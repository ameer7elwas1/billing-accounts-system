<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ŸÇÿ≥ŸÖ ÿßŸÑÿ≠ÿ≥ÿßÿ®ÿßÿ™ </title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìä</text></svg>">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700;800;900&display=swap">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/exceljs@4.4.0/dist/exceljs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js" crossorigin="anonymous"></script>
    <script>
        // ÿ™ÿ≠ŸÖŸäŸÑ config.js ÿ®ÿ¥ŸÉŸÑ ÿØŸäŸÜÿßŸÖŸäŸÉŸä ŸÑÿ™ÿ¨ŸÜÿ® ÿÆÿ∑ÿ£ 404 ŸÅŸä Console
        (function() {
            const script = document.createElement('script');
            script.src = 'js/config.js';
            script.onerror = function() {
                // ÿßŸÑŸÖŸÑŸÅ ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ (ŸÖÿ™ŸàŸÇÿπ ÿπŸÑŸâ GitHub Pages) - ŸÑÿß ŸÜÿπÿ±ÿ∂ ÿÆÿ∑ÿ£
                this.remove();
            };
            script.onload = function() {
                // ÿßŸÑŸÖŸÑŸÅ ŸÖŸàÿ¨ŸàÿØ - ÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑŸá ÿ®ŸÜÿ¨ÿßÿ≠
            };
            document.head.appendChild(script);
        })();
    </script>
    <style>
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --bg-tertiary: #f0f0f0;
            --text-primary: #2c3e50;
            --text-secondary: #5a6c7d;
            --text-tertiary: #95a5a6;
            --border-color: #801c32;
            --border-light: rgba(128, 28, 50, 0.3);
            --primary-color: #801c32;
            --primary-hover: #9d2338;
            --primary-light: rgba(128, 28, 50, 0.1);
            --shadow-sm: rgba(128, 28, 50, 0.08);
            --shadow-md: rgba(128, 28, 50, 0.18);
            --shadow-lg: rgba(128, 28, 50, 0.28);
            --card-bg: #ffffff;
            --sidebar-bg: #f8f9fa;
            --nav-bg: rgba(255, 255, 255, 0.7);
            --nav-hover: rgba(128, 28, 50, 0.08);
            --input-bg: #ffffff;
            --input-border: #801c32;
            --input-focus: rgba(128, 28, 50, 0.4);
            --modal-bg: #ffffff;
            --table-bg: #ffffff;
            --table-header: #801c32;
            --table-border: #e0e0e0;
            --success-color: #28a745;
            --success-light: rgba(40, 167, 69, 0.1);
            --error-color: #dc3545;
            --error-light: rgba(220, 53, 69, 0.1);
            --info-color: #17a2b8;
            --info-light: rgba(23, 162, 184, 0.1);
            --warning-color: #ffc107;
            --warning-light: rgba(255, 193, 7, 0.1);
        }
        [data-theme="dark"] {
            --bg-primary: #1a1a1a;
            --bg-secondary: #2d2d2d;
            --bg-tertiary: #3a3a3a;
            --text-primary: #f0f0f0;
            --text-secondary: #d0d0d0;
            --text-tertiary: #a0a0a0;
            --border-color: rgba(255, 255, 255, 0.18);
            --border-light: rgba(255, 255, 255, 0.12);
            --primary-color: #ff4757;
            --primary-hover: #ff6b7a;
            --primary-light: rgba(255, 71, 87, 0.15);
            --shadow-sm: rgba(0, 0, 0, 0.4);
            --shadow-md: rgba(0, 0, 0, 0.6);
            --shadow-lg: rgba(0, 0, 0, 0.8);
            --card-bg: #2d2d2d;
            --sidebar-bg: #2d2d2d;
            --nav-bg: rgba(45, 45, 45, 0.85);
            --nav-hover: rgba(255, 71, 87, 0.18);
            --input-bg: #3a3a3a;
            --input-border: rgba(255, 255, 255, 0.25);
            --input-focus: rgba(255, 71, 87, 0.5);
            --modal-bg: #2d2d2d;
            --table-bg: #2d2d2d;
            --table-header: #ff4757;
            --table-border: #4a4a4a;
            --success-color: #4ade80;
            --success-light: rgba(74, 222, 128, 0.15);
            --error-color: #f87171;
            --error-light: rgba(248, 113, 113, 0.15);
            --info-color: #60a5fa;
            --info-light: rgba(96, 165, 250, 0.15);
            --warning-color: #fbbf24;
            --warning-light: rgba(251, 191, 36, 0.15);
        }
        [data-theme="dark"] * {
            text-shadow: none;
        }
        [data-theme="dark"] .nav-text,
        [data-theme="dark"] .nav-item,
        [data-theme="dark"] .section-title,
        [data-theme="dark"] .agent-name-title,
        [data-theme="dark"] .info-value,
        [data-theme="dark"] .result-card h3,
        [data-theme="dark"] .result-card .count {
            font-weight: 700;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }
        [data-theme="dark"] .text-primary,
        [data-theme="dark"] body,
        [data-theme="dark"] .main-content {
            color: #ffffff;
            font-weight: 400;
        }
        [data-theme="dark"] p,
        [data-theme="dark"] span,
        [data-theme="dark"] div,
        [data-theme="dark"] label,
        [data-theme="dark"] td,
        [data-theme="dark"] th {
            color: #ffffff !important;
        }
        [data-theme="dark"] .section,
        [data-theme="dark"] .section-title,
        [data-theme="dark"] .section h3,
        [data-theme="dark"] .section h4,
        [data-theme="dark"] .section p {
            color: #ffffff !important;
        }
        [data-theme="dark"] .agent-card-improved,
        [data-theme="dark"] .agent-card-improved * {
            color: #ffffff !important;
        }
        [data-theme="dark"] .settings-section,
        [data-theme="dark"] .settings-section * {
            color: #ffffff !important;
        }
        [data-theme="dark"] .info-item-improved,
        [data-theme="dark"] .info-item-improved * {
            color: #ffffff !important;
        }
        [data-theme="dark"] .info-label,
        [data-theme="dark"] .info-value,
        [data-theme="dark"] .info-label-empty {
            color: #ffffff !important;
        }
        [data-theme="dark"] .modal-content,
        [data-theme="dark"] .modal-content * {
            color: #ffffff !important;
        }
        [data-theme="dark"] input,
        [data-theme="dark"] textarea,
        [data-theme="dark"] select {
            color: #ffffff !important;
            background-color: #3a3a3a !important;
        }
        [data-theme="dark"] button {
            color: #ffffff !important;
        }
        [data-theme="dark"] .btn {
            color: #ffffff !important;
        }
        [data-theme="dark"] .btn-danger {
            background-color: #dc3545 !important;
            color: #ffffff !important;
        }
        [data-theme="dark"] .btn-success {
            background-color: #28a745 !important;
            color: #ffffff !important;
        }
        [data-theme="dark"] .btn-primary {
            background-color: #007bff !important;
            color: #ffffff !important;
        }
        [data-theme="dark"] .btn-info {
            background-color: #17a2b8 !important;
            color: #ffffff !important;
        }
        [data-theme="dark"] .btn-warning {
            background-color: #ffc107 !important;
            color: #000000 !important;
        }
        [data-theme="dark"] .btn-secondary {
            background-color: #6c757d !important;
            color: #ffffff !important;
            border-color: #6c757d !important;
        }
        [data-theme="dark"] .btn-secondary:hover {
            background-color: #5a6268 !important;
            border-color: #545b62 !important;
        }
        [data-theme="dark"] [style*="color: #801c32"],
        [data-theme="dark"] [style*="color:#801c32"] {
            color: #ff6b7a !important;
        }
        [data-theme="dark"] [style*="color: #28a745"],
        [data-theme="dark"] [style*="color:#28a745"] {
            color: #4ade80 !important;
        }
        [data-theme="dark"] [style*="color: #dc3545"],
        [data-theme="dark"] [style*="color:#dc3545"] {
            color: #f87171 !important;
        }
        [data-theme="dark"] [style*="color: #007bff"],
        [data-theme="dark"] [style*="color:#007bff"] {
            color: #60a5fa !important;
        }
        [data-theme="dark"] [style*="color: #17a2b8"],
        [data-theme="dark"] [style*="color:#17a2b8"] {
            color: #22d3ee !important;
        }
        [data-theme="dark"] [style*="color: #ffc107"],
        [data-theme="dark"] [style*="color:#ffc107"] {
            color: #fbbf24 !important;
        }
        [data-theme="dark"] [style*="background: #801c32"],
        [data-theme="dark"] [style*="background:#801c32"] {
            background: #ff4757 !important;
        }
        [data-theme="dark"] [style*="background: #28a745"],
        [data-theme="dark"] [style*="background:#28a745"] {
            background: #4ade80 !important;
        }
        [data-theme="dark"] [style*="background: #dc3545"],
        [data-theme="dark"] [style*="background:#dc3545"] {
            background: #f87171 !important;
        }
        [data-theme="dark"] [style*="background: #007bff"],
        [data-theme="dark"] [style*="background:#007bff"] {
            background: #60a5fa !important;
        }
        [data-theme="dark"] [style*="background: #17a2b8"],
        [data-theme="dark"] [style*="background:#17a2b8"] {
            background: #22d3ee !important;
        }
        [data-theme="dark"] [style*="background: #ffc107"],
        [data-theme="dark"] [style*="background:#ffc107"] {
            background: #fbbf24 !important;
        }
        [data-theme="dark"] [style*="border-color: #801c32"],
        [data-theme="dark"] [style*="border-color:#801c32"] {
            border-color: #ff4757 !important;
        }
        [data-theme="dark"] [style*="border-color: #28a745"],
        [data-theme="dark"] [style*="border-color:#28a745"] {
            border-color: #4ade80 !important;
        }
        [data-theme="dark"] [style*="border-color: #dc3545"],
        [data-theme="dark"] [style*="border-color:#dc3545"] {
            border-color: #f87171 !important;
        }
        [data-theme="dark"] td[style*="color: #801c32"],
        [data-theme="dark"] td[style*="color:#801c32"],
        [data-theme="dark"] span[style*="color: #801c32"],
        [data-theme="dark"] span[style*="color:#801c32"],
        [data-theme="dark"] strong[style*="color: #801c32"],
        [data-theme="dark"] strong[style*="color:#801c32"] {
            color: #ff6b7a !important;
        }
        [data-theme="dark"] td[style*="color: #28a745"],
        [data-theme="dark"] td[style*="color:#28a745"],
        [data-theme="dark"] span[style*="color: #28a745"],
        [data-theme="dark"] span[style*="color:#28a745"],
        [data-theme="dark"] div[style*="color: #28a745"],
        [data-theme="dark"] div[style*="color:#28a745"],
        [data-theme="dark"] strong[style*="color: #28a745"],
        [data-theme="dark"] strong[style*="color:#28a745"] {
            color: #4ade80 !important;
        }
        [data-theme="dark"] td[style*="color: #dc3545"],
        [data-theme="dark"] td[style*="color:#dc3545"],
        [data-theme="dark"] span[style*="color: #dc3545"],
        [data-theme="dark"] span[style*="color:#dc3545"],
        [data-theme="dark"] div[style*="color: #dc3545"],
        [data-theme="dark"] div[style*="color:#dc3545"],
        [data-theme="dark"] strong[style*="color: #dc3545"],
        [data-theme="dark"] strong[style*="color:#dc3545"] {
            color: #f87171 !important;
        }
        [data-theme="dark"] h4[style*="color: #dc3545"],
        [data-theme="dark"] h4[style*="color:#dc3545"] {
            color: #f87171 !important;
        }
        [data-theme="dark"] [style*="background: #fff3cd"] {
            background: #3a3a3a !important;
            border-color: #fbbf24 !important;
        }
        [data-theme="dark"] [style*="color: #856404"] {
            color: #fbbf24 !important;
        }
        [data-theme="dark"] [style*="color: #155724"] {
            color: #4ade80 !important;
        }
        [data-theme="dark"] [style*="background: #d4edda"] {
            background: #2d2d2d !important;
            border-color: #4ade80 !important;
        }
        [data-theme="dark"] table,
        [data-theme="dark"] table td,
        [data-theme="dark"] table th {
            color: #ffffff !important;
        }
        [data-theme="dark"] #percentageTable td,
        [data-theme="dark"] #percentageTable th {
            color: #ffffff !important;
        }
        [data-theme="dark"] [style*="color: #1a1a1a"],
        [data-theme="dark"] [style*="color:#1a1a1a"],
        [data-theme="dark"] [style*="color: #333"],
        [data-theme="dark"] [style*="color:#333"],
        [data-theme="dark"] [style*="color: #999"],
        [data-theme="dark"] [style*="color:#999"] {
            color: var(--text-primary) !important;
        }
        [data-theme="dark"] [style*="background: #ffffff"],
        [data-theme="dark"] [style*="background:#ffffff"],
        [data-theme="dark"] [style*="background: white"],
        [data-theme="dark"] [style*="background:white"] {
            background: var(--card-bg) !important;
        }
        [data-theme="dark"] [style*="background: rgba(128, 28, 50, 0.05)"] {
            background: rgba(255, 71, 87, 0.1) !important;
        }
        [data-theme="dark"] .section p[style*="color: #1a1a1a"],
        [data-theme="dark"] .section p[style*="color:#1a1a1a"] {
            color: var(--text-primary) !important;
        }
        [data-theme="dark"] label[style*="color: #1a1a1a"],
        [data-theme="dark"] label[style*="color:#1a1a1a"],
        [data-theme="dark"] label[style*="color: #801c32"],
        [data-theme="dark"] label[style*="color:#801c32"] {
            color: var(--text-primary) !important;
        }
        [data-theme="dark"] .search-input,
        [data-theme="dark"] .search-results,
        [data-theme="dark"] .search-result-item {
            background: var(--card-bg) !important;
            color: var(--text-primary) !important;
            border-color: var(--border-color) !important;
        }
        [data-theme="dark"] .search-result-item:hover {
            background: var(--nav-hover) !important;
        }
        [data-theme="dark"] .search-result-item .result-type {
            color: var(--primary-color) !important;
        }
        [data-theme="dark"] .search-result-item .result-title {
            color: var(--text-primary) !important;
        }
        [data-theme="dark"] .search-result-item .result-month {
            color: var(--text-secondary) !important;
        }
        [data-theme="dark"] #archiveContent,
        [data-theme="dark"] #archiveContent * {
            color: var(--text-primary) !important;
        }
        [data-theme="dark"] #archiveContent h3,
        [data-theme="dark"] #archiveContent h4,
        [data-theme="dark"] #archiveContent h5 {
            color: var(--primary-color) !important;
        }
        [data-theme="dark"] #archiveContent table,
        [data-theme="dark"] #archiveContent table td,
        [data-theme="dark"] #archiveContent table th {
            background: var(--table-bg) !important;
            color: var(--text-primary) !important;
            border-color: var(--table-border) !important;
        }
        [data-theme="dark"] #archiveContent table thead tr,
        [data-theme="dark"] #archiveContent table thead th {
            background: var(--bg-secondary) !important;
            color: var(--primary-color) !important;
        }
        [data-theme="dark"] #archiveContent table tbody tr:nth-child(even) {
            background: var(--bg-secondary) !important;
        }
        [data-theme="dark"] #archiveContent table tbody tr:nth-child(odd) {
            background: var(--card-bg) !important;
        }
        [data-theme="dark"] #searchResultsContainer,
        [data-theme="dark"] #searchResultsContainer * {
            color: var(--text-primary) !important;
        }
        [data-theme="dark"] #searchResultsContainer h4,
        [data-theme="dark"] #searchResultsContainer h5 {
            color: var(--primary-color) !important;
        }
        [data-theme="dark"] #searchResultsContainer strong {
            color: var(--text-primary) !important;
        }
        [data-theme="dark"] #searchResultsContainer [style*="background: var(--bg-secondary)"] {
            background: var(--bg-secondary) !important;
        }
        [data-theme="dark"] #searchResultsContainer [style*="background: var(--card-bg)"] {
            background: var(--card-bg) !important;
        }
        [data-theme="dark"] .settings-input {
            background: var(--input-bg) !important;
            color: var(--text-primary) !important;
            border-color: var(--input-border) !important;
        }
        [data-theme="dark"] .file-upload {
            background: var(--card-bg) !important;
            border-color: var(--border-color) !important;
            color: var(--text-primary) !important;
        }
        [data-theme="dark"] .file-upload:hover {
            background: var(--bg-secondary) !important;
        }
        [data-theme="dark"] .success-message {
            background: rgba(40, 167, 69, 0.2) !important;
            color: #90ee90 !important;
            border-color: #28a745 !important;
        }
        [data-theme="dark"] .error-message {
            background: rgba(220, 53, 69, 0.2) !important;
            color: #ff6b7a !important;
            border-color: #dc3545 !important;
        }
        [data-theme="dark"] #archivesList > div {
            background: var(--card-bg) !important;
            border-color: var(--border-color) !important;
            color: var(--text-primary) !important;
        }
        [data-theme="dark"] #archivesList > div:hover {
            background: var(--nav-hover) !important;
            border-color: var(--primary-color) !important;
        }
        [data-theme="dark"] [style*="background: var(--bg-primary)"] {
            background: var(--bg-primary) !important;
        }
        [data-theme="dark"] [style*="background: var(--bg-secondary)"] {
            background: var(--bg-secondary) !important;
        }
        [data-theme="dark"] [style*="background: var(--card-bg)"] {
            background: var(--card-bg) !important;
        }
        [data-theme="dark"] [style*="color: var(--text-secondary)"] {
            color: var(--text-secondary) !important;
        }
        [data-theme="dark"] [style*="color: var(--text-tertiary)"] {
            color: var(--text-tertiary) !important;
        }
        [data-theme="dark"] div[style*="background"],
        [data-theme="dark"] p[style*="background"],
        [data-theme="dark"] span[style*="background"] {
            background-color: var(--card-bg) !important;
        }
        [data-theme="dark"] .main-content,
        [data-theme="dark"] .main-content * {
            color: var(--text-primary);
        }
        [data-theme="dark"] .main-content h1,
        [data-theme="dark"] .main-content h2,
        [data-theme="dark"] .main-content h3,
        [data-theme="dark"] .main-content h4,
        [data-theme="dark"] .main-content h5,
        [data-theme="dark"] .main-content h6 {
            color: var(--text-primary);
        }
        [data-theme="dark"] p[style*="color: #1a1a1a"],
        [data-theme="dark"] p[style*="color:#1a1a1a"],
        [data-theme="dark"] div[style*="color: #1a1a1a"],
        [data-theme="dark"] div[style*="color:#1a1a1a"],
        [data-theme="dark"] span[style*="color: #1a1a1a"],
        [data-theme="dark"] span[style*="color:#1a1a1a"],
        [data-theme="dark"] label[style*="color: #1a1a1a"],
        [data-theme="dark"] label[style*="color:#1a1a1a"] {
            color: var(--text-primary) !important;
        }
        [data-theme="dark"] p[style*="color: #333"],
        [data-theme="dark"] p[style*="color:#333"],
        [data-theme="dark"] span[style*="color: #333"],
        [data-theme="dark"] span[style*="color:#333"] {
            color: var(--text-primary) !important;
        }
        [data-theme="dark"] p[style*="color: #999"],
        [data-theme="dark"] p[style*="color:#999"],
        [data-theme="dark"] td[style*="color: #999"],
        [data-theme="dark"] td[style*="color:#999"] {
            color: var(--text-secondary) !important;
        }
        [data-theme="dark"] tr[style*="background: #801c32"],
        [data-theme="dark"] tr[style*="background:#801c32"] {
            background: var(--primary-color) !important;
        }
        [data-theme="dark"] tr[style*="background: #801c32"] th,
        [data-theme="dark"] tr[style*="background:#801c32"] th,
        [data-theme="dark"] tr[style*="color: white"] th,
        [data-theme="dark"] tr[style*="color:white"] th {
            color: #ffffff !important;
        }
        [data-theme="dark"] [style*="border: 1px solid #ddd"],
        [data-theme="dark"] [style*="border:1px solid #ddd"],
        [data-theme="dark"] [style*="border: 1px solid #ddd"] {
            border-color: var(--table-border) !important;
        }
        [data-theme="dark"] div[style*="background: rgba(128, 28, 50, 0.05)"] {
            background: rgba(255, 71, 87, 0.15) !important;
        }
        [data-theme="dark"] .activity-item {
            background: var(--card-bg) !important;
            border-color: var(--border-color) !important;
            color: var(--text-primary) !important;
        }
        [data-theme="dark"] .results-grid,
        [data-theme="dark"] .result-card {
            background: var(--card-bg) !important;
            border-color: var(--border-color) !important;
            color: var(--text-primary) !important;
        }
        [data-theme="dark"] .result-card h3 {
            color: var(--text-primary) !important;
        }
        [data-theme="dark"] .result-card .count,
        [data-theme="dark"] .result-card .amount {
            color: var(--text-primary) !important;
        }
        [data-theme="dark"] .agent-card,
        [data-theme="dark"] .agent-card-improved {
            background: var(--card-bg) !important;
            border-color: var(--border-color) !important;
        }
        [data-theme="dark"] .summary-section,
        [data-theme="dark"] .summary-card {
            background: var(--card-bg) !important;
            border-color: var(--border-color) !important;
            color: var(--text-primary) !important;
        }
        [data-theme="dark"] .form-group,
        [data-theme="dark"] .form-group label {
            color: var(--text-primary) !important;
        }
        [data-theme="dark"] .section {
            background: transparent !important;
            color: var(--text-primary) !important;
        }
        [data-theme="dark"] [style*="color: white"],
        [data-theme="dark"] [style*="color:white"] {
            color: var(--text-primary) !important;
        }
        [data-theme="dark"] a {
            color: var(--primary-color) !important;
        }
        [data-theme="dark"] a:hover {
            color: var(--primary-hover) !important;
        }
        [data-theme="dark"] .loading {
            color: var(--text-primary) !important;
        }
        [data-theme="dark"] .empty-state {
            color: var(--text-secondary) !important;
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Cairo', 'Segoe UI', 'Arial', sans-serif;
        }
        body {
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            transition: background-color 0.3s ease, color 0.3s ease;
            font-size: 16px;
            font-weight: 500;
            line-height: 1.6;
            overflow-x: hidden;
        }
        input, textarea {
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            user-select: text;
        }
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 30%, var(--shadow-sm) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, var(--shadow-sm) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
            opacity: 0.5;
        }
        [data-theme="dark"] body::before {
            opacity: 0.3;
        }
        .container {
            display: flex;
            width: 100%;
            max-width: 100vw;
            min-height: 100vh;
            position: relative;
            z-index: 1;
            overflow-x: hidden;
            box-sizing: border-box;
        }
        .sidebar {
            width: 230px;
            max-width: 230px;
            background: linear-gradient(180deg, var(--sidebar-bg) 0%, rgba(255, 255, 255, 0.02) 100%);
            border-left: 3px solid var(--primary-color);
            box-shadow: 3px 0 20px rgba(0, 0, 0, 0.08), inset -1px 0 0 rgba(128, 28, 50, 0.1);
            position: fixed;
            right: 0;
            top: 0;
            bottom: 0;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            padding: 0;
            overflow: hidden;
            transition: transform 0.3s ease, background 0.3s ease, border-color 0.3s ease;
            box-sizing: border-box;
        }
        [data-theme="dark"] .sidebar {
            background: linear-gradient(180deg, var(--sidebar-bg) 0%, rgba(0, 0, 0, 0.2) 100%);
            box-shadow: 4px 0 25px rgba(0, 0, 0, 0.3), inset -1px 0 0 rgba(128, 28, 50, 0.2);
        }
        .sidebar.hidden {
            transform: translateX(100%);
        }
        .sidebar-toggle-external {
            display: none !important;
            position: fixed !important;
            top: 20px !important;
            right: 20px !important;
            z-index: 10001 !important;
        }
        .sidebar.hidden ~ .sidebar-toggle-external,
        .sidebar.hidden + .sidebar-toggle-external,
        body:has(.sidebar.hidden) .sidebar-toggle-external {
            display: flex !important;
        }
        .sidebar-toggle-btn {
            position: relative;
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, var(--primary-color), var(--primary-hover));
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            box-shadow: 0 2px 6px var(--shadow-sm);
            transition: all 0.3s ease;
            font-weight: 700;
        }
        .sidebar.hidden ~ .sidebar-toggle-btn,
        .sidebar.hidden + .sidebar-toggle-btn {
            display: flex;
        }
        .sidebar-toggle-btn:hover {
            background: linear-gradient(135deg, var(--primary-hover), var(--primary-color));
            transform: scale(1.05);
            box-shadow: 0 4px 12px var(--shadow-md);
        }
        .theme-toggle-btn-small {
            position: relative;
            width: 36px;
            height: 36px;
            background: var(--bg-secondary);
            border: 1.5px solid var(--border-light);
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
            transition: all 0.3s ease;
            padding: 0;
            margin: 0;
            box-shadow: 0 2px 4px var(--shadow-sm);
            flex-shrink: 0;
        }
        .theme-toggle-btn-small:hover {
            background: var(--bg-tertiary);
            border-color: var(--primary-color);
            transform: scale(1.05);
            box-shadow: 0 3px 8px var(--shadow-md);
        }
        .theme-toggle-btn-small:active {
            transform: scale(0.95);
        }
        .theme-toggle-btn-small span {
            display: inline-block;
            transition: transform 0.3s ease;
        }
        [data-theme="dark"] .theme-toggle-btn-small span {
            transform: rotate(180deg);
        }
        .sidebar.hidden .theme-toggle-btn-small {
            display: flex !important;
        }
        #loginScreen[style*="display: flex"] ~ .sidebar-toggle-btn,
        #loginScreen[style*="display: block"] ~ .sidebar-toggle-btn {
            display: none !important;
        }
        #dashboard[style*="display: none"] ~ .sidebar-toggle-btn,
        #dashboard[style*="display: none"] .sidebar-toggle-btn {
            display: none !important;
        }
        .sidebar-header {
            padding: 20px 15px 15px;
            border-bottom: 1.5px solid var(--border-color);
            margin-bottom: 8px;
            transition: border-color 0.3s ease;
            flex-shrink: 0;
            background: linear-gradient(135deg, rgba(128, 28, 50, 0.03) 0%, transparent 100%);
            overflow: visible;
            width: 100%;
            box-sizing: border-box;
            position: relative;
            min-height: 120px;
        }
        [data-theme="dark"] .sidebar-header {
            background: linear-gradient(135deg, rgba(128, 28, 50, 0.1) 0%, transparent 100%);
        }
        .sidebar-header-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin-bottom: 8px;
        }
        .sidebar-header h1 {
            font-size: 1.1rem;
            color: var(--primary-color);
            font-weight: 800;
            text-align: center;
            margin: 45px 0 15px 0;
            letter-spacing: 0.5px;
            flex: 1;
            line-height: 1.3;
            transition: color 0.3s ease;
            padding: 0 10px;
        }
        .search-container {
            margin: 10px 15px;
            position: relative;
        }
        .search-input {
            width: 100%;
            padding: 10px 40px 10px 15px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            background: var(--input-bg);
            color: var(--text-primary);
            font-size: 0.95rem;
            transition: all 0.3s ease;
        }
        .search-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px var(--shadow-sm);
        }
        .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
            font-size: 1.1rem;
            pointer-events: none;
        }
        .search-results {
            max-height: 400px;
            overflow-y: auto;
            margin-top: 10px;
            padding: 10px;
            background: var(--bg-secondary);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            display: none;
        }
        .search-results.active {
            display: block;
        }
        .search-result-item {
            padding: 8px;
            margin-bottom: 5px;
            background: var(--card-bg);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid var(--border-light);
        }
        .search-result-item:hover {
            background: var(--nav-hover);
            border-color: var(--primary-color);
        }
        .search-result-item .result-type {
            font-size: 0.75rem;
            color: var(--primary-color);
            font-weight: 600;
            margin-bottom: 3px;
        }
        .search-result-item .result-title {
            font-size: 0.9rem;
            color: var(--text-primary);
            font-weight: 500;
        }
        .search-result-item .result-month {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-top: 3px;
        }
        .sidebar-nav {
            flex: 1;
            padding: 8px 12px;
            overflow-y: auto;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            gap: 5px;
            min-height: 0;
            margin-top: 5px;
        }
        .nav-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 12px;
            margin-bottom: 4px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            color: var(--text-primary);
            font-weight: 600;
            font-size: 0.85rem;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            text-rendering: optimizeLegibility;
            position: relative;
            overflow: visible;
            background: linear-gradient(135deg, var(--nav-bg) 0%, rgba(255, 255, 255, 0.02) 100%);
            border: 1.5px solid rgba(128, 28, 50, 0.1);
            backdrop-filter: blur(10px);
            line-height: 1.4;
            flex-shrink: 0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            min-height: 42px;
        }
        [data-theme="dark"] .nav-item {
            color: #f5f5f5;
            background: linear-gradient(135deg, var(--nav-bg) 0%, rgba(255, 255, 255, 0.03) 100%);
            border-color: rgba(128, 28, 50, 0.15);
        }
        .nav-item::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(180deg, var(--primary-color) 0%, var(--primary-hover) 100%);
            transform: translateX(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 0 10px 10px 0;
            box-shadow: 0 0 8px rgba(128, 28, 50, 0.3);
        }
        .nav-item::after {
            content: '';
            position: absolute;
            top: 50%;
            right: 0;
            width: 0;
            height: 0;
            background: radial-gradient(circle, rgba(128, 28, 50, 0.1) 0%, transparent 70%);
            border-radius: 50%;
            transform: translate(50%, -50%);
            transition: width 0.4s ease, height 0.4s ease;
            pointer-events: none;
        }
        .nav-item:hover::after {
            width: 150px;
            height: 150px;
        }
        .nav-item:hover::before,
        .nav-item.active::before {
            transform: translateX(0);
        }
        .nav-item:hover {
            background: linear-gradient(135deg, var(--nav-hover) 0%, rgba(128, 28, 50, 0.08) 100%);
            border-color: rgba(128, 28, 50, 0.25);
            transform: translateX(-4px);
            box-shadow: 0 4px 12px rgba(128, 28, 50, 0.15), 0 2px 4px rgba(0, 0, 0, 0.1);
            color: var(--primary-color);
        }
        .nav-item.active {
            background: linear-gradient(135deg, rgba(128, 28, 50, 0.12) 0%, rgba(128, 28, 50, 0.06) 100%);
            border-color: rgba(128, 28, 50, 0.3);
            color: var(--primary-color);
            font-weight: 700;
            box-shadow: 0 2px 8px rgba(128, 28, 50, 0.2), inset 0 0 20px rgba(128, 28, 50, 0.05);
        }
        [data-theme="dark"] .nav-item.active {
            background: linear-gradient(135deg, rgba(128, 28, 50, 0.25) 0%, rgba(128, 28, 50, 0.15) 100%);
            border-color: rgba(128, 28, 50, 0.4);
            box-shadow: 0 2px 8px rgba(128, 28, 50, 0.3), inset 0 0 20px rgba(128, 28, 50, 0.1);
        }
        .nav-icon {
            font-size: 0.9rem;
            width: 22px;
            height: 22px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            background: linear-gradient(135deg, rgba(128, 28, 50, 0.12) 0%, rgba(128, 28, 50, 0.06) 100%);
            border-radius: 5px;
            transition: all 0.3s ease;
            position: relative;
        }
        .nav-item:hover .nav-icon,
        .nav-item.active .nav-icon {
            background: linear-gradient(135deg, rgba(128, 28, 50, 0.2) 0%, rgba(128, 28, 50, 0.1) 100%);
            transform: scale(1.1);
        }
        .nav-item.active .nav-icon {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-hover) 100%);
            color: white;
            box-shadow: 0 2px 6px rgba(128, 28, 50, 0.3);
        }
        .nav-text {
            flex: 1;
            font-size: 0.9rem;
            font-weight: 700;
            letter-spacing: 0.3px;
            white-space: normal;
            overflow: visible;
            word-wrap: break-word;
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            text-rendering: optimizeLegibility;
            color: var(--text-primary);
            transition: color 0.3s ease, font-weight 0.3s ease;
            text-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .nav-item.active .nav-text {
            font-weight: 800;
            color: var(--primary-color);
            text-shadow: 0 1px 3px rgba(128, 28, 50, 0.2);
        }
        .nav-item:hover .nav-text {
            font-weight: 700;
            color: var(--primary-color);
        }
        [data-theme="dark"] .nav-text {
            color: var(--text-primary);
        }
        [data-theme="dark"] .nav-item.active .nav-text {
            color: var(--primary-color);
        }
        [data-theme="dark"] .nav-item:hover .nav-text {
            color: var(--primary-color);
        }
        .sidebar-footer {
            padding: 6px 20px;
            border-top: 2px solid var(--border-color);
            margin-top: auto;
            transition: border-color 0.3s ease;
            flex-shrink: 0;
        }
        .user-info-sidebar {
            color: var(--primary-color);
            font-size: 14px;
            text-align: center;
            margin-bottom: 10px;
            font-weight: 600;
            transition: color 0.3s ease;
        }
        .sidebar-user-info {
            text-align: center;
            font-size: 0.9rem;
            color: var(--text-secondary);
            overflow: visible;
            margin-top: 0;
            padding: 0;
        }
        .sidebar-user-name {
            font-size: 0.9rem;
            font-weight: 700;
            color: var(--text-primary);
            margin: 0;
            padding: 6px 10px;
            cursor: pointer;
            position: relative;
            opacity: 1;
            overflow: visible;
            width: 100%;
            box-sizing: border-box;
        }
        .sidebar-user-name:hover {
            opacity: 0.9;
        }
        .user-contact-popup {
            position: fixed;
            background: var(--card-bg);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 15px 20px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
            min-width: 250px;
            max-width: 300px;
            z-index: 10001;
            display: none;
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
            transform: translateY(0);
            will-change: transform, opacity;
        }
        .user-contact-popup.show {
            display: block !important;
            opacity: 1 !important;
            visibility: visible !important;
            pointer-events: auto !important;
            animation: popupFadeIn 0.15s ease-out forwards;
        }
        @keyframes popupFadeIn {
            from {
                opacity: 0;
                transform: translateY(-5px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        @keyframes popupFadeOut {
            from {
                opacity: 1;
                transform: translateY(0);
            }
            to {
                opacity: 0;
                transform: translateY(-5px);
            }
        }
        .user-contact-popup::before {
            content: '';
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 8px solid transparent;
            border-bottom-color: var(--card-bg);
            filter: drop-shadow(0 -2px 4px rgba(0, 0, 0, 0.1));
            pointer-events: none;
        }
        .user-contact-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-light);
            font-size: 0.9rem;
        }
        .user-contact-item:last-child {
            border-bottom: none;
        }
        .user-contact-item a {
            color: var(--primary-color);
            text-decoration: none;
            transition: color 0.2s ease;
        }
        .user-contact-item a:hover {
            color: var(--primary-hover);
            text-decoration: underline;
        }
        .user-contact-icon {
            font-size: 1.0rem;
            width: 24px;
            text-align: center;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .user-contact-icon i {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .date-info-sidebar {
            color: #1a1a1a;
            font-size: 12px;
            text-align: center;
            transition: color 0.3s ease;
            font-weight: 600;
            background: #ffffff;
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
        }
        [data-theme="dark"] .date-info-sidebar {
            color: #801c32 !important;
            background: #ffffff !important;
            font-weight: 700;
            text-shadow: none;
            opacity: 1 !important;
            border-color: #801c32;
        }
        .main-content {
            flex: 1;
            margin-right: 250px;
            padding: 30px 25px;
            min-height: 100vh;
            transition: background-color 0.3s ease, color 0.3s ease;
            width: calc(100% - 250px);
            max-width: calc(100% - 250px);
            overflow-x: hidden;
            position: relative;
            z-index: 1;
            box-sizing: border-box;
        }
        .main-content.sidebar-hidden {
            margin-right: 0;
            width: 100%;
            max-width: 100%;
        }
        .login-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            width: 100%;
        }
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: var(--bg-primary);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 10000;
        }
        .login-container.hidden {
            display: none !important;
        }
        .login-card {
            background: var(--card-bg);
            border: 2px solid var(--border-color);
            border-radius: 16px;
            padding: 40px;
            box-shadow: 0 8px 24px var(--shadow-lg);
            width: 100%;
            max-width: 450px;
        }
        .login-card h1 {
            color: var(--primary-color);
            font-size: 1.8rem;
            font-weight: 700;
            text-align: center;
            margin-bottom: 30px;
        }
        .login-form {
            background: var(--card-bg);
            padding: 60px 50px;
            border-radius: 30px;
            box-shadow: 0 20px 60px var(--shadow-md);
            width: 100%;
            max-width: 480px;
            text-align: center;
            border: 3px solid var(--primary-color);
            position: relative;
            overflow: hidden;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        .login-form::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--primary-color);
            transition: background 0.3s ease;
        }
        .login-logo {
            font-size: 3.5rem;
            color: var(--primary-color);
            margin-bottom: 20px;
            font-weight: bold;
            transition: color 0.3s ease;
        }
        .login-title {
            font-size: 1.8rem;
            color: var(--primary-color);
            margin-bottom: 35px;
            font-weight: 600;
            transition: color 0.3s ease;
        }
        .form-group {
            margin-bottom: 20px;
            text-align: right;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-primary);
            font-weight: bold;
            transition: color 0.3s ease;
        }
        .form-group input {
            width: 100%;
            padding: 15px 20px;
            border: 2px solid var(--input-border);
            border-radius: 15px;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
            text-align: right;
            background: var(--input-bg);
            color: var(--text-primary);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            text-rendering: optimizeLegibility;
            line-height: 1.5;
        }
        .form-group input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 20px var(--shadow-md);
            transform: translateY(-2px);
            background: var(--input-bg);
            font-weight: 600;
        }
        .login-btn {
            width: 100%;
            padding: 15px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 15px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 25px var(--shadow-md);
        }
        .login-btn:hover {
            transform: translateY(-3px);
            background: var(--primary-hover);
            box-shadow: 0 12px 35px var(--shadow-lg);
        }
        .login-btn:active {
            transform: translateY(-1px);
        }
        .dashboard {
            display: flex;
            width: 100%;
            max-width: 100%;
            overflow-x: hidden;
            position: relative;
            box-sizing: border-box;
        }
        .dashboard.hidden {
            display: none !important;
        }
        .tab-content {
            display: none;
            width: 100%;
            max-width: 100%;
            overflow-x: hidden;
            box-sizing: border-box;
        }
        .tab-content.active {
            display: block;
            width: 100%;
            max-width: 100%;
            overflow-x: hidden;
            box-sizing: border-box;
        }
        .section {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1.5px solid var(--border-light);
            box-shadow: 
                0 4px 12px var(--shadow-sm),
                0 2px 6px var(--shadow-sm);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            overflow-x: hidden;
            color: var(--text-primary);
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
        }
        #percentageResults.section {
            overflow: visible;
            overflow-x: hidden;
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
            transition: none !important;
            animation: none !important;
        }
        #percentageResults.section::before {
            display: none !important;
        }
        #percentageResults.section:hover {
            transform: none !important;
        }
        #agentPercentageTab .section {
            transition: none !important;
            animation: none !important;
        }
        #agentPercentageTab .section::before {
            display: none !important;
        }
        #agentPercentageTab .section:hover {
            transform: none !important;
        }
        #percentageTableContainer * {
            transition: none !important;
            animation: none !important;
        }
        #percentageTable * {
            transition: none !important;
            animation: none !important;
        }
        #percentageTableContainer {
            width: 100% !important;
            max-width: 100% !important;
            box-sizing: border-box !important;
            overflow-x: auto !important;
            overflow-y: auto !important;
            will-change: scroll-position;
            contain: layout style paint;
            position: relative;
            isolation: isolate;
        }
        #percentageTableContainer::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        #percentageTableContainer::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        #percentageTableContainer::-webkit-scrollbar-thumb {
            background: #801c32;
            border-radius: 4px;
        }
        #percentageTableContainer::-webkit-scrollbar-thumb:hover {
            background: #a52d45;
        }
        #percentageTable {
            width: auto;
            min-width: 100%;
            table-layout: auto;
            border-collapse: collapse;
            box-sizing: border-box;
            display: table;
        }
        #percentageTable th,
        #percentageTable td {
            box-sizing: border-box;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        #agentPercentageTab {
            width: 100%;
            max-width: 100%;
            overflow-x: hidden;
            box-sizing: border-box;
        }
        #agentPercentageTab .section {
            width: 100%;
            max-width: 100%;
            overflow-x: hidden;
            box-sizing: border-box;
        }
        .section::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(
                45deg,
                transparent 30%,
                rgba(128, 28, 50, 0.05) 50%,
                transparent 70%
            );
            transform: rotate(45deg);
            transition: all 0.6s ease;
            opacity: 0;
        }
        .section:hover::before {
            display: none;
        }
        .section:hover {
            transform: none;
            box-shadow: 
                0 20px 50px var(--shadow-md),
                0 10px 30px var(--shadow-sm);
            border-color: var(--primary-color);
        }
        .section-title {
            font-size: 1.4rem;
            font-weight: 900;
            color: var(--primary-color);
            margin-bottom: 20px;
            padding-bottom: 14px;
            border-bottom: 3px solid var(--primary-color);
            display: flex;
            align-items: center;
            gap: 12px;
            letter-spacing: 0.5px;
            position: relative;
            transition: color 0.3s ease, border-color 0.3s ease;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            text-rendering: optimizeLegibility;
            line-height: 1.3;
            text-shadow: 0 2px 4px rgba(128, 28, 50, 0.15);
        }
        .file-upload {
            border: 2px dashed var(--primary-color);
            border-radius: 12px;
            padding: 30px 25px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 20px;
            background: var(--bg-secondary);
            position: relative;
            overflow: hidden;
            box-shadow: 
                0 10px 30px var(--shadow-sm),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
        }
        .file-upload::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(128, 28, 50, 0.1), transparent);
            transition: left 0.5s ease;
        }
        .file-upload:hover::before {
            left: 100%;
        }
        .file-upload:hover {
            transform: translateY(-2px);
            box-shadow: 
                0 8px 20px var(--shadow-md),
                0 4px 10px var(--shadow-sm),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            background: var(--bg-tertiary);
            border-color: var(--primary-color);
        }
        .file-upload.dragover {
            transform: scale(1.05);
            box-shadow: 
                0 25px 60px rgba(128, 28, 50, 0.2),
                0 15px 40px rgba(128, 28, 50, 0.15),
                inset 0 1px 0 rgba(255, 255, 255, 0.5);
            border-color: #801c32;
        }
        .file-upload p {
            margin: 0;
            font-size: 1.15rem;
            font-weight: 700;
            color: var(--primary-color);
            position: relative;
            z-index: 2;
            letter-spacing: 0.8px;
            transition: color 0.3s ease;
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 700;
            margin: 6px 5px;
            transition: all 0.3s ease;
            box-shadow: 
                0 3px 8px rgba(0, 0, 0, 0.12),
                0 2px 4px rgba(0, 0, 0, 0.08);
            position: relative;
            overflow: hidden;
            letter-spacing: 0.3px;
            color: #ffffff;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            text-rendering: optimizeLegibility;
            line-height: 1.4;
        }
        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255,255,255,0.3);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: all 0.6s ease;
        }
        .btn:active::before {
            width: 400px;
            height: 400px;
        }
        .btn-primary {
            background: var(--primary-color);
            box-shadow: 
                0 8px 25px var(--shadow-md),
                0 4px 15px var(--shadow-sm);
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            background: var(--primary-hover);
            box-shadow: 
                0 6px 16px var(--shadow-md),
                0 3px 8px var(--shadow-sm);
        }
        .btn-success {
            background: linear-gradient(135deg, #10b981, #059669);
            box-shadow: 
                0 8px 25px rgba(16, 185, 129, 0.4),
                0 4px 15px rgba(16, 185, 129, 0.3);
        }
        .btn-success:hover {
            transform: translateY(-2px);
            background: linear-gradient(135deg, #059669, #047857);
            box-shadow: 
                0 6px 16px rgba(16, 185, 129, 0.4),
                0 3px 8px rgba(16, 185, 129, 0.3);
        }
        .btn-warning {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            box-shadow: 
                0 8px 25px rgba(245, 158, 11, 0.4),
                0 4px 15px rgba(245, 158, 11, 0.3);
        }
        .btn-warning:hover {
            transform: translateY(-5px) scale(1.05);
            background: linear-gradient(135deg, #d97706, #b45309);
            box-shadow: 
                0 15px 40px rgba(245, 158, 11, 0.5),
                0 8px 25px rgba(245, 158, 11, 0.4);
        }
        .btn-danger {
            background: linear-gradient(180deg, #ef4444 0%, #dc2626 100%);
            color: #ffffff;
            border-color: rgba(239, 68, 68, 0.5);
        }
        .btn-danger:hover {
            background: linear-gradient(180deg, #dc2626 0%, #b91c1c 100%);
            transform: translateY(-2px);
            box-shadow: 
                0 8px 25px rgba(239, 68, 68, 0.4),
                0 0 20px rgba(239, 68, 68, 0.3);
        }
        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin: 20px 0;
            padding: 10px;
        }
        .agents-grid-improved {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
            margin: 20px 0;
            padding: 0;
            width: 100%;
            box-sizing: border-box;
        }
        .result-card {
            background: var(--card-bg);
            border-radius: 10px;
            padding: 12px 10px;
            text-align: center;
            box-shadow: 
                0 3px 10px var(--shadow-sm),
                0 2px 5px var(--shadow-sm);
            border: 1.5px solid var(--border-light);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            color: var(--text-primary);
        }
        .result-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(128, 28, 50, 0.1), transparent);
            transition: left 0.6s ease;
        }
        .result-card:hover::before {
            left: 100%;
        }
        .result-card:hover {
            transform: translateY(-2px);
            box-shadow: 
                0 6px 16px var(--shadow-md),
                0 3px 8px var(--shadow-sm);
            border-color: var(--primary-color);
        }
        .result-card.bronze {
            border-top: 3px solid #f59e0b;
        }
        .result-card.silver {
            border-top: 3px solid #94a3b8;
        }
        .result-card.gold {
            border-top: 3px solid #fbbf24;
        }
        .result-card.platinum {
            border-top: 3px solid #a855f7;
        }
        .result-card h3 {
            color: var(--primary-color);
            margin-bottom: 8px;
            font-size: 0.85rem;
            font-weight: 700;
            letter-spacing: 0.3px;
            position: relative;
            z-index: 2;
            text-transform: uppercase;
            transition: color 0.3s ease;
        }
        .result-card .count {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--primary-color);
            margin-bottom: 8px;
            line-height: 1.1;
            position: relative;
            z-index: 2;
            transition: color 0.3s ease;
        }
        .result-card .amount {
            color: var(--text-primary);
            font-weight: 600;
            font-size: 0.9rem;
            position: relative;
            z-index: 2;
            margin: 8px 0;
            padding: 6px 0;
            border-top: 1px solid var(--border-light);
            transition: color 0.3s ease, border-color 0.3s ease;
        }
        .result-card .amount:first-of-type {
            border-top: none;
        }
        .agent-summary-card {
            transition: all 0.3s ease;
        }
        .agent-summary-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 6px 16px var(--shadow-md);
            border-color: var(--primary-color);
        }
        .agent-info {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: 
                0 4px 12px var(--shadow-md),
                0 2px 6px var(--shadow-sm);
            position: relative;
            overflow: hidden;
            border: 2px solid var(--primary-color);
            color: var(--text-primary);
            transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
        }
        .agent-info::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(128, 28, 50, 0.05), transparent);
            transform: rotate(45deg);
        }
        .agent-info h3 {
            margin-bottom: 15px;
            font-size: 1.3rem;
            font-weight: 800;
            position: relative;
            z-index: 2;
            color: var(--primary-color);
            letter-spacing: 1px;
            text-transform: uppercase;
            transition: color 0.3s ease;
        }
        .agent-info p {
            position: relative;
            z-index: 2;
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--text-primary);
            transition: color 0.3s ease;
        }
        .hidden {
            display: none;
        }
        .loading {
            display: none;
            text-align: center;
            padding: 30px 20px;
            background: var(--card-bg);
            border-radius: 12px;
            margin: 20px 0;
            box-shadow: 
                0 4px 12px var(--shadow-md),
                0 2px 6px var(--shadow-sm);
            border: 2px solid var(--primary-color);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        .spinner {
            border: 4px solid var(--shadow-sm);
            border-top: 4px solid var(--primary-color);
            border-right: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            margin: 0 auto 15px;
            box-shadow: 
                0 0 20px var(--shadow-md),
                0 3px 10px var(--shadow-sm);
        }
        .loading p {
            color: var(--primary-color);
            font-weight: 700;
            font-size: 0.95rem;
            letter-spacing: 0.5px;
            transition: color 0.3s ease;
        }
        .error-message {
            background: var(--card-bg);
            color: #e53e3e;
            padding: 12px 18px;
            border-radius: 10px;
            margin: 15px 0;
            border: 2px solid #e53e3e;
            font-weight: 700;
            font-size: 0.9rem;
            box-shadow: 
                0 4px 12px var(--shadow-md),
                0 2px 6px var(--shadow-sm);
            letter-spacing: 0.3px;
            transition: background-color 0.3s ease;
        }
        .success-message {
            background: var(--card-bg);
            color: var(--primary-color);
            padding: 12px 18px;
            border-radius: 10px;
            margin: 15px 0;
            border: 2px solid var(--primary-color);
            font-weight: 700;
            font-size: 0.9rem;
            box-shadow: 
                0 4px 12px var(--shadow-md),
                0 2px 6px var(--shadow-sm);
            letter-spacing: 0.3px;
            transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
        }
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                position: relative;
                height: auto;
                border-left: none;
                border-bottom: 2px solid #801c32;
            }
            .main-content {
                margin-right: 0;
                padding: 20px;
            }
            .results-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            .section {
                padding: 25px 20px;
            }
            .section-title {
                font-size: 1.5rem;
            }
            .btn {
                padding: 12px 24px;
                font-size: 14px;
                margin: 8px 4px;
            }
            .file-upload {
                padding: 30px 20px;
            }
            .login-form {
                margin: 20px;
                padding: 40px 25px;
            }
        }
        .date-time-bar {
            width: 100%;
            text-align: center;
            margin: 10px 0 0 0;
        }
        #currentDateTime {
            font-size: 0.95rem;
            font-weight: 700;
            color: #801c32;
            background: #ffffff;
            padding: 8px 18px;
            border-radius: 6px;
            display: inline-block;
            letter-spacing: 1px;
            box-shadow: 
                0 3px 8px rgba(128, 28, 50, 0.12),
                0 0 0 1px rgba(128, 28, 50, 0.15);
            position: relative;
            z-index: 2;
            margin-top: 10px;
            border: 1.5px solid #801c32;
        }
        @media print {
            body * {
                visibility: hidden;
            }
            .dashboard, 
            .dashboard * {
                visibility: visible;
            }
            .login-screen {
                display: none !important;
            }
            .dashboard {
                display: block !important;
            }
            .header {
                background: #667eea !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            .tabs {
                display: none;
            }
            .tab-content {
                display: block !important;
            }
            .tab-content:not(.active) {
                display: none !important;
            }
            .btn {
                display: none;
            }
            .file-upload {
                display: none;
            }
            .results-grid {
                break-inside: avoid;
                page-break-inside: avoid;
            }
            .result-card {
                break-inside: avoid;
                page-break-inside: avoid;
                border: 1px solid #ccc !important;
            }
            .agent-info {
                background: #28a745 !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
        }
        .sidebar-header .author-name {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-align: center;
            margin: 8px auto 0;
            letter-spacing: 0.5px;
            padding: 0;
            background: transparent;
            border: none;
            display: block;
            width: 100%;
            box-shadow: none;
            cursor: default;
            pointer-events: none;
        }
        [data-theme="dark"] .sidebar-header .author-name {
            color: var(--text-primary) !important;
            opacity: 0.9;
        }
        .author-info-popup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border-radius: 24px;
            padding: 0;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.25), 0 10px 30px rgba(128, 28, 50, 0.15);
            border: 2px solid #801c32;
            z-index: 10001;
            min-width: 480px;
            max-width: 600px;
            width: 90%;
            overflow: hidden;
        }
        [data-theme="dark"] .author-info-popup {
            background: linear-gradient(135deg, #2d2d2d 0%, #1a1a1a 100%);
            border-color: #ff4757;
        }
        .author-info-popup.show {
            display: block;
        }
        .popup-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 10000;
            backdrop-filter: blur(6px);
        }
        .popup-overlay.show {
            display: block;
        }
        .popup-close {
            position: absolute;
            top: 15px;
            left: 15px;
            width: 36px;
            height: 36px;
            background: rgba(128, 28, 50, 0.1);
            border: 2px solid #801c32;
            border-radius: 50%;
            color: #801c32;
            font-size: 1.5rem;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            line-height: 1;
        }
        .popup-close:hover {
            background: #801c32;
            color: white;
            box-shadow: 0 4px 12px rgba(128, 28, 50, 0.4);
        }
        [data-theme="dark"] .popup-close {
            background: rgba(255, 71, 87, 0.15);
            border-color: #ff4757;
            color: #ff4757;
        }
        [data-theme="dark"] .popup-close:hover {
            background: #ff4757;
            color: white;
        }
        .popup-header {
            text-align: center;
            margin: 0;
            padding: 30px 40px 20px;
            background: linear-gradient(135deg, #801c32 0%, #a52d45 100%);
            color: white;
            position: relative;
        }
        [data-theme="dark"] .popup-header {
            background: linear-gradient(135deg, #ff4757 0%, #ff6b7a 100%);
        }
        .popup-header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 80px;
            height: 4px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 2px;
        }
        .popup-header h2 {
            color: white;
            font-size: 1.5rem;
            font-weight: 700;
            margin: 0;
            letter-spacing: 1px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        .popup-content {
            display: flex;
            flex-direction: column;
            gap: 16px;
            padding: 30px 40px;
            background: var(--bg-primary);
        }
        .info-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 18px 20px;
            background: var(--bg-secondary);
            border-radius: 16px;
            border: 2px solid var(--border-light);
            flex-direction: row-reverse;
            position: relative;
            overflow: hidden;
        }
        .info-item::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(180deg, #801c32 0%, #a52d45 100%);
        }
        [data-theme="dark"] .info-item::before {
            background: linear-gradient(180deg, #ff4757 0%, #ff6b7a 100%);
        }
        .info-item:hover {
            background: var(--bg-tertiary);
            border-color: var(--primary-color);
            box-shadow: 0 8px 20px var(--shadow-md);
        }
        .info-icon {
            font-size: 1.8rem;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, rgba(128, 28, 50, 0.1) 0%, rgba(128, 28, 50, 0.15) 100%);
            border-radius: 12px;
            flex-shrink: 0;
        }
        [data-theme="dark"] .info-icon {
            background: linear-gradient(135deg, rgba(255, 71, 87, 0.15) 0%, rgba(255, 71, 87, 0.25) 100%);
        }
        .info-item:hover .info-icon {
            background: linear-gradient(135deg, rgba(128, 28, 50, 0.2) 0%, rgba(128, 28, 50, 0.3) 100%);
        }
        [data-theme="dark"] .info-item:hover .info-icon {
            background: linear-gradient(135deg, rgba(255, 71, 87, 0.25) 0%, rgba(255, 71, 87, 0.35) 100%);
        }
        .info-text {
            flex: 0 0 auto;
            color: #1a1a1a;
            font-size: 0.9rem;
            font-weight: 600;
            min-width: 120px;
            text-align: left;
        }
        [data-theme="dark"] .info-text {
            color: #f5f5f5;
        }
        .info-value {
            color: var(--primary-color);
            font-weight: 700;
            font-size: 1rem;
            flex: 1;
            text-align: left;
            direction: ltr;
            white-space: nowrap;
        }
        [data-theme="dark"] .info-value {
            color: #ff6b7a;
        }
        .info-item:hover .info-value {
            color: var(--primary-color);
        }
        [data-theme="dark"] .info-item:hover .info-value {
            color: #ff4757;
        }
        .info-action {
            padding: 8px 18px;
            background: linear-gradient(135deg, #801c32 0%, #a52d45 100%);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 700;
            white-space: nowrap;
            flex-shrink: 0;
            box-shadow: 0 2px 8px rgba(128, 28, 50, 0.3);
            position: relative;
            overflow: hidden;
        }
        [data-theme="dark"] .info-action {
            background: linear-gradient(135deg, #ff4757 0%, #ff6b7a 100%);
            box-shadow: 0 2px 8px rgba(255, 71, 87, 0.3);
        }
        .info-action:hover {
            box-shadow: 0 4px 16px rgba(128, 28, 50, 0.4);
        }
        [data-theme="dark"] .info-action:hover {
            box-shadow: 0 4px 16px rgba(255, 71, 87, 0.4);
        }
        .settings-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 20px;
        }
        .settings-section {
            background: var(--card-bg);
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 2px 12px var(--shadow-sm);
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            color: var(--text-primary);
        }
        .settings-section::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(180deg, #801c32, #a52d45);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .settings-section:hover {
            box-shadow: 0 4px 20px rgba(128, 28, 50, 0.15);
            border-color: rgba(128, 28, 50, 0.3);
            transform: translateY(-2px);
        }
        .settings-section:hover::before {
            opacity: 1;
        }
        .settings-section h4 {
            color: var(--primary-color);
            margin-bottom: 18px;
            font-size: 1.1rem;
            font-weight: 700;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 12px;
            letter-spacing: 0.3px;
            transition: color 0.3s ease, border-color 0.3s ease;
        }
        .settings-group {
            margin-bottom: 18px;
        }
        .settings-group:last-child {
            margin-bottom: 0;
        }
        .settings-group label {
            display: block;
            color: #1a1a1a;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 0.9rem;
            transition: color 0.3s ease;
        }
        [data-theme="dark"] .settings-group label {
            color: #f5f5f5;
        }
        .settings-input {
            width: 100%;
            padding: 10px 14px;
            border: 2px solid var(--input-border);
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 500;
            transition: all 0.3s ease;
            background: var(--input-bg);
            color: var(--text-primary);
            box-sizing: border-box;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            text-rendering: optimizeLegibility;
            line-height: 1.5;
        }
        .settings-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px var(--shadow-sm);
            background: var(--input-bg);
            font-weight: 600;
        }
        .settings-input:hover {
            border-color: var(--border-color);
        }
        .settings-checkbox {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            padding: 8px;
            border-radius: 6px;
            transition: all 0.2s ease;
        }
        .settings-checkbox:hover {
            background: rgba(128, 28, 50, 0.05);
        }
        .settings-checkbox input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: #801c32;
        }
        .settings-section .btn {
            margin-top: 12px;
            width: 100%;
        }
        .settings-section .btn:not(:last-child) {
            margin-bottom: 10px;
        }
        .activity-log-container {
            background: #ffffff;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(128, 28, 50, 0.1);
            border: 1px solid rgba(128, 28, 50, 0.2);
            max-height: 600px;
            overflow-y: auto;
        }
        .activity-item {
            padding: 12px;
            margin-bottom: 10px;
            background: rgba(128, 28, 50, 0.05);
            border-radius: 8px;
            border-right: 4px solid #801c32;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }
        .activity-item:hover {
            background: rgba(128, 28, 50, 0.1);
            transform: translateX(-3px);
        }
        .activity-item .activity-icon {
            font-size: 1.5rem;
            margin-left: 10px;
        }
        .activity-item .activity-details {
            flex: 1;
        }
        .activity-item .activity-time {
            color: #1a1a1a;
            font-size: 0.85rem;
            font-weight: 600;
        }
        [data-theme="dark"] .activity-item .activity-time {
            color: #f5f5f5;
        }
        .agent-card {
            background: #ffffff;
            border-radius: 15px;
            padding: 20px;
            border: 2px solid #e0e0e0;
            box-shadow: 0 6px 20px rgba(128, 28, 50, 0.1);
            transition: all 0.3s ease;
            position: relative;
        }
        .agent-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 30px rgba(128, 28, 50, 0.15);
            border-color: #801c32;
        }
        .agent-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e0e0e0;
        }
        .agent-card-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: #801c32;
        }
        .agent-card-actions {
            display: flex;
            gap: 10px;
        }
        .agent-card-actions button {
            padding: 8px 15px;
            font-size: 0.9rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .btn-edit {
            background: #2C5F8D;
            color: white;
        }
        .btn-send {
            background: #25D366;
            color: white;
        }
        .btn-delete {
            background: #ef4444;
            color: white;
        }
        .agent-card-improved {
            background: var(--card-bg);
            border-radius: 10px;
            padding: 10px 15px;
            border: 2px solid rgba(128, 28, 50, 0.2);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: visible;
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 15px;
            color: #1a1a1a;
            width: 100%;
            box-sizing: border-box;
            min-height: auto;
        }
        [data-theme="dark"] .agent-card-improved {
            border: 2px solid rgba(255, 255, 255, 0.2);
            color: #f5f5f5;
        }
        .agent-card-improved::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, var(--primary-color), var(--primary-hover));
            transform: translateY(-100%);
            transition: transform 0.3s ease;
        }
        .agent-card-improved:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(128, 28, 50, 0.12);
            border-color: var(--primary-color);
        }
        .agent-card-improved:hover::before {
            transform: translateY(0);
        }
        .agent-card-header-improved {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: flex-start;
            gap: 6px;
            flex: 0 0 180px;
            min-width: 180px;
            max-width: 180px;
            padding-right: 12px;
            border-right: 1px solid rgba(128, 28, 50, 0.1);
            box-sizing: border-box;
        }
        .agent-name-section {
            flex: 1;
            min-width: 0;
            width: 100%;
            overflow: hidden;
            box-sizing: border-box;
        }
        .agent-name-title {
            font-size: 0.95rem;
            font-weight: 800;
            color: #1a1a1a;
            margin: 0 0 3px 0;
            line-height: 1.3;
            letter-spacing: 0.1px;
            word-wrap: break-word;
            overflow-wrap: break-word;
            transition: color 0.3s ease;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            width: 100%;
            box-sizing: border-box;
        }
        [data-theme="dark"] .agent-name-title {
            color: #f5f5f5;
        }
        .agent-name-subtitle {
            font-size: 0.75rem;
            font-weight: 600;
            color: #1a1a1a;
            margin: 0 0 4px 0;
            line-height: 1.3;
            transition: color 0.3s ease;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            width: 100%;
            box-sizing: border-box;
        }
        [data-theme="dark"] .agent-name-subtitle {
            color: #f5f5f5;
        }
        .agent-badge {
            display: inline-block;
            padding: 3px 8px;
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            border-radius: 10px;
            font-size: 0.65rem;
            font-weight: 700;
            box-shadow: 0 1px 4px rgba(40, 167, 69, 0.2);
            margin-top: 4px;
            letter-spacing: 0.1px;
        }
        .agent-badge-empty {
            display: inline-block;
            padding: 3px 8px;
            background: rgba(128, 28, 50, 0.08);
            color: #1a1a1a;
            border-radius: 10px;
            font-size: 0.65rem;
            font-weight: 600;
            margin-top: 4px;
            border: 1px solid rgba(128, 28, 50, 0.15);
        }
        [data-theme="dark"] .agent-badge-empty {
            color: #f5f5f5;
        }
        .agent-actions-improved {
            display: flex;
            gap: 4px;
            flex-shrink: 0;
            flex-wrap: wrap;
            align-items: center;
            justify-content: flex-start;
            min-width: auto;
            max-width: none;
            box-sizing: border-box;
            width: 100%;
        }
        .btn-action {
            padding: 5px 8px;
            min-width: 55px;
            width: auto;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 0.65rem;
            font-weight: 700;
            color: white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            letter-spacing: 0.05px;
            white-space: nowrap;
            line-height: 1.3;
            flex-shrink: 0;
        }
        .btn-action:hover:not(:disabled) {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
        }
        .btn-action:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        .btn-action-edit {
            background: linear-gradient(135deg, #2C5F8D, #1e4a6b);
        }
        .btn-action-edit:hover:not(:disabled) {
            background: linear-gradient(135deg, #1e4a6b, #153d5c);
        }
        .btn-action-send {
            background: linear-gradient(135deg, #25D366, #128C7E);
        }
        .btn-action-send:hover:not(:disabled) {
            background: linear-gradient(135deg, #128C7E, #0d6e5f);
        }
        .btn-action-delete {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }
        .btn-action-delete:hover:not(:disabled) {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
        }
        .agent-info-section {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 4px;
            flex-wrap: nowrap;
            flex: 0 0 200px;
            min-width: 200px;
            max-width: 200px;
            padding-right: 12px;
            border-right: 1px solid rgba(128, 28, 50, 0.1);
            box-sizing: border-box;
        }
        .info-item-improved {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 4px 8px;
            background: rgba(128, 28, 50, 0.04);
            border-radius: 5px;
            transition: all 0.25s ease;
            border: 1px solid rgba(128, 28, 50, 0.1);
            white-space: nowrap;
            margin: 0;
            box-sizing: border-box;
            width: 100%;
            clear: both;
            font-size: 0.75rem;
        }
        .info-item-improved:hover {
            background: rgba(128, 28, 50, 0.08);
            border-color: rgba(128, 28, 50, 0.2);
        }
        .info-label {
            font-weight: 600;
            color: #1a1a1a;
            min-width: 45px;
            font-size: 0.75rem;
            transition: color 0.3s ease;
        }
        [data-theme="dark"] .info-label {
            color: #f5f5f5;
        }
        .info-value {
            font-weight: 700;
            color: #1a1a1a;
            flex: 1;
            text-align: right;
            direction: ltr;
            font-size: 0.8rem;
            word-break: break-all;
            transition: color 0.3s ease;
        }
        [data-theme="dark"] .info-value {
            color: #f5f5f5;
        }
        .info-label-empty {
            color: #1a1a1a;
            font-style: italic;
            font-size: 0.85rem;
            text-align: center;
            width: 100%;
            padding: 8px;
            transition: color 0.3s ease;
        }
        [data-theme="dark"] .info-label-empty {
            color: #f5f5f5;
        }
        .agent-reports-section {
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 8px;
            flex: 1;
            min-width: 0;
            box-sizing: border-box;
            margin-top: 0;
            padding-top: 0;
            padding-right: 12px;
            border-right: 1px solid rgba(128, 28, 50, 0.1);
            flex-wrap: wrap;
        }
        .reports-grid {
            display: flex;
            flex-direction: row;
            gap: 6px;
            flex-wrap: wrap;
            align-items: center;
            margin-top: 0;
            margin-bottom: 0;
            flex: 1;
        }
        .report-item {
            padding: 6px 12px;
            border-radius: 6px;
            text-align: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid transparent;
            position: relative;
            overflow: hidden;
            min-width: 100px;
            max-width: 100px;
            flex: 1 1 100px;
            white-space: nowrap;
        }
        .report-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s ease;
        }
        .report-item:hover::before {
            left: 100%;
        }
        .report-item:hover {
            transform: translateY(-2px) scale(1.03);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            border-color: rgba(128, 28, 50, 0.3);
        }
        .report-basic {
            background: linear-gradient(135deg, #5b12fa 0%, #0629f1 100%);
            border-color: #e43007;
        }
        .report-basic .report-label,
        .report-basic .report-value,
        .report-basic .currency {
            color: #ffffff !important;
        }
        .report-advanced {
            background: linear-gradient(135deg, #f40202 0%, #fd0000 100%);
            border-color: #000000;
        }
        .report-advanced .report-label,
        .report-advanced .report-value,
        .report-advanced .currency {
            color: #ffffff !important;
        }
        .report-twomonths {
            background: linear-gradient(135deg, #00ff73 0%, #00f90c 100%);
            border-color: #f59e0b;
        }
        .report-twomonths .report-label,
        .report-twomonths .report-value,
        .report-twomonths .currency {
            color: #ffffff !important;
        }
        .report-label {
            font-size: 0.65rem;
            font-weight: 700;
            color: #1a1a1a;
            margin-bottom: 3px;
            letter-spacing: 0.1px;
        }
        [data-theme="dark"] .report-label {
            color: #f5f5f5;
        }
        [data-theme="dark"] .report-basic .report-label,
        [data-theme="dark"] .report-basic .report-value,
        [data-theme="dark"] .report-basic .currency {
            color: #ffffff !important;
        }
        [data-theme="dark"] .report-advanced .report-label,
        [data-theme="dark"] .report-advanced .report-value,
        [data-theme="dark"] .report-advanced .currency {
            color: #ffffff !important;
        }
        [data-theme="dark"] .report-twomonths .report-label,
        [data-theme="dark"] .report-twomonths .report-value,
        [data-theme="dark"] .report-twomonths .currency {
            color: #ffffff !important;
        }
        .report-value {
            font-size: 0.75rem;
            font-weight: 900;
            color: #1a1a1a;
            line-height: 1.2;
        }
        [data-theme="dark"] .report-value {
            color: #f5f5f5;
        }
        .currency {
            font-size: 0.65rem;
            font-weight: 600;
            color: #1a1a1a;
        }
        [data-theme="dark"] .currency {
            color: #f5f5f5;
        }
        .agent-total-section {
            background: linear-gradient(135deg, #801c32 0%, #a52d45 100%);
            padding: 6px 12px;
            border-radius: 6px;
            text-align: center;
            color: white;
            box-shadow: 0 2px 8px rgba(128, 28, 50, 0.2);
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.1);
            min-width: 100px;
            max-width: 100px;
            flex: 0 0 100px;
            white-space: nowrap;
            margin-top: 0;
        }
        .agent-total-section::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
        }
        .total-label {
            font-size: 0.7rem;
            font-weight: 700;
            margin-bottom: 2px;
            opacity: 0.95;
            letter-spacing: 0.1px;
            position: relative;
            z-index: 1;
        }
        .total-value {
            font-size: 0.9rem;
            font-weight: 900;
            line-height: 1.2;
            position: relative;
            z-index: 1;
        }
        .total-value .currency {
            font-size: 0.75rem;
            opacity: 0.95;
            color: rgba(255, 255, 255, 0.98);
            font-weight: 700;
        }
        .no-reports-message {
            text-align: center;
            padding: 10px 12px;
            background: rgba(128, 28, 50, 0.04);
            border-radius: 8px;
            border: 1px dashed rgba(128, 28, 50, 0.25);
            margin: 0;
            box-sizing: border-box;
            width: 100%;
            clear: both;
        }
        .no-reports-message p {
            color: #999;
            font-size: 0.75rem;
            margin: 0;
            font-style: italic;
            line-height: 1.4;
            padding: 0;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 10002;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
        }
        [data-theme="dark"] .modal {
            background: rgba(0, 0, 0, 0.8);
        }
        .modal.show {
            display: flex;
        }
        .modal-content {
            background: var(--modal-bg);
            padding: 30px;
            border-radius: 20px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px var(--shadow-lg);
            border: 3px solid var(--primary-color);
            color: var(--text-primary);
            transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--primary-color);
            transition: border-color 0.3s ease;
        }
        .modal-header h3 {
            color: var(--primary-color);
            font-size: 1.5rem;
            transition: color 0.3s ease;
        }
        .modal-close {
            background: transparent;
            border: none;
            font-size: 2rem;
            color: var(--primary-color);
            cursor: pointer;
            padding: 0;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s ease;
        }
        .modal-close:hover {
            background: var(--nav-hover);
        }
        .message-customization {
            max-width: 700px;
            width: 95%;
        }
        .offer-options {
            margin: 20px 0;
            padding: 15px;
            background: rgba(128, 28, 50, 0.05);
            border-radius: 10px;
        }
        .offer-options h4 {
            color: #801c32;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }
        .offer-checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 15px;
        }
        .offer-checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 15px;
            background: white;
            border-radius: 8px;
            border: 2px solid #e0e0e0;
            cursor: pointer;
            transition: all 0.3s ease;
            flex: 1;
            min-width: 150px;
        }
        .offer-checkbox-item:hover {
            border-color: #801c32;
            background: rgba(128, 28, 50, 0.05);
        }
        .offer-checkbox-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        .offer-checkbox-item label {
            cursor: pointer;
            font-weight: 600;
            flex: 1;
            margin: 0;
        }
        .message-textarea,
        textarea,
        select {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            text-rendering: optimizeLegibility;
            font-weight: 500;
            line-height: 1.6;
        }
        .message-textarea {
            width: 100%;
            min-height: 150px;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1rem;
            font-family: 'Cairo', 'Segoe UI', 'Arial', sans-serif;
            font-weight: 500;
            resize: vertical;
            direction: rtl;
            text-align: right;
            line-height: 1.6;
        }
        .message-textarea:focus {
            outline: none;
            border-color: #801c32;
            box-shadow: 0 0 0 3px rgba(128, 28, 50, 0.1);
            font-weight: 600;
        }
        .message-preview {
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 2px solid #e0e0e0;
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
            font-size: 0.95rem;
            direction: rtl;
            text-align: right;
        }
        .preview-label {
            font-weight: 700;
            color: #801c32;
            margin-bottom: 10px;
            display: block;
        }
        .info-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        .info-btn {
            padding: 8px 15px;
            background: #2C5F8D;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.3s ease;
        }
        .info-btn:hover {
            background: #1e4a6b;
            transform: none;
        }
        *,
        *::before,
        *::after {
            transition: none !important;
            animation: none !important;
        }
        *:hover,
        *:focus,
        *:active {
            transform: none !important;
        }
    </style>
</head>
<body>
    <div id="loginScreen" class="login-container">
        <div class="login-card">
            <h1>ŸÇÿ≥ŸÖ ÿßŸÑÿ≠ÿ≥ÿßÿ®ÿßÿ™</h1>
            <div id="loginAlert"></div>
            <div class="form-group">
                <label for="loginUsername">ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ</label>
                <input type="text" id="loginUsername" placeholder="ÿ£ÿØÿÆŸÑ ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ">
            </div>
            <div class="form-group">
                <label for="loginPassword">ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±</label>
                <input type="password" id="loginPassword" placeholder="ÿ£ÿØÿÆŸÑ ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±">
            </div>
            <div class="btn-group" style="flex-direction: column;">
                <button class="btn btn-primary" id="loginButton" style="width: 100%;">ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ</button>
            </div>
        </div>
    </div>

    <div class="container">
        <div id="dashboard" class="dashboard hidden">
            <button class="sidebar-toggle-btn sidebar-toggle-external" id="sidebarToggleBtnExternal" onclick="toggleSidebar()" title="ÿ•ÿ∏Ÿáÿßÿ± ÿßŸÑŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ¨ÿßŸÜÿ®Ÿäÿ©">
                ‚ò∞
            </button>
            <div class="sidebar" id="sidebar">
                <div class="sidebar-header">
                    <div style="display: flex; gap: 10px; align-items: center; justify-content: flex-start; position: absolute; top: 15px; right: 15px; z-index: 10001; pointer-events: auto;">
                        <button class="theme-toggle-btn-small" onclick="toggleTheme()" id="themeToggleBtn" title="ÿ™ÿ®ÿØŸäŸÑ ÿßŸÑŸàÿ∂ÿπ ÿßŸÑŸÖÿ∏ŸÑŸÖ/ÿßŸÑŸÅÿßÿ™ÿ≠" style="pointer-events: auto; z-index: 10002;">
                            <span id="themeToggleIcon">üåô</span>
                        </button>
                        <button class="sidebar-toggle-btn" id="sidebarToggleBtn" onclick="toggleSidebar()" title="ÿ•ÿ∏Ÿáÿßÿ±/ÿ•ÿÆŸÅÿßÿ° ÿßŸÑŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ¨ÿßŸÜÿ®Ÿäÿ©" style="pointer-events: auto; z-index: 10002;">
                            ‚ò∞
                        </button>
                    </div>
                    <h1>ŸÇÿ≥ŸÖ ÿßŸÑÿ≠ÿ≥ÿßÿ®ÿßÿ™</h1>
                    <div class="sidebar-user-info" style="display: flex; flex-direction: column; align-items: center; gap: 8px; margin-top: 0;">
                        <div id="sidebarUser" class="sidebar-user-name" style="background: linear-gradient(135deg, #801c32, #a52d45); color: white; padding: 14px 18px; border-radius: 12px; font-weight: 700; font-size: 1rem; box-shadow: 0 4px 12px rgba(128, 28, 50, 0.4); text-align: center; letter-spacing: 0.5px; border: 2px solid rgba(255, 255, 255, 0.3); position: relative; cursor: pointer; user-select: none; -webkit-user-select: none; transition: all 0.3s ease; width: 100%; box-sizing: border-box;" onclick="toggleUserContactPopup(event)">
                            <div style="display: flex; flex-direction: column; align-items: center; gap: 4px;">
                                <div style="display: flex; align-items: center; justify-content: center; gap: 8px;">
                                    <span style="font-size: 1.3rem;"></span>
                                    <span style="font-size: 1.05rem; font-weight: 700;">Ameer Helwas</span>
                                </div>
                                <div style="font-size: 0.75rem; opacity: 0.9; font-weight: 500;"></div>
                            </div>
                            <div id="userContactPopup" class="user-contact-popup">
                                <div class="user-contact-item">
                                    <span class="user-contact-icon">
                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z" fill="#0078d4"/>
                                        </svg>
                                    </span>
                                    <a href="mailto:ameeralgaraawi@hotmail.com">Email</a>
                                </div>
                                <div class="user-contact-item">
                                    <span class="user-contact-icon">
                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z" fill="#E4405F"/>
                                        </svg>
                                    </span>
                                    <a href="https://instagram.com/ameer_7elwas" target="_blank">instagram</a>
                                </div>
                                <div class="user-contact-item">
                                    <span class="user-contact-icon">
                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M12 0C5.373 0 0 5.373 0 12s5.373 12 12 12 12-5.373 12-12S18.627 0 12 0zm5.894 8.221l-1.97 9.28c-.145.658-.537.818-1.084.508l-3-2.21-1.446 1.394c-.14.18-.357.295-.6.295-.002 0-.003 0-.005 0l.213-3.054 5.56-5.022c.24-.213-.054-.334-.373-.121l-6.869 4.326-2.96-.924c-.64-.203-.658-.64.135-.954l11.566-4.458c.538-.196 1.006.128.832.941z" fill="#0088cc"/>
                                        </svg>
                                    </span>
                                    <a href="https://t.me/ameer_7elwas" target="_blank">Telegram</a>
                                </div>
                                <div class="user-contact-item">
                                    <span class="user-contact-icon">
                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.98 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z" fill="#25D366"/>
                                        </svg>
                                    </span>
                                    <a href="https://wa.me/9647701024143" target="_blank">Ÿàÿßÿ™ÿ≥ÿßÿ®</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="sidebar-nav">
                    <div class="nav-item active" onclick="switchTab('summary')">
                        <span class="nav-icon"></span>
                        <span class="nav-text">ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©</span>
                    </div>
                    <div class="nav-item" onclick="switchTab('basic')">
                        <span class="nav-icon"></span>
                        <span class="nav-text">ÿßŸÑÿπÿ±ÿ∂ ÿßŸÑŸÖÿ¨ÿßŸÜŸä</span>
                    </div>
                    <div class="nav-item" onclick="switchTab('twoMonths')">
                        <span class="nav-icon"></span>
                        <span class="nav-text">ÿπÿ±ÿ∂ ÿ¥Ÿáÿ±ŸäŸÜ ŸÖÿÆŸÅÿ∂</span>
                    </div>
                    <div class="nav-item" onclick="switchTab('advanced')">
                        <span class="nav-icon"></span>
                        <span class="nav-text">ÿπÿ±ÿ∂ 3 ÿ£ÿ¥Ÿáÿ± ŸÖÿÆŸÅÿ∂</span>
                    </div>
                    <div class="nav-item" onclick="switchTab('agents')">
                        <span class="nav-icon"></span>
                        <span class="nav-text">ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸàŸÉŸÑÿßÿ° Ÿàÿπÿ±Ÿàÿ∂ŸáŸÖ</span>
                    </div>
                    <div class="nav-item" onclick="switchTab('agentPercentage')">
                        <span class="nav-icon"></span>
                        <span class="nav-text">ŸÜÿ≥ÿ®ÿ© ÿßŸÑŸàŸÉŸÑÿßÿ°</span>
                    </div>
                    <div class="nav-item" onclick="switchTab('activity')">
                        <span class="nav-icon"></span>
                        <span class="nav-text">ÿ≥ÿ¨ŸÑ ÿßŸÑÿπŸÖŸÑŸäÿßÿ™</span>
                    </div>
                    <div class="nav-item" onclick="switchTab('settings')">
                        <span class="nav-icon"></span>
                        <span class="nav-text">ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™</span>
                    </div>
                    <div class="nav-item" onclick="switchTab('archive')">
                        <span class="nav-icon"></span>
                        <span class="nav-text">ÿßŸÑÿ£ÿ±ÿ¥ŸäŸÅ</span>
                    </div>
                    <div class="nav-item admin-only" onclick="switchTab('users')" style="display: none;">
                        <span class="nav-icon"></span>
                        <span class="nav-text">ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ</span>
                    </div>
                </div>
                <div class="sidebar-footer">
                    <button class="btn btn-secondary" onclick="switchUser()" style="width: 100%; background: #6c757d; border-color: #6c757d; color: white; display: flex; align-items: center; justify-content: space-between; padding: 12px 16px;" id="switchUserBtn">
                        <span id="switchUserBtnName" style="font-weight: 600;">${loggedInUser || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'}</span>
                        <span style="margin-right: 5px; font-size: 1.1rem;">‚Üª</span>
                    </button>
                    <div class="date-info-sidebar" id="currentDateTime" style="margin-top: 10px;"></div>
                </div>
            </div>
            <div class="main-content">
            <div id="basicTab" class="tab-content">
                <div class="section">
                    <h3 class="section-title">
                         ÿ±ŸÅÿπ Excel ÿßŸÑŸàŸÉŸäŸÑ ŸÑÿ≠ÿ≥ÿßÿ® ÿßŸÑÿπÿ±ÿ∂ ÿßŸÑŸÖÿ¨ÿßŸÜŸä
                    </h3>
                    <div style="background: #fff3cd; border: 2px solid #ffc107; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                        <div style="display: flex; align-items: start; gap: 10px;">
                            <div style="font-size: 1.5rem; color: #ffc107;">‚ö†Ô∏è</div>
                            <div style="flex: 1;">
                                <h4 style="margin: 0 0 15px 0; color: #856404; font-size: 1.1rem; font-weight: 700;">ÿ™ŸÜÿ®ŸäŸá ŸÖŸáŸÖ</h4>
                                <p style="margin: 0 0 15px 0; color: #856404; font-size: 0.95rem; line-height: 1.8;">
                                    Ÿäÿ±ÿ¨Ÿâ ÿßŸÑÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ£ŸÜ ŸÖŸÑŸÅ ÿßŸÑŸÄ Excel ÿßŸÑŸÖÿ±ŸÅŸÇ ŸäÿπŸàÿØ ÿ•ŸÑŸâ ŸÜŸÅÿ≥ ÿßŸÑÿ¥Ÿáÿ± ÿßŸÑÿ≠ÿßŸÑŸä.
                                </p>
                                <p style="margin: 0 0 10px 0; color: #856404; font-size: 0.95rem; line-height: 1.8; font-weight: 600;">
                                    ŸÑŸÜ Ÿäÿ™ŸÖ ÿßÿ≠ÿ™ÿ≥ÿßÿ® ÿßŸÑŸÜÿ™ÿßÿ¶ÿ¨ ÿ®ÿµŸàÿ±ÿ© ÿµÿ≠Ÿäÿ≠ÿ© ŸÅŸä ÿßŸÑÿ≠ÿßŸÑÿßÿ™ ÿßŸÑÿ™ÿßŸÑŸäÿ©:
                                </p>
                                <ul style="margin: 0 0 15px 0; padding-right: 20px; color: #856404; font-size: 0.95rem; line-height: 1.8;">
                                    <li style="margin-bottom: 8px;">ÿ•ÿ∞ÿß ŸÉÿßŸÜ ÿßŸÑŸÖŸÑŸÅ Ÿäÿ™ÿ∂ŸÖŸÜ ÿ®ŸäÿßŸÜÿßÿ™ ŸÖŸÜ ÿ¥Ÿáÿ± ÿ≥ÿßÿ®ŸÇ.</li>
                                    <li style="margin-bottom: 8px;">ÿ£Ÿà ÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖŸÑŸÅ ÿßŸÑÿ¢ŸÜ ŸÑŸÉŸÜ ÿ™ÿßÿ±ŸäÿÆ ÿ®ŸäÿßŸÜÿßÿ™Ÿá ŸÇÿØŸäŸÖ.</li>
                                </ul>
                                <div style="background: #d4edda; border: 1px solid #c3e6cb; border-radius: 6px; padding: 12px; margin-bottom: 10px;">
                                    <div style="display: flex; align-items: start; gap: 8px;">
                                        <div style="font-size: 1.2rem; color: #28a745;">‚úÖ</div>
                                        <div style="flex: 1;">
                                            <strong style="color: #155724; display: block; margin-bottom: 8px;">ÿπŸÑŸâ ÿ≥ÿ®ŸäŸÑ ÿßŸÑŸÖÿ´ÿßŸÑ:</strong>
                                            <ul style="margin: 0; padding-right: 20px; color: #155724; font-size: 0.9rem; line-height: 1.8;">
                                                <li style="margin-bottom: 6px;">ŸÅŸä ÿ¥Ÿáÿ± ÿ™ÿ¥ÿ±ŸäŸÜ ÿßŸÑÿ£ŸàŸÑ (10) Ÿäÿ¨ÿ® ÿ£ŸÜ ŸäŸÉŸàŸÜ ÿßŸÑŸÖŸÑŸÅ ÿÆÿßÿµŸãÿß ÿ®ŸÜŸÅÿ≥ ÿßŸÑÿ¥Ÿáÿ± (10).</li>
                                                <li>ŸÅŸä ÿ¥Ÿáÿ± ÿ™ÿ¥ÿ±ŸäŸÜ ÿßŸÑÿ´ÿßŸÜŸä (11) Ÿäÿ¨ÿ® ÿ£ŸÜ ŸäŸÉŸàŸÜ ÿßŸÑŸÖŸÑŸÅ ÿÆÿßÿµŸãÿß ÿ®ÿßŸÑÿ¥Ÿáÿ± (11).</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                                <p style="margin: 0; color: #856404; font-size: 0.95rem; line-height: 1.8; font-weight: 600;">
                                       ÿ™Ÿèÿπÿ±ÿ∂ ŸÜÿ™ÿßÿ¶ÿ¨ ÿ∫Ÿäÿ± ÿØŸÇŸäŸÇÿ© ŸÅŸä ÿ≠ÿßŸÑ ÿπÿØŸÖ ÿ™ÿ∑ÿßÿ®ŸÇ ÿßŸÑÿ¥Ÿáÿ± ÿ®ŸäŸÜ ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑŸÖŸÑŸÅ ŸàÿßŸÑÿ¥Ÿáÿ± ÿßŸÑÿ≠ÿßŸÑŸä.
                                </p>
                            </div>
                        </div>
                    </div>
                    <div class="file-upload" id="basicFileUpload">
                        <p> ÿßÿ≥ÿ≠ÿ® ŸÖŸÑŸÅ Excel ÿ£Ÿà CSV ŸáŸÜÿß ÿ£Ÿà ÿßŸÜŸÇÿ± ŸÑŸÑÿßÿÆÿ™Ÿäÿßÿ±</p>
                        <input type="file" id="basicFileInput" accept=".xlsx,.xls,.csv" style="display: none;">
                    </div>
                </div>
                <div class="section">
                    <h3 class="section-title">
                         ÿ™ÿ≠ŸÑŸäŸÑ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿπÿ±ÿ∂ ÿßŸÑŸÖÿ¨ÿßŸÜŸä
                    </h3>
                    <p style="color: var(--text-primary); margin-bottom: 15px; font-size: 1rem; font-weight: 600;">
                    </p>
                    <button class="btn btn-primary" onclick="analyzeBasicData()">
                         ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
                    </button>
                    <button class="btn btn-warning" onclick="resetBasicResults()">
                         ŸÖÿ≥ÿ≠ ÿßŸÑŸÜÿ™ÿßÿ¶ÿ¨
                    </button>
                </div>
                <div id="basicResults" class="section hidden">
                    <h3 class="section-title">
                         ŸÜÿ™ÿßÿ¶ÿ¨ ÿßŸÑÿπÿ±ÿ∂ ÿßŸÑŸÖÿ¨ÿßŸÜŸä
                    </h3>
                    <div id="basicAgentInfo" class="agent-info"></div>
                    <div class="results-grid" id="basicResultsGrid"></div>
                    <div style="text-align: center; margin-top: 20px;">
                        <button class="btn btn-success" onclick="saveBasicReport()">
 ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ŸÇÿ±Ÿäÿ±
                        </button>
                        <button class="btn btn-warning" onclick="exportBasicData()">
 ÿ™ÿµÿØŸäÿ± ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
                        </button>
                        <button class="btn btn-success" onclick="exportBasicDetailsToExcel()">
 ÿ™ÿµÿØŸäÿ± Excel ÿ®ÿßŸÑÿ™ŸÅÿßÿµŸäŸÑ
                        </button>
                    </div>
                </div>
                <div id="basicLoading" class="loading">
                    <div class="spinner"></div>
                    <p>ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÑŸäŸÑ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿπÿ±ÿ∂ ÿßŸÑŸÖÿ¨ÿßŸÜŸä...</p>
                </div>
            </div>
            <div id="advancedTab" class="tab-content">
                <div class="section">
                    <h3 class="section-title">
 ÿ±ŸÅÿπ Excel ÿßŸÑŸàŸÉŸäŸÑ ŸÑÿ≠ÿ≥ÿßÿ® ÿßŸÑÿπÿ±ÿ∂ ÿßŸÑŸÖÿÆŸÅÿ∂ ŸÑÿ´ŸÑÿßÿ´ ÿ£ÿ¥Ÿáÿ±
                    </h3>
                    <div class="file-upload" id="advancedFileUpload">
                        <p> ÿßÿ≥ÿ≠ÿ® ŸÖŸÑŸÅ Excel ÿ£Ÿà CSV ŸáŸÜÿß ÿ£Ÿà ÿßŸÜŸÇÿ± ŸÑŸÑÿßÿÆÿ™Ÿäÿßÿ±</p>
                        <input type="file" id="advancedFileInput" accept=".xlsx,.xls,.csv" style="display: none;">
                    </div>
                </div>
                <div class="section">
                    <h3 class="section-title">
                         ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑÿπÿ±ÿ∂ ÿßŸÑŸÖÿÆŸÅÿ∂ ŸÑÿ´ŸÑÿßÿ´ ÿ£ÿ¥Ÿáÿ±
                    </h3>
                    <p style="color: #1a1a1a; margin-bottom: 15px; font-size: 1rem; font-weight: 600;">
                         Ÿäÿ™ŸÖ ÿ≠ÿ≥ÿßÿ® ÿßŸÑÿ™ŸÅÿπŸäŸÑ ÿπŸÜÿØ Ÿàÿ¨ŸàÿØ 3 ÿßÿ¥ÿ™ÿ±ÿßŸÉÿßÿ™ ŸÑŸÜŸÅÿ≥ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿÆŸÑÿßŸÑ 5 ÿ£ŸäÿßŸÖ<br>
                         ŸÖŸÇÿßÿ±ŸÜÿ© ÿ£ÿ≥ÿπÿßÿ± ÿßŸÑÿπÿ±ÿ∂ ÿßŸÑŸÖÿÆŸÅÿ∂ ŸÖÿπ ÿßŸÑÿ£ÿ≥ÿπÿßÿ± ÿßŸÑÿ±ÿ≥ŸÖŸäÿ© ŸÑÿ≠ÿ≥ÿßÿ® ÿßŸÑÿ±ÿßÿ¨ÿπ ŸÑŸÑŸàŸÉŸäŸÑ
                    </p>
                    <button class="btn btn-primary" onclick="analyzeAdvancedData()">
                         ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑÿ™ŸÅÿπŸäŸÑÿßÿ™
                    </button>
                    <button class="btn btn-warning" onclick="resetAdvancedResults()">
                         ŸÖÿ≥ÿ≠ ÿßŸÑŸÜÿ™ÿßÿ¶ÿ¨
                    </button>
                </div>
                <div id="advancedResults" class="section hidden">
                    <h3 class="section-title">
                         ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉÿßÿ™ ŸàÿßŸÑŸÖÿ®ÿßŸÑÿ∫ 
                    </h3>
                    <div id="advancedAgentInfo" class="agent-info"></div>
                    <div class="results-grid" id="advancedResultsGrid"></div>
                    <div style="text-align: center; margin-top: 20px;">
                        <button class="btn btn-success" onclick="saveAdvancedReport()">
 ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ŸÇÿ±Ÿäÿ±
                        </button>
                        <button class="btn btn-warning" onclick="exportAdvancedData()">
 ÿ™ÿµÿØŸäÿ± ŸÑŸÑŸàŸÉŸäŸÑ
                        </button>
                        <button class="btn btn-success" onclick="exportAdvancedDetailsToExcel()">
 ÿ™ÿµÿØŸäÿ± Excel ÿ®ÿßŸÑÿ™ŸÅÿßÿµŸäŸÑ
                        </button>
                    </div>
                </div>
                <div id="advancedLoading" class="loading">
                    <div class="spinner"></div>
                    <p>ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑÿπÿ±ÿ∂ ÿßŸÑŸÖÿÆŸÅÿ∂ ŸÑÿ´ŸÑÿßÿ´ ÿ£ÿ¥Ÿáÿ±...</p>
                </div>
            </div>
            <div id="twoMonthsTab" class="tab-content">
                <div class="section">
                    <h3 class="section-title">
 ÿ±ŸÅÿπ Excel ÿßŸÑŸàŸÉŸäŸÑ ŸÑÿ≠ÿ≥ÿßÿ® ÿßŸÑÿπÿ±ÿ∂ ÿßŸÑŸÖÿÆŸÅÿ∂ ŸÑÿ¥Ÿáÿ±ŸäŸÜ
                    </h3>
                    <div class="file-upload" id="twoMonthsFileUpload">
                        <p> ÿßÿ≥ÿ≠ÿ® ŸÖŸÑŸÅ Excel ÿ£Ÿà CSV ŸáŸÜÿß ÿ£Ÿà ÿßŸÜŸÇÿ± ŸÑŸÑÿßÿÆÿ™Ÿäÿßÿ±</p>
                        <input type="file" id="twoMonthsFileInput" accept=".xlsx,.xls,.csv" style="display: none;">
                    </div>
                </div>
                <div class="section">
                    <h3 class="section-title">
                         ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑÿπÿ±ÿ∂ ÿßŸÑŸÖÿÆŸÅÿ∂ ŸÑÿ¥Ÿáÿ±ŸäŸÜ
                    </h3>
                    <p style="color: #1a1a1a; margin-bottom: 15px; font-size: 1rem; font-weight: 600;">
                         Ÿäÿ™ŸÖ ÿ≠ÿ≥ÿßÿ® ÿßŸÑÿ™ŸÅÿπŸäŸÑ ÿπŸÜÿØ Ÿàÿ¨ŸàÿØ 2 ÿßÿ¥ÿ™ÿ±ÿßŸÉÿßÿ™ ŸÑŸÜŸÅÿ≥ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿÆŸÑÿßŸÑ 5 ÿ£ŸäÿßŸÖ<br>
                         ŸÖŸÇÿßÿ±ŸÜÿ© ÿ£ÿ≥ÿπÿßÿ± ÿßŸÑÿπÿ±ÿ∂ ÿßŸÑŸÖÿÆŸÅÿ∂ ŸÖÿπ ÿßŸÑÿ£ÿ≥ÿπÿßÿ± ÿßŸÑÿ±ÿ≥ŸÖŸäÿ© ŸÑÿ≠ÿ≥ÿßÿ® ÿßŸÑÿ±ÿßÿ¨ÿπ ŸÑŸÑŸàŸÉŸäŸÑ
                    </p>
                    <button class="btn btn-primary" onclick="analyzeTwoMonthsData()">
                         ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑÿ™ŸÅÿπŸäŸÑÿßÿ™
                    </button>
                    <button class="btn btn-warning" onclick="resetTwoMonthsResults()">
                         ŸÖÿ≥ÿ≠ ÿßŸÑŸÜÿ™ÿßÿ¶ÿ¨
                    </button>
                </div>
                <div id="twoMonthsResults" class="section hidden">
                    <h3 class="section-title">
                         ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉÿßÿ™ ŸàÿßŸÑŸÖÿ®ÿßŸÑÿ∫ 
                    </h3>
                    <div id="twoMonthsAgentInfo" class="agent-info"></div>
                    <div class="results-grid" id="twoMonthsResultsGrid"></div>
                    <div style="text-align: center; margin-top: 20px;">
                        <button class="btn btn-success" onclick="saveTwoMonthsReport()">
 ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ŸÇÿ±Ÿäÿ±
                        </button>
                        <button class="btn btn-warning" onclick="exportTwoMonthsData()">
 ÿ™ÿµÿØŸäÿ± ŸÑŸÑŸàŸÉŸäŸÑ
                        </button>
                        <button class="btn btn-success" onclick="exportTwoMonthsDetailsToExcel()">
 ÿ™ÿµÿØŸäÿ± Excel ÿ®ÿßŸÑÿ™ŸÅÿßÿµŸäŸÑ
                        </button>
                    </div>
                </div>
                <div id="twoMonthsLoading" class="loading">
                    <div class="spinner"></div>
                    <p>ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑÿπÿ±ÿ∂ ÿßŸÑŸÖÿÆŸÅÿ∂ ŸÑÿ¥Ÿáÿ±ŸäŸÜ...</p>
                </div>
            </div>
            <div id="agentsTab" class="tab-content">
                <div class="section">
                    <h3 class="section-title"> ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸàŸÉŸÑÿßÿ°</h3>
                    <div style="margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                        <button class="btn btn-success" onclick="refreshAgentsList()"> ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÇÿßÿ¶ŸÖÿ©</button>
                    </div>
                    <div class="agents-controls" style="margin-bottom: 20px; padding: 15px; background: rgba(128, 28, 50, 0.05); border-radius: 12px; display: flex; gap: 15px; flex-wrap: wrap; align-items: center; position: relative; z-index: 10;">
                        <div style="flex: 1; min-width: 250px; position: relative; z-index: 10;">
                            <input type="text" id="agentSearchInput" class="settings-input" placeholder="ÿ®ÿ≠ÿ´ ÿπŸÜ ŸàŸÉŸäŸÑ..." onkeyup="filterAgents()" style="width: 100%; position: relative; z-index: 10; pointer-events: auto;">
                        </div>
                        <div style="display: flex; gap: 10px; align-items: center; position: relative; z-index: 10;">
                            <label style="font-weight: 600; color: var(--text-primary);">ÿ™ÿ±ÿ™Ÿäÿ® ÿ≠ÿ≥ÿ®:</label>
                            <select id="agentSortSelect" class="settings-input" onchange="sortAgents()" style="min-width: 180px; position: relative; z-index: 10; pointer-events: auto;">
                                <option value="name">ÿßŸÑÿßÿ≥ŸÖ (ÿ£-Ÿä)</option>
                                <option value="name-desc">ÿßŸÑÿßÿ≥ŸÖ (Ÿä-ÿ£)</option>
                                <option value="total-desc">ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä (ÿßŸÑÿ£ÿπŸÑŸâ ÿ£ŸàŸÑÿßŸã)</option>
                                <option value="total-asc">ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä (ÿßŸÑÿ£ŸÇŸÑ ÿ£ŸàŸÑÿßŸã)</option>
                                <option value="reports-desc">ÿπÿØÿØ ÿßŸÑÿ™ŸÇÿßÿ±Ÿäÿ± (ÿßŸÑÿ£ŸÉÿ´ÿ± ÿ£ŸàŸÑÿßŸã)</option>
                                <option value="reports-asc">ÿπÿØÿØ ÿßŸÑÿ™ŸÇÿßÿ±Ÿäÿ± (ÿßŸÑÿ£ŸÇŸÑ ÿ£ŸàŸÑÿßŸã)</option>
                            </select>
                        </div>
                        <div style="color: var(--text-primary); font-size: 0.9rem; font-weight: 600;">
                            <span id="agentsCount">0</span> ŸàŸÉŸäŸÑ
                        </div>
                    </div>
                    <div id="agentsList" class="agents-grid-improved"></div>
                </div>
            </div>
            <div id="summaryTab" class="tab-content active">
                <div class="section" style="background: linear-gradient(135deg, rgba(128, 28, 50, 0.08) 0%, rgba(255, 255, 255, 0.03) 100%); border-radius: 16px; padding: 20px; margin-bottom: 20px; border: 2px solid var(--border-light); box-shadow: 0 6px 18px rgba(0,0,0,0.08);">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 25px; flex-wrap: wrap; gap: 20px;">
                        <div style="flex: 1;">
                            <h3 class="section-title" style="margin: 0 0 10px 0; font-size: 1.5rem; color: var(--primary-color); font-weight: 900; text-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            </h3>
                            <p style="color: var(--text-secondary); font-size: 1rem; font-weight: 500; margin: 0;">
                               
                            </p>
                        </div>
                        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                            <button class="btn btn-primary" onclick="refreshSummary()" style="padding: 10px 18px; font-weight: 700; font-size: 0.85rem; border-radius: 8px; box-shadow: 0 3px 10px rgba(0,123,255,0.3);">
                                 ÿ™ÿ≠ÿØŸäÿ´
                            </button>
                            <button class="btn btn-success" onclick="exportSummaryToExcel()" style="padding: 10px 18px; font-weight: 700; font-size: 0.85rem; border-radius: 8px; box-shadow: 0 3px 10px rgba(40,167,69,0.3);">
                                 Excel
                            </button>
                            <button class="btn btn-warning" onclick="clearAllAgentReports()" style="padding: 10px 18px; font-weight: 700; font-size: 0.85rem; border-radius: 8px; box-shadow: 0 3px 10px rgba(255,193,7,0.3);">
                                 ŸÖÿ≥ÿ≠
                            </button>
                        </div>
                    </div>
                </div>
                
                <div id="summaryTotals" class="section" style="margin-bottom: 30px;">
                    <div class="results-grid" id="summaryTotalsGrid"></div>
                </div>
                
                <div id="chartsSection" class="section" style="display: none; margin-bottom: 30px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                        <h3 class="section-title" style="margin: 0; font-size: 1.3rem; color: var(--primary-color); font-weight: 800;">   ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™</h3>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px;">
                        <div style="background: var(--card-bg); border-radius: 12px; padding: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); border: 1px solid var(--border-color); transition: transform 0.3s ease, box-shadow 0.3s ease;" onmouseover="this.style.transform='translateY(-3px)'; this.style.boxShadow='0 6px 16px rgba(0,0,0,0.12)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)'">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                                <div style="font-size: 1.2rem;"></div>
                                <h4 style="margin: 0; color: var(--primary-color); font-size: 1rem; font-weight: 700;">ÿ™Ÿàÿ≤Ÿäÿπ ÿßŸÑÿπÿ±Ÿàÿ∂</h4>
                            </div>
                            <canvas id="offersChart" style="max-height: 220px;"></canvas>
                        </div>
                        <div style="background: var(--card-bg); border-radius: 12px; padding: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); border: 1px solid var(--border-color); transition: transform 0.3s ease, box-shadow 0.3s ease;" onmouseover="this.style.transform='translateY(-3px)'; this.style.boxShadow='0 6px 16px rgba(0,0,0,0.12)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)'">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                                <div style="font-size: 1.2rem;"></div>
                                <h4 style="margin: 0; color: var(--primary-color); font-size: 1rem; font-weight: 700;">ÿ£ÿπŸÑŸâ ÿßŸÑŸàŸÉŸÑÿßÿ°</h4>
                            </div>
                            <canvas id="topAgentsChart" style="max-height: 220px;"></canvas>
                        </div>
                        <div style="background: var(--card-bg); border-radius: 12px; padding: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); border: 1px solid var(--border-color); transition: transform 0.3s ease, box-shadow 0.3s ease;" onmouseover="this.style.transform='translateY(-3px)'; this.style.boxShadow='0 6px 16px rgba(0,0,0,0.12)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)'">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                                <div style="font-size: 1.2rem;"></div>
                                <h4 style="margin: 0; color: var(--primary-color); font-size: 1rem; font-weight: 700;">ÿ™Ÿàÿ≤Ÿäÿπ ÿ£ŸÜŸàÿßÿπ ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉÿßÿ™</h4>
                            </div>
                            <canvas id="subscriptionsChart" style="max-height: 220px;"></canvas>
                        </div>
                    </div>
                </div>
                
                <div id="summaryResults" class="section">
                    <h3 class="section-title" style="font-size: 1.2rem; margin-bottom: 15px;">
                        üë• ŸÖŸÑÿÆÿµ ÿßŸÑŸàŸÉŸÑÿßÿ°
                    </h3>
                    <div id="summaryContent">
                        <div style="text-align: center; padding: 60px 20px; background: var(--bg-secondary); border-radius: 12px; border: 2px dashed var(--border-color);">
                            <div style="font-size: 3rem; margin-bottom: 20px;"></div>
                            <p style="color: var(--text-secondary); font-size: 1.1rem; font-weight: 600; margin: 0;">
                                ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™ ŸÑŸÑÿπÿ±ÿ∂
                            </p>
                            <p style="color: var(--text-tertiary); font-size: 0.9rem; margin-top: 10px;">
                                Ÿäÿ±ÿ¨Ÿâ ÿ™ÿ≠ŸÑŸäŸÑ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸàŸÉŸÑÿßÿ° ÿ£ŸàŸÑÿßŸã
                            </p>
                        </div>
                    </div>
                </div>
            </div>
            <div id="agentPercentageTab" class="tab-content">
                <div class="section">
                    <h3 class="section-title"> ŸÜÿ≥ÿ®ÿ© ÿßŸÑŸàŸÉŸÑÿßÿ°</h3>
                    <p style="color: #1a1a1a; margin-bottom: 20px; font-size: 1rem; font-weight: 600;">
                    </p>
                    <div style="margin-bottom: 20px; padding: 20px; background: rgba(128, 28, 50, 0.05); border-radius: 12px;">
                        <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #801c32;">ÿßÿÆÿ™ÿ± ÿßŸÑŸàŸÉŸäŸÑ:</label>
                        <select id="selectedAgentForPercentage" class="settings-input" style="width: 100%; margin-bottom: 15px; position: relative; z-index: 10; pointer-events: auto;">
                            <option value="">-- ÿßÿÆÿ™ÿ± ŸàŸÉŸäŸÑ --</option>
                        </select>
                        <div id="agentFileUploadSection" style="display: none;">
                            <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #801c32;">ÿ±ŸÅÿπ ŸÖŸÑŸÅ Excel ŸÑŸÑŸàŸÉŸäŸÑ:</label>
                            <div class="file-upload" id="percentageFileUpload">
                                <p> ÿßÿ≥ÿ≠ÿ® ŸÖŸÑŸÅ Excel ŸáŸÜÿß ÿ£Ÿà ÿßŸÜŸÇÿ± ŸÑŸÑÿßÿÆÿ™Ÿäÿßÿ±</p>
                                <input type="file" id="percentageFileInput" accept=".xlsx,.xls" style="display: none;">
                            </div>
                            <div id="percentageFileName" class="success-message hidden" style="margin-top: 10px;"></div>
                            <div style="margin-top: 15px;">
                                <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #801c32;">ÿßŸÑŸÜÿ≥ÿ®ÿ©</label>
                                <input type="number" id="percentageRateSelect" class="settings-input" value="16" min="0" max="100" step="0.01" style="width: 200px; position: relative; z-index: 10; pointer-events: auto;" onchange="updatePercentageRate()">
                                <p style="margin-top: 5px; font-size: 0.85rem; color: var(--text-primary); font-weight: 600;" id="percentageRateInfo">
                                    ÿ≥Ÿäÿ™ŸÖ ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑŸÜÿ≥ÿ®ÿ© ÿßŸÑŸÖÿ≠ŸÅŸàÿ∏ÿ© ŸÑŸÑŸàŸÉŸäŸÑ (16% ÿßŸÅÿ™ÿ±ÿßÿ∂Ÿä)
                                </p>
                            </div>
                            <div style="margin-top: 20px; display: flex; gap: 10px;">
                                <button class="btn btn-primary" onclick="analyzeAgentPercentageData()"> ÿ™ÿ≠ŸÑŸäŸÑ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸàŸÉŸäŸÑ</button>
                                <button class="btn btn-warning" onclick="resetPercentageData()"> ŸÖÿ≥ÿ≠ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="percentageResults" class="section hidden" style="padding: 20px; overflow: visible; overflow-x: hidden; width: 100%; max-width: 100%; box-sizing: border-box;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; width: 100%; max-width: 100%; box-sizing: border-box;">
                        <h3 class="section-title" style="margin: 0; font-size: 1.3rem; padding-bottom: 10px;"> ÿ®ŸäÿßŸÜÿßÿ™ ŸÜÿ≥ÿ®ÿ© ÿßŸÑŸàŸÉŸÑÿßÿ°</h3>
                        <button class="btn btn-success" onclick="exportPercentageToExcel()" style="padding: 8px 16px; font-size: 0.85rem;">
                            ÿ™ÿµÿØŸäÿ± Excel
                        </button>
                    </div>
                    <div id="percentageTableContainer" style="overflow-x: auto; overflow-y: auto; max-height: 70vh; width: 100%; max-width: 100%; position: relative; z-index: 1; -webkit-overflow-scrolling: touch; overscroll-behavior: contain; box-sizing: border-box; will-change: scroll-position; contain: layout style paint;">
                        <table id="percentageTable" style="width: auto; min-width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.8rem; table-layout: auto; box-sizing: border-box;">
                            <thead>
                                <tr style="background: #801c32; color: white;">
                                    <th rowspan="2" style="padding: 8px 6px; text-align: center; border: 1px solid #ddd; vertical-align: middle; font-size: 0.75rem; font-weight: 600; background-color: #801c32;">ÿßÿ≥ŸÖ ÿßŸÑŸàŸÉŸäŸÑ</th>
                                    <th rowspan="2" style="padding: 8px 6px; text-align: center; border: 1px solid #ddd; vertical-align: middle; font-size: 0.75rem; font-weight: 600;">B</th>
                                    <th rowspan="2" style="padding: 8px 6px; text-align: center; border: 1px solid #ddd; vertical-align: middle; font-size: 0.75rem; font-weight: 600;">S</th>
                                    <th rowspan="2" style="padding: 8px 6px; text-align: center; border: 1px solid #ddd; vertical-align: middle; font-size: 0.75rem; font-weight: 600;">G</th>
                                    <th rowspan="2" style="padding: 8px 6px; text-align: center; border: 1px solid #ddd; vertical-align: middle; font-size: 0.75rem; font-weight: 600;">P</th>
                                    <th rowspan="2" style="padding: 8px 6px; text-align: center; border: 1px solid #ddd; vertical-align: middle; font-size: 0.75rem; font-weight: 600;">ŸÖÿ¨ŸÖŸàÿπ<br>ÿßŸÑÿ™ŸÅÿπŸäŸÑÿßÿ™</th>
                                    <th colspan="5" style="padding: 8px 6px; text-align: center; border: 1px solid #ddd; font-size: 0.75rem; font-weight: 600;">ÿßŸÑŸÖÿ®ÿßŸÑÿ∫</th>
                                    <th colspan="4" style="padding: 8px 6px; text-align: center; border: 1px solid #ddd; font-size: 0.75rem; font-weight: 600;">16% ŸÜÿ≥ÿ®ÿ© ÿßŸÑŸàŸÉŸäŸÑ</th>
                                    <th rowspan="2" style="padding: 8px 6px; text-align: center; border: 1px solid #ddd; vertical-align: middle; font-size: 0.75rem; font-weight: 600;">ŸÜÿ≥ÿ®ÿ© ÿßŸÑŸàŸÉŸäŸÑ<br>16%</th>
                                    <th rowspan="2" style="padding: 8px 6px; text-align: center; border: 1px solid #ddd; vertical-align: middle; font-size: 0.75rem; font-weight: 600;">ÿßÿ≥ÿ™ŸÇÿ∑ÿßÿπÿßÿ™</th>
                                    <th rowspan="2" style="padding: 8px 6px; text-align: center; border: 1px solid #ddd; vertical-align: middle; font-size: 0.75rem; font-weight: 600;">ÿ∫ÿ±ÿßŸÖÿßÿ™</th>
                                    <th rowspan="2" style="padding: 8px 6px; text-align: center; border: 1px solid #ddd; vertical-align: middle; font-size: 0.75rem; font-weight: 600;">ÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™</th>
                                </tr>
                                <tr style="background: #801c32; color: white;">
                                    <th style="padding: 6px 4px; text-align: center; border: 1px solid #ddd; font-size: 0.7rem; font-weight: 500;">IQ.B</th>
                                    <th style="padding: 6px 4px; text-align: center; border: 1px solid #ddd; font-size: 0.7rem; font-weight: 500;">IQ.S</th>
                                    <th style="padding: 6px 4px; text-align: center; border: 1px solid #ddd; font-size: 0.7rem; font-weight: 500;">IQ.G</th>
                                    <th style="padding: 6px 4px; text-align: center; border: 1px solid #ddd; font-size: 0.7rem; font-weight: 500;">IQ.P</th>
                                    <th style="padding: 6px 4px; text-align: center; border: 1px solid #ddd; font-size: 0.7rem; font-weight: 500;">IQ.T</th>
                                    <th style="padding: 6px 4px; text-align: center; border: 1px solid #ddd; font-size: 0.7rem; font-weight: 500;">IQ.B%16</th>
                                    <th style="padding: 6px 4px; text-align: center; border: 1px solid #ddd; font-size: 0.7rem; font-weight: 500;">IQ.S%16</th>
                                    <th style="padding: 6px 4px; text-align: center; border: 1px solid #ddd; font-size: 0.7rem; font-weight: 500;">IQ.G%16</th>
                                    <th style="padding: 6px 4px; text-align: center; border: 1px solid #ddd; font-size: 0.7rem; font-weight: 500;">IQ.P%16</th>
                                </tr>
                            </thead>
                            <tbody id="percentageTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div id="settingsTab" class="tab-content">
                <div class="section">
                    <h3 class="section-title"> ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™</h3>
                    <div class="settings-container">
                        <div class="settings-section">
                            <h4> ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿ£ÿ≥ÿπÿßÿ±</h4>
                            <div class="settings-group">
                                <label for="priceBronze"> Bronze</label>
                                <input type="number" id="priceBronze" class="settings-input" value="30000" min="0" step="1000">
                            </div>
                            <div class="settings-group">
                                <label for="priceSilver"> Silver</label>
                                <input type="number" id="priceSilver" class="settings-input" value="40000" min="0" step="1000">
                            </div>
                            <div class="settings-group">
                                <label for="priceGold"> Gold</label>
                                <input type="number" id="priceGold" class="settings-input" value="50000" min="0" step="1000">
                            </div>
                            <div class="settings-group">
                                <label for="pricePlatinum"> Platinum</label>
                                <input type="number" id="pricePlatinum" class="settings-input" value="65000" min="0" step="1000">
                            </div>
                            <button class="btn btn-primary" onclick="savePriceSettings()"> ÿ≠ŸÅÿ∏</button>
                        </div>
                        <div class="settings-section">
                            <h4> ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™</h4>
                            <button class="btn btn-success" onclick="backupData()"> ŸÜÿ≥ÿÆ ÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿä</button>
                            <button class="btn btn-warning" onclick="restoreData()"> ÿßÿ≥ÿ™ÿπÿßÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™</button>
                            <button class="btn btn-danger" onclick="clearAllData()"> ŸÖÿ≥ÿ≠ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™</button>
                        </div>
                        <div class="settings-section">
                            <h4> ÿßŸÑŸÜÿ≥ÿ® ÿßŸÑÿßŸÅÿ™ÿ±ÿßÿ∂Ÿäÿ©</h4>
                            <div class="settings-group">
                                <label for="defaultAgentPercentage">ÿßŸÑŸÜÿ≥ÿ®ÿ© ÿßŸÑÿßŸÅÿ™ÿ±ÿßÿ∂Ÿäÿ© ŸÑŸÑŸàŸÉŸÑÿßÿ° ÿßŸÑÿ¨ÿØÿØ (%):</label>
                                <input type="number" id="defaultAgentPercentage" class="settings-input" value="16" min="0" max="100" step="0.01" onchange="saveDefaultPercentage()">
                                <p style="margin-top: 5px; font-size: 0.85rem; color: var(--text-primary); font-weight: 600;"></p>
                            </div>
                        </div>
                        <div class="settings-section">
                            <h4> ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™</h4>
                            <label class="settings-checkbox">
                                <input type="checkbox" id="enableNotifications" checked>
                                <span style="font-weight: 500; color: #333;">ÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™</span>
                            </label>
                            <p style="margin-top: 12px; font-size: 0.85rem; color: var(--text-primary); line-height: 1.5; font-weight: 600;">
                                ÿπŸÜÿØ ÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ÿå ÿ≥Ÿäÿ™ŸÖ ÿ•ÿ∏Ÿáÿßÿ± ÿ±ÿ≥ÿßÿ¶ŸÑ ÿ™ÿ£ŸÉŸäÿØ ÿπŸÜÿØ ÿ•ÿ™ŸÖÿßŸÖ ÿßŸÑÿπŸÖŸÑŸäÿßÿ™
                            </p>
                        </div>
                    </div>
                </div>
            </div>
            <div id="activityTab" class="tab-content">
                <div class="section">
                    <h3 class="section-title"> ÿ≥ÿ¨ŸÑ ÿßŸÑÿπŸÖŸÑŸäÿßÿ™</h3>
                    <div class="activity-controls" style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                        <input type="text" id="activitySearch" placeholder=" ÿ®ÿ≠ÿ´ ŸÅŸä ÿßŸÑÿ≥ÿ¨ŸÑ..." class="settings-input" style="flex: 1; min-width: 200px;" onkeyup="filterActivityLog()">
                        <button class="btn btn-primary" onclick="refreshActivityLog()"> ÿ™ÿ≠ÿØŸäÿ´</button>
                        <button class="btn btn-success" onclick="exportActivityLog()"> ÿ™ÿµÿØŸäÿ±</button>
                        <button class="btn btn-danger" onclick="clearActivityLog()"> ŸÖÿ≥ÿ≠ ÿßŸÑÿ≥ÿ¨ŸÑ</button>
                    </div>
                    <div id="activityLogContent" class="activity-log-container"></div>
                </div>
            </div>
            <div id="archiveTab" class="tab-content">
                <div class="section" style="background: linear-gradient(135deg, rgba(128, 28, 50, 0.05) 0%, rgba(255, 255, 255, 0.02) 100%); border-radius: 20px; padding: 30px; margin-bottom: 30px; border: 2px solid var(--border-light); box-shadow: 0 8px 24px rgba(0,0,0,0.08);">
                    <h3 class="section-title" style="font-size: 1.8rem; margin-bottom: 25px;">üìÅ ÿßŸÑÿ£ÿ±ÿ¥ŸäŸÅ - ÿßŸÑÿ™ÿ≠ŸÑŸäŸÑÿßÿ™ ŸàÿßŸÑÿ™ŸÅÿßÿµŸäŸÑ</h3>
                    <div style="margin-bottom: 25px; display: flex; gap: 15px; flex-wrap: wrap; align-items: center; padding: 20px; background: var(--bg-secondary); border-radius: 12px; border: 1px solid var(--border-light);">
                        <label for="archiveMonthSelect" style="font-weight: 700; color: var(--primary-color); font-size: 1rem;">ÿßÿÆÿ™ÿ± ÿßŸÑÿ¥Ÿáÿ±:</label>
                        <input type="month" id="archiveMonthSelect" class="settings-input" style="width: 220px; padding: 12px; font-weight: 600; font-size: 1rem;" onchange="loadArchiveByAgent()">
                        <button class="btn btn-primary" onclick="loadArchiveByAgent()" style="padding: 12px 24px; font-weight: 700; font-size: 0.95rem;">üì• ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ£ÿ±ÿ¥ŸäŸÅ</button>
                        <button class="btn btn-success" onclick="refreshArchivesList()" style="padding: 12px 24px; font-weight: 700; font-size: 0.95rem;">üîÑ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÇÿßÿ¶ŸÖÿ©</button>
                    </div>
                    <div id="archivesListContainer" style="margin-bottom: 25px; padding: 20px; background: var(--card-bg); border-radius: 12px; border: 1px solid var(--border-color);">
                        <h4 style="font-size: 1.2rem; font-weight: 800; color: var(--primary-color); margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid var(--border-color);">üìã ÿßŸÑÿ£ÿ±ÿ¥ŸäŸÅÿßÿ™ ÿßŸÑŸÖÿ™ÿßÿ≠ÿ©:</h4>
                        <div id="archivesList" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 15px; margin-top: 15px;"></div>
                    </div>
                    <div id="archiveContentContainer">
                        <div id="archiveAgentsList" style="background: var(--card-bg); padding: 25px; border-radius: 16px; border: 2px solid var(--border-color); margin-bottom: 25px; display: none; box-shadow: 0 4px 16px rgba(0,0,0,0.08);">
                            <div style="margin-bottom: 20px;">
                                <h4 style="font-size: 1.1rem; font-weight: 800; color: var(--primary-color); margin-bottom: 15px;">üîç ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ŸàŸÉŸäŸÑ</h4>
                                <input type="text" id="archiveAgentSearch" class="settings-input" 
                                       placeholder="ÿßŸÉÿ™ÿ® ÿßÿ≥ŸÖ ÿßŸÑŸàŸÉŸäŸÑ ŸÑŸÑÿ®ÿ≠ÿ´..." 
                                       style="width: 100%; padding: 14px 18px; font-size: 1rem; font-weight: 600; border-radius: 10px; border: 2px solid var(--border-color);"
                                       onkeyup="filterArchiveAgents(this.value)">
                            </div>
                            <div id="archiveAgentsListContent" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 15px;">
                            </div>
                        </div>
                        <div id="archiveContent" style="background: var(--card-bg); padding: 30px; border-radius: 16px; border: 2px solid var(--border-color); min-height: 200px; box-shadow: 0 4px 16px rgba(0,0,0,0.08);">
                            <div style="text-align: center; padding: 40px 20px;">
                                <div style="font-size: 4rem; margin-bottom: 20px;">üìÅ</div>
                                <p style="text-align: center; color: var(--text-secondary); font-size: 1.1rem; font-weight: 600; margin-bottom: 10px;">ÿßÿÆÿ™ÿ± ÿ¥Ÿáÿ±ÿßŸã ŸÑÿπÿ±ÿ∂ ÿ£ÿ±ÿ¥ŸäŸÅ ÿßŸÑŸàŸÉŸÑÿßÿ°</p>
                                <p style="text-align: center; color: var(--text-tertiary); font-size: 0.95rem;">ÿ≥Ÿäÿ™ŸÖ ÿπÿ±ÿ∂ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ™ÿ≠ŸÑŸäŸÑÿßÿ™ ŸàÿßŸÑÿ™ŸÅÿßÿµŸäŸÑ ŸÑŸÑÿ¥Ÿáÿ± ÿßŸÑŸÖÿ≠ÿØÿØ</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="usersTab" class="tab-content">
                <div class="section" style="background: var(--card-bg); border-radius: 12px; padding: 25px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 2px solid var(--border-color);">
                        <h3 class="section-title" style="margin: 0; font-size: 1.5rem; color: var(--primary-color);">ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ</h3>
                        <div class="btn-group" style="gap: 10px;">
                            <button class="btn btn-primary" onclick="openAddUserModal()" style="padding: 10px 20px; font-weight: 600;">
                                <span style="margin-left: 8px;">‚ûï</span> ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ¨ÿØŸäÿØ
                            </button>
                            <button class="btn btn-secondary" onclick="loadUsers()" style="padding: 10px 20px;">
                                <span style="margin-left: 8px;">üîÑ</span> ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÇÿßÿ¶ŸÖÿ©
                            </button>
                        </div>
                    </div>
                    <div id="usersAlert" style="margin-bottom: 20px;"></div>
                    <div id="usersList" style="min-height: auto;">
                        <div style="text-align: center; padding: 40px;">
                            <div class="spinner" style="margin: 0 auto 20px;"></div>
                            <p style="color: var(--text-secondary); font-size: 1rem;">ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="addUserModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="addUserModalTitle">ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ¨ÿØŸäÿØ</h3>
                <button class="modal-close" onclick="closeAddUserModal()">&times;</button>
            </div>
            <div id="addUserAlert"></div>
            <input type="hidden" id="editUserId" value="">
            <div class="form-group">
                <label for="userUsername">ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ *</label>
                <input type="text" id="userUsername" placeholder="ÿ£ÿØÿÆŸÑ ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ (ŸÑŸÑÿ™ÿ≥ÿ¨ŸäŸÑ)">
            </div>
            <div class="form-group">
                <label for="userFullName">ÿßŸÑÿßÿ≥ŸÖ ÿßŸÑŸÉÿßŸÖŸÑ *</label>
                <input type="text" id="userFullName" placeholder="ÿ£ÿØÿÆŸÑ ÿßŸÑÿßÿ≥ŸÖ ÿßŸÑŸÉÿßŸÖŸÑ">
            </div>
            <div class="form-group">
                <label for="userPassword">ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± <span id="passwordRequired">*</span></label>
                <input type="password" id="userPassword" placeholder="ÿ£ÿØÿÆŸÑ ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± (ÿßÿ™ÿ±ŸÉŸá ŸÅÿßÿ±ÿ∫ÿßŸã ÿπŸÜÿØ ÿßŸÑÿ™ÿπÿØŸäŸÑ ŸÑŸÑÿ≠ŸÅÿßÿ∏ ÿπŸÑŸâ ÿßŸÑŸÉŸÑŸÖÿ© ÿßŸÑÿ≠ÿßŸÑŸäÿ©)">
                <small style="color: var(--text-secondary); font-size: 0.85rem; display: block; margin-top: 5px;" id="passwordHint" style="display: none;">ÿπŸÜÿØ ÿßŸÑÿ™ÿπÿØŸäŸÑÿå ÿßÿ™ÿ±ŸÉŸá ŸÅÿßÿ±ÿ∫ÿßŸã ŸÑŸÑÿ≠ŸÅÿßÿ∏ ÿπŸÑŸâ ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ÿßŸÑÿ≠ÿßŸÑŸäÿ©</small>
            </div>
            <div class="form-group">
                <label for="userRole">ÿßŸÑÿØŸàÿ± *</label>
                <select id="userRole">
                    <option value="employee">ŸÖŸàÿ∏ŸÅ</option>
                    <option value="admin">ŸÖÿØŸäÿ±</option>
                </select>
            </div>
            <div class="btn-group" style="margin-top: 20px;">
                <button class="btn btn-secondary" onclick="closeAddUserModal()">ÿ•ŸÑÿ∫ÿßÿ°</button>
                <button class="btn btn-primary" onclick="saveUser()">ÿ≠ŸÅÿ∏</button>
            </div>
        </div>
    </div>
    <div id="messageCustomizationModal" class="modal">
        <div class="modal-content message-customization">
            <div class="modal-header">
                <h3>ÿ™ÿÆÿµŸäÿµ ÿ±ÿ≥ÿßŸÑÿ© ÿßŸÑŸàŸÉŸäŸÑ</h3>
                <button class="modal-close" onclick="closeMessageCustomizationModal()">&times;</button>
            </div>
            <div style="margin-bottom: 20px;">
                <strong style="color: #801c32; font-size: 1.1rem;">ÿßŸÑŸàŸÉŸäŸÑ:</strong>
                <span id="customMessageAgentName" style="font-size: 1.1rem; font-weight: 600;" data-agent=""></span>
            </div>
            <div style="margin: 20px 0;">
                <label for="customMessageText" class="preview-label">ŸÜÿµ ÿßŸÑÿ±ÿ≥ÿßŸÑÿ©:</label>
                <textarea id="customMessageText" class="message-textarea" rows="10"></textarea>
            </div>
            <div style="display: flex; gap: 15px; justify-content: flex-end; margin-top: 20px;">
                <button class="btn btn-danger" onclick="closeMessageCustomizationModal()">ÿ•ŸÑÿ∫ÿßÿ°</button>
                <button class="btn btn-success" onclick="sendViaEmail()">ÿ•ÿ±ÿ≥ÿßŸÑ ÿπÿ®ÿ± ÿßŸÑÿ®ÿ±ŸäÿØ</button>
                <button class="btn btn-primary" onclick="sendCustomizedWhatsAppMessage()">ÿ•ÿ±ÿ≥ÿßŸÑ Ÿàÿßÿ™ÿ≥ÿßÿ®</button>
            </div>
        </div>
    </div>
    <div id="agentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="agentModalTitle">ÿ•ÿ∂ÿßŸÅÿ© ŸàŸÉŸäŸÑ</h3>
                <button class="modal-close" onclick="closeAgentModal()">&times;</button>
            </div>
            <form id="agentForm">
                <div class="form-group">
                    <label for="agentName">ÿßÿ≥ŸÖ ÿßŸÑŸÑŸàÿ≠ÿ© *</label>
                    <input type="text" id="agentName" class="settings-input" required>
                </div>
                <div class="form-group">
                    <label for="agentSubName">ÿßÿ≥ŸÖ ÿßŸÑŸàŸÉŸäŸÑ :</label>
                    <input type="text" id="agentSubName" class="settings-input" placeholder=" ">
                </div>
                <div class="form-group">
                    <label for="agentPhone">ÿ±ŸÇŸÖ ÿßŸÑŸáÿßÿ™ŸÅ (Ÿàÿßÿ™ÿ≥ÿßÿ®):</label>
                    <input type="tel" id="agentPhone" class="settings-input" placeholder="ŸÖÿ´ÿßŸÑ: 07701234567">
                </div>
                <div class="form-group">
                    <label for="agentEmail">ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä:</label>
                    <input type="email" id="agentEmail" class="settings-input" placeholder="example@email.com">
                </div>
                <div style="display: flex; gap: 15px; justify-content: flex-end; margin-top: 20px;">
                    <button type="button" class="btn btn-danger" onclick="closeAgentModal()">ÿ•ŸÑÿ∫ÿßÿ°</button>
                    <button type="submit" class="btn btn-primary">ÿ≠ŸÅÿ∏</button>
                </div>
            </form>
        </div>
    </div>
    <script>
let agentReports = {};
        let agentsList = JSON.parse(localStorage.getItem('agentsList') || '[]');
        let lastActivityTime = Date.now();
        let autoLogoutTimer = null;
        const AUTO_LOGOUT_TIME = 2 * 60 * 60 * 1000;
        let basicData = null;
        let advancedData = null;
        let twoMonthsData = null;
        let twoMonthsDetails = []; 
        let advancedDetails = [];
        let basicDetails = [];
        let percentageData = null;
        let agentPercentages = JSON.parse(localStorage.getItem('agentPercentages') || '{}');
        const SUPABASE_URL = (typeof window !== 'undefined' && typeof window.SUPABASE_URL !== 'undefined') ? window.SUPABASE_URL : 'https://qcbcjyhqgxwuqutzkxrh.supabase.co';
        const SUPABASE_ANON_KEY = (typeof window !== 'undefined' && typeof window.SUPABASE_ANON_KEY !== 'undefined') ? window.SUPABASE_ANON_KEY : 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFjYmNqeWhxZ3h3dXF1dHpreHJoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTEyMDE3NjQsImV4cCI6MjA2Njc3Nzc2NH0.y-hQVa6nzBpCMpXL7XbcWPMGafATvnMez3lAmFvb2zY';
        const SYSTEM_NAME = 'billing_accounts';
        let supabaseClient = null;
        let loggedInUser = '';
        let currentUserRole = 'employee';
        let currentUserId = null;
        
        async function initSupabase() {
            try {
                if (typeof supabase !== 'undefined') {
                    supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                } else {
                }
            } catch (error) {
            }
        }
        
        async function supabaseRequest(table, method = 'GET', data = null, filters = '', customHeaders = {}) {
            const url = `${SUPABASE_URL}/rest/v1/${table}${filters}`;
            const options = {
                method: method,
                headers: {
                    'apikey': SUPABASE_ANON_KEY,
                    'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                    'Content-Type': 'application/json',
                    'Prefer': 'return=representation',
                    ...customHeaders
                }
            };
            
            if (data && (method === 'POST' || method === 'PATCH' || method === 'PUT')) {
                options.body = JSON.stringify(data);
            }
            
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 30000);
                options.signal = controller.signal;
                
                const response = await fetch(url, options);
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Supabase error: ${response.status} - ${errorText}`);
                }
                const result = await response.json();
                return result;
            } catch (error) {
                if (error.name === 'AbortError') {
                    throw new Error('Request timeout - Ÿäÿ±ÿ¨Ÿâ ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ© ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ');
                }
                if (error.message && error.message.includes('Failed to fetch')) {
                    throw new Error('ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ÿßŸÑÿ•ŸÜÿ™ÿ±ŸÜÿ™ - Ÿäÿ±ÿ¨Ÿâ ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿßÿ™ÿµÿßŸÑ');
                }
                throw error;
            }
        }
        
        async function hashPassword(password) {
            const encoder = new TextEncoder();
            const data = encoder.encode(password);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }
        
        function showAlert(alertDiv, message, type = 'info') {
            if (!alertDiv) return;
            alertDiv.innerHTML = `<div style="padding: 12px; border-radius: 8px; margin-bottom: 15px; background: ${type === 'error' ? '#f8d7da' : type === 'success' ? '#d4edda' : '#d1ecf1'}; color: ${type === 'error' ? '#721c24' : type === 'success' ? '#155724' : '#0c5460'}; border: 1px solid ${type === 'error' ? '#f5c6cb' : type === 'success' ? '#c3e6cb' : '#bee5eb'};">
                ${message}
            </div>`;
            setTimeout(() => {
                alertDiv.innerHTML = '';
            }, 5000);
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        async function handleLogin() {
            const usernameInput = document.getElementById('loginUsername');
            const passwordInput = document.getElementById('loginPassword');
            const alertDiv = document.getElementById('loginAlert');
            if (!usernameInput || !passwordInput) return;
            const username = usernameInput.value.trim();
            const password = passwordInput.value.trim();

            if (!username || !password) {
                showAlert(alertDiv, 'Ÿäÿ±ÿ¨Ÿâ ÿ™ÿπÿ®ÿ¶ÿ© ÿ¨ŸÖŸäÿπ ÿßŸÑÿ≠ŸÇŸàŸÑ.', 'error');
                return;
            }

            showAlert(alertDiv, 'ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™...', 'info');

            try {
                const passwordHash = await hashPassword(password);
                
                let filter = `?username=eq.${encodeURIComponent(username)}`;
                let users = await supabaseRequest('users', 'GET', null, filter);
                if (users && users.length > 0) {
                    users = users.filter(user => {
                        if (user.system_name !== undefined && user.system_name !== null && user.system_name !== '') {
                            return user.system_name === SYSTEM_NAME;
                        }
                        return true;
                    });
                }
                
                if (users && users.length > 0) {
                    const user = users[0];
                    
                    if (!user.is_active) {
                        showAlert(alertDiv, 'Ÿáÿ∞ÿß ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÖÿπÿ∑ŸÑ. Ÿäÿ±ÿ¨Ÿâ ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ÿßŸÑŸÖÿØŸäÿ±.', 'error');
                        return;
                    }
                    
                    if (user.password_hash === passwordHash) {
                        try {
                            await supabaseRequest('users', 'PATCH', { last_login: new Date().toISOString() }, `?id=eq.${user.id}`);
                        } catch (e) {
                        }
                        
                        loggedInUser = user.full_name;
                        currentUserRole = user.role;
                        currentUserId = user.id;
                        
                        localStorage.setItem('loggedInUser', user.full_name);
                        localStorage.setItem('currentUserRole', user.role);
                        localStorage.setItem('currentUserId', user.id);
                        
                        showMainApp();
                    } else {
                        showAlert(alertDiv, 'ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ£Ÿà ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠ÿ©.', 'error');
                    }
                } else {
                    try {
                        let systemUsers = await supabaseRequest('users', 'GET', null, `?select=username,is_active`);
                        if (systemUsers && systemUsers.length > 0) {
                            systemUsers = systemUsers.filter(user => {
                                if (user.system_name !== undefined && user.system_name !== null && user.system_name !== '') {
                                    return user.system_name === SYSTEM_NAME;
                                }
                                return true;
                            });
                        }
                        if (!systemUsers || systemUsers.length === 0) {
                            showAlert(alertDiv, 'ŸÑÿß ŸäŸàÿ¨ÿØ ŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ ŸÅŸä Ÿáÿ∞ÿß ÿßŸÑŸÜÿ∏ÿßŸÖ. Ÿäÿ±ÿ¨Ÿâ ÿ•ŸÜÿ¥ÿßÿ° ŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÖÿØŸäÿ± ÿ£ŸàŸÑÿßŸã. ÿßÿ≥ÿ™ÿÆÿØŸÖ ŸÖŸÑŸÅ check_and_create_admin.sql', 'error');
                        } else {
                            const foundUser = systemUsers.find(u => u.username === username);
                            if (foundUser && !foundUser.is_active) {
                                showAlert(alertDiv, 'Ÿáÿ∞ÿß ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÖÿπÿ∑ŸÑ. Ÿäÿ±ÿ¨Ÿâ ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ÿßŸÑŸÖÿØŸäÿ±.', 'error');
                            } else {
                                showAlert(alertDiv, 'ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ£Ÿà ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠ÿ©.', 'error');
                            }
                        }
                    } catch (e) {
                        console.error('Error checking users:', e);
                        showAlert(alertDiv, 'ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ. ÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ™ŸÜŸÅŸäÿ∞ ŸÉŸàÿØ SQL ŸÑÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ.', 'error');
                    }
                }
            } catch (error) {
                showAlert(alertDiv, `ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ: ${error.message}. Ÿäÿ±ÿ¨Ÿâ ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ÿßŸÑÿ•ŸÜÿ™ÿ±ŸÜÿ™ ŸàÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ© ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ.`, 'error');
            }
        }
        
        function showMainApp() {
            const loginScreen = document.getElementById('loginScreen');
            const dashboard = document.getElementById('dashboard');
            
            if (loginScreen) {
                loginScreen.classList.add('hidden');
                loginScreen.style.display = 'none';
            }
            
            if (dashboard) {
                dashboard.classList.remove('hidden');
                dashboard.style.display = 'flex';
            }
            
            const switchUserText = document.getElementById('switchUserText');
            if (switchUserText) {
                switchUserText.textContent = loggedInUser || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ';
            }
            const switchUserBtnName = document.getElementById('switchUserBtnName');
            if (switchUserBtnName) {
                switchUserBtnName.textContent = loggedInUser || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ';
            }
            
            updateAdminTabsVisibility();
            updateCurrentDate();
            
            setTimeout(() => {
                updateAgentSummary();
            }, 500);
            
            resetAutoLogoutTimer();
        }
        
        function resetAutoLogoutTimer() {
            lastActivityTime = Date.now();
            if (autoLogoutTimer) {
                clearTimeout(autoLogoutTimer);
            }
            autoLogoutTimer = setTimeout(() => {
                if (confirm('ÿ™ŸÖ ÿ•ŸäŸÇÿßŸÅ ÿßŸÑŸÜÿ¥ÿßÿ∑ ŸÑŸÖÿØÿ© ÿ≥ÿßÿπÿ™ŸäŸÜ. ÿ≥Ÿäÿ™ŸÖ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨ ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã.\n\nŸáŸÑ ÿ™ÿ±ŸäÿØ ÿßŸÑÿ®ŸÇÿßÿ° ŸÖÿ™ÿµŸÑÿßŸãÿü')) {
                    resetAutoLogoutTimer();
                } else {
                    handleLogout(true);
                }
            }, AUTO_LOGOUT_TIME);
        }
        
        ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart', 'click'].forEach(event => {
            document.addEventListener(event, () => {
                if (loggedInUser) {
                    resetAutoLogoutTimer();
                }
            });
        });
        
        function handleLogout(isAutoLogout = false) {
            if (!isAutoLogout && !confirm('ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨ÿü')) {
                return;
            }
            
            if (autoLogoutTimer) {
                clearTimeout(autoLogoutTimer);
                autoLogoutTimer = null;
            }
            
            localStorage.removeItem('loggedInUser');
            localStorage.removeItem('currentUserRole');
            localStorage.removeItem('currentUserId');
            
            loggedInUser = '';
            currentUserRole = '';
            currentUserId = null;
            
            const dashboard = document.getElementById('dashboard');
            const loginScreen = document.getElementById('loginScreen');
            
            if (dashboard) {
                dashboard.classList.add('hidden');
                dashboard.style.display = 'none';
            }
            
            if (loginScreen) {
                loginScreen.classList.remove('hidden');
                loginScreen.style.display = 'flex';
            }
            
            const loginUsername = document.getElementById('loginUsername');
            const loginPassword = document.getElementById('loginPassword');
            const loginAlert = document.getElementById('loginAlert');
            
            if (loginUsername) loginUsername.value = '';
            if (loginPassword) loginPassword.value = '';
            if (loginAlert) loginAlert.innerHTML = '';
            
        }
        
        function updateAdminTabsVisibility() {
            const adminTabs = document.querySelectorAll('.admin-only');
            if (currentUserRole === 'admin') {
                adminTabs.forEach(tab => {
                    tab.style.display = 'block';
                });
            } else {
                adminTabs.forEach(tab => tab.style.display = 'none');
            }
        }
        
        async function loadUsers() {
            if (currentUserRole !== 'admin') {
                document.getElementById('usersList').innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 20px;">ŸÑŸäÿ≥ ŸÑÿØŸäŸÉ ÿµŸÑÿßÿ≠Ÿäÿ© ŸÑŸÑŸàÿµŸàŸÑ ÿ•ŸÑŸâ Ÿáÿ∞Ÿá ÿßŸÑÿµŸÅÿ≠ÿ©.</p>';
                return;
            }
            
            try {
                let allUsers = [];
                let from = 0;
                const batchSize = 1000;
                let hasMore = true;
                
                while (hasMore) {
                    const to = from + batchSize - 1;
                    try {
                        const batch = await supabaseRequest('users', 'GET', null, `?system_name=eq.${SYSTEM_NAME}&order=created_at.desc`, {
                            'Range': `${from}-${to}`
                        });
                        if (Array.isArray(batch) && batch.length > 0) {
                            allUsers = allUsers.concat(batch);
                            if (batch.length < batchSize) {
                                hasMore = false;
                            } else {
                                from += batchSize;
                            }
                        } else {
                            hasMore = false;
                        }
                    } catch (rangeError) {
                        try {
                            const batch = await supabaseRequest('users', 'GET', null, `?system_name=eq.${SYSTEM_NAME}&order=created_at.desc&limit=${batchSize}`);
                            if (Array.isArray(batch) && batch.length > 0) {
                                allUsers = allUsers.concat(batch);
                            }
                        } catch (e) {
                            console.warn('Error fetching batch:', e);
                        }
                        hasMore = false;
                    }
                }
                
                if (allUsers.length === 0) {
                    try {
                        const usersWithoutSystem = await supabaseRequest('users', 'GET', null, `?system_name=is.null&order=created_at.desc&limit=200`);
                        if (Array.isArray(usersWithoutSystem) && usersWithoutSystem.length > 0) {
                            allUsers = usersWithoutSystem;
                        }
                    } catch (e) {
                    }
                    
                    if (allUsers.length === 0) {
                        try {
                            const allUsersSimple = await supabaseRequest('users', 'GET', null, `?order=created_at.desc&limit=200`);
                            if (Array.isArray(allUsersSimple) && allUsersSimple.length > 0) {
                                allUsers = allUsersSimple;
                            }
                        } catch (e2) {
                        }
                    }
                }
                
                let filteredUsers = allUsers.filter(user => {
                    const userSystem = user.system_name || '';
                    return userSystem === SYSTEM_NAME || !userSystem || userSystem === '';
                });
                
                for (const user of filteredUsers) {
                    if (!user.system_name || user.system_name === null || user.system_name === '') {
                        try {
                            await supabaseRequest('users', 'PATCH', { system_name: SYSTEM_NAME }, `?id=eq.${user.id}`);
                            user.system_name = SYSTEM_NAME;
                        } catch (updateError) {
                        }
                    }
                }
                
                if (filteredUsers.length === 0) {
                    try {
                        const allUsersSimple = await supabaseRequest('users', 'GET', null, `?order=created_at.desc&limit=200`);
                        if (Array.isArray(allUsersSimple) && allUsersSimple.length > 0) {
                            filteredUsers = allUsersSimple.filter(user => {
                                const userSystem = user.system_name || '';
                                return userSystem === SYSTEM_NAME || !userSystem || userSystem === '';
                            });
                            
                            for (const user of filteredUsers) {
                                if (!user.system_name || user.system_name === null || user.system_name === '') {
                                    try {
                                        await supabaseRequest('users', 'PATCH', { system_name: SYSTEM_NAME }, `?id=eq.${user.id}`);
                                        user.system_name = SYSTEM_NAME;
                                    } catch (updateError) {
                                    }
                                }
                            }
                        }
                    } catch (e) {
                    }
                }
                
                displayUsers(filteredUsers);
            } catch (error) {
                console.error('Error loading users:', error);
                const errorMsg = error.message || 'ÿÆÿ∑ÿ£ ÿ∫Ÿäÿ± ŸÖÿπÿ±ŸàŸÅ';
                document.getElementById('usersList').innerHTML = `<p style="text-align: center; color: var(--error-color); padding: 20px;">ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿ™ÿ≠ŸÖŸäŸÑ ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ: ${errorMsg}</p>`;
            }
        }
        
        function displayUsers(users) {
            const container = document.getElementById('usersList');
            if (!users || users.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px; background: var(--bg-secondary); border-radius: 12px; border: 2px dashed var(--border-light);">
                        <div style="font-size: 3rem; margin-bottom: 15px;">üë•</div>
                        <p style="color: var(--text-secondary); font-size: 1.1rem; font-weight: 600;">ŸÑÿß ŸäŸàÿ¨ÿØ ŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ ŸÖÿ≥ÿ¨ŸÑŸäŸÜ</p>
                        <p style="color: var(--text-tertiary); font-size: 0.9rem; margin-top: 10px;">ÿßÿ∂ÿ∫ÿ∑ ÿπŸÑŸâ "ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ¨ÿØŸäÿØ" ŸÑÿ•ÿ∂ÿßŸÅÿ© ÿ£ŸàŸÑ ŸÖÿ≥ÿ™ÿÆÿØŸÖ</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = `
                <div style="margin-bottom: 20px; padding: 15px; background: linear-gradient(135deg, var(--primary-light) 0%, rgba(128, 28, 50, 0.05) 100%); border-radius: 10px; border: 1px solid var(--border-light);">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 1.5rem;">üìä</span>
                        <div>
                            <strong style="color: var(--primary-color); font-size: 1.1rem;">ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ:</strong>
                            <span style="color: var(--text-primary); font-size: 1.2rem; font-weight: 700; margin-right: 5px;">${users.length}</span>
                            <span style="color: var(--text-secondary);">ŸÖÿ≥ÿ™ÿÆÿØŸÖ</span>
                        </div>
                    </div>
                </div>
                <div style="overflow-x: auto; border-radius: 12px; border: 1px solid var(--border-color); box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                    <table class="agents-stats-table" style="width: 100%; margin: 0;">
                        <thead style="background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-hover) 100%); color: white;">
                            <tr>
                                <th style="padding: 15px; font-weight: 700;">ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ</th>
                                <th style="padding: 15px; font-weight: 700;">ÿßŸÑÿßÿ≥ŸÖ ÿßŸÑŸÉÿßŸÖŸÑ</th>
                                <th style="padding: 15px; font-weight: 700;">ÿßŸÑÿØŸàÿ±</th>
                                <th style="padding: 15px; font-weight: 700;">ÿßŸÑŸÜÿ∏ÿßŸÖ</th>
                                <th style="padding: 15px; font-weight: 700;">ÿ¢ÿÆÿ± ÿ™ÿ≥ÿ¨ŸäŸÑ ÿØÿÆŸàŸÑ</th>
                                <th style="padding: 15px; font-weight: 700;">ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ•ŸÜÿ¥ÿßÿ°</th>
                                <th style="padding: 15px; font-weight: 700;">ÿßŸÑÿ≠ÿßŸÑÿ©</th>
                                <th style="padding: 15px; font-weight: 700;">ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${users.map((user, index) => {
                                const usernameSafe = escapeHtml(user.username || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ');
                                const fullNameSafe = escapeHtml(user.full_name || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ');
                                const usernameEscaped = (user.username || '').replace(/\\/g, '\\\\').replace(/'/g, "\\'").replace(/"/g, '&quot;');
                                const fullNameEscaped = (user.full_name || '').replace(/\\/g, '\\\\').replace(/'/g, "\\'").replace(/"/g, '&quot;');
                                const roleEscaped = (user.role || 'employee').replace(/\\/g, '\\\\').replace(/'/g, "\\'").replace(/"/g, '&quot;');
                                const rowBg = index % 2 === 0 ? 'var(--bg-primary)' : 'var(--bg-secondary)';
                                return `
                                <tr style="background: ${rowBg}; transition: background 0.2s ease;">
                                    <td style="padding: 15px;"><strong style="color: var(--primary-color);">${usernameSafe}</strong></td>
                                    <td style="padding: 15px;">${fullNameSafe}</td>
                                    <td style="padding: 15px;">
                                        <span style="display: inline-block; padding: 5px 12px; border-radius: 20px; font-weight: 600; font-size: 0.9rem; background: ${user.role === 'admin' ? 'rgba(220, 53, 69, 0.1)' : 'rgba(40, 167, 69, 0.1)'}; color: ${user.role === 'admin' ? '#dc3545' : '#28a745'};">
                                            ${user.role === 'admin' ? 'üëë ŸÖÿØŸäÿ±' : 'üë§ ŸÖŸàÿ∏ŸÅ'}
                                        </span>
                                    </td>
                                    <td style="padding: 15px;">
                                        <span style="display: inline-block; padding: 5px 10px; border-radius: 8px; font-weight: 600; font-size: 0.85rem; background: ${user.system_name === SYSTEM_NAME ? 'rgba(40, 167, 69, 0.1)' : (user.system_name ? 'rgba(220, 53, 69, 0.1)' : 'rgba(255, 193, 7, 0.1)')}; color: ${user.system_name === SYSTEM_NAME ? '#28a745' : (user.system_name ? '#dc3545' : '#ffc107')};">
                                            ${user.system_name === SYSTEM_NAME ? '‚úì Ÿáÿ∞ÿß ÿßŸÑŸÜÿ∏ÿßŸÖ' : (user.system_name ? `‚úó ${user.system_name}` : '‚ö† ŸÇÿØŸäŸÖ')}
                                        </span>
                                        ${user.system_name !== SYSTEM_NAME && user.system_name ? `<button class="btn btn-sm" style="padding: 4px 10px; font-size: 0.75rem; margin-top: 5px; background: var(--info-color); color: white; border: none; border-radius: 6px; cursor: pointer; transition: all 0.2s ease;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'" onclick="fixUserSystem(${user.id}, '${usernameEscaped}')" title="ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÜÿ∏ÿßŸÖ">üîÑ ÿ™ÿ≠ÿØŸäÿ´</button>` : ''}
                                    </td>
                                    <td style="padding: 15px; color: var(--text-secondary); font-size: 0.9rem;">${user.last_login ? new Date(user.last_login).toLocaleString('en-GB', {year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit'}) : '<span style="color: var(--text-tertiary);">‚ùå ŸÑŸÖ Ÿäÿ≥ÿ¨ŸÑ ÿØÿÆŸàŸÑ</span>'}</td>
                                    <td style="padding: 15px; color: var(--text-secondary); font-size: 0.9rem;">${user.created_at ? new Date(user.created_at).toLocaleString('en-GB', {year: 'numeric', month: '2-digit', day: '2-digit'}) : 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'}</td>
                                    <td style="padding: 15px;">
                                        <span style="display: inline-block; padding: 5px 12px; border-radius: 20px; font-weight: 600; font-size: 0.9rem; background: ${user.is_active ? 'rgba(40, 167, 69, 0.1)' : 'rgba(220, 53, 69, 0.1)'}; color: ${user.is_active ? '#28a745' : '#dc3545'};">
                                            ${user.is_active ? '‚úÖ ŸÜÿ¥ÿ∑' : '‚ùå ŸÖÿπÿ∑ŸÑ'}
                                        </span>
                                    </td>
                                    <td style="padding: 15px;">
                                        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                            <button class="btn btn-primary" style="padding: 8px 14px; font-size: 0.85rem; border-radius: 6px; transition: all 0.2s ease;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'" onclick="openEditUserModal(${user.id}, '${usernameEscaped}', '${fullNameEscaped}', '${roleEscaped}', ${user.is_active})">‚úèÔ∏è ÿ™ÿπÿØŸäŸÑ</button>
                                            <button class="btn btn-warning" style="padding: 8px 14px; font-size: 0.85rem; border-radius: 6px; transition: all 0.2s ease;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'" onclick="toggleUserStatus(${user.id}, ${!user.is_active})">${user.is_active ? '‚è∏Ô∏è ÿ™ÿπÿ∑ŸäŸÑ' : '‚ñ∂Ô∏è ÿ™ŸÅÿπŸäŸÑ'}</button>
                                            ${user.id !== currentUserId ? `<button class="btn btn-danger" style="padding: 8px 14px; font-size: 0.85rem; border-radius: 6px; transition: all 0.2s ease;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'" onclick="deleteUser(${user.id}, '${usernameEscaped}')">üóëÔ∏è ÿ≠ÿ∞ŸÅ</button>` : '<span style="color: var(--text-tertiary); font-size: 0.85rem; padding: 8px;">(ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑÿ≠ÿßŸÑŸä)</span>'}
                                        </div>
                                    </td>
                                </tr>
                            `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }
        
        function openAddUserModal() {
            if (currentUserRole !== 'admin') {
                showAlert(document.getElementById('usersAlert'), 'ŸÑŸäÿ≥ ŸÑÿØŸäŸÉ ÿµŸÑÿßÿ≠Ÿäÿ© ŸÑÿ•ÿ∂ÿßŸÅÿ© ŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ.', 'error');
                return;
            }
            const modal = document.getElementById('addUserModal');
            if (modal) {
                modal.classList.add('show');
                modal.style.display = 'flex';
            }
            const modalTitle = document.getElementById('addUserModalTitle');
            const editUserIdEl = document.getElementById('editUserId');
            const userUsernameEl = document.getElementById('userUsername');
            const userFullNameEl = document.getElementById('userFullName');
            const userPasswordEl = document.getElementById('userPassword');
            const passwordRequiredEl = document.getElementById('passwordRequired');
            const passwordHintEl = document.getElementById('passwordHint');
            const userRoleEl = document.getElementById('userRole');
            const addUserAlertEl = document.getElementById('addUserAlert');
            if (modalTitle) modalTitle.textContent = 'ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ¨ÿØŸäÿØ';
            if (editUserIdEl) editUserIdEl.value = '';
            if (userUsernameEl) {
                userUsernameEl.value = '';
                userUsernameEl.disabled = false;
            }
            if (userFullNameEl) userFullNameEl.value = '';
            if (userPasswordEl) {
                userPasswordEl.value = '';
                userPasswordEl.required = true;
            }
            if (passwordRequiredEl) passwordRequiredEl.style.display = 'inline';
            if (passwordHintEl) passwordHintEl.style.display = 'none';
            if (userRoleEl) userRoleEl.value = 'employee';
            if (addUserAlertEl) addUserAlertEl.innerHTML = '';
        }
        
        function openEditUserModal(userId, username, fullName, role, isActive) {
            if (currentUserRole !== 'admin') {
                showAlert(document.getElementById('usersAlert'), 'ŸÑŸäÿ≥ ŸÑÿØŸäŸÉ ÿµŸÑÿßÿ≠Ÿäÿ© ŸÑÿ™ÿπÿØŸäŸÑ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ.', 'error');
                return;
            }
            const modal = document.getElementById('addUserModal');
            if (modal) {
                modal.classList.add('show');
                modal.style.display = 'flex';
            }
            const modalTitleEl = document.getElementById('addUserModalTitle');
            const editUserIdEl = document.getElementById('editUserId');
            const userUsernameEl = document.getElementById('userUsername');
            const userFullNameEl = document.getElementById('userFullName');
            const userPasswordEl = document.getElementById('userPassword');
            const passwordRequiredEl = document.getElementById('passwordRequired');
            const passwordHintEl = document.getElementById('passwordHint');
            const userRoleEl = document.getElementById('userRole');
            const addUserAlertEl = document.getElementById('addUserAlert');
            if (modalTitleEl) modalTitleEl.textContent = 'ÿ™ÿπÿØŸäŸÑ ŸÖÿ≥ÿ™ÿÆÿØŸÖ';
            if (editUserIdEl) editUserIdEl.value = userId;
            if (userUsernameEl) {
                userUsernameEl.value = username;
                userUsernameEl.disabled = true;
            }
            if (userFullNameEl) userFullNameEl.value = fullName;
            if (userPasswordEl) {
                userPasswordEl.value = '';
                userPasswordEl.required = false;
            }
            if (passwordRequiredEl) passwordRequiredEl.style.display = 'none';
            if (passwordHintEl) passwordHintEl.style.display = 'block';
            if (userRoleEl) userRoleEl.value = role;
            if (addUserAlertEl) addUserAlertEl.innerHTML = '';
        }
        
        function closeAddUserModal() {
            const modal = document.getElementById('addUserModal');
            if (modal) {
                modal.classList.remove('show');
                modal.style.display = 'none';
            }
        }
        
        async function saveUser() {
            if (currentUserRole !== 'admin') {
                showAlert(document.getElementById('addUserAlert'), 'ŸÑŸäÿ≥ ŸÑÿØŸäŸÉ ÿµŸÑÿßÿ≠Ÿäÿ© ŸÑÿ•ÿ∂ÿßŸÅÿ©/ÿ™ÿπÿØŸäŸÑ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ.', 'error');
                return;
            }
            
            const editUserIdEl = document.getElementById('editUserId');
            const userUsernameEl = document.getElementById('userUsername');
            const userFullNameEl = document.getElementById('userFullName');
            const userPasswordEl = document.getElementById('userPassword');
            const userRoleEl = document.getElementById('userRole');
            const alertDiv = document.getElementById('addUserAlert');
            if (!editUserIdEl || !userUsernameEl || !userFullNameEl || !userRoleEl) return;
            const editUserId = editUserIdEl.value;
            const username = userUsernameEl.value.trim();
            const fullName = userFullNameEl.value.trim();
            const password = userPasswordEl ? userPasswordEl.value.trim() : '';
            const role = userRoleEl.value;
            
            if (!username || !fullName) {
                showAlert(alertDiv, 'Ÿäÿ±ÿ¨Ÿâ ÿ™ÿπÿ®ÿ¶ÿ© ÿ¨ŸÖŸäÿπ ÿßŸÑÿ≠ŸÇŸàŸÑ ÿßŸÑŸÖÿ∑ŸÑŸàÿ®ÿ©.', 'error');
                return;
            }
            
            if (!editUserId && !password) {
                showAlert(alertDiv, 'Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±.', 'error');
                return;
            }
            
            try {
                const userData = {
                    full_name: fullName,
                    role: role,
                    system_name: SYSTEM_NAME
                };
                
                if (editUserId) {
                    userData.system_name = SYSTEM_NAME;
                    if (password) {
                        const passwordHash = await hashPassword(password);
                        userData.password_hash = passwordHash;
                    }
                    await supabaseRequest('users', 'PATCH', userData, `?id=eq.${editUserId}`);
                    showAlert(alertDiv, 'ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ®ŸÜÿ¨ÿßÿ≠', 'success');
                } else {
                    if (!password) {
                        showAlert(alertDiv, 'Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±.', 'error');
                        return;
                    }
                    
                    let usernameExistsInCurrentSystem = false;
                    try {
                        const existingUserFilter = `?username=eq.${encodeURIComponent(username)}`;
                        const existingUsers = await supabaseRequest('users', 'GET', null, existingUserFilter);
                        
                        if (Array.isArray(existingUsers) && existingUsers.length > 0) {
                            const filtered = existingUsers.filter(user => {
                                if (user.system_name !== undefined && user.system_name !== null && user.system_name !== '') {
                                    return user.system_name === SYSTEM_NAME;
                                }
                                return true;
                            });
                            
                            if (filtered.length > 0) {
                                usernameExistsInCurrentSystem = true;
                                showAlert(alertDiv, 'ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÖŸàÿ¨ŸàÿØ ÿ®ÿßŸÑŸÅÿπŸÑ ŸÅŸä Ÿáÿ∞ÿß ÿßŸÑŸÜÿ∏ÿßŸÖ. Ÿäÿ±ÿ¨Ÿâ ÿßÿÆÿ™Ÿäÿßÿ± ÿßÿ≥ŸÖ ŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ¢ÿÆÿ±.', 'error');
                                return;
                            }
                        }
                    } catch (checkError) {
                        console.warn('Error checking username (will try to create anyway):', checkError);
                    }
                    
                    const passwordHash = await hashPassword(password);
                    userData.username = username;
                    userData.password_hash = passwordHash;
                    userData.is_active = true;
                    userData.system_name = SYSTEM_NAME;
                    
                    try {
                        const result = await supabaseRequest('users', 'POST', userData);
                        showAlert(alertDiv, 'ÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ®ŸÜÿ¨ÿßÿ≠', 'success');
                    } catch (createError) {
                        const errorMsg = createError.message || createError.toString() || '';
                        
                        if (errorMsg.includes('duplicate') || errorMsg.includes('23505') || errorMsg.includes('409') || errorMsg.includes('unique')) {
                            try {
                                const existingUserFilter = `?username=eq.${encodeURIComponent(username)}`;
                                const existingUsers = await supabaseRequest('users', 'GET', null, existingUserFilter);
                                
                                if (Array.isArray(existingUsers) && existingUsers.length > 0) {
                                    const existingUser = existingUsers[0];
                                    
                                    if (existingUser.system_name && existingUser.system_name !== SYSTEM_NAME) {
                                        const updateData = {
                                            system_name: SYSTEM_NAME,
                                            full_name: fullName,
                                            role: role
                                        };
                                        
                                        if (password) {
                                            const passwordHash = await hashPassword(password);
                                            updateData.password_hash = passwordHash;
                                        }
                                        
                                        await supabaseRequest('users', 'PATCH', updateData, `?id=eq.${existingUser.id}`);
                                        showAlert(alertDiv, `ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ "${username}" Ÿàÿ•ÿ∂ÿßŸÅÿ™Ÿá ÿ•ŸÑŸâ Ÿáÿ∞ÿß ÿßŸÑŸÜÿ∏ÿßŸÖ ÿ®ŸÜÿ¨ÿßÿ≠`, 'success');
                                        
                                        closeAddUserModal();
                                        setTimeout(() => {
                                            loadUsers();
                                        }, 1000);
                                        return;
                                    } else if (existingUser.system_name === SYSTEM_NAME) {
                                        showAlert(alertDiv, 'ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÖŸàÿ¨ŸàÿØ ÿ®ÿßŸÑŸÅÿπŸÑ ŸÅŸä Ÿáÿ∞ÿß ÿßŸÑŸÜÿ∏ÿßŸÖ. Ÿäÿ±ÿ¨Ÿâ ÿßÿÆÿ™Ÿäÿßÿ± ÿßÿ≥ŸÖ ŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ¢ÿÆÿ±.', 'error');
                                        return;
                                    } else {
                                        const updateData = {
                                            system_name: SYSTEM_NAME,
                                            full_name: fullName,
                                            role: role
                                        };
                                        
                                        if (password) {
                                            const passwordHash = await hashPassword(password);
                                            updateData.password_hash = passwordHash;
                                        }
                                        
                                        await supabaseRequest('users', 'PATCH', updateData, `?id=eq.${existingUser.id}`);
                                        showAlert(alertDiv, `ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ "${username}" Ÿàÿ•ÿ∂ÿßŸÅÿ™Ÿá ÿ•ŸÑŸâ Ÿáÿ∞ÿß ÿßŸÑŸÜÿ∏ÿßŸÖ ÿ®ŸÜÿ¨ÿßÿ≠`, 'success');
                                        
                                        closeAddUserModal();
                                        setTimeout(() => {
                                            loadUsers();
                                        }, 1000);
                                        return;
                                    }
                                } else {
                                    showAlert(alertDiv, 'ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÖŸàÿ¨ŸàÿØ ÿ®ÿßŸÑŸÅÿπŸÑ. Ÿäÿ±ÿ¨Ÿâ ÿßÿÆÿ™Ÿäÿßÿ± ÿßÿ≥ŸÖ ŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ¢ÿÆÿ±.', 'error');
                                    return;
                                }
                            } catch (checkError) {
                                showAlert(alertDiv, 'ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÖŸàÿ¨ŸàÿØ ÿ®ÿßŸÑŸÅÿπŸÑ. Ÿäÿ±ÿ¨Ÿâ ÿßÿÆÿ™Ÿäÿßÿ± ÿßÿ≥ŸÖ ŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ¢ÿÆÿ±.', 'error');
                                return;
                            }
                        }
                        
                        throw createError;
                    }
                }
                
                closeAddUserModal();
                setTimeout(() => {
                    loadUsers();
                }, 500);
            } catch (error) {
                const errorMessage = error.message || error.toString() || 'ÿÆÿ∑ÿ£ ÿ∫Ÿäÿ± ŸÖÿπÿ±ŸàŸÅ';
                if (errorMessage.includes('duplicate key') || errorMessage.includes('23505') || errorMessage.includes('409')) {
                    showAlert(alertDiv, 'ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÖŸàÿ¨ŸàÿØ ÿ®ÿßŸÑŸÅÿπŸÑ. Ÿäÿ±ÿ¨Ÿâ ÿßÿÆÿ™Ÿäÿßÿ± ÿßÿ≥ŸÖ ŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ¢ÿÆÿ±.', 'error');
                } else if (errorMessage.includes('Failed to fetch') || errorMessage.includes('network')) {
                    showAlert(alertDiv, 'ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿßÿ™ÿµÿßŸÑ. Ÿäÿ±ÿ¨Ÿâ ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ÿßŸÑÿ•ŸÜÿ™ÿ±ŸÜÿ™ ŸàÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ© ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ.', 'error');
                } else {
                    showAlert(alertDiv, `ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿ≠ŸÅÿ∏ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ: ${errorMessage}`, 'error');
                }
            }
        }
        
        async function toggleUserStatus(userId, newStatus) {
            if (currentUserRole !== 'admin') {
                showAlert(document.getElementById('usersAlert'), 'ŸÑŸäÿ≥ ŸÑÿØŸäŸÉ ÿµŸÑÿßÿ≠Ÿäÿ© ŸÑÿ™ÿπÿØŸäŸÑ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ.', 'error');
                return;
            }
            
            try {
                await supabaseRequest('users', 'PATCH', { is_active: newStatus }, `?id=eq.${userId}`);
                loadUsers();
            } catch (error) {
                showAlert(document.getElementById('usersAlert'), 'ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿ™ÿ≠ÿØŸäÿ´ ÿ≠ÿßŸÑÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ.', 'error');
            }
        }
        
        async function deleteUser(userId, username = '') {
            if (currentUserRole !== 'admin') {
                showAlert(document.getElementById('usersAlert'), 'ŸÑŸäÿ≥ ŸÑÿØŸäŸÉ ÿµŸÑÿßÿ≠Ÿäÿ© ŸÑÿ≠ÿ∞ŸÅ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ.', 'error');
                return;
            }
            
            const confirmMessage = username 
                ? `ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ "${username}"ÿü\n\nÿ™ÿ≠ÿ∞Ÿäÿ±: ÿ≥Ÿäÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÜŸáÿßÿ¶ŸäÿßŸã.`
                : 'ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ≠ÿ∞ŸÅ Ÿáÿ∞ÿß ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖÿü\n\nÿ™ÿ≠ÿ∞Ÿäÿ±: ÿ≥Ÿäÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÜŸáÿßÿ¶ŸäÿßŸã.';
            
            if (!confirm(confirmMessage)) {
                return;
            }
            
            try {
                await supabaseRequest('users', 'DELETE', null, `?id=eq.${userId}`);
                loadUsers();
                showAlert(document.getElementById('usersAlert'), `ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ "${username || userId}" ÿ®ŸÜÿ¨ÿßÿ≠`, 'success');
            } catch (error) {
                showAlert(document.getElementById('usersAlert'), `ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ: ${error.message}`, 'error');
            }
        }
        function getCurrentMonthYear() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            return `${year}-${month}`;
        }
        function extractMonthYearFromDetails(details) {
            if (!details || !Array.isArray(details) || details.length === 0) {
                return null;
            }
            for (const detail of details) {
                let dateObj = null;
                let dateField = detail.date1 || detail.date2 || detail.date3 || 
                               detail.date || detail.dateStr || detail.createdAt || 
                               detail['ColumnB'] || detail[1];
                if (!dateField) continue;
                try {
                    if (dateField instanceof Date) {
                        dateObj = dateField;
                    } else if (typeof dateField === 'number' && dateField > 40000) {
                        dateObj = new Date((dateField - 25569) * 86400 * 1000);
                    } else if (typeof dateField === 'string') {
                        const dateStr = dateField.trim();
                        const ddmmyyyy = dateStr.match(/^(\d{1,2})[-\/](\d{1,2})[-\/](\d{4})$/);
                        if (ddmmyyyy) {
                            dateObj = new Date(parseInt(ddmmyyyy[3]), parseInt(ddmmyyyy[2]) - 1, parseInt(ddmmyyyy[1]));
                        } else {
                            const yyyymmdd = dateStr.match(/^(\d{4})[-\/](\d{1,2})[-\/](\d{1,2})$/);
                            if (yyyymmdd) {
                                dateObj = new Date(parseInt(yyyymmdd[1]), parseInt(yyyymmdd[2]) - 1, parseInt(yyyymmdd[3]));
                            } else {
                                dateObj = new Date(dateField);
                            }
                        }
                    } else {
                        dateObj = new Date(dateField);
                    }
                    if (dateObj && !isNaN(dateObj.getTime())) {
                        const year = dateObj.getFullYear();
                        const month = String(dateObj.getMonth() + 1).padStart(2, '0');
                        return `${year}-${month}`;
                    }
                } catch (e) {
                    continue;
                }
            }
            return null;
        }
        function extractMonthYearFromData(data) {
            if (!data || !Array.isArray(data) || data.length === 0) {
                return null;
            }
            for (const row of data) {
                const dateField = row['ColumnB'] || row[1] || row.createdAt || row.date;
                if (!dateField) continue;
                try {
                    let dateObj = null;
                    if (dateField instanceof Date) {
                        dateObj = dateField;
                    } else if (typeof dateField === 'number' && dateField > 40000) {
                        dateObj = new Date((dateField - 25569) * 86400 * 1000);
                    } else if (typeof dateField === 'string') {
                        const dateStr = dateField.trim();
                        const ddmmyyyy = dateStr.match(/^(\d{1,2})[-\/](\d{1,2})[-\/](\d{4})$/);
                        if (ddmmyyyy) {
                            dateObj = new Date(parseInt(ddmmyyyy[3]), parseInt(ddmmyyyy[2]) - 1, parseInt(ddmmyyyy[1]));
                        } else {
                            const yyyymmdd = dateStr.match(/^(\d{4})[-\/](\d{1,2})[-\/](\d{1,2})$/);
                            if (yyyymmdd) {
                                dateObj = new Date(parseInt(yyyymmdd[1]), parseInt(yyyymmdd[2]) - 1, parseInt(yyyymmdd[3]));
                            } else {
                                dateObj = new Date(dateField);
                            }
                        }
                    } else {
                        dateObj = new Date(dateField);
                    }
                    if (dateObj && !isNaN(dateObj.getTime())) {
                        const year = dateObj.getFullYear();
                        const month = String(dateObj.getMonth() + 1).padStart(2, '0');
                        return `${year}-${month}`;
                    }
                } catch (e) {
                    continue;
                }
            }
            return null;
        }
        const arabicMonths = [
            'ŸÉÿßŸÜŸàŸÜ ÿßŸÑÿ´ÿßŸÜŸä', 'ÿ¥ÿ®ÿßÿ∑', 'ÿ¢ÿ∞ÿßÿ±', 'ŸÜŸäÿ≥ÿßŸÜ', 'ÿ£Ÿäÿßÿ±', 'ÿ≠ÿ≤Ÿäÿ±ÿßŸÜ',
            'ÿ™ŸÖŸàÿ≤', 'ÿ¢ÿ®', 'ÿ£ŸäŸÑŸàŸÑ', 'ÿ™ÿ¥ÿ±ŸäŸÜ ÿßŸÑÿ£ŸàŸÑ', 'ÿ™ÿ¥ÿ±ŸäŸÜ ÿßŸÑÿ´ÿßŸÜŸä', 'ŸÉÿßŸÜŸàŸÜ ÿßŸÑÿ£ŸàŸÑ'
        ];
        const subscriptionPrices = {
            basic: {
                'Iraqcell_Bronze_Profile_NEW': 30000,
                'Iraqcell_Bronze_Profile': 30000,
                'Iraqcell_Silver_Profile_NEW': 40000,
                'Iraqcell_Silver_Profile': 40000,
                'Iraqcell_Gold_Profile_NEW': 50000,
                'Iraqcell_Gold_Profile': 50000,
                'Iraqcell_Platinum_Profile_NEW': 65000,
                'Iraqcell_Platinum_Profile': 65000
            },
            advanced: {
                promo: {
                    'Iraqcell_Bronze_Profile_NEW': 75000,
                    'Iraqcell_Bronze_Profile': 75000,
                    'Iraqcell_Silver_Profile_NEW': 105000,
                    'Iraqcell_Silver_Profile': 105000,
                    'Iraqcell_Gold_Profile_NEW': 120000,
                    'Iraqcell_Gold_Profile': 120000,
                    'Iraqcell_Platinum_Profile_NEW': 165000,
                    'Iraqcell_Platinum_Profile': 165000
                },
                official: {
                    'Iraqcell_Bronze_Profile_NEW': 90000,
                    'Iraqcell_Bronze_Profile': 90000,
                    'Iraqcell_Silver_Profile_NEW': 120000,
                    'Iraqcell_Silver_Profile': 120000,
                    'Iraqcell_Gold_Profile_NEW': 150000,
                    'Iraqcell_Gold_Profile': 150000,
                    'Iraqcell_Platinum_Profile_NEW': 195000,
                    'Iraqcell_Platinum_Profile': 195000
                }
            },
            twoMonths: {
                promo: {
                    'Iraqcell_Bronze_Profile_NEW': 50000,
                    'Iraqcell_Bronze_Profile': 50000,
                    'Iraqcell_Silver_Profile_NEW': 70000, 
                    'Iraqcell_Silver_Profile': 70000,
                    'Iraqcell_Gold_Profile_NEW': 80000, 
                    'Iraqcell_Gold_Profile': 80000,
                    'Iraqcell_Platinum_Profile_NEW': 110000,
                    'Iraqcell_Platinum_Profile': 110000
                }
            }
        };
        function getSubscriptionCategory(subscriptionName, agentName) {
            if (!subscriptionName) return '';
            const subscription = String(subscriptionName).trim();
            if (subscription.includes('Platinum') || subscription.includes('ÿ®ŸÑÿßÿ™ŸäŸÜŸäŸàŸÖ') || subscription.toLowerCase().includes('platinum')) {
                return 'P';
            } else if (subscription.includes('Gold') || subscription.includes('ŸÉŸàŸÑÿØ') || subscription.toLowerCase().includes('gold')) {
                return 'G';
            } else if (subscription.includes('Silver') || subscription.includes('ÿ≥ŸÑŸÅÿ±') || subscription.toLowerCase().includes('silver')) {
                return 'S';
            } else if (subscription.includes('Bronze') || subscription.includes('ÿ®ÿ±ŸàŸÜÿ≤') || subscription.toLowerCase().includes('bronze')) {
                return 'B';
            }
            return '';
        }
        function getSubscriptionPrice(subscriptionName, category, type = 'basic', priceType = 'basic') {
            if (!subscriptionName || !category) return 0;
            const subType = String(subscriptionName).trim();
            const defaultNames = {
                'B': 'Iraqcell_Bronze_Profile_NEW',
                'S': 'Iraqcell_Silver_Profile_NEW',
                'G': 'Iraqcell_Gold_Profile_NEW',
                'P': 'Iraqcell_Platinum_Profile_NEW'
            };
            if (type === 'basic') {
                if (subscriptionPrices.basic[subType]) {
                    return subscriptionPrices.basic[subType];
                }
            } else if (type === 'advanced') {
                if (priceType === 'promo' && subscriptionPrices.advanced.promo[subType]) {
                    return subscriptionPrices.advanced.promo[subType];
                } else if (priceType === 'official' && subscriptionPrices.advanced.official[subType]) {
                    return subscriptionPrices.advanced.official[subType];
                }
            } else if (type === 'twoMonths') {
                if (subscriptionPrices.twoMonths.promo && subscriptionPrices.twoMonths.promo[subType]) {
                    return subscriptionPrices.twoMonths.promo[subType];
                }
            }
            const defaultName = defaultNames[category];
            if (!defaultName) return 0;
            if (type === 'basic') {
                return subscriptionPrices.basic[defaultName] || 0;
            } else if (type === 'advanced') {
                if (priceType === 'promo') {
                    return subscriptionPrices.advanced.promo[defaultName] || 0;
                } else if (priceType === 'official') {
                    return subscriptionPrices.advanced.official[defaultName] || 0;
                }
            } else if (type === 'twoMonths') {
                return subscriptionPrices.twoMonths.promo[defaultName] || 0;
            }
            return 0;
        }
        function setupPercentageFileUpload() {
            const fileUpload = document.getElementById('percentageFileUpload');
            const fileInput = document.getElementById('percentageFileInput');
            if (!fileUpload || !fileInput) return;
            fileUpload.addEventListener('click', () => fileInput.click());
            fileUpload.addEventListener('dragover', (e) => {
                e.preventDefault();
                fileUpload.style.background = 'rgba(128, 28, 50, 0.1)';
            });
            fileUpload.addEventListener('dragleave', () => {
                fileUpload.style.background = '';
            });
            fileUpload.addEventListener('drop', (e) => {
                e.preventDefault();
                fileUpload.style.background = '';
                if (e.dataTransfer.files.length > 0) {
                    fileInput.files = e.dataTransfer.files;
                    handlePercentageFileUpload(e.dataTransfer.files[0]);
                }
            });
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handlePercentageFileUpload(e.target.files[0]);
                }
            });
        }
        function handlePercentageFileUpload(file) {
            const fileName = file.name;
            const selectedAgentEl = document.getElementById('selectedAgentForPercentage');
            if (!selectedAgentEl) return;
            const selectedAgent = selectedAgentEl.value;
            if (!selectedAgent) {
                alert('Ÿäÿ±ÿ¨Ÿâ ÿßÿÆÿ™Ÿäÿßÿ± ŸàŸÉŸäŸÑ ÿ£ŸàŸÑÿßŸã');
                const percentageFileInputEl = document.getElementById('percentageFileInput');
                if (percentageFileInputEl) percentageFileInputEl.value = '';
                return;
            }
            const percentageFileNameEl = document.getElementById('percentageFileName');
            if (percentageFileNameEl) {
                percentageFileNameEl.textContent = `ÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖŸÑŸÅ: ${fileName}`;
                percentageFileNameEl.classList.remove('hidden');
            }
            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                percentageData = {
                    agentName: selectedAgent,
                    data: XLSX.utils.sheet_to_json(firstSheet, { header: 1 }),
                    fileName: fileName
                };
                showSuccessMessage(`ÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ ŸÖŸÑŸÅ ÿßŸÑŸàŸÉŸäŸÑ "${selectedAgent}" ÿ®ŸÜÿ¨ÿßÿ≠. ÿßÿ∂ÿ∫ÿ∑ ÿπŸÑŸâ "ÿ™ÿ≠ŸÑŸäŸÑ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸàŸÉŸäŸÑ" ŸÑŸÑÿ®ÿØÿ°`);
                logActivity('ÿ±ŸÅÿπ ŸÖŸÑŸÅ ŸÜÿ≥ÿ®ÿ© ÿßŸÑŸàŸÉŸÑÿßÿ°', `ÿ™ŸÖ ÿ±ŸÅÿπ ŸÖŸÑŸÅ ŸÑŸÑŸàŸÉŸäŸÑ ${selectedAgent}: ${fileName}`);
            };
            reader.readAsArrayBuffer(file);
        }
        function onAgentSelectedForPercentage() {
            const selectedAgentEl = document.getElementById('selectedAgentForPercentage');
            if (!selectedAgentEl) return;
            const selectedAgent = selectedAgentEl.value;
            const agentFileUploadSectionEl = document.getElementById('agentFileUploadSection');
            const percentageFileInputEl = document.getElementById('percentageFileInput');
            const percentageFileNameEl = document.getElementById('percentageFileName');
            const percentageRateSelectEl = document.getElementById('percentageRateSelect');
            const percentageRateInfoEl = document.getElementById('percentageRateInfo');
            if (selectedAgent) {
                if (agentFileUploadSectionEl) agentFileUploadSectionEl.style.display = 'block';
                if (percentageFileInputEl) percentageFileInputEl.value = '';
                if (percentageFileNameEl) percentageFileNameEl.classList.add('hidden');
                percentageData = null;
                const agent = agentsList.find(a => a.name === selectedAgent);
                if (agent && agent.percentage) {
                    if (percentageRateSelectEl) percentageRateSelectEl.value = agent.percentage;
                    if (percentageRateInfoEl) percentageRateInfoEl.textContent = 
                        `ÿßŸÑŸÜÿ≥ÿ®ÿ© ÿßŸÑŸÖÿ≠ŸÅŸàÿ∏ÿ© ŸÑŸÑŸàŸÉŸäŸÑ: ${agent.percentage}%`;
                } else {
                    if (percentageRateSelectEl) percentageRateSelectEl.value = 16;
                    if (percentageRateInfoEl) percentageRateInfoEl.textContent = 
                        'ÿ≥Ÿäÿ™ŸÖ ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑŸÜÿ≥ÿ®ÿ© ÿßŸÑÿßŸÅÿ™ÿ±ÿßÿ∂Ÿäÿ©: 16%';
                }
            } else {
                if (agentFileUploadSectionEl) agentFileUploadSectionEl.style.display = 'none';
            }
        }
        function updatePercentageRate() {
            const selectedAgent = document.getElementById('selectedAgentForPercentage').value;
            const newRate = parseFloat(document.getElementById('percentageRateSelect').value) || 16;
            if (newRate < 0 || newRate > 100) {
                alert('ÿßŸÑŸÜÿ≥ÿ®ÿ© ÿßŸÑŸÖÿ¶ŸàŸäÿ© Ÿäÿ¨ÿ® ÿ£ŸÜ ÿ™ŸÉŸàŸÜ ÿ®ŸäŸÜ 0 Ÿà 100');
                const agent = agentsList.find(a => a.name === selectedAgent);
                document.getElementById('percentageRateSelect').value = agent ? (agent.percentage || 16) : 16;
                return;
            }
            if (selectedAgent) {
                const agent = agentsList.find(a => a.name === selectedAgent);
                if (agent) {
                    agent.percentage = newRate;
                    localStorage.setItem('agentsList', JSON.stringify(agentsList));
                    document.getElementById('percentageRateInfo').textContent = 
                        `ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÜÿ≥ÿ®ÿ© ŸÑŸÑŸàŸÉŸäŸÑ: ${newRate}%`;
                    showSuccessMessage(`ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÜÿ≥ÿ®ÿ© ŸÑŸÑŸàŸÉŸäŸÑ "${selectedAgent}" ÿ•ŸÑŸâ ${newRate}%`);
                }
            }
        }
        function updateAgentsListForPercentage() {
            const select = document.getElementById('selectedAgentForPercentage');
            if (!select) return;
            const currentValue = select.value;
            select.innerHTML = '<option value="">-- ÿßÿÆÿ™ÿ± ŸàŸÉŸäŸÑ --</option>';
            if (Array.isArray(agentsList)) {
                agentsList.forEach(agent => {
                    const option = document.createElement('option');
                    option.value = agent.name;
                    option.textContent = agent.name;
                    select.appendChild(option);
                });
            }
            if (currentValue) {
                select.value = currentValue;
            }
            select.removeEventListener('change', onAgentSelectedForPercentage);
            select.addEventListener('change', onAgentSelectedForPercentage);
        }
        async function analyzeAgentPercentageData() {
            if (!percentageData || !percentageData.data || percentageData.data.length === 0) {
                alert('Ÿäÿ±ÿ¨Ÿâ ÿ±ŸÅÿπ ŸÖŸÑŸÅ Excel ÿ£ŸàŸÑÿßŸã');
                return;
            }
            const selectedAgent = percentageData.agentName;
            if (!selectedAgent) {
                alert('Ÿäÿ±ÿ¨Ÿâ ÿßÿÆÿ™Ÿäÿßÿ± ŸàŸÉŸäŸÑ ÿ£ŸàŸÑÿßŸã');
                return;
            }
            const agent = agentsList.find(a => a.name === selectedAgent);
            let percentageRate = parseFloat(document.getElementById('percentageRateSelect').value) || 16;
            if (agent && agent.percentage) {
                percentageRate = agent.percentage;
                document.getElementById('percentageRateSelect').value = percentageRate;
                showSuccessMessage(`ÿ™ŸÖ ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑŸÜÿ≥ÿ®ÿ© ÿßŸÑŸÖÿ≠ŸÅŸàÿ∏ÿ© ŸÑŸÑŸàŸÉŸäŸÑ: ${percentageRate}%`);
            }
            try {
                const data = percentageData.data;
                let headerRow = -1;
                for (let i = 0; i < Math.min(10, data.length); i++) {
                    const row = data[i];
                    const rowText = row.join(' ').toLowerCase();
                    if ((rowText.includes('profile') || rowText.includes('ŸÜŸàÿπ') || rowText.includes('type')) && 
                        (rowText.includes('amount') || rowText.includes('ŸÖÿ®ŸÑÿ∫') || row.length > 5)) {
                        headerRow = i;
                        break;
                    }
                }
                if (headerRow === -1) {
                    headerRow = 0;
                }
                const headers = data[headerRow] || [];
                const profileCol = findColumnIndex(headers, ['profile', 'ŸÜŸàÿπ', 'type', 'h']);
                const amountCol = findColumnIndex(headers, ['amount', 'ŸÖÿ®ŸÑÿ∫', 'ŸÇŸäŸÖÿ©', 'l']);
                if (profileCol < 0 || amountCol < 0) {
                    alert('ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ÿ£ÿπŸÖÿØÿ© Profile Type Ÿà Amount ŸÅŸä ÿßŸÑŸÖŸÑŸÅ. ÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿµÿ≠ÿ© ÿßŸÑŸÖŸÑŸÅ.');
                    return;
                }
                await analyzeSubscriptionFileWithSystemPrices(data, headerRow, profileCol, amountCol, selectedAgent, percentageRate);
            } catch (error) {
                console.error('Error analyzing percentage data:', error);
                alert('ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™: ' + error.message);
            }
        }
        async function analyzeSubscriptionFileWithSystemPrices(data, headerRow, profileCol, amountCol, agentName, percentageRate) {
            const hasExistingData = agentPercentages[agentName] && (
                agentPercentages[agentName].iqT > 0 || 
                agentPercentages[agentName].totalCount > 0
            );
            
            let keepDeductions = false;
            if (hasExistingData) {
                const existing = agentPercentages[agentName];
                if (existing.deductions > 0 || existing.penalties > 0) {
                    keepDeductions = confirm(`‚ö†Ô∏è ŸäŸàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™ ŸÖÿ≠ŸÅŸàÿ∏ÿ© ŸÑŸÑŸàŸÉŸäŸÑ "${agentName}"\n\nŸáŸÑ ÿ™ÿ±ŸäÿØ ÿßŸÑÿßÿ≠ÿ™ŸÅÿßÿ∏ ÿ®ÿßŸÑÿßÿ≥ÿ™ŸÇÿ∑ÿßÿπÿßÿ™ ŸàÿßŸÑÿ∫ÿ±ÿßŸÖÿßÿ™ ÿßŸÑÿ≠ÿßŸÑŸäÿ©ÿü\n\n- ŸÜÿπŸÖ: ÿ≥Ÿäÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿäÿ© ŸÖÿπ ÿßŸÑÿßÿ≠ÿ™ŸÅÿßÿ∏ ÿ®ÿßŸÑÿßÿ≥ÿ™ŸÇÿ∑ÿßÿπÿßÿ™ ŸàÿßŸÑÿ∫ÿ±ÿßŸÖÿßÿ™\n- ÿ•ŸÑÿ∫ÿßÿ°: ÿ≥Ÿäÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ®ŸÖÿß ŸÅŸä ÿ∞ŸÑŸÉ ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ÿßŸÑÿßÿ≥ÿ™ŸÇÿ∑ÿßÿπÿßÿ™ ŸàÿßŸÑÿ∫ÿ±ÿßŸÖÿßÿ™ ÿ•ŸÑŸâ ÿµŸÅÿ±`);
                }
                
                if (!confirm(`ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ™ÿ≠ÿØŸäÿ´ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸàŸÉŸäŸÑ "${agentName}"ÿü\n\nÿ≥Ÿäÿ™ŸÖ ÿßÿ≥ÿ™ÿ®ÿØÿßŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÇÿØŸäŸÖÿ© ÿ®ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ¨ÿØŸäÿØÿ© ŸÖŸÜ ÿßŸÑŸÖŸÑŸÅ.`)) {
                    return;
                }
            }
            
            let countP = 0, countG = 0, countS = 0, countB = 0;
            for (let i = headerRow + 1; i < data.length; i++) {
                const row = data[i];
                if (!row || row.length === 0) continue;
                const profileType = (row[profileCol] || '').toString().trim();
                const amount = parseFloat(row[amountCol]) || 0;
                if (!profileType) continue;
                const category = getSubscriptionCategory(profileType, agentName);
                if (!category) continue;
                switch(category) {
                    case 'P':
                        countP++;
                        break;
                    case 'G':
                        countG++;
                        break;
                    case 'S':
                        countS++;
                        break;
                    case 'B':
                        countB++;
                        break;
                }
            }
            const officialPriceP = subscriptionPrices.basic['Iraqcell_Platinum_Profile_NEW'] || 65000;
            const officialPriceG = subscriptionPrices.basic['Iraqcell_Gold_Profile_NEW'] || 50000;
            const officialPriceS = subscriptionPrices.basic['Iraqcell_Silver_Profile_NEW'] || 40000;
            const officialPriceB = subscriptionPrices.basic['Iraqcell_Bronze_Profile_NEW'] || 30000;
            const iqP = countP * officialPriceP;
            const iqG = countG * officialPriceG;
            const iqS = countS * officialPriceS;
            const iqB = countB * officialPriceB;
            const iqT = iqP + iqG + iqS + iqB;
            const iqPPercent = iqP * (percentageRate / 100);
            const iqGPercent = iqG * (percentageRate / 100);
            const iqSPercent = iqS * (percentageRate / 100);
            const iqBPercent = iqB * (percentageRate / 100);
            const agentPercentageAmount = iqPPercent + iqGPercent + iqSPercent + iqBPercent;
            const agent = agentsList.find(a => a.name === agentName);
            const agentPhone = agent?.phone || '';
            const agentEmail = agent?.email || '';
            
            const existing = agentPercentages[agentName];
            
            if (!existing) {
                agentPercentages[agentName] = {
                    percentage: percentageRate,
                    iqT: iqT,
                    iqP: iqP,
                    iqG: iqG,
                    iqS: iqS,
                    iqB: iqB,
                    iqPPercent: iqPPercent,
                    iqGPercent: iqGPercent,
                    iqSPercent: iqSPercent,
                    iqBPercent: iqBPercent,
                    agentPercentageAmount: agentPercentageAmount,
                    deductions: 0,
                    penalties: 0,
                    netPercentage: agentPercentageAmount,
                    totalCount: countP + countG + countS + countB,
                    countP: countP,
                    countG: countG,
                    countS: countS,
                    countB: countB,
                    phone: agentPhone,
                    email: agentEmail
                };
            } else {
                agentPercentages[agentName] = {
                    percentage: percentageRate,
                    iqT: iqT,
                    iqP: iqP,
                    iqG: iqG,
                    iqS: iqS,
                    iqB: iqB,
                    iqPPercent: iqPPercent,
                    iqGPercent: iqGPercent,
                    iqSPercent: iqSPercent,
                    iqBPercent: iqBPercent,
                    agentPercentageAmount: agentPercentageAmount,
                    deductions: keepDeductions ? (existing.deductions || 0) : 0,
                    penalties: keepDeductions ? (existing.penalties || 0) : 0,
                    netPercentage: agentPercentageAmount - (keepDeductions ? (existing.deductions || 0) : 0) - (keepDeductions ? (existing.penalties || 0) : 0),
                    totalCount: countP + countG + countS + countB,
                    countP: countP,
                    countG: countG,
                    countS: countS,
                    countB: countB,
                    phone: agentPhone || existing.phone || '',
                    email: agentEmail || existing.email || ''
                };
            }
            renderPercentageTable();
            const extractedMonthYear = extractMonthYearFromData(percentageData.data);
            const monthYear = extractedMonthYear || getCurrentMonthYear();
            
            try {
                localStorage.setItem('agentPercentages', JSON.stringify(agentPercentages));
                localStorage.setItem('agentPercentages_monthYear', monthYear);
            } catch (e) {
                console.warn('‚ö† Failed to save to localStorage:', e);
            }
            
            if (supabaseClient) {
                try {
                    const saved = await saveToDatabase('agent_percentages', agentPercentages, { monthYear: monthYear });
                    if (saved) {
                    } else {
                    }
                } catch (error) {
                    console.error('‚úó ÿÆÿ∑ÿ£ ŸÅŸä ÿ≠ŸÅÿ∏ ÿßŸÑŸÜÿ≥ÿ® ŸÅŸä ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™:', error);
                }
                
                try {
                    await saveToDatabase('analysis_archives', {
                        data: percentageData.data || [],
                        details: [],
                        results: {},
                        agentReports: agentReports
                    }, { analysis_type: 'percentage', monthYear: monthYear });
                } catch (error) {
                    console.error('‚úó ÿÆÿ∑ÿ£ ŸÅŸä ÿ≠ŸÅÿ∏ ÿßŸÑÿ£ÿ±ÿ¥ŸäŸÅ:', error);
                }
            }
            showSuccessMessage(`ÿ™ŸÖ ÿ™ÿ≠ŸÑŸäŸÑ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸàŸÉŸäŸÑ "${agentName}" ÿ®ŸÜÿ¨ÿßÿ≠. ÿßŸÑŸÜÿ≥ÿ®ÿ©: ${percentageRate}% - ÿßŸÑŸÖÿ¨ŸÖŸàÿπ: ${formatNumber(iqT)} ÿØ.ÿπ`);
            logActivity('ÿ™ÿ≠ŸÑŸäŸÑ ŸÜÿ≥ÿ®ÿ© ÿßŸÑŸàŸÉŸÑÿßÿ°', `ÿ™ŸÖ ÿ™ÿ≠ŸÑŸäŸÑ ŸÖŸÑŸÅ ÿßŸÑŸàŸÉŸäŸÑ ${agentName}: ${countP}P, ${countG}G, ${countS}S, ${countB}B - ÿßŸÑŸÜÿ≥ÿ®ÿ©: ${percentageRate}%`);
        }
        async function analyzeDirectPercentageFile(headers, headerRow) {
            const agentNameCol = findColumnIndex(headers, ['ÿßÿ≥ŸÖ', 'ŸàŸÉŸäŸÑ', 'ÿßŸÑŸàŸÉŸäŸÑ', 'name']);
            const iqTCol = findColumnIndex(headers, ['IQ.T', 'IQT', 'IQ', 'ÿ™']);
            const iqPCol = findColumnIndex(headers, ['IQ.P', 'IQP', 'P']);
            const iqGCol = findColumnIndex(headers, ['IQ.G', 'IQG', 'G']);
            const iqSCol = findColumnIndex(headers, ['IQ.S', 'IQS', 'S']);
            const iqBCol = findColumnIndex(headers, ['IQ.B', 'IQB', 'B']);
            const agentPercentageCol = findColumnIndex(headers, ['ŸÜÿ≥ÿ®ÿ©', 'ÿßŸÑŸàŸÉŸäŸÑ', 'ŸÜÿ≥ÿ®ÿ© ÿßŸÑŸàŸÉŸäŸÑ']);
            let defaultPercentage = 15;
            for (let i = 0; i < headers.length; i++) {
                const header = (headers[i] || '').toString().toUpperCase();
                if (header.includes('%16') || header.includes('16%')) {
                    defaultPercentage = 16;
                    break;
                } else if (header.includes('%15') || header.includes('15%')) {
                    defaultPercentage = 15;
                    break;
                }
            }
            for (let i = headerRow + 1; i < percentageData.length; i++) {
                const row = percentageData[i];
                if (!row || row.length === 0) continue;
                const agentName = row[agentNameCol];
                if (!agentName || agentName === 'ÿßŸÑŸÖÿ¨ŸÖŸàÿπ' || agentName.toString().trim() === '') continue;
                let agentPercentage = defaultPercentage;
                let agentPercentageAmount = 0;
                for (let j = 0; j < headers.length; j++) {
                    const header = (headers[j] || '').toString().toUpperCase();
                    if (header.includes('P%16') || header.includes('G%16') || header.includes('S%16') || header.includes('B%16')) {
                        agentPercentage = 16;
                        break;
                    } else if (header.includes('P%15') || header.includes('G%15') || header.includes('S%15') || header.includes('B%15')) {
                        agentPercentage = 15;
                        break;
                    }
                }
                const iqT = parseFloat(row[iqTCol]) || 0;
                const iqP = parseFloat(row[iqPCol]) || 0;
                const iqG = parseFloat(row[iqGCol]) || 0;
                const iqS = parseFloat(row[iqSCol]) || 0;
                const iqB = parseFloat(row[iqBCol]) || 0;
                if (agentPercentageCol >= 0 && row[agentPercentageCol]) {
                    agentPercentageAmount = parseFloat(row[agentPercentageCol]) || 0;
                } else {
                    agentPercentageAmount = calculateAgentPercentage(iqT, iqP, iqG, iqS, iqB, agentPercentage);
                }
                saveAgentPercentage(agentName, agentPercentage, iqT, iqP, iqG, iqS, iqB, agentPercentageAmount);
            }
            renderPercentageTable();
            const extractedMonthYear = extractMonthYearFromData(percentageData.data);
            const monthYear = extractedMonthYear || getCurrentMonthYear();
            
            try {
                localStorage.setItem('agentPercentages', JSON.stringify(agentPercentages));
                localStorage.setItem('agentPercentages_monthYear', monthYear);
            } catch (e) {
                console.warn('‚ö† Failed to save to localStorage:', e);
            }
            
            if (supabaseClient) {
                try {
                    const saved = await saveToDatabase('agent_percentages', agentPercentages, { monthYear: monthYear });
                    if (saved) {
                    } else {
                    }
                } catch (error) {
                    console.error('‚úó ÿÆÿ∑ÿ£ ŸÅŸä ÿ≠ŸÅÿ∏ ÿßŸÑŸÜÿ≥ÿ® ŸÅŸä ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™:', error);
                }
                
                try {
                    await saveToDatabase('analysis_archives', {
                        data: percentageData.data || [],
                        details: [],
                        results: {},
                        agentReports: agentReports
                    }, { analysis_type: 'percentage', monthYear: monthYear });
                } catch (error) {
                    console.error('‚úó ÿÆÿ∑ÿ£ ŸÅŸä ÿ≠ŸÅÿ∏ ÿßŸÑÿ£ÿ±ÿ¥ŸäŸÅ:', error);
                }
            }
            showSuccessMessage('ÿ™ŸÖ ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ®ŸÜÿ¨ÿßÿ≠');
            logActivity('ÿ™ÿ≠ŸÑŸäŸÑ ŸÜÿ≥ÿ®ÿ© ÿßŸÑŸàŸÉŸÑÿßÿ°', 'ÿ™ŸÖ ÿ™ÿ≠ŸÑŸäŸÑ ŸÖŸÑŸÅ ŸÜÿ≥ÿ®ÿ© ÿßŸÑŸàŸÉŸÑÿßÿ° ÿ®ŸÜÿ¨ÿßÿ≠');
        }
        async function analyzeSubscriptionPercentageFile(headers, headerRow) {
            const agentNameCol = findColumnIndex(headers, ['ÿßÿ≥ŸÖ', 'ŸàŸÉŸäŸÑ', 'ÿßŸÑŸàŸÉŸäŸÑ', 'name', 'f', 'c']);
            const profileCol = findColumnIndex(headers, ['profile', 'ŸÜŸàÿπ', 'type', 'h']);
            const amountCol = findColumnIndex(headers, ['amount', 'ŸÖÿ®ŸÑÿ∫', 'ŸÇŸäŸÖÿ©', 'l']);
            const emailCol = findColumnIndex(headers, ['email', 'ÿ®ÿ±ŸäÿØ', 'e', 'p']);
            const percentageInput = prompt('Ÿäÿ±ÿ¨Ÿâ ÿ™ÿ≠ÿØŸäÿØ ÿßŸÑŸÜÿ≥ÿ®ÿ©:\n1 - 15%\n2 - 16%', '1');
            const agentPercentage = (percentageInput === '2' || percentageInput === '16') ? 16 : 15;
            const agentData = {};
            for (let i = headerRow + 1; i < percentageData.length; i++) {
                const row = percentageData[i];
                if (!row || row.length === 0) continue;
                let agentName = '';
                if (agentNameCol >= 0 && row[agentNameCol]) {
                    agentName = (row[agentNameCol] || '').toString().trim();
                }
                if (!agentName && emailCol >= 0 && row[emailCol]) {
                    const email = (row[emailCol] || '').toString().trim();
                    if (email.includes('@')) {
                        agentName = email.split('@')[0];
                    } else {
                        agentName = email;
                    }
                }
                if (!agentName) {
                    for (let j = 0; j < row.length; j++) {
                        const cell = (row[j] || '').toString().trim();
                        if (cell && !/^\d+$/.test(cell) && !cell.includes('-') && !cell.includes('@') && cell.length > 2) {
                            agentName = cell;
                            break;
                        }
                    }
                }
                if (!agentName || agentName === '') continue;
                let profileType = '';
                if (profileCol >= 0 && row[profileCol]) {
                    profileType = (row[profileCol] || '').toString().trim();
                }
                let amount = 0;
                if (amountCol >= 0 && row[amountCol]) {
                    amount = parseFloat(row[amountCol]) || 0;
                }
                const category = getSubscriptionCategory(profileType, agentName) || 'B';
                if (!agentData[agentName]) {
                    agentData[agentName] = { 
                        P: 0, G: 0, S: 0, B: 0,
                        countP: 0, countG: 0, countS: 0, countB: 0
                    };
                }
                agentData[agentName][category] += amount;
                agentData[agentName]['count' + category] += 1;
            }
            for (const agentName in agentData) {
                const data = agentData[agentName];
                const iqP = data.P || 0;
                const iqG = data.G || 0;
                const iqS = data.S || 0;
                const iqB = data.B || 0;
                const iqT = iqP + iqG + iqS + iqB;
                const countP = data.countP || 0;
                const countG = data.countG || 0;
                const countS = data.countS || 0;
                const countB = data.countB || 0;
                const totalCount = countP + countG + countS + countB;
                const agentPercentageAmount = calculateAgentPercentage(iqT, iqP, iqG, iqS, iqB, agentPercentage);
                saveAgentPercentageWithCounts(
                    agentName, 
                    agentPercentage, 
                    iqT, iqP, iqG, iqS, iqB, 
                    agentPercentageAmount,
                    totalCount, countP, countG, countS, countB
                );
            }
            renderPercentageTable();
            const extractedMonthYear = extractMonthYearFromData(percentageData.data);
            const monthYear = extractedMonthYear || getCurrentMonthYear();
            
            try {
                localStorage.setItem('agentPercentages', JSON.stringify(agentPercentages));
                localStorage.setItem('agentPercentages_monthYear', monthYear);
            } catch (e) {
                console.warn('‚ö† Failed to save to localStorage:', e);
            }
            
            if (supabaseClient) {
                try {
                    const saved = await saveToDatabase('agent_percentages', agentPercentages, { monthYear: monthYear });
                    if (saved) {
                    } else {
                    }
                } catch (error) {
                    console.error('‚úó ÿÆÿ∑ÿ£ ŸÅŸä ÿ≠ŸÅÿ∏ ÿßŸÑŸÜÿ≥ÿ® ŸÅŸä ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™:', error);
                }
                
                try {
                    await saveToDatabase('analysis_archives', {
                        data: percentageData.data || [],
                        details: [],
                        results: {},
                        agentReports: agentReports
                    }, { analysis_type: 'percentage', monthYear: monthYear });
                } catch (error) {
                    console.error('‚úó ÿÆÿ∑ÿ£ ŸÅŸä ÿ≠ŸÅÿ∏ ÿßŸÑÿ£ÿ±ÿ¥ŸäŸÅ:', error);
                }
            }
            showSuccessMessage(`ÿ™ŸÖ ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ®ŸÜÿ¨ÿßÿ≠. ÿ™ŸÖ ÿ≠ÿ≥ÿßÿ® ÿßŸÑŸÜÿ≥ÿ®ÿ© ÿ®ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ${agentPercentage}%`);
            logActivity('ÿ™ÿ≠ŸÑŸäŸÑ ŸÜÿ≥ÿ®ÿ© ÿßŸÑŸàŸÉŸÑÿßÿ°', `ÿ™ŸÖ ÿ™ÿ≠ŸÑŸäŸÑ ŸÖŸÑŸÅ ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉÿßÿ™ Ÿàÿ≠ÿ≥ÿßÿ® ÿßŸÑŸÜÿ≥ÿ® ÿ®ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ${agentPercentage}%`);
        }
        function saveAgentPercentage(agentName, percentage, iqT, iqP, iqG, iqS, iqB, agentPercentageAmount) {
            const agent = agentsList.find(a => a.name === agentName);
            const agentPhone = agent?.phone || '';
            const agentEmail = agent?.email || '';
            const hasExistingData = agentPercentages[agentName] && (
                agentPercentages[agentName].iqT > 0 || 
                agentPercentages[agentName].totalCount > 0
            );
            
            if (!agentPercentages[agentName]) {
                agentPercentages[agentName] = {
                    percentage: percentage,
                    iqT: iqT,
                    iqP: iqP,
                    iqG: iqG,
                    iqS: iqS,
                    iqB: iqB,
                    agentPercentageAmount: agentPercentageAmount,
                    deductions: 0,
                    penalties: 0,
                    netPercentage: agentPercentageAmount,
                    totalCount: 0,
                    countP: 0,
                    countG: 0,
                    countS: 0,
                    countB: 0,
                    phone: agentPhone,
                    email: agentEmail
                };
            } else {
                const existing = agentPercentages[agentName];
                const keepDeductions = hasExistingData && (existing.deductions > 0 || existing.penalties > 0);
                
                agentPercentages[agentName].percentage = percentage;
                agentPercentages[agentName].iqT = iqT;
                agentPercentages[agentName].iqP = iqP;
                agentPercentages[agentName].iqG = iqG;
                agentPercentages[agentName].iqS = iqS;
                agentPercentages[agentName].iqB = iqB;
                agentPercentages[agentName].agentPercentageAmount = agentPercentageAmount;
                agentPercentages[agentName].deductions = keepDeductions ? (existing.deductions || 0) : 0;
                agentPercentages[agentName].penalties = keepDeductions ? (existing.penalties || 0) : 0;
                agentPercentages[agentName].netPercentage = agentPercentageAmount - 
                    (keepDeductions ? (existing.deductions || 0) : 0) - 
                    (keepDeductions ? (existing.penalties || 0) : 0);
                if (agentPhone) {
                    agentPercentages[agentName].phone = agentPhone;
                }
                if (agentEmail) {
                    agentPercentages[agentName].email = agentEmail;
                }
            }
        }
        function saveAgentPercentageWithCounts(agentName, percentage, iqT, iqP, iqG, iqS, iqB, agentPercentageAmount, totalCount, countP, countG, countS, countB) {
            const agent = agentsList.find(a => a.name === agentName);
            const agentPhone = agent?.phone || '';
            const agentEmail = agent?.email || '';
            const hasExistingData = agentPercentages[agentName] && (
                agentPercentages[agentName].iqT > 0 || 
                agentPercentages[agentName].totalCount > 0
            );
            
            if (!agentPercentages[agentName]) {
                agentPercentages[agentName] = {
                    percentage: percentage,
                    iqT: iqT,
                    iqP: iqP,
                    iqG: iqG,
                    iqS: iqS,
                    iqB: iqB,
                    agentPercentageAmount: agentPercentageAmount,
                    deductions: 0,
                    penalties: 0,
                    netPercentage: agentPercentageAmount,
                    totalCount: totalCount,
                    countP: countP,
                    countG: countG,
                    countS: countS,
                    countB: countB,
                    phone: agentPhone,
                    email: agentEmail
                };
            } else {
                const existing = agentPercentages[agentName];
                const keepDeductions = hasExistingData && (existing.deductions > 0 || existing.penalties > 0);
                
                agentPercentages[agentName].percentage = percentage;
                agentPercentages[agentName].iqT = iqT;
                agentPercentages[agentName].iqP = iqP;
                agentPercentages[agentName].iqG = iqG;
                agentPercentages[agentName].iqS = iqS;
                agentPercentages[agentName].iqB = iqB;
                agentPercentages[agentName].agentPercentageAmount = agentPercentageAmount;
                agentPercentages[agentName].totalCount = totalCount;
                agentPercentages[agentName].countP = countP;
                agentPercentages[agentName].countG = countG;
                agentPercentages[agentName].countS = countS;
                agentPercentages[agentName].countB = countB;
                agentPercentages[agentName].deductions = keepDeductions ? (existing.deductions || 0) : 0;
                agentPercentages[agentName].penalties = keepDeductions ? (existing.penalties || 0) : 0;
                agentPercentages[agentName].netPercentage = agentPercentageAmount - 
                    (keepDeductions ? (existing.deductions || 0) : 0) - 
                    (keepDeductions ? (existing.penalties || 0) : 0);
                if (agentPhone) {
                    agentPercentages[agentName].phone = agentPhone;
                }
                if (agentEmail) {
                    agentPercentages[agentName].email = agentEmail;
                }
            }
        }
        function findColumnIndex(headers, keywords) {
            for (let i = 0; i < headers.length; i++) {
                const header = (headers[i] || '').toString().toLowerCase();
                if (keywords.some(keyword => header.includes(keyword.toLowerCase()))) {
                    return i;
                }
            }
            return -1;
        }
        function calculateAgentPercentage(iqT, iqP, iqG, iqS, iqB, percentage) {
            const rate = percentage / 100;
            return (iqP * rate) + (iqG * rate) + (iqS * rate) + (iqB * rate);
        }
        function renderPercentageTable() {
            const tbody = document.getElementById('percentageTableBody');
            if (!tbody) return;
            if (isRenderingTable) return;
            isRenderingTable = true;
            const activeElement = document.activeElement;
            let savedFocus = null;
            if (activeElement && activeElement.tagName === 'INPUT' && 
                activeElement.hasAttribute('data-agent-name') && 
                activeElement.hasAttribute('data-field-type')) {
                savedFocus = {
                    agentName: activeElement.getAttribute('data-agent-name'),
                    fieldType: activeElement.getAttribute('data-field-type'),
                    value: activeElement.value
                };
            }
            tbody.innerHTML = '';
            if (!agentPercentages || typeof agentPercentages !== 'object') {
                tbody.innerHTML = '<tr><td colspan="19" style="text-align: center; padding: 15px; color: #999; font-size: 0.85rem;">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™ ŸÑŸÑÿπÿ±ÿ∂</td></tr>';
                isRenderingTable = false;
                return;
            }
            const agents = Object.keys(agentPercentages);
            if (agents.length === 0) {
                tbody.innerHTML = '<tr><td colspan="19" style="text-align: center; padding: 15px; color: #999; font-size: 0.85rem;">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™ ŸÑŸÑÿπÿ±ÿ∂</td></tr>';
                isRenderingTable = false;
                return;
            }
            let totalIQT = 0, totalIQP = 0, totalIQG = 0, totalIQS = 0, totalIQB = 0;
            let totalIQPPercent = 0, totalIQGPercent = 0, totalIQSPercent = 0, totalIQBPercent = 0;
            let totalCountP = 0, totalCountG = 0, totalCountS = 0, totalCountB = 0;
            let totalAgentPercentage = 0;
            agents.forEach(agentName => {
                const data = agentPercentages[agentName] || {};
                const row = document.createElement('tr');
                row.style.borderBottom = '1px solid #ddd';
                const percentage = data.percentage || 15;
                const rate = percentage / 100;
                const iqPPercent = data.iqPPercent !== undefined ? data.iqPPercent : ((data.iqP || 0) * rate);
                const iqGPercent = data.iqGPercent !== undefined ? data.iqGPercent : ((data.iqG || 0) * rate);
                const iqSPercent = data.iqSPercent !== undefined ? data.iqSPercent : ((data.iqS || 0) * rate);
                const iqBPercent = data.iqBPercent !== undefined ? data.iqBPercent : ((data.iqB || 0) * rate);
                totalIQT += data.iqT || 0;
                totalIQP += data.iqP || 0;
                totalIQG += data.iqG || 0;
                totalIQS += data.iqS || 0;
                totalIQB += data.iqB || 0;
                totalIQPPercent += iqPPercent;
                totalIQGPercent += iqGPercent;
                totalIQSPercent += iqSPercent;
                totalIQBPercent += iqBPercent;
                totalCountP += data.countP || 0;
                totalCountG += data.countG || 0;
                totalCountS += data.countS || 0;
                totalCountB += data.countB || 0;
                
                const agent = agentsList.find(a => a.name === agentName);
                const totalActivations = (data.countB || 0) + (data.countS || 0) + (data.countG || 0) + (data.countP || 0);
                const totalAgentPercentageAmount = Math.round(iqBPercent) + Math.round(iqSPercent) + Math.round(iqGPercent) + Math.round(iqPPercent);
                const netAgentPercentage = totalAgentPercentageAmount - (data.deductions || 0) - (data.penalties || 0);
                totalAgentPercentage += totalAgentPercentageAmount;
                
                row.innerHTML = `
                    <td style="padding: 6px 4px; text-align: center; border: 1px solid #ddd; font-weight: 600; font-size: 0.75rem; background-color: #801c32; color: white;">${agentName}</td>
                    <td style="padding: 6px 4px; text-align: center; border: 1px solid #ddd; direction: ltr; font-size: 0.7rem;">${data.countB || 0}</td>
                    <td style="padding: 6px 4px; text-align: center; border: 1px solid #ddd; direction: ltr; font-size: 0.7rem;">${data.countS || 0}</td>
                    <td style="padding: 6px 4px; text-align: center; border: 1px solid #ddd; direction: ltr; font-size: 0.7rem;">${data.countG || 0}</td>
                    <td style="padding: 6px 4px; text-align: center; border: 1px solid #ddd; direction: ltr; font-size: 0.7rem;">${data.countP || 0}</td>
                    <td style="padding: 6px 4px; text-align: center; border: 1px solid #ddd; direction: ltr; font-size: 0.7rem; font-weight: 600;">${totalActivations}</td>
                    <td style="padding: 6px 4px; text-align: center; border: 1px solid #ddd; direction: ltr; font-size: 0.7rem;">${formatNumber(data.iqB || 0)}</td>
                    <td style="padding: 6px 4px; text-align: center; border: 1px solid #ddd; direction: ltr; font-size: 0.7rem;">${formatNumber(data.iqS || 0)}</td>
                    <td style="padding: 6px 4px; text-align: center; border: 1px solid #ddd; direction: ltr; font-size: 0.7rem;">${formatNumber(data.iqG || 0)}</td>
                    <td style="padding: 6px 4px; text-align: center; border: 1px solid #ddd; direction: ltr; font-size: 0.7rem;">${formatNumber(data.iqP || 0)}</td>
                    <td style="padding: 6px 4px; text-align: center; border: 1px solid #ddd; direction: ltr; font-size: 0.7rem;">${formatNumber(data.iqT || 0)}</td>
                    <td style="padding: 6px 4px; text-align: center; border: 1px solid #ddd; direction: ltr; font-weight: 600; color: #2C5F8D; font-size: 0.7rem;">${formatNumber(Math.round(iqBPercent))}</td>
                    <td style="padding: 6px 4px; text-align: center; border: 1px solid #ddd; direction: ltr; font-weight: 600; color: #2C5F8D; font-size: 0.7rem;">${formatNumber(Math.round(iqSPercent))}</td>
                    <td style="padding: 6px 4px; text-align: center; border: 1px solid #ddd; direction: ltr; font-weight: 600; color: #2C5F8D; font-size: 0.7rem;">${formatNumber(Math.round(iqGPercent))}</td>
                    <td style="padding: 6px 4px; text-align: center; border: 1px solid #ddd; direction: ltr; font-weight: 600; color: #2C5F8D; font-size: 0.7rem;">${formatNumber(Math.round(iqPPercent))}</td>
                    <td style="padding: 6px 4px; text-align: center; border: 1px solid #ddd; direction: ltr; font-weight: bold; color: #801c32; font-size: 0.85rem;">${formatNumber(netAgentPercentage)}</td>
                    <td style="padding: 6px 4px; text-align: center; border: 1px solid #ddd; position: relative; z-index: 10;">
                        <input type="number" id="deduction_${agentName.replace(/[^a-zA-Z0-9]/g, '_')}" value="${data.deductions || 0}" 
                               data-agent-name="${agentName}"
                               data-field-type="deduction"
                               style="width: 80px; padding: 4px; text-align: center; direction: ltr; font-size: 0.7rem; position: relative; z-index: 10; pointer-events: auto; cursor: text; -webkit-user-select: text; -moz-user-select: text; user-select: text; border: 1px solid #ccc; border-radius: 4px;" 
                               step="0.01" min="0" placeholder="0">
                    </td>
                    <td style="padding: 6px 4px; text-align: center; border: 1px solid #ddd; position: relative; z-index: 10;">
                        <input type="number" id="penalty_${agentName.replace(/[^a-zA-Z0-9]/g, '_')}" value="${data.penalties || 0}" 
                               data-agent-name="${agentName}"
                               data-field-type="penalty"
                               style="width: 80px; padding: 4px; text-align: center; direction: ltr; font-size: 0.7rem; position: relative; z-index: 10; pointer-events: auto; cursor: text; -webkit-user-select: text; -moz-user-select: text; user-select: text; border: 1px solid #ccc; border-radius: 4px;" 
                               step="0.01" min="0" placeholder="0">
                    </td>
                    <td style="padding: 6px 4px; text-align: center; border: 1px solid #ddd;">
                        <button class="btn btn-success" onclick="showPercentageSendOptions('${agentName}')" style="padding: 4px 8px; font-size: 0.7rem; margin-left: 3px;">ÿ•ÿ±ÿ≥ÿßŸÑ</button>
                        <button class="btn btn-info" onclick="downloadPercentagePDF('${agentName}')" style="padding: 4px 8px; font-size: 0.7rem; margin-left: 3px; background-color: #dc3545; border-color: #dc3545;">PDF</button>
                        <button class="btn btn-danger" onclick="deletePercentage('${agentName}')" style="padding: 4px 8px; font-size: 0.7rem;">ÿ≠ÿ∞ŸÅ</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            const totalRow = document.createElement('tr');
            totalRow.style.borderTop = '3px solid #801c32';
            totalRow.style.background = '#f8f9fa';
            totalRow.style.fontWeight = 'bold';
            const totalActivationsSum = totalCountB + totalCountS + totalCountG + totalCountP;
            const totalAgentPercentageSum = Math.round(totalIQBPercent) + Math.round(totalIQSPercent) + Math.round(totalIQGPercent) + Math.round(totalIQPPercent);
            
            let totalDeductions = 0;
            let totalPenalties = 0;
            if (Array.isArray(agents) && agentPercentages) {
                agents.forEach(agentName => {
                    const data = agentPercentages[agentName] || {};
                    totalDeductions += data.deductions || 0;
                    totalPenalties += data.penalties || 0;
                });
            }
            const netTotalAgentPercentage = totalAgentPercentageSum - totalDeductions - totalPenalties;
            
            totalRow.innerHTML = `
                <td style="padding: 8px 6px; text-align: center; border: 1px solid #ddd; font-weight: bold; font-size: 0.8rem;">ÿßŸÑŸÖÿ¨ŸÖŸàÿπ</td>
                <td style="padding: 8px 6px; text-align: center; border: 1px solid #ddd; direction: ltr; font-weight: bold; font-size: 0.75rem;">${totalCountB}</td>
                <td style="padding: 8px 6px; text-align: center; border: 1px solid #ddd; direction: ltr; font-weight: bold; font-size: 0.75rem;">${totalCountS}</td>
                <td style="padding: 8px 6px; text-align: center; border: 1px solid #ddd; direction: ltr; font-weight: bold; font-size: 0.75rem;">${totalCountG}</td>
                <td style="padding: 8px 6px; text-align: center; border: 1px solid #ddd; direction: ltr; font-weight: bold; font-size: 0.75rem;">${totalCountP}</td>
                <td style="padding: 8px 6px; text-align: center; border: 1px solid #ddd; direction: ltr; font-weight: bold; font-size: 0.75rem;">${totalActivationsSum}</td>
                <td style="padding: 8px 6px; text-align: center; border: 1px solid #ddd; direction: ltr; font-weight: bold; font-size: 0.75rem;">${formatNumber(totalIQB)}</td>
                <td style="padding: 8px 6px; text-align: center; border: 1px solid #ddd; direction: ltr; font-weight: bold; font-size: 0.75rem;">${formatNumber(totalIQS)}</td>
                <td style="padding: 8px 6px; text-align: center; border: 1px solid #ddd; direction: ltr; font-weight: bold; font-size: 0.75rem;">${formatNumber(totalIQG)}</td>
                <td style="padding: 8px 6px; text-align: center; border: 1px solid #ddd; direction: ltr; font-weight: bold; font-size: 0.75rem;">${formatNumber(totalIQP)}</td>
                <td style="padding: 8px 6px; text-align: center; border: 1px solid #ddd; direction: ltr; font-weight: bold; font-size: 0.75rem;">${formatNumber(totalIQT)}</td>
                <td style="padding: 8px 6px; text-align: center; border: 1px solid #ddd; direction: ltr; font-weight: bold; color: #2C5F8D; font-size: 0.75rem;">${formatNumber(Math.round(totalIQBPercent))}</td>
                <td style="padding: 8px 6px; text-align: center; border: 1px solid #ddd; direction: ltr; font-weight: bold; color: #2C5F8D; font-size: 0.75rem;">${formatNumber(Math.round(totalIQSPercent))}</td>
                <td style="padding: 8px 6px; text-align: center; border: 1px solid #ddd; direction: ltr; font-weight: bold; color: #2C5F8D; font-size: 0.75rem;">${formatNumber(Math.round(totalIQGPercent))}</td>
                <td style="padding: 8px 6px; text-align: center; border: 1px solid #ddd; direction: ltr; font-weight: bold; color: #2C5F8D; font-size: 0.75rem;">${formatNumber(Math.round(totalIQPPercent))}</td>
                <td style="padding: 8px 6px; text-align: center; border: 1px solid #ddd; direction: ltr; font-weight: bold; color: #801c32; font-size: 0.9rem;">${formatNumber(netTotalAgentPercentage)}</td>
                <td style="padding: 8px 6px; text-align: center; border: 1px solid #ddd; direction: ltr; font-weight: bold; font-size: 0.75rem;">${formatNumber(totalDeductions)}</td>
                <td style="padding: 8px 6px; text-align: center; border: 1px solid #ddd; direction: ltr; font-weight: bold; font-size: 0.75rem;">${formatNumber(totalPenalties)}</td>
                <td style="padding: 8px 6px; text-align: center; border: 1px solid #ddd;"></td>
            `;
            tbody.appendChild(totalRow);
            const percentageResults = document.getElementById('percentageResults');
            if (percentageResults) {
                percentageResults.classList.remove('hidden');
            }
            setupPercentageTableEventListeners();
                        if (savedFocus) {
                setTimeout(() => {
                            const inputId = savedFocus.fieldType === 'deduction' 
                                ? `deduction_${savedFocus.agentName.replace(/[^a-zA-Z0-9]/g, '_')}`
                                : `penalty_${savedFocus.agentName.replace(/[^a-zA-Z0-9]/g, '_')}`;
                            const input = document.getElementById(inputId);
                            if (input) {
                                    try {
                                        input.value = savedFocus.value;
                            input.focus();
                                        if (input.setSelectionRange) {
                                            input.setSelectionRange(input.value.length, input.value.length);
                                        }
                                    } catch (err) {
                                    }
                            }
                }, 100);
                        }
                isRenderingTable = false;
        }
        async function exportPercentageToExcel() {
            if (!agentPercentages || Object.keys(agentPercentages).length === 0) {
                alert('ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™ ŸÑŸÑÿ™ÿµÿØŸäÿ±. Ÿäÿ±ÿ¨Ÿâ ÿ™ÿ≠ŸÑŸäŸÑ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸàŸÉŸÑÿßÿ° ÿ£ŸàŸÑÿßŸã.');
                return;
            }
            try {
                const workbook = new ExcelJS.Workbook();
                const worksheet = workbook.addWorksheet('ŸÜÿ≥ÿ®ÿ© ÿßŸÑŸàŸÉŸÑÿßÿ°');
                let totalIQT = 0, totalIQP = 0, totalIQG = 0, totalIQS = 0, totalIQB = 0;
                let totalIQPPercent = 0, totalIQGPercent = 0, totalIQSPercent = 0, totalIQBPercent = 0;
                let totalCountP = 0, totalCountG = 0, totalCountS = 0, totalCountB = 0;
                
                const headerRow1 = worksheet.addRow([
                    'ÿßÿ≥ŸÖ ÿßŸÑŸàŸÉŸäŸÑ',
                    'B',
                    'S',
                    'G',
                    'P',
                    'ŸÖÿ¨ŸÖŸàÿπ ÿßŸÑÿ™ŸÅÿπŸäŸÑÿßÿ™',
                    '', '', '', '', '',
                    '', '', '', '',
                    'ŸÜÿ≥ÿ®ÿ© ÿßŸÑŸàŸÉŸäŸÑ %16',
                    'ÿßÿ≥ÿ™ŸÇÿ∑ÿßÿπÿßÿ™',
                    'ÿ∫ÿ±ÿßŸÖÿßÿ™'
                ]);
                
                const headerRow2 = worksheet.addRow([
                    '',
                    '',
                    '',
                    '',
                    '',
                    '',
                    'IQ.B', 'IQ.S', 'IQ.G', 'IQ.P', 'IQ.T',
                    'IQ.B%16', 'IQ.S%16', 'IQ.G%16', 'IQ.P%16',
                    '',
                    '',
                    ''
                ]);
                [headerRow1, headerRow2].forEach((row, rowIndex) => {
                    row.height = 25;
                    row.eachCell((cell, colNumber) => {
                        let bgColor = 'FF801C32';
                        let textColor = 'FFFFFFFF';
                        
                        if (rowIndex === 0) {
                            if (colNumber === 1) {
                                bgColor = 'FF801C32';
                                textColor = 'FFFFFFFF';
                            } else if (colNumber >= 2 && colNumber <= 5) {
                                bgColor = 'FFFFFFFF';
                                textColor = 'FF000000';
                            } else if (colNumber === 6) {
                                bgColor = 'FFFFFFFF';
                                textColor = 'FF000000';
                            } else if (colNumber >= 7 && colNumber <= 11) {
                                bgColor = 'FF801C32';
                                textColor = 'FFFFFFFF';
                            } else if (colNumber >= 12 && colNumber <= 15) {
                                bgColor = 'FF801C32';
                                textColor = 'FFFFFFFF';
                            } else if (colNumber >= 16 && colNumber <= 18) {
                                bgColor = 'FF801C32';
                                textColor = 'FFFFFFFF';
                            }
                        } else {
                            if (colNumber >= 7 && colNumber <= 11) {
                                bgColor = 'FF801C32';
                                textColor = 'FFFFFFFF';
                            } else if (colNumber >= 12 && colNumber <= 15) {
                                bgColor = 'FF801C32';
                                textColor = 'FFFFFFFF';
                            }
                        }
                        
                        cell.fill = {
                            type: 'pattern',
                            pattern: 'solid',
                            fgColor: { argb: bgColor }
                        };
                        cell.font = {
                            bold: true,
                            size: 12,
                            color: { argb: textColor }
                        };
                        cell.alignment = {
                            horizontal: 'center',
                            vertical: 'middle',
                            wrapText: true
                        };
                        cell.border = {
                            top: { style: 'medium', color: { argb: 'FF000000' } },
                            bottom: { style: 'medium', color: { argb: 'FF000000' } },
                            left: { style: 'medium', color: { argb: 'FF000000' } },
                            right: { style: 'medium', color: { argb: 'FF000000' } }
                        };
                    });
                });
                
                worksheet.mergeCells('G1:K1');
                worksheet.mergeCells('L1:O1');
                worksheet.mergeCells('P1:P2');
                worksheet.mergeCells('Q1:Q2');
                worksheet.mergeCells('R1:R2');
                const agents = Object.keys(agentPercentages).sort();
                agents.forEach(agentName => {
                    const data = agentPercentages[agentName];
                    const agent = agentsList.find(a => a.name === agentName);
                    const agentSubName = agent?.subName || '';
                    const agentDisplayName = agentSubName ? `${agentName}\n${agentSubName}` : agentName;
                    const percentage = data.percentage || 15;
                    const rate = percentage / 100;
                    const iqPPercent = data.iqPPercent !== undefined ? data.iqPPercent : ((data.iqP || 0) * rate);
                    const iqGPercent = data.iqGPercent !== undefined ? data.iqGPercent : ((data.iqG || 0) * rate);
                    const iqSPercent = data.iqSPercent !== undefined ? data.iqSPercent : ((data.iqS || 0) * rate);
                    const iqBPercent = data.iqBPercent !== undefined ? data.iqBPercent : ((data.iqB || 0) * rate);
                    const totalActivations = (data.countB || 0) + (data.countS || 0) + (data.countG || 0) + (data.countP || 0);
                    const totalAgentPercentageAmount = Math.round(iqBPercent) + Math.round(iqSPercent) + Math.round(iqGPercent) + Math.round(iqPPercent);
                    const netAgentPercentage = totalAgentPercentageAmount - (data.deductions || 0) - (data.penalties || 0);
                    
                    const row = worksheet.addRow([
                        agentDisplayName,
                        data.countB || 0,
                        data.countS || 0,
                        data.countG || 0,
                        data.countP || 0,
                        totalActivations,
                        data.iqB || 0,
                        data.iqS || 0,
                        data.iqG || 0,
                        data.iqP || 0,
                        data.iqT || 0,
                        Math.round(iqBPercent),
                        Math.round(iqSPercent),
                        Math.round(iqGPercent),
                        Math.round(iqPPercent),
                        netAgentPercentage,
                        data.deductions || 0,
                        data.penalties || 0
                    ]);
                    row.height = 20;
                    const isEvenRow = row.number % 2 === 0;
                    const bgColor = isEvenRow ? 'FFF8F9FA' : 'FFFFFFFF';
                    row.eachCell((cell, colNumber) => {
                        if (colNumber >= 2 && typeof cell.value === 'number') {
                            cell.numFmt = '#,##0';
                        }
                        
                        let fontColor = 'FF000000';
                        let fontSize = 11;
                        let isBold = false;
                        let cellBgColor = bgColor;
                        
                        if (colNumber === 1) {
                            cellBgColor = 'FF801C32';
                            fontColor = 'FFFFFFFF';
                            isBold = true;
                            cell.alignment = {
                                horizontal: 'center',
                                vertical: 'middle',
                                wrapText: true
                            };
                        } else if (colNumber >= 12 && colNumber <= 15) {
                            fontColor = 'FF2C5F8D';
                            isBold = true;
                        } else if (colNumber === 16) {
                            fontColor = 'FF801C32';
                            fontSize = 12;
                            isBold = true;
                        }
                        cell.fill = {
                            type: 'pattern',
                            pattern: 'solid',
                            fgColor: { argb: cellBgColor }
                        };
                        cell.font = {
                            size: fontSize,
                            color: { argb: fontColor },
                            bold: isBold
                        };
                        cell.alignment = {
                            horizontal: 'center',
                            vertical: 'middle'
                        };
                        cell.border = {
                            top: { style: 'thin', color: { argb: 'FFDDDDDD' } },
                            bottom: { style: 'thin', color: { argb: 'FFDDDDDD' } },
                            left: { style: 'thin', color: { argb: 'FFDDDDDD' } },
                            right: { style: 'thin', color: { argb: 'FFDDDDDD' } }
                        };
                    });
                    totalIQT += data.iqT || 0;
                    totalIQP += data.iqP || 0;
                    totalIQG += data.iqG || 0;
                    totalIQS += data.iqS || 0;
                    totalIQB += data.iqB || 0;
                    totalIQPPercent += iqPPercent;
                    totalIQGPercent += iqGPercent;
                    totalIQSPercent += iqSPercent;
                    totalIQBPercent += iqBPercent;
                    totalCountP += data.countP || 0;
                    totalCountG += data.countG || 0;
                    totalCountS += data.countS || 0;
                    totalCountB += data.countB || 0;
                });
                
                const totalActivationsSum = totalCountB + totalCountS + totalCountG + totalCountP;
                const totalAgentPercentageSum = Math.round(totalIQBPercent) + Math.round(totalIQSPercent) + Math.round(totalIQGPercent) + Math.round(totalIQPPercent);
                
                let totalDeductions = 0;
                let totalPenalties = 0;
                agents.forEach(agentName => {
                    const data = agentPercentages[agentName];
                    totalDeductions += data.deductions || 0;
                    totalPenalties += data.penalties || 0;
                });
                const netTotalAgentPercentage = totalAgentPercentageSum - totalDeductions - totalPenalties;
                
                const totalRow = worksheet.addRow([
                    'ÿßŸÑŸÖÿ¨ŸÖŸàÿπ',
                    totalCountB,
                    totalCountS,
                    totalCountG,
                    totalCountP,
                    totalActivationsSum,
                    totalIQB,
                    totalIQS,
                    totalIQG,
                    totalIQP,
                    totalIQT,
                    Math.round(totalIQBPercent),
                    Math.round(totalIQSPercent),
                    Math.round(totalIQGPercent),
                    Math.round(totalIQPPercent),
                    netTotalAgentPercentage,
                    totalDeductions,
                    totalPenalties
                ]);
                totalRow.height = 25;
                totalRow.eachCell((cell, colNumber) => {
                    if (colNumber >= 2 && typeof cell.value === 'number') {
                        cell.numFmt = '#,##0';
                    }
                    let fontColor = 'FF000000';
                    let fontSize = 12;
                    cell.fill = {
                        type: 'pattern',
                        pattern: 'solid',
                        fgColor: { argb: 'FFF8F9FA' }
                    };
                    cell.font = {
                        bold: true,
                        size: fontSize,
                        color: { argb: fontColor }
                    };
                    cell.alignment = {
                        horizontal: 'center',
                        vertical: 'middle'
                    };
                    cell.border = {
                        top: { style: 'thick', color: { argb: 'FF801C32' } },
                        bottom: { style: 'medium', color: { argb: 'FF000000' } },
                        left: { style: 'thin', color: { argb: 'FFDDDDDD' } },
                        right: { style: 'thin', color: { argb: 'FFDDDDDD' } }
                    };
                });
                worksheet.columns = [
                    { width: 25 },
                    { width: 10 },
                    { width: 10 },
                    { width: 10 },
                    { width: 10 },
                    { width: 15 },
                    { width: 15 },
                    { width: 15 },
                    { width: 15 },
                    { width: 15 },
                    { width: 15 },
                    { width: 15 },
                    { width: 15 },
                    { width: 15 },
                    { width: 15 },
                    { width: 18 },
                    { width: 12 },
                    { width: 12 }
                ];
                const now = new Date();
                const dateStr = `${now.getDate()}_${now.getMonth() + 1}_${now.getFullYear()}`;
                const filename = `ŸÜÿ≥ÿ®ÿ©_ÿßŸÑŸàŸÉŸÑÿßÿ°_${dateStr}.xlsx`;
                const buffer = await workbook.xlsx.writeBuffer();
                const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                ""
                const url = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = filename;
                link.click();
                window.URL.revokeObjectURL(url);
                showSuccessMessage(`ÿ™ŸÖ ÿ™ÿµÿØŸäÿ± ÿ®ŸäÿßŸÜÿßÿ™ ${agents.length} ŸàŸÉŸäŸÑ ÿ•ŸÑŸâ ŸÖŸÑŸÅ Excel ÿ®ŸÜÿ¨ÿßÿ≠!`);
                logActivity('ÿ™ÿµÿØŸäÿ± ŸÜÿ≥ÿ®ÿ© ÿßŸÑŸàŸÉŸÑÿßÿ°', `ÿ™ŸÖ ÿ™ÿµÿØŸäÿ± ÿ®ŸäÿßŸÜÿßÿ™ ${agents.length} ŸàŸÉŸäŸÑ ÿ•ŸÑŸâ Excel`);
            } catch (error) {
                console.error('Error exporting to Excel:', error);
                alert('ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿßŸÑÿ™ÿµÿØŸäÿ±: ' + error.message);
            }
        }
        function updateDeduction(agentName, value, skipRender = false) {
            if (!agentPercentages[agentName]) return;
            const deduction = parseFloat(value) || 0;
            agentPercentages[agentName].deductions = deduction;
            
            const data = agentPercentages[agentName];
            const percentage = data.percentage || 15;
            const rate = percentage / 100;
            const iqPPercent = data.iqPPercent !== undefined ? data.iqPPercent : ((data.iqP || 0) * rate);
            const iqGPercent = data.iqGPercent !== undefined ? data.iqGPercent : ((data.iqG || 0) * rate);
            const iqSPercent = data.iqSPercent !== undefined ? data.iqSPercent : ((data.iqS || 0) * rate);
            const iqBPercent = data.iqBPercent !== undefined ? data.iqBPercent : ((data.iqB || 0) * rate);
            const agentPercentageAmount = data.agentPercentageAmount || (Math.round(iqBPercent) + Math.round(iqSPercent) + Math.round(iqGPercent) + Math.round(iqPPercent));
            
            if (!data.agentPercentageAmount) {
                agentPercentages[agentName].agentPercentageAmount = agentPercentageAmount;
            }
            
            agentPercentages[agentName].netPercentage = agentPercentageAmount - 
                deduction - (agentPercentages[agentName].penalties || 0);
            localStorage.setItem('agentPercentages', JSON.stringify(agentPercentages));
            if (supabaseClient && !skipRender) {
                const savedMonthYear = localStorage.getItem('agentPercentages_monthYear') || getCurrentMonthYear();
                saveToDatabase('agent_percentages', agentPercentages, { monthYear: savedMonthYear })
                    .then(saved => {
                        if (saved) {
                        }
                    })
                    .catch(err => console.error('Error saving deduction to database:', err));
            }
            if (!skipRender) {
                lastPercentageDataHash = '';
                loadPercentageData();
                logActivity('ÿ™ÿ≠ÿØŸäÿ´ ÿßÿ≥ÿ™ŸÇÿ∑ÿßÿπ', `ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿßÿ≥ÿ™ŸÇÿ∑ÿßÿπ ŸÑŸÑŸàŸÉŸäŸÑ ${agentName}: ${formatNumber(deduction)}`);
            }
        }
        function updatePenalty(agentName, value, skipRender = false) {
            if (!agentPercentages[agentName]) return;
            const penalty = parseFloat(value) || 0;
            agentPercentages[agentName].penalties = penalty;
            
            const data = agentPercentages[agentName];
            const percentage = data.percentage || 15;
            const rate = percentage / 100;
            const iqPPercent = data.iqPPercent !== undefined ? data.iqPPercent : ((data.iqP || 0) * rate);
            const iqGPercent = data.iqGPercent !== undefined ? data.iqGPercent : ((data.iqG || 0) * rate);
            const iqSPercent = data.iqSPercent !== undefined ? data.iqSPercent : ((data.iqS || 0) * rate);
            const iqBPercent = data.iqBPercent !== undefined ? data.iqBPercent : ((data.iqB || 0) * rate);
            const agentPercentageAmount = data.agentPercentageAmount || (Math.round(iqBPercent) + Math.round(iqSPercent) + Math.round(iqGPercent) + Math.round(iqPPercent));
            
            if (!data.agentPercentageAmount) {
                agentPercentages[agentName].agentPercentageAmount = agentPercentageAmount;
            }
            
            agentPercentages[agentName].netPercentage = agentPercentageAmount - 
                (agentPercentages[agentName].deductions || 0) - penalty;
            localStorage.setItem('agentPercentages', JSON.stringify(agentPercentages));
            if (supabaseClient && !skipRender) {
                const savedMonthYear = localStorage.getItem('agentPercentages_monthYear') || getCurrentMonthYear();
                saveToDatabase('agent_percentages', agentPercentages, { monthYear: savedMonthYear })
                    .then(saved => {
                        if (saved) {
                        }
                    })
                    .catch(err => console.error('Error saving penalty to database:', err));
            }
            if (!skipRender) {
                lastPercentageDataHash = '';
                loadPercentageData();
                logActivity('ÿ™ÿ≠ÿØŸäÿ´ ÿ∫ÿ±ÿßŸÖÿ©', `ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ∫ÿ±ÿßŸÖÿ© ŸÑŸÑŸàŸÉŸäŸÑ ${agentName}: ${formatNumber(penalty)}`);
            }
        }
        async function deletePercentage(agentName) {
            if (confirm(`ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ≠ÿ∞ŸÅ ÿ®ŸäÿßŸÜÿßÿ™ ŸÜÿ≥ÿ®ÿ© ÿßŸÑŸàŸÉŸäŸÑ "${agentName}"ÿü`)) {
                delete agentPercentages[agentName];
                localStorage.setItem('agentPercentages', JSON.stringify(agentPercentages));
                lastPercentageDataHash = '';
                if (supabaseClient) {
                    try {
                        const savedMonthYear = localStorage.getItem('agentPercentages_monthYear') || getCurrentMonthYear();
                        const saved = await saveToDatabase('agent_percentages', agentPercentages, { monthYear: savedMonthYear });
                        if (saved) {
                        }
                    } catch (error) {
                        console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿ∫ŸäŸäÿ±ÿßÿ™ ŸÅŸä ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™:', error);
                    }
                }
                renderPercentageTable();
                logActivity('ÿ≠ÿ∞ŸÅ ŸÜÿ≥ÿ®ÿ© ŸàŸÉŸäŸÑ', `ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿ®ŸäÿßŸÜÿßÿ™ ŸÜÿ≥ÿ®ÿ© ÿßŸÑŸàŸÉŸäŸÑ: ${agentName}`);
            }
        }
        async function updateAgentPhone(agentName, phone) {
            if (!agentPercentages[agentName]) return;
            agentPercentages[agentName].phone = phone || '';
            const agent = agentsList.find(a => a.name === agentName);
            if (agent) {
                agent.phone = phone || '';
                localStorage.setItem('agentsList', JSON.stringify(agentsList));
                try {
                    const saved = await saveAgentsToDatabase();
                    if (saved) {
                    } else {
                    }
                } catch (err) {
                    console.error('Error saving agent phone to database:', err);
                }
            }
            localStorage.setItem('agentPercentages', JSON.stringify(agentPercentages));
            logActivity('ÿ™ÿ≠ÿØŸäÿ´ ÿ±ŸÇŸÖ Ÿáÿßÿ™ŸÅ ŸàŸÉŸäŸÑ', `ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿ±ŸÇŸÖ ÿßŸÑŸáÿßÿ™ŸÅ ŸÑŸÑŸàŸÉŸäŸÑ ${agentName}: ${phone}`);
            showSuccessMessage(`ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿ±ŸÇŸÖ ÿßŸÑŸáÿßÿ™ŸÅ ŸÑŸÑŸàŸÉŸäŸÑ: ${agentName}`);
        }
        function showPercentageSendOptions(agentName) {
            if (!agentName) {
                alert('ÿÆÿ∑ÿ£: ŸÑŸÖ Ÿäÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿØ ÿßÿ≥ŸÖ ÿßŸÑŸàŸÉŸäŸÑ');
                return;
            }
            const modal = document.getElementById('percentageSendOptionsModal');
            const agentNameSpan = document.getElementById('percentageSendAgentName');
            if (!modal || !agentNameSpan) {
                alert('ÿÆÿ∑ÿ£: ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ÿπŸÜÿßÿµÿ± ÿßŸÑŸÜÿßŸÅÿ∞ÿ©');
                return;
            }
            let agent = agentsList.find(a => a.name === agentName);
            if (!agent) {
                const percentageData = agentPercentages[agentName];
                if (percentageData && (percentageData.phone || percentageData.email)) {
                    agent = {
                        name: agentName,
                        phone: percentageData.phone || '',
                        email: percentageData.email || ''
                    };
                } else {
                    alert('ÿßŸÑŸàŸÉŸäŸÑ ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ ŸÅŸä ÿßŸÑŸÇÿßÿ¶ŸÖÿ©. Ÿäÿ±ÿ¨Ÿâ ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸàŸÉŸäŸÑ ŸÅŸä ÿ™ÿ®ŸàŸäÿ® "ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸàŸÉŸÑÿßÿ°" Ÿàÿ•ÿ∂ÿßŸÅÿ© ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿßÿ™ÿµÿßŸÑ.');
                    return;
                }
            }
            const phone = agentPercentages[agentName]?.phone || agent?.phone;
            const email = agentPercentages[agentName]?.email || agent?.email;
            if (!phone && !email) {
                alert('ŸÑŸÖ Ÿäÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿØ ÿ±ŸÇŸÖ Ÿáÿßÿ™ŸÅ ÿ£Ÿà ÿ®ÿ±ŸäÿØ ÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä ŸÑŸÑŸàŸÉŸäŸÑ. Ÿäÿ±ÿ¨Ÿâ ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿßÿ™ÿµÿßŸÑ ŸÅŸä ÿ™ÿ®ŸàŸäÿ® "ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸàŸÉŸÑÿßÿ°"');
                return;
            }
            agentNameSpan.textContent = agentName;
            modal.setAttribute('data-agent-name', agentName);
            modal.classList.add('show');
        }
        function closePercentageSendOptions() {
            const modal = document.getElementById('percentageSendOptionsModal');
            if (modal) {
                modal.classList.remove('show');
            }
        }
        function sendPercentageReportViaWhatsApp() {
            const modal = document.getElementById('percentageSendOptionsModal');
            if (!modal) {
                alert('ÿÆÿ∑ÿ£: ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ŸÜÿßŸÅÿ∞ÿ© ÿßŸÑÿ•ÿ±ÿ≥ÿßŸÑ');
                return;
            }
            const agentName = modal.getAttribute('data-agent-name');
            if (!agentName) {
                alert('ÿÆÿ∑ÿ£: ŸÑŸÖ Ÿäÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿØ ÿßÿ≥ŸÖ ÿßŸÑŸàŸÉŸäŸÑ');
                return;
            }
            closePercentageSendOptions();
            sendPercentageReport(agentName, 'Ÿàÿßÿ™ÿ≥ÿßÿ®');
        }
        function sendPercentageReportViaEmail() {
            const modal = document.getElementById('percentageSendOptionsModal');
            if (!modal) {
                alert('ÿÆÿ∑ÿ£: ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ŸÜÿßŸÅÿ∞ÿ© ÿßŸÑÿ•ÿ±ÿ≥ÿßŸÑ');
                return;
            }
            const agentName = modal.getAttribute('data-agent-name');
            if (!agentName) {
                alert('ÿÆÿ∑ÿ£: ŸÑŸÖ Ÿäÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿØ ÿßÿ≥ŸÖ ÿßŸÑŸàŸÉŸäŸÑ');
                return;
            }
            closePercentageSendOptions();
            sendPercentageReport(agentName, 'email');
        }
        function sendPercentageReport(agentName, method = 'Ÿàÿßÿ™ÿ≥ÿßÿ®') {
            let agent = agentsList.find(a => a.name === agentName);
            if (!agent) {
                const percentageData = agentPercentages[agentName];
                if (percentageData && (percentageData.phone || percentageData.email)) {
                    agent = {
                        name: agentName,
                        phone: percentageData.phone || '',
                        email: percentageData.email || ''
                    };
                } else {
                    alert('ÿßŸÑŸàŸÉŸäŸÑ ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ ŸÅŸä ÿßŸÑŸÇÿßÿ¶ŸÖÿ©. Ÿäÿ±ÿ¨Ÿâ ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸàŸÉŸäŸÑ ŸÅŸä ÿ™ÿ®ŸàŸäÿ® "ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸàŸÉŸÑÿßÿ°" Ÿàÿ•ÿ∂ÿßŸÅÿ© ÿ±ŸÇŸÖ ÿßŸÑŸáÿßÿ™ŸÅ.');
                    return;
                }
            }
            if (agent && agentPercentages[agentName]) {
                if (agent.phone) {
                    agentPercentages[agentName].phone = agent.phone;
                }
                if (agent.email) {
                    agentPercentages[agentName].email = agent.email;
                }
                localStorage.setItem('agentPercentages', JSON.stringify(agentPercentages));
            }
            const phone = agentPercentages[agentName]?.phone || agent?.phone;
            const email = agentPercentages[agentName]?.email || agent?.email;
            const data = agentPercentages[agentName];
            if (!data) {
                alert('ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™ ŸÑŸÑŸàŸÉŸäŸÑ');
                return;
            }
            if (method === 'Ÿàÿßÿ™ÿ≥ÿßÿ®' && !phone) {
                alert('ŸÑŸÖ Ÿäÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿØ ÿ±ŸÇŸÖ Ÿáÿßÿ™ŸÅ ŸÑŸÑŸàŸÉŸäŸÑ. Ÿäÿ±ÿ¨Ÿâ ÿ•ÿ∂ÿßŸÅÿ© ÿ±ŸÇŸÖ ÿßŸÑŸáÿßÿ™ŸÅ ŸÅŸä ÿ™ÿ®ŸàŸäÿ® "ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸàŸÉŸÑÿßÿ°"');
                return;
            }
            if (method === 'email' && !email) {
                alert('ŸÑŸÖ Ÿäÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿØ ÿ®ÿ±ŸäÿØ ÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä ŸÑŸÑŸàŸÉŸäŸÑ. Ÿäÿ±ÿ¨Ÿâ ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä ŸÅŸä ÿ™ÿ®ŸàŸäÿ® "ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸàŸÉŸÑÿßÿ°"');
                return;
            }
            let message = `*${agentName}*\n\n`;
            message += `ÿ™ÿ≠Ÿäÿ© ÿ∑Ÿäÿ®ÿ© \n\n`;
            message += `ŸÜŸàÿØ ÿ•ÿπŸÑÿßŸÖŸÉŸÖ ÿ®ÿßŸÑÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑÿÆÿßÿµ ÿ®ŸÜÿ≥ÿ®ÿ© ÿßŸÑŸàŸÉŸäŸÑÿå ŸàŸÉŸÖÿß ŸäŸÑŸä:\n\n`;
            message += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
            const percentage = data.percentage || 15;
            const rate = percentage / 100;
            const iqPPercent = data.iqPPercent !== undefined ? data.iqPPercent : ((data.iqP || 0) * rate);
            const iqGPercent = data.iqGPercent !== undefined ? data.iqGPercent : ((data.iqG || 0) * rate);
            const iqSPercent = data.iqSPercent !== undefined ? data.iqSPercent : ((data.iqS || 0) * rate);
            const iqBPercent = data.iqBPercent !== undefined ? data.iqBPercent : ((data.iqB || 0) * rate);
            message += `*ÿßŸÑŸÜÿ≥ÿ®ÿ© ÿßŸÑÿµÿßŸÅŸäÿ©: ${formatNumberEnglish(data.netPercentage || 0)} ÿØŸäŸÜÿßÿ± ÿπÿ±ÿßŸÇŸä*\n`;
            if ((data.deductions || 0) > 0) {
                message += `*ÿßŸÑÿßÿ≥ÿ™ŸÇÿ∑ÿßÿπÿßÿ™: ${formatNumberEnglish(data.deductions || 0)} ÿØŸäŸÜÿßÿ± ÿπÿ±ÿßŸÇŸä*\n`;
            }
            if ((data.penalties || 0) > 0) {
                message += `*ÿßŸÑÿ∫ÿ±ÿßŸÖÿßÿ™: ${formatNumberEnglish(data.penalties || 0)} ÿØŸäŸÜÿßÿ± ÿπÿ±ÿßŸÇŸä*\n`;
            }
            message += `\n`;
            message += `\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
            message += `Ÿäÿ±ÿ¨Ÿâ ÿßŸÑÿ™ŸÅÿ∂ŸÑ ÿ®ÿßŸÑÿßÿ∑ŸÑÿßÿπ ÿπŸÑŸâ ÿßŸÑŸÖŸÑŸÅ ÿßŸÑŸÖÿ±ŸÅŸÇ ŸÑŸÑÿßÿ∑ŸÑÿßÿπ ÿπŸÑŸâ ÿßŸÑÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑŸÉÿßŸÖŸÑÿ©.\n\n`;
            message += `ŸÖÿπ ŸÅÿßÿ¶ŸÇ ÿßŸÑÿ¥ŸÉÿ± ŸàÿßŸÑÿ™ŸÇÿØŸäÿ±ÿå\n`;
            message += `*ÿ¥ÿ±ŸÉÿ© ÿπÿ±ÿßŸÇ ÿ≥ŸäŸÑ ŸÑŸÑÿ•ÿ™ÿµÿßŸÑÿßÿ™*`;
            generatePercentageExcelReport(agentName).then((excelBlob) => {
                const filename = `ÿ™ŸÇÿ±Ÿäÿ±_ŸÜÿ≥ÿ®ÿ©_${agentName}_${formatDateForFilename(new Date())}.xlsx`;
                downloadFile(excelBlob, filename);
                if (method === 'Ÿàÿßÿ™ÿ≥ÿßÿ®') {
                    const formattedPhone = formatPhoneForWhatsApp(phone);
                    const whatsappUrl = `https://wa.me/${formattedPhone}?text=${encodeURIComponent(message)}`;
                    window.open(whatsappUrl, '_blank');
                    logActivity('ÿ•ÿ±ÿ≥ÿßŸÑ ÿ™ŸÇÿ±Ÿäÿ± ŸÜÿ≥ÿ®ÿ© ŸàŸÉŸäŸÑ ÿπÿ®ÿ± Ÿàÿßÿ™ÿ≥ÿßÿ®', `ÿ™ŸÖ ÿ•ÿ±ÿ≥ÿßŸÑ ÿ™ŸÇÿ±Ÿäÿ± ŸÜÿ≥ÿ®ÿ© ÿßŸÑŸàŸÉŸäŸÑ: ${agentName}`);
                    showSuccessMessage(`ÿ™ŸÖ ÿ•ÿ±ÿ≥ÿßŸÑ ÿ™ŸÇÿ±Ÿäÿ± ŸÜÿ≥ÿ®ÿ© ÿßŸÑŸàŸÉŸäŸÑ ÿπÿ®ÿ± Ÿàÿßÿ™ÿ≥ÿßÿ®: ${agentName}`);
                } else if (method === 'email') {
                    const subject = encodeURIComponent(`ÿ™ŸÇÿ±Ÿäÿ± ŸÜÿ≥ÿ®ÿ© ÿßŸÑŸàŸÉŸäŸÑ - ${agentName}`);
                    const body = encodeURIComponent(message.replace(/\*/g, ''));
                    const mailtoUrl = `mailto:${email}?subject=${subject}&body=${body}`;
                    window.open(mailtoUrl, '_blank');
                    logActivity('ÿ•ÿ±ÿ≥ÿßŸÑ ÿ™ŸÇÿ±Ÿäÿ± ŸÜÿ≥ÿ®ÿ© ŸàŸÉŸäŸÑ ÿπÿ®ÿ± ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä', `ÿ™ŸÖ ÿ•ÿ±ÿ≥ÿßŸÑ ÿ™ŸÇÿ±Ÿäÿ± ŸÜÿ≥ÿ®ÿ© ÿßŸÑŸàŸÉŸäŸÑ: ${agentName}`);
                    showSuccessMessage(`ÿ™ŸÖ ŸÅÿ™ÿ≠ ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä ŸÑÿ•ÿ±ÿ≥ÿßŸÑ ÿ™ŸÇÿ±Ÿäÿ± ŸÜÿ≥ÿ®ÿ© ÿßŸÑŸàŸÉŸäŸÑ: ${agentName}`);
                }
            }).catch((error) => {
                console.error('Error generating Excel:', error);
                alert('ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿ•ŸÜÿ¥ÿßÿ° ŸÖŸÑŸÅ Excel. Ÿäÿ±ÿ¨Ÿâ ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ© ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ.');
            });
        }
        function generatePercentageExcelReport(agentName) {
            return new Promise(async (resolve, reject) => {
                try {
                    const data = agentPercentages[agentName];
                    if (!data) {
                        reject(new Error('ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™ ŸÑŸÑŸàŸÉŸäŸÑ'));
                        return;
                    }
                    const agent = agentsList.find(a => a.name === agentName);
                    const ExcelJS = window.ExcelJS;
                    if (!ExcelJS) {
                        reject(new Error('ExcelJS ÿ∫Ÿäÿ± ŸÖÿ™ŸàŸÅÿ±'));
                        return;
                    }
                    const workbook = new ExcelJS.Workbook();
                    const worksheet = workbook.addWorksheet('ÿ™ŸÇÿ±Ÿäÿ± ŸÜÿ≥ÿ®ÿ© ÿßŸÑŸàŸÉŸäŸÑ');
                    worksheet.columns = [
                        { width: 30, key: 'type' },
                        { width: 20, key: 'count' },
                        { width: 20, key: 'amount' },
                        { width: 20, key: 'percentage' }
                    ];
                    let currentRow = 1;
                    const titleRow = worksheet.getRow(currentRow);
                    titleRow.getCell(1).value = 'ÿ™ŸÇÿ±Ÿäÿ± ŸÜÿ≥ÿ®ÿ© ÿßŸÑŸàŸÉŸäŸÑ';
                    titleRow.getCell(1).font = { bold: true, size: 18, color: { argb: 'FF801C32' } };
                    titleRow.getCell(1).alignment = { horizontal: 'center', vertical: 'middle' };
                    worksheet.mergeCells(currentRow, 1, currentRow, 4);
                    titleRow.height = 30;
                    currentRow++;
                    currentRow++;
                    worksheet.getRow(currentRow).getCell(1).value = `ÿßÿ≥ŸÖ ÿßŸÑŸàŸÉŸäŸÑ: ${agentName}`;
                    worksheet.getRow(currentRow).getCell(1).font = { bold: true, size: 12 };
                    currentRow++;
                    if (agent?.email) {
                        worksheet.getRow(currentRow).getCell(1).value = `ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä: ${agent.email}`;
                        worksheet.getRow(currentRow).getCell(1).font = { size: 12 };
                        currentRow++;
                    }
                    if (agent?.phone) {
                        worksheet.getRow(currentRow).getCell(1).value = `ÿ±ŸÇŸÖ ÿßŸÑŸáÿßÿ™ŸÅ: ${agent.phone}`;
                        worksheet.getRow(currentRow).getCell(1).font = { size: 12 };
                        currentRow++;
                    }
                    currentRow++;
                    const percentage = data.percentage || 15;
                    const rate = percentage / 100;
                    currentRow++;
                    const sectionRow = worksheet.getRow(currentRow);
                    sectionRow.getCell(1).value = 'ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉÿßÿ™';
                    sectionRow.getCell(1).font = { bold: true, size: 14, color: { argb: 'FF801C32' } };
                    sectionRow.getCell(1).fill = {
                        type: 'pattern',
                        pattern: 'solid',
                        fgColor: { argb: 'FFF8F9FA' }
                    };
                    sectionRow.getCell(1).alignment = { horizontal: 'right', vertical: 'middle' };
                    sectionRow.getCell(1).border = {
                        top: { style: 'thin', color: { argb: 'FF801C32' } },
                        bottom: { style: 'thin', color: { argb: 'FF801C32' } },
                        left: { style: 'thin', color: { argb: 'FF801C32' } },
                        right: { style: 'thin', color: { argb: 'FF801C32' } }
                    };
                    worksheet.mergeCells(currentRow, 1, currentRow, 4);
                    sectionRow.height = 25;
                    currentRow++;
                    const headerRow = worksheet.getRow(currentRow);
                    const headers = ['ŸÜŸàÿπ ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ', 'ÿπÿØÿØ ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉÿßÿ™', 'ÿßŸÑŸÖÿ®ŸÑÿ∫ (ÿØ.ÿπ)', 'ŸÜÿ≥ÿ®ÿ© ÿßŸÑŸàŸÉŸäŸÑ (ÿØ.ÿπ)'];
                    headers.forEach((header, idx) => {
                        const cell = headerRow.getCell(idx + 1);
                        cell.value = header;
                        cell.font = { bold: true, size: 12, color: { argb: 'FFFFFFFF' } };
                        cell.fill = {
                            type: 'pattern',
                            pattern: 'solid',
                            fgColor: { argb: 'FF801C32' }
                        };
                        cell.alignment = { horizontal: 'center', vertical: 'middle', wrapText: true };
                        cell.border = {
                            top: { style: 'thin', color: { argb: 'FFFFFFFF' } },
                            bottom: { style: 'thin', color: { argb: 'FFFFFFFF' } },
                            left: { style: 'thin', color: { argb: 'FFFFFFFF' } },
                            right: { style: 'thin', color: { argb: 'FFFFFFFF' } }
                        };
                    });
                    headerRow.height = 25;
                    currentRow++;
                    const categories = [
                        { key: 'platinum', name: 'Platinum', count: data.countP || 0, amount: data.iqP || 0 },
                        { key: 'gold', name: 'Gold', count: data.countG || 0, amount: data.iqG || 0 },
                        { key: 'silver', name: 'Silver', count: data.countS || 0, amount: data.iqS || 0 },
                        { key: 'bronze', name: 'Bronze', count: data.countB || 0, amount: data.iqB || 0 }
                    ];
                    categories.forEach((cat, index) => {
                        const iqPPercent = cat.key === 'platinum' ? (data.iqPPercent !== undefined ? data.iqPPercent : ((data.iqP || 0) * rate)) :
                                          cat.key === 'gold' ? (data.iqGPercent !== undefined ? data.iqGPercent : ((data.iqG || 0) * rate)) :
                                          cat.key === 'silver' ? (data.iqSPercent !== undefined ? data.iqSPercent : ((data.iqS || 0) * rate)) :
                                          (data.iqBPercent !== undefined ? data.iqBPercent : ((data.iqB || 0) * rate));
                        const dataRow = worksheet.getRow(currentRow);
                        const isEven = index % 2 === 0;
                        const bgColor = isEven ? 'FFFFFFFF' : 'FFF8F9FA';
                        dataRow.getCell(1).value = cat.name;
                        dataRow.getCell(2).value = formatNumberEnglish(cat.count);
                        dataRow.getCell(3).value = formatNumberEnglish(cat.amount);
                        dataRow.getCell(4).value = formatNumberEnglish(Math.round(iqPPercent));
                        for (let col = 1; col <= 4; col++) {
                            const cell = dataRow.getCell(col);
                            cell.font = { size: 12 };
                            cell.fill = {
                                type: 'pattern',
                                pattern: 'solid',
                                fgColor: { argb: bgColor }
                            };
                            cell.alignment = col === 1 ? 
                                { horizontal: 'right', vertical: 'middle' } : 
                                { horizontal: 'center', vertical: 'middle' };
                            cell.border = {
                                top: { style: 'thin', color: { argb: 'FFDDDDDD' } },
                                bottom: { style: 'thin', color: { argb: 'FFDDDDDD' } },
                                left: { style: 'thin', color: { argb: 'FFDDDDDD' } },
                                right: { style: 'thin', color: { argb: 'FFDDDDDD' } }
                            };
                        }
                        dataRow.height = 22;
                        currentRow++;
                    });
                    const totalDataRow = worksheet.getRow(currentRow);
                    const totalCount = (data.countP || 0) + (data.countG || 0) + (data.countS || 0) + (data.countB || 0);
                    const totalAmount = (data.iqP || 0) + (data.iqG || 0) + (data.iqS || 0) + (data.iqB || 0);
                    const totalPercent = Math.round((data.iqPPercent !== undefined ? data.iqPPercent : ((data.iqP || 0) * rate)) +
                                                   (data.iqGPercent !== undefined ? data.iqGPercent : ((data.iqG || 0) * rate)) +
                                                   (data.iqSPercent !== undefined ? data.iqSPercent : ((data.iqS || 0) * rate)) +
                                                   (data.iqBPercent !== undefined ? data.iqBPercent : ((data.iqB || 0) * rate)));
                    totalDataRow.getCell(1).value = 'ÿßŸÑŸÖÿ¨ŸÖŸàÿπ';
                    totalDataRow.getCell(2).value = formatNumberEnglish(totalCount);
                    totalDataRow.getCell(3).value = formatNumberEnglish(totalAmount);
                    totalDataRow.getCell(4).value = formatNumberEnglish(totalPercent);
                    for (let col = 1; col <= 4; col++) {
                        const cell = totalDataRow.getCell(col);
                        cell.font = { bold: true, size: 12 };
                        cell.fill = {
                            type: 'pattern',
                            pattern: 'solid',
                            fgColor: { argb: 'FFE8F0F5' }
                        };
                        cell.alignment = col === 1 ? 
                            { horizontal: 'right', vertical: 'middle' } : 
                            { horizontal: 'center', vertical: 'middle' };
                        cell.border = {
                            top: { style: 'medium', color: { argb: 'FF801C32' } },
                            bottom: { style: 'medium', color: { argb: 'FF801C32' } },
                            left: { style: 'medium', color: { argb: 'FF801C32' } },
                            right: { style: 'medium', color: { argb: 'FF801C32' } }
                        };
                    }
                    totalDataRow.height = 25;
                    currentRow++;
                    currentRow++;
                    const summaryRow = worksheet.getRow(currentRow);
                    summaryRow.getCell(1).value = 'ŸÜÿ≥ÿ®ÿ© ÿßŸÑŸàŸÉŸäŸÑ';
                    summaryRow.getCell(4).value = formatNumberEnglish(data.agentPercentageAmount || 0);
                    summaryRow.getCell(1).font = { bold: true, size: 12 };
                    summaryRow.getCell(4).font = { bold: true, size: 12 };
                    summaryRow.getCell(4).alignment = { horizontal: 'center' };
                    currentRow++;
                    if ((data.deductions || 0) > 0) {
                        const deductionRow = worksheet.getRow(currentRow);
                        deductionRow.getCell(1).value = 'ÿßŸÑÿßÿ≥ÿ™ŸÇÿ∑ÿßÿπÿßÿ™';
                        deductionRow.getCell(4).value = formatNumberEnglish(data.deductions || 0);
                        deductionRow.getCell(1).font = { bold: true, size: 12 };
                        deductionRow.getCell(4).font = { bold: true, size: 12 };
                        deductionRow.getCell(4).alignment = { horizontal: 'center' };
                        currentRow++;
                    }
                    if ((data.penalties || 0) > 0) {
                        const penaltyRow = worksheet.getRow(currentRow);
                        penaltyRow.getCell(1).value = 'ÿßŸÑÿ∫ÿ±ÿßŸÖÿßÿ™';
                        penaltyRow.getCell(4).value = formatNumberEnglish(data.penalties || 0);
                        penaltyRow.getCell(1).font = { bold: true, size: 12 };
                        penaltyRow.getCell(4).font = { bold: true, size: 12 };
                        penaltyRow.getCell(4).alignment = { horizontal: 'center' };
                        currentRow++;
                    }
                    const netRow = worksheet.getRow(currentRow);
                    netRow.getCell(1).value = 'ÿßŸÑŸÜÿ≥ÿ®ÿ© ÿßŸÑÿµÿßŸÅŸäÿ©';
                    netRow.getCell(4).value = formatNumberEnglish(data.netPercentage || 0);
                    netRow.getCell(1).font = { bold: true, size: 14, color: { argb: 'FF801C32' } };
                    netRow.getCell(4).font = { bold: true, size: 14, color: { argb: 'FF801C32' } };
                    netRow.getCell(4).alignment = { horizontal: 'center' };
                    netRow.getCell(1).fill = {
                        type: 'pattern',
                        pattern: 'solid',
                        fgColor: { argb: 'FFE8F0F5' }
                    };
                    netRow.getCell(4).fill = {
                        type: 'pattern',
                        pattern: 'solid',
                        fgColor: { argb: 'FFE8F0F5' }
                    };
                    netRow.getCell(1).border = {
                        top: { style: 'medium', color: { argb: 'FF801C32' } },
                        bottom: { style: 'medium', color: { argb: 'FF801C32' } },
                        left: { style: 'medium', color: { argb: 'FF801C32' } },
                        right: { style: 'thin', color: { argb: 'FF801C32' } }
                    };
                    netRow.getCell(4).border = {
                        top: { style: 'medium', color: { argb: 'FF801C32' } },
                        bottom: { style: 'medium', color: { argb: 'FF801C32' } },
                        left: { style: 'thin', color: { argb: 'FF801C32' } },
                        right: { style: 'medium', color: { argb: 'FF801C32' } }
                    };
                    netRow.height = 30;
                    const buffer = await workbook.xlsx.writeBuffer();
                    const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                    resolve(blob);
                } catch (error) {
                    reject(error);
                }
            });
        }
        function downloadPercentagePDF(agentName) {
            generatePercentagePDFReport(agentName).then((pdfBlob) => {
                const safeName = agentName.replace(/[^a-zA-Z0-9_]/g, '_');
                const filename = `ÿ™ŸÇÿ±Ÿäÿ±_ŸÜÿ≥ÿ®ÿ©_${safeName}_${formatDateForFilename(new Date())}.pdf`;
                downloadFile(pdfBlob, filename);
                logActivity('ÿ™ÿ≠ŸÖŸäŸÑ ÿ™ŸÇÿ±Ÿäÿ± ŸÜÿ≥ÿ®ÿ© PDF', `ÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ ÿ™ŸÇÿ±Ÿäÿ± ŸÜÿ≥ÿ®ÿ© PDF ŸÑŸÑŸàŸÉŸäŸÑ: ${agentName}`);
                showSuccessMessage(`ÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ ÿ™ŸÇÿ±Ÿäÿ± PDF ŸÑŸÑŸàŸÉŸäŸÑ: ${agentName}`);
            }).catch((error) => {
                console.error('Error generating PDF:', error);
                alert('ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿ•ŸÜÿ¥ÿßÿ° ŸÖŸÑŸÅ PDF. Ÿäÿ±ÿ¨Ÿâ ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ© ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ.');
            });
        }
        function generatePercentagePDFReport(agentName) {
            return new Promise(async (resolve, reject) => {
                try {
                    const data = agentPercentages[agentName];
                    if (!data) {
                        reject(new Error('ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™ ŸÑŸÑŸàŸÉŸäŸÑ'));
                        return;
                    }
                    const { jsPDF } = window.jspdf;
                    if (!jsPDF) {
                        reject(new Error('jsPDF ÿ∫Ÿäÿ± ŸÖÿ™ŸàŸÅÿ±'));
                        return;
                    }
                    const doc = new jsPDF('portrait', 'mm', 'a4');
                    const pageWidth = doc.internal.pageSize.getWidth();
                    const pageHeight = doc.internal.pageSize.getHeight();
                    let yPos = 15;
                    doc.setFontSize(18);
                    doc.setTextColor(128, 28, 50);
                    doc.setFont('helvetica', 'bold');
                    const titleText = 'Agent Percentage Report';
                    const titleWidth = doc.getTextWidth(titleText);
                    doc.text(titleText, (pageWidth - titleWidth) / 2, yPos);
                    yPos += 15;
                    const agent = agentsList.find(a => a.name === agentName);
                    doc.setFontSize(12);
                    doc.setTextColor(0, 0, 0);
                    doc.setFont('helvetica', 'bold');
                    doc.text(`Agent Name: ${agentName}`, 20, yPos);
                    yPos += 8;
                    if (agent?.email) {
                        doc.setFont('helvetica', 'normal');
                        doc.setFontSize(12);
                        doc.text(`Email: ${agent.email}`, 20, yPos);
                        yPos += 7;
                    }
                    if (agent?.phone) {
                        doc.text(`Phone Number: ${agent.phone}`, 20, yPos);
                        yPos += 7;
                    }
                    yPos += 5;
                    const percentage = data.percentage || 15;
                    const rate = percentage / 100;
                    const iqPPercent = data.iqPPercent !== undefined ? data.iqPPercent : ((data.iqP || 0) * rate);
                    const iqGPercent = data.iqGPercent !== undefined ? data.iqGPercent : ((data.iqG || 0) * rate);
                    const iqSPercent = data.iqSPercent !== undefined ? data.iqSPercent : ((data.iqS || 0) * rate);
                    const iqBPercent = data.iqBPercent !== undefined ? data.iqBPercent : ((data.iqB || 0) * rate);
                    const tableData = [
                        ['Platinum', formatNumberEnglish(data.countP || 0), formatNumberEnglish(data.iqP || 0), formatNumberEnglish(Math.round(iqPPercent))],
                        ['Gold', formatNumberEnglish(data.countG || 0), formatNumberEnglish(data.iqG || 0), formatNumberEnglish(Math.round(iqGPercent))],
                        ['Silver', formatNumberEnglish(data.countS || 0), formatNumberEnglish(data.iqS || 0), formatNumberEnglish(Math.round(iqSPercent))],
                        ['Bronze', formatNumberEnglish(data.countB || 0), formatNumberEnglish(data.iqB || 0), formatNumberEnglish(Math.round(iqBPercent))],
                    ];
                    const totalCount = (data.countP || 0) + (data.countG || 0) + (data.countS || 0) + (data.countB || 0);
                    const totalAmount = (data.iqP || 0) + (data.iqG || 0) + (data.iqS || 0) + (data.iqB || 0);
                    const totalPercent = Math.round(iqPPercent + iqGPercent + iqSPercent + iqBPercent);
                    tableData.push([
                        'Total',
                        formatNumberEnglish(totalCount),
                        formatNumberEnglish(totalAmount),
                        formatNumberEnglish(totalPercent)
                    ]);
                    doc.autoTable({
                        startY: yPos,
                        head: [['Profile Type', 'Count', 'Amount (IQD)', 'Agent Percentage (IQD)']],
                        body: tableData,
                        theme: 'striped',
                        headStyles: {
                            fillColor: [128, 28, 50],
                            textColor: [255, 255, 255],
                            fontStyle: 'bold',
                            fontSize: 12,
                            halign: 'center'
                        },
                        bodyStyles: {
                            fontSize: 12,
                            halign: 'center'
                        },
                        columnStyles: {
                            0: { halign: 'left' },
                            1: { halign: 'center' },
                            2: { halign: 'center' },
                            3: { halign: 'center' }
                        },
                        didParseCell: function(data) {
                            if (data.row.index === tableData.length - 1) {
                                data.cell.styles.fillColor = [232, 240, 245];
                                data.cell.styles.fontStyle = 'bold';
                                data.cell.styles.fontSize = 12;
                            }
                        },
                        margin: { left: 20, right: 20 }
                    });
                    yPos = doc.lastAutoTable.finalY + 15;
                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'bold');
                    doc.text(`Agent Percentage: ${formatNumberEnglish(data.agentPercentageAmount || 0)} IQD`, 20, yPos);
                    yPos += 10;
                    if ((data.deductions || 0) > 0) {
                        doc.setFont('helvetica', 'normal');
                        doc.text(`Deductions: ${formatNumberEnglish(data.deductions || 0)} IQD`, 20, yPos);
                        yPos += 10;
                    }
                    if ((data.penalties || 0) > 0) {
                        doc.text(`Penalties: ${formatNumberEnglish(data.penalties || 0)} IQD`, 20, yPos);
                        yPos += 10;
                    }
                    doc.setFontSize(14);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(128, 28, 50);
                    doc.text(`Net Percentage: ${formatNumberEnglish(data.netPercentage || 0)} IQD`, 20, yPos);
                    const pdfBlob = doc.output('blob');
                    resolve(pdfBlob);
                } catch (error) {
                    reject(error);
                }
            });
        }
        async function resetPercentageData() {
            if (!confirm('ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ≠ÿ∞ŸÅ ÿ¨ŸÖŸäÿπ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÜÿ≥ÿ®ÿü')) {
                return;
            }
            
            percentageData = null;
            agentPercentages = {};
            localStorage.removeItem('agentPercentages');
            localStorage.removeItem('agentPercentages_monthYear');
            lastPercentageDataHash = '';
            document.getElementById('percentageFileName').classList.add('hidden');
            document.getElementById('percentageResults').classList.add('hidden');
            document.getElementById('percentageFileInput').value = '';
            document.getElementById('selectedAgentForPercentage').value = '';
            document.getElementById('agentFileUploadSection').style.display = 'none';
            
            if (supabaseClient) {
                try {
                    const monthYear = getCurrentMonthYear();
                    const { error: deleteError } = await supabaseClient
                        .from('agent_percentages')
                        .delete()
                        .eq('month_year', monthYear);
                    
                    if (deleteError) {
                        console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ≠ÿ∞ŸÅ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖŸÜ ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™:', deleteError);
                        showSuccessMessage('ÿ™ŸÖ ŸÖÿ≥ÿ≠ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™. ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ÿ≠ÿ∞ŸÅ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖŸÜ ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™');
                    } else {
                        showSuccessMessage('ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿ¨ŸÖŸäÿπ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÜÿ≥ÿ® ÿ®ŸÜÿ¨ÿßÿ≠');
                        logActivity('ŸÖÿ≥ÿ≠ ŸÜÿ≥ÿ®ÿ© ÿßŸÑŸàŸÉŸÑÿßÿ°', 'ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿ®ŸäÿßŸÜÿßÿ™ ŸÜÿ≥ÿ®ÿ© ÿßŸÑŸàŸÉŸÑÿßÿ°');
                    }
                } catch (error) {
                    console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ≠ÿ∞ŸÅ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖŸÜ ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™:', error);
                    showSuccessMessage('ÿ™ŸÖ ŸÖÿ≥ÿ≠ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖŸÜ ÿßŸÑÿ∞ÿßŸÉÿ±ÿ© ÿßŸÑŸÖÿ≠ŸÑŸäÿ©. ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ÿ≠ÿ∞ŸÅ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖŸÜ ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™');
                }
            } else {
                showSuccessMessage('ÿ™ŸÖ ŸÖÿ≥ÿ≠ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ®ŸÜÿ¨ÿßÿ≠');
                logActivity('ŸÖÿ≥ÿ≠ ŸÜÿ≥ÿ®ÿ© ÿßŸÑŸàŸÉŸÑÿßÿ°', 'ÿ™ŸÖ ŸÖÿ≥ÿ≠ ÿ®ŸäÿßŸÜÿßÿ™ ŸÜÿ≥ÿ®ÿ© ÿßŸÑŸàŸÉŸÑÿßÿ°');
            }
            
            renderPercentageTable();
        }
        let lastPercentageDataHash = '';
        let isRenderingTable = false;
        let renderPercentageTableTimeout = null;
        function loadPercentageData() {
            if (isRenderingTable) return;
            if (renderPercentageTableTimeout) {
                clearTimeout(renderPercentageTableTimeout);
            }
            const currentDataHash = JSON.stringify(agentPercentages);
            if (currentDataHash !== lastPercentageDataHash) {
                lastPercentageDataHash = currentDataHash;
                renderPercentageTableTimeout = setTimeout(() => {
                    if (Object.keys(agentPercentages).length > 0 && !isRenderingTable) {
                        renderPercentageTable();
                    }
                    renderPercentageTableTimeout = null;
                }, 1000);
            }
        }
        function setupPercentageTableEventListeners() {
                const tbody = document.getElementById('percentageTableBody');
            if (!tbody) return;
            const oldInputs = tbody.querySelectorAll('input[data-agent-name]');
            oldInputs.forEach(input => {
                const newInput = input.cloneNode(true);
                input.parentNode.replaceChild(newInput, input);
            });
            tbody.addEventListener('input', function(e) {
                const input = e.target;
                if (input && input.tagName === 'INPUT' && input.hasAttribute('data-agent-name') && input.hasAttribute('data-field-type')) {
                    const agentName = input.getAttribute('data-agent-name');
                    const fieldType = input.getAttribute('data-field-type');
                    const value = parseFloat(input.value) || 0;
                    if (fieldType === 'deduction') {
                        updateDeduction(agentName, value, true);
                    } else if (fieldType === 'penalty') {
                        updatePenalty(agentName, value, true);
                    }
                }
            });
            tbody.addEventListener('change', function(e) {
                const input = e.target;
                if (input && input.tagName === 'INPUT' && input.hasAttribute('data-agent-name') && input.hasAttribute('data-field-type')) {
                    const agentName = input.getAttribute('data-agent-name');
                    const fieldType = input.getAttribute('data-field-type');
                    const value = parseFloat(input.value) || 0;
                    if (fieldType === 'deduction') {
                        updateDeduction(agentName, value, false);
                    } else if (fieldType === 'penalty') {
                        updatePenalty(agentName, value, false);
                    }
                }
            });
            tbody.addEventListener('blur', function(e) {
                const input = e.target;
                if (input && input.tagName === 'INPUT' && input.hasAttribute('data-agent-name') && input.hasAttribute('data-field-type')) {
                    const agentName = input.getAttribute('data-agent-name');
                    const fieldType = input.getAttribute('data-field-type');
                    const value = parseFloat(input.value) || 0;
                    if (fieldType === 'deduction') {
                        updateDeduction(agentName, value, false);
                    } else if (fieldType === 'penalty') {
                        updatePenalty(agentName, value, false);
                    }
                }
            }, true);
        }
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.querySelector('.main-content');
            const toggleBtn = document.getElementById('sidebarToggleBtn');
            const toggleBtnExternal = document.getElementById('sidebarToggleBtnExternal');
            if (!sidebar || !mainContent || !toggleBtn) return;
            const isHidden = sidebar.classList.contains('hidden');
            if (isHidden) {
                sidebar.classList.remove('hidden');
                mainContent.classList.remove('sidebar-hidden');
                toggleBtn.textContent = '‚ò∞';
                toggleBtn.title = 'ÿ•ÿÆŸÅÿßÿ° ÿßŸÑŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ¨ÿßŸÜÿ®Ÿäÿ©';
                if (toggleBtnExternal) {
                    toggleBtnExternal.style.display = 'none';
                    toggleBtnExternal.title = 'ÿ•ÿÆŸÅÿßÿ° ÿßŸÑŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ¨ÿßŸÜÿ®Ÿäÿ©';
                }
                localStorage.setItem('sidebarHidden', 'false');
            } else {
                sidebar.classList.add('hidden');
                mainContent.classList.add('sidebar-hidden');
                toggleBtn.textContent = '‚ò∞';
                toggleBtn.title = 'ÿ•ÿ∏Ÿáÿßÿ± ÿßŸÑŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ¨ÿßŸÜÿ®Ÿäÿ©';
                if (toggleBtnExternal) {
                    toggleBtnExternal.style.display = 'flex';
                    toggleBtnExternal.title = 'ÿ•ÿ∏Ÿáÿßÿ± ÿßŸÑŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ¨ÿßŸÜÿ®Ÿäÿ©';
                }
                localStorage.setItem('sidebarHidden', 'true');
            }
        }
        function loadSidebarState() {
            const sidebarHidden = localStorage.getItem('sidebarHidden') === 'true';
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.querySelector('.main-content');
            const toggleBtn = document.getElementById('sidebarToggleBtn');
            const toggleBtnExternal = document.getElementById('sidebarToggleBtnExternal');
            if (sidebar && mainContent && toggleBtn) {
                if (sidebarHidden) {
                    sidebar.classList.add('hidden');
                    mainContent.classList.add('sidebar-hidden');
                    toggleBtn.title = 'ÿ•ÿ∏Ÿáÿßÿ± ÿßŸÑŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ¨ÿßŸÜÿ®Ÿäÿ©';
                    if (toggleBtnExternal) {
                        toggleBtnExternal.style.display = 'flex';
                        toggleBtnExternal.title = 'ÿ•ÿ∏Ÿáÿßÿ± ÿßŸÑŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ¨ÿßŸÜÿ®Ÿäÿ©';
                    }
                } else {
                    sidebar.classList.remove('hidden');
                    mainContent.classList.remove('sidebar-hidden');
                    toggleBtn.title = 'ÿ•ÿÆŸÅÿßÿ° ÿßŸÑŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ¨ÿßŸÜÿ®Ÿäÿ©';
                    if (toggleBtnExternal) {
                        toggleBtnExternal.style.display = 'none';
                        toggleBtnExternal.title = 'ÿ•ÿÆŸÅÿßÿ° ÿßŸÑŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ¨ÿßŸÜÿ®Ÿäÿ©';
                    }
                }
            }
        }
        const saveLocks = new Map();
        const archiveSaveLocks = new Map();
        const displayLocks = new Map();
        
        async function saveToDatabase(tableName, data, options = {}) {
            if (!supabaseClient) {
                return false;
            }
            
            const lockKey = `${tableName}_${options.monthYear || getCurrentMonthYear()}_${options.analysis_type || ''}`;
            
            if (saveLocks.has(lockKey)) {
                const startTime = Date.now();
                let waitCount = 0;
                while (saveLocks.has(lockKey) && (Date.now() - startTime) < 30000) {
                    await new Promise(resolve => setTimeout(resolve, 200));
                    waitCount++;
                    if (waitCount === 10) {
                        console.warn(`‚ö† Save already in progress for ${lockKey}, waiting...`);
                    }
                }
                if (saveLocks.has(lockKey)) {
                    console.warn(`‚ö† Timeout waiting for previous save to complete for ${lockKey}`);
                    return false;
                }
            }
            
            saveLocks.set(lockKey, true);
            
            try {
                let monthYear = options.monthYear || getCurrentMonthYear();
                const { analysis_type } = options;
                let dataString = JSON.stringify(data);
                const originalSize = dataString.length;
                if (originalSize > 5000000) {
                    console.warn(`Data size: ${(originalSize / 1024 / 1024).toFixed(2)}MB, optimizing...`);
                    if (tableName === 'analysis_archives' && data.agentReports) {
                        const optimizedData = {
                            ...data,
                            details: Array.isArray(data.details) ? data.details.map(detail => ({
                                username: detail.username,
                                subscription: detail.subscription,
                                agent: detail.agent,
                                date1: detail.date1,
                                date2: detail.date2,
                                date3: detail.date3,
                                daysDiff: detail.daysDiff,
                                type: detail.type
                            })).slice(0, 10000) : data.details, 
                            data: Array.isArray(data.data) ? data.data.slice(0, 500) : data.data,
                            agentReports: data.agentReports ? Object.keys(data.agentReports).reduce((acc, key) => {
                                const report = data.agentReports[key];
                                if (report && report.advanced) {
                                    acc[key] = {
                                        advanced: {
                                            bronze: report.advanced.bronze,
                                            silver: report.advanced.silver,
                                            gold: report.advanced.gold,
                                            platinum: report.advanced.platinum,
                                            total: report.advanced.total,
                                            agentName: report.advanced.agentName
                                        }
                                    };
                                }
                                return acc;
                            }, {}) : data.agentReports
                        };
                        data = optimizedData;
                        dataString = JSON.stringify(data);
                    }
                }
                dataString = JSON.stringify(data);
                if (dataString.length > 10000000) { 
                    console.warn(`Data still too large after optimization (${(dataString.length / 1024 / 1024).toFixed(2)}MB), applying aggressive reduction...`);
                    if (tableName === 'analysis_archives' && data.details) {
                        const optimizedDetails = Array.isArray(data.details) ? data.details.map(detail => ({
                            username: detail.username,
                            subscription: detail.subscription,
                            agent: detail.agent,
                            date1: detail.date1,
                            date2: detail.date2,
                            date3: detail.date3,
                            daysDiff: detail.daysDiff,
                            type: detail.type,
                            price: detail.price,
                            promoPrice: detail.promoPrice,
                            officialPrice: detail.officialPrice
                        })).slice(0, 5000) : data.details;
                        data = {
                            ...data,
                            details: optimizedDetails,
                            data: Array.isArray(data.data) ? data.data.slice(0, 200) : data.data,
                            agentReports: data.agentReports ? Object.keys(data.agentReports).reduce((acc, key) => {
                                const report = data.agentReports[key];
                                if (report) {
                                    acc[key] = {};
                                    if (report.basic) {
                                        acc[key].basic = {
                                            bronze: report.basic.bronze,
                                            silver: report.basic.silver,
                                            gold: report.basic.gold,
                                            platinum: report.basic.platinum,
                                            total: report.basic.total,
                                            agentName: report.basic.agentName
                                        };
                                    }
                                    if (report.advanced) {
                                        acc[key].advanced = {
                                            bronze: report.advanced.bronze,
                                            silver: report.advanced.silver,
                                            gold: report.advanced.gold,
                                            platinum: report.advanced.platinum,
                                            total: report.advanced.total,
                                            agentName: report.advanced.agentName
                                        };
                                    }
                                    if (report.twoMonths) {
                                        acc[key].twoMonths = {
                                            bronze: report.twoMonths.bronze,
                                            silver: report.twoMonths.silver,
                                            gold: report.twoMonths.gold,
                                            platinum: report.twoMonths.platinum,
                                            total: report.twoMonths.total,
                                            agentName: report.twoMonths.agentName
                                        };
                                    }
                                }
                                return acc;
                            }, {}) : data.agentReports
                        };
                        dataString = JSON.stringify(data);
                    }
                }
                let archiveData = {
                    month_year: monthYear,
                    data: data,
                    created_at: new Date().toISOString(),
                    updated_at: new Date().toISOString()
                };
                if (tableName === 'analysis_archives' && analysis_type) {
                    archiveData.analysis_type = analysis_type;
                }
                let existingArchive;
                const checkPromise = tableName === 'analysis_archives' && analysis_type
                    ? supabaseClient
                        .from(tableName)
                        .select('id, data')
                        .eq('month_year', monthYear)
                        .eq('analysis_type', analysis_type)
                        .maybeSingle()
                    : supabaseClient
                        .from(tableName)
                        .select('id, data')
                        .eq('month_year', monthYear)
                        .maybeSingle();
                const checkTimeout = new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('Check timeout')), 10000)
                );
                try {
                    const { data: existing, error: checkError } = await Promise.race([checkPromise, checkTimeout]);
                    if (!checkError) existingArchive = existing;
                } catch (timeoutError) {
                }
                if (existingArchive) {
                    let mergedData = { ...data };
                    if (tableName === 'analysis_archives' && existingArchive.data) {
                        const newAnalysisType = analysis_type;
                        const newAgentNames = data.agentReports ? Object.keys(data.agentReports) : [];
                        const newAgentName = newAgentNames.length > 0 ? newAgentNames[0] : null;
                        
                        if (existingArchive.data.agentReports && data.agentReports) {
                            mergedData.agentReports = { ...existingArchive.data.agentReports };
                            
                            Object.keys(data.agentReports).forEach(agentName => {
                                const normalizedNewAgent = normalizeAgentName(agentName);
                                const normalizedExistingAgents = Object.keys(mergedData.agentReports).map(a => normalizeAgentName(a));
                                
                                let existingAgentName = null;
                                for (const existingAgent of Object.keys(mergedData.agentReports)) {
                                    if (normalizeAgentName(existingAgent) === normalizedNewAgent) {
                                        existingAgentName = existingAgent;
                                        break;
                                    }
                                }
                                
                                if (existingAgentName) {
                                    if (!mergedData.agentReports[existingAgentName]) {
                                        mergedData.agentReports[existingAgentName] = {};
                                    }
                                    
                                    if (data.agentReports[agentName].basic && newAnalysisType === 'basic') {
                                        mergedData.agentReports[existingAgentName].basic = data.agentReports[agentName].basic;
                                    }
                                    if (data.agentReports[agentName].advanced && newAnalysisType === 'advanced') {
                                        mergedData.agentReports[existingAgentName].advanced = data.agentReports[agentName].advanced;
                                    }
                                    if (data.agentReports[agentName].twoMonths && newAnalysisType === 'two_months') {
                                        mergedData.agentReports[existingAgentName].twoMonths = data.agentReports[agentName].twoMonths;
                                    }
                                } else {
                                    mergedData.agentReports[agentName] = { ...data.agentReports[agentName] };
                                }
                            });
                        } else if (data.agentReports) {
                            mergedData.agentReports = data.agentReports;
                        } else if (existingArchive.data.agentReports) {
                            mergedData.agentReports = existingArchive.data.agentReports;
                        }
                        
                        if (Array.isArray(existingArchive.data.details) && Array.isArray(data.details) && newAgentName) {
                            const normalizedNewAgent = normalizeAgentName(newAgentName);
                            
                            const otherAgentsDetails = existingArchive.data.details.filter(detail => {
                                const detailAgent = detail.agent || detail.Agent || detail.agentName || detail.AgentName || detail['ÿßÿ≥ŸÖ ÿßŸÑŸàŸÉŸäŸÑ'] || detail['ÿßŸÑŸàŸÉŸäŸÑ'] || '';
                                return normalizeAgentName(detailAgent) !== normalizedNewAgent;
                            });
                            
                            const newDetailsMap = new Map();
                            data.details.forEach(detail => {
                                const detailKey = `${detail.username || ''}_${detail.subscription || ''}_${detail.date || detail.dateStr || detail.date1 || detail.date2 || detail.date3 || ''}_${detail.type || ''}`;
                                if (!newDetailsMap.has(detailKey)) {
                                    newDetailsMap.set(detailKey, detail);
                                }
                            });
                            
                            mergedData.details = [...otherAgentsDetails, ...Array.from(newDetailsMap.values())];
                        } else if (Array.isArray(data.details)) {
                            const detailsMap = new Map();
                            data.details.forEach(detail => {
                                const detailKey = `${detail.username || ''}_${detail.subscription || ''}_${detail.date || detail.dateStr || detail.date1 || detail.date2 || detail.date3 || ''}_${detail.type || ''}`;
                                if (!detailsMap.has(detailKey)) {
                                    detailsMap.set(detailKey, detail);
                                }
                            });
                            mergedData.details = Array.from(detailsMap.values());
                        } else if (Array.isArray(existingArchive.data.details)) {
                            mergedData.details = existingArchive.data.details;
                        }
                        
                        if (Array.isArray(existingArchive.data.data) && Array.isArray(data.data) && newAgentName) {
                            const normalizedNewAgent = normalizeAgentName(newAgentName);
                            
                            const otherAgentsData = existingArchive.data.data.filter(item => {
                                const itemAgent = item.agent || item.Agent || item.agentName || item.AgentName || item['ColumnF'] || item[5] || item['ÿßÿ≥ŸÖ ÿßŸÑŸàŸÉŸäŸÑ'] || item['ÿßŸÑŸàŸÉŸäŸÑ'] || '';
                                return normalizeAgentName(itemAgent) !== normalizedNewAgent;
                            });
                            
                            const newDataMap = new Map();
                            data.data.forEach(item => {
                                const itemKey = JSON.stringify(item);
                                if (!newDataMap.has(itemKey)) {
                                    newDataMap.set(itemKey, item);
                                }
                            });
                            
                            mergedData.data = [...otherAgentsData, ...Array.from(newDataMap.values())];
                        } else if (Array.isArray(data.data)) {
                            const dataMap = new Map();
                            data.data.forEach(item => {
                                const itemKey = JSON.stringify(item);
                                if (!dataMap.has(itemKey)) {
                                    dataMap.set(itemKey, item);
                                }
                            });
                            mergedData.data = Array.from(dataMap.values());
                        } else if (Array.isArray(existingArchive.data.data)) {
                            mergedData.data = existingArchive.data.data;
                        }
                        
                        if (data.results) {
                            if (data.results.agentName && newAgentName && normalizeAgentName(data.results.agentName) === normalizeAgentName(newAgentName)) {
                                mergedData.results = data.results;
                            } else if (existingArchive.data.results) {
                                if (existingArchive.data.results.agentName && newAgentName && 
                                    normalizeAgentName(existingArchive.data.results.agentName) === normalizeAgentName(newAgentName)) {
                                    mergedData.results = data.results;
                                } else {
                                    mergedData.results = existingArchive.data.results;
                                }
                            } else {
                                mergedData.results = data.results;
                            }
                        } else if (existingArchive.data.results) {
                            mergedData.results = existingArchive.data.results;
                        }
                    }
                    const updateData = {
                        data: mergedData,
                        updated_at: new Date().toISOString()
                    };
                    let query = supabaseClient
                        .from(tableName)
                        .update(updateData)
                        .eq('id', existingArchive.id);
                    if (tableName === 'analysis_archives' && analysis_type) {
                        query = query.eq('analysis_type', analysis_type);
                    }
                    const updatePromise = query;
                    let timeoutDuration = 45000;
                    if (tableName === 'analysis_archives') {
                        if (analysis_type === 'advanced' || analysis_type === 'two_months') {
                            timeoutDuration = 120000; 
                        } else {
                            timeoutDuration = 60000; 
                        }
                    }
                    const updateTimeout = new Promise((_, reject) => 
                        setTimeout(() => reject(new Error('Update timeout')), timeoutDuration)
                    );
                    try {
                        const { error: updateError } = await Promise.race([updatePromise, updateTimeout]);
                        if (updateError) {
                            if (updateError.message && updateError.message.includes('timeout')) {
                                const dataSize = JSON.stringify(mergedData || data).length;
                                if (dataSize > 5000000) {
                                    console.warn(`‚ö† Update timeout for ${tableName}${analysis_type ? ' (' + analysis_type + ')' : ''} - Data too large (${(dataSize / 1024 / 1024).toFixed(2)}MB). Will retry on next operation.`);
                                } else {
                                    console.warn(`‚ö† Update timeout for ${tableName}${analysis_type ? ' (' + analysis_type + ')' : ''} - Data is too large for localStorage backup`);
                                    try {
                                        const backupKey = `${tableName}_${monthYear}${analysis_type ? '_' + analysis_type : ''}`;
                                        const backupData = mergedData || data;
                                        const backupString = JSON.stringify(backupData);
                                        if (backupString.length <= 2000000) {
                                            localStorage.setItem(backupKey, backupString);
                                        } else {
                                            console.warn(`‚ö† Backup data too large (${(backupString.length / 1024 / 1024).toFixed(2)}MB), skipping localStorage backup. Data will be saved on next successful database operation.`);
                                        }
                                    } catch (e) {
                                        if (e.name === 'QuotaExceededError') {
                                            console.warn(`‚ö† localStorage quota exceeded for backup. Data will be saved on next successful database operation.`);
                                        } else {
                                            console.error('Failed to save backup:', e);
                                        }
                                    }
                                }
                                return false;
                            }
                            throw updateError;
                        }
                    } catch (timeoutError) {
                        if (timeoutError.message && timeoutError.message.includes('timeout')) {
                            console.warn(`‚ö† Update timeout for ${tableName}${analysis_type ? ' (' + analysis_type + ')' : ''} - Data is too large for localStorage backup`);
                            try {
                                const backupKey = `${tableName}_${monthYear}${analysis_type ? '_' + analysis_type : ''}`;
                                const backupData = mergedData || data;
                                const backupString = JSON.stringify(backupData);
                                if (backupString.length <= 2000000) {
                                    localStorage.setItem(backupKey, backupString);
                                } else {
                                    console.warn(`‚ö† Backup data too large (${(backupString.length / 1024 / 1024).toFixed(2)}MB), skipping localStorage backup. Data will be saved on next successful database operation.`);
                                }
                            } catch (e) {
                                if (e.name === 'QuotaExceededError') {
                                    console.warn(`‚ö† localStorage quota exceeded for backup. Data will be saved on next successful database operation.`);
                                } else {
                                    console.error('Failed to save backup:', e);
                                }
                            }
                            return false;
                        }
                        throw timeoutError;
                    }
                } else {
                    const insertPromise = supabaseClient
                        .from(tableName)
                        .insert(archiveData);
                    let timeoutDuration = 45000;
                    if (tableName === 'analysis_archives') {
                        if (analysis_type === 'advanced' || analysis_type === 'two_months') {
                            timeoutDuration = 120000; 
                        } else {
                            timeoutDuration = 60000; 
                        }
                    }
                    const insertTimeout = new Promise((_, reject) => 
                        setTimeout(() => reject(new Error('Insert timeout')), timeoutDuration)
                    );
                    try {
                        const { error: insertError } = await Promise.race([insertPromise, insertTimeout]);
                        if (insertError) {
                            if (insertError.message && insertError.message.includes('timeout')) {
                                console.warn(`‚ö† Insert timeout for ${tableName}${analysis_type ? ' (' + analysis_type + ')' : ''} - Data will be saved in localStorage`);
                                try {
                                    const backupKey = `${tableName}_${monthYear}${analysis_type ? '_' + analysis_type : ''}`;
                                    localStorage.setItem(backupKey, JSON.stringify(data));
                                } catch (e) {
                                    console.error('Failed to save backup:', e);
                                }
                                return false;
                            }
                            throw insertError;
                        }
                    } catch (timeoutError) {
                        if (timeoutError.message && timeoutError.message.includes('timeout')) {
                            console.warn(`‚ö† Insert timeout for ${tableName}${analysis_type ? ' (' + analysis_type + ')' : ''} - Data is too large for localStorage backup`);
                            try {
                                const backupKey = `${tableName}_${monthYear}${analysis_type ? '_' + analysis_type : ''}`;
                                const backupString = JSON.stringify(data);
                                if (backupString.length <= 2000000) {
                                    localStorage.setItem(backupKey, backupString);
                                } else {
                                    console.warn(`‚ö† Backup data too large (${(backupString.length / 1024 / 1024).toFixed(2)}MB), skipping localStorage backup. Data will be saved on next successful database operation.`);
                                }
                            } catch (e) {
                                if (e.name === 'QuotaExceededError') {
                                    console.warn(`‚ö† localStorage quota exceeded for backup. Data will be saved on next successful database operation.`);
                                } else {
                                    console.error('Failed to save backup:', e);
                                }
                            }
                            return false;
                        }
                        throw timeoutError;
                    }
                }
                return true;
            } catch (error) {
                console.error(`‚úó Error saving to ${tableName}:`, error);
                try {
                    const backupKey = `${tableName}_${getCurrentMonthYear()}${options.analysis_type ? '_' + options.analysis_type : ''}`;
                    const backupString = JSON.stringify(data);
                    if (backupString.length <= 2000000) {
                        localStorage.setItem(backupKey, backupString);
                    } else {
                        console.warn(`‚ö† Backup data too large (${(backupString.length / 1024 / 1024).toFixed(2)}MB), skipping localStorage backup. Data will be saved on next successful database operation.`);
                    }
                } catch (e) {
                    if (e.name === 'QuotaExceededError') {
                        console.warn(`‚ö† localStorage quota exceeded for backup. Data will be saved on next successful database operation.`);
                    } else {
                        console.error('Failed to save backup:', e);
                    }
                }
                return false;
            } finally {
                saveLocks.delete(lockKey);
            }
        }
        async function loadDataFromDatabase() {
            if (!supabaseClient) {
                console.error('‚úó Supabase not initialized! Cannot load data.');
                alert('ÿÆÿ∑ÿ£: ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ∫Ÿäÿ± ŸÖÿ™ÿµŸÑÿ©. Ÿäÿ±ÿ¨Ÿâ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿµŸÅÿ≠ÿ©.');
                return;
            }
            try {
                const monthYear = getCurrentMonthYear();
                let savedAgents = JSON.parse(localStorage.getItem('agentsList') || '[]');
                const { data: permanentAgentsArchive } = await supabaseClient
                    .from('agents_list')
                    .select('data')
                    .eq('month_year', '0000-00')
                    .maybeSingle();
                if (permanentAgentsArchive && permanentAgentsArchive.data) {
                    const permanentAgents = permanentAgentsArchive.data;
                    const agentsMap = new Map();
                    
                    permanentAgents.forEach(permanentAgent => {
                        agentsMap.set(permanentAgent.name, {
                            name: permanentAgent.name,
                            subName: permanentAgent.subName || '',
                            phone: permanentAgent.phone || '',
                            email: permanentAgent.email || '',
                            percentage: permanentAgent.percentage || 16
                        });
                    });
                    
                    savedAgents.forEach(agent => {
                        const existingAgent = agentsMap.get(agent.name);
                        if (existingAgent) {
                            if (!existingAgent.phone && agent.phone) existingAgent.phone = agent.phone;
                            if (!existingAgent.email && agent.email) existingAgent.email = agent.email;
                            if (!existingAgent.subName && agent.subName) existingAgent.subName = agent.subName;
                            if (existingAgent.percentage === undefined && agent.percentage !== undefined) {
                                existingAgent.percentage = agent.percentage;
                            }
                        } else {
                            agentsMap.set(agent.name, {
                                name: agent.name,
                                subName: agent.subName || '',
                                phone: agent.phone || '',
                                email: agent.email || '',
                                percentage: agent.percentage || 16
                            });
                        }
                    });
                    
                    agentsList = Array.from(agentsMap.values());
                    localStorage.setItem('agentsList', JSON.stringify(agentsList));
                } else {
                    agentsList = savedAgents;
                }
                const savedPercentages = localStorage.getItem('agentPercentages');
                const savedMonthYear = localStorage.getItem('agentPercentages_monthYear');
                if (savedPercentages) {
                    try {
                        const parsedPercentages = JSON.parse(savedPercentages);
                        if (parsedPercentages && Object.keys(parsedPercentages).length > 0) {
                            agentPercentages = parsedPercentages;
                            const percentageResults = document.getElementById('percentageResults');
                            if (percentageResults) {
                                percentageResults.classList.remove('hidden');
                            }
                            const percentageFileName = document.getElementById('percentageFileName');
                            if (percentageFileName) {
                                percentageFileName.textContent = savedMonthYear 
                                    ? `ÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ™ÿ≠ŸÑŸäŸÑ (${savedMonthYear})`
                                    : 'ÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ™ÿ≠ŸÑŸäŸÑ';
                                percentageFileName.classList.remove('hidden');
                            }
                            renderPercentageTable();
                            if (supabaseClient) {
                                let percentagesArchive = null;
                                const { data: currentMonthArchive, error: currentMonthError } = await supabaseClient
                                    .from('agent_percentages')
                                    .select('data, month_year')
                                    .eq('month_year', monthYear)
                                    .maybeSingle();
                                if (!currentMonthError && currentMonthArchive && currentMonthArchive.data && Object.keys(currentMonthArchive.data).length > 0) {
                                    percentagesArchive = currentMonthArchive;
                                    Object.keys(percentagesArchive.data).forEach(agentName => {
                                        if (!agentPercentages[agentName]) {
                                            agentPercentages[agentName] = percentagesArchive.data[agentName];
                                        }
                                    });
                                    localStorage.setItem('agentPercentages', JSON.stringify(agentPercentages));
                                    localStorage.setItem('agentPercentages_monthYear', percentagesArchive.month_year || monthYear);
                                    renderPercentageTable();
                                } else {
                                    const currentDate = new Date();
                                    for (let i = 0; i < 3; i++) {
                                        const checkDate = new Date(currentDate.getFullYear(), currentDate.getMonth() - i, 1);
                                        const checkMonthYear = `${checkDate.getFullYear()}-${String(checkDate.getMonth() + 1).padStart(2, '0')}`;
                                        const { data: archiveData, error: archiveError } = await supabaseClient
                                            .from('agent_percentages')
                                            .select('data, month_year')
                                            .eq('month_year', checkMonthYear)
                                            .maybeSingle();
                                        if (!archiveError && archiveData && archiveData.data && Object.keys(archiveData.data).length > 0) {
                                            percentagesArchive = archiveData;
                                            Object.keys(percentagesArchive.data).forEach(agentName => {
                                                if (!agentPercentages[agentName]) {
                                                    agentPercentages[agentName] = percentagesArchive.data[agentName];
                                                }
                                            });
                                            localStorage.setItem('agentPercentages', JSON.stringify(agentPercentages));
                                            localStorage.setItem('agentPercentages_monthYear', percentagesArchive.month_year || checkMonthYear);
                                            renderPercentageTable();
                                            break;
                                        }
                                    }
                                }
                            }
                            return; 
                        }
                    } catch (e) {
                        console.error('Error parsing saved percentages from localStorage:', e);
                    }
                }
                let percentagesArchive = null;
                const { data: currentMonthArchive, error: currentMonthError } = await supabaseClient
                    .from('agent_percentages')
                    .select('data, month_year')
                    .eq('month_year', monthYear)
                    .maybeSingle();
                if (!currentMonthError && currentMonthArchive && currentMonthArchive.data && Object.keys(currentMonthArchive.data).length > 0) {
                    percentagesArchive = currentMonthArchive;
                } else {
                    const currentDate = new Date();
                    for (let i = 0; i < 3; i++) {
                        const checkDate = new Date(currentDate.getFullYear(), currentDate.getMonth() - i, 1);
                        const checkMonthYear = `${checkDate.getFullYear()}-${String(checkDate.getMonth() + 1).padStart(2, '0')}`;
                        const { data: archiveData, error: archiveError } = await supabaseClient
                            .from('agent_percentages')
                            .select('data, month_year')
                            .eq('month_year', checkMonthYear)
                            .maybeSingle();
                        if (!archiveError && archiveData && archiveData.data && Object.keys(archiveData.data).length > 0) {
                            percentagesArchive = archiveData;
                            break;
                        }
                    }
                }
                if (percentagesArchive && percentagesArchive.data) {
                    agentPercentages = percentagesArchive.data;
                    localStorage.setItem('agentPercentages', JSON.stringify(agentPercentages));
                    localStorage.setItem('agentPercentages_monthYear', percentagesArchive.month_year || monthYear);
                    if (Object.keys(agentPercentages).length > 0) {
                        const percentageResults = document.getElementById('percentageResults');
                        if (percentageResults) {
                            percentageResults.classList.remove('hidden');
                        }
                        const percentageFileName = document.getElementById('percentageFileName');
                        if (percentageFileName) {
                            percentageFileName.textContent = `ÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ™ÿ≠ŸÑŸäŸÑ ŸÖŸÜ ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ (${percentagesArchive.month_year || monthYear})`;
                            percentageFileName.classList.remove('hidden');
                        }
                        renderPercentageTable();
                    }
                } else {
                    agentPercentages = {};
                }
                const { data: basicArchive } = await supabaseClient
                    .from('analysis_archives')
                    .select('data')
                    .eq('month_year', monthYear)
                    .eq('analysis_type', 'basic')
                    .maybeSingle();
                
                const { data: advancedArchive } = await supabaseClient
                    .from('analysis_archives')
                    .select('data')
                    .eq('month_year', monthYear)
                    .eq('analysis_type', 'advanced')
                    .maybeSingle();
                
                const { data: twoMonthsArchive } = await supabaseClient
                    .from('analysis_archives')
                    .select('data')
                    .eq('month_year', monthYear)
                    .eq('analysis_type', 'two_months')
                    .maybeSingle();
                
                if (basicArchive && basicArchive.data && basicArchive.data.agentReports) {
                    Object.keys(basicArchive.data.agentReports).forEach(agentName => {
                        if (!agentReports[agentName]) {
                            agentReports[agentName] = {};
                        }
                        if (basicArchive.data.agentReports[agentName].basic) {
                            agentReports[agentName].basic = basicArchive.data.agentReports[agentName].basic;
                        }
                    });
                }
                
                if (advancedArchive && advancedArchive.data && advancedArchive.data.agentReports) {
                    Object.keys(advancedArchive.data.agentReports).forEach(agentName => {
                        if (!agentReports[agentName]) {
                            agentReports[agentName] = {};
                        }
                        if (advancedArchive.data.agentReports[agentName].advanced) {
                            agentReports[agentName].advanced = advancedArchive.data.agentReports[agentName].advanced;
                        }
                    });
                }
                
                if (twoMonthsArchive && twoMonthsArchive.data && twoMonthsArchive.data.agentReports) {
                    Object.keys(twoMonthsArchive.data.agentReports).forEach(agentName => {
                        if (!agentReports[agentName]) {
                            agentReports[agentName] = {};
                        }
                        if (twoMonthsArchive.data.agentReports[agentName].twoMonths) {
                            agentReports[agentName].twoMonths = twoMonthsArchive.data.agentReports[agentName].twoMonths;
                        }
                    });
                }
                
                if (Object.keys(agentReports).length > 0) {
                    try {
                        const agentReportsString = JSON.stringify(agentReports);
                        if (agentReportsString.length <= 2000000) {
                            localStorage.setItem('agentReports', agentReportsString);
                        }
                    } catch (e) {
                        console.warn('Could not save agentReports to localStorage:', e);
                    }
                }
                
                basicData = null;
                basicDetails = [];
                advancedData = null;
                advancedDetails = [];
                twoMonthsData = null;
                twoMonthsDetails = [];
                const { data: activityArchive, error: activityError } = await supabaseClient
                    .from('activity_logs')
                    .select('data')
                    .eq('month_year', monthYear)
                    .maybeSingle();
                if (!activityError && activityArchive && activityArchive.data) {
                    activityLog = activityArchive.data;
                } else {
                    activityLog = [];
                }
            } catch (error) {
                console.error('‚úó Error loading from database:', error);
                alert('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖŸÜ ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™: ' + error.message);
            }
        }
        async function getArchiveForMonth(tableName, monthYear) {
            if (!supabaseClient) {
                console.error('‚úó Supabase not initialized');
                return null;
            }
            if (!monthYear || monthYear.length !== 7) {
                console.error(`‚úó Invalid month_year format: ${monthYear}`);
                return null;
            }
            try {
                let query = supabaseClient
                    .from(tableName)
                    .select('*')
                    .eq('month_year', monthYear);
                const { data, error } = await query.maybeSingle();
                if (error) {
                    console.error(`‚úó Error loading archive for ${tableName} - ${monthYear}:`, error);
                    console.error('Error details:', {
                        message: error.message,
                        details: error.details,
                        hint: error.hint,
                        code: error.code
                    });
                    return null;
                }
                if (!data) {
                    return null;
                }
                return data;
            } catch (error) {
                console.error(`‚úó Exception loading archive for ${tableName} - ${monthYear}:`, error);
                console.error('Exception details:', error);
                return null;
            }
        }
        async function listArchives(tableName) {
            if (!supabaseClient) return [];
            try {
                const { data, error } = await supabaseClient
                    .from(tableName)
                    .select('month_year, created_at, updated_at')
                    .order('month_year', { ascending: false });
                if (error) throw error;
                return data || [];
            } catch (error) {
                console.error(`‚úó Error listing archives:`, error);
                return [];
            }
        }
        async function searchInDatabase(searchQuery, options = {}) {
            if (!supabaseClient) {
                console.error('Supabase not initialized');
                return { results: [], error: 'ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ∫Ÿäÿ± ŸÖÿ™ÿµŸÑÿ©' };
            }
            if (!searchQuery || searchQuery.trim().length < 2) {
                return { results: [], error: 'Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ŸÜÿµ ÿ®ÿ≠ÿ´ (ÿ≠ÿ±ŸÅŸäŸÜ ÿπŸÑŸâ ÿßŸÑÿ£ŸÇŸÑ)' };
            }
            const query = searchQuery.trim().toLowerCase();
            const results = {
                agents: [],
                percentages: [],
                analyses: [],
                archives: [],
                activities: []
            };
            try {
                if (options.searchAgents !== false) {
                    const { data: agentsData, error: agentsError } = await supabaseClient
                        .from('agents_list')
                        .select('*')
                        .order('month_year', { ascending: false })
                        .limit(100);
                    if (!agentsError && agentsData) {
                        agentsData.forEach(archive => {
                            if (archive.data && Array.isArray(archive.data)) {
                                archive.data.forEach(agent => {
                                    const agentName = (agent.name || '').toLowerCase();
                                    if (agentName.includes(query)) {
                                        results.agents.push({
                                            month_year: archive.month_year,
                                            agent: agent,
                                            match: 'name'
                                        });
                                    }
                                });
                            }
                        });
                    }
                }
                if (options.searchPercentages !== false) {
                    const { data: percentagesData, error: percentagesError } = await supabaseClient
                        .from('agent_percentages')
                        .select('*')
                        .order('month_year', { ascending: false })
                        .limit(100);
                    if (!percentagesError && percentagesData) {
                        percentagesData.forEach(archive => {
                            if (archive.data && typeof archive.data === 'object') {
                                Object.keys(archive.data).forEach(agentName => {
                                    if (agentName.toLowerCase().includes(query)) {
                                        results.percentages.push({
                                            month_year: archive.month_year,
                                            agentName: agentName,
                                            data: archive.data[agentName]
                                        });
                                    }
                                });
                            }
                        });
                    }
                }
                if (options.searchAnalyses !== false) {
                    const { data: analysesData, error: analysesError } = await supabaseClient
                        .from('analysis_archives')
                        .select('*')
                        .order('month_year', { ascending: false })
                        .limit(100);
                    if (!analysesError && analysesData) {
                        analysesData.forEach(archive => {
                            if (archive.data) {
                                if (archive.data.details && Array.isArray(archive.data.details)) {
                                    const matchingDetails = archive.data.details.filter(detail => {
                                        const username = (detail.username || '').toLowerCase();
                                        const agent = (detail.agent || detail.Agent || detail.agentName || detail.AgentName || detail['ÿßÿ≥ŸÖ ÿßŸÑŸàŸÉŸäŸÑ'] || detail['ÿßŸÑŸàŸÉŸäŸÑ'] || '').toLowerCase();
                                        const subscription = (detail.subscription || '').toLowerCase();
                                        return username.includes(query) || agent.includes(query) || subscription.includes(query);
                                    });
                                    if (matchingDetails.length > 0) {
                                        results.analyses.push({
                                            month_year: archive.month_year,
                                            analysis_type: archive.analysis_type,
                                            matches: matchingDetails.length,
                                            sample: matchingDetails[0]
                                        });
                                    }
                                }
                                if (archive.data.agentReports) {
                                    Object.keys(archive.data.agentReports).forEach(agentName => {
                                        if (agentName.toLowerCase().includes(query)) {
                                            results.analyses.push({
                                                month_year: archive.month_year,
                                                analysis_type: archive.analysis_type,
                                                agentName: agentName,
                                                report: archive.data.agentReports[agentName]
                                            });
                                        }
                                    });
                                }
                            }
                        });
                    }
                }
                if (options.searchActivities !== false) {
                    const { data: activitiesData, error: activitiesError } = await supabaseClient
                        .from('activity_logs')
                        .select('*')
                        .order('month_year', { ascending: false })
                        .limit(100);
                    if (!activitiesError && activitiesData) {
                        activitiesData.forEach(archive => {
                            if (archive.data && Array.isArray(archive.data)) {
                                const matchingActivities = archive.data.filter(activity => {
                                    const action = (activity.action || '').toLowerCase();
                                    const details = (activity.details || '').toLowerCase();
                                    const user = (activity.user || '').toLowerCase();
                                    return action.includes(query) || details.includes(query) || user.includes(query);
                                });
                                if (matchingActivities.length > 0) {
                                    results.activities.push({
                                        month_year: archive.month_year,
                                        matches: matchingActivities.length,
                                        activities: matchingActivities
                                    });
                                }
                            }
                        });
                    }
                }
                return { results, error: null };
            } catch (error) {
                console.error('Error searching database:', error);
                return { results: null, error: error.message };
            }
        }
        function searchInCurrentData(searchQuery) {
            if (!searchQuery || searchQuery.trim().length < 2) {
                return { results: [], error: 'Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ŸÜÿµ ÿ®ÿ≠ÿ´ (ÿ≠ÿ±ŸÅŸäŸÜ ÿπŸÑŸâ ÿßŸÑÿ£ŸÇŸÑ)' };
            }
            const query = searchQuery.trim().toLowerCase();
            const results = {
                agents: [],
                percentages: [],
                basicDetails: [],
                advancedDetails: [],
                twoMonthsDetails: [],
                activities: []
            };
            if (Array.isArray(agentsList)) {
                agentsList.forEach(agent => {
                    const name = (agent.name || '').toLowerCase();
                    if (name.includes(query)) {
                        results.agents.push(agent);
                    }
                });
            }
            if (agentPercentages && typeof agentPercentages === 'object') {
                Object.keys(agentPercentages).forEach(agentName => {
                    if (agentName.toLowerCase().includes(query)) {
                        results.percentages.push({
                            agentName: agentName,
                            data: agentPercentages[agentName]
                        });
                    }
                });
            }
            if (Array.isArray(basicDetails)) {
                basicDetails.forEach(detail => {
                    const username = (detail.username || '').toLowerCase();
                    const agent = (detail.agent || detail.Agent || detail.agentName || detail.AgentName || detail['ÿßÿ≥ŸÖ ÿßŸÑŸàŸÉŸäŸÑ'] || detail['ÿßŸÑŸàŸÉŸäŸÑ'] || '').toLowerCase();
                    if (username.includes(query) || agent.includes(query)) {
                        results.basicDetails.push(detail);
                    }
                });
            }
            if (Array.isArray(advancedDetails)) {
                advancedDetails.forEach(detail => {
                    const username = (detail.username || '').toLowerCase();
                    const agent = (detail.agent || detail.Agent || detail.agentName || detail.AgentName || detail['ÿßÿ≥ŸÖ ÿßŸÑŸàŸÉŸäŸÑ'] || detail['ÿßŸÑŸàŸÉŸäŸÑ'] || '').toLowerCase();
                    if (username.includes(query) || agent.includes(query)) {
                        results.advancedDetails.push(detail);
                    }
                });
            }
            if (Array.isArray(twoMonthsDetails)) {
                twoMonthsDetails.forEach(detail => {
                    const username = (detail.username || '').toLowerCase();
                    const agent = (detail.agent || detail.Agent || detail.agentName || detail.AgentName || detail['ÿßÿ≥ŸÖ ÿßŸÑŸàŸÉŸäŸÑ'] || detail['ÿßŸÑŸàŸÉŸäŸÑ'] || '').toLowerCase();
                    if (username.includes(query) || agent.includes(query)) {
                        results.twoMonthsDetails.push(detail);
                    }
                });
            }
            if (Array.isArray(activityLog)) {
                activityLog.forEach(activity => {
                    const action = (activity.action || '').toLowerCase();
                    const details = (activity.details || '').toLowerCase();
                    if (action.includes(query) || details.includes(query)) {
                        results.activities.push(activity);
                    }
                });
            }
            return { results, error: null };
        }
        let searchTimeout = null;
        async function handleGlobalSearch(event) {
            const query = event.target.value.trim();
            const resultsDiv = document.getElementById('searchResults');
            if (query.length < 2) {
                resultsDiv.classList.remove('active');
                return;
            }
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(async () => {
                const currentResults = searchInCurrentData(query);
                const dbResults = await searchInDatabase(query, {
                    searchAgents: true,
                    searchPercentages: true,
                    searchAnalyses: true,
                    searchActivities: true
                });
                displayQuickSearchResults(currentResults, dbResults, query);
            }, 300);
        }
        function showSearchResults() {
            const input = document.getElementById('globalSearchInput');
            const resultsDiv = document.getElementById('searchResults');
            if (input.value.trim().length >= 2) {
                resultsDiv.classList.add('active');
            }
        }
        function displayQuickSearchResults(currentResults, dbResults, query) {
            const resultsDiv = document.getElementById('searchResults');
            let html = '';
            const totalResults = 
                (currentResults.results.agents.length || 0) +
                (currentResults.results.percentages.length || 0) +
                (currentResults.results.basicDetails.length || 0) +
                (currentResults.results.advancedDetails.length || 0) +
                (currentResults.results.twoMonthsDetails.length || 0) +
                (dbResults.results?.agents.length || 0) +
                (dbResults.results?.percentages.length || 0) +
                (dbResults.results?.analyses.length || 0);
            if (totalResults === 0) {
                html = '<div style="padding: 10px; text-align: center; color: var(--text-secondary);">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÜÿ™ÿßÿ¶ÿ¨</div>';
            } else {
                if (currentResults.results.agents.length > 0) {
                    currentResults.results.agents.slice(0, 3).forEach(agent => {
                        html += `<div class="search-result-item" onclick="switchTab('agents'); highlightAgent('${agent.name}')">
                            <div class="result-type">ŸàŸÉŸäŸÑ - ÿßŸÑÿ¥Ÿáÿ± ÿßŸÑÿ≠ÿßŸÑŸä</div>
                            <div class="result-title">${agent.name}</div>
                        </div>`;
                    });
                }
                if (dbResults.results?.agents.length > 0) {
                    dbResults.results.agents.slice(0, 3).forEach(item => {
                        html += `<div class="search-result-item" onclick="switchTab('archive'); loadArchiveByAgent('${item.month_year}')">
                            <div class="result-type">ŸàŸÉŸäŸÑ - ${item.month_year}</div>
                            <div class="result-title">${item.agent.name}</div>
                        </div>`;
                    });
                }
                if (totalResults > 6) {
                    html += `<div class="search-result-item" style="text-align: center; font-weight: 600; color: var(--text-secondary);">
                        ... Ÿà ${totalResults - 6} ŸÜÿ™Ÿäÿ¨ÿ© ÿ£ÿÆÿ±Ÿâ
                    </div>`;
                }
            }
            resultsDiv.innerHTML = html;
            resultsDiv.classList.add('active');
        }
        async function refreshArchivesList() {
            if (!supabaseClient) {
                document.getElementById('archivesList').innerHTML = '<p style="color: var(--text-secondary);">Supabase ÿ∫Ÿäÿ± ŸÖÿ™ÿµŸÑ</p>';
                return;
            }
            try {
                const allArchives = {};
                const agentCounts = {};
                const tables = ['agents_list', 'agent_percentages', 'analysis_archives', 'activity_logs'];
                for (const table of tables) {
                    const archives = await listArchives(table);
                    for (const archive of archives) {
                        if (!allArchives[archive.month_year]) {
                            allArchives[archive.month_year] = [];
                            agentCounts[archive.month_year] = 0;
                        }
                        allArchives[archive.month_year].push(table);
                            }
                            }
                const months = Object.keys(allArchives).filter(month => month !== '0000-00').sort().reverse();
                const container = document.getElementById('archivesList');
                if (months.length === 0) {
                    container.innerHTML = '<p style="color: var(--text-secondary);">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ£ÿ±ÿ¥ŸäŸÅÿßÿ™ ŸÖÿ™ÿßÿ≠ÿ©</p>';
                    return;
                }
                const realCounts = {};
                for (const month of months) {
                    try {
                        const percentagesArchive = await getArchiveForMonth('agent_percentages', month);
                        const agentsListArchive = await getArchiveForMonth('agents_list', month);
                        const { data: basicArchiveData } = await supabaseClient.from('analysis_archives').select('*').eq('month_year', month).eq('analysis_type', 'basic').maybeSingle();
                        const { data: advancedArchiveData } = await supabaseClient.from('analysis_archives').select('*').eq('month_year', month).eq('analysis_type', 'advanced').maybeSingle();
                        const { data: twoMonthsArchiveData } = await supabaseClient.from('analysis_archives').select('*').eq('month_year', month).eq('analysis_type', 'two_months').maybeSingle();
                        const basicArchive = basicArchiveData ? { data: basicArchiveData.data } : null;
                        const advancedArchive = advancedArchiveData ? { data: advancedArchiveData.data } : null;
                        const twoMonthsArchive = twoMonthsArchiveData ? { data: twoMonthsArchiveData.data } : null;
                        let percentages = {};
                        if (percentagesArchive && percentagesArchive.data && typeof percentagesArchive.data === 'object') {
                            Object.keys(percentagesArchive.data).forEach(agentName => {
                                const normalized = normalizeAgentName(agentName);
                                if (!percentages[normalized]) {
                                    percentages[normalized] = {
                                        ...percentagesArchive.data[agentName],
                                        originalName: agentName
                                    };
                                }
                            });
                        }
                        if (agentsListArchive && agentsListArchive.data && Array.isArray(agentsListArchive.data)) {
                            agentsListArchive.data.forEach(agent => {
                                if (agent && agent.name) {
                                    const normalized = normalizeAgentName(agent.name);
                                    if (!percentages[normalized]) {
                                        percentages[normalized] = {
                                            originalName: agent.name,
                                            percentage: agent.percentage || 15,
                                            iqT: 0,
                                            iqP: 0,
                                            iqG: 0,
                                            iqS: 0,
                                            iqB: 0,
                                            agentPercentageAmount: 0,
                                            netPercentage: 0
                                        };
                                    }
                                }
                            });
                        }
                        const agentNames = Object.keys(percentages);
                        const checkAgentHasAnalyses = (normalizedName, displayName) => {
                            const possibleNames = [displayName, normalizedName];
                            if (percentagesArchive && percentagesArchive.data) {
                                Object.keys(percentagesArchive.data).forEach(name => {
                                    if (normalizeAgentName(name) === normalizedName) {
                                        possibleNames.push(name);
                                    }
                                });
                            }
                            if (agentsListArchive && agentsListArchive.data && Array.isArray(agentsListArchive.data)) {
                                agentsListArchive.data.forEach(agent => {
                                    if (agent && agent.name && normalizeAgentName(agent.name) === normalizedName) {
                                        possibleNames.push(agent.name);
                                    }
                                });
                            }
                            const nameMatches = (name) => {
                                if (!name) return false;
                                const normalizedNameToCheck = normalizeAgentName(name);
                                return possibleNames.some(pn => normalizeAgentName(pn) === normalizedNameToCheck);
                            };
                            const archives = [basicArchive, advancedArchive, twoMonthsArchive];
                            for (const archive of archives) {
                                if (archive && archive.data) {
                                    if (archive.data.agentReports && typeof archive.data.agentReports === 'object') {
                                        for (const archiveAgentName of Object.keys(archive.data.agentReports)) {
                                            if (nameMatches(archiveAgentName)) {
                                                const agentReport = archive.data.agentReports[archiveAgentName];
                                                if (agentReport && (agentReport.basic || agentReport.advanced || agentReport.twoMonths || agentReport.two_months)) {
                                                    return true;
                                                }
                                            }
                                        }
                                    }
                                    if (Array.isArray(archive.data.details) && archive.data.details.length > 0) {
                                        for (const detail of archive.data.details) {
                                            const agent = detail.agent || detail.Agent || detail.agentName || detail.AgentName || detail['ÿßÿ≥ŸÖ ÿßŸÑŸàŸÉŸäŸÑ'] || detail['ÿßŸÑŸàŸÉŸäŸÑ'];
                                            if (nameMatches(agent)) {
                                                return true;
                                            }
                                        }
                                    }
                                }
                            }
                            return false;
                        };
                        const filteredCount = agentNames.filter(normalizedName => {
                            const agentData = percentages[normalizedName];
                            const displayName = agentData.originalName || normalizedName;
                            const hasPercentageData = agentData.percentage !== undefined && 
                                                     agentData.percentage !== null && 
                                                     agentData.percentage > 0 &&
                                                     (agentData.agentPercentageAmount > 0 || 
                                                      agentData.iqT > 0 || 
                                                      (agentData.iqP + agentData.iqG + agentData.iqS + agentData.iqB) > 0);
                            const hasAnalyses = checkAgentHasAnalyses(normalizedName, displayName);
                            return hasPercentageData && hasAnalyses;
                        }).length;
                        realCounts[month] = filteredCount;
                    } catch (err) {
                        console.error(`Error calculating count for ${month}:`, err);
                        realCounts[month] = 0;
                    }
                }
                container.innerHTML = months.map(month => {
                    const count = realCounts[month] || 0;
                    return `
                        <div style="background: var(--card-bg); padding: 15px; border-radius: 8px; border: 1px solid var(--border-color); cursor: pointer;" 
                             onclick="loadArchiveByAgent('${month}')">
                            <div style="font-weight: 600; margin-bottom: 5px;">${month}</div>
                            <div style="font-size: 0.85rem; color: var(--text-secondary);">${count} ŸàŸÉŸäŸÑ</div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error refreshing archives list:', error);
                document.getElementById('archivesList').innerHTML = '<p style="color: red;">ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ£ÿ±ÿ¥ŸäŸÅÿßÿ™</p>';
            }
        }
        function normalizeAgentName(agentName) {
            if (!agentName) return '';
            return agentName.toLowerCase().replace(/[_-]/g, '-');
        }
        async function loadArchiveByAgent(monthYear = null) {
            if (!supabaseClient) {
                document.getElementById('archiveContent').innerHTML = '<p style="color: red;">Supabase ÿ∫Ÿäÿ± ŸÖÿ™ÿµŸÑ</p>';
                return;
            }
            if (!monthYear) {
                const monthInput = document.getElementById('archiveMonthSelect');
                if (monthInput && monthInput.value) {
                    monthYear = monthInput.value.substring(0, 7);
                } else {
                    monthYear = getCurrentMonthYear();
                }
            }
            try {
                const container = document.getElementById('archiveContent');
                container.innerHTML = '<p style="text-align: center;">ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ£ÿ±ÿ¥ŸäŸÅ...</p>';
                const percentagesArchive = await getArchiveForMonth('agent_percentages', monthYear);
                const agentsListArchive = await getArchiveForMonth('agents_list', monthYear);
                const { data: basicArchiveData, error: basicError } = await supabaseClient.from('analysis_archives').select('*').eq('month_year', monthYear).eq('analysis_type', 'basic').maybeSingle();
                const { data: advancedArchiveData, error: advancedError } = await supabaseClient.from('analysis_archives').select('*').eq('month_year', monthYear).eq('analysis_type', 'advanced').maybeSingle();
                const { data: twoMonthsArchiveData, error: twoMonthsError } = await supabaseClient.from('analysis_archives').select('*').eq('month_year', monthYear).eq('analysis_type', 'two_months').maybeSingle();
                const basicArchive = { 
                    data: basicArchiveData ? basicArchiveData.data : null, 
                    error: basicError,
                    raw: basicArchiveData 
                };
                const advancedArchive = { 
                    data: advancedArchiveData ? advancedArchiveData.data : null, 
                    error: advancedError,
                    raw: advancedArchiveData 
                };
                const twoMonthsArchive = { 
                    data: twoMonthsArchiveData ? twoMonthsArchiveData.data : null, 
                    error: twoMonthsError,
                    raw: twoMonthsArchiveData 
                };
                let percentages = {};
                const agentsListMap = {};
                const normalizedToOriginal = {}; 
                if (percentagesArchive && percentagesArchive.data && typeof percentagesArchive.data === 'object' && Object.keys(percentagesArchive.data).length > 0) {
                    Object.keys(percentagesArchive.data).forEach(agentName => {
                        const normalized = normalizeAgentName(agentName);
                        normalizedToOriginal[normalized] = agentName;
                        if (!percentages[normalized]) {
                            percentages[normalized] = {
                                ...percentagesArchive.data[agentName],
                                originalName: agentName 
                            };
                        } else {
                            const existing = percentages[normalized];
                            const newData = percentagesArchive.data[agentName];
                            if (newData.percentage !== undefined && newData.percentage !== null) {
                                existing.percentage = newData.percentage;
                            }
                            existing.originalName = agentName;
                            Object.keys(newData).forEach(key => {
                                if (key !== 'percentage' && key !== 'originalName' && newData[key] !== undefined && newData[key] !== null) {
                                    if (Array.isArray(newData[key])) {
                                        existing[key] = newData[key];
                                    } else if (typeof newData[key] === 'object' && newData[key] !== null) {
                                        existing[key] = { ...existing[key], ...newData[key] };
                                    } else {
                                        existing[key] = newData[key];
                                    }
                                }
                            });
                        }
                    });
                }
                if (agentsListArchive && agentsListArchive.data && Array.isArray(agentsListArchive.data) && agentsListArchive.data.length > 0) {
                    agentsListArchive.data.forEach(agent => {
                        if (agent && agent.name) {
                            const normalized = normalizeAgentName(agent.name);
                            if (!normalizedToOriginal[normalized]) {
                                normalizedToOriginal[normalized] = agent.name;
                            }
                            agentsListMap[normalized] = agent;
                            if (!percentages[normalized]) {
                                percentages[normalized] = {
                                    originalName: agent.name,
                                    percentage: agent.percentage || 15, 
                                    iqT: 0,
                                    iqP: 0,
                                    iqG: 0,
                                    iqS: 0,
                                    iqB: 0,
                                    agentPercentageAmount: 0,
                                    netPercentage: 0,
                                    offers: agent.offers || {},
                                    details: agent.details || {}
                                };
                            } else {
                                if (agent.offers) {
                                    percentages[normalized].offers = { ...percentages[normalized].offers, ...agent.offers };
                                }
                                if (agent.details) {
                                    percentages[normalized].details = { ...percentages[normalized].details, ...agent.details };
                                }
                                if (!percentages[normalized].percentage && agent.percentage) {
                                    percentages[normalized].percentage = agent.percentage;
                                }
                            }
                        }
                    });
                }
                if (Object.keys(percentages).length === 0) {
                    const displayMonth = monthYear === '0000-00' ? 'ŸÇÿßÿ¶ŸÖÿ© ÿØÿßÿ¶ŸÖÿ©' : monthYear;
                    container.innerHTML = `<h4 style="margin-bottom: 20px; text-align: center; color: var(--primary-color);">ÿ£ÿ±ÿ¥ŸäŸÅ ${displayMonth}</h4>
                        <div style="text-align: center; color: var(--text-secondary); padding: 20px;">
                            <p style="margin-bottom: 15px;">‚ö†Ô∏è ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™ ŸÖÿ≠ŸÅŸàÿ∏ÿ© ŸÑŸáÿ∞ÿß ÿßŸÑÿ¥Ÿáÿ± ŸÅŸä ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™.</p>
                            <p style="font-size: 0.9rem; margin-bottom: 10px;">ŸÑÿ™ÿ≥ÿ¨ŸäŸÑ ÿ®ŸäÿßŸÜÿßÿ™ ŸÑŸáÿ∞ÿß ÿßŸÑÿ¥Ÿáÿ±:</p>
                            <ol style="text-align: right; display: inline-block; font-size: 0.9rem; margin: 10px 0;">
                                <li>ÿßÿ∞Ÿáÿ® ÿ•ŸÑŸâ ÿµŸÅÿ≠ÿ© "ŸÜÿ≥ÿ®ÿ© ÿßŸÑŸàŸÉŸÑÿßÿ°"</li>
                                <li>ŸÇŸÖ ÿ®ÿ™ÿ≠ŸÑŸäŸÑ Ÿàÿ≠ŸÅÿ∏ ŸÜÿ≥ÿ® ÿßŸÑŸàŸÉŸÑÿßÿ°</li>
                                <li>ÿ≥Ÿäÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã ŸÅŸä ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™</li>
                            </ol>
                            <p style="font-size: 0.85rem; color: var(--text-tertiary); margin-top: 15px;">ŸÖŸÑÿßÿ≠ÿ∏ÿ©: ÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ£ŸÜ ÿßŸÑÿ¥Ÿáÿ± ÿßŸÑŸÖÿ≠ÿØÿØ ÿµÿ≠Ÿäÿ≠ (${monthYear})</p>
                        </div>`;
                    return;
                }
                const agentNames = Object.keys(percentages).sort();
                const displayMonth = monthYear === '0000-00' ? 'ŸÇÿßÿ¶ŸÖÿ© ÿØÿßÿ¶ŸÖÿ©' : monthYear;
                const checkAgentHasAnalyses = (normalizedName, displayName) => {
                        const possibleNames = [displayName, normalizedName];
                        if (percentagesArchive && percentagesArchive.data) {
                            Object.keys(percentagesArchive.data).forEach(name => {
                                if (normalizeAgentName(name) === normalizedName) {
                                    possibleNames.push(name);
                                }
                            });
                        }
                        if (agentsListArchive && agentsListArchive.data && Array.isArray(agentsListArchive.data)) {
                            agentsListArchive.data.forEach(agent => {
                                if (agent && agent.name && normalizeAgentName(agent.name) === normalizedName) {
                                    possibleNames.push(agent.name);
                                }
                            });
                        }
                        const nameMatches = (name) => {
                            if (!name) return false;
                            const normalizedNameToCheck = normalizeAgentName(name);
                            return possibleNames.some(pn => normalizeAgentName(pn) === normalizedNameToCheck);
                        };
                        if (basicArchive && basicArchive.data) {
                            if (basicArchive.data.agentReports && typeof basicArchive.data.agentReports === 'object') {
                                for (const archiveAgentName of Object.keys(basicArchive.data.agentReports)) {
                                    if (nameMatches(archiveAgentName)) {
                                        const agentReport = basicArchive.data.agentReports[archiveAgentName];
                                        if (agentReport && agentReport.basic) {
                                            if (typeof agentReport.basic === 'object' && Object.keys(agentReport.basic).length > 0) {
                                                return true;
                                            }
                                            if (agentReport.basic) {
                                                return true;
                                            }
                                        }
                                    }
                                }
                            }
                            if (basicArchive.data.results) {
                                if (typeof basicArchive.data.results === 'object') {
                                    if (basicArchive.data.results.agentName && nameMatches(basicArchive.data.results.agentName)) {
                                        return true;
                                    }
                                    for (const key of Object.keys(basicArchive.data.results)) {
                                        if (nameMatches(key)) {
                                            const result = basicArchive.data.results[key];
                                            if (result && (result.basic || (typeof result === 'object' && Object.keys(result).length > 0))) {
                                                return true;
                                            }
                                        }
                                    }
                                }
                            }
                            if (Array.isArray(basicArchive.data.details) && basicArchive.data.details.length > 0) {
                                for (const detail of basicArchive.data.details) {
                                    const agent = detail.agent || detail.Agent || detail.agentName || detail.AgentName || detail['ÿßÿ≥ŸÖ ÿßŸÑŸàŸÉŸäŸÑ'] || detail['ÿßŸÑŸàŸÉŸäŸÑ'];
                                    if (nameMatches(agent)) {
                                        return true;
                                    }
                                }
                            }
                            if (Array.isArray(basicArchive.data.data) && basicArchive.data.data.length > 0) {
                                for (const item of basicArchive.data.data) {
                                    const agent = item.agent || item.Agent || item.agentName || item.AgentName || item['ÿßÿ≥ŸÖ ÿßŸÑŸàŸÉŸäŸÑ'] || item['ÿßŸÑŸàŸÉŸäŸÑ'];
                                    if (nameMatches(agent)) {
                                        return true;
                                    }
                                }
                            }
                        }
                        if (advancedArchive && advancedArchive.data) {
                            if (advancedArchive.data.agentReports && typeof advancedArchive.data.agentReports === 'object') {
                                for (const archiveAgentName of Object.keys(advancedArchive.data.agentReports)) {
                                    if (nameMatches(archiveAgentName)) {
                                        const agentReport = advancedArchive.data.agentReports[archiveAgentName];
                                        if (agentReport && agentReport.advanced) {
                                            if (typeof agentReport.advanced === 'object' && Object.keys(agentReport.advanced).length > 0) {
                                                return true;
                                            }
                                            if (agentReport.advanced) {
                                                return true;
                                            }
                                        }
                                    }
                                }
                            }
                            if (advancedArchive.data.results) {
                                if (typeof advancedArchive.data.results === 'object') {
                                    if (advancedArchive.data.results.agentName && nameMatches(advancedArchive.data.results.agentName)) {
                                        return true;
                                    }
                                    for (const key of Object.keys(advancedArchive.data.results)) {
                                        if (nameMatches(key)) {
                                            const result = advancedArchive.data.results[key];
                                            if (result && (result.advanced || (typeof result === 'object' && Object.keys(result).length > 0))) {
                                                return true;
                                            }
                                        }
                                    }
                                }
                            }
                            if (Array.isArray(advancedArchive.data.details) && advancedArchive.data.details.length > 0) {
                                for (const detail of advancedArchive.data.details) {
                                    const agent = detail.agent || detail.Agent || detail.agentName || detail.AgentName || detail['ÿßÿ≥ŸÖ ÿßŸÑŸàŸÉŸäŸÑ'] || detail['ÿßŸÑŸàŸÉŸäŸÑ'];
                                    if (nameMatches(agent)) {
                                        return true;
                                    }
                                }
                            }
                            if (Array.isArray(advancedArchive.data.data) && advancedArchive.data.data.length > 0) {
                                for (const item of advancedArchive.data.data) {
                                    const agent = item.agent || item.Agent || item.agentName || item.AgentName || item['ÿßÿ≥ŸÖ ÿßŸÑŸàŸÉŸäŸÑ'] || item['ÿßŸÑŸàŸÉŸäŸÑ'];
                                    if (nameMatches(agent)) {
                                        return true;
                                    }
                                }
                            }
                        }
                        if (twoMonthsArchive && twoMonthsArchive.data) {
                            if (twoMonthsArchive.data.agentReports && typeof twoMonthsArchive.data.agentReports === 'object') {
                                for (const archiveAgentName of Object.keys(twoMonthsArchive.data.agentReports)) {
                                    if (nameMatches(archiveAgentName)) {
                                        const agentReport = twoMonthsArchive.data.agentReports[archiveAgentName];
                                        const twoMonthsData = agentReport.twoMonths || agentReport.two_months;
                                        if (agentReport && twoMonthsData) {
                                            if (typeof twoMonthsData === 'object' && Object.keys(twoMonthsData).length > 0) {
                                                return true;
                                            }
                                            if (twoMonthsData) {
                                                return true;
                                            }
                                        }
                                    }
                                }
                            }
                            if (twoMonthsArchive.data.results) {
                                if (typeof twoMonthsArchive.data.results === 'object') {
                                    if (twoMonthsArchive.data.results.agentName && nameMatches(twoMonthsArchive.data.results.agentName)) {
                                        return true;
                                    }
                                    for (const key of Object.keys(twoMonthsArchive.data.results)) {
                                        if (nameMatches(key)) {
                                            const result = twoMonthsArchive.data.results[key];
                                            if (result && (result.twoMonths || result.two_months || (typeof result === 'object' && Object.keys(result).length > 0))) {
                                                return true;
                                            }
                                        }
                                    }
                                }
                            }
                            if (Array.isArray(twoMonthsArchive.data.details) && twoMonthsArchive.data.details.length > 0) {
                                for (const detail of twoMonthsArchive.data.details) {
                                    const agent = detail.agent || detail.Agent || detail.agentName || detail.AgentName || detail['ÿßÿ≥ŸÖ ÿßŸÑŸàŸÉŸäŸÑ'] || detail['ÿßŸÑŸàŸÉŸäŸÑ'];
                                    if (nameMatches(agent)) {
                                        return true;
                                    }
                                }
                            }
                            if (Array.isArray(twoMonthsArchive.data.data) && twoMonthsArchive.data.data.length > 0) {
                                for (const item of twoMonthsArchive.data.data) {
                                    const agent = item.agent || item.Agent || item.agentName || item.AgentName || item['ÿßÿ≥ŸÖ ÿßŸÑŸàŸÉŸäŸÑ'] || item['ÿßŸÑŸàŸÉŸäŸÑ'];
                                    if (nameMatches(agent)) {
                                        return true;
                                    }
                                }
                            }
                        }
                        return false;
                    };
                const agentsListContainer = document.getElementById('archiveAgentsList');
                const agentsListContent = document.getElementById('archiveAgentsListContent');
                const archiveContent = document.getElementById('archiveContent');
                if (agentsListContainer && agentsListContent) {
                    agentsListContainer.style.display = 'block';
                    archiveContent.style.display = 'none';
                    const filteredAgents = agentNames.filter(normalizedName => {
                        const agentData = percentages[normalizedName];
                        const displayName = agentData.originalName || normalizedName;
                        const hasPercentageData = agentData.percentage !== undefined && 
                                                 agentData.percentage !== null && 
                                                 agentData.percentage > 0 &&
                                                 (agentData.agentPercentageAmount > 0 || 
                                                  agentData.iqT > 0 || 
                                                  (agentData.iqP + agentData.iqG + agentData.iqS + agentData.iqB) > 0);
                        const hasAnalyses = checkAgentHasAnalyses(normalizedName, displayName);
                        const shouldInclude = hasPercentageData && hasAnalyses;
                        if (!shouldInclude) {
                        }
                        return shouldInclude;
                    });
                    let agentsListHTML = `<h4 style="margin-bottom: 15px; text-align: center; color: var(--primary-color);">ÿ£ÿ±ÿ¥ŸäŸÅ ${displayMonth} - ${filteredAgents.length} ŸàŸÉŸäŸÑ</h4>`;
                    if (filteredAgents.length === 0) {
                        agentsListHTML += `
                            <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                                <p style="font-size: 1.1rem; margin-bottom: 10px;">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸàŸÉŸÑÿßÿ° ŸÑÿØŸäŸáŸÖ ÿ®ŸäÿßŸÜÿßÿ™ ŸÜÿ≥ÿ®ÿ© Ÿàÿ™ÿ≠ŸÑŸäŸÑÿßÿ™ ŸÅŸä Ÿáÿ∞ÿß ÿßŸÑÿ£ÿ±ÿ¥ŸäŸÅ</p>
                                <p style="font-size: 0.9rem;">Ÿäÿ™ŸÖ ÿπÿ±ÿ∂ ÿßŸÑŸàŸÉŸÑÿßÿ° ÿßŸÑÿ∞ŸäŸÜ ŸÑÿØŸäŸáŸÖ ŸÜÿ≥ÿ®ÿ© Ÿàÿ™ÿ≠ŸÑŸäŸÑÿßÿ™ ÿπÿ±Ÿàÿ∂ ŸÅŸÇÿ∑</p>
                            </div>
                        `;
                    } else {
                        filteredAgents.forEach(normalizedName => {
                            const agentData = percentages[normalizedName];
                            const displayName = agentData.originalName || normalizedName;
                            const hasAnalyses = checkAgentHasAnalyses(normalizedName, displayName);
                            agentsListHTML += `
                                <div class="archive-agent-card" onclick="showArchiveAgentDetails('${normalizedName}', '${monthYear}')" 
                                 style="background: var(--bg-secondary); padding: 15px; border-radius: 8px; border: 2px solid var(--border-color); cursor: pointer; transition: all 0.3s;"
                                 onmouseover="this.style.borderColor='var(--primary-color)'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.1)'"
                                 onmouseout="this.style.borderColor='var(--border-color)'; this.style.transform='translateY(0)'; this.style.boxShadow='none'"
                                     data-agent-name="${displayName}">
                                    <div style="font-weight: 700; font-size: 1.1rem; color: var(--primary-color); margin-bottom: 8px;">${displayName}</div>
                                <div style="font-size: 0.9rem; color: var(--text-secondary);">
                                    ${agentData.percentage ? `<div>ÿßŸÑŸÜÿ≥ÿ®ÿ©: ${agentData.percentage}%</div>` : ''}
                                    ${agentData.agentPercentageAmount ? `<div>ÿßŸÑŸÖÿ®ŸÑÿ∫: ${formatNumber(agentData.agentPercentageAmount)} ÿØ.ÿπ</div>` : ''}
                                        <div style="color: #28a745; margin-top: 5px;">‚úì ŸÑÿØŸäŸá ÿ™ÿ≠ŸÑŸäŸÑÿßÿ™</div>
                                </div>
                            </div>
                        `;
                    });
                    }
                    agentsListContent.innerHTML = agentsListHTML;
                }
                window.currentArchiveMonthYear = monthYear;
                const filteredAgentsForStorage = agentNames.filter(normalizedName => {
                    const agentData = percentages[normalizedName];
                    const displayName = agentData.originalName || normalizedName;
                    const hasPercentageData = agentData.percentage !== undefined && 
                                             agentData.percentage !== null && 
                                             agentData.percentage > 0 &&
                                             (agentData.agentPercentageAmount > 0 || 
                                              agentData.iqT > 0 || 
                                              (agentData.iqP + agentData.iqG + agentData.iqS + agentData.iqB) > 0);
                    const hasAnalyses = checkAgentHasAnalyses(normalizedName, displayName);
                    return hasPercentageData && hasAnalyses;
                });
                window.currentArchiveAgentNames = filteredAgentsForStorage;
                window.currentArchivePercentages = percentages;
                window.normalizedToOriginal = normalizedToOriginal;
                window.currentBasicArchive = basicArchive;
                window.currentAdvancedArchive = advancedArchive;
                window.currentTwoMonthsArchive = twoMonthsArchive;
                window.currentPercentagesArchive = percentagesArchive;
                return;
                let html = `<h4 style="margin-bottom: 20px; text-align: center; color: var(--primary-color);">ÿ£ÿ±ÿ¥ŸäŸÅ ${displayMonth} </h4>`;
                for (const agentName of agentNames) {
                    const agentData = percentages[agentName];
                    html += `<div style="margin-bottom: 30px; border: 2px solid var(--primary-color); border-radius: 12px; padding: 20px; background: var(--card-bg); box-shadow: var(--shadow-md);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid var(--primary-color); padding-bottom: 10px;">
                            <h3 style="margin: 0; color: var(--primary-color); font-size: 1.3rem;">${agentName}</h3>
                            <div style="display: flex; gap: 10px;">
                            <button class="btn btn-success" onclick="exportAgentArchiveReport('${agentName}', '${monthYear}')" style="font-size: 0.9rem; padding: 8px 15px;">
                                    üì• ÿ™ÿµÿØŸäÿ± Excel
                            </button>
                                <button class="btn btn-danger" onclick="printArchivePDF('${agentName}', '${monthYear}')" style="font-size: 0.9rem; padding: 8px 15px; background-color: #dc3545; border-color: #dc3545;">
                                    üñ®Ô∏è ÿ∑ÿ®ÿßÿπÿ© PDF
                                </button>
                            </div>
                        </div>`;
                    html += `<div style="margin-bottom: 20px; background: var(--bg-secondary); padding: 15px; border-radius: 8px; border: 1px solid var(--border-color);">
                        <h4 style="margin-bottom: 15px; color: var(--primary-color); border-bottom: 1px solid var(--border-color); padding-bottom: 8px;">ŸÖŸÑÿÆÿµ ÿßŸÑŸÜÿ≥ÿ® ŸàÿßŸÑÿ™ŸÅÿßÿµŸäŸÑ</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 15px;">
                            <div><strong>ÿßŸÑŸÜÿ≥ÿ®ÿ© :</strong> ${agentData.percentage || 0}%</div>
                            <div><strong>ÿßŸÑŸÖÿ¨ŸÖŸàÿπ ÿßŸÑŸÉŸÑŸä:</strong> ${formatNumber(agentData.iqT || 0)} ÿØ.ÿπ</div>
                            <div><strong>ŸÜÿ≥ÿ®ÿ© ÿßŸÑŸàŸÉŸäŸÑ:</strong> ${formatNumber(agentData.agentPercentageAmount || 0)} ÿØ.ÿπ</div>
                            ${agentData.deductions ? `<div style="color: #dc3545;"><strong>ÿßŸÑÿßÿ≥ÿ™ŸÇÿ∑ÿßÿπ:</strong> ${formatNumber(agentData.deductions)} ÿØ.ÿπ</div>` : '<div><strong>ÿßŸÑÿßÿ≥ÿ™ŸÇÿ∑ÿßÿπ:</strong> 0 ÿØ.ÿπ</div>'}
                            ${agentData.penalties ? `<div style="color: #dc3545;"><strong>ÿßŸÑÿ∫ÿ±ÿßŸÖÿ©:</strong> ${formatNumber(agentData.penalties)} ÿØ.ÿπ</div>` : '<div><strong>ÿßŸÑÿ∫ÿ±ÿßŸÖÿ©:</strong> 0 ÿØ.ÿπ</div>'}
                            <div style="font-weight: 700; color: var(--primary-color); font-size: 1.1rem;"><strong>ÿßŸÑÿµÿßŸÅŸä ÿßŸÑŸÜŸáÿßÿ¶Ÿä:</strong> ${formatNumber(agentData.netPercentage || 0)} ÿØ.ÿπ</div>
                        </div>`;
                        if (agentData.iqP || agentData.iqG || agentData.iqS || agentData.iqB || agentData.countP || agentData.countG || agentData.countS || agentData.countB) {
                            const totalCount = (Number(agentData.countB) || 0) + (Number(agentData.countG) || 0) + (Number(agentData.countS) || 0) + (Number(agentData.countP) || 0);
                            const totalAmount = (Number(agentData.iqB) || 0) + (Number(agentData.iqG) || 0) + (Number(agentData.iqS) || 0) + (Number(agentData.iqP) || 0);
                            html += `<div style="margin-top: 15px; padding-top: 15px; border-top: 2px solid var(--border-color);">
                                <strong style="color: var(--primary-color); font-size: 1.05rem;">ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑŸÜÿ≥ÿ®ÿ© ÿ≠ÿ≥ÿ® ŸÜŸàÿπ ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ:</strong>
                                <div style="margin-top: 15px; background: var(--bg-primary); padding: 15px; border-radius: 8px; overflow-x: auto;">
                                    <table style="width: 100%; border-collapse: collapse; min-width: 600px;">
                                        <thead>
                                            <tr style="background: var(--bg-secondary); font-weight: 600;">
                                                <th style="padding: 10px; text-align: right; border: 1px solid var(--border-color);">ŸÜŸàÿπ ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ</th>
                                                <th style="padding: 10px; text-align: center; border: 1px solid var(--border-color);">ÿßŸÑÿπÿØÿØ</th>
                                                <th style="padding: 10px; text-align: right; border: 1px solid var(--border-color);">ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä</th>
                                                <th style="padding: 10px; text-align: right; border: 1px solid var(--border-color);"> ÿßŸÑÿ≥ÿπÿ±</th>
                                                <th style="padding: 10px; text-align: right; border: 1px solid var(--border-color);">ŸÜÿ≥ÿ®ÿ© ÿßŸÑŸàŸÉŸäŸÑ (${agentData.percentage || 0}%)</th>
                                                <th style="padding: 10px; text-align: right; border: 1px solid var(--border-color);">ŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÜÿ≥ÿ®ÿ©</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                    ${agentData.countB || agentData.iqB ? `
                                                <tr style="border-bottom: 1px solid var(--border-color);">
                                                    <td style="padding: 8px; text-align: right; border: 1px solid var(--border-color); font-weight: 600; color: var(--primary-color);">Bronze </td>
                                                    <td style="padding: 8px; text-align: center; border: 1px solid var(--border-color);">${Number(agentData.countB) || 0}</td>
                                                    <td style="padding: 8px; text-align: right; border: 1px solid var(--border-color);">${formatNumber(Number(agentData.iqB) || 0)} ÿØ.ÿπ</td>
                                                    <td style="padding: 8px; text-align: right; border: 1px solid var(--border-color);">${agentData.iqB && agentData.countB ? formatNumber((Number(agentData.iqB) / Number(agentData.countB)) || 0) : 0} ÿØ.ÿπ</td>
                                                    <td style="padding: 8px; text-align: right; border: 1px solid var(--border-color);">${agentData.percentage || 0}%</td>
                                                    <td style="padding: 8px; text-align: right; border: 1px solid var(--border-color); font-weight: 600; color: #28a745;">${formatNumber(((Number(agentData.iqB) || 0) * (Number(agentData.percentage) || 0)) / 100)} ÿØ.ÿπ</td>
                                                </tr>
                                    ` : ''}
                                    ${agentData.countG || agentData.iqG ? `
                                                <tr style="border-bottom: 1px solid var(--border-color);">
                                                    <td style="padding: 8px; text-align: right; border: 1px solid var(--border-color); font-weight: 600; color: var(--primary-color);">Gold </td>
                                                    <td style="padding: 8px; text-align: center; border: 1px solid var(--border-color);">${Number(agentData.countG) || 0}</td>
                                                    <td style="padding: 8px; text-align: right; border: 1px solid var(--border-color);">${formatNumber(Number(agentData.iqG) || 0)} ÿØ.ÿπ</td>
                                                    <td style="padding: 8px; text-align: right; border: 1px solid var(--border-color);">${agentData.iqG && agentData.countG ? formatNumber((Number(agentData.iqG) / Number(agentData.countG)) || 0) : 0} ÿØ.ÿπ</td>
                                                    <td style="padding: 8px; text-align: right; border: 1px solid var(--border-color);">${agentData.percentage || 0}%</td>
                                                    <td style="padding: 8px; text-align: right; border: 1px solid var(--border-color); font-weight: 600; color: #28a745;">${formatNumber(((Number(agentData.iqG) || 0) * (Number(agentData.percentage) || 0)) / 100)} ÿØ.ÿπ</td>
                                                </tr>
                                    ` : ''}
                                    ${agentData.countS || agentData.iqS ? `
                                                <tr style="border-bottom: 1px solid var(--border-color);">
                                                    <td style="padding: 8px; text-align: right; border: 1px solid var(--border-color); font-weight: 600; color: var(--primary-color);">Silver </td>
                                                    <td style="padding: 8px; text-align: center; border: 1px solid var(--border-color);">${Number(agentData.countS) || 0}</td>
                                                    <td style="padding: 8px; text-align: right; border: 1px solid var(--border-color);">${formatNumber(Number(agentData.iqS) || 0)} ÿØ.ÿπ</td>
                                                    <td style="padding: 8px; text-align: right; border: 1px solid var(--border-color);">${agentData.iqS && agentData.countS ? formatNumber((Number(agentData.iqS) / Number(agentData.countS)) || 0) : 0} ÿØ.ÿπ</td>
                                                    <td style="padding: 8px; text-align: right; border: 1px solid var(--border-color);">${agentData.percentage || 0}%</td>
                                                    <td style="padding: 8px; text-align: right; border: 1px solid var(--border-color); font-weight: 600; color: #28a745;">${formatNumber(((Number(agentData.iqS) || 0) * (Number(agentData.percentage) || 0)) / 100)} ÿØ.ÿπ</td>
                                                </tr>
                                    ` : ''}
                                    ${agentData.countP || agentData.iqP ? `
                                                <tr style="border-bottom: 1px solid var(--border-color);">
                                                    <td style="padding: 8px; text-align: right; border: 1px solid var(--border-color); font-weight: 600; color: var(--primary-color);">Platinum </td>
                                                    <td style="padding: 8px; text-align: center; border: 1px solid var(--border-color);">${Number(agentData.countP) || 0}</td>
                                                    <td style="padding: 8px; text-align: right; border: 1px solid var(--border-color);">${formatNumber(Number(agentData.iqP) || 0)} ÿØ.ÿπ</td>
                                                    <td style="padding: 8px; text-align: right; border: 1px solid var(--border-color);">${agentData.iqP && agentData.countP ? formatNumber((Number(agentData.iqP) / Number(agentData.countP)) || 0) : 0} ÿØ.ÿπ</td>
                                                    <td style="padding: 8px; text-align: right; border: 1px solid var(--border-color);">${agentData.percentage || 0}%</td>
                                                    <td style="padding: 8px; text-align: right; border: 1px solid var(--border-color); font-weight: 600; color: #28a745;">${formatNumber(((Number(agentData.iqP) || 0) * (Number(agentData.percentage) || 0)) / 100)} ÿØ.ÿπ</td>
                                                </tr>
                                    ` : ''}
                                            <tr style="background: var(--bg-secondary); font-weight: 700; border-top: 2px solid var(--primary-color);">
                                                <td style="padding: 10px; text-align: right; border: 1px solid var(--border-color); color: var(--primary-color);">ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä</td>
                                                <td style="padding: 10px; text-align: center; border: 1px solid var(--border-color); color: var(--primary-color);">${totalCount}</td>
                                                <td style="padding: 10px; text-align: right; border: 1px solid var(--border-color); color: var(--primary-color);">${formatNumber(totalAmount)} ÿØ.ÿπ</td>
                                                <td style="padding: 10px; text-align: right; border: 1px solid var(--border-color); color: var(--primary-color);">${totalCount > 0 ? formatNumber(totalAmount / totalCount) : 0} ÿØ.ÿπ</td>
                                                <td style="padding: 10px; text-align: right; border: 1px solid var(--border-color); color: var(--primary-color);">${agentData.percentage || 0}%</td>
                                                <td style="padding: 10px; text-align: right; border: 1px solid var(--border-color); color: var(--primary-color);">${formatNumber(agentData.agentPercentageAmount || 0)} ÿØ.ÿπ</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>`;
                        }
                        html += `</div>`;
                    const agentAnalyses = [];
                    const agentFromList = agentsListMap[agentName];
                    const getAgentResults = (archiveData, agentName, type) => {
                        if (!archiveData || !archiveData.data) {
                            return null;
                        }
                        if (archiveData.data.agentReports && archiveData.data.agentReports[agentName]) {
                            const agentReport = archiveData.data.agentReports[agentName];
                            if (type === 'basic' && agentReport.basic) {
                                return agentReport.basic;
                            }
                            if (type === 'advanced' && agentReport.advanced) {
                                return agentReport.advanced;
                            }
                            if (type === 'two_months' && agentReport.twoMonths) {
                                return agentReport.twoMonths;
                            }
                        }
                        if (archiveData.data.results) {
                            const results = archiveData.data.results;
                            if (results.agentName === agentName) {
                                return results;
                            }
                            if (typeof results === 'object' && results[agentName]) {
                                if (type === 'basic' && results[agentName].basic) return results[agentName].basic;
                                if (type === 'advanced' && results[agentName].advanced) return results[agentName].advanced;
                                if (type === 'two_months' && results[agentName].twoMonths) return results[agentName].twoMonths;
                            }
                        }
                        return null;
                    };
                    if (agentFromList && agentFromList.offers) {
                        if (agentFromList.offers.basic) {
                            const basicResults = agentFromList.offers.basic;
                            const basicDetails = agentFromList.details && agentFromList.details.basic ? agentFromList.details.basic : [];
                            if (!agentAnalyses.find(a => a.type === 'basic')) {
                                agentAnalyses.push({
                                    type: 'basic',
                                    name: 'ÿßŸÑÿπÿ±ÿ∂ ÿßŸÑŸÖÿ¨ÿßŸÜŸä',
                                    results: basicResults,
                                    details: basicDetails,
                                    fileData: []
                                });
                            }
                        }
                        if (agentFromList.offers.advanced) {
                            const advancedResults = agentFromList.offers.advanced;
                            const advancedDetails = agentFromList.details && agentFromList.details.advanced ? agentFromList.details.advanced : [];
                            if (!agentAnalyses.find(a => a.type === 'advanced')) {
                                agentAnalyses.push({
                                    type: 'advanced',
                                    name: 'ÿπÿ±ÿ∂ 3 ÿ£ÿ¥Ÿáÿ± ŸÖÿÆŸÅÿ∂',
                                    results: advancedResults,
                                    details: advancedDetails,
                                    fileData: []
                                });
                            }
                        }
                        if (agentFromList.offers.twoMonths) {
                            const twoMonthsResults = agentFromList.offers.twoMonths;
                            const twoMonthsDetails = agentFromList.details && agentFromList.details.twoMonths ? agentFromList.details.twoMonths : [];
                            if (!agentAnalyses.find(a => a.type === 'two_months')) {
                                agentAnalyses.push({
                                    type: 'two_months',
                                    name: 'ÿπÿ±ÿ∂ ÿ¥Ÿáÿ±ŸäŸÜ ŸÖÿÆŸÅÿ∂',
                                    results: twoMonthsResults,
                                    details: twoMonthsDetails,
                                    fileData: []
                                });
                            }
                        }
                    }
                    if (basicArchive && basicArchive.data) {
                        const agentDetails = (basicArchive.data.details || []).filter(d => {
                            const agent = d.agent || d.Agent || d.agentName || d.AgentName || d['ÿßÿ≥ŸÖ ÿßŸÑŸàŸÉŸäŸÑ'] || d['ÿßŸÑŸàŸÉŸäŸÑ'];
                            return agent === agentName;
                        });
                        const basicResults = getAgentResults(basicArchive, agentName, 'basic');
                        let directResults = null;
                        if (basicArchive.data.results) {
                            if (basicArchive.data.results.agentName === agentName) {
                                directResults = basicArchive.data.results;
                            }
                        }
                        const finalResults = basicResults || directResults;
                        const hasArchive = basicArchive.data && Object.keys(basicArchive.data).length > 0;
                        const hasAgentData = finalResults || agentDetails.length > 0 || hasArchive;
                        if (hasAgentData || hasArchive) {
                            if (!agentAnalyses.find(a => a.type === 'basic')) {
                            const agentFileData = Array.isArray(basicArchive.data.data) ? 
                                basicArchive.data.data.filter(d => {
                                    const agent = d.agent || d.Agent || d.agentName || d.AgentName || d['ÿßÿ≥ŸÖ ÿßŸÑŸàŸÉŸäŸÑ'] || d['ÿßŸÑŸàŸÉŸäŸÑ'];
                                    return agent === agentName;
                                }) : [];
                            agentAnalyses.push({
                                type: 'basic',
                                name: 'ÿßŸÑÿπÿ±ÿ∂ ÿßŸÑŸÖÿ¨ÿßŸÜŸä',
                                results: finalResults,
                                details: agentDetails,
                                fileData: agentFileData.length > 0 ? agentFileData : null
                            });
                            }
                        }
                    } else {
                    }
                    if (advancedArchive && advancedArchive.data) {
                        const agentDetails = (advancedArchive.data.details || []).filter(d => {
                            const agent = d.agent || d.Agent || d.agentName || d.AgentName || d['ÿßÿ≥ŸÖ ÿßŸÑŸàŸÉŸäŸÑ'] || d['ÿßŸÑŸàŸÉŸäŸÑ'];
                            return agent === agentName;
                        });
                        const advancedResults = getAgentResults(advancedArchive, agentName, 'advanced');
                        let directResults = null;
                        if (advancedArchive.data.results) {
                            if (advancedArchive.data.results.agentName === agentName) {
                                directResults = advancedArchive.data.results;
                            }
                        }
                        const finalResults = advancedResults || directResults;
                        const hasArchive = advancedArchive.data && Object.keys(advancedArchive.data).length > 0;
                        const hasAgentData = finalResults || agentDetails.length > 0 || hasArchive;
                        if (hasAgentData || hasArchive) {
                            if (!agentAnalyses.find(a => a.type === 'advanced')) {
                            const agentFileData = Array.isArray(advancedArchive.data.data) ? 
                                advancedArchive.data.data.filter(d => {
                                    const agent = d.agent || d.Agent || d.agentName || d.AgentName || d['ÿßÿ≥ŸÖ ÿßŸÑŸàŸÉŸäŸÑ'] || d['ÿßŸÑŸàŸÉŸäŸÑ'];
                                    return agent === agentName;
                                }) : [];
                            agentAnalyses.push({
                                type: 'advanced',
                                name: '3 ÿ£ÿ¥Ÿáÿ± ŸÖÿÆŸÅÿ∂',
                                results: finalResults,
                                details: agentDetails,
                                fileData: agentFileData.length > 0 ? agentFileData : null
                            });
                            }
                        }
                    } else {
                    }
                    if (twoMonthsArchive && twoMonthsArchive.data) {
                        const agentDetails = (twoMonthsArchive.data.details || []).filter(d => {
                            const agent = d.agent || d.Agent || d.agentName || d.AgentName || d['ÿßÿ≥ŸÖ ÿßŸÑŸàŸÉŸäŸÑ'] || d['ÿßŸÑŸàŸÉŸäŸÑ'];
                            return agent === agentName;
                        });
                        const twoMonthsResults = getAgentResults(twoMonthsArchive, agentName, 'two_months');
                        let directResults = null;
                        if (twoMonthsArchive.data.results) {
                            if (twoMonthsArchive.data.results.agentName === agentName) {
                                directResults = twoMonthsArchive.data.results;
                            }
                        }
                        const finalResults = twoMonthsResults || directResults;
                        const hasArchive = twoMonthsArchive.data && Object.keys(twoMonthsArchive.data).length > 0;
                        const hasAgentData = finalResults || agentDetails.length > 0 || hasArchive;
                        if (hasAgentData || hasArchive) {
                            if (!agentAnalyses.find(a => a.type === 'two_months')) {
                            const agentFileData = Array.isArray(twoMonthsArchive.data.data) ? 
                                twoMonthsArchive.data.data.filter(d => {
                                    const agent = d.agent || d.Agent || d.agentName || d.AgentName || d['ÿßÿ≥ŸÖ ÿßŸÑŸàŸÉŸäŸÑ'] || d['ÿßŸÑŸàŸÉŸäŸÑ'];
                                    return agent === agentName;
                                }) : [];
                            agentAnalyses.push({
                                type: 'two_months',
                                name: 'ÿ¥Ÿáÿ±ŸäŸÜ ŸÖÿÆŸÅÿ∂',
                                results: finalResults,
                                details: agentDetails,
                                fileData: agentFileData.length > 0 ? agentFileData : null
                            });
                            }
                        }
                    } else {
                    }
                    if (agentAnalyses.length > 0) {
                        html += `<div style="margin-bottom: 20px;">
                            <h4 style="margin-bottom: 15px; color: var(--primary-color);">ÿ™ÿ≠ŸÑŸäŸÑÿßÿ™ ÿßŸÑÿπÿ±Ÿàÿ∂</h4>`;
                        agentAnalyses.forEach(analysis => {
                            html += `<div style="margin-bottom: 20px; background: var(--bg-secondary); padding: 15px; border-radius: 8px; border-left: 4px solid var(--primary-color);">
                                <h5 style="margin-bottom: 10px; color: var(--primary-color);">${analysis.name}</h5>`;
                            if (analysis.results && analysis.results.total) {
                                html += `<div style="background: var(--bg-primary); padding: 12px; border-radius: 6px; margin-bottom: 15px; border: 1px solid var(--border-color);">
                                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-bottom: 10px;">
                                        <div><strong>ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉÿßÿ™:</strong> ${analysis.results.total.count || 0}</div>
                                        ${analysis.results.total.amount ? `<div><strong>ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä:</strong> ${formatNumber(analysis.results.total.amount)} ÿØ.ÿπ</div>` : ''}
                                        ${analysis.results.total.promoAmount ? `<div><strong>ŸÖÿ®ŸÑÿ∫ ÿßŸÑÿπÿ±ÿ∂:</strong> ${formatNumber(analysis.results.total.promoAmount)} ÿØ.ÿπ</div>` : ''}
                                        ${analysis.results.total.officialAmount ? `<div><strong>ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑÿ±ÿ≥ŸÖŸä:</strong> ${formatNumber(analysis.results.total.officialAmount)} ÿØ.ÿπ</div>` : ''}
                                        ${analysis.results.total.profit ? `<div style="font-weight: 700; color: #28a745;"><strong>ÿßŸÑÿ±ÿ®ÿ≠/ÿßŸÑÿ±ÿßÿ¨ÿπ:</strong> ${formatNumber(analysis.results.total.profit)} ÿØ.ÿπ</div>` : ''}
                                    </div>`;
                                if (analysis.results.bronze || analysis.results.silver || analysis.results.gold || analysis.results.platinum) {
                                    html += `<div style="margin-top: 15px; padding-top: 15px; border-top: 2px solid var(--border-color);">
                                        <strong style="color: var(--primary-color);">ÿ™ŸÅÿßÿµŸäŸÑ ÿ≠ÿ≥ÿ® ŸÜŸàÿπ ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ:</strong>
                                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; margin-top: 10px;">
                                            ${analysis.results.bronze ? `
                                                <div style="background: var(--bg-secondary); padding: 10px; border-radius: 6px; border: 1px solid var(--border-color);">
                                                    <div style="font-weight: 600; color: var(--primary-color); margin-bottom: 5px;">Bronze</div>
                                                    <div style="font-size: 0.9rem;"><strong>ÿßŸÑÿπÿØÿØ:</strong> ${analysis.results.bronze.count || 0}</div>
                                                    ${analysis.results.bronze.amount ? `<div style="font-size: 0.9rem;"><strong>ÿßŸÑŸÖÿ®ŸÑÿ∫:</strong> ${formatNumber(analysis.results.bronze.amount)} ÿØ.ÿπ</div>` : ''}
                                                    ${analysis.results.bronze.promoAmount ? `<div style="font-size: 0.85rem; color: var(--text-secondary);"><strong>ÿπÿ±ÿ∂:</strong> ${formatNumber(analysis.results.bronze.promoAmount)} ÿØ.ÿπ</div>` : ''}
                                                    ${analysis.results.bronze.officialAmount ? `<div style="font-size: 0.85rem; color: var(--text-secondary);"><strong>ÿ±ÿ≥ŸÖŸä:</strong> ${formatNumber(analysis.results.bronze.officialAmount)} ÿØ.ÿπ</div>` : ''}
                                                </div>
                                            ` : ''}
                                            ${analysis.results.silver ? `
                                                <div style="background: var(--bg-secondary); padding: 10px; border-radius: 6px; border: 1px solid var(--border-color);">
                                                    <div style="font-weight: 600; color: var(--primary-color); margin-bottom: 5px;">Silver</div>
                                                    <div style="font-size: 0.9rem;"><strong>ÿßŸÑÿπÿØÿØ:</strong> ${analysis.results.silver.count || 0}</div>
                                                    ${analysis.results.silver.amount ? `<div style="font-size: 0.9rem;"><strong>ÿßŸÑŸÖÿ®ŸÑÿ∫:</strong> ${formatNumber(analysis.results.silver.amount)} ÿØ.ÿπ</div>` : ''}
                                                    ${analysis.results.silver.promoAmount ? `<div style="font-size: 0.85rem; color: var(--text-secondary);"><strong>ÿπÿ±ÿ∂:</strong> ${formatNumber(analysis.results.silver.promoAmount)} ÿØ.ÿπ</div>` : ''}
                                                    ${analysis.results.silver.officialAmount ? `<div style="font-size: 0.85rem; color: var(--text-secondary);"><strong>ÿ±ÿ≥ŸÖŸä:</strong> ${formatNumber(analysis.results.silver.officialAmount)} ÿØ.ÿπ</div>` : ''}
                                                </div>
                                            ` : ''}
                                            ${analysis.results.gold ? `
                                                <div style="background: var(--bg-secondary); padding: 10px; border-radius: 6px; border: 1px solid var(--border-color);">
                                                    <div style="font-weight: 600; color: var(--primary-color); margin-bottom: 5px;">Gold</div>
                                                    <div style="font-size: 0.9rem;"><strong>ÿßŸÑÿπÿØÿØ:</strong> ${analysis.results.gold.count || 0}</div>
                                                    ${analysis.results.gold.amount ? `<div style="font-size: 0.9rem;"><strong>ÿßŸÑŸÖÿ®ŸÑÿ∫:</strong> ${formatNumber(analysis.results.gold.amount)} ÿØ.ÿπ</div>` : ''}
                                                    ${analysis.results.gold.promoAmount ? `<div style="font-size: 0.85rem; color: var(--text-secondary);"><strong>ÿπÿ±ÿ∂:</strong> ${formatNumber(analysis.results.gold.promoAmount)} ÿØ.ÿπ</div>` : ''}
                                                    ${analysis.results.gold.officialAmount ? `<div style="font-size: 0.85rem; color: var(--text-secondary);"><strong>ÿ±ÿ≥ŸÖŸä:</strong> ${formatNumber(analysis.results.gold.officialAmount)} ÿØ.ÿπ</div>` : ''}
                                                </div>
                                            ` : ''}
                                            ${analysis.results.platinum ? `
                                                <div style="background: var(--bg-secondary); padding: 10px; border-radius: 6px; border: 1px solid var(--border-color);">
                                                    <div style="font-weight: 600; color: var(--primary-color); margin-bottom: 5px;">Platinum</div>
                                                    <div style="font-size: 0.9rem;"><strong>ÿßŸÑÿπÿØÿØ:</strong> ${analysis.results.platinum.count || 0}</div>
                                                    ${analysis.results.platinum.amount ? `<div style="font-size: 0.9rem;"><strong>ÿßŸÑŸÖÿ®ŸÑÿ∫:</strong> ${formatNumber(analysis.results.platinum.amount)} ÿØ.ÿπ</div>` : ''}
                                                    ${analysis.results.platinum.promoAmount ? `<div style="font-size: 0.85rem; color: var(--text-secondary);"><strong>ÿπÿ±ÿ∂:</strong> ${formatNumber(analysis.results.platinum.promoAmount)} ÿØ.ÿπ</div>` : ''}
                                                    ${analysis.results.platinum.officialAmount ? `<div style="font-size: 0.85rem; color: var(--text-secondary);"><strong>ÿ±ÿ≥ŸÖŸä:</strong> ${formatNumber(analysis.results.platinum.officialAmount)} ÿØ.ÿπ</div>` : ''}
                                                </div>
                                            ` : ''}
                                        </div>
                                    </div>`;
                                }
                                html += `</div>`;
                            } else if (analysis.details && Array.isArray(analysis.details) && analysis.details.length > 0) {
                                const totalCount = analysis.details.length;
                                let totalAmount = 0;
                                let totalPromoAmount = 0;
                                let totalOfficialAmount = 0;
                                analysis.details.forEach(detail => {
                                    if (detail.price) totalAmount += Number(detail.price) || 0;
                                    if (detail.promoPrice) totalPromoAmount += Number(detail.promoPrice) || 0;
                                    if (detail.officialPrice) totalOfficialAmount += Number(detail.officialPrice) || 0;
                                });
                                html += `<div style="background: var(--bg-primary); padding: 12px; border-radius: 6px; margin-bottom: 15px; border: 1px solid var(--border-color);">
                                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-bottom: 10px;">
                                        <div><strong>ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉÿßÿ™:</strong> ${totalCount}</div>
                                        ${totalAmount > 0 ? `<div><strong>ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä:</strong> ${formatNumber(totalAmount)} ÿØ.ÿπ</div>` : ''}
                                        ${totalPromoAmount > 0 ? `<div><strong>ŸÖÿ®ŸÑÿ∫ ÿßŸÑÿπÿ±ÿ∂:</strong> ${formatNumber(totalPromoAmount)} ÿØ.ÿπ</div>` : ''}
                                        ${totalOfficialAmount > 0 ? `<div><strong>ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑÿ±ÿ≥ŸÖŸä:</strong> ${formatNumber(totalOfficialAmount)} ÿØ.ÿπ</div>` : ''}
                                        ${totalOfficialAmount > 0 && totalPromoAmount > 0 ? `<div style="font-weight: 700; color: #28a745;"><strong>ÿßŸÑÿ±ÿ®ÿ≠/ÿßŸÑÿ±ÿßÿ¨ÿπ:</strong> ${formatNumber(totalOfficialAmount - totalPromoAmount)} ÿØ.ÿπ</div>` : ''}
                                    </div>
                                </div>`;
                            } else {
                                html += `<div style="background: var(--bg-primary); padding: 12px; border-radius: 6px; margin-bottom: 15px; border: 1px solid var(--border-color); text-align: center; color: var(--text-secondary);">
                                    <p>ÿßŸÑÿ£ÿ±ÿ¥ŸäŸÅ ŸÖŸàÿ¨ŸàÿØ ŸÑŸáÿ∞ÿß ÿßŸÑÿπÿ±ÿ∂ ŸàŸÑŸÉŸÜ ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ™ŸÅÿßÿµŸäŸÑ ŸÖÿ≠ÿØÿØÿ© ŸÑŸáÿ∞ÿß ÿßŸÑŸàŸÉŸäŸÑ</p>
                                    <p style="font-size: 0.9rem; margin-top: 5px;">ŸÇÿØ ÿ™ŸÉŸàŸÜ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖÿ≠ŸÅŸàÿ∏ÿ© ÿ®ÿ¥ŸÉŸÑ ŸÖÿÆÿ™ŸÑŸÅ ÿ£Ÿà ŸÑŸÖ Ÿäÿ™ŸÖ ÿ™ÿ≠ŸÑŸäŸÑŸáÿß ŸÑŸáÿ∞ÿß ÿßŸÑŸàŸÉŸäŸÑ</p>
                                </div>`;
                            }
                            if (analysis.details && analysis.details.length > 0) {
                                html += `<div style="margin-top: 15px;">
                                    <strong style="color: var(--primary-color); font-size: 1.05rem;">ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉÿßÿ™ ÿßŸÑŸÉÿßŸÖŸÑÿ© (${analysis.details.length}):</strong>
                                    <div style="background: var(--bg-primary); padding: 10px; border-radius: 8px; margin-top: 5px; max-height: 600px; overflow-y: auto; overflow-x: auto; font-size: 0.85rem;">
                                        <table style="width: 100%; border-collapse: collapse; min-width: 800px;">
                                            <thead>
                                                <tr style="background: var(--bg-secondary); font-weight: 600; position: sticky; top: 0; z-index: 10;">
                                                    <th style="padding: 8px; text-align: center; border: 1px solid var(--border-color);">#</th>
                                                    <th style="padding: 8px; text-align: right; border: 1px solid var(--border-color);">ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ</th>
                                                    <th style="padding: 8px; text-align: right; border: 1px solid var(--border-color);">ŸÜŸàÿπ ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ</th>
                                                    <th style="padding: 8px; text-align: right; border: 1px solid var(--border-color);">ÿßŸÑÿ™ÿßÿ±ŸäÿÆ</th>
                                                    <th style="padding: 8px; text-align: right; border: 1px solid var(--border-color);">ÿßŸÑÿ≥ÿπÿ±</th>
                                                    <th style="padding: 8px; text-align: right; border: 1px solid var(--border-color);">ÿ≥ÿπÿ± ÿßŸÑÿπÿ±ÿ∂</th>
                                                    <th style="padding: 8px; text-align: right; border: 1px solid var(--border-color);">ÿßŸÑÿ≥ÿπÿ± ÿßŸÑÿ±ÿ≥ŸÖŸä</th>
                                                    ${analysis.type === 'advanced' || analysis.type === 'two_months' ? `
                                                        <th style="padding: 8px; text-align: right; border: 1px solid var(--border-color);">ÿ™ÿßÿ±ŸäÿÆ 1</th>
                                                        <th style="padding: 8px; text-align: right; border: 1px solid var(--border-color);">ÿ™ÿßÿ±ŸäÿÆ 2</th>
                                                        ${analysis.type === 'advanced' ? `<th style="padding: 8px; text-align: right; border: 1px solid var(--border-color);">ÿ™ÿßÿ±ŸäÿÆ 3</th>` : ''}
                                                        <th style="padding: 8px; text-align: center; border: 1px solid var(--border-color);">ÿßŸÑŸÅÿ±ŸÇ ÿ®ÿßŸÑÿ£ŸäÿßŸÖ</th>
                                                    ` : ''}
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${(Array.isArray(analysis.details) ? analysis.details : []).map((detail, idx) => {
                                                    const date1 = detail.date1 || '';
                                                    const date2 = detail.date2 || '';
                                                    const date3 = detail.date3 || '';
                                                    const dateStr = detail.dateStr || detail.date || detail.createdAt || date1 || '';
                                                    let price = detail.price;
                                                    let promoPrice = detail.promoPrice;
                                                    let officialPrice = detail.officialPrice;
                                                    if (!price && !promoPrice && !officialPrice && detail.subscription) {
                                                        const category = getSubscriptionCategory(detail.subscription, detail.agent || '');
                                                        if (category) {
                                                            if (analysis.type === 'basic') {
                                                                price = getSubscriptionPrice(detail.subscription, category, 'basic');
                                                                promoPrice = price;
                                                                officialPrice = price;
                                                            } else if (analysis.type === 'advanced') {
                                                                promoPrice = getSubscriptionPrice(detail.subscription, category, 'advanced', 'promo');
                                                                officialPrice = getSubscriptionPrice(detail.subscription, category, 'advanced', 'official');
                                                            } else if (analysis.type === 'two_months') {
                                                                promoPrice = getSubscriptionPrice(detail.subscription, category, 'twoMonths', 'promo');
                                                                const monthlyOfficialPrice = getSubscriptionPrice(detail.subscription, category, 'basic');
                                                                officialPrice = monthlyOfficialPrice * 2;
                                                            }
                                                        }
                                                    }
                                                    const priceStr = price ? formatNumber(price) + ' ÿØ.ÿπ' : '-';
                                                    const promoPriceStr = promoPrice ? formatNumber(promoPrice) + ' ÿØ.ÿπ' : '-';
                                                    const officialPriceStr = officialPrice ? formatNumber(officialPrice) + ' ÿØ.ÿπ' : '-';
                                                    return `
                                                    <tr style="border-bottom: 1px solid var(--border-color); ${idx % 2 === 0 ? 'background: var(--bg-primary);' : 'background: var(--card-bg);'}">
                                                        <td style="padding: 6px; text-align: center; border: 1px solid var(--border-color);">${idx + 1}</td>
                                                        <td style="padding: 6px; text-align: right; border: 1px solid var(--border-color);">${detail.username || ''}</td>
                                                        <td style="padding: 6px; text-align: right; border: 1px solid var(--border-color);">${detail.subscription || ''}</td>
                                                        <td style="padding: 6px; text-align: right; border: 1px solid var(--border-color);">${dateStr}</td>
                                                        <td style="padding: 6px; text-align: right; border: 1px solid var(--border-color);">${priceStr}</td>
                                                        <td style="padding: 6px; text-align: right; border: 1px solid var(--border-color); color: #28a745; font-weight: 600;">${promoPriceStr}</td>
                                                        <td style="padding: 6px; text-align: right; border: 1px solid var(--border-color); color: #dc3545; font-weight: 600;">${officialPriceStr}</td>
                                                        ${analysis.type === 'advanced' || analysis.type === 'two_months' ? `
                                                            <td style="padding: 6px; text-align: right; border: 1px solid var(--border-color);">${date1}</td>
                                                            <td style="padding: 6px; text-align: right; border: 1px solid var(--border-color);">${date2}</td>
                                                            ${analysis.type === 'advanced' ? `<td style="padding: 6px; text-align: right; border: 1px solid var(--border-color);">${date3}</td>` : ''}
                                                            <td style="padding: 6px; text-align: center; border: 1px solid var(--border-color); font-weight: 600;">${detail.daysDiff !== undefined && detail.daysDiff !== null ? detail.daysDiff : '-'}</td>
                                                        ` : ''}
                                                    </tr>
                                                `;
                                                }).join('')}
                                            </tbody>
                                        </table>
                                    </div>
                                    <div style="margin-top: 10px; padding: 10px; background: var(--bg-secondary); border-radius: 6px; text-align: center; color: var(--text-secondary); font-size: 0.9rem;">
                                        <strong>ÿ•ÿ¨ŸÖÿßŸÑŸä:</strong> ${analysis.details.length} ÿßÿ¥ÿ™ÿ±ÿßŸÉ
                                    </div>
                                </div>`;
                            }
                            if (analysis.fileData && Array.isArray(analysis.fileData) && analysis.fileData.length > 0) {
                                html += `<div style="margin-top: 15px;">
                                    <strong>ÿßŸÑŸÖŸÑŸÅ ÿßŸÑŸÖÿ≠ŸÖŸÑ:</strong>
                                    <div style="background: var(--bg-primary); padding: 10px; border-radius: 8px; margin-top: 5px; font-size: 0.9rem;">
                                        ÿπÿØÿØ ÿßŸÑÿ≥ÿ¨ŸÑÿßÿ™: ${analysis.fileData.length}
                                    </div>
                                </div>`;
                            }
                            html += `</div>`;
                        });
                        html += `</div>`;
                    } else {
                        html += `<div style="margin-bottom: 20px; padding: 15px; background: var(--bg-secondary); border-radius: 8px; text-align: center; color: var(--text-secondary);">
                            <p>ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ™ÿ≠ŸÑŸäŸÑÿßÿ™ ŸÖÿ≥ÿ¨ŸÑÿ© ŸÑŸáÿ∞ÿß ÿßŸÑŸàŸÉŸäŸÑ ŸÅŸä ÿßŸÑÿ£ÿ±ÿ¥ŸäŸÅ</p>
                            <p style="font-size: 0.9rem; margin-top: 10px; color: var(--text-tertiary);">ÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑÿπÿ±Ÿàÿ∂ ÿ£ŸàŸÑÿßŸã ŸÖŸÜ ÿµŸÅÿ≠ÿßÿ™ "ÿßŸÑÿπÿ±ÿ∂ ÿßŸÑŸÖÿ¨ÿßŸÜŸä" ÿ£Ÿà "3 ÿ£ÿ¥Ÿáÿ± ŸÖÿÆŸÅÿ∂" ÿ£Ÿà "ÿ¥Ÿáÿ±ŸäŸÜ ŸÖÿÆŸÅÿ∂"</p>
                        </div>`;
                    }
                    html += `</div>`;
                }
                if (currentUserRole === 'admin') {
                    html += `
                        <div style="margin-top: 30px; padding: 20px; background: rgba(220, 53, 69, 0.1); border-radius: 12px; border: 2px solid rgba(220, 53, 69, 0.3);">
                            <h4 style="color: #dc3545; margin-bottom: 15px; font-weight: 700;">‚ö†Ô∏è ŸÖŸÜÿ∑ŸÇÿ© ÿßŸÑŸÖÿØŸäÿ± - ÿ≠ÿ∞ŸÅ ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑŸàŸÉŸäŸÑ</h4>
                            <p style="color: var(--text-secondary); margin-bottom: 15px; font-size: 0.95rem;">ŸäŸÖŸÉŸÜŸÉ ÿ≠ÿ∞ŸÅ ÿ™ŸÅÿßÿµŸäŸÑ Ÿáÿ∞ÿß ÿßŸÑŸàŸÉŸäŸÑ ŸÖŸÜ ÿßŸÑÿ£ÿ±ÿ¥ŸäŸÅ. ÿ≥Ÿäÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ™ÿ≠ŸÑŸäŸÑÿßÿ™ ŸàÿßŸÑÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑŸÖÿ≠ŸÅŸàÿ∏ÿ© ŸÑŸáÿ∞ÿß ÿßŸÑŸàŸÉŸäŸÑ ŸÖŸÜ ÿ¨ŸÖŸäÿπ ÿ£ŸÜŸàÿßÿπ ÿßŸÑÿπÿ±Ÿàÿ∂.</p>
                            <button class="btn btn-danger" onclick="deleteAgentFromArchive('${displayName}', '${monthYear}')" style="padding: 12px 24px; font-weight: 600; font-size: 1rem;">
                                üóëÔ∏è ÿ≠ÿ∞ŸÅ ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑŸàŸÉŸäŸÑ "${displayName}" ŸÖŸÜ ÿßŸÑÿ£ÿ±ÿ¥ŸäŸÅ
                            </button>
                        </div>
                    `;
                }
                if (false) {
                container.innerHTML = html;
                }
            } catch (error) {
                console.error('Error loading archive:', error);
                const errorMessage = error.message || 'ÿÆÿ∑ÿ£ ÿ∫Ÿäÿ± ŸÖÿπÿ±ŸàŸÅ';
                const errorDetails = error.details || error.hint || '';
                const container = document.getElementById('archiveContent');
                if (container) {
                    container.innerHTML = `
                    <div style="padding: 20px; text-align: center;">
                        <h4 style="color: #dc3545; margin-bottom: 15px;">‚ö†Ô∏è ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ£ÿ±ÿ¥ŸäŸÅ</h4>
                        <p style="color: var(--text-secondary); margin-bottom: 10px;"><strong>ÿßŸÑÿÆÿ∑ÿ£:</strong> ${errorMessage}</p>
                        ${errorDetails ? `<p style="color: var(--text-tertiary); font-size: 0.9rem;">${errorDetails}</p>` : ''}
                        <div style="margin-top: 20px; padding: 15px; background: var(--bg-secondary); border-radius: 8px; text-align: right;">
                            <p style="font-weight: 600; margin-bottom: 10px;">ÿ≠ŸÑŸàŸÑ ŸÖŸÇÿ™ÿ±ÿ≠ÿ©:</p>
                            <ul style="text-align: right; font-size: 0.9rem;">
                                <li>ÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿßÿ™ÿµÿßŸÑ ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™</li>
                                <li>ÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ£ŸÜ ÿßŸÑÿ¥Ÿáÿ± ÿßŸÑŸÖÿ≠ÿØÿØ ÿµÿ≠Ÿäÿ≠ (${monthYear})</li>
                                <li>ÿ™ÿ£ŸÉÿØ ŸÖŸÜ Ÿàÿ¨ŸàÿØ ÿ®ŸäÿßŸÜÿßÿ™ ŸÖÿ≠ŸÅŸàÿ∏ÿ© ŸÑŸáÿ∞ÿß ÿßŸÑÿ¥Ÿáÿ±</li>
                                <li>ÿ≠ÿßŸàŸÑ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿµŸÅÿ≠ÿ©</li>
                            </ul>
                        </div>
                    </div>`;
                }
            }
        }
        function filterArchiveAgents(searchQuery) {
            const searchLower = searchQuery.toLowerCase().trim();
            const agentCards = document.querySelectorAll('.archive-agent-card');
            if (!searchLower) {
                agentCards.forEach(card => {
                    card.style.display = 'block';
                });
                return;
            }
            agentCards.forEach(card => {
                const agentName = card.getAttribute('data-agent-name') || '';
                if (agentName.toLowerCase().includes(searchLower)) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        }
        async function showArchiveAgentDetails(normalizedName, monthYear = null) {
            if (!monthYear) {
                monthYear = window.currentArchiveMonthYear || getCurrentMonthYear();
            }
            const agentsListContainer = document.getElementById('archiveAgentsList');
            const archiveContent = document.getElementById('archiveContent');
            if (agentsListContainer) {
                agentsListContainer.style.display = 'none';
            }
            if (archiveContent) {
                archiveContent.style.display = 'block';
                archiveContent.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑŸàŸÉŸäŸÑ...</p>';
            }
            if (!supabaseClient) {
                archiveContent.innerHTML = '<p style="color: red;">Supabase ÿ∫Ÿäÿ± ŸÖÿ™ÿµŸÑ</p>';
                return;
            }
            try {
                const storedPercentages = window.currentArchivePercentages || {};
                const agentData = storedPercentages[normalizedName];
                const displayName = agentData?.originalName || normalizedName;
                if (!agentData) {
                    archiveContent.innerHTML = `
                        <div style="text-align: center; padding: 20px;">
                            <button class="btn btn-secondary" onclick="goBackToArchiveAgentsList()" style="margin-bottom: 20px; background: linear-gradient(135deg, #801c32, #a52d45); color: #fff; border: none; padding: 12px 24px; font-weight: 700; box-shadow: 0 4px 12px rgba(128, 28, 50, 0.3); transition: all 0.3s ease;">‚Üê ÿßŸÑÿπŸàÿØÿ© ÿ•ŸÑŸâ ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸàŸÉŸÑÿßÿ°</button>
                            <p style="color: var(--text-secondary);">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™ ŸÑŸáÿ∞ÿß ÿßŸÑŸàŸÉŸäŸÑ ŸÅŸä ÿßŸÑÿ£ÿ±ÿ¥ŸäŸÅ</p>
                        </div>
                    `;
                    return;
                }
                const percentagesArchive = await getArchiveForMonth('agent_percentages', monthYear);
                const { data: basicArchiveData } = await supabaseClient.from('analysis_archives').select('*').eq('month_year', monthYear).eq('analysis_type', 'basic').maybeSingle();
                const { data: advancedArchiveData } = await supabaseClient.from('analysis_archives').select('*').eq('month_year', monthYear).eq('analysis_type', 'advanced').maybeSingle();
                const { data: twoMonthsArchiveData } = await supabaseClient.from('analysis_archives').select('*').eq('month_year', monthYear).eq('analysis_type', 'two_months').maybeSingle();
                const possibleNames = [displayName, normalizedName];
                if (percentagesArchive && percentagesArchive.data) {
                    Object.keys(percentagesArchive.data).forEach(name => {
                        if (normalizeAgentName(name) === normalizedName) {
                            possibleNames.push(name);
                        }
                    });
                }
                const filterDetailsByAgent = (details, agentNames) => {
                    if (!details || !Array.isArray(details)) return [];
                    return details.filter(d => {
                        const agent = d.agent || d.Agent || d.agentName || d.AgentName || d['ÿßÿ≥ŸÖ ÿßŸÑŸàŸÉŸäŸÑ'] || d['ÿßŸÑŸàŸÉŸäŸÑ'];
                        return agentNames.some(name => normalizeAgentName(agent) === normalizeAgentName(name));
                    });
                };
                const getAgentResultsFromArchive = (archiveData, agentNames, type) => {
                    if (!archiveData || !archiveData.data) return null;
                    for (const agentName of agentNames) {
                    if (archiveData.data.agentReports && archiveData.data.agentReports[agentName]) {
                        const agentReport = archiveData.data.agentReports[agentName];
                        if (type === 'basic' && agentReport.basic) return agentReport.basic;
                        if (type === 'advanced' && agentReport.advanced) return agentReport.advanced;
                        if (type === 'two_months' && agentReport.twoMonths) return agentReport.twoMonths;
                    }
                    if (archiveData.data.results) {
                        if (archiveData.data.results.agentName === agentName) {
                            return archiveData.data.results;
                        }
                        if (archiveData.data.results[agentName]) {
                            if (type === 'basic' && archiveData.data.results[agentName].basic) return archiveData.data.results[agentName].basic;
                            if (type === 'advanced' && archiveData.data.results[agentName].advanced) return archiveData.data.results[agentName].advanced;
                            if (type === 'two_months' && archiveData.data.results[agentName].twoMonths) return archiveData.data.results[agentName].twoMonths;
                        }
                    }
                    }
                    return null;
                };
                const basicArchive = basicArchiveData ? { data: basicArchiveData.data, raw: basicArchiveData } : null;
                const advancedArchive = advancedArchiveData ? { data: advancedArchiveData.data, raw: advancedArchiveData } : null;
                const twoMonthsArchive = twoMonthsArchiveData ? { data: twoMonthsArchiveData.data, raw: twoMonthsArchiveData } : null;
                
                const { data: agentsListArchive } = await supabaseClient
                    .from('agents_list')
                    .select('*')
                    .eq('month_year', monthYear)
                    .maybeSingle();
                
                let savedBasicResults = null;
                let savedAdvancedResults = null;
                let savedTwoMonthsResults = null;
                let savedBasicDetails = [];
                let savedAdvancedDetails = [];
                let savedTwoMonthsDetails = [];
                
                if (agentsListArchive && agentsListArchive.data && Array.isArray(agentsListArchive.data)) {
                    const agentFromList = agentsListArchive.data.find(a => {
                        if (!a || !a.name) return false;
                        return possibleNames.some(name => normalizeAgentName(a.name) === normalizeAgentName(name));
                    });
                    
                    if (agentFromList) {
                        if (agentFromList.offers && agentFromList.offers.basic) {
                            savedBasicResults = agentFromList.offers.basic.results;
                        }
                        if (agentFromList.offers && agentFromList.offers.advanced) {
                            savedAdvancedResults = agentFromList.offers.advanced.results;
                        }
                        if (agentFromList.offers && agentFromList.offers.two_months) {
                            savedTwoMonthsResults = agentFromList.offers.two_months.results;
                        }
                        if (agentFromList.details && agentFromList.details.basic) {
                            savedBasicDetails = agentFromList.details.basic;
                        }
                        if (agentFromList.details && agentFromList.details.advanced) {
                            savedAdvancedDetails = agentFromList.details.advanced;
                        }
                        if (agentFromList.details && agentFromList.details.two_months) {
                            savedTwoMonthsDetails = agentFromList.details.two_months;
                        }
                    }
                }
                
                const agentBasicDetails = (basicArchive ? filterDetailsByAgent(basicArchive.data.details, possibleNames) : []).concat(savedBasicDetails);
                const agentAdvancedDetails = (advancedArchive ? filterDetailsByAgent(advancedArchive.data.details, possibleNames) : []).concat(savedAdvancedDetails);
                const agentTwoMonthsDetails = (twoMonthsArchive ? filterDetailsByAgent(twoMonthsArchive.data.details, possibleNames) : []).concat(savedTwoMonthsDetails);
                const basicResults = savedBasicResults || (basicArchive ? getAgentResultsFromArchive(basicArchive, possibleNames, 'basic') : null);
                const advancedResults = savedAdvancedResults || (advancedArchive ? getAgentResultsFromArchive(advancedArchive, possibleNames, 'advanced') : null);
                const twoMonthsResults = savedTwoMonthsResults || (twoMonthsArchive ? getAgentResultsFromArchive(twoMonthsArchive, possibleNames, 'two_months') : null);
                const displayMonth = monthYear === '0000-00' ? 'ŸÇÿßÿ¶ŸÖÿ© ÿØÿßÿ¶ŸÖÿ©' : monthYear;
                let html = `
                    <div style="margin-bottom: 20px;">
                        <button class="btn btn-secondary" onclick="goBackToArchiveAgentsList()" style="margin-bottom: 15px;">‚Üê ÿßŸÑÿπŸàÿØÿ© ÿ•ŸÑŸâ ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸàŸÉŸÑÿßÿ°</button>
                        <h4 style="margin-bottom: 20px; text-align: center; color: var(--primary-color);">ÿ£ÿ±ÿ¥ŸäŸÅ ${displayMonth} - ${displayName}</h4>
                    </div>
                `;
                html += `<div style="margin-bottom: 30px; border: 2px solid var(--primary-color); border-radius: 12px; padding: 20px; background: var(--card-bg); box-shadow: var(--shadow-md);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid var(--primary-color); padding-bottom: 10px;">
                        <h3 style="margin: 0; color: var(--primary-color); font-size: 1.3rem;">${displayName}</h3>
                        <div style="display: flex; gap: 10px;">
                        <button class="btn btn-success" onclick="exportAgentArchiveReport('${displayName}', '${monthYear}')" style="font-size: 0.9rem; padding: 8px 15px;">
                                üì• ÿ™ÿµÿØŸäÿ± Excel
                        </button>
                            <button class="btn btn-danger" onclick="printArchivePDF('${displayName}', '${monthYear}')" style="font-size: 0.9rem; padding: 8px 15px; background-color: #dc3545; border-color: #dc3545;">
                                üñ®Ô∏è ÿ∑ÿ®ÿßÿπÿ© PDF
                            </button>
                        </div>
                    </div>`;
                html += `<div style="margin-bottom: 20px; background: var(--bg-secondary); padding: 15px; border-radius: 8px; border: 1px solid var(--border-color);">
                    <h4 style="margin-bottom: 15px; color: var(--primary-color); border-bottom: 1px solid var(--border-color); padding-bottom: 8px;">ŸÖŸÑÿÆÿµ ÿßŸÑŸÜÿ≥ÿ® ŸàÿßŸÑÿ™ŸÅÿßÿµŸäŸÑ</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 15px;">
                        <div><strong>ÿßŸÑŸÜÿ≥ÿ®ÿ© :</strong> ${agentData.percentage || 0}%</div>
                        <div><strong>ÿßŸÑŸÖÿ¨ŸÖŸàÿπ ÿßŸÑŸÉŸÑŸä:</strong> ${formatNumber(agentData.iqT || 0)} ÿØ.ÿπ</div>
                        <div><strong>ŸÜÿ≥ÿ®ÿ© ÿßŸÑŸàŸÉŸäŸÑ:</strong> ${formatNumber(agentData.agentPercentageAmount || 0)} ÿØ.ÿπ</div>
                        ${agentData.deductions ? `<div style="color: #dc3545;"><strong>ÿßŸÑÿßÿ≥ÿ™ŸÇÿ∑ÿßÿπ:</strong> ${formatNumber(agentData.deductions)} ÿØ.ÿπ</div>` : '<div><strong>ÿßŸÑÿßÿ≥ÿ™ŸÇÿ∑ÿßÿπ:</strong> 0 ÿØ.ÿπ</div>'}
                        ${agentData.penalties ? `<div style="color: #dc3545;"><strong>ÿßŸÑÿ∫ÿ±ÿßŸÖÿ©:</strong> ${formatNumber(agentData.penalties)} ÿØ.ÿπ</div>` : '<div><strong>ÿßŸÑÿ∫ÿ±ÿßŸÖÿ©:</strong> 0 ÿØ.ÿπ</div>'}
                        <div style="font-weight: 700; color: var(--primary-color); font-size: 1.1rem;"><strong>ÿßŸÑÿµÿßŸÅŸä ÿßŸÑŸÜŸáÿßÿ¶Ÿä:</strong> ${formatNumber(agentData.netPercentage || 0)} ÿØ.ÿπ</div>
                    </div>`;
                html += `<div style="margin-bottom: 20px;">
                    <h4 style="margin-bottom: 15px; color: var(--primary-color);">ÿ™ÿ≠ŸÑŸäŸÑÿßÿ™ ÿßŸÑÿπÿ±Ÿàÿ∂</h4>
                    <p style="color: var(--text-secondary);">ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ™ŸÅÿßÿµŸäŸÑ...</p>
                </div>`;
                html += `</div>`;
                archiveContent.innerHTML = html;
                setTimeout(async () => {
                    await loadFullAgentArchiveDetails(agentName, agentData, monthYear, basicResults, advancedResults, twoMonthsResults, agentBasicDetails, agentAdvancedDetails, agentTwoMonthsDetails, basicArchive, advancedArchive, twoMonthsArchive);
                }, 100);
            } catch (error) {
                console.error('Error loading agent archive details:', error);
                archiveContent.innerHTML = `
                    <div style="text-align: center; padding: 20px;">
                        <button class="btn btn-secondary" onclick="goBackToArchiveAgentsList()" style="margin-bottom: 20px;">‚Üê ÿßŸÑÿπŸàÿØÿ© ÿ•ŸÑŸâ ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸàŸÉŸÑÿßÿ°</button>
                        <p style="color: red;">ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿ™ÿ≠ŸÖŸäŸÑ ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑŸàŸÉŸäŸÑ: ${error.message}</p>
                    </div>
                `;
            }
        }
        function goBackToArchiveAgentsList() {
            const agentsListContainer = document.getElementById('archiveAgentsList');
            const archiveContent = document.getElementById('archiveContent');
            if (agentsListContainer) {
                agentsListContainer.style.display = 'block';
            }
            if (archiveContent) {
                archiveContent.style.display = 'none';
            }
            const searchInput = document.getElementById('archiveAgentSearch');
            if (searchInput) {
                searchInput.value = '';
                filterArchiveAgents('');
            }
        }
        async function loadFullAgentArchiveDetails(agentName, agentData, monthYear, basicResults, advancedResults, twoMonthsResults, agentBasicDetails, agentAdvancedDetails, agentTwoMonthsDetails, basicArchive, advancedArchive, twoMonthsArchive) {
            const archiveContent = document.getElementById('archiveContent');
            if (!archiveContent) return;
            const existingHTML = archiveContent.innerHTML;
            const analysesStart = existingHTML.indexOf('<h4 style="margin-bottom: 15px; color: var(--primary-color);">ÿ™ÿ≠ŸÑŸäŸÑÿßÿ™ ÿßŸÑÿπÿ±Ÿàÿ∂</h4>');
            if (analysesStart === -1) return;
            let analysesHTML = '<h4 style="margin-bottom: 15px; color: var(--primary-color);">ÿ™ÿ≠ŸÑŸäŸÑÿßÿ™ ÿßŸÑÿπÿ±Ÿàÿ∂</h4>';
            const agentAnalyses = [];
            if (basicResults || agentBasicDetails.length > 0) {
                agentAnalyses.push({
                    type: 'basic',
                    name: 'ÿßŸÑÿπÿ±ÿ∂ ÿßŸÑŸÖÿ¨ÿßŸÜŸä',
                    results: basicResults,
                    details: agentBasicDetails
                });
            }
            if (advancedResults || agentAdvancedDetails.length > 0) {
                agentAnalyses.push({
                    type: 'advanced',
                    name: 'ÿπÿ±ÿ∂ 3 ÿ£ÿ¥Ÿáÿ± ŸÖÿÆŸÅÿ∂',
                    results: advancedResults,
                    details: agentAdvancedDetails
                });
            }
            if (twoMonthsResults || agentTwoMonthsDetails.length > 0) {
                agentAnalyses.push({
                    type: 'two_months',
                    name: 'ÿπÿ±ÿ∂ ÿ¥Ÿáÿ±ŸäŸÜ ŸÖÿÆŸÅÿ∂',
                    results: twoMonthsResults,
                    details: agentTwoMonthsDetails
                });
            }
            if (agentAnalyses.length > 0) {
                agentAnalyses.forEach(analysis => {
                    const analysisType = analysis.type;
                    const typeColors = {
                        'basic': { bg: '#e8f5e9', border: '#4caf50', text: '#2e7d32' },
                        'advanced': { bg: '#e3f2fd', border: '#2196f3', text: '#1565c0' },
                        'two_months': { bg: '#fff3e0', border: '#ff9800', text: '#e65100' }
                    };
                    const colors = typeColors[analysisType] || typeColors['basic'];
                    
                    analysesHTML += `<div style="margin-bottom: 20px; background: ${colors.bg}; padding: 15px; border-radius: 8px; border-left: 4px solid ${colors.border};">
                        <h5 style="margin-bottom: 10px; color: ${colors.text}; font-weight: 700; font-size: 1.1rem;">${analysis.name}</h5>`;
                    if (analysis.results && analysis.results.total) {
                        const total = analysis.results.total;
                        analysesHTML += `<div style="background: white; padding: 15px; border-radius: 6px; margin-bottom: 15px; border: 1px solid ${colors.border};">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 15px;">
                                <div style="background: #f5f5f5; padding: 10px; border-radius: 6px;">
                                    <div style="font-size: 0.85rem; color: #666; margin-bottom: 5px;">ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉÿßÿ™</div>
                                    <div style="font-size: 1.3rem; font-weight: 700; color: ${colors.text};">${formatNumber(total.count || 0)}</div>
                                </div>
                                ${total.amount ? `<div style="background: #f5f5f5; padding: 10px; border-radius: 6px;">
                                    <div style="font-size: 0.85rem; color: #666; margin-bottom: 5px;">ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä</div>
                                    <div style="font-size: 1.2rem; font-weight: 700; color: ${colors.text};">${formatNumber(total.amount)} ÿØ.ÿπ</div>
                                </div>` : ''}
                                ${total.promoAmount ? `<div style="background: #f5f5f5; padding: 10px; border-radius: 6px;">
                                    <div style="font-size: 0.85rem; color: #666; margin-bottom: 5px;">ŸÖÿ®ŸÑÿ∫ ÿßŸÑÿπÿ±ÿ∂</div>
                                    <div style="font-size: 1.2rem; font-weight: 700; color: ${colors.text};">${formatNumber(total.promoAmount)} ÿØ.ÿπ</div>
                                </div>` : ''}
                                ${total.officialAmount ? `<div style="background: #f5f5f5; padding: 10px; border-radius: 6px;">
                                    <div style="font-size: 0.85rem; color: #666; margin-bottom: 5px;">ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑÿ±ÿ≥ŸÖŸä</div>
                                    <div style="font-size: 1.2rem; font-weight: 700; color: ${colors.text};">${formatNumber(total.officialAmount)} ÿØ.ÿπ</div>
                                </div>` : ''}
                                ${total.profit !== undefined ? `<div style="background: #e8f5e9; padding: 10px; border-radius: 6px; border: 2px solid #4caf50;">
                                    <div style="font-size: 0.85rem; color: #2e7d32; margin-bottom: 5px;">ÿßŸÑÿ±ÿßÿ¨ÿπ ŸÑŸÑŸàŸÉŸäŸÑ</div>
                                    <div style="font-size: 1.3rem; font-weight: 700; color: #2e7d32;">${formatNumber(total.profit)} ÿØ.ÿπ</div>
                                </div>` : ''}
                            </div>`;
                        if (analysis.results.bronze || analysis.results.silver || analysis.results.gold || analysis.results.platinum) {
                            analysesHTML += `<div style="margin-top: 15px; padding-top: 15px; border-top: 2px solid ${colors.border};">
                                <div style="font-weight: 600; margin-bottom: 10px; color: ${colors.text};">ÿßŸÑÿ™ŸÅÿßÿµŸäŸÑ ÿ≠ÿ≥ÿ® ŸÜŸàÿπ ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ:</div>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">`;
                            ['bronze', 'silver', 'gold', 'platinum'].forEach(cat => {
                                const catData = analysis.results[cat];
                                if (catData && (catData.count > 0 || catData.amount > 0 || catData.promoAmount > 0)) {
                                    const catNames = { bronze: 'Bronze', silver: 'Silver', gold: 'Gold', platinum: 'Platinum' };
                                    analysesHTML += `<div style="background: white; padding: 10px; border-radius: 6px; border: 1px solid ${colors.border};">
                                        <div style="font-weight: 600; color: ${colors.text}; margin-bottom: 5px;">${catNames[cat]}</div>
                                        <div style="font-size: 0.9rem;">ÿßŸÑÿπÿØÿØ: ${formatNumber(catData.count || 0)}</div>
                                        ${catData.amount ? `<div style="font-size: 0.9rem;">ÿßŸÑŸÖÿ®ŸÑÿ∫: ${formatNumber(catData.amount)} ÿØ.ÿπ</div>` : ''}
                                        ${catData.promoAmount ? `<div style="font-size: 0.9rem;">ÿπÿ±ÿ∂: ${formatNumber(catData.promoAmount)} ÿØ.ÿπ</div>` : ''}
                                        ${catData.officialAmount ? `<div style="font-size: 0.9rem;">ÿ±ÿ≥ŸÖŸä: ${formatNumber(catData.officialAmount)} ÿØ.ÿπ</div>` : ''}
                                    </div>`;
                                }
                            });
                            analysesHTML += `</div></div>`;
                        }
                        analysesHTML += `</div>`;
                    } else if (analysis.details && analysis.details.length > 0) {
                        analysesHTML += `<div style="background: white; padding: 12px; border-radius: 6px; margin-bottom: 15px; border: 1px solid ${colors.border};">
                            <div style="font-size: 1.1rem; font-weight: 600; color: ${colors.text};">
                                ÿπÿØÿØ ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉÿßÿ™: <span style="color: ${colors.border};">${formatNumber(analysis.details.length)}</span>
                            </div>
                        </div>`;
                    }
                    if (analysis.details && analysis.details.length > 0) {
                        analysesHTML += `<div style="margin-top: 15px;">
                            <strong style="color: var(--primary-color);">ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉÿßÿ™ (${analysis.details.length}):</strong>
                            <div style="background: var(--bg-primary); padding: 10px; border-radius: 8px; margin-top: 5px; max-height: 400px; overflow-y: auto; font-size: 0.85rem;">
                                <table style="width: 100%; border-collapse: collapse;">
                                    <thead>
                                        <tr style="background: var(--bg-secondary); font-weight: 600;">
                                            <th style="padding: 8px; text-align: center; border: 1px solid var(--border-color);">#</th>
                                            <th style="padding: 8px; text-align: right; border: 1px solid var(--border-color);">ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ</th>
                                            <th style="padding: 8px; text-align: right; border: 1px solid var(--border-color);">ŸÜŸàÿπ ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ</th>
                                            <th style="padding: 8px; text-align: right; border: 1px solid var(--border-color);">ÿßŸÑÿ™ÿßÿ±ŸäÿÆ</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${analysis.details.slice(0, 100).map((detail, idx) => `
                                            <tr style="border-bottom: 1px solid var(--border-color);">
                                                <td style="padding: 6px; text-align: center; border: 1px solid var(--border-color);">${idx + 1}</td>
                                                <td style="padding: 6px; text-align: right; border: 1px solid var(--border-color);">${detail.username || ''}</td>
                                                <td style="padding: 6px; text-align: right; border: 1px solid var(--border-color);">${detail.subscription || ''}</td>
                                                <td style="padding: 6px; text-align: right; border: 1px solid var(--border-color);">${detail.dateStr || detail.date || ''}</td>
                                            </tr>
                                        `).join('')}
                                        ${analysis.details.length > 100 ? `<tr><td colspan="4" style="text-align: center; padding: 10px; color: var(--text-secondary);">... Ÿà ${analysis.details.length - 100} ÿ≥ÿ¨ŸÑ ÿ•ÿ∂ÿßŸÅŸä</td></tr>` : ''}
                                    </tbody>
                                </table>
                            </div>
                        </div>`;
                    }
                    analysesHTML += `</div>`;
                });
            } else {
                analysesHTML += `<div style="padding: 15px; background: var(--bg-secondary); border-radius: 8px; text-align: center; color: var(--text-secondary);">
                    <p>ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ™ÿ≠ŸÑŸäŸÑÿßÿ™ ŸÖÿ≥ÿ¨ŸÑÿ© ŸÑŸáÿ∞ÿß ÿßŸÑŸàŸÉŸäŸÑ ŸÅŸä ÿßŸÑÿ£ÿ±ÿ¥ŸäŸÅ</p>
                </div>`;
            }
            const beforeAnalyses = existingHTML.substring(0, analysesStart);
            const afterAnalysesStart = existingHTML.indexOf('</div>', analysesStart + 200);
            const afterAnalyses = afterAnalysesStart !== -1 ? existingHTML.substring(afterAnalysesStart + 6) : '';
            archiveContent.innerHTML = beforeAnalyses + analysesHTML + afterAnalyses;
        }
        function applyExcelStyling(ws, numRows, numCols) {
            if (!ws || !ws['!ref']) return;
            const range = XLSX.utils.decode_range(ws['!ref']);
            const maxCol = Math.max(range.e.c, numCols - 1);
            const headerRows = new Set();
            const titleRows = new Set();
            const separatorRows = new Set();
            const totalRows = new Set();
            for (let r = 0; r <= range.e.r; r++) {
                const cellAddress = XLSX.utils.encode_cell({ r: r, c: 0 });
                const cell = ws[cellAddress];
                if (cell && cell.v) {
                    const value = String(cell.v);
                    if (value.includes('‚ïê‚ïê‚ïê‚ïê')) {
                        separatorRows.add(r);
                    }
                    else if (value.includes('ÿ™ŸÇÿ±Ÿäÿ±') || value.includes('ÿ™ÿ≠ŸÑŸäŸÑ') || value.includes('ŸÖŸÑÿÆÿµ') || value.includes('ŸÖÿπŸÑŸàŸÖÿßÿ™')) {
                        titleRows.add(r);
                    }
                    else if (value === 'ÿßŸÑŸÜŸàÿπ' || value === 'ÿßŸÑÿπÿØÿØ' || value === 'ÿßŸÑŸÖÿ®ŸÑÿ∫' || value === '#' || value === 'ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ' || 
                             value === 'ÿßÿ≥ŸÖ ÿßŸÑŸàŸÉŸäŸÑ' || value === 'ÿßŸÑÿ¥Ÿáÿ±' || value === 'ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ™ÿµÿØŸäÿ±' || value === 'ŸÜÿ≥ÿ®ÿ© ÿßŸÑŸàŸÉŸäŸÑ' ||
                             value === 'ÿßŸÑŸÖÿ¨ŸÖŸàÿπ ÿßŸÑŸÉŸÑŸä' || value === 'ŸÜÿ≥ÿ®ÿ© ÿßŸÑŸàŸÉŸäŸÑ' || value === 'ÿßŸÑÿßÿ≥ÿ™ŸÇÿ∑ÿßÿπ' || value === 'ÿßŸÑÿ∫ÿ±ÿßŸÖÿ©' ||
                             value === 'ÿßŸÑÿµÿßŸÅŸä ÿßŸÑŸÜŸáÿßÿ¶Ÿä' || value === 'ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä' || value === 'ŸÖÿ®ŸÑÿ∫ ÿßŸÑÿπÿ±ÿ∂' || value === 'ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑÿ±ÿ≥ŸÖŸä' ||
                             value === 'ÿßŸÑÿ±ÿ®ÿ≠/ÿßŸÑÿ±ÿßÿ¨ÿπ' || value === 'ÿ≥ÿπÿ± ÿßŸÑÿπÿ±ÿ∂' || value === 'ÿßŸÑÿ≥ÿπÿ± ÿßŸÑÿ±ÿ≥ŸÖŸä' || value === 'ÿßŸÑÿ≥ÿπÿ±' ||
                             value === ' ÿßŸÑÿ≥ÿπÿ±' || value === 'ŸÜÿ≥ÿ®ÿ© ÿßŸÑŸàŸÉŸäŸÑ' || value === 'ŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÜÿ≥ÿ®ÿ©' || value === 'ŸÜŸàÿπ ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ' ||
                             value === 'ÿßŸÑÿ™ÿßÿ±ŸäÿÆ' || value === 'ÿ™ÿßÿ±ŸäÿÆ 1' || value === 'ÿ™ÿßÿ±ŸäÿÆ 2' || value === 'ÿ™ÿßÿ±ŸäÿÆ 3' || value === 'ÿßŸÑŸÅÿ±ŸÇ ÿ®ÿßŸÑÿ£ŸäÿßŸÖ') {
                        headerRows.add(r);
                    }
                    if (value === 'ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä') {
                        totalRows.add(r);
                    }
                }
            }
            for (let r = 0; r <= range.e.r; r++) {
                const isSeparatorRow = separatorRows.has(r);
                const isTitleRow = titleRows.has(r);
                const isHeaderRow = headerRows.has(r);
                const isTotalRow = totalRows.has(r);
                const isEvenRow = r % 2 === 0 && !isTitleRow && !isHeaderRow && !isSeparatorRow && !isTotalRow;
                for (let c = 0; c <= maxCol; c++) {
                    const cellAddress = XLSX.utils.encode_cell({ r: r, c: c });
                    if (!ws[cellAddress]) continue;
                    let bgColor = isEvenRow ? "F2F2F2" : "FFFFFF";
                    let fontSize = 11;
                    let isBold = false;
                    let borderStyle = "thin";
                    let borderColor = "CCCCCC";
                    if (isSeparatorRow) {
                        bgColor = "E8F4F8";
                        fontSize = 10;
                        isBold = false;
                        borderStyle = "thin";
                        borderColor = "CCCCCC";
                    }
                    else if (isTitleRow) {
                        bgColor = "E8F4F8";
                        fontSize = 14;
                        isBold = true;
                        borderStyle = "medium";
                        borderColor = "000000";
                    }
                    else if (isHeaderRow) {
                        bgColor = "801C32";
                        fontSize = 12;
                        isBold = true;
                        borderStyle = "medium";
                        borderColor = "000000";
                    }
                    else if (isTotalRow) {
                        bgColor = "FFF8F9FA";
                        fontSize = 12;
                        isBold = true;
                        borderStyle = "thick";
                        borderColor = "801C32";
                    }
                    if (ws[cellAddress].t === 'n' && c >= 1) {
                        ws[cellAddress].z = '#,##0';
                    }
                    ws[cellAddress].s = {
                        fill: {
                            fgColor: { rgb: bgColor }
                        },
                        font: {
                            bold: isBold,
                            sz: fontSize,
                            color: { rgb: isHeaderRow ? "FFFFFF" : "000000" }
                        },
                        alignment: {
                            horizontal: c === 0 ? "right" : "center",
                            vertical: "center",
                            wrapText: isTitleRow || isHeaderRow
                        },
                        border: {
                            top: { style: borderStyle, color: { rgb: borderColor } },
                            bottom: { style: borderStyle, color: { rgb: borderColor } },
                            left: { style: borderStyle, color: { rgb: borderColor } },
                            right: { style: borderStyle, color: { rgb: borderColor } }
                        }
                    };
                }
            }
            if (!ws['!rows']) {
                ws['!rows'] = [];
            }
            for (let r = 0; r <= range.e.r; r++) {
                if (separatorRows.has(r)) {
                    ws['!rows'][r] = { hpt: 15 };
                } else if (titleRows.has(r)) {
                    ws['!rows'][r] = { hpt: 25 };
                } else if (headerRows.has(r)) {
                    ws['!rows'][r] = { hpt: 30 };
                } else if (totalRows.has(r)) {
                    ws['!rows'][r] = { hpt: 25 };
                } else {
                    ws['!rows'][r] = { hpt: 20 };
                }
            }
            if (!ws['!cols']) {
                ws['!cols'] = [];
            }
            for (let c = 0; c <= maxCol; c++) {
                ws['!cols'][c] = { wch: c === 0 ? 25 : (c === 1 ? 15 : 18) };
            }
        }
        async function exportAgentArchiveReport(agentName, monthYear) {
            if (!supabaseClient) {
                alert('Supabase ÿ∫Ÿäÿ± ŸÖÿ™ÿµŸÑ');
                return;
            }
            try {
                showSuccessMessage('ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ÿ∂Ÿäÿ± ÿßŸÑÿ™ŸÇÿ±Ÿäÿ±...');
                const percentagesArchive = await getArchiveForMonth('agent_percentages', monthYear);
                const { data: basicArchiveData } = await supabaseClient.from('analysis_archives').select('*').eq('month_year', monthYear).eq('analysis_type', 'basic').maybeSingle();
                const { data: advancedArchiveData } = await supabaseClient.from('analysis_archives').select('*').eq('month_year', monthYear).eq('analysis_type', 'advanced').maybeSingle();
                const { data: twoMonthsArchiveData } = await supabaseClient.from('analysis_archives').select('*').eq('month_year', monthYear).eq('analysis_type', 'two_months').maybeSingle();
                if (!percentagesArchive || !percentagesArchive.data || !percentagesArchive.data[agentName]) {
                    alert('ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™ ŸÑŸáÿ∞ÿß ÿßŸÑŸàŸÉŸäŸÑ ŸÅŸä ÿßŸÑÿ£ÿ±ÿ¥ŸäŸÅ');
                    return;
                }
                const agentData = percentagesArchive.data[agentName];
                const filterDetailsByAgent = (details, agentName) => {
                    if (!details || !Array.isArray(details)) return [];
                    return details.filter(d => {
                        const agent = d.agent || d.Agent || d.agentName || d.AgentName || d['ÿßÿ≥ŸÖ ÿßŸÑŸàŸÉŸäŸÑ'] || d['ÿßŸÑŸàŸÉŸäŸÑ'];
                        return agent === agentName;
                    });
                };
                const getAgentResultsFromArchive = (archiveData, agentName, type) => {
                    if (!archiveData || !archiveData.data) return null;
                    if (archiveData.data.agentReports && archiveData.data.agentReports[agentName]) {
                        const agentReport = archiveData.data.agentReports[agentName];
                        if (type === 'basic' && agentReport.basic) {
                            return agentReport.basic;
                        }
                        if (type === 'advanced' && agentReport.advanced) {
                            return agentReport.advanced;
                        }
                        if (type === 'two_months' && agentReport.twoMonths) {
                            return agentReport.twoMonths;
                        }
                    }
                    if (archiveData.data.results) {
                        if (archiveData.data.results.agentName === agentName) {
                            return archiveData.data.results;
                        }
                        if (archiveData.data.results[agentName]) {
                            if (type === 'basic' && archiveData.data.results[agentName].basic) {
                                return archiveData.data.results[agentName].basic;
                            }
                            if (type === 'advanced' && archiveData.data.results[agentName].advanced) {
                                return archiveData.data.results[agentName].advanced;
                            }
                            if (type === 'two_months' && archiveData.data.results[agentName].twoMonths) {
                                return archiveData.data.results[agentName].twoMonths;
                            }
                        }
                    }
                    return null;
                };
                const basicArchive = basicArchiveData ? { data: basicArchiveData.data, raw: basicArchiveData } : null;
                const advancedArchive = advancedArchiveData ? { data: advancedArchiveData.data, raw: advancedArchiveData } : null;
                const twoMonthsArchive = twoMonthsArchiveData ? { data: twoMonthsArchiveData.data, raw: twoMonthsArchiveData } : null;
                const agentBasicDetails = basicArchive ? filterDetailsByAgent(basicArchive.data.details, agentName) : [];
                const agentAdvancedDetails = advancedArchive ? filterDetailsByAgent(advancedArchive.data.details, agentName) : [];
                const agentTwoMonthsDetails = twoMonthsArchive ? filterDetailsByAgent(twoMonthsArchive.data.details, agentName) : [];
                const basicResults = basicArchive ? getAgentResultsFromArchive(basicArchive, agentName, 'basic') : null;
                const advancedResults = advancedArchive ? getAgentResultsFromArchive(advancedArchive, agentName, 'advanced') : null;
                const twoMonthsResults = twoMonthsArchive ? getAgentResultsFromArchive(twoMonthsArchive, agentName, 'two_months') : null;
                const wb = XLSX.utils.book_new();
                const totalCount = (Number(agentData.countB) || 0) + (Number(agentData.countG) || 0) + (Number(agentData.countS) || 0) + (Number(agentData.countP) || 0);
                const totalAmount = (Number(agentData.iqB) || 0) + (Number(agentData.iqG) || 0) + (Number(agentData.iqS) || 0) + (Number(agentData.iqP) || 0);
                const percentageData = [
                    ['‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê'],
                    ['ÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑÿßÿ±ÿ¥ŸäŸÅ '],
                    ['‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê'],
                    [],
                    ['ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿ™ŸÇÿ±Ÿäÿ±'],
                    ['ÿßÿ≥ŸÖ ÿßŸÑŸàŸÉŸäŸÑ', (() => {
                        const agent = agentsList.find(a => a.name === agentName);
                        const agentSubName = agent?.subName || '';
                        return agentSubName ? `${agentName}\n${agentSubName}` : agentName;
                    })()],
                    ['ÿßŸÑÿ¥Ÿáÿ±', monthYear],
                    ['ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ™ÿµÿØŸäÿ±', new Date().toLocaleString('ar-IQ')],
                    [],
                    ['‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê'],
                    ['ŸÖŸÑÿÆÿµ ÿßŸÑŸÜÿ≥ÿ® ŸàÿßŸÑÿ™ŸÅÿßÿµŸäŸÑ'],
                    ['‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê'],
                    [],
                    ['ÿßŸÑŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿäÿ©'],
                    ['ŸÜÿ≥ÿ®ÿ© ÿßŸÑŸàŸÉŸäŸÑ ', `${agentData.percentage || 0}%`],
                    ['ÿßŸÑŸÖÿ¨ŸÖŸàÿπ ÿßŸÑŸÉŸÑŸä', `${formatNumber(agentData.iqT || 0)} ÿØ.ÿπ`],
                    ['ŸÜÿ≥ÿ®ÿ© ÿßŸÑŸàŸÉŸäŸÑ', `${formatNumber(agentData.agentPercentageAmount || 0)} ÿØ.ÿπ`],
                    [],
                    ['ÿßŸÑÿßÿ≥ÿ™ŸÇÿ∑ÿßÿπÿßÿ™ ŸàÿßŸÑÿ∫ÿ±ÿßŸÖÿßÿ™'],
                    ['ÿßŸÑÿßÿ≥ÿ™ŸÇÿ∑ÿßÿπ', `${formatNumber(agentData.deductions || 0)} ÿØ.ÿπ`],
                    ['ÿßŸÑÿ∫ÿ±ÿßŸÖÿ©', `${formatNumber(agentData.penalties || 0)} ÿØ.ÿπ`],
                    [],
                    ['ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÜŸáÿßÿ¶Ÿä'],
                    ['ÿßŸÑÿµÿßŸÅŸä ÿßŸÑŸÜŸáÿßÿ¶Ÿä', `${formatNumber(agentData.netPercentage || 0)} ÿØ.ÿπ`],
                    [],
                    ['‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê'],
                    ['ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑŸÜÿ≥ÿ®ÿ© ÿ≠ÿ≥ÿ® ŸÜŸàÿπ ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ'],
                    ['‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê'],
                    [],
                    ['ÿßŸÑŸÜŸàÿπ', 'ÿßŸÑÿπÿØÿØ', 'ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä', ' ÿßŸÑÿ≥ÿπÿ±', 'ŸÜÿ≥ÿ®ÿ© ÿßŸÑŸàŸÉŸäŸÑ', 'ŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÜÿ≥ÿ®ÿ©'],
                    ['Bronze ', Number(agentData.countB) || 0, formatNumber(Number(agentData.iqB) || 0) + ' ÿØ.ÿπ', agentData.countB ? formatNumber((Number(agentData.iqB) / Number(agentData.countB)) || 0) + ' ÿØ.ÿπ' : '0 ÿØ.ÿπ', (agentData.percentage || 0) + '%', formatNumber(((Number(agentData.iqB) || 0) * (Number(agentData.percentage) || 0)) / 100) + ' ÿØ.ÿπ'],
                    ['Gold ', Number(agentData.countG) || 0, formatNumber(Number(agentData.iqG) || 0) + ' ÿØ.ÿπ', agentData.countG ? formatNumber((Number(agentData.iqG) / Number(agentData.countG)) || 0) + ' ÿØ.ÿπ' : '0 ÿØ.ÿπ', (agentData.percentage || 0) + '%', formatNumber(((Number(agentData.iqG) || 0) * (Number(agentData.percentage) || 0)) / 100) + ' ÿØ.ÿπ'],
                    ['Silver ', Number(agentData.countS) || 0, formatNumber(Number(agentData.iqS) || 0) + ' ÿØ.ÿπ', agentData.countS ? formatNumber((Number(agentData.iqS) / Number(agentData.countS)) || 0) + ' ÿØ.ÿπ' : '0 ÿØ.ÿπ', (agentData.percentage || 0) + '%', formatNumber(((Number(agentData.iqS) || 0) * (Number(agentData.percentage) || 0)) / 100) + ' ÿØ.ÿπ'],
                    ['Platinum ', Number(agentData.countP) || 0, formatNumber(Number(agentData.iqP) || 0) + ' ÿØ.ÿπ', agentData.countP ? formatNumber((Number(agentData.iqP) / Number(agentData.countP)) || 0) + ' ÿØ.ÿπ' : '0 ÿØ.ÿπ', (agentData.percentage || 0) + '%', formatNumber(((Number(agentData.iqP) || 0) * (Number(agentData.percentage) || 0)) / 100) + ' ÿØ.ÿπ'],
                    [],
                    ['ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä', totalCount, formatNumber(totalAmount) + ' ÿØ.ÿπ', totalCount > 0 ? formatNumber(totalAmount / totalCount) + ' ÿØ.ÿπ' : '0 ÿØ.ÿπ', (agentData.percentage || 0) + '%', formatNumber(agentData.agentPercentageAmount || 0) + ' ÿØ.ÿπ']
                ];
                const ws1 = XLSX.utils.aoa_to_sheet(percentageData);
                applyExcelStyling(ws1, percentageData.length, percentageData[0] ? percentageData[0].length : 0);
                XLSX.utils.book_append_sheet(wb, ws1, 'ŸÖŸÑÿÆÿµ ÿßŸÑŸÜÿ≥ÿ®');
                if (basicResults || agentBasicDetails.length > 0) {
                    let totalCount = basicResults ? (basicResults.total.count || 0) : agentBasicDetails.length;
                    let totalAmount = 0;
                    if (basicResults && basicResults.total.amount) {
                        totalAmount = basicResults.total.amount;
                    } else {
                        agentBasicDetails.forEach(d => {
                            if (d.price) totalAmount += Number(d.price) || 0;
                        });
                    }
                    const basicSheetData = [
                        ['‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê'],
                        ['ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑÿπÿ±ÿ∂ ÿßŸÑŸÖÿ¨ÿßŸÜŸä'],
                        ['‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê'],
                        [],
                        ['ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿ™ÿ≠ŸÑŸäŸÑ'],
                        ['ÿßÿ≥ŸÖ ÿßŸÑŸàŸÉŸäŸÑ', agentName],
                        ['ÿßŸÑÿ¥Ÿáÿ±', monthYear],
                        [],
                        ['‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê'],
                        ['ŸÖŸÑÿÆÿµ ÿßŸÑÿ™ÿ≠ŸÑŸäŸÑ'],
                        ['‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê'],
                        [],
                        ['ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä', totalCount],
                        ['ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä', `${formatNumber(totalAmount)} ÿØ.ÿπ`],
                        [],
                        ['‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê'],
                        ['ÿ™ŸÅÿßÿµŸäŸÑ ÿ≠ÿ≥ÿ® ŸÜŸàÿπ ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ'],
                        ['‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê'],
                        [],
                        ['ÿßŸÑŸÜŸàÿπ', 'ÿßŸÑÿπÿØÿØ', 'ÿßŸÑŸÖÿ®ŸÑÿ∫'],
                        ['Bronze', (basicResults && basicResults.bronze && basicResults.bronze.count !== undefined) ? Number(basicResults.bronze.count) : 0, (basicResults && basicResults.bronze && basicResults.bronze.amount) ? `${formatNumber(basicResults.bronze.amount)} ÿØ.ÿπ` : '0 ÿØ.ÿπ'],
                        ['Silver', (basicResults && basicResults.silver && basicResults.silver.count !== undefined) ? Number(basicResults.silver.count) : 0, (basicResults && basicResults.silver && basicResults.silver.amount) ? `${formatNumber(basicResults.silver.amount)} ÿØ.ÿπ` : '0 ÿØ.ÿπ'],
                        ['Gold', (basicResults && basicResults.gold && basicResults.gold.count !== undefined) ? Number(basicResults.gold.count) : 0, (basicResults && basicResults.gold && basicResults.gold.amount) ? `${formatNumber(basicResults.gold.amount)} ÿØ.ÿπ` : '0 ÿØ.ÿπ'],
                        ['Platinum', (basicResults && basicResults.platinum && basicResults.platinum.count !== undefined) ? Number(basicResults.platinum.count) : 0, (basicResults && basicResults.platinum && basicResults.platinum.amount) ? `${formatNumber(basicResults.platinum.amount)} ÿØ.ÿπ` : '0 ÿØ.ÿπ'],
                        [],
                        ['‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê'],
                        ['ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉÿßÿ™ ÿßŸÑŸÉÿßŸÖŸÑÿ©'],
                        ['‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê'],
                        [],
                        ['#', 'ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ', 'ŸÜŸàÿπ ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ', 'ÿßŸÑÿ™ÿßÿ±ŸäÿÆ', 'ÿßŸÑÿ≥ÿπÿ±', 'ÿ≥ÿπÿ± ÿßŸÑÿπÿ±ÿ∂', 'ÿßŸÑÿ≥ÿπÿ± ÿßŸÑÿ±ÿ≥ŸÖŸä']
                    ];
                    agentBasicDetails.forEach((detail, idx) => {
                        const dateStr = detail.dateStr || detail.date || detail.createdAt || detail.date1 || '';
                        let price = detail.price;
                        let promoPrice = detail.promoPrice;
                        let officialPrice = detail.officialPrice;
                        if (!price && !promoPrice && !officialPrice && detail.subscription) {
                            const category = getSubscriptionCategory(detail.subscription, detail.agent || '');
                            if (category) {
                                price = getSubscriptionPrice(detail.subscription, category, 'basic');
                                promoPrice = price;
                                officialPrice = price;
                            }
                        }
                        const priceStr = price ? `${formatNumber(price)} ÿØ.ÿπ` : '-';
                        const promoPriceStr = promoPrice ? `${formatNumber(promoPrice)} ÿØ.ÿπ` : '-';
                        const officialPriceStr = officialPrice ? `${formatNumber(officialPrice)} ÿØ.ÿπ` : '-';
                        basicSheetData.push([
                            idx + 1,
                            detail.username || '',
                            detail.subscription || '',
                            dateStr,
                            priceStr,
                            promoPriceStr,
                            officialPriceStr
                        ]);
                    });
                    const ws2 = XLSX.utils.aoa_to_sheet(basicSheetData);
                    applyExcelStyling(ws2, basicSheetData.length, basicSheetData[0] ? basicSheetData[0].length : 0);
                    XLSX.utils.book_append_sheet(wb, ws2, 'ÿßŸÑÿπÿ±ÿ∂ ÿßŸÑŸÖÿ¨ÿßŸÜŸä');
                }
                if (advancedResults || agentAdvancedDetails.length > 0) {
                    let totalCount = advancedResults ? (advancedResults.total.count || 0) : agentAdvancedDetails.length;
                    let totalPromoAmount = 0;
                    let totalOfficialAmount = 0;
                    if (advancedResults && advancedResults.total) {
                        totalPromoAmount = advancedResults.total.promoAmount || 0;
                        totalOfficialAmount = advancedResults.total.officialAmount || 0;
                    } else {
                        agentAdvancedDetails.forEach(d => {
                            if (d.promoPrice) totalPromoAmount += Number(d.promoPrice) || 0;
                            if (d.officialPrice) totalOfficialAmount += Number(d.officialPrice) || 0;
                        });
                    }
                    const totalProfit = totalOfficialAmount - totalPromoAmount;
                    const agent = agentsList.find(a => a.name === agentName);
                    const agentSubName = agent?.subName || '';
                    const agentDisplayName = agentSubName ? `${agentName}\n${agentSubName}` : agentName;
                    
                    const advancedSheetData = [
                        ['‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê'],
                        ['ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑÿπÿ±ÿ∂ ÿßŸÑŸÖÿÆŸÅÿ∂ ŸÑÿ´ŸÑÿßÿ´ ÿ£ÿ¥Ÿáÿ±'],
                        ['‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê'],
                        [],
                        ['ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿ™ÿ≠ŸÑŸäŸÑ'],
                        ['ÿßÿ≥ŸÖ ÿßŸÑŸàŸÉŸäŸÑ', agentDisplayName],
                        ['ÿßŸÑÿ¥Ÿáÿ±', monthYear],
                        [],
                        ['‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê'],
                        ['ŸÖŸÑÿÆÿµ ÿßŸÑÿ™ÿ≠ŸÑŸäŸÑ'],
                        ['‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê'],
                        [],
                        ['ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä', totalCount],
                        ['ŸÖÿ®ŸÑÿ∫ ÿßŸÑÿπÿ±ÿ∂', `${formatNumber(totalPromoAmount)} ÿØ.ÿπ`],
                        ['ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑÿ±ÿ≥ŸÖŸä', `${formatNumber(totalOfficialAmount)} ÿØ.ÿπ`],
                        ['ÿßŸÑÿ±ÿ®ÿ≠/ÿßŸÑÿ±ÿßÿ¨ÿπ', `${formatNumber(totalProfit)} ÿØ.ÿπ`],
                        [],
                        ['‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê'],
                        ['ÿ™ŸÅÿßÿµŸäŸÑ ÿ≠ÿ≥ÿ® ŸÜŸàÿπ ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ'],
                        ['‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê'],
                        [],
                        ['ÿßŸÑŸÜŸàÿπ', 'ÿßŸÑÿπÿØÿØ', 'ŸÖÿ®ŸÑÿ∫ ÿßŸÑÿπÿ±ÿ∂', 'ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑÿ±ÿ≥ŸÖŸä', 'ÿßŸÑÿ±ÿ®ÿ≠/ÿßŸÑÿ±ÿßÿ¨ÿπ'],
                        ['Bronze', (advancedResults && advancedResults.bronze && advancedResults.bronze.count !== undefined) ? Number(advancedResults.bronze.count) : 0, 
                         (advancedResults && advancedResults.bronze && advancedResults.bronze.promoAmount) ? `${formatNumber(advancedResults.bronze.promoAmount)} ÿØ.ÿπ` : '0 ÿØ.ÿπ',
                         (advancedResults && advancedResults.bronze && advancedResults.bronze.officialAmount) ? `${formatNumber(advancedResults.bronze.officialAmount)} ÿØ.ÿπ` : '0 ÿØ.ÿπ',
                         (advancedResults && advancedResults.bronze && advancedResults.bronze.officialAmount && advancedResults.bronze.promoAmount) ? `${formatNumber(advancedResults.bronze.officialAmount - advancedResults.bronze.promoAmount)} ÿØ.ÿπ` : '0 ÿØ.ÿπ'],
                        ['Silver', (advancedResults && advancedResults.silver && advancedResults.silver.count !== undefined) ? Number(advancedResults.silver.count) : 0,
                         (advancedResults && advancedResults.silver && advancedResults.silver.promoAmount) ? `${formatNumber(advancedResults.silver.promoAmount)} ÿØ.ÿπ` : '0 ÿØ.ÿπ',
                         (advancedResults && advancedResults.silver && advancedResults.silver.officialAmount) ? `${formatNumber(advancedResults.silver.officialAmount)} ÿØ.ÿπ` : '0 ÿØ.ÿπ',
                         (advancedResults && advancedResults.silver && advancedResults.silver.officialAmount && advancedResults.silver.promoAmount) ? `${formatNumber(advancedResults.silver.officialAmount - advancedResults.silver.promoAmount)} ÿØ.ÿπ` : '0 ÿØ.ÿπ'],
                        ['Gold', (advancedResults && advancedResults.gold && advancedResults.gold.count !== undefined) ? Number(advancedResults.gold.count) : 0,
                         (advancedResults && advancedResults.gold && advancedResults.gold.promoAmount) ? `${formatNumber(advancedResults.gold.promoAmount)} ÿØ.ÿπ` : '0 ÿØ.ÿπ',
                         (advancedResults && advancedResults.gold && advancedResults.gold.officialAmount) ? `${formatNumber(advancedResults.gold.officialAmount)} ÿØ.ÿπ` : '0 ÿØ.ÿπ',
                         (advancedResults && advancedResults.gold && advancedResults.gold.officialAmount && advancedResults.gold.promoAmount) ? `${formatNumber(advancedResults.gold.officialAmount - advancedResults.gold.promoAmount)} ÿØ.ÿπ` : '0 ÿØ.ÿπ'],
                        ['Platinum', (advancedResults && advancedResults.platinum && advancedResults.platinum.count !== undefined) ? Number(advancedResults.platinum.count) : 0,
                         (advancedResults && advancedResults.platinum && advancedResults.platinum.promoAmount) ? `${formatNumber(advancedResults.platinum.promoAmount)} ÿØ.ÿπ` : '0 ÿØ.ÿπ',
                         (advancedResults && advancedResults.platinum && advancedResults.platinum.officialAmount) ? `${formatNumber(advancedResults.platinum.officialAmount)} ÿØ.ÿπ` : '0 ÿØ.ÿπ',
                         (advancedResults && advancedResults.platinum && advancedResults.platinum.officialAmount && advancedResults.platinum.promoAmount) ? `${formatNumber(advancedResults.platinum.officialAmount - advancedResults.platinum.promoAmount)} ÿØ.ÿπ` : '0 ÿØ.ÿπ'],
                        [],
                        ['‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê'],
                        ['ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉÿßÿ™ ÿßŸÑŸÉÿßŸÖŸÑÿ©'],
                        ['‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê'],
                        [],
                        ['#', 'ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ', 'ŸÜŸàÿπ ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ', 'ÿßŸÑÿ™ÿßÿ±ŸäÿÆ', 'ÿ™ÿßÿ±ŸäÿÆ 1', 'ÿ™ÿßÿ±ŸäÿÆ 2', 'ÿ™ÿßÿ±ŸäÿÆ 3', 'ÿßŸÑŸÅÿ±ŸÇ ÿ®ÿßŸÑÿ£ŸäÿßŸÖ', 'ÿ≥ÿπÿ± ÿßŸÑÿπÿ±ÿ∂', 'ÿßŸÑÿ≥ÿπÿ± ÿßŸÑÿ±ÿ≥ŸÖŸä']
                    ];
                    agentAdvancedDetails.forEach((detail, idx) => {
                        const date1 = detail.date1 || '';
                        const date2 = detail.date2 || '';
                        const date3 = detail.date3 || '';
                        const dateStr = detail.dateStr || detail.date || detail.createdAt || date1 || '';
                        const daysDiff = detail.daysDiff !== undefined && detail.daysDiff !== null ? detail.daysDiff : '-';
                        let promoPrice = detail.promoPrice;
                        let officialPrice = detail.officialPrice;
                        if (!promoPrice && !officialPrice && detail.subscription) {
                            const category = getSubscriptionCategory(detail.subscription, detail.agent || '');
                            if (category) {
                                promoPrice = getSubscriptionPrice(detail.subscription, category, 'advanced', 'promo');
                                officialPrice = getSubscriptionPrice(detail.subscription, category, 'advanced', 'official');
                            }
                        }
                        const promoPriceStr = promoPrice ? `${formatNumber(promoPrice)} ÿØ.ÿπ` : '-';
                        const officialPriceStr = officialPrice ? `${formatNumber(officialPrice)} ÿØ.ÿπ` : '-';
                        advancedSheetData.push([
                            idx + 1,
                            detail.username || '',
                            detail.subscription || '',
                            dateStr,
                            date1,
                            date2,
                            date3,
                            daysDiff,
                            promoPriceStr,
                            officialPriceStr
                        ]);
                    });
                    const ws3 = XLSX.utils.aoa_to_sheet(advancedSheetData);
                    applyExcelStyling(ws3, advancedSheetData.length, advancedSheetData[0] ? advancedSheetData[0].length : 0);
                    XLSX.utils.book_append_sheet(wb, ws3, '3 ÿ£ÿ¥Ÿáÿ± ŸÖÿÆŸÅÿ∂');
                }
                if (twoMonthsResults || agentTwoMonthsDetails.length > 0) {
                    let totalCount = twoMonthsResults ? (twoMonthsResults.total.count || 0) : agentTwoMonthsDetails.length;
                    let totalPromoAmount = 0;
                    let totalOfficialAmount = 0;
                    if (twoMonthsResults && twoMonthsResults.total) {
                        totalPromoAmount = twoMonthsResults.total.promoAmount || 0;
                        totalOfficialAmount = twoMonthsResults.total.officialAmount || 0;
                    } else {
                        agentTwoMonthsDetails.forEach(d => {
                            if (d.promoPrice) totalPromoAmount += Number(d.promoPrice) || 0;
                            if (d.officialPrice) totalOfficialAmount += Number(d.officialPrice) || 0;
                        });
                    }
                    const totalProfit = totalOfficialAmount - totalPromoAmount;
                    const agent = agentsList.find(a => a.name === agentName);
                    const agentSubName = agent?.subName || '';
                    const agentDisplayName = agentSubName ? `${agentName}\n${agentSubName}` : agentName;
                    
                    const twoMonthsSheetData = [
                        ['‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê'],
                        ['ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑÿπÿ±ÿ∂ ÿßŸÑŸÖÿÆŸÅÿ∂ ŸÑÿ¥Ÿáÿ±ŸäŸÜ'],
                        ['‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê'],
                        [],
                        ['ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿ™ÿ≠ŸÑŸäŸÑ'],
                        ['ÿßÿ≥ŸÖ ÿßŸÑŸàŸÉŸäŸÑ', agentDisplayName],
                        ['ÿßŸÑÿ¥Ÿáÿ±', monthYear],
                        [],
                        ['‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê'],
                        ['ŸÖŸÑÿÆÿµ ÿßŸÑÿ™ÿ≠ŸÑŸäŸÑ'],
                        ['‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê'],
                        [],
                        ['ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä', totalCount],
                        ['ŸÖÿ®ŸÑÿ∫ ÿßŸÑÿπÿ±ÿ∂', `${formatNumber(totalPromoAmount)} ÿØ.ÿπ`],
                        ['ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑÿ±ÿ≥ŸÖŸä', `${formatNumber(totalOfficialAmount)} ÿØ.ÿπ`],
                        ['ÿßŸÑÿ±ÿ®ÿ≠/ÿßŸÑÿ±ÿßÿ¨ÿπ', `${formatNumber(totalProfit)} ÿØ.ÿπ`],
                        [],
                        ['‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê'],
                        ['ÿ™ŸÅÿßÿµŸäŸÑ ÿ≠ÿ≥ÿ® ŸÜŸàÿπ ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ'],
                        ['‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê'],
                        [],
                        ['ÿßŸÑŸÜŸàÿπ', 'ÿßŸÑÿπÿØÿØ', 'ŸÖÿ®ŸÑÿ∫ ÿßŸÑÿπÿ±ÿ∂', 'ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑÿ±ÿ≥ŸÖŸä', 'ÿßŸÑÿ±ÿ®ÿ≠/ÿßŸÑÿ±ÿßÿ¨ÿπ'],
                        ['Bronze', (twoMonthsResults && twoMonthsResults.bronze && twoMonthsResults.bronze.count !== undefined) ? Number(twoMonthsResults.bronze.count) : 0,
                         (twoMonthsResults && twoMonthsResults.bronze && twoMonthsResults.bronze.promoAmount) ? `${formatNumber(twoMonthsResults.bronze.promoAmount)} ÿØ.ÿπ` : '0 ÿØ.ÿπ',
                         (twoMonthsResults && twoMonthsResults.bronze && twoMonthsResults.bronze.officialAmount) ? `${formatNumber(twoMonthsResults.bronze.officialAmount)} ÿØ.ÿπ` : '0 ÿØ.ÿπ',
                         (twoMonthsResults && twoMonthsResults.bronze && twoMonthsResults.bronze.officialAmount && twoMonthsResults.bronze.promoAmount) ? `${formatNumber(twoMonthsResults.bronze.officialAmount - twoMonthsResults.bronze.promoAmount)} ÿØ.ÿπ` : '0 ÿØ.ÿπ'],
                        ['Silver', (twoMonthsResults && twoMonthsResults.silver && twoMonthsResults.silver.count !== undefined) ? Number(twoMonthsResults.silver.count) : 0,
                         (twoMonthsResults && twoMonthsResults.silver && twoMonthsResults.silver.promoAmount) ? `${formatNumber(twoMonthsResults.silver.promoAmount)} ÿØ.ÿπ` : '0 ÿØ.ÿπ',
                         (twoMonthsResults && twoMonthsResults.silver && twoMonthsResults.silver.officialAmount) ? `${formatNumber(twoMonthsResults.silver.officialAmount)} ÿØ.ÿπ` : '0 ÿØ.ÿπ',
                         (twoMonthsResults && twoMonthsResults.silver && twoMonthsResults.silver.officialAmount && twoMonthsResults.silver.promoAmount) ? `${formatNumber(twoMonthsResults.silver.officialAmount - twoMonthsResults.silver.promoAmount)} ÿØ.ÿπ` : '0 ÿØ.ÿπ'],
                        ['Gold', (twoMonthsResults && twoMonthsResults.gold && twoMonthsResults.gold.count !== undefined) ? Number(twoMonthsResults.gold.count) : 0,
                         (twoMonthsResults && twoMonthsResults.gold && twoMonthsResults.gold.promoAmount) ? `${formatNumber(twoMonthsResults.gold.promoAmount)} ÿØ.ÿπ` : '0 ÿØ.ÿπ',
                         (twoMonthsResults && twoMonthsResults.gold && twoMonthsResults.gold.officialAmount) ? `${formatNumber(twoMonthsResults.gold.officialAmount)} ÿØ.ÿπ` : '0 ÿØ.ÿπ',
                         (twoMonthsResults && twoMonthsResults.gold && twoMonthsResults.gold.officialAmount && twoMonthsResults.gold.promoAmount) ? `${formatNumber(twoMonthsResults.gold.officialAmount - twoMonthsResults.gold.promoAmount)} ÿØ.ÿπ` : '0 ÿØ.ÿπ'],
                        ['Platinum', (twoMonthsResults && twoMonthsResults.platinum && twoMonthsResults.platinum.count !== undefined) ? Number(twoMonthsResults.platinum.count) : 0,
                         (twoMonthsResults && twoMonthsResults.platinum && twoMonthsResults.platinum.promoAmount) ? `${formatNumber(twoMonthsResults.platinum.promoAmount)} ÿØ.ÿπ` : '0 ÿØ.ÿπ',
                         (twoMonthsResults && twoMonthsResults.platinum && twoMonthsResults.platinum.officialAmount) ? `${formatNumber(twoMonthsResults.platinum.officialAmount)} ÿØ.ÿπ` : '0 ÿØ.ÿπ',
                         (twoMonthsResults && twoMonthsResults.platinum && twoMonthsResults.platinum.officialAmount && twoMonthsResults.platinum.promoAmount) ? `${formatNumber(twoMonthsResults.platinum.officialAmount - twoMonthsResults.platinum.promoAmount)} ÿØ.ÿπ` : '0 ÿØ.ÿπ'],
                        [],
                        ['‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê'],
                        ['ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉÿßÿ™ ÿßŸÑŸÉÿßŸÖŸÑÿ©'],
                        ['‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê'],
                        [],
                        ['#', 'ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ', 'ŸÜŸàÿπ ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ', 'ÿßŸÑÿ™ÿßÿ±ŸäÿÆ', 'ÿ™ÿßÿ±ŸäÿÆ 1', 'ÿ™ÿßÿ±ŸäÿÆ 2', 'ÿßŸÑŸÅÿ±ŸÇ ÿ®ÿßŸÑÿ£ŸäÿßŸÖ', 'ÿ≥ÿπÿ± ÿßŸÑÿπÿ±ÿ∂', 'ÿßŸÑÿ≥ÿπÿ± ÿßŸÑÿ±ÿ≥ŸÖŸä']
                    ];
                    agentTwoMonthsDetails.forEach((detail, idx) => {
                        const date1 = detail.date1 || '';
                        const date2 = detail.date2 || '';
                        const dateStr = detail.dateStr || detail.date || detail.createdAt || date1 || '';
                        const daysDiff = detail.daysDiff !== undefined && detail.daysDiff !== null ? detail.daysDiff : '-';
                        let promoPrice = detail.promoPrice;
                        let officialPrice = detail.officialPrice;
                        if (!promoPrice && !officialPrice && detail.subscription) {
                            const category = getSubscriptionCategory(detail.subscription, detail.agent || '');
                            if (category) {
                                promoPrice = getSubscriptionPrice(detail.subscription, category, 'twoMonths', 'promo');
                                const monthlyOfficialPrice = getSubscriptionPrice(detail.subscription, category, 'basic');
                                officialPrice = monthlyOfficialPrice * 2;
                            }
                        }
                        const promoPriceStr = promoPrice ? `${formatNumber(promoPrice)} ÿØ.ÿπ` : '-';
                        const officialPriceStr = officialPrice ? `${formatNumber(officialPrice)} ÿØ.ÿπ` : '-';
                        twoMonthsSheetData.push([
                            idx + 1,
                            detail.username || '',
                            detail.subscription || '',
                            dateStr,
                            date1,
                            date2,
                            daysDiff,
                            promoPriceStr,
                            officialPriceStr
                        ]);
                    });
                    const ws4 = XLSX.utils.aoa_to_sheet(twoMonthsSheetData);
                    applyExcelStyling(ws4, twoMonthsSheetData.length, twoMonthsSheetData[0] ? twoMonthsSheetData[0].length : 0);
                    XLSX.utils.book_append_sheet(wb, ws4, 'ÿ¥Ÿáÿ±ŸäŸÜ ŸÖÿÆŸÅÿ∂');
                }
                const filename = `ÿ™ŸÇÿ±Ÿäÿ±_${agentName}_${monthYear}_${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, filename);
                showSuccessMessage(`ÿ™ŸÖ ÿ™ÿµÿØŸäÿ± ÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑŸàŸÉŸäŸÑ ${agentName} ÿ®ŸÜÿ¨ÿßÿ≠`);
                await logActivity('ÿ™ÿµÿØŸäÿ± ÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑÿ£ÿ±ÿ¥ŸäŸÅ', `ÿ™ŸÖ ÿ™ÿµÿØŸäÿ± ÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑÿ£ÿ±ÿ¥ŸäŸÅ ÿßŸÑŸÉÿßŸÖŸÑ ŸÑŸÑŸàŸÉŸäŸÑ ${agentName} ŸÑÿ¥Ÿáÿ± ${monthYear}`);
            } catch (error) {
                console.error('Error exporting agent archive report:', error);
                alert('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿµÿØŸäÿ± ÿßŸÑÿ™ŸÇÿ±Ÿäÿ±: ' + error.message);
            }
        }
        async function printArchivePDF(agentName, monthYear) {
            if (!supabaseClient) {
                alert('Supabase ÿ∫Ÿäÿ± ŸÖÿ™ÿµŸÑ');
                return;
            }
            try {
                showSuccessMessage('ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ÿ∂Ÿäÿ± ÿßŸÑÿ™ŸÇÿ±Ÿäÿ±...');
                const percentagesArchive = await getArchiveForMonth('agent_percentages', monthYear);
                if (!percentagesArchive || !percentagesArchive.data || !percentagesArchive.data[agentName]) {
                    alert('ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™ ŸÑŸáÿ∞ÿß ÿßŸÑŸàŸÉŸäŸÑ ŸÅŸä ÿßŸÑÿ£ÿ±ÿ¥ŸäŸÅ');
                    return;
                }
                const agentData = percentagesArchive.data[agentName];
                const agent = agentsList.find(a => a.name === agentName);
                const { data: basicArchiveData } = await supabaseClient.from('analysis_archives').select('*').eq('month_year', monthYear).eq('analysis_type', 'basic').maybeSingle();
                const { data: advancedArchiveData } = await supabaseClient.from('analysis_archives').select('*').eq('month_year', monthYear).eq('analysis_type', 'advanced').maybeSingle();
                const { data: twoMonthsArchiveData } = await supabaseClient.from('analysis_archives').select('*').eq('month_year', monthYear).eq('analysis_type', 'two_months').maybeSingle();
                const getAgentResultsFromArchive = (archiveData, agentName, type) => {
                    if (!archiveData || !archiveData.data) return null;
                    if (archiveData.data.agentReports && archiveData.data.agentReports[agentName]) {
                        const agentReport = archiveData.data.agentReports[agentName];
                        if (type === 'basic' && agentReport.basic) return agentReport.basic;
                        if (type === 'advanced' && agentReport.advanced) return agentReport.advanced;
                        if (type === 'two_months' && agentReport.twoMonths) return agentReport.twoMonths;
                    }
                    if (archiveData.data.results) {
                        if (archiveData.data.results.agentName === agentName) {
                            return archiveData.data.results;
                        }
                        if (archiveData.data.results[agentName]) {
                            if (type === 'basic' && archiveData.data.results[agentName].basic) return archiveData.data.results[agentName].basic;
                            if (type === 'advanced' && archiveData.data.results[agentName].advanced) return archiveData.data.results[agentName].advanced;
                            if (type === 'two_months' && archiveData.data.results[agentName].twoMonths) return archiveData.data.results[agentName].twoMonths;
                        }
                    }
                    return null;
                };
                const basicResults = basicArchiveData ? getAgentResultsFromArchive({ data: basicArchiveData.data }, agentName, 'basic') : null;
                const advancedResults = advancedArchiveData ? getAgentResultsFromArchive({ data: advancedArchiveData.data }, agentName, 'advanced') : null;
                const twoMonthsResults = twoMonthsArchiveData ? getAgentResultsFromArchive({ data: twoMonthsArchiveData.data }, agentName, 'two_months') : null;
                generateArchivePDFReport(agentName, monthYear, agentData, agent, basicResults, advancedResults, twoMonthsResults).then((pdfBlob) => {
                    const safeName = agentName.replace(/[^a-zA-Z0-9_]/g, '_');
                    const filename = `Agent_Archive_Report_${safeName}_${monthYear}_${formatDateForFilename(new Date())}.pdf`;
                    downloadFile(pdfBlob, filename);
                    logActivity('ÿ∑ÿ®ÿßÿπÿ© ÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑÿ£ÿ±ÿ¥ŸäŸÅ PDF', `ÿ™ŸÖ ÿ∑ÿ®ÿßÿπÿ© ÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑÿ£ÿ±ÿ¥ŸäŸÅ PDF ŸÑŸÑŸàŸÉŸäŸÑ ${agentName} ŸÑÿ¥Ÿáÿ± ${monthYear}`);
                    showSuccessMessage(`ÿ™ŸÖ ÿ∑ÿ®ÿßÿπÿ© ÿ™ŸÇÿ±Ÿäÿ± PDF ŸÑŸÑŸàŸÉŸäŸÑ ${agentName} ÿ®ŸÜÿ¨ÿßÿ≠`);
                }).catch((error) => {
                    console.error('Error generating PDF:', error);
                    alert('ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿ•ŸÜÿ¥ÿßÿ° ŸÖŸÑŸÅ PDF. Ÿäÿ±ÿ¨Ÿâ ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ© ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ.');
                });
            } catch (error) {
                console.error('Error printing archive PDF:', error);
                alert('ÿÆÿ∑ÿ£ ŸÅŸä ÿ∑ÿ®ÿßÿπÿ© ÿßŸÑÿ™ŸÇÿ±Ÿäÿ±: ' + error.message);
            }
        }
        function generateArchivePDFReport(agentName, monthYear, agentData, agent, basicResults = null, advancedResults = null, twoMonthsResults = null) {
            return new Promise(async (resolve, reject) => {
                try {
                    const { jsPDF } = window.jspdf;
                    if (!jsPDF) {
                        reject(new Error('jsPDF ÿ∫Ÿäÿ± ŸÖÿ™ŸàŸÅÿ±'));
                        return;
                    }
                    const doc = new jsPDF('portrait', 'mm', 'a4');
                    const pageWidth = doc.internal.pageSize.getWidth();
                    const pageHeight = doc.internal.pageSize.getHeight();
                    let yPos = 15;
                    doc.setFontSize(20);
                    doc.setTextColor(128, 28, 50);
                    doc.setFont('helvetica', 'bold');
                    const titleText = 'Agent Archive Report';
                    const titleWidth = doc.getTextWidth(titleText);
                    doc.text(titleText, (pageWidth - titleWidth) / 2, yPos);
                    yPos += 12;
                    doc.setFontSize(14);
                    doc.setTextColor(0, 0, 0);
                    doc.setFont('helvetica', 'bold');
                    doc.text(`Agent Name: ${agentName}`, 20, yPos);
                    yPos += 8;
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(12);
                    doc.text(`Month: ${monthYear}`, 20, yPos);
                    yPos += 8;
                    doc.text(`Export Date: ${new Date().toLocaleString('en-US')}`, 20, yPos);
                    yPos += 10;
                    if (agent?.phone) {
                        doc.text(`Phone Number: ${agent.phone}`, 20, yPos);
                        yPos += 8;
                    }
                    if (agent?.email) {
                        doc.text(`Email: ${agent.email}`, 20, yPos);
                        yPos += 8;
                    }
                    yPos += 5;
                    doc.setFontSize(16);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(128, 28, 50);
                    doc.text('Summary of Percentages and Details', 20, yPos);
                    yPos += 10;
                    doc.setFontSize(12);
                    doc.setTextColor(0, 0, 0);
                    doc.setFont('helvetica', 'normal');
                    doc.text(`Percentage: ${agentData.percentage || 0}%`, 20, yPos);
                    yPos += 8;
                    doc.text(`Total Amount: ${formatNumberEnglish(agentData.iqT || 0)} IQD`, 20, yPos);
                    yPos += 8;
                    doc.setFont('helvetica', 'bold');
                    doc.text(`Agent Percentage: ${formatNumberEnglish(agentData.agentPercentageAmount || 0)} IQD`, 20, yPos);
                    yPos += 10;
                    if ((agentData.deductions || 0) > 0) {
                        doc.setFont('helvetica', 'normal');
                        doc.setTextColor(220, 53, 69);
                        doc.text(`Deductions: ${formatNumberEnglish(agentData.deductions || 0)} IQD`, 20, yPos);
                        yPos += 8;
                    }
                    if ((agentData.penalties || 0) > 0) {
                        doc.setTextColor(220, 53, 69);
                        doc.text(`Penalties: ${formatNumberEnglish(agentData.penalties || 0)} IQD`, 20, yPos);
                        yPos += 8;
                    }
                    doc.setFontSize(14);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(128, 28, 50);
                    doc.text(`Net Amount: ${formatNumberEnglish(agentData.netPercentage || 0)} IQD`, 20, yPos);
                    yPos += 15;
                    if (agentData.iqP || agentData.iqG || agentData.iqS || agentData.iqB || 
                        agentData.countP || agentData.countG || agentData.countS || agentData.countB) {
                        doc.setFontSize(14);
                        doc.setFont('helvetica', 'bold');
                        doc.setTextColor(128, 28, 50);
                        doc.text('Percentage Details by Profile Type', 20, yPos);
                        yPos += 10;
                        const percentageTableData = [];
                        if (agentData.countB || agentData.iqB) {
                            const percentageAmount = ((Number(agentData.iqB) || 0) * (Number(agentData.percentage) || 0)) / 100;
                            percentageTableData.push([
                                'Bronze ',
                                formatNumberEnglish(Number(agentData.countB) || 0),
                                formatNumberEnglish(Number(agentData.iqB) || 0),
                                formatNumberEnglish(Math.round(percentageAmount))
                            ]);
                        }
                        if (agentData.countG || agentData.iqG) {
                            const percentageAmount = ((Number(agentData.iqG) || 0) * (Number(agentData.percentage) || 0)) / 100;
                            percentageTableData.push([
                                'Gold ',
                                formatNumberEnglish(Number(agentData.countG) || 0),
                                formatNumberEnglish(Number(agentData.iqG) || 0),
                                formatNumberEnglish(Math.round(percentageAmount))
                            ]);
                        }
                        if (agentData.countS || agentData.iqS) {
                            const percentageAmount = ((Number(agentData.iqS) || 0) * (Number(agentData.percentage) || 0)) / 100;
                            percentageTableData.push([
                                'Silver ',
                                formatNumberEnglish(Number(agentData.countS) || 0),
                                formatNumberEnglish(Number(agentData.iqS) || 0),
                                formatNumberEnglish(Math.round(percentageAmount))
                            ]);
                        }
                        if (agentData.countP || agentData.iqP) {
                            const percentageAmount = ((Number(agentData.iqP) || 0) * (Number(agentData.percentage) || 0)) / 100;
                            percentageTableData.push([
                                'Platinum ',
                                formatNumberEnglish(Number(agentData.countP) || 0),
                                formatNumberEnglish(Number(agentData.iqP) || 0),
                                formatNumberEnglish(Math.round(percentageAmount))
                            ]);
                        }
                        const totalCount = (Number(agentData.countB) || 0) + (Number(agentData.countG) || 0) + 
                                         (Number(agentData.countS) || 0) + (Number(agentData.countP) || 0);
                        const totalAmount = (Number(agentData.iqB) || 0) + (Number(agentData.iqG) || 0) + 
                                          (Number(agentData.iqS) || 0) + (Number(agentData.iqP) || 0);
                        percentageTableData.push([
                            'Total',
                            formatNumberEnglish(totalCount),
                            formatNumberEnglish(totalAmount),
                            formatNumberEnglish(Math.round(agentData.agentPercentageAmount || 0))
                        ]);
                        doc.autoTable({
                            startY: yPos,
                            head: [['Profile Type', 'Count', 'Total Amount', 'Percentage Amount']],
                            body: percentageTableData,
                            theme: 'striped',
                            headStyles: {
                                fillColor: [128, 28, 50],
                                textColor: [255, 255, 255],
                                fontStyle: 'bold',
                                fontSize: 12,
                                halign: 'center'
                            },
                            bodyStyles: {
                                fontSize: 12,
                                halign: 'center'
                            },
                            columnStyles: {
                                0: { halign: 'left' },
                                1: { halign: 'center' },
                                2: { halign: 'center' },
                                3: { halign: 'center' }
                            },
                            didParseCell: function(data) {
                                if (data.row.index === percentageTableData.length - 1) {
                                    data.cell.styles.fillColor = [248, 249, 250];
                                    data.cell.styles.fontStyle = 'bold';
                                    data.cell.styles.fontSize = 12;
                                }
                            },
                            margin: { left: 20, right: 20 }
                        });
                        yPos = doc.lastAutoTable.finalY + 10;
                    }
                    if (basicResults || advancedResults || twoMonthsResults) {
                        if (yPos > pageHeight - 50) {
                            doc.addPage();
                            yPos = 15;
                        }
                        doc.setFontSize(14);
                        doc.setFont('helvetica', 'bold');
                        doc.setTextColor(128, 28, 50);
                        doc.text('Offers Summary', 20, yPos);
                        yPos += 10;
                        const offersTableData = [];
                        if (basicResults && basicResults.total) {
                            const basicAmount = basicResults.total.amount || 0;
                            const basicCount = basicResults.total.count || 0;
                            offersTableData.push([
                                'Free Offer',
                                formatNumberEnglish(basicCount),
                                formatNumberEnglish(basicAmount) + ' IQD'
                            ]);
                        }
                        if (advancedResults && advancedResults.total) {
                            const advancedProfit = advancedResults.total.profit || 0;
                            const advancedCount = advancedResults.total.count || 0;
                            offersTableData.push([
                                '3 Months Discounted',
                                formatNumberEnglish(advancedCount),
                                formatNumberEnglish(advancedProfit) + ' IQD'
                            ]);
                        }
                        if (twoMonthsResults && twoMonthsResults.total) {
                            const twoMonthsProfit = twoMonthsResults.total.profit || 0;
                            const twoMonthsCount = twoMonthsResults.total.count || 0;
                            offersTableData.push([
                                '2 Months Discounted',
                                formatNumberEnglish(twoMonthsCount),
                                formatNumberEnglish(twoMonthsProfit) + ' IQD'
                            ]);
                        }
                        if (offersTableData.length > 0) {
                            let totalOffersCount = 0;
                            let totalOffersAmount = 0;
                            if (basicResults && basicResults.total) {
                                totalOffersCount += (basicResults.total.count || 0);
                                totalOffersAmount += (basicResults.total.amount || 0);
                            }
                            if (advancedResults && advancedResults.total) {
                                totalOffersCount += (advancedResults.total.count || 0);
                                totalOffersAmount += (advancedResults.total.profit || 0);
                            }
                            if (twoMonthsResults && twoMonthsResults.total) {
                                totalOffersCount += (twoMonthsResults.total.count || 0);
                                totalOffersAmount += (twoMonthsResults.total.profit || 0);
                            }
                            offersTableData.push([
                                'Total',
                                formatNumberEnglish(totalOffersCount),
                                formatNumberEnglish(totalOffersAmount) + ' IQD'
                            ]);
                            doc.autoTable({
                                startY: yPos,
                                head: [['Offer Type', 'Profiles Count', 'Net Amount']],
                                body: offersTableData,
                                theme: 'striped',
                                headStyles: {
                                    fillColor: [128, 28, 50],
                                    textColor: [255, 255, 255],
                                    fontStyle: 'bold',
                                    fontSize: 12,
                                    halign: 'center'
                                },
                                bodyStyles: {
                                    fontSize: 12,
                                    halign: 'center'
                                },
                                columnStyles: {
                                    0: { halign: 'left' },
                                    1: { halign: 'center' },
                                    2: { halign: 'center' }
                                },
                                didParseCell: function(data) {
                                    if (data.row.index === offersTableData.length - 1) {
                                        data.cell.styles.fillColor = [248, 249, 250];
                                        data.cell.styles.fontStyle = 'bold';
                                        data.cell.styles.fontSize = 12;
                                    }
                                },
                                margin: { left: 20, right: 20 }
                            });
                            yPos = doc.lastAutoTable.finalY + 10;
                        }
                    }
                    if (yPos > pageHeight - 30) {
                        doc.addPage();
                        yPos = 15;
                    }
                    const pdfBlob = doc.output('blob');
                    resolve(pdfBlob);
                } catch (error) {
                    reject(error);
                }
            });
        }
        document.addEventListener('DOMContentLoaded', async function() {
            const savedUser = localStorage.getItem('loggedInUser');
            const savedRole = localStorage.getItem('currentUserRole');
            const savedUserId = localStorage.getItem('currentUserId');
            
            if (savedUser && savedRole && savedUserId) {
                const loginScreen = document.getElementById('loginScreen');
                const dashboard = document.getElementById('dashboard');
                if (loginScreen) {
                    loginScreen.style.display = 'none';
                    loginScreen.classList.add('hidden');
                }
                if (dashboard) {
                    dashboard.style.display = 'flex';
                    dashboard.classList.remove('hidden');
                }
            }
            
            await initSupabase();
            
            const loginButton = document.getElementById('loginButton');
            const loginPassword = document.getElementById('loginPassword');
            const loginUsername = document.getElementById('loginUsername');
            
            if (loginButton) {
                loginButton.addEventListener('click', handleLogin);
            }
            
            if (loginPassword) {
                loginPassword.addEventListener('keydown', function(event) {
                    if (event.key === 'Enter') {
                        event.preventDefault();
                        if (typeof handleLogin === 'function') {
                            handleLogin();
                        }
                    }
                });
            }
            
            if (loginUsername) {
                loginUsername.addEventListener('keydown', function(event) {
                    if (event.key === 'Enter') {
                        event.preventDefault();
                        loginPassword?.focus();
                    }
                });
            }
            
            if (savedUser && savedRole && savedUserId) {
                loggedInUser = savedUser;
                currentUserRole = savedRole;
                currentUserId = savedUserId;
                showMainApp();
            } else {
                const loginScreen = document.getElementById('loginScreen');
                const dashboard = document.getElementById('dashboard');
                if (loginScreen) {
                    loginScreen.style.display = 'flex';
                    loginScreen.classList.remove('hidden');
                }
                if (dashboard) {
                    dashboard.style.display = 'none';
                    dashboard.classList.add('hidden');
                }
            }
            
            await loadDataFromDatabase();
            updateCurrentDate();
            setupPercentageFileUpload();
            setupPercentageTableEventListeners();
            setupFileUploads();
            loadSidebarState();
            loadPercentageData();
            loadSettings();
            loadActivityLog();
            restoreTabAndScroll();
            loadTheme();
            const savedDefaultPercentage = parseFloat(localStorage.getItem('defaultAgentPercentage')) || 16;
            const defaultPercentageInput = document.getElementById('defaultAgentPercentage');
            if (defaultPercentageInput) {
                defaultPercentageInput.value = savedDefaultPercentage;
            }
            const select = document.getElementById('selectedAgentForPercentage');
            if (select) {
                updateAgentsListForPercentage();
            }
            setTimeout(async () => {
                await restoreSavedData();
                if (Object.keys(agentReports).length > 0) {
                    updateAgentSummary();
                }
            }, 500);
            autoLoginFromMaster();
            
            setTimeout(() => {
                const popup = document.getElementById('userContactPopup');
                const sidebarUserBtn = document.getElementById('sidebarUser');
                
                if (popup && sidebarUserBtn) {
                    popup.addEventListener('mouseenter', function(e) {
                        e.stopPropagation();
                    });
                    
                    popup.addEventListener('mouseleave', function(e) {
                        e.stopPropagation();
                    });
                    
                    popup.addEventListener('click', function(e) {
                        e.stopPropagation();
                    });
                    
                    const links = popup.querySelectorAll('a');
                    links.forEach(link => {
                        link.addEventListener('click', function(e) {
                            e.stopPropagation();
                        });
                    });
                    
                }
            }, 1000);
        });
        window.addEventListener('beforeunload', function() {
            try {
                if (agentReports && Object.keys(agentReports).length > 0) {
                    const agentReportsSummary = Object.keys(agentReports).reduce((acc, agentName) => {
                        acc[agentName] = {};
                        if (agentReports[agentName].basic) {
                            acc[agentName].basic = {
                                total: agentReports[agentName].basic.total || null,
                                agentName: agentReports[agentName].basic.agentName || null
                            };
                        }
                        if (agentReports[agentName].advanced) {
                            acc[agentName].advanced = {
                                total: agentReports[agentName].advanced.total || null,
                                agentName: agentReports[agentName].advanced.agentName || null
                            };
                        }
                        if (agentReports[agentName].twoMonths) {
                            acc[agentName].twoMonths = {
                                total: agentReports[agentName].twoMonths.total || null,
                                agentName: agentReports[agentName].twoMonths.agentName || null
                            };
                        }
                        return acc;
                    }, {});
                    saveDataToStorage('agentReports', agentReportsSummary);
                }
            } catch (error) {
                console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ≠ŸÅÿ∏ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÇÿ®ŸÑ ÿ•ÿπÿßÿØÿ© ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ:', error);
            }
        });
        function updateCurrentDate() {
            const now = new Date();
            const arabicDate = formatArabicDate(now);
            document.getElementById('currentDateTime').textContent = arabicDate;
        }
        function formatArabicDate(date) {
            const day = date.getDate().toString();
            const month = arabicMonths[date.getMonth()];
            const year = date.getFullYear().toString();
            return `${day} ${month} ${year}`;
        }
        function switchTab(tabName) {
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            if (event && event.target.closest('.nav-item')) {
                event.target.closest('.nav-item').classList.add('active');
            } else {
                const navItems = document.querySelectorAll('.nav-item');
                if (tabName === 'summary') navItems[0]?.classList.add('active');
                else if (tabName === 'basic') navItems[1]?.classList.add('active');
                else if (tabName === 'twoMonths') navItems[2]?.classList.add('active');
                else if (tabName === 'advanced') navItems[3]?.classList.add('active');
                else if (tabName === 'agents') navItems[4]?.classList.add('active');
                else if (tabName === 'agentPercentage') navItems[5]?.classList.add('active');
                else if (tabName === 'activity') navItems[6]?.classList.add('active');
                else if (tabName === 'settings') navItems[7]?.classList.add('active');
                else if (tabName === 'archive') navItems[8]?.classList.add('active');
                else if (tabName === 'users') navItems[9]?.classList.add('active');
            }
            const tabElement = document.getElementById(tabName + 'Tab');
            if (tabElement) {
                tabElement.classList.add('active');
                localStorage.setItem('currentTab', tabName);
                const currentScroll = window.scrollY || document.documentElement.scrollTop;
                localStorage.setItem(`scrollPosition_${tabName}`, currentScroll.toString());
                
                if (tabName === 'summary') {
                    updateAgentSummary();
                } else if (tabName === 'agents') {
                    renderAgentsList();
                } else if (tabName === 'agentPercentage') {
                    updateAgentsListForPercentage();
                } else if (tabName === 'activity') {
                    setTimeout(() => refreshActivityLog(), 100);
                } else if (tabName === 'archive') {
                    setTimeout(() => refreshArchivesList(), 100);
                } else if (tabName === 'users') {
                    loadUsers();
                }
            }
        }
        
        function restoreTabAndScroll() {
            const savedTab = localStorage.getItem('currentTab');
            if (savedTab) {
                setTimeout(() => {
                    const originalEvent = window.event;
                    window.event = null;
                    switchTab(savedTab);
                    window.event = originalEvent;
                    
                    const savedScrollPosition = localStorage.getItem(`scrollPosition_${savedTab}`);
                    if (savedScrollPosition) {
                        setTimeout(() => {
                            window.scrollTo({
                                top: parseInt(savedScrollPosition),
                                behavior: 'auto'
                            });
                        }, 400);
                    }
                }, 200);
            }
        }
        function setupFileUploads() {
            setupFileUpload('basic');
            setupFileUpload('advanced');
            setupFileUpload('twoMonths');
        }
        function setupFileUpload(type) {
            const uploadDiv = document.getElementById(type + 'FileUpload');
            const fileInput = document.getElementById(type + 'FileInput');
            uploadDiv.addEventListener('click', () => fileInput.click());
            uploadDiv.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadDiv.classList.add('dragover');
            });
            uploadDiv.addEventListener('dragleave', () => {
                uploadDiv.classList.remove('dragover');
            });
            uploadDiv.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadDiv.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFileSelect(files[0], type);
                }
            });
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleFileSelect(e.target.files[0], type);
                }
            });
        }
        function handleFileSelect(file, type) {
            const fileName = document.getElementById(type + 'FileName');
            if (fileName) {
            fileName.textContent = `ÿ™ŸÖ ÿßÿÆÿ™Ÿäÿßÿ± ÿßŸÑŸÖŸÑŸÅ: ${file.name}`;
            fileName.classList.remove('hidden');
            }
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    if (file.name.toLowerCase().endsWith('.csv')) {
                        Papa.parse(e.target.result, {
                            header: false,
                            skipEmptyLines: true,
                            complete: function(results) {
                                const processedData = convertArrayToObjects(results.data);
                                if (type === 'basic') {
                                    basicData = processedData;
                                } else if (type === 'advanced') {
                                    advancedData = processedData;
                                } else {
                                    twoMonthsData = processedData;
                                }
                                showSuccessMessage(`ÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ ŸÖŸÑŸÅ CSV ÿ®ŸÜÿ¨ÿßÿ≠ - ${results.data.length} ÿµŸÅ`);
                            }
                        });
                    } else if (file.name.toLowerCase().match(/\.(xlsx|xls)$/)) {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { 
                            header: 1,
                            defval: "",
                            raw: false
                        });
                        const processedData = convertArrayToObjects(jsonData);
                        if (type === 'basic') {
                            basicData = processedData;
                        } else if (type === 'advanced') {
                            advancedData = processedData;
                        } else {
                            twoMonthsData = processedData;
                        }
                        showSuccessMessage(`ÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ ŸÖŸÑŸÅ Excel ÿ®ŸÜÿ¨ÿßÿ≠ - ${jsonData.length} ÿµŸÅ`);
                    } else {
                        alert('ŸÜŸàÿπ ÿßŸÑŸÖŸÑŸÅ ÿ∫Ÿäÿ± ŸÖÿØÿπŸàŸÖ. Ÿäÿ±ÿ¨Ÿâ ÿßÿÆÿ™Ÿäÿßÿ± ŸÖŸÑŸÅ Excel (.xlsx, .xls) ÿ£Ÿà CSV');
                    }
                } catch (error) {
                    alert('ÿÆÿ∑ÿ£ ŸÅŸä ŸÇÿ±ÿßÿ°ÿ© ÿßŸÑŸÖŸÑŸÅ: ' + error.message);
                    console.error('File reading error:', error);
                }
            };
            if (file.name.toLowerCase().match(/\.(xlsx|xls)$/)) {
                reader.readAsArrayBuffer(file);
            } else {
                reader.readAsText(file);
            }
        }
        function convertArrayToObjects(arrayData) {
            if (!arrayData || arrayData.length === 0) return [];
            const headers = arrayData[0];
            const result = [];
            for (let i = 1; i < arrayData.length; i++) {
                const obj = {};
                for (let j = 0; j < headers.length; j++) {
                    obj[`Column${String.fromCharCode(65 + j)}`] = arrayData[i][j] || '';
                    obj[j] = arrayData[i][j] || '';
                }
                result.push(obj);
            }
            return result;
        }
        function saveDataToStorage(key, data) {
            const largeDataKeys = ['basicData', 'advancedData', 'twoMonthsData', 'basicDetails', 'advancedDetails', 'twoMonthsDetails'];
            if (largeDataKeys.includes(key)) {
                return;
            }
            try {
                const dataString = JSON.stringify(data);
                if (dataString.length > 2000000) {
                    console.warn(`‚ö† Skipping save to localStorage for ${key}: data too large (${(dataString.length / 1024 / 1024).toFixed(2)}MB)`);
                    return;
                }
                localStorage.setItem(key, dataString);
            } catch (error) {
                if (error.name === 'QuotaExceededError') {
                    console.warn(`‚ö† Quota exceeded for ${key}, skipping localStorage save. Data is saved in database.`);
                    try {
                        localStorage.removeItem('basicData');
                        localStorage.removeItem('advancedData');
                        localStorage.removeItem('twoMonthsData');
                        localStorage.removeItem('basicDetails');
                        localStorage.removeItem('advancedDetails');
                        localStorage.removeItem('twoMonthsDetails');
                        const dataString = JSON.stringify(data);
                        if (dataString.length <= 2000000) {
                            localStorage.setItem(key, dataString);
                        }
                    } catch (e) {
                        console.warn(`‚ö† Could not free up space for ${key}, data is saved in database only`);
                    }
                } else {
                    console.error(`Error saving ${key} to storage:`, error);
                }
            }
        }
        function loadDataFromStorage(key, defaultValue = null) {
            try {
                const saved = localStorage.getItem(key);
                if (saved) {
                    return JSON.parse(saved);
                }
            } catch (error) {
                console.error(`Error loading ${key} from storage:`, error);
            }
            return defaultValue;
        }
        async function restoreSavedData() {
            try {
                const savedBasicData = loadDataFromStorage('basicData');
                if (savedBasicData && savedBasicData.length > 0) {
                    basicData = savedBasicData;
                }
                const savedAdvancedData = loadDataFromStorage('advancedData');
                if (savedAdvancedData && savedAdvancedData.length > 0) {
                    advancedData = savedAdvancedData;
                }
                const savedTwoMonthsData = loadDataFromStorage('twoMonthsData');
                if (savedTwoMonthsData && savedTwoMonthsData.length > 0) {
                    twoMonthsData = savedTwoMonthsData;
                }
                const savedBasicDetails = loadDataFromStorage('basicDetails', []);
                if (savedBasicDetails.length > 0) {
                    basicDetails = savedBasicDetails;
                }
                const savedAdvancedDetails = loadDataFromStorage('advancedDetails', []);
                if (savedAdvancedDetails.length > 0) {
                    advancedDetails = savedAdvancedDetails;
                }
                const savedTwoMonthsDetails = loadDataFromStorage('twoMonthsDetails', []);
                if (savedTwoMonthsDetails.length > 0) {
                    twoMonthsDetails = savedTwoMonthsDetails;
                }
                if (supabaseClient) {
                    try {
                        const monthYear = getCurrentMonthYear();
                        const { data: basicArchive } = await supabaseClient
                            .from('analysis_archives')
                            .select('data')
                            .eq('month_year', monthYear)
                            .eq('analysis_type', 'basic')
                            .maybeSingle();
                        
                        const { data: advancedArchive } = await supabaseClient
                            .from('analysis_archives')
                            .select('data')
                            .eq('month_year', monthYear)
                            .eq('analysis_type', 'advanced')
                            .maybeSingle();
                        
                        const { data: twoMonthsArchive } = await supabaseClient
                            .from('analysis_archives')
                            .select('data')
                            .eq('month_year', monthYear)
                            .eq('analysis_type', 'two_months')
                            .maybeSingle();
                        
                        if (basicArchive && basicArchive.data && basicArchive.data.agentReports) {
                            Object.keys(basicArchive.data.agentReports).forEach(agentName => {
                                if (!agentReports[agentName]) {
                                    agentReports[agentName] = {};
                                }
                                if (basicArchive.data.agentReports[agentName].basic) {
                                    agentReports[agentName].basic = basicArchive.data.agentReports[agentName].basic;
                                }
                            });
                        }
                        
                        if (advancedArchive && advancedArchive.data && advancedArchive.data.agentReports) {
                            Object.keys(advancedArchive.data.agentReports).forEach(agentName => {
                                if (!agentReports[agentName]) {
                                    agentReports[agentName] = {};
                                }
                                if (advancedArchive.data.agentReports[agentName].advanced) {
                                    agentReports[agentName].advanced = advancedArchive.data.agentReports[agentName].advanced;
                                }
                            });
                        }
                        
                        if (twoMonthsArchive && twoMonthsArchive.data && twoMonthsArchive.data.agentReports) {
                            Object.keys(twoMonthsArchive.data.agentReports).forEach(agentName => {
                                if (!agentReports[agentName]) {
                                    agentReports[agentName] = {};
                                }
                                if (twoMonthsArchive.data.agentReports[agentName].twoMonths) {
                                    agentReports[agentName].twoMonths = twoMonthsArchive.data.agentReports[agentName].twoMonths;
                                }
                            });
                        }
                    } catch (e) {
                        console.warn('Error loading agentReports from database in restoreSavedData:', e);
                    }
                }
                
                if (Object.keys(agentReports).length === 0) {
                    const savedAgentReports = loadDataFromStorage('agentReports', {});
                    if (savedAgentReports && Object.keys(savedAgentReports).length > 0) {
                        agentReports = savedAgentReports;
                    }
                }
                
                if (Object.keys(agentReports).length > 0) {
                    try {
                        const agentReportsString = JSON.stringify(agentReports);
                        if (agentReportsString.length <= 2000000) {
                            localStorage.setItem('agentReports', agentReportsString);
                        }
                    } catch (e) {
                        console.warn('Could not save agentReports to localStorage:', e);
                    }
                }
                
                const savedBasicResults = loadDataFromStorage('basicResults');
                if (savedBasicResults && savedBasicResults.total && savedBasicResults.total.count > 0) {
                    await displayBasicResults(savedBasicResults);
                }
                const savedAdvancedResults = loadDataFromStorage('advancedResults');
                if (savedAdvancedResults && savedAdvancedResults.total && savedAdvancedResults.total.count > 0) {
                    await displayAdvancedResults(savedAdvancedResults);
                }
                const savedTwoMonthsResults = loadDataFromStorage('twoMonthsResults');
                if (savedTwoMonthsResults && savedTwoMonthsResults.total && savedTwoMonthsResults.total.count > 0) {
                    await displayTwoMonthsResults(savedTwoMonthsResults);
                }
            } catch (error) {
                console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿßÿ≥ÿ™ÿπÿßÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≠ŸÅŸàÿ∏ÿ©:', error);
            }
        }
        function showSuccessMessage(message) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'success-message';
            messageDiv.textContent = message;
            messageDiv.style.position = 'fixed';
            messageDiv.style.top = '20px';
            messageDiv.style.right = '20px';
            messageDiv.style.zIndex = '9999';
            messageDiv.style.maxWidth = '300px';
            document.body.appendChild(messageDiv);
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.parentNode.removeChild(messageDiv);
                }
            }, 3000);
        }
        let isAnalyzingBasic = false;
        let isAnalyzingAdvanced = false;
        let isAnalyzingTwoMonths = false;
        function analyzeBasicData() {
            if (isAnalyzingBasic) {
                showSuccessMessage('ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÑŸäŸÑÿå Ÿäÿ±ÿ¨Ÿâ ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ±...');
                return;
            }
            if (!basicData) {
                alert('Ÿäÿ±ÿ¨Ÿâ ÿßÿÆÿ™Ÿäÿßÿ± ŸÖŸÑŸÅ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ£ŸàŸÑÿßŸã');
                return;
            }
            isAnalyzingBasic = true;
            basicDetails = [];
            showLoading('basic');
                try {
                    const results = processBasicData(basicData);
                    if (results.total.count === 0) {
                        alert('ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ÿ®ŸäÿßŸÜÿßÿ™ ÿµÿßŸÑÿ≠ÿ© ŸÑŸÑÿ™ÿ≠ŸÑŸäŸÑ. ÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿµÿ≠ÿ© ÿ™ŸÜÿ≥ŸäŸÇ ÿßŸÑŸÖŸÑŸÅ.');
                        hideLoading('basic');
                    isAnalyzingBasic = false;
                        return;
                    }
                    displayBasicResults(results);
                    hideLoading('basic');
                    showSuccessMessage(`ÿ™ŸÖ ÿ™ÿ≠ŸÑŸäŸÑ ${results.total.count} ÿßÿ¥ÿ™ÿ±ÿßŸÉ ŸÖÿ¨ÿßŸÜŸä ÿ®ŸÜÿ¨ÿßÿ≠`);
                isAnalyzingBasic = false;
                } catch (error) {
                    alert('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÑŸäŸÑ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿπÿ±ÿ∂ ÿßŸÑŸÖÿ¨ÿßŸÜŸä: ' + error.message);
                    hideLoading('basic');
                isAnalyzingBasic = false;
                }
        }
        function processBasicData(data) {
            const results = {
                bronze: { count: 0, amount: 0 },
                silver: { count: 0, amount: 0 },
                gold: { count: 0, amount: 0 },
                platinum: { count: 0, amount: 0 },
                total: { count: 0, amount: 0 },
                agentName: ''
            };
            if (data.length === 0) return results;
            results.agentName = data[0]['ColumnF'] || data[0][5] || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ';
            for (let i = 0; i < data.length; i++) {
                const row = data[i];
                const id = row['ColumnA'] || row[0];
                const createdAt = row['ColumnB'] || row[1];
                const username = row['ColumnC'] || row[2];
                const subscription = row['ColumnI'] || row[8];
                const count = row['ColumnP'] || row[15];
                const agent = row['ColumnF'] || row[5] || '';
                if (!createdAt || !username || !subscription || count != 1) continue;
                const subType = String(subscription).trim();
                const agentName = String(agent).trim();
                const category = getSubscriptionCategory(subType, agentName);
                if (!category) continue;
                const price = getSubscriptionPrice(subType, category, 'basic');
                if (price > 0) {
                    basicDetails.push({
                        username: String(username).trim(),
                        subscription: subType,
                        agent: agentName,
                        date: createdAt,
                        dateStr: createdAt,
                        createdAt: createdAt,
                        price: price,
                        promoPrice: price,
                        officialPrice: price,
                        type: 'ŸÖÿ¨ÿßŸÜŸä'
                    });
                    switch(category) {
                        case 'B':
                        results.bronze.count++;
                        results.bronze.amount += price;
                            break;
                        case 'S':
                        results.silver.count++;
                        results.silver.amount += price;
                            break;
                        case 'G':
                        results.gold.count++;
                        results.gold.amount += price;
                            break;
                        case 'P':
                        results.platinum.count++;
                        results.platinum.amount += price;
                            break;
                    }
                }
            }
            results.total.count = results.bronze.count + results.silver.count + results.gold.count + results.platinum.count;
            results.total.amount = results.bronze.amount + results.silver.amount + results.gold.amount + results.platinum.amount;
            return results;
        }
        async function saveAgentAnalysisToArchive(agentName, analysisType, analysisData) {
            if (!supabaseClient) {
                return;
            }
            const monthYear = analysisData.monthYear || getCurrentMonthYear();
            const normalizedAgentName = normalizeAgentName(agentName);
            const archiveLockKey = `archive_${agentName}_${analysisType}_${monthYear}`;
            
            if (archiveSaveLocks.has(archiveLockKey)) {
                return;
            }
            
            archiveSaveLocks.set(archiveLockKey, true);
            
            try {
                try {
                    const archiveData = {
                        agentName: agentName,
                        analysisType: analysisType,
                        monthYear: monthYear,
                        analysisDate: analysisData.analysisDate || new Date().toISOString(),
                        results: analysisData.results,
                        details: Array.isArray(analysisData.details) ? analysisData.details.slice(0, 500) : [],
                        data: Array.isArray(analysisData.data) ? analysisData.data.slice(0, 200) : []
                    };
                    const existingArchives = JSON.parse(localStorage.getItem('agentAnalysesArchive') || '{}');
                    if (!existingArchives[monthYear]) {
                        existingArchives[monthYear] = {};
                    }
                    existingArchives[monthYear][agentName] = existingArchives[monthYear][agentName] || {};
                    existingArchives[monthYear][agentName][analysisType] = archiveData;
                    const dataString = JSON.stringify(existingArchives);
                    if (dataString.length > 1500000) {
                        const monthYearKey = monthYear;
                        const agentKey = agentName;
                        if (existingArchives[monthYearKey] && existingArchives[monthYearKey][agentKey]) {
                            delete existingArchives[monthYearKey][agentKey][analysisType];
                            const reducedString = JSON.stringify(existingArchives);
                            if (reducedString.length <= 1500000) {
                                localStorage.setItem('agentAnalysesArchive', reducedString);
                            }
                        }
                    } else {
                        localStorage.setItem('agentAnalysesArchive', dataString);
                    }
                } catch (e) {
                    if (e.name === 'QuotaExceededError') {
                        try {
                            const existingArchives = JSON.parse(localStorage.getItem('agentAnalysesArchive') || '{}');
                            const monthYearKey = monthYear;
                            const agentKey = agentName;
                            if (existingArchives[monthYearKey] && existingArchives[monthYearKey][agentKey] && existingArchives[monthYearKey][agentKey][analysisType]) {
                                delete existingArchives[monthYearKey][agentKey][analysisType];
                                localStorage.setItem('agentAnalysesArchive', JSON.stringify(existingArchives));
                            }
                        } catch (cleanupError) {
                        }
                    }
                }
                
                const { data: existingAgentsList } = await supabaseClient
                    .from('agents_list')
                    .select('*')
                    .eq('month_year', monthYear)
                    .maybeSingle();
                
                let agentsListData = existingAgentsList?.data || [];
                if (!Array.isArray(agentsListData)) {
                    agentsListData = [];
                }
                
                let agentIndex = agentsListData.findIndex(a => normalizeAgentName(a.name) === normalizedAgentName);
                if (agentIndex === -1) {
                    agentsListData.push({
                        name: agentName,
                        percentage: 16,
                        offers: {},
                        details: {}
                    });
                    agentIndex = agentsListData.length - 1;
                }
                
                if (!agentsListData[agentIndex].offers) {
                    agentsListData[agentIndex].offers = {};
                }
                if (!agentsListData[agentIndex].details) {
                    agentsListData[agentIndex].details = {};
                }
                
                agentsListData[agentIndex].offers[analysisType] = {
                    results: analysisData.results,
                    analysisDate: analysisData.analysisDate || new Date().toISOString()
                };
                
                if (analysisData.details && analysisData.details.length > 0) {
                    const uniqueDetails = [];
                    const detailsMap = new Map();
                    
                    analysisData.details.forEach(detail => {
                        const key = `${detail.username || ''}_${detail.subscription || ''}_${detail.date || detail.dateStr || detail.date1 || detail.date2 || detail.date3 || ''}_${detail.type || ''}`;
                        if (!detailsMap.has(key)) {
                            detailsMap.set(key, detail);
                            uniqueDetails.push(detail);
                        }
                    });
                    
                    agentsListData[agentIndex].details[analysisType] = uniqueDetails;
                } else {
                    delete agentsListData[agentIndex].details[analysisType];
                }
                
                await saveToDatabase('agents_list', agentsListData, { monthYear: monthYear });
                
                } catch (error) {
                    console.error('Error saving agent analysis to archive:', error);
                } finally {
                    archiveSaveLocks.delete(archiveLockKey);
                }
            }
        async function displayBasicResults(results) {
            await ensureAgentExists(results.agentName);
            if (!agentReports[results.agentName]) {
                agentReports[results.agentName] = {};
            }
            agentReports[results.agentName].basic = results;
            const monthYear = extractMonthYearFromDetails(basicDetails) || 
                             extractMonthYearFromData(basicData) || 
                             getCurrentMonthYear();
            
            try {
                const agentReportsString = JSON.stringify(agentReports);
                if (agentReportsString.length <= 2000000) {
                    localStorage.setItem('agentReports', agentReportsString);
                }
            } catch (e) {
                console.warn('Could not save agentReports to localStorage:', e);
            }
            
            await saveAgentAnalysisToArchive(results.agentName, 'basic', {
                results: results,
                details: basicDetails,
                data: basicData,
                monthYear: monthYear,
                analysisDate: new Date().toISOString()
            });
            
            saveToDatabase('analysis_archives', {
                data: basicData,
                details: basicDetails,
                results: results,
                agentReports: agentReports
            }, { analysis_type: 'basic', monthYear: monthYear }).catch(err => console.error('Error saving basic analysis:', err));
            saveAgentsListToDatabase(monthYear).catch(err => console.error('Error saving agents list:', err));
            const agentInfo = document.getElementById('basicAgentInfo');
            agentInfo.innerHTML = `
                <h3> ÿßŸÑÿπÿ±ÿ∂ ÿßŸÑŸÖÿ¨ÿßŸÜŸä</h3>
                <p><strong>ÿßÿ≥ŸÖ ÿßŸÑŸàŸÉŸäŸÑ:</strong> ${results.agentName}</p>
                <p><strong>ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ™ÿ≠ŸÑŸäŸÑ:</strong> ${formatArabicDate(new Date())}</p>
                <p><strong>ŸÜŸàÿπ ÿßŸÑÿ™ÿ≠ŸÑŸäŸÑ:</strong> ÿ≠ÿ≥ÿßÿ® ÿßŸÑÿπÿ±ÿ∂ ÿßŸÑŸÖÿ¨ÿßŸÜŸä</p>
            `;
            const resultsGrid = document.getElementById('basicResultsGrid');
            resultsGrid.innerHTML = `
                <div class="result-card bronze">
                    <h3> Bronze</h3>
                    <div class="count">${results.bronze.count}</div>
                    <div class="amount">${formatNumber(results.bronze.amount)} ÿØ.ÿπ</div>
                </div>
                <div class="result-card silver">
                    <h3> Silver</h3>
                    <div class="count">${results.silver.count}</div>
                    <div class="amount">${formatNumber(results.silver.amount)} ÿØ.ÿπ</div>
                </div>
                <div class="result-card gold">
                    <h3> Gold</h3>
                    <div class="count">${results.gold.count}</div>
                    <div class="amount">${formatNumber(results.gold.amount)} ÿØ.ÿπ</div>
                </div>
                <div class="result-card platinum">
                    <h3> Platinum</h3>
                    <div class="count">${results.platinum.count}</div>
                    <div class="amount">${formatNumber(results.platinum.amount)} ÿØ.ÿπ</div>
                </div>
                <div class="result-card">
                    <h3> ÿßŸÑŸÖÿ¨ŸÖŸàÿπ</h3>
                    <div class="count">${results.total.count}</div>
                    <div class="amount">${formatNumber(results.total.amount)} ÿØ.ÿπ</div>
                </div>
            `;
            document.getElementById('basicResults').classList.remove('hidden');
            updateAgentSummary();
            logActivity('ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ - ÿßŸÑÿπÿ±ÿ∂ ÿßŸÑŸÖÿ¨ÿßŸÜŸä', `ÿ™ŸÖ ÿ™ÿ≠ŸÑŸäŸÑ ${results.total.count} ÿßÿ¥ÿ™ÿ±ÿßŸÉ ŸÖÿ¨ÿßŸÜŸä ŸÑŸÑŸàŸÉŸäŸÑ ${results.agentName}`);
        }
        function analyzeAdvancedData() {
            if (isAnalyzingAdvanced) {
                showSuccessMessage('ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÑŸäŸÑÿå Ÿäÿ±ÿ¨Ÿâ ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ±...');
                return;
            }
            if (!advancedData) {
                alert('Ÿäÿ±ÿ¨Ÿâ ÿßÿÆÿ™Ÿäÿßÿ± ŸÖŸÑŸÅ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ£ŸàŸÑÿßŸã');
                return;
            }
            isAnalyzingAdvanced = true;
            advancedDetails = [];
            showLoading('advanced');
                try {
                    const results = processAdvancedData(advancedData);
                    if (results.total.count === 0) {
                        alert('ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ÿ™ŸÅÿπŸäŸÑÿßÿ™ ÿµÿßŸÑÿ≠ÿ© ŸÑŸÑÿπÿ±ÿ∂ ÿßŸÑŸÖÿÆŸÅÿ∂. ÿ™ÿ£ŸÉÿØ ŸÖŸÜ Ÿàÿ¨ŸàÿØ 3 ÿßÿ¥ÿ™ÿ±ÿßŸÉÿßÿ™ ÿÆŸÑÿßŸÑ 5 ÿ£ŸäÿßŸÖ ŸÑŸÜŸÅÿ≥ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ.');
                        hideLoading('advanced');
                    isAnalyzingAdvanced = false;
                        return;
                    }
                    displayAdvancedResults(results);
                    hideLoading('advanced');
                    showSuccessMessage(`ÿ™ŸÖ ÿ™ÿ≠ŸÑŸäŸÑ ${results.total.count} ÿ™ŸÅÿπŸäŸÑ ŸÑŸÑÿπÿ±ÿ∂ ÿßŸÑŸÖÿÆŸÅÿ∂ ÿ®ŸÜÿ¨ÿßÿ≠`);
                isAnalyzingAdvanced = false;
                } catch (error) {
                    alert('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÑŸäŸÑ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿπÿ±ÿ∂ ÿßŸÑŸÖÿÆŸÅÿ∂: ' + error.message);
                    hideLoading('advanced');
                isAnalyzingAdvanced = false;
                }
        }
        function processAdvancedData(data) {
            const results = {
                bronze: { count: 0, promoAmount: 0, officialAmount: 0 },
                silver: { count: 0, promoAmount: 0, officialAmount: 0 },
                gold: { count: 0, promoAmount: 0, officialAmount: 0 },
                platinum: { count: 0, promoAmount: 0, officialAmount: 0 },
                total: { count: 0, promoAmount: 0, officialAmount: 0, profit: 0 },
                agentName: ''
            };
            if (data.length === 0) return results;
            results.agentName = data[0]['ColumnF'] || data[0][5] || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ';
            const userSubscriptions = {};
            const subscriptionDetails = {};
            data.forEach(row => {
                const id = row['ColumnA'] || row[0];
                const createdAt = row['ColumnB'] || row[1];
                const username = row['ColumnC'] || row[2];
                const subscription = row['ColumnI'] || row[8];
                const agent = row['ColumnF'] || row[5] || '';
                if (!createdAt || !username || !subscription) return;
                let dateObj;
                try {
                    if (createdAt instanceof Date) {
                        dateObj = createdAt;
                    } else {
                        if (typeof createdAt === 'number' && createdAt > 40000) {
                            dateObj = new Date((createdAt - 25569) * 86400 * 1000);
                        } else {
                            dateObj = new Date(createdAt);
                        }
                    }
                    if (isNaN(dateObj.getTime())) {
                        return;
                    }
                } catch (e) {
                    return;
                }
                const key = `${String(username).trim()}|${String(subscription).trim()}`;
                if (!userSubscriptions[key]) {
                    userSubscriptions[key] = [];
                    subscriptionDetails[key] = [];
                }
                userSubscriptions[key].push(dateObj);
                subscriptionDetails[key].push({
                    date: dateObj,
                    dateStr: createdAt,
                    username: String(username).trim(),
                    subscription: String(subscription).trim(),
                    agent: String(agent).trim()
                });
            });
            Object.keys(userSubscriptions).forEach(key => {
                const [username, subscription] = key.split('|');
                const dates = userSubscriptions[key].sort((a, b) => a - b);
                const details = subscriptionDetails[key];
                let activations = 0;
                const used = new Array(dates.length).fill(false);
                const activationDetails = [];
                let found = true;
                while (found) {
                    found = false;
                for (let i = 0; i < dates.length - 2; i++) {
                    if (used[i]) continue;
                    for (let j = i + 1; j < dates.length - 1; j++) {
                        if (used[j]) continue;
                        for (let k = j + 1; k < dates.length; k++) {
                            if (used[k]) continue;
                            const daysDiff = (dates[k] - dates[i]) / (1000 * 60 * 60 * 24);
                            if (daysDiff <= 5) {
                                used[i] = used[j] = used[k] = true;
                                activations++;
                                    const subType = details[i].subscription.trim();
                                    const agentName = details[i].agent || '';
                                    const category = getSubscriptionCategory(subType, agentName);
                                    const promoPrice = category ? getSubscriptionPrice(subType, category, 'advanced', 'promo') : 0;
                                    const officialPrice = category ? getSubscriptionPrice(subType, category, 'advanced', 'official') : 0;
                                    activationDetails.push({
                                        username: details[i].username,
                                        subscription: details[i].subscription,
                                        agent: details[i].agent,
                                        date: details[i].dateStr,
                                        dateStr: details[i].dateStr,
                                        createdAt: details[i].dateStr,
                                        date1: details[i].dateStr,
                                        date2: details[j].dateStr,
                                        date3: details[k].dateStr,
                                        daysDiff: Math.round(daysDiff * 100) / 100,
                                        promoPrice: promoPrice,
                                        officialPrice: officialPrice,
                                        type: 'ÿ´ŸÑÿßÿ´ ÿ£ÿ¥Ÿáÿ±'
                                    });
                                    found = true;
                                break;
                            }
                        }
                            if (found) break;
                        }
                        if (found) break;
                    }
                }
                advancedDetails.push(...activationDetails);
                if (activations > 0) {
                    const subType = subscription.trim();
                    const agentName = details[0]?.agent || '';
                    const category = getSubscriptionCategory(subType, agentName);
                    if (category) {
                        const promoPrice = getSubscriptionPrice(subType, category, 'advanced', 'promo');
                        const officialPrice = getSubscriptionPrice(subType, category, 'advanced', 'official');
                        switch(category) {
                            case 'B':
                        results.bronze.count += activations;
                        results.bronze.promoAmount += activations * promoPrice;
                        results.bronze.officialAmount += activations * officialPrice;
                                break;
                            case 'S':
                        results.silver.count += activations;
                        results.silver.promoAmount += activations * promoPrice;
                        results.silver.officialAmount += activations * officialPrice;
                                break;
                            case 'G':
                        results.gold.count += activations;
                        results.gold.promoAmount += activations * promoPrice;
                        results.gold.officialAmount += activations * officialPrice;
                                break;
                            case 'P':
                        results.platinum.count += activations;
                        results.platinum.promoAmount += activations * promoPrice;
                        results.platinum.officialAmount += activations * officialPrice;
                                break;
                        }
                    }
                }
            });
            results.total.count = results.bronze.count + results.silver.count + results.gold.count + results.platinum.count;
            results.total.promoAmount = results.bronze.promoAmount + results.silver.promoAmount + results.gold.promoAmount + results.platinum.promoAmount;
            results.total.officialAmount = results.bronze.officialAmount + results.silver.officialAmount + results.gold.officialAmount + results.platinum.officialAmount;
            results.total.profit = results.total.officialAmount - results.total.promoAmount;
            return results;
        }
        async function displayAdvancedResults(results) {
            const displayLockKey = `display_advanced_${results.agentName}_${getCurrentMonthYear()}`;
            if (displayLocks.has(displayLockKey)) {
                return;
            }
            displayLocks.set(displayLockKey, true);
            
            try {
                await ensureAgentExists(results.agentName);
                if (!agentReports[results.agentName]) {
                    agentReports[results.agentName] = {};
                }
                agentReports[results.agentName].advanced = results;
                const monthYear = extractMonthYearFromDetails(advancedDetails) || 
                                 extractMonthYearFromData(advancedData) || 
                                 getCurrentMonthYear();
                
                try {
                    const agentReportsString = JSON.stringify(agentReports);
                    if (agentReportsString.length <= 2000000) {
                        localStorage.setItem('agentReports', agentReportsString);
                    }
                } catch (e) {
                }
                
                await saveAgentAnalysisToArchive(results.agentName, 'advanced', {
                    results: results,
                    details: advancedDetails,
                    data: advancedData,
                    monthYear: monthYear,
                    analysisDate: new Date().toISOString()
                });
                
                saveToDatabase('analysis_archives', {
                    data: advancedData,
                    details: advancedDetails,
                    results: results,
                    agentReports: agentReports
                }, { analysis_type: 'advanced', monthYear: monthYear }).then(saved => {
                    if (saved) {
                    } else {
                        console.warn('‚ö† Advanced analysis save failed or timed out. Data is saved in database only (too large for localStorage).');
                    }
                }).catch(err => {
                    console.error('Error saving advanced analysis:', err);
                });
                
                saveAgentsListToDatabase(monthYear).then(saved => {
                    if (saved) {
                    }
                }).catch(err => {
                    console.error('Error saving agents list:', err);
                });
                
                const agentInfo = document.getElementById('advancedAgentInfo');
                agentInfo.innerHTML = `
                    <h3>ÿßŸÑÿπÿ±ÿ∂ ÿßŸÑŸÖÿÆŸÅÿ∂ ŸÑÿ´ŸÑÿßÿ´ ÿ£ÿ¥Ÿáÿ±</h3>
                    <p><strong>ÿßÿ≥ŸÖ ÿßŸÑŸàŸÉŸäŸÑ:</strong> ${results.agentName}</p>
                    <p><strong>ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ™ÿ≠ŸÑŸäŸÑ:</strong> ${formatArabicDate(new Date())}</p>
                    <p><strong>ŸÜŸàÿπ ÿßŸÑÿ™ÿ≠ŸÑŸäŸÑ:</strong> ÿ≠ÿ≥ÿßÿ® ÿßŸÑÿπÿ±ÿ∂ ÿßŸÑŸÖÿÆŸÅÿ∂ ŸÑÿ´ŸÑÿßÿ´ ÿ£ÿ¥Ÿáÿ±</p>
                    <p><strong>ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿ±ÿßÿ¨ÿπ ŸÑŸÑŸàŸÉŸäŸÑ :</strong> ${formatNumber(results.total.profit)} ÿØ.ÿπ</p>
                `;
                const resultsGrid = document.getElementById('advancedResultsGrid');
                resultsGrid.innerHTML = `
                    <div class="result-card bronze">
                        <h3> Bronze</h3>
                        <div class="count">${results.bronze.count}</div>
                        <div class="amount">ÿπÿ±ÿ∂: ${formatNumber(results.bronze.promoAmount)} ÿØ.ÿπ</div>
                        <div class="amount">ÿ±ÿ≥ŸÖŸä: ${formatNumber(results.bronze.officialAmount)} ÿØ.ÿπ</div>
                    </div>
                    <div class="result-card silver">
                        <h3> Silver</h3>
                        <div class="count">${results.silver.count}</div>
                        <div class="amount">ÿπÿ±ÿ∂: ${formatNumber(results.silver.promoAmount)} ÿØ.ÿπ</div>
                        <div class="amount">ÿ±ÿ≥ŸÖŸä: ${formatNumber(results.silver.officialAmount)} ÿØ.ÿπ</div>
                    </div>
                    <div class="result-card gold">
                        <h3> Gold</h3>
                        <div class="count">${results.gold.count}</div>
                        <div class="amount">ÿπÿ±ÿ∂: ${formatNumber(results.gold.promoAmount)} ÿØ.ÿπ</div>
                        <div class="amount">ÿ±ÿ≥ŸÖŸä: ${formatNumber(results.gold.officialAmount)} ÿØ.ÿπ</div>
                    </div>
                    <div class="result-card platinum">
                        <h3> Platinum</h3>
                        <div class="count">${results.platinum.count}</div>
                        <div class="amount">ÿπÿ±ÿ∂: ${formatNumber(results.platinum.promoAmount)} ÿØ.ÿπ</div>
                        <div class="amount">ÿ±ÿ≥ŸÖŸä: ${formatNumber(results.platinum.officialAmount)} ÿØ.ÿπ</div>
                    </div>
                    <div class="result-card">
                        <h3> ÿßŸÑŸÖÿ¨ŸÖŸàÿπ</h3>
                        <div class="count">${results.total.count}</div>
                        <div class="amount">ÿπÿ±ÿ∂: ${formatNumber(results.total.promoAmount)} ÿØ.ÿπ</div>
                        <div class="amount">ÿ±ÿ≥ŸÖŸä: ${formatNumber(results.total.officialAmount)} ÿØ.ÿπ</div>
                    </div>
                `;
                document.getElementById('advancedResults').classList.remove('hidden');
                updateAgentSummary();
                logActivity('ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ - 3 ÿ£ÿ¥Ÿáÿ±', `ÿ™ŸÖ ÿ™ÿ≠ŸÑŸäŸÑ ${results.total.count} ÿ™ŸÅÿπŸäŸÑ ŸÑŸÑÿπÿ±ÿ∂ ÿßŸÑŸÖÿÆŸÅÿ∂ 3 ÿ£ÿ¥Ÿáÿ± ŸÑŸÑŸàŸÉŸäŸÑ ${results.agentName}`);
            } finally {
                setTimeout(() => {
                    displayLocks.delete(displayLockKey);
                }, 5000);
            }
            updateAgentSummary();
            logActivity('ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ - 3 ÿ£ÿ¥Ÿáÿ±', `ÿ™ŸÖ ÿ™ÿ≠ŸÑŸäŸÑ ${results.total.count} ÿ™ŸÅÿπŸäŸÑ ŸÑŸÑÿπÿ±ÿ∂ ÿßŸÑŸÖÿÆŸÅÿ∂ 3 ÿ£ÿ¥Ÿáÿ± ŸÑŸÑŸàŸÉŸäŸÑ ${results.agentName}`);
        }
        function analyzeTwoMonthsData() {
            if (isAnalyzingTwoMonths) {
                showSuccessMessage('ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÑŸäŸÑÿå Ÿäÿ±ÿ¨Ÿâ ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ±...');
                return;
            }
            if (!twoMonthsData) {
                alert('Ÿäÿ±ÿ¨Ÿâ ÿßÿÆÿ™Ÿäÿßÿ± ŸÖŸÑŸÅ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ£ŸàŸÑÿßŸã');
                return;
            }
            isAnalyzingTwoMonths = true;
            twoMonthsDetails = [];
            showLoading('twoMonths');
                try {
                    const results = processTwoMonthsData(twoMonthsData);
                    if (results.total.count === 0) {
                        alert('ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ÿ™ŸÅÿπŸäŸÑÿßÿ™ ÿµÿßŸÑÿ≠ÿ© ŸÑŸÑÿπÿ±ÿ∂ ÿßŸÑŸÖÿÆŸÅÿ∂ ŸÑÿ¥Ÿáÿ±ŸäŸÜ. ÿ™ÿ£ŸÉÿØ ŸÖŸÜ Ÿàÿ¨ŸàÿØ 2 ÿßÿ¥ÿ™ÿ±ÿßŸÉÿßÿ™ ÿÆŸÑÿßŸÑ 5 ÿ£ŸäÿßŸÖ ŸÑŸÜŸÅÿ≥ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ.');
                        hideLoading('twoMonths');
                    isAnalyzingTwoMonths = false;
                        return;
                    }
                    displayTwoMonthsResults(results);
                    hideLoading('twoMonths');
                    showSuccessMessage(`ÿ™ŸÖ ÿ™ÿ≠ŸÑŸäŸÑ ${results.total.count} ÿ™ŸÅÿπŸäŸÑ ŸÑŸÑÿπÿ±ÿ∂ ÿßŸÑŸÖÿÆŸÅÿ∂ ŸÑÿ¥Ÿáÿ±ŸäŸÜ ÿ®ŸÜÿ¨ÿßÿ≠`);
                isAnalyzingTwoMonths = false;
                } catch (error) {
                    alert('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÑŸäŸÑ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿπÿ±ÿ∂ ÿßŸÑŸÖÿÆŸÅÿ∂ ŸÑÿ¥Ÿáÿ±ŸäŸÜ: ' + error.message);
                    hideLoading('twoMonths');
                isAnalyzingTwoMonths = false;
                }
        }
        function processTwoMonthsData(data) {
            const results = {
                bronze: { count: 0, promoAmount: 0, officialAmount: 0 },
                silver: { count: 0, promoAmount: 0, officialAmount: 0 },
                gold: { count: 0, promoAmount: 0, officialAmount: 0 },
                platinum: { count: 0, promoAmount: 0, officialAmount: 0 },
                total: { count: 0, promoAmount: 0, officialAmount: 0, profit: 0 },
                agentName: '',
                dateFrom: null,
                dateTo: null
            };
            if (data.length === 0) return results;
            results.agentName = data[0]['ColumnF'] || data[0][5] || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ';
            const userSubscriptions = {};
            const subscriptionDetails = {};
            data.forEach(row => {
                const id = row['ColumnA'] || row[0];
                const createdAt = row['ColumnB'] || row[1];
                const username = row['ColumnC'] || row[2];
                const subscription = row['ColumnI'] || row[8];
                const agent = row['ColumnF'] || row[5] || '';
                if (!createdAt || !username || !subscription) return;
                let dateObj;
                try {
                    if (createdAt instanceof Date) {
                        dateObj = createdAt;
                    } else {
                        if (typeof createdAt === 'number' && createdAt > 40000) {
                            dateObj = new Date((createdAt - 25569) * 86400 * 1000);
                        } else {
                            dateObj = new Date(createdAt);
                        }
                    }
                    if (isNaN(dateObj.getTime())) {
                        return;
                    }
                } catch (e) {
                    return;
                }
                const key = `${String(username).trim()}|${String(subscription).trim()}`;
                if (!userSubscriptions[key]) {
                    userSubscriptions[key] = [];
                    subscriptionDetails[key] = [];
                }
                userSubscriptions[key].push(dateObj);
                subscriptionDetails[key].push({
                    date: dateObj,
                    dateStr: createdAt,
                    username: String(username).trim(),
                    subscription: String(subscription).trim(),
                    agent: String(agent).trim()
                });
            });
            Object.keys(userSubscriptions).forEach(key => {
                const [username, subscription] = key.split('|');
                let dates = userSubscriptions[key].sort((a, b) => a - b);
                const details = subscriptionDetails[key].sort((a, b) => a.date - b.date);
                const usedForThreeMonths = new Array(dates.length).fill(false);
                for (let i = 0; i < dates.length - 2; i++) {
                    if (usedForThreeMonths[i]) continue;
                    for (let j = i + 1; j < dates.length - 1; j++) {
                        if (usedForThreeMonths[j]) continue;
                        for (let k = j + 1; k < dates.length; k++) {
                            if (usedForThreeMonths[k]) continue;
                            const daysDiff = (dates[k] - dates[i]) / (1000 * 60 * 60 * 24);
                            if (daysDiff >= 0 && daysDiff <= 5) {
                                usedForThreeMonths[i] = true;
                                usedForThreeMonths[j] = true;
                                usedForThreeMonths[k] = true;
                                break;
                            }
                        }
                    }
                }
                const remainingDates = dates.filter((date, index) => !usedForThreeMonths[index]);
                const remainingDetails = details.filter((detail, index) => !usedForThreeMonths[index]);
                let activations = 0;
                const used = new Array(remainingDates.length).fill(false);
                const activationDetails = [];
                for (let i = 0; i < remainingDates.length - 1; i++) {
                    if (used[i]) continue;
                    for (let j = i + 1; j < remainingDates.length; j++) {
                        if (used[j]) continue;
                        const daysDiff = (remainingDates[j] - remainingDates[i]) / (1000 * 60 * 60 * 24);
                        if (daysDiff >= 0 && daysDiff <= 5) {
                            used[i] = true;
                            used[j] = true;
                            activations++;
                            const subType = remainingDetails[i].subscription.trim();
                            const agentName = remainingDetails[i].agent || '';
                            const category = getSubscriptionCategory(subType, agentName);
                            const promoPrice = category ? getSubscriptionPrice(subType, category, 'twoMonths', 'promo') : 0;
                            const monthlyOfficialPrice = category ? getSubscriptionPrice(subType, category, 'basic') : 0;
                            const officialPrice = monthlyOfficialPrice * 2;
                            activationDetails.push({
                                username: remainingDetails[i].username,
                                subscription: remainingDetails[i].subscription,
                                agent: remainingDetails[i].agent,
                                date: remainingDetails[i].dateStr,
                                dateStr: remainingDetails[i].dateStr,
                                createdAt: remainingDetails[i].dateStr,
                                date1: remainingDetails[i].dateStr,
                                date2: remainingDetails[j].dateStr,
                                daysDiff: Math.round(daysDiff * 100) / 100,
                                promoPrice: promoPrice,
                                officialPrice: officialPrice,
                                type: 'ÿ¥Ÿáÿ±ŸäŸÜ'
                            });
                            break;
                        }
                    }
                }
                twoMonthsDetails.push(...activationDetails);
                if (activations > 0) {
                    const subType = subscription.trim();
                    const agentName = remainingDetails[0]?.agent || '';
                    const category = getSubscriptionCategory(subType, agentName);
                    if (category) {
                        const promoPrice = getSubscriptionPrice(subType, category, 'twoMonths');
                        const monthlyOfficialPrice = getSubscriptionPrice(subType, category, 'basic');
                    const officialPrice = monthlyOfficialPrice * 2;
                        switch(category) {
                            case 'B':
                        results.bronze.count += activations;
                        results.bronze.promoAmount += activations * promoPrice;
                        results.bronze.officialAmount += activations * officialPrice;
                                break;
                            case 'S':
                        results.silver.count += activations;
                        results.silver.promoAmount += activations * promoPrice;
                        results.silver.officialAmount += activations * officialPrice;
                                break;
                            case 'G':
                        results.gold.count += activations;
                        results.gold.promoAmount += activations * promoPrice;
                        results.gold.officialAmount += activations * officialPrice;
                                break;
                            case 'P':
                        results.platinum.count += activations;
                        results.platinum.promoAmount += activations * promoPrice;
                        results.platinum.officialAmount += activations * officialPrice;
                                break;
                        }
                    }
                }
            });
            results.total.count = results.bronze.count + results.silver.count + results.gold.count + results.platinum.count;
            results.total.promoAmount = results.bronze.promoAmount + results.silver.promoAmount + results.gold.promoAmount + results.platinum.promoAmount;
            results.total.officialAmount = results.bronze.officialAmount + results.silver.officialAmount + results.gold.officialAmount + results.platinum.officialAmount;
            results.total.profit = results.total.officialAmount - results.total.promoAmount;
            return results;
        }
        async function displayTwoMonthsResults(results) {
            const displayLockKey = `display_two_months_${results.agentName}_${getCurrentMonthYear()}`;
            if (displayLocks.has(displayLockKey)) {
                return;
            }
            displayLocks.set(displayLockKey, true);
            
            try {
                await ensureAgentExists(results.agentName);
                if (!agentReports[results.agentName]) {
                    agentReports[results.agentName] = {};
                }
                agentReports[results.agentName].twoMonths = results;
                const monthYear = extractMonthYearFromDetails(twoMonthsDetails) || 
                                 extractMonthYearFromData(twoMonthsData) || 
                                 getCurrentMonthYear();
                
                try {
                    const agentReportsString = JSON.stringify(agentReports);
                    if (agentReportsString.length <= 2000000) {
                        localStorage.setItem('agentReports', agentReportsString);
                    }
                } catch (e) {
                }
                
                await saveAgentAnalysisToArchive(results.agentName, 'two_months', {
                    results: results,
                    details: twoMonthsDetails,
                    data: twoMonthsData,
                    monthYear: monthYear,
                    analysisDate: new Date().toISOString()
                });
                
                saveToDatabase('analysis_archives', {
                    data: twoMonthsData,
                    details: twoMonthsDetails,
                    results: results,
                    agentReports: agentReports
                }, { analysis_type: 'two_months', monthYear: monthYear }).then(saved => {
                    if (!saved) {
                        console.warn('‚ö† Two months analysis save failed or timed out. Data is saved in database only (too large for localStorage).');
                    }
                }).catch(err => {
                    console.error('Error saving two months analysis:', err);
                });
                
                saveAgentsListToDatabase(monthYear).catch(err => console.error('Error saving agents list:', err));
                
                const agentInfo = document.getElementById('twoMonthsAgentInfo');
                agentInfo.innerHTML = `
                    <h3>ÿßŸÑÿπÿ±ÿ∂ ÿßŸÑŸÖÿÆŸÅÿ∂ ŸÑÿ¥Ÿáÿ±ŸäŸÜ</h3>
                    <p><strong>ÿßÿ≥ŸÖ ÿßŸÑŸàŸÉŸäŸÑ:</strong> ${results.agentName}</p>
                    <p><strong>ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ™ÿ≠ŸÑŸäŸÑ:</strong> ${formatArabicDate(new Date())}</p>
                    <p><strong>ŸÜŸàÿπ ÿßŸÑÿ™ÿ≠ŸÑŸäŸÑ:</strong> ÿ≠ÿ≥ÿßÿ® ÿßŸÑÿπÿ±ÿ∂ ÿßŸÑŸÖÿÆŸÅÿ∂ ŸÑÿ¥Ÿáÿ±ŸäŸÜ</p>
                    <p><strong>ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿ±ÿßÿ¨ÿπ ŸÑŸÑŸàŸÉŸäŸÑ :</strong> ${formatNumber(results.total.profit)} ÿØ.ÿπ</p>
                `;
                const resultsGrid = document.getElementById('twoMonthsResultsGrid');
                resultsGrid.innerHTML = `
                    <div class="result-card bronze">
                        <h3> Bronze</h3>
                        <div class="count">${results.bronze.count}</div>
                        <div class="amount">ÿπÿ±ÿ∂: ${formatNumber(results.bronze.promoAmount)} ÿØ.ÿπ</div>
                        <div class="amount">ÿ±ÿ≥ŸÖŸä: ${formatNumber(results.bronze.officialAmount)} ÿØ.ÿπ</div>
                        <div class="amount" style="color: #28a745; font-weight: 700; margin-top: 5px;">ÿ±ÿßÿ¨ÿπ: ${formatNumber(results.bronze.officialAmount - results.bronze.promoAmount)} ÿØ.ÿπ</div>
                    </div>
                    <div class="result-card silver">
                        <h3> Silver</h3>
                        <div class="count">${results.silver.count}</div>
                        <div class="amount">ÿπÿ±ÿ∂: ${formatNumber(results.silver.promoAmount)} ÿØ.ÿπ</div>
                        <div class="amount">ÿ±ÿ≥ŸÖŸä: ${formatNumber(results.silver.officialAmount)} ÿØ.ÿπ</div>
                        <div class="amount" style="color: #28a745; font-weight: 700; margin-top: 5px;">ÿ±ÿßÿ¨ÿπ: ${formatNumber(results.silver.officialAmount - results.silver.promoAmount)} ÿØ.ÿπ</div>
                    </div>
                    <div class="result-card gold">
                        <h3> Gold</h3>
                        <div class="count">${results.gold.count}</div>
                        <div class="amount">ÿπÿ±ÿ∂: ${formatNumber(results.gold.promoAmount)} ÿØ.ÿπ</div>
                        <div class="amount">ÿ±ÿ≥ŸÖŸä: ${formatNumber(results.gold.officialAmount)} ÿØ.ÿπ</div>
                        <div class="amount" style="color: #28a745; font-weight: 700; margin-top: 5px;">ÿ±ÿßÿ¨ÿπ: ${formatNumber(results.gold.officialAmount - results.gold.promoAmount)} ÿØ.ÿπ</div>
                    </div>
                    <div class="result-card platinum">
                        <h3> Platinum</h3>
                        <div class="count">${results.platinum.count}</div>
                        <div class="amount">ÿπÿ±ÿ∂: ${formatNumber(results.platinum.promoAmount)} ÿØ.ÿπ</div>
                        <div class="amount">ÿ±ÿ≥ŸÖŸä: ${formatNumber(results.platinum.officialAmount)} ÿØ.ÿπ</div>
                        <div class="amount" style="color: #28a745; font-weight: 700; margin-top: 5px;">ÿ±ÿßÿ¨ÿπ: ${formatNumber(results.platinum.officialAmount - results.platinum.promoAmount)} ÿØ.ÿπ</div>
                    </div>
                    <div class="result-card">
                        <h3> ÿßŸÑŸÖÿ¨ŸÖŸàÿπ</h3>
                        <div class="count">${results.total.count}</div>
                        <div class="amount">ÿπÿ±ÿ∂: ${formatNumber(results.total.promoAmount)} ÿØ.ÿπ</div>
                        <div class="amount">ÿ±ÿ≥ŸÖŸä: ${formatNumber(results.total.officialAmount)} ÿØ.ÿπ</div>
                        <div class="amount" style="color: #28a745; font-weight: 700; margin-top: 5px; font-size: 1.2rem;">ÿ±ÿßÿ¨ÿπ ÿßŸÑŸÉŸÑŸä: ${formatNumber(results.total.profit)} ÿØ.ÿπ</div>
                    </div>
                `;
                document.getElementById('twoMonthsResults').classList.remove('hidden');
                updateAgentSummary();
                logActivity('ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ - ÿ¥Ÿáÿ±ŸäŸÜ', `ÿ™ŸÖ ÿ™ÿ≠ŸÑŸäŸÑ ${results.total.count} ÿ™ŸÅÿπŸäŸÑ ŸÑŸÑÿπÿ±ÿ∂ ÿßŸÑŸÖÿÆŸÅÿ∂ ÿ¥Ÿáÿ±ŸäŸÜ ŸÑŸÑŸàŸÉŸäŸÑ ${results.agentName}`);
            } finally {
                setTimeout(() => {
                    displayLocks.delete(displayLockKey);
                }, 5000);
            }
        }
        function showLoading(type) {
            document.getElementById(type + 'Loading').style.display = 'block';
        }
        function hideLoading(type) {
            document.getElementById(type + 'Loading').style.display = 'none';
        }
        function formatNumber(num) {
            if (num === null || num === undefined || isNaN(num)) return '0';
            return new Intl.NumberFormat('en-US').format(Math.floor(num));
        }
        async function resetBasicResults() {
            if (confirm('ÿ≥Ÿäÿ™ŸÖ ŸÖÿ≥ÿ≠ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™.\n\nŸáŸÑ ÿ™ÿ±ŸäÿØ ÿßŸÑŸÖÿ™ÿßÿ®ÿπÿ©ÿü')) {
                document.getElementById('basicResults').classList.add('hidden');
                document.getElementById('basicFileInput').value = '';
                basicData = null;
                basicDetails = [];
                localStorage.removeItem('basicData');
                localStorage.removeItem('basicDetails');
                localStorage.removeItem('basicResults');
                Object.keys(agentReports).forEach(agent => {
                    if (agentReports[agent].basic) {
                        delete agentReports[agent].basic;
                        if (Object.keys(agentReports[agent]).length === 0) {
                            delete agentReports[agent];
                        }
                    }
                });
                showSuccessMessage('ÿ™ŸÖ ŸÖÿ≥ÿ≠ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ®ŸÜÿ¨ÿßÿ≠');
            }
        }
        async function resetAdvancedResults() {
            if (confirm('ÿ≥Ÿäÿ™ŸÖ ŸÖÿ≥ÿ≠ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™.\n\nŸáŸÑ ÿ™ÿ±ŸäÿØ ÿßŸÑŸÖÿ™ÿßÿ®ÿπÿ©ÿü')) {
                document.getElementById('advancedResults').classList.add('hidden');
                document.getElementById('advancedFileInput').value = '';
                advancedData = null;
                advancedDetails = [];
                localStorage.removeItem('advancedData');
                localStorage.removeItem('advancedDetails');
                localStorage.removeItem('advancedResults');
                Object.keys(agentReports).forEach(agent => {
                    if (agentReports[agent].advanced) {
                        delete agentReports[agent].advanced;
                        if (Object.keys(agentReports[agent]).length === 0) {
                            delete agentReports[agent];
                        }
                    }
                });
                showSuccessMessage('ÿ™ŸÖ ŸÖÿ≥ÿ≠ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ®ŸÜÿ¨ÿßÿ≠');
            }
        }
        async function resetTwoMonthsResults() {
            if (confirm('ÿ≥Ÿäÿ™ŸÖ ŸÖÿ≥ÿ≠ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™.\n\nŸáŸÑ ÿ™ÿ±ŸäÿØ ÿßŸÑŸÖÿ™ÿßÿ®ÿπÿ©ÿü')) {
                document.getElementById('twoMonthsResults').classList.add('hidden');
                document.getElementById('twoMonthsFileInput').value = '';
                twoMonthsData = null;
                twoMonthsDetails = [];
                localStorage.removeItem('twoMonthsData');
                localStorage.removeItem('twoMonthsDetails');
                localStorage.removeItem('twoMonthsResults');
                Object.keys(agentReports).forEach(agent => {
                    if (agentReports[agent].twoMonths) {
                        delete agentReports[agent].twoMonths;
                        if (Object.keys(agentReports[agent]).length === 0) {
                            delete agentReports[agent];
                        }
                    }
                });
                showSuccessMessage('ÿ™ŸÖ ŸÖÿ≥ÿ≠ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ®ŸÜÿ¨ÿßÿ≠');
            }
        }
        function saveBasicReport() {
            if (!basicData || document.getElementById('basicResults').classList.contains('hidden')) {
                alert('ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÜÿ™ÿßÿ¶ÿ¨ ŸÑÿ≠ŸÅÿ∏Ÿáÿß. Ÿäÿ±ÿ¨Ÿâ ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ£ŸàŸÑÿßŸã.');
                return;
            }
            const results = processBasicData(basicData);
            const csvContent = generateBasicReportCSV(results);
            downloadCSV(csvContent, `ÿ™ŸÇÿ±Ÿäÿ±_ÿ£ÿ≥ÿßÿ≥Ÿä_${results.agentName}_${formatDateForFilename(new Date())}.csv`);
            logActivity('ÿ™ÿµÿØŸäÿ± ÿ™ŸÇÿ±Ÿäÿ±', `ÿ™ŸÖ ÿ™ÿµÿØŸäÿ± ÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑÿπÿ±ÿ∂ ÿßŸÑŸÖÿ¨ÿßŸÜŸä ŸÑŸÑŸàŸÉŸäŸÑ ${results.agentName}`);
            showSuccessMessage('ÿ™ŸÖ ÿ™ÿµÿØŸäÿ± ÿßŸÑÿ™ŸÇÿ±Ÿäÿ± ÿ®ŸÜÿ¨ÿßÿ≠!');
        }
        function saveAdvancedReport() {
            if (!advancedData || document.getElementById('advancedResults').classList.contains('hidden')) {
                alert('ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÜÿ™ÿßÿ¶ÿ¨ ŸÑÿ≠ŸÅÿ∏Ÿáÿß. Ÿäÿ±ÿ¨Ÿâ ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ£ŸàŸÑÿßŸã.');
                return;
            }
            const results = processAdvancedData(advancedData);
            const csvContent = generateAdvancedReportCSV(results);
            downloadCSV(csvContent, `ÿ™ŸÇÿ±Ÿäÿ±_ÿ™ŸÅÿπŸäŸÑÿßÿ™_${results.agentName}_${formatDateForFilename(new Date())}.csv`);
            logActivity('ÿ™ÿµÿØŸäÿ± ÿ™ŸÇÿ±Ÿäÿ±', `ÿ™ŸÖ ÿ™ÿµÿØŸäÿ± ÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑÿπÿ±ÿ∂ ÿßŸÑŸÖÿÆŸÅÿ∂ 3 ÿ£ÿ¥Ÿáÿ± ŸÑŸÑŸàŸÉŸäŸÑ ${results.agentName}`);
            showSuccessMessage('ÿ™ŸÖ ÿ™ÿµÿØŸäÿ± ÿßŸÑÿ™ŸÇÿ±Ÿäÿ± ÿ®ŸÜÿ¨ÿßÿ≠!');
        }
        function saveTwoMonthsReport() {
            if (!twoMonthsData || document.getElementById('twoMonthsResults').classList.contains('hidden')) {
                alert('ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÜÿ™ÿßÿ¶ÿ¨ ŸÑÿ≠ŸÅÿ∏Ÿáÿß. Ÿäÿ±ÿ¨Ÿâ ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ£ŸàŸÑÿßŸã.');
                return;
            }
            const results = processTwoMonthsData(twoMonthsData);
            const csvContent = generateTwoMonthsReportCSV(results);
            downloadCSV(csvContent, `ÿ™ŸÇÿ±Ÿäÿ±_ÿ¥Ÿáÿ±ŸäŸÜ_${results.agentName}_${formatDateForFilename(new Date())}.csv`);
            logActivity('ÿ™ÿµÿØŸäÿ± ÿ™ŸÇÿ±Ÿäÿ±', `ÿ™ŸÖ ÿ™ÿµÿØŸäÿ± ÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑÿπÿ±ÿ∂ ÿßŸÑŸÖÿÆŸÅÿ∂ ÿ¥Ÿáÿ±ŸäŸÜ ŸÑŸÑŸàŸÉŸäŸÑ ${results.agentName}`);
            showSuccessMessage('ÿ™ŸÖ ÿ™ÿµÿØŸäÿ± ÿßŸÑÿ™ŸÇÿ±Ÿäÿ± ÿ®ŸÜÿ¨ÿßÿ≠!');
        }
        function generateBasicReportCSV(results) {
            const header = 'ŸÜŸàÿπ ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ,ÿßŸÑÿπÿØÿØ,ÿßŸÑŸÖÿ®ŸÑÿ∫ (ÿØ.ÿπ)\n';
            const rows = [
                `Bronze,${results.bronze.count},${results.bronze.amount}`,
                `Silver,${results.silver.count},${results.silver.amount}`,
                `Gold,${results.gold.count},${results.gold.amount}`,
                `Platinum,${results.platinum.count},${results.platinum.amount}`,
                `ÿßŸÑŸÖÿ¨ŸÖŸàÿπ,${results.total.count},${results.total.amount}`
            ].join('\n');
            return header + rows;
        }
        function generateAdvancedReportCSV(results) {
            const header = 'ŸÜŸàÿπ ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ,ÿπÿØÿØ ÿßŸÑÿ™ŸÅÿπŸäŸÑÿßÿ™,ŸÖÿ®ŸÑÿ∫ ÿßŸÑÿπÿ±ÿ∂ (ÿØ.ÿπ),ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑÿ±ÿ≥ŸÖŸä (ÿØ.ÿπ),ÿßŸÑÿ±ÿ®ÿ≠ (ÿØ.ÿπ)\n';
            const rows = [
                `Bronze,${results.bronze.count},${results.bronze.promoAmount},${results.bronze.officialAmount},${results.bronze.officialAmount - results.bronze.promoAmount}`,
                `Silver,${results.silver.count},${results.silver.promoAmount},${results.silver.officialAmount},${results.silver.officialAmount - results.silver.promoAmount}`,
                `Gold,${results.gold.count},${results.gold.promoAmount},${results.gold.officialAmount},${results.gold.officialAmount - results.gold.promoAmount}`,
                `Platinum,${results.platinum.count},${results.platinum.promoAmount},${results.platinum.officialAmount},${results.platinum.officialAmount - results.platinum.promoAmount}`,
                `ÿßŸÑŸÖÿ¨ŸÖŸàÿπ,${results.total.count},${results.total.promoAmount},${results.total.officialAmount},${results.total.profit}`
            ].join('\n');
            return header + rows;
        }
        function generateTwoMonthsReportCSV(results) {
            const header = 'ŸÜŸàÿπ ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ,ÿπÿØÿØ ÿßŸÑÿ™ŸÅÿπŸäŸÑÿßÿ™,ŸÖÿ®ŸÑÿ∫ ÿßŸÑÿπÿ±ÿ∂ (ÿØ.ÿπ),ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑÿ±ÿ≥ŸÖŸä (ÿØ.ÿπ),ÿßŸÑÿ±ÿ®ÿ≠ (ÿØ.ÿπ)\n';
            const rows = [
                `Bronze,${results.bronze.count},${results.bronze.promoAmount},${results.bronze.officialAmount},${results.bronze.officialAmount - results.bronze.promoAmount}`,
                `Silver,${results.silver.count},${results.silver.promoAmount},${results.silver.officialAmount},${results.silver.officialAmount - results.silver.promoAmount}`,
                `Gold,${results.gold.count},${results.gold.promoAmount},${results.gold.officialAmount},${results.gold.officialAmount - results.gold.promoAmount}`,
                `Platinum,${results.platinum.count},${results.platinum.promoAmount},${results.platinum.officialAmount},${results.platinum.officialAmount - results.platinum.promoAmount}`,
                `ÿßŸÑŸÖÿ¨ŸÖŸàÿπ,${results.total.count},${results.total.promoAmount},${results.total.officialAmount},${results.total.profit}`
            ].join('\n');
            return header + rows;
        }
        function downloadCSV(content, filename) {
            const blob = new Blob(['\ufeff' + content], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        function formatDateForFilename(date) {
            return date.toISOString().split('T')[0];
        }
        function getReportInfo(agentName) {
            const reports = agentReports[agentName] || {};
            const agent = agentsList.find(a => a.name === agentName);
            const reportType = reports.twoMonths && (reports.twoMonths.total?.count > 0) ? 'twoMonths' : 
                              reports.advanced && (reports.advanced.total?.count > 0) ? 'advanced' : 
                              'basic';
            let reportData = {};
            let reportTitle = '';
            const getMonthFromDetails = (details) => {
                if (!details || !Array.isArray(details) || details.length === 0) {
                    return null;
                }
                for (const detail of details) {
                    let dateObj = null;
                    let dateField = detail.date1 || detail.date2 || detail.date3 || 
                                   detail.date || detail.dateStr || detail.createdAt || 
                                   detail['ColumnB'] || detail[1];
                    if (!dateField) continue;
                    try {
                        if (dateField instanceof Date) {
                            dateObj = dateField;
                        } else if (typeof dateField === 'number' && dateField > 40000) {
                            dateObj = new Date((dateField - 25569) * 86400 * 1000);
                        } else if (typeof dateField === 'string') {
                            const dateStr = dateField.trim();
                            const ddmmyyyy = dateStr.match(/^(\d{1,2})[-\/](\d{1,2})[-\/](\d{4})$/);
                            if (ddmmyyyy) {
                                dateObj = new Date(parseInt(ddmmyyyy[3]), parseInt(ddmmyyyy[2]) - 1, parseInt(ddmmyyyy[1]));
                            } else {
                                const yyyymmdd = dateStr.match(/^(\d{4})[-\/](\d{1,2})[-\/](\d{1,2})$/);
                                if (yyyymmdd) {
                                    dateObj = new Date(parseInt(yyyymmdd[1]), parseInt(yyyymmdd[2]) - 1, parseInt(yyyymmdd[3]));
                                } else {
                                    dateObj = new Date(dateField);
                                }
                            }
                        } else {
                            dateObj = new Date(dateField);
                        }
                        if (dateObj && !isNaN(dateObj.getTime())) {
                            return {
                                month: dateObj.getMonth() + 1,
                                year: dateObj.getFullYear()
                            };
                        }
                    } catch (e) {
                        continue;
                    }
                }
                return null;
            };
            let detectedMonth = null;
            let detectedYear = null;
            if (reportType === 'twoMonths') {
                reportData = reports.twoMonths || {};
                let details = reportData.details || [];
                if (details.length === 0) {
                    details = (twoMonthsDetails || []).filter(d => {
                        const agent = d.agent || d.Agent || d.agentName || d.AgentName || d['ÿßÿ≥ŸÖ ÿßŸÑŸàŸÉŸäŸÑ'] || d['ÿßŸÑŸàŸÉŸäŸÑ'];
                        return agent === agentName;
                    });
                }
                const monthInfo = getMonthFromDetails(details);
                if (monthInfo) {
                    detectedMonth = monthInfo.month;
                    detectedYear = monthInfo.year;
                }
            } else if (reportType === 'advanced') {
                reportData = reports.advanced || {};
                let details = reportData.details || [];
                if (details.length === 0) {
                    details = (advancedDetails || []).filter(d => {
                        const agent = d.agent || d.Agent || d.agentName || d.AgentName || d['ÿßÿ≥ŸÖ ÿßŸÑŸàŸÉŸäŸÑ'] || d['ÿßŸÑŸàŸÉŸäŸÑ'];
                        return agent === agentName;
                    });
                }
                const monthInfo = getMonthFromDetails(details);
                if (monthInfo) {
                    detectedMonth = monthInfo.month;
                    detectedYear = monthInfo.year;
                }
            } else {
                reportData = reports.basic || {};
                let details = reportData.details || [];
                if (details.length === 0) {
                    details = (basicDetails || []).filter(d => {
                        const agent = d.agent || d.Agent || d.agentName || d.AgentName || d['ÿßÿ≥ŸÖ ÿßŸÑŸàŸÉŸäŸÑ'] || d['ÿßŸÑŸàŸÉŸäŸÑ'];
                        return agent === agentName;
                    });
                }
                const monthInfo = getMonthFromDetails(details);
                if (monthInfo) {
                    detectedMonth = monthInfo.month;
                    detectedYear = monthInfo.year;
                }
            }
            const today = new Date();
            const month = detectedMonth || (today.getMonth() + 1);
            const year = detectedYear || today.getFullYear();
            const monthName = arabicMonths[month - 1];
            const dateFrom = `1/${month}/${year}`;
            const dateTo = `${new Date(year, month, 0).getDate()}/${month}/${year}`;
            if (reportType === 'twoMonths') {
                if (reportData.dateFrom && reportData.dateTo) {
                    const dateFromParts = reportData.dateFrom.split('/');
                    const monthFrom = parseInt(dateFromParts[1]);
                    const yearFrom = parseInt(dateFromParts[2]);
                    const monthNameFrom = arabicMonths[monthFrom - 1];
                    reportTitle = `ŸÉÿ¥ŸÅ ÿ™ŸÅÿπŸäŸÑÿßÿ™ ÿßŸÑŸàŸÉŸÑÿßÿ° ÿπŸÜ ÿßŸÑÿπÿ±ÿ∂ (ÿ¥Ÿáÿ±ŸäŸÜ) ÿßŸÑŸÖÿÆŸÅÿ∂ ŸÑÿ¥Ÿáÿ± ${monthNameFrom}`;
                } else {
                    reportTitle = `ŸÉÿ¥ŸÅ ÿ™ŸÅÿπŸäŸÑÿßÿ™ ÿßŸÑŸàŸÉŸÑÿßÿ° ÿπŸÜ ÿßŸÑÿπÿ±ÿ∂ (ÿ¥Ÿáÿ±ŸäŸÜ) ÿßŸÑŸÖÿÆŸÅÿ∂ ŸÑÿ¥Ÿáÿ± ${monthName}`;
                }
            } else if (reportType === 'advanced') {
                reportTitle = `ŸÉÿ¥ŸÅ ÿ™ŸÅÿπŸäŸÑÿßÿ™ ÿßŸÑŸàŸÉŸÑÿßÿ° ÿπŸÜ ÿßŸÑÿπÿ±ÿ∂ ÿßŸÑŸÖÿÆŸÅÿ∂ ŸÑÿ´ŸÑÿßÿ´ÿ© ÿ£ÿ¥Ÿáÿ± ŸÑÿ¥Ÿáÿ± ${monthName}`;
            } else {
                reportTitle = `ŸÉÿ¥ŸÅ ÿ™ŸÅÿπŸäŸÑÿßÿ™ ÿßŸÑŸàŸÉŸÑÿßÿ° ÿπŸÜ ÿßŸÑÿπÿ±ÿ∂ ÿßŸÑŸÖÿ¨ÿßŸÜŸä ŸÑÿ¥Ÿáÿ± ${monthName}`;
            }
            return {
                reportType,
                reportData,
                reportTitle,
                agent,
                dateFrom,
                dateTo
            };
        }
        function calculateCategoryPricesAndCounts(reportData, reportType) {
            const categories = ['platinum', 'gold', 'silver', 'bronze'];
            const result = {};
            categories.forEach(category => {
                const count = reportData[category]?.count || 0;
                result[`${category}Count`] = count;
                if (reportType === 'twoMonths' || reportType === 'advanced') {
                    const officialAmount = reportData[category]?.officialAmount || 0;
                    const promoAmount = reportData[category]?.promoAmount || 0;
                    result[`${category}Price`] = count > 0 ? Math.round((officialAmount - promoAmount) / count) : 0;
                } else {
                    const amount = reportData[category]?.amount || 0;
                    result[`${category}Price`] = count > 0 ? Math.round(amount / count) : 0;
                }
            });
            result.totalSubs = result.platinumCount + result.goldCount + result.silverCount + result.bronzeCount;
            result.totalAmount = reportData.total?.profit || reportData.total?.amount || 0;
            return result;
        }
        function downloadFile(blob, filename) {
            const downloadUrl = URL.createObjectURL(blob);
            const downloadLink = document.createElement('a');
            downloadLink.href = downloadUrl;
            downloadLink.download = filename;
            downloadLink.style.display = 'none';
            document.body.appendChild(downloadLink);
            downloadLink.click();
            setTimeout(() => {
                document.body.removeChild(downloadLink);
                URL.revokeObjectURL(downloadUrl);
            }, 1000);
        }
        function getReportFilename(agentName, extension) {
            const safeName = agentName.replace(/[^a-zA-Z0-9_]/g, '_');
            return `ÿ™ŸÇÿ±Ÿäÿ±_${safeName}_${formatDateForFilename(new Date())}.${extension}`;
        }
        function getFileBlobPromise(agentName, fileType) {
                    return generateExcelReportBlob(agentName);
        }
        function getFileTypeInfo(fileType, agentName) {
            const typeMap = {
                'excel': { ext: 'xlsx', name: 'Excel' }
            };
            const info = typeMap[fileType] || typeMap['excel'];
            return {
                extension: info.ext,
                typeName: info.name,
                filename: getReportFilename(agentName, info.ext)
            };
        }
        function formatPhoneForWhatsApp(phone) {
            let cleanPhone = phone.replace(/[^0-9]/g, '');
            if (cleanPhone.startsWith('0')) {
                cleanPhone = '964' + cleanPhone.substring(1);
            } else if (!cleanPhone.startsWith('964') && cleanPhone.length <= 10) {
                cleanPhone = '964' + cleanPhone;
            }
            return cleanPhone;
        }
        function exportBasicData() {
            if (!basicData) {
                alert('ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™ ŸÑŸÑÿ™ÿµÿØŸäÿ±. Ÿäÿ±ÿ¨Ÿâ ÿ™ÿ≠ŸÖŸäŸÑ ŸÖŸÑŸÅ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ£ŸàŸÑÿßŸã.');
                return;
            }
            const filteredData = basicData.filter(row => {
                const count = row['ColumnP'] || row[15];
                return count == 1;
            });
            const csvContent = convertDataToCSV(filteredData);
            downloadCSV(csvContent, `ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™_ÿßŸÑŸÖŸÅŸÑÿ™ÿ±ÿ©_${formatDateForFilename(new Date())}.csv`);
            alert('ÿ™ŸÖ ÿ™ÿµÿØŸäÿ± ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿäÿ© ÿ®ŸÜÿ¨ÿßÿ≠!');
        }
        function exportAdvancedData() {
            if (!advancedData) {
                alert('ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™ ŸÑŸÑÿ™ÿµÿØŸäÿ±. Ÿäÿ±ÿ¨Ÿâ ÿ™ÿ≠ŸÖŸäŸÑ ŸÖŸÑŸÅ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ£ŸàŸÑÿßŸã.');
                return;
            }
            const results = processAdvancedData(advancedData);
            const csvContent = generateAdvancedReportCSV(results);
            downloadCSV(csvContent, `ÿ™ŸÇÿ±Ÿäÿ±_ŸàŸÉŸäŸÑ_${results.agentName}_${formatDateForFilename(new Date())}.csv`);
            alert('ÿ™ŸÖ ÿ™ÿµÿØŸäÿ± ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸàŸÉŸäŸÑ ÿ®ŸÜÿ¨ÿßÿ≠!');
        }
        function exportTwoMonthsData() {
            if (!twoMonthsData) {
                alert('ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™ ŸÑŸÑÿ™ÿµÿØŸäÿ±. Ÿäÿ±ÿ¨Ÿâ ÿ™ÿ≠ŸÖŸäŸÑ ŸÖŸÑŸÅ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ£ŸàŸÑÿßŸã.');
                return;
            }
            const results = processTwoMonthsData(twoMonthsData);
            const csvContent = generateTwoMonthsReportCSV(results);
            downloadCSV(csvContent, `ÿ™ŸÇÿ±Ÿäÿ±_ÿ¥Ÿáÿ±ŸäŸÜ_ŸàŸÉŸäŸÑ_${results.agentName}_${formatDateForFilename(new Date())}.csv`);
            alert('ÿ™ŸÖ ÿ™ÿµÿØŸäÿ± ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿπÿ±ÿ∂ ÿßŸÑŸÖÿÆŸÅÿ∂ ŸÑÿ¥Ÿáÿ±ŸäŸÜ ÿ®ŸÜÿ¨ÿßÿ≠!');
        }
        function exportTwoMonthsDetailsToExcel() {
            if (!twoMonthsDetails || twoMonthsDetails.length === 0) {
                alert('ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ™ŸÅÿßÿµŸäŸÑ ŸÑŸÑÿ™ÿµÿØŸäÿ±. Ÿäÿ±ÿ¨Ÿâ ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ£ŸàŸÑÿßŸã.');
                return;
            }
            try {
                const wb = XLSX.utils.book_new();
                const excelData = twoMonthsDetails.map((detail, index) => {
                    const agent = agentsList.find(a => a.name === detail.agent);
                    const agentSubName = agent?.subName || '';
                    const agentDisplayName = agentSubName ? `${detail.agent}\n${agentSubName}` : detail.agent;
                    
                    return {
                        'ÿ±ŸÇŸÖ': index + 1,
                        'ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ': detail.username,
                        'ŸÜŸàÿπ ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ': detail.subscription,
                        'ÿßÿ≥ŸÖ ÿßŸÑŸàŸÉŸäŸÑ': agentDisplayName,
                        'ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ ÿßŸÑÿ£ŸàŸÑ': detail.date1,
                        'ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ ÿßŸÑÿ´ÿßŸÜŸä': detail.date2,
                        'ÿßŸÑŸÅÿ±ŸÇ ÿ®ÿßŸÑÿ£ŸäÿßŸÖ': detail.daysDiff,
                        'ŸÜŸàÿπ ÿßŸÑÿ™ŸÅÿπŸäŸÑ': detail.type,
                        'ÿßŸÑÿ≥ÿπÿ± ÿßŸÑŸÖÿÆŸÅÿ∂ (ÿØ.ÿπ)': subscriptionPrices.twoMonths.promo[detail.subscription] || 0,
                        'ÿßŸÑÿ≥ÿπÿ± ÿßŸÑÿ±ÿ≥ŸÖŸä (ÿØ.ÿπ)': (subscriptionPrices.basic[detail.subscription] || 0) * 2,
                        'ÿßŸÑÿ±ÿßÿ¨ÿπ ŸÑŸÑŸàŸÉŸäŸÑ (ÿØ.ÿπ)': ((subscriptionPrices.basic[detail.subscription] || 0) * 2) - (subscriptionPrices.twoMonths.promo[detail.subscription] || 0)
                    };
                });
                const ws = XLSX.utils.json_to_sheet(excelData);
                ws['!cols'] = [
                    { wch: 8 },
                    { wch: 25 },
                    { wch: 30 },
                    { wch: 20 },
                    { wch: 20 },
                    { wch: 20 },
                    { wch: 12 },
                    { wch: 15 },
                    { wch: 18 },
                    { wch: 18 },
                    { wch: 18 }
                ];
                XLSX.utils.book_append_sheet(wb, ws, 'ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑÿ™ŸÅÿπŸäŸÑÿßÿ™');
                const agentName = twoMonthsDetails.length > 0 ? twoMonthsDetails[0].agent : 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ';
                const filename = `ÿ™ŸÅÿßÿµŸäŸÑ_ÿßŸÑÿ™ŸÅÿπŸäŸÑÿßÿ™_ÿ¥Ÿáÿ±ŸäŸÜ_${agentName}_${formatDateForFilename(new Date())}.xlsx`;
                XLSX.writeFile(wb, filename);
                showSuccessMessage(`ÿ™ŸÖ ÿ™ÿµÿØŸäÿ± ${twoMonthsDetails.length} ÿ™ŸÅÿπŸäŸÑ ÿ•ŸÑŸâ ŸÖŸÑŸÅ Excel ÿ®ŸÜÿ¨ÿßÿ≠!`);
            } catch (error) {
                alert('ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿßŸÑÿ™ÿµÿØŸäÿ±: ' + error.message);
                console.error('Export error:', error);
            }
        }
        function exportAdvancedDetailsToExcel() {
            if (!advancedDetails || advancedDetails.length === 0) {
                alert('ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ™ŸÅÿßÿµŸäŸÑ ŸÑŸÑÿ™ÿµÿØŸäÿ±. Ÿäÿ±ÿ¨Ÿâ ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ£ŸàŸÑÿßŸã.');
                return;
            }
            try {
                const wb = XLSX.utils.book_new();
                const excelData = advancedDetails.map((detail, index) => {
                    const agent = agentsList.find(a => a.name === detail.agent);
                    const agentSubName = agent?.subName || '';
                    const agentDisplayName = agentSubName ? `${detail.agent}\n${agentSubName}` : detail.agent;
                    
                    return {
                        'ÿ±ŸÇŸÖ': index + 1,
                        'ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ': detail.username,
                        'ŸÜŸàÿπ ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ': detail.subscription,
                        'ÿßÿ≥ŸÖ ÿßŸÑŸàŸÉŸäŸÑ': agentDisplayName,
                        'ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ ÿßŸÑÿ£ŸàŸÑ': detail.date1,
                        'ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ ÿßŸÑÿ´ÿßŸÜŸä': detail.date2,
                        'ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ ÿßŸÑÿ´ÿßŸÑÿ´': detail.date3,
                        'ÿßŸÑŸÅÿ±ŸÇ ÿ®ÿßŸÑÿ£ŸäÿßŸÖ': detail.daysDiff,
                        'ŸÜŸàÿπ ÿßŸÑÿ™ŸÅÿπŸäŸÑ': detail.type,
                        'ÿßŸÑÿ≥ÿπÿ± ÿßŸÑŸÖÿÆŸÅÿ∂ (ÿØ.ÿπ)': subscriptionPrices.advanced.promo[detail.subscription] || 0,
                        'ÿßŸÑÿ≥ÿπÿ± ÿßŸÑÿ±ÿ≥ŸÖŸä (ÿØ.ÿπ)': subscriptionPrices.advanced.official[detail.subscription] || 0,
                        'ÿßŸÑÿ±ÿßÿ¨ÿπ ŸÑŸÑŸàŸÉŸäŸÑ (ÿØ.ÿπ)': (subscriptionPrices.advanced.official[detail.subscription] || 0) - (subscriptionPrices.advanced.promo[detail.subscription] || 0)
                    };
                });
                const ws = XLSX.utils.json_to_sheet(excelData);
                ws['!cols'] = [
                    { wch: 8 },
                    { wch: 25 },
                    { wch: 30 },
                    { wch: 20 },
                    { wch: 20 },
                    { wch: 20 },
                    { wch: 20 },
                    { wch: 12 },
                    { wch: 15 },
                    { wch: 18 },
                    { wch: 18 },
                    { wch: 18 }
                ];
                XLSX.utils.book_append_sheet(wb, ws, 'ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑÿ™ŸÅÿπŸäŸÑÿßÿ™');
                const agentName = advancedDetails.length > 0 ? advancedDetails[0].agent : 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ';
                const filename = `ÿ™ŸÅÿßÿµŸäŸÑ_ÿßŸÑÿ™ŸÅÿπŸäŸÑÿßÿ™_ÿ´ŸÑÿßÿ´_ÿ£ÿ¥Ÿáÿ±_${agentName}_${formatDateForFilename(new Date())}.xlsx`;
                XLSX.writeFile(wb, filename);
                showSuccessMessage(`ÿ™ŸÖ ÿ™ÿµÿØŸäÿ± ${advancedDetails.length} ÿ™ŸÅÿπŸäŸÑ ÿ•ŸÑŸâ ŸÖŸÑŸÅ Excel ÿ®ŸÜÿ¨ÿßÿ≠!`);
            } catch (error) {
                alert('ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿßŸÑÿ™ÿµÿØŸäÿ±: ' + error.message);
                console.error('Export error:', error);
            }
        }
        function exportBasicDetailsToExcel() {
            if (!basicDetails || basicDetails.length === 0) {
                alert('ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ™ŸÅÿßÿµŸäŸÑ ŸÑŸÑÿ™ÿµÿØŸäÿ±. Ÿäÿ±ÿ¨Ÿâ ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ£ŸàŸÑÿßŸã.');
                return;
            }
            try {
                const wb = XLSX.utils.book_new();
                const excelData = basicDetails.map((detail, index) => {
                    const agent = agentsList.find(a => a.name === detail.agent);
                    const agentSubName = agent?.subName || '';
                    const agentDisplayName = agentSubName ? `${detail.agent}\n${agentSubName}` : detail.agent;
                    
                    return {
                        'ÿ±ŸÇŸÖ': index + 1,
                        'ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ': detail.username,
                        'ŸÜŸàÿπ ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ': detail.subscription,
                        'ÿßÿ≥ŸÖ ÿßŸÑŸàŸÉŸäŸÑ': agentDisplayName,
                        'ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ': detail.date,
                        'ŸÜŸàÿπ ÿßŸÑÿπÿ±ÿ∂': detail.type,
                        'ÿßŸÑŸÖÿ®ŸÑÿ∫ (ÿØ.ÿπ)': detail.price
                    };
                });
                const ws = XLSX.utils.json_to_sheet(excelData);
                ws['!cols'] = [
                    { wch: 8 },
                    { wch: 25 },
                    { wch: 30 },
                    { wch: 20 },
                    { wch: 20 },
                    { wch: 15 },
                    { wch: 15 }
                ];
                XLSX.utils.book_append_sheet(wb, ws, 'ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉÿßÿ™');
                const agentName = basicDetails.length > 0 ? basicDetails[0].agent : 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ';
                const filename = `ÿ™ŸÅÿßÿµŸäŸÑ_ÿßŸÑÿπÿ±ÿ∂_ÿßŸÑŸÖÿ¨ÿßŸÜŸä_${agentName}_${formatDateForFilename(new Date())}.xlsx`;
                XLSX.writeFile(wb, filename);
                showSuccessMessage(`ÿ™ŸÖ ÿ™ÿµÿØŸäÿ± ${basicDetails.length} ÿßÿ¥ÿ™ÿ±ÿßŸÉ ÿ•ŸÑŸâ ŸÖŸÑŸÅ Excel ÿ®ŸÜÿ¨ÿßÿ≠!`);
            } catch (error) {
                alert('ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿßŸÑÿ™ÿµÿØŸäÿ±: ' + error.message);
                console.error('Export error:', error);
            }
        }
        function convertDataToCSV(data) {
            if (!data || data.length === 0) return '';
            const headers = ['ID', 'ÿßŸÑÿ™ÿßÿ±ŸäÿÆ', 'ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ', 'ŸÜŸàÿπ ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ', 'ÿßŸÑŸàŸÉŸäŸÑ'];
            let csv = headers.join(',') + '\n';
            data.forEach(row => {
                const rowData = [
                    row['ColumnA'] || row[0] || '',
                    row['ColumnB'] || row[1] || '',
                    row['ColumnC'] || row[2] || '',
                    row['ColumnI'] || row[8] || '',
                    row['ColumnF'] || row[5] || ''
                ];
                csv += rowData.map(field => `"${field}"`).join(',') + '\n';
            });
            return csv;
        }
        function updateAgentSummary() {
            const switchUserText = document.getElementById('switchUserText');
            if (switchUserText) {
                switchUserText.textContent = loggedInUser || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ';
            }
            const switchUserBtnName = document.getElementById('switchUserBtnName');
            if (switchUserBtnName) {
                switchUserBtnName.textContent = loggedInUser || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ';
            }
            
            if (!agentReports || Object.keys(agentReports).length === 0) {
                document.getElementById('summaryContent').innerHTML = `
                    <div style="text-align: center; padding: 60px 20px; background: var(--bg-secondary); border-radius: 12px; border: 2px dashed var(--border-color);">
                        <div style="font-size: 3rem; margin-bottom: 20px;">üìä</div>
                        <p style="color: var(--text-secondary); font-size: 1.1rem; font-weight: 600; margin: 0;">
                            ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™ ŸÑŸÑÿπÿ±ÿ∂
                        </p>
                        <p style="color: var(--text-tertiary); font-size: 0.9rem; margin-top: 10px;">
                            Ÿäÿ±ÿ¨Ÿâ ÿ™ÿ≠ŸÑŸäŸÑ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸàŸÉŸÑÿßÿ° ÿ£ŸàŸÑÿßŸã
                        </p>
                    </div>
                `;
                document.getElementById('summaryTotals').style.display = 'none';
                document.getElementById('chartsSection').style.display = 'none';
                return;
            }
            let totalBasicAll = 0;
            let totalAdvancedAll = 0;
            let totalTwoMonthsAll = 0;
            let totalAllAgents = 0;
            let agentsCount = 0;
            let summaryHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 15px; margin-bottom: 20px;">
            `;
            const sortedAgents = Object.entries(agentReports).sort((a, b) => {
                let totalA = 0;
                let totalB = 0;
                if (a[1].basic && a[1].basic.total && a[1].basic.total.amount > 0) totalA += a[1].basic.total.amount;
                if (a[1].advanced && a[1].advanced.total && a[1].advanced.total.profit > 0) totalA += a[1].advanced.total.profit;
                if (a[1].twoMonths && a[1].twoMonths.total && a[1].twoMonths.total.profit > 0) totalA += a[1].twoMonths.total.profit;
                if (b[1].basic && b[1].basic.total && b[1].basic.total.amount > 0) totalB += b[1].basic.total.amount;
                if (b[1].advanced && b[1].advanced.total && b[1].advanced.total.profit > 0) totalB += b[1].advanced.total.profit;
                if (b[1].twoMonths && b[1].twoMonths.total && b[1].twoMonths.total.profit > 0) totalB += b[1].twoMonths.total.profit;
                return totalB - totalA;
            });
            sortedAgents.forEach(([agentName, report]) => {
                let totalBasic = (report.basic && report.basic.total && report.basic.total.amount > 0) ? report.basic.total.amount : 0;
                let totalAdvanced = (report.advanced && report.advanced.total && report.advanced.total.profit > 0) ? report.advanced.total.profit : 0;
                let totalTwoMonths = (report.twoMonths && report.twoMonths.total && report.twoMonths.total.profit > 0) ? report.twoMonths.total.profit : 0;
                let totalAll = 0;
                let offersCount = 0;
                if (totalBasic > 0) {
                    totalAll += totalBasic;
                    offersCount++;
                }
                if (totalAdvanced > 0) {
                    totalAll += totalAdvanced;
                    offersCount++;
                }
                if (totalTwoMonths > 0) {
                    totalAll += totalTwoMonths;
                    offersCount++;
                }
                if (totalAll > 0) {
                    agentsCount++;
                }
                totalBasicAll += totalBasic;
                totalAdvancedAll += totalAdvanced;
                totalTwoMonthsAll += totalTwoMonths;
                totalAllAgents += totalAll;
                
                let agentOffersHTML = '';
                if (report.basic && totalBasic > 0) {
                    agentOffersHTML += `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 10px; background: rgba(34, 197, 94, 0.1); border-radius: 6px; margin-bottom: 6px; border-right: 2px solid #22c55e;">
                            <span style="font-weight: 600; color: var(--text-primary); font-size: 0.85rem;">üÜì ÿßŸÑÿπÿ±ÿ∂ ÿßŸÑŸÖÿ¨ÿßŸÜŸä</span>
                            <span style="font-weight: 700; color: #22c55e; font-size: 0.85rem;">${formatNumber(totalBasic)} ÿØ.ÿπ</span>
                        </div>
                    `;
                }
                if (report.advanced && totalAdvanced > 0) {
                    agentOffersHTML += `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 10px; background: rgba(59, 130, 246, 0.1); border-radius: 6px; margin-bottom: 6px; border-right: 2px solid #3b82f6;">
                            <span style="font-weight: 600; color: var(--text-primary); font-size: 0.85rem;">üìâ ŸÖÿÆŸÅÿ∂ 3 ÿ£ÿ¥Ÿáÿ±</span>
                            <span style="font-weight: 700; color: #3b82f6; font-size: 0.85rem;">${formatNumber(totalAdvanced)} ÿØ.ÿπ</span>
                        </div>
                    `;
                }
                if (report.twoMonths && totalTwoMonths > 0) {
                    agentOffersHTML += `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 10px; background: rgba(168, 85, 247, 0.1); border-radius: 6px; margin-bottom: 6px; border-right: 2px solid #a855f7;">
                            <span style="font-weight: 600; color: var(--text-primary); font-size: 0.85rem;">üìâ ŸÖÿÆŸÅÿ∂ ÿ¥Ÿáÿ±ŸäŸÜ</span>
                            <span style="font-weight: 700; color: #a855f7; font-size: 0.85rem;">${formatNumber(totalTwoMonths)} ÿØ.ÿπ</span>
                        </div>
                    `;
                }
                
                if (totalAll > 0) {
                    const agentPercentage = totalAllAgents > 0 ? ((totalAll / totalAllAgents) * 100).toFixed(1) : 0;
                    summaryHTML += `
                        <div class="agent-summary-card" style="background: var(--card-bg); border: 2px solid var(--border-color); border-radius: 12px; padding: 16px; box-shadow: 0 3px 12px var(--shadow-sm); transition: all 0.3s ease; position: relative; overflow: hidden;">
                            <div style="position: absolute; top: 0; right: 0; width: 45px; height: 45px; background: linear-gradient(135deg, rgba(128, 28, 50, 0.1), rgba(165, 45, 69, 0.05)); border-radius: 0 0 0 40px;"></div>
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; padding-bottom: 10px; border-bottom: 2px solid var(--border-color); position: relative; z-index: 2;">
                                <h3 style="margin: 0; font-size: 1rem; font-weight: 800; color: var(--primary-color); text-shadow: 0 1px 2px rgba(0,0,0,0.1);">${agentName}</h3>
                                <span style="background: linear-gradient(135deg, var(--primary-color), var(--primary-hover)); color: #fff; padding: 4px 10px; border-radius: 16px; font-size: 0.7rem; font-weight: 700; box-shadow: 0 2px 6px rgba(128, 28, 50, 0.3);">${offersCount} ÿπÿ±ÿ∂</span>
                            </div>
                            <div style="margin-bottom: 12px; position: relative; z-index: 2;">
                                ${agentOffersHTML}
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: linear-gradient(135deg, rgba(128, 28, 50, 0.12), rgba(165, 45, 69, 0.08)); border-radius: 8px; border-top: 2px solid var(--primary-color); margin-top: 8px; position: relative; z-index: 2; box-shadow: 0 2px 6px rgba(128, 28, 50, 0.1);">
                                <div>
                                    <span style="font-weight: 700; color: var(--text-primary); font-size: 0.85rem; display: block; margin-bottom: 3px;">ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä:</span>
                                    <span style="font-size: 0.7rem; color: var(--text-secondary); font-weight: 600;">${agentPercentage}% ŸÖŸÜ ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä</span>
                                </div>
                                <span style="font-weight: 900; color: var(--primary-color); font-size: 1.2rem; text-shadow: 0 2px 4px rgba(128, 28, 50, 0.2);">${formatNumber(totalAll)} ÿØ.ÿπ</span>
                            </div>
                        </div>
                    `;
                }
            });
            summaryHTML += `</div>`;
            document.getElementById('summaryContent').innerHTML = summaryHTML;
            
            const totalOffers = totalBasicAll + totalAdvancedAll + totalTwoMonthsAll;
            const basicPercentage = totalOffers > 0 ? ((totalBasicAll / totalOffers) * 100).toFixed(1) : 0;
            const advancedPercentage = totalOffers > 0 ? ((totalAdvancedAll / totalOffers) * 100).toFixed(1) : 0;
            const twoMonthsPercentage = totalOffers > 0 ? ((totalTwoMonthsAll / totalOffers) * 100).toFixed(1) : 0;
            
            let basicAgentsCount = 0, advancedAgentsCount = 0, twoMonthsAgentsCount = 0;
            sortedAgents.forEach(([agentName, report]) => {
                if (report.basic && report.basic.total && report.basic.total.amount > 0) basicAgentsCount++;
                if (report.advanced && report.advanced.total && report.advanced.total.profit > 0) advancedAgentsCount++;
                if (report.twoMonths && report.twoMonths.total && report.twoMonths.total.profit > 0) twoMonthsAgentsCount++;
            });
            
            let totalsHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <div style="background: linear-gradient(135deg, #22c55e, #16a34a); color: #fff; border-radius: 12px; padding: 18px; box-shadow: 0 4px 16px rgba(34, 197, 94, 0.3); text-align: center; border: 2px solid rgba(255, 255, 255, 0.2); position: relative; overflow: hidden;">
                        <div style="position: absolute; top: -15px; right: -15px; width: 70px; height: 70px; background: rgba(255, 255, 255, 0.1); border-radius: 50%;"></div>
                        <div style="position: relative; z-index: 2;">
                            <div style="font-size: 1.5rem; margin-bottom: 8px;"></div>
                            <div style="font-size: 0.95rem; font-weight: 700; margin-bottom: 10px; opacity: 0.95;">ÿßŸÑÿπÿ±ÿ∂ ÿßŸÑŸÖÿ¨ÿßŸÜŸä</div>
                            <div style="font-size: 1.6rem; font-weight: 900; margin-bottom: 6px; text-shadow: 0 2px 6px rgba(0,0,0,0.2);">${formatNumber(totalBasicAll)}</div>
                            <div style="padding: 6px 10px; background: rgba(255, 255, 255, 0.2); border-radius: 6px; margin-top: 8px; font-size: 0.8rem; font-weight: 600;">
                                ${basicPercentage}% | ${basicAgentsCount} ŸàŸÉŸäŸÑ
                            </div>
                        </div>
                    </div>
                    <div style="background: linear-gradient(135deg, #3b82f6, #2563eb); color: #fff; border-radius: 12px; padding: 18px; box-shadow: 0 4px 16px rgba(59, 130, 246, 0.3); text-align: center; border: 2px solid rgba(255, 255, 255, 0.2); position: relative; overflow: hidden;">
                        <div style="position: absolute; top: -15px; right: -15px; width: 70px; height: 70px; background: rgba(255, 255, 255, 0.1); border-radius: 50%;"></div>
                        <div style="position: relative; z-index: 2;">
                            <div style="font-size: 1.5rem; margin-bottom: 8px;"></div>
                            <div style="font-size: 0.95rem; font-weight: 700; margin-bottom: 10px; opacity: 0.95;">ŸÖÿÆŸÅÿ∂ 3 ÿ£ÿ¥Ÿáÿ±</div>
                            <div style="font-size: 1.6rem; font-weight: 900; margin-bottom: 6px; text-shadow: 0 2px 6px rgba(0,0,0,0.2);">${formatNumber(totalAdvancedAll)}</div>
                            <div style="padding: 6px 10px; background: rgba(255, 255, 255, 0.2); border-radius: 6px; margin-top: 8px; font-size: 0.8rem; font-weight: 600;">
                                ${advancedPercentage}% | ${advancedAgentsCount} ŸàŸÉŸäŸÑ
                            </div>
                        </div>
                    </div>
                    <div style="background: linear-gradient(135deg, #a855f7, #9333ea); color: #fff; border-radius: 12px; padding: 18px; box-shadow: 0 4px 16px rgba(168, 85, 247, 0.3); text-align: center; border: 2px solid rgba(255, 255, 255, 0.2); position: relative; overflow: hidden;">
                        <div style="position: absolute; top: -15px; right: -15px; width: 70px; height: 70px; background: rgba(255, 255, 255, 0.1); border-radius: 50%;"></div>
                        <div style="position: relative; z-index: 2;">
                            <div style="font-size: 1.5rem; margin-bottom: 8px;"></div>
                            <div style="font-size: 0.95rem; font-weight: 700; margin-bottom: 10px; opacity: 0.95;">ŸÖÿÆŸÅÿ∂ ÿ¥Ÿáÿ±ŸäŸÜ</div>
                            <div style="font-size: 1.6rem; font-weight: 900; margin-bottom: 6px; text-shadow: 0 2px 6px rgba(0,0,0,0.2);">${formatNumber(totalTwoMonthsAll)}</div>
                            <div style="padding: 6px 10px; background: rgba(255, 255, 255, 0.2); border-radius: 6px; margin-top: 8px; font-size: 0.8rem; font-weight: 600;">
                                ${twoMonthsPercentage}% | ${twoMonthsAgentsCount} ŸàŸÉŸäŸÑ
                            </div>
                        </div>
                    </div>
                    <div style="background: linear-gradient(135deg, #801c32, #a52d45); color: #fff; border-radius: 12px; padding: 18px; box-shadow: 0 6px 20px rgba(128, 28, 50, 0.4); text-align: center; border: 2px solid rgba(255, 255, 255, 0.3); position: relative; overflow: hidden;">
                        <div style="position: absolute; top: -20px; right: -20px; width: 80px; height: 80px; background: rgba(255, 255, 255, 0.15); border-radius: 50%;"></div>
                        <div style="position: relative; z-index: 2;">
                            <div style="font-size: 1.8rem; margin-bottom: 10px;"></div>
                            <div style="font-size: 1rem; font-weight: 800; margin-bottom: 12px; opacity: 0.95; text-shadow: 0 2px 4px rgba(0,0,0,0.3);">ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÉŸÑŸä</div>
                            <div style="font-size: 1.8rem; font-weight: 900; margin-bottom: 8px; text-shadow: 0 2px 8px rgba(0,0,0,0.3);">${formatNumber(totalAllAgents)}</div>
                            <div style="font-size: 0.85rem; opacity: 0.95; margin-bottom: 10px; font-weight: 600;">ÿØŸäŸÜÿßÿ± ÿπÿ±ÿßŸÇŸä</div>
                            <div style="padding: 8px 12px; background: rgba(255, 255, 255, 0.25); border-radius: 8px; margin-top: 8px; font-size: 0.85rem; font-weight: 700; border: 1px solid rgba(255, 255, 255, 0.3);">
                                ${agentsCount} ŸàŸÉŸäŸÑ 
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('summaryTotalsGrid').innerHTML = totalsHTML;
            document.getElementById('summaryTotals').style.display = 'block';
            
            createCharts(totalBasicAll, totalAdvancedAll, totalTwoMonthsAll, sortedAgents);
        }
        
        function createCharts(totalBasic, totalAdvanced, totalTwoMonths, agentsData) {
            if (window.offersChart && typeof window.offersChart.destroy === 'function') {
                try {
                    window.offersChart.destroy();
                } catch (e) {
                    console.warn('Error destroying offersChart:', e);
                }
                window.offersChart = null;
            }
            if (window.topAgentsChart && typeof window.topAgentsChart.destroy === 'function') {
                try {
                    window.topAgentsChart.destroy();
                } catch (e) {
                    console.warn('Error destroying topAgentsChart:', e);
                }
                window.topAgentsChart = null;
            }
            if (window.subscriptionsChart && typeof window.subscriptionsChart.destroy === 'function') {
                try {
                    window.subscriptionsChart.destroy();
                } catch (e) {
                    console.warn('Error destroying subscriptionsChart:', e);
                }
                window.subscriptionsChart = null;
            }
            
            const offersCtx = document.getElementById('offersChart');
            if (offersCtx) {
                const totalOffers = totalBasic + totalAdvanced + totalTwoMonths;
                window.offersChart = new Chart(offersCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['ÿßŸÑÿπÿ±ÿ∂ ÿßŸÑŸÖÿ¨ÿßŸÜŸä', 'ŸÖÿÆŸÅÿ∂ 3 ÿ£ÿ¥Ÿáÿ±', 'ŸÖÿÆŸÅÿ∂ ÿ¥Ÿáÿ±ŸäŸÜ'],
                        datasets: [{
                            data: [totalBasic, totalAdvanced, totalTwoMonths],
                            backgroundColor: [
                                'rgba(34, 197, 94, 0.85)',
                                'rgba(59, 130, 246, 0.85)',
                                'rgba(168, 85, 247, 0.85)'
                            ],
                            borderColor: [
                                '#22c55e',
                                '#3b82f6',
                                '#a855f7'
                            ],
                            borderWidth: 3,
                            hoverOffset: 8
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 12,
                                    font: {
                                        size: 11,
                                        family: 'Cairo',
                                        weight: '600'
                                    },
                                    usePointStyle: true,
                                    pointStyle: 'circle'
                                }
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                padding: 10,
                                titleFont: {
                                    size: 12,
                                    family: 'Cairo',
                                    weight: '700'
                                },
                                bodyFont: {
                                    size: 11,
                                    family: 'Cairo'
                                },
                                callbacks: {
                                    label: function(context) {
                                        const value = context.parsed;
                                        const percentage = totalOffers > 0 ? ((value / totalOffers) * 100).toFixed(1) : 0;
                                        return context.label + ': ' + formatNumber(value) + ' ÿØ.ÿπ (' + percentage + '%)';
                                    }
                                }
                            }
                        }
                    }
                });
            }
            
            const topAgentsCtx = document.getElementById('topAgentsChart');
            if (topAgentsCtx && agentsData.length > 0) {
                const topAgents = agentsData.slice(0, 10).map(([agentName, report]) => {
                    let total = 0;
                    if (report.basic?.total?.amount) total += report.basic.total.amount;
                    if (report.advanced?.total?.profit) total += report.advanced.total.profit;
                    if (report.twoMonths?.total?.profit) total += report.twoMonths.total.profit;
                    return { name: agentName, total: total };
                }).filter(a => a.total > 0);
                
                window.topAgentsChart = new Chart(topAgentsCtx, {
                    type: 'bar',
                    data: {
                        labels: topAgents.map(a => a.name),
                        datasets: [{
                            label: 'ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä (ÿØ.ÿπ)',
                            data: topAgents.map(a => a.total),
                            backgroundColor: topAgents.map((a, i) => {
                                const colors = [
                                    'rgba(128, 28, 50, 0.85)',
                                    'rgba(165, 45, 69, 0.85)',
                                    'rgba(192, 62, 86, 0.85)',
                                    'rgba(219, 79, 103, 0.85)',
                                    'rgba(246, 96, 120, 0.85)'
                                ];
                                return colors[i % colors.length];
                            }),
                            borderColor: '#801c32',
                            borderWidth: 2,
                            borderRadius: 6,
                            borderSkipped: false
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        indexAxis: 'y',
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                padding: 10,
                                titleFont: {
                                    size: 12,
                                    family: 'Cairo',
                                    weight: '700'
                                },
                                bodyFont: {
                                    size: 11,
                                    family: 'Cairo'
                                },
                                callbacks: {
                                    label: function(context) {
                                        return formatNumber(context.parsed.x) + ' ÿØŸäŸÜÿßÿ± ÿπÿ±ÿßŸÇŸä';
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                ticks: {
                                    callback: function(value) {
                                        return formatNumber(value);
                                    },
                                    font: {
                                        size: 9,
                                        family: 'Cairo'
                                    }
                                },
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)'
                                }
                            },
                            y: {
                                ticks: {
                                    font: {
                                        size: 9,
                                        family: 'Cairo'
                                    }
                                },
                                grid: {
                                    display: false
                                }
                            }
                        }
                    }
                });
            }
            
            const subscriptionsCtx = document.getElementById('subscriptionsChart');
            if (subscriptionsCtx) {
                let totalBronze = 0, totalSilver = 0, totalGold = 0, totalPlatinum = 0;
                if (agentsData && agentsData.length > 0) {
                    agentsData.forEach(([agentName, report]) => {
                        if (report.basic && report.basic.bronze) {
                            totalBronze += Number(report.basic.bronze.count || 0);
                        }
                        if (report.basic && report.basic.silver) {
                            totalSilver += Number(report.basic.silver.count || 0);
                        }
                        if (report.basic && report.basic.gold) {
                            totalGold += Number(report.basic.gold.count || 0);
                        }
                        if (report.basic && report.basic.platinum) {
                            totalPlatinum += Number(report.basic.platinum.count || 0);
                        }
                        if (report.advanced && report.advanced.bronze) {
                            totalBronze += Number(report.advanced.bronze.count || 0);
                        }
                        if (report.advanced && report.advanced.silver) {
                            totalSilver += Number(report.advanced.silver.count || 0);
                        }
                        if (report.advanced && report.advanced.gold) {
                            totalGold += Number(report.advanced.gold.count || 0);
                        }
                        if (report.advanced && report.advanced.platinum) {
                            totalPlatinum += Number(report.advanced.platinum.count || 0);
                        }
                        if (report.twoMonths && report.twoMonths.bronze) {
                            totalBronze += Number(report.twoMonths.bronze.count || 0);
                        }
                        if (report.twoMonths && report.twoMonths.silver) {
                            totalSilver += Number(report.twoMonths.silver.count || 0);
                        }
                        if (report.twoMonths && report.twoMonths.gold) {
                            totalGold += Number(report.twoMonths.gold.count || 0);
                        }
                        if (report.twoMonths && report.twoMonths.platinum) {
                            totalPlatinum += Number(report.twoMonths.platinum.count || 0);
                        }
                    });
                }
                
                const totalSubscriptions = totalBronze + totalSilver + totalGold + totalPlatinum;
                const chartData = totalSubscriptions > 0 
                    ? [totalBronze, totalSilver, totalGold, totalPlatinum]
                    : [1, 1, 1, 1];
                
                const labels = ['ÿ®ÿ±ŸàŸÜÿ≤ (Bronze)', 'ÿ≥ŸÑŸÅÿ± (Silver)', 'ÿ∞Ÿáÿ®Ÿä (Gold)', 'ÿ®ŸÑÿßÿ™ŸäŸÜŸäŸàŸÖ (Platinum)'];
                const backgroundColors = [
                    'rgba(205, 127, 50, 0.8)',
                    'rgba(192, 192, 192, 0.8)',
                    'rgba(255, 215, 0, 0.8)',
                    'rgba(231, 231, 231, 0.8)'
                ];
                const borderColors = [
                    '#cd7f32',
                    '#c0c0c0',
                    '#ffd700',
                    '#e7e7e7'
                ];
                
                window.subscriptionsChart = new Chart(subscriptionsCtx, {
                    type: 'pie',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: chartData,
                            backgroundColor: backgroundColors,
                            borderColor: borderColors,
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 10,
                                    font: {
                                        size: 10,
                                        family: 'Cairo',
                                        weight: '600'
                                    },
                                    usePointStyle: true,
                                    pointStyle: 'circle',
                                    generateLabels: function(chart) {
                                        const values = [totalBronze, totalSilver, totalGold, totalPlatinum];
                                        const total = totalSubscriptions > 0 ? totalSubscriptions : values.reduce((a, b) => a + b, 0);
                                        return labels.map((label, i) => {
                                            const value = values[i];
                                            const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                            return {
                                                text: label + ': ' + formatNumberEnglish(value) + ' (' + percentage + '%)',
                                                fillStyle: backgroundColors[i],
                                                strokeStyle: borderColors[i],
                                                lineWidth: 2,
                                                hidden: false,
                                                index: i
                                            };
                                        });
                                    }
                                }
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                padding: 10,
                                titleFont: {
                                    size: 12,
                                    family: 'Cairo',
                                    weight: '700'
                                },
                                bodyFont: {
                                    size: 11,
                                    family: 'Cairo'
                                },
                                callbacks: {
                                    label: function(context) {
                                        if (totalSubscriptions === 0) {
                                            return context.label + ': ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™';
                                        }
                                        const value = context.parsed;
                                        const percentage = totalSubscriptions > 0 ? ((value / totalSubscriptions) * 100).toFixed(1) : 0;
                                        return context.label + ': ' + formatNumberEnglish(value) + ' ÿßÿ¥ÿ™ÿ±ÿßŸÉ (' + percentage + '%)';
                                    }
                                }
                            }
                        }
                    }
                });
            }
            
            document.getElementById('chartsSection').style.display = 'block';
        }
        function refreshSummary() {
            updateAgentSummary();
            showSuccessMessage('ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÖŸÑÿÆÿµ ÿ®ŸÜÿ¨ÿßÿ≠!');
        }
        function exportSummaryToExcel() {
            if (!agentReports || Object.keys(agentReports).length === 0) {
                alert('ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™ ŸÑŸÑÿ™ÿµÿØŸäÿ±. Ÿäÿ±ÿ¨Ÿâ ÿ™ÿ≠ŸÑŸäŸÑ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸàŸÉŸÑÿßÿ° ÿ£ŸàŸÑÿßŸã.');
                return;
            }
            
            let analyzedOfferType = null;
            let hasBasic = false, hasAdvanced = false, hasTwoMonths = false;
            
            Object.values(agentReports).forEach(report => {
                if (report.basic && report.basic.total && report.basic.total.count > 0) {
                    hasBasic = true;
                }
                if (report.advanced && report.advanced.total && report.advanced.total.count > 0) {
                    hasAdvanced = true;
                }
                if (report.twoMonths && report.twoMonths.total && report.twoMonths.total.count > 0) {
                    hasTwoMonths = true;
                }
            });
            
            if (hasBasic) {
                analyzedOfferType = 'basic';
            } else if (hasAdvanced) {
                analyzedOfferType = 'advanced';
            } else if (hasTwoMonths) {
                analyzedOfferType = 'twoMonths';
            }
            
            if (!analyzedOfferType) {
                alert('ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™ ŸÖÿ≠ŸÑŸÑÿ© ŸÑŸÑÿ™ÿµÿØŸäÿ±. Ÿäÿ±ÿ¨Ÿâ ÿ™ÿ≠ŸÑŸäŸÑ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸàŸÉŸÑÿßÿ° ÿ£ŸàŸÑÿßŸã.');
                return;
            }
            
            try {
                const ExcelJS = window.ExcelJS;
                if (!ExcelJS) {
                    exportSummaryToExcelXLSX(analyzedOfferType);
                    return;
                }
                const workbook = new ExcelJS.Workbook();
                let worksheetTitle = '';
                let reportTitle = '';
                let headers = [];
                let totalColumns = 0;
                
                if (analyzedOfferType === 'basic') {
                    worksheetTitle = 'ÿßŸÑÿπÿ±ÿ∂ ÿßŸÑŸÖÿ¨ÿßŸÜŸä';
                    reportTitle = 'ÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑÿπÿ±ÿ∂ ÿßŸÑŸÖÿ¨ÿßŸÜŸä';
                    headers = [
                        'ÿßÿ≥ŸÖ ÿßŸÑŸàŸÉŸäŸÑ',
                        'ŸÜÿ≥ÿ®ÿ© ÿßŸÑŸàŸÉŸäŸÑ',
                        'ÿ®ÿ±ŸàŸÜÿ≤ (ÿπÿØÿØ)', 'ÿ®ÿ±ŸàŸÜÿ≤ (ŸÖÿ®ŸÑÿ∫)',
                        'ÿ≥ŸÑŸÅÿ± (ÿπÿØÿØ)', 'ÿ≥ŸÑŸÅÿ± (ŸÖÿ®ŸÑÿ∫)',
                        'ÿ∞Ÿáÿ®Ÿä (ÿπÿØÿØ)', 'ÿ∞Ÿáÿ®Ÿä (ŸÖÿ®ŸÑÿ∫)',
                        'ÿ®ŸÑÿßÿ™ŸäŸÜŸäŸàŸÖ (ÿπÿØÿØ)', 'ÿ®ŸÑÿßÿ™ŸäŸÜŸäŸàŸÖ (ŸÖÿ®ŸÑÿ∫)',
                        'ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä'
                    ];
                    totalColumns = 11;
                } else if (analyzedOfferType === 'advanced') {
                    worksheetTitle = 'ŸÖÿÆŸÅÿ∂ 3 ÿ£ÿ¥Ÿáÿ±';
                    reportTitle = 'ÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑÿπÿ±ÿ∂ ÿßŸÑŸÖÿÆŸÅÿ∂ ŸÑÿ´ŸÑÿßÿ´ÿ© ÿ£ÿ¥Ÿáÿ±';
                    headers = [
                        'ÿßÿ≥ŸÖ ÿßŸÑŸàŸÉŸäŸÑ',
                        'ŸÜÿ≥ÿ®ÿ© ÿßŸÑŸàŸÉŸäŸÑ',
                        'ÿ®ÿ±ŸàŸÜÿ≤ (ÿπÿØÿØ)', 'ÿ®ÿ±ŸàŸÜÿ≤ (ÿπÿ±ÿ∂)', 'ÿ®ÿ±ŸàŸÜÿ≤ (ÿ±ÿ≥ŸÖŸä)', 'ÿ®ÿ±ŸàŸÜÿ≤ (ÿ±ÿßÿ¨ÿπ)',
                        'ÿ≥ŸÑŸÅÿ± (ÿπÿØÿØ)', 'ÿ≥ŸÑŸÅÿ± (ÿπÿ±ÿ∂)', 'ÿ≥ŸÑŸÅÿ± (ÿ±ÿ≥ŸÖŸä)', 'ÿ≥ŸÑŸÅÿ± (ÿ±ÿßÿ¨ÿπ)',
                        'ÿ∞Ÿáÿ®Ÿä (ÿπÿØÿØ)', 'ÿ∞Ÿáÿ®Ÿä (ÿπÿ±ÿ∂)', 'ÿ∞Ÿáÿ®Ÿä (ÿ±ÿ≥ŸÖŸä)', 'ÿ∞Ÿáÿ®Ÿä (ÿ±ÿßÿ¨ÿπ)',
                        'ÿ®ŸÑÿßÿ™ŸäŸÜŸäŸàŸÖ (ÿπÿØÿØ)', 'ÿ®ŸÑÿßÿ™ŸäŸÜŸäŸàŸÖ (ÿπÿ±ÿ∂)', 'ÿ®ŸÑÿßÿ™ŸäŸÜŸäŸàŸÖ (ÿ±ÿ≥ŸÖŸä)', 'ÿ®ŸÑÿßÿ™ŸäŸÜŸäŸàŸÖ (ÿ±ÿßÿ¨ÿπ)',
                        'ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä (ÿßŸÑÿ±ÿßÿ¨ÿπ)'
                    ];
                    totalColumns = 19;
                } else if (analyzedOfferType === 'twoMonths') {
                    worksheetTitle = 'ŸÖÿÆŸÅÿ∂ ÿ¥Ÿáÿ±ŸäŸÜ';
                    reportTitle = 'ÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑÿπÿ±ÿ∂ ÿßŸÑŸÖÿÆŸÅÿ∂ ŸÑÿ¥Ÿáÿ±ŸäŸÜ';
                    headers = [
                        'ÿßÿ≥ŸÖ ÿßŸÑŸàŸÉŸäŸÑ',
                        'ŸÜÿ≥ÿ®ÿ© ÿßŸÑŸàŸÉŸäŸÑ',
                        'ÿ®ÿ±ŸàŸÜÿ≤ (ÿπÿØÿØ)', 'ÿ®ÿ±ŸàŸÜÿ≤ (ÿπÿ±ÿ∂)', 'ÿ®ÿ±ŸàŸÜÿ≤ (ÿ±ÿ≥ŸÖŸä)', 'ÿ®ÿ±ŸàŸÜÿ≤ (ÿ±ÿßÿ¨ÿπ)',
                        'ÿ≥ŸÑŸÅÿ± (ÿπÿØÿØ)', 'ÿ≥ŸÑŸÅÿ± (ÿπÿ±ÿ∂)', 'ÿ≥ŸÑŸÅÿ± (ÿ±ÿ≥ŸÖŸä)', 'ÿ≥ŸÑŸÅÿ± (ÿ±ÿßÿ¨ÿπ)',
                        'ÿ∞Ÿáÿ®Ÿä (ÿπÿØÿØ)', 'ÿ∞Ÿáÿ®Ÿä (ÿπÿ±ÿ∂)', 'ÿ∞Ÿáÿ®Ÿä (ÿ±ÿ≥ŸÖŸä)', 'ÿ∞Ÿáÿ®Ÿä (ÿ±ÿßÿ¨ÿπ)',
                        'ÿ®ŸÑÿßÿ™ŸäŸÜŸäŸàŸÖ (ÿπÿØÿØ)', 'ÿ®ŸÑÿßÿ™ŸäŸÜŸäŸàŸÖ (ÿπÿ±ÿ∂)', 'ÿ®ŸÑÿßÿ™ŸäŸÜŸäŸàŸÖ (ÿ±ÿ≥ŸÖŸä)', 'ÿ®ŸÑÿßÿ™ŸäŸÜŸäŸàŸÖ (ÿ±ÿßÿ¨ÿπ)',
                        'ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä (ÿßŸÑÿ±ÿßÿ¨ÿπ)'
                    ];
                    totalColumns = 19;
                }
                
                const worksheet = workbook.addWorksheet(worksheetTitle);
                
                const titleRow = worksheet.getRow(1);
                titleRow.getCell(1).value = reportTitle;
                titleRow.getCell(1).font = { bold: true, size: 18, color: { argb: 'FF801C32' } };
                titleRow.getCell(1).alignment = { horizontal: 'center', vertical: 'middle' };
                worksheet.mergeCells(1, 1, 1, totalColumns);
                titleRow.height = 35;
                
                let monthYear = null;
                if (analyzedOfferType === 'basic') {
                    monthYear = extractMonthYearFromDetails(basicDetails) || extractMonthYearFromData(basicData);
                } else if (analyzedOfferType === 'advanced') {
                    monthYear = extractMonthYearFromDetails(advancedDetails) || extractMonthYearFromData(advancedData);
                } else if (analyzedOfferType === 'twoMonths') {
                    monthYear = extractMonthYearFromDetails(twoMonthsDetails) || extractMonthYearFromData(twoMonthsData);
                }
                
                let monthInfo = '';
                if (monthYear) {
                    const [year, month] = monthYear.split('-');
                    const monthIndex = parseInt(month) - 1;
                    if (monthIndex >= 0 && monthIndex < arabicMonths.length) {
                        monthInfo = ` ŸÑÿ¥Ÿáÿ±: ${arabicMonths[monthIndex]} ${year}`;
                    }
                }
                
                const monthRow = worksheet.getRow(2);
                if (monthInfo) {
                    monthRow.getCell(1).value = monthInfo;
                    monthRow.getCell(1).font = { bold: true, size: 14, color: { argb: 'FF801C32' } };
                    monthRow.getCell(1).alignment = { horizontal: 'center', vertical: 'middle' };
                    worksheet.mergeCells(2, 1, 2, totalColumns);
                    monthRow.height = 30;
                }
                
                const dateRow = worksheet.getRow(monthInfo ? 3 : 2);
                const now = new Date();
                const dateStr = `${now.getDate()}/${now.getMonth() + 1}/${now.getFullYear()} ${now.getHours()}:${String(now.getMinutes()).padStart(2, '0')}`;
                dateRow.getCell(1).value = `ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ™ŸÇÿ±Ÿäÿ±: ${dateStr}`;
                dateRow.getCell(1).font = { size: 12, color: { argb: 'FF666666' } };
                dateRow.getCell(1).alignment = { horizontal: 'center' };
                worksheet.mergeCells(monthInfo ? 3 : 2, 1, monthInfo ? 3 : 2, totalColumns);
                dateRow.height = 25;
                
                let currentRow = monthInfo ? 5 : 4;
                
                const headerRow = worksheet.getRow(currentRow);
                headers.forEach((header, idx) => {
                    const cell = headerRow.getCell(idx + 1);
                    cell.value = header;
                    cell.font = { bold: true, size: 12, color: { argb: 'FFFFFFFF' } };
                    cell.fill = {
                        type: 'pattern',
                        pattern: 'solid',
                        fgColor: { argb: 'FF801C32' }
                    };
                    cell.alignment = { horizontal: 'center', vertical: 'middle', wrapText: true };
                    cell.border = {
                        top: { style: 'thin', color: { argb: 'FFFFFFFF' } },
                        bottom: { style: 'thin', color: { argb: 'FFFFFFFF' } },
                        left: { style: 'thin', color: { argb: 'FFFFFFFF' } },
                        right: { style: 'thin', color: { argb: 'FFFFFFFF' } }
                    };
                });
                headerRow.height = 40;
                
                const sortedAgents = Object.entries(agentReports).sort((a, b) => {
                    let totalA = 0, totalB = 0;
                    if (analyzedOfferType === 'basic') {
                        totalA = (a[1].basic?.total?.amount || 0);
                        totalB = (b[1].basic?.total?.amount || 0);
                    } else if (analyzedOfferType === 'advanced') {
                        totalA = (a[1].advanced?.total?.profit || 0);
                        totalB = (b[1].advanced?.total?.profit || 0);
                    } else if (analyzedOfferType === 'twoMonths') {
                        totalA = (a[1].twoMonths?.total?.profit || 0);
                        totalB = (b[1].twoMonths?.total?.profit || 0);
                    }
                    return totalB - totalA;
                });
                
                let grandTotal = 0;
                let grandTotalBronzeCount = 0, grandTotalSilverCount = 0, grandTotalGoldCount = 0, grandTotalPlatinumCount = 0;
                let grandTotalBronzeAmount = 0, grandTotalSilverAmount = 0, grandTotalGoldAmount = 0, grandTotalPlatinumAmount = 0;
                
                sortedAgents.forEach(([agentName, report], index) => {
                    let hasData = false;
                    if (analyzedOfferType === 'basic' && report.basic && report.basic.total && report.basic.total.count > 0) {
                        hasData = true;
                    } else if (analyzedOfferType === 'advanced' && report.advanced && report.advanced.total && report.advanced.total.count > 0) {
                        hasData = true;
                    } else if (analyzedOfferType === 'twoMonths' && report.twoMonths && report.twoMonths.total && report.twoMonths.total.count > 0) {
                        hasData = true;
                    }
                    
                    if (!hasData) return;
                    
                    currentRow++;
                    const dataRow = worksheet.getRow(currentRow);
                    let col = 1;
                    
                    const agent = agentsList.find(a => a.name === agentName);
                    const agentSubName = agent?.subName || '';
                    const agentPercentage = agent?.percentage || 0;
                    
                    const agentNameCell = dataRow.getCell(col++);
                    if (agentSubName) {
                        agentNameCell.value = `${agentName}\n${agentSubName}`;
                    } else {
                        agentNameCell.value = agentName;
                    }
                    agentNameCell.alignment = { horizontal: 'center', vertical: 'middle', wrapText: true };
                    
                    const percentageCell = dataRow.getCell(col++);
                    percentageCell.value = agentPercentage;
                    if (agentPercentage > 0) {
                        percentageCell.numFmt = '0.00"%"';
                    }
                    
                    if (analyzedOfferType === 'basic') {
                    const basic = report.basic || {};
                    const basicBronze = basic.bronze || { count: 0, amount: 0 };
                    const basicSilver = basic.silver || { count: 0, amount: 0 };
                    const basicGold = basic.gold || { count: 0, amount: 0 };
                    const basicPlatinum = basic.platinum || { count: 0, amount: 0 };
                    const basicTotal = basic.total || { count: 0, amount: 0 };
                    
                    dataRow.getCell(col++).value = basicBronze.count || 0;
                    dataRow.getCell(col++).value = basicBronze.amount || 0;
                    dataRow.getCell(col++).value = basicSilver.count || 0;
                    dataRow.getCell(col++).value = basicSilver.amount || 0;
                    dataRow.getCell(col++).value = basicGold.count || 0;
                    dataRow.getCell(col++).value = basicGold.amount || 0;
                    dataRow.getCell(col++).value = basicPlatinum.count || 0;
                    dataRow.getCell(col++).value = basicPlatinum.amount || 0;
                    dataRow.getCell(col++).value = basicTotal.amount || 0;
                        
                        grandTotal += basicTotal.amount || 0;
                        grandTotalBronzeCount += basicBronze.count || 0;
                        grandTotalSilverCount += basicSilver.count || 0;
                        grandTotalGoldCount += basicGold.count || 0;
                        grandTotalPlatinumCount += basicPlatinum.count || 0;
                        grandTotalBronzeAmount += basicBronze.amount || 0;
                        grandTotalSilverAmount += basicSilver.amount || 0;
                        grandTotalGoldAmount += basicGold.amount || 0;
                        grandTotalPlatinumAmount += basicPlatinum.amount || 0;
                    } else if (analyzedOfferType === 'advanced') {
                    const advanced = report.advanced || {};
                    const advBronze = advanced.bronze || { count: 0, promoAmount: 0, officialAmount: 0 };
                    const advSilver = advanced.silver || { count: 0, promoAmount: 0, officialAmount: 0 };
                    const advGold = advanced.gold || { count: 0, promoAmount: 0, officialAmount: 0 };
                    const advPlatinum = advanced.platinum || { count: 0, promoAmount: 0, officialAmount: 0 };
                    const advTotal = advanced.total || { count: 0, profit: 0, promoAmount: 0, officialAmount: 0 };
                    
                    dataRow.getCell(col++).value = advBronze.count || 0;
                    dataRow.getCell(col++).value = advBronze.promoAmount || 0;
                    dataRow.getCell(col++).value = advBronze.officialAmount || 0;
                    dataRow.getCell(col++).value = (advBronze.officialAmount || 0) - (advBronze.promoAmount || 0);
                    dataRow.getCell(col++).value = advSilver.count || 0;
                    dataRow.getCell(col++).value = advSilver.promoAmount || 0;
                    dataRow.getCell(col++).value = advSilver.officialAmount || 0;
                    dataRow.getCell(col++).value = (advSilver.officialAmount || 0) - (advSilver.promoAmount || 0);
                    dataRow.getCell(col++).value = advGold.count || 0;
                    dataRow.getCell(col++).value = advGold.promoAmount || 0;
                    dataRow.getCell(col++).value = advGold.officialAmount || 0;
                    dataRow.getCell(col++).value = (advGold.officialAmount || 0) - (advGold.promoAmount || 0);
                    dataRow.getCell(col++).value = advPlatinum.count || 0;
                    dataRow.getCell(col++).value = advPlatinum.promoAmount || 0;
                    dataRow.getCell(col++).value = advPlatinum.officialAmount || 0;
                    dataRow.getCell(col++).value = (advPlatinum.officialAmount || 0) - (advPlatinum.promoAmount || 0);
                    dataRow.getCell(col++).value = advTotal.profit || 0;
                        
                        grandTotal += advTotal.profit || 0;
                        grandTotalBronzeCount += advBronze.count || 0;
                        grandTotalSilverCount += advSilver.count || 0;
                        grandTotalGoldCount += advGold.count || 0;
                        grandTotalPlatinumCount += advPlatinum.count || 0;
                    } else if (analyzedOfferType === 'twoMonths') {
                    const twoMonths = report.twoMonths || {};
                    const tmBronze = twoMonths.bronze || { count: 0, promoAmount: 0, officialAmount: 0 };
                    const tmSilver = twoMonths.silver || { count: 0, promoAmount: 0, officialAmount: 0 };
                    const tmGold = twoMonths.gold || { count: 0, promoAmount: 0, officialAmount: 0 };
                    const tmPlatinum = twoMonths.platinum || { count: 0, promoAmount: 0, officialAmount: 0 };
                    const tmTotal = twoMonths.total || { count: 0, profit: 0, promoAmount: 0, officialAmount: 0 };
                    
                    dataRow.getCell(col++).value = tmBronze.count || 0;
                    dataRow.getCell(col++).value = tmBronze.promoAmount || 0;
                    dataRow.getCell(col++).value = tmBronze.officialAmount || 0;
                    dataRow.getCell(col++).value = (tmBronze.officialAmount || 0) - (tmBronze.promoAmount || 0);
                    dataRow.getCell(col++).value = tmSilver.count || 0;
                    dataRow.getCell(col++).value = tmSilver.promoAmount || 0;
                    dataRow.getCell(col++).value = tmSilver.officialAmount || 0;
                    dataRow.getCell(col++).value = (tmSilver.officialAmount || 0) - (tmSilver.promoAmount || 0);
                    dataRow.getCell(col++).value = tmGold.count || 0;
                    dataRow.getCell(col++).value = tmGold.promoAmount || 0;
                    dataRow.getCell(col++).value = tmGold.officialAmount || 0;
                    dataRow.getCell(col++).value = (tmGold.officialAmount || 0) - (tmGold.promoAmount || 0);
                    dataRow.getCell(col++).value = tmPlatinum.count || 0;
                    dataRow.getCell(col++).value = tmPlatinum.promoAmount || 0;
                    dataRow.getCell(col++).value = tmPlatinum.officialAmount || 0;
                    dataRow.getCell(col++).value = (tmPlatinum.officialAmount || 0) - (tmPlatinum.promoAmount || 0);
                    dataRow.getCell(col++).value = tmTotal.profit || 0;
                        
                        grandTotal += tmTotal.profit || 0;
                        grandTotalBronzeCount += tmBronze.count || 0;
                        grandTotalSilverCount += tmSilver.count || 0;
                        grandTotalGoldCount += tmGold.count || 0;
                        grandTotalPlatinumCount += tmPlatinum.count || 0;
                    }
                    
                    const isEven = index % 2 === 0;
                    const bgColor = isEven ? 'FFFFFFFF' : 'FFF8F9FA';
                    for (let c = 1; c <= headers.length; c++) {
                        const cell = dataRow.getCell(c);
                        cell.fill = {
                            type: 'pattern',
                            pattern: 'solid',
                            fgColor: { argb: bgColor }
                        };
                        cell.font = { size: 12 };
                        cell.alignment = { horizontal: 'center', vertical: 'middle' };
                        cell.border = {
                            top: { style: 'thin', color: { argb: 'FFDDDDDD' } },
                            bottom: { style: 'thin', color: { argb: 'FFDDDDDD' } },
                            left: { style: 'thin', color: { argb: 'FFDDDDDD' } },
                            right: { style: 'thin', color: { argb: 'FFDDDDDD' } }
                        };
                        if (c > 1 && cell.value !== null && typeof cell.value === 'number') {
                            cell.numFmt = '#,##0';
                        }
                    }
                    dataRow.height = 25;
                });
                
                currentRow++;
                const totalRow = worksheet.getRow(currentRow);
                totalRow.getCell(1).value = 'ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÉŸÑŸä';
                    totalRow.getCell(1).font = { bold: true, size: 14, color: { argb: 'FF801C32' } };
                
                if (analyzedOfferType === 'basic') {
                    totalRow.getCell(2).value = '';
                    totalRow.getCell(3).value = grandTotalBronzeCount;
                    totalRow.getCell(4).value = grandTotalBronzeAmount;
                    totalRow.getCell(5).value = grandTotalSilverCount;
                    totalRow.getCell(6).value = grandTotalSilverAmount;
                    totalRow.getCell(7).value = grandTotalGoldCount;
                    totalRow.getCell(8).value = grandTotalGoldAmount;
                    totalRow.getCell(9).value = grandTotalPlatinumCount;
                    totalRow.getCell(10).value = grandTotalPlatinumAmount;
                    totalRow.getCell(11).value = grandTotal;
                } else if (analyzedOfferType === 'advanced' || analyzedOfferType === 'twoMonths') {
                    totalRow.getCell(2).value = '';
                    totalRow.getCell(3).value = grandTotalBronzeCount;
                    totalRow.getCell(4).value = 0; 
                    totalRow.getCell(5).value = 0; 
                    totalRow.getCell(6).value = 0; 
                    totalRow.getCell(7).value = grandTotalSilverCount;
                    totalRow.getCell(8).value = 0;
                    totalRow.getCell(9).value = 0;
                    totalRow.getCell(10).value = 0;
                    totalRow.getCell(11).value = grandTotalGoldCount;
                    totalRow.getCell(12).value = 0;
                    totalRow.getCell(13).value = 0;
                    totalRow.getCell(14).value = 0;
                    totalRow.getCell(15).value = grandTotalPlatinumCount;
                    totalRow.getCell(16).value = 0;
                    totalRow.getCell(17).value = 0;
                    totalRow.getCell(18).value = 0;
                    totalRow.getCell(19).value = grandTotal;
                }
                
                for (let c = 1; c <= headers.length; c++) {
                    const cell = totalRow.getCell(c);
                    cell.fill = {
                        type: 'pattern',
                        pattern: 'solid',
                        fgColor: { argb: 'FFE8F0F5' }
                    };
                    cell.font = { bold: true, size: 12, color: { argb: 'FF801C32' } };
                    cell.alignment = { horizontal: 'center', vertical: 'middle' };
                    cell.border = {
                        top: { style: 'medium', color: { argb: 'FF801C32' } },
                        bottom: { style: 'medium', color: { argb: 'FF801C32' } },
                        left: { style: 'thin', color: { argb: 'FF801C32' } },
                        right: { style: 'thin', color: { argb: 'FF801C32' } }
                    };
                    if (c > 1 && cell.value !== null && typeof cell.value === 'number') {
                        cell.numFmt = '#,##0';
                    }
                }
                totalRow.height = 30;
                
                worksheet.columns.forEach((column, index) => {
                    if (index === 0) {
                        column.width = 25;
                    } else {
                        column.width = 12;
                    }
                });
                
                workbook.xlsx.writeBuffer().then(buffer => {
                    const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    const offerName = analyzedOfferType === 'basic' ? 'ÿßŸÑÿπÿ±ÿ∂_ÿßŸÑŸÖÿ¨ÿßŸÜŸä' : 
                                     analyzedOfferType === 'advanced' ? 'ŸÖÿÆŸÅÿ∂_3_ÿ£ÿ¥Ÿáÿ±' : 'ŸÖÿÆŸÅÿ∂_ÿ¥Ÿáÿ±ŸäŸÜ';
                    link.download = `ÿ™ŸÇÿ±Ÿäÿ±_${offerName}_${formatDateForFilename(new Date())}.xlsx`;
                    link.click();
                    URL.revokeObjectURL(url);
                    const offerNameAr = analyzedOfferType === 'basic' ? 'ÿßŸÑÿπÿ±ÿ∂ ÿßŸÑŸÖÿ¨ÿßŸÜŸä' : 
                                       analyzedOfferType === 'advanced' ? 'ŸÖÿÆŸÅÿ∂ 3 ÿ£ÿ¥Ÿáÿ±' : 'ŸÖÿÆŸÅÿ∂ ÿ¥Ÿáÿ±ŸäŸÜ';
                    showSuccessMessage(`ÿ™ŸÖ ÿ™ÿµÿØŸäÿ± ÿ™ŸÇÿ±Ÿäÿ± ${offerNameAr} ŸÑŸÄ ${sortedAgents.filter(([_, r]) => {
                        if (analyzedOfferType === 'basic') return r.basic?.total?.count > 0;
                        if (analyzedOfferType === 'advanced') return r.advanced?.total?.count > 0;
                        return r.twoMonths?.total?.count > 0;
                    }).length} ŸàŸÉŸäŸÑ ÿ®ŸÜÿ¨ÿßÿ≠!`);
                });
            } catch (error) {
                console.error('Error exporting with ExcelJS, trying XLSX:', error);
                exportSummaryToExcelXLSX(analyzedOfferType);
            }
        }
        
        function exportSummaryToExcelXLSX(analyzedOfferType = null) {
            if (!analyzedOfferType) {
                let hasBasic = false, hasAdvanced = false, hasTwoMonths = false;
                Object.values(agentReports).forEach(report => {
                    if (report.basic && report.basic.total && report.basic.total.count > 0) hasBasic = true;
                    if (report.advanced && report.advanced.total && report.advanced.total.count > 0) hasAdvanced = true;
                    if (report.twoMonths && report.twoMonths.total && report.twoMonths.total.count > 0) hasTwoMonths = true;
                });
                if (hasBasic) analyzedOfferType = 'basic';
                else if (hasAdvanced) analyzedOfferType = 'advanced';
                else if (hasTwoMonths) analyzedOfferType = 'twoMonths';
                else {
                    alert('ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™ ŸÖÿ≠ŸÑŸÑÿ© ŸÑŸÑÿ™ÿµÿØŸäÿ±.');
                    return;
                }
            }
            
            try {
                const wb = XLSX.utils.book_new();
                const agentData = [];
                const sortedAgents = Object.entries(agentReports).sort((a, b) => {
                    let totalA = 0, totalB = 0;
                    if (analyzedOfferType === 'basic') {
                        totalA = (a[1].basic?.total?.amount || 0);
                        totalB = (b[1].basic?.total?.amount || 0);
                    } else if (analyzedOfferType === 'advanced') {
                        totalA = (a[1].advanced?.total?.profit || 0);
                        totalB = (b[1].advanced?.total?.profit || 0);
                    } else if (analyzedOfferType === 'twoMonths') {
                        totalA = (a[1].twoMonths?.total?.profit || 0);
                        totalB = (b[1].twoMonths?.total?.profit || 0);
                    }
                    return totalB - totalA;
                });
                
                sortedAgents.forEach(([agentName, report]) => {
                    const agent = agentsList.find(a => a.name === agentName);
                    const agentSubName = agent?.subName || '';
                    const agentPercentage = agent?.percentage || 0;
                    
                    let rowData = { 
                        'ÿßÿ≥ŸÖ ÿßŸÑŸàŸÉŸäŸÑ': agentSubName ? `${agentName}\n${agentSubName}` : agentName,
                        'ŸÜÿ≥ÿ®ÿ© ÿßŸÑŸàŸÉŸäŸÑ': agentPercentage
                    };
                    
                    if (analyzedOfferType === 'basic') {
                    const basic = report.basic || {};
                        rowData['ÿ®ÿ±ŸàŸÜÿ≤ (ÿπÿØÿØ)'] = basic.bronze?.count || 0;
                        rowData['ÿ®ÿ±ŸàŸÜÿ≤ (ŸÖÿ®ŸÑÿ∫)'] = basic.bronze?.amount || 0;
                        rowData['ÿ≥ŸÑŸÅÿ± (ÿπÿØÿØ)'] = basic.silver?.count || 0;
                        rowData['ÿ≥ŸÑŸÅÿ± (ŸÖÿ®ŸÑÿ∫)'] = basic.silver?.amount || 0;
                        rowData['ÿ∞Ÿáÿ®Ÿä (ÿπÿØÿØ)'] = basic.gold?.count || 0;
                        rowData['ÿ∞Ÿáÿ®Ÿä (ŸÖÿ®ŸÑÿ∫)'] = basic.gold?.amount || 0;
                        rowData['ÿ®ŸÑÿßÿ™ŸäŸÜŸäŸàŸÖ (ÿπÿØÿØ)'] = basic.platinum?.count || 0;
                        rowData['ÿ®ŸÑÿßÿ™ŸäŸÜŸäŸàŸÖ (ŸÖÿ®ŸÑÿ∫)'] = basic.platinum?.amount || 0;
                        rowData['ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä'] = basic.total?.amount || 0;
                        if ((basic.total?.count || 0) > 0) agentData.push(rowData);
                    } else if (analyzedOfferType === 'advanced') {
                    const advanced = report.advanced || {};
                        rowData['ÿ®ÿ±ŸàŸÜÿ≤ (ÿπÿØÿØ)'] = advanced.bronze?.count || 0;
                        rowData['ÿ®ÿ±ŸàŸÜÿ≤ (ÿπÿ±ÿ∂)'] = advanced.bronze?.promoAmount || 0;
                        rowData['ÿ®ÿ±ŸàŸÜÿ≤ (ÿ±ÿ≥ŸÖŸä)'] = advanced.bronze?.officialAmount || 0;
                        rowData['ÿ®ÿ±ŸàŸÜÿ≤ (ÿ±ÿßÿ¨ÿπ)'] = (advanced.bronze?.officialAmount || 0) - (advanced.bronze?.promoAmount || 0);
                        rowData['ÿ≥ŸÑŸÅÿ± (ÿπÿØÿØ)'] = advanced.silver?.count || 0;
                        rowData['ÿ≥ŸÑŸÅÿ± (ÿπÿ±ÿ∂)'] = advanced.silver?.promoAmount || 0;
                        rowData['ÿ≥ŸÑŸÅÿ± (ÿ±ÿ≥ŸÖŸä)'] = advanced.silver?.officialAmount || 0;
                        rowData['ÿ≥ŸÑŸÅÿ± (ÿ±ÿßÿ¨ÿπ)'] = (advanced.silver?.officialAmount || 0) - (advanced.silver?.promoAmount || 0);
                        rowData['ÿ∞Ÿáÿ®Ÿä (ÿπÿØÿØ)'] = advanced.gold?.count || 0;
                        rowData['ÿ∞Ÿáÿ®Ÿä (ÿπÿ±ÿ∂)'] = advanced.gold?.promoAmount || 0;
                        rowData['ÿ∞Ÿáÿ®Ÿä (ÿ±ÿ≥ŸÖŸä)'] = advanced.gold?.officialAmount || 0;
                        rowData['ÿ∞Ÿáÿ®Ÿä (ÿ±ÿßÿ¨ÿπ)'] = (advanced.gold?.officialAmount || 0) - (advanced.gold?.promoAmount || 0);
                        rowData['ÿ®ŸÑÿßÿ™ŸäŸÜŸäŸàŸÖ (ÿπÿØÿØ)'] = advanced.platinum?.count || 0;
                        rowData['ÿ®ŸÑÿßÿ™ŸäŸÜŸäŸàŸÖ (ÿπÿ±ÿ∂)'] = advanced.platinum?.promoAmount || 0;
                        rowData['ÿ®ŸÑÿßÿ™ŸäŸÜŸäŸàŸÖ (ÿ±ÿ≥ŸÖŸä)'] = advanced.platinum?.officialAmount || 0;
                        rowData['ÿ®ŸÑÿßÿ™ŸäŸÜŸäŸàŸÖ (ÿ±ÿßÿ¨ÿπ)'] = (advanced.platinum?.officialAmount || 0) - (advanced.platinum?.promoAmount || 0);
                        rowData['ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä (ÿßŸÑÿ±ÿßÿ¨ÿπ)'] = advanced.total?.profit || 0;
                        if ((advanced.total?.count || 0) > 0) agentData.push(rowData);
                    } else if (analyzedOfferType === 'twoMonths') {
                    const twoMonths = report.twoMonths || {};
                        rowData['ÿ®ÿ±ŸàŸÜÿ≤ (ÿπÿØÿØ)'] = twoMonths.bronze?.count || 0;
                        rowData['ÿ®ÿ±ŸàŸÜÿ≤ (ÿπÿ±ÿ∂)'] = twoMonths.bronze?.promoAmount || 0;
                        rowData['ÿ®ÿ±ŸàŸÜÿ≤ (ÿ±ÿ≥ŸÖŸä)'] = twoMonths.bronze?.officialAmount || 0;
                        rowData['ÿ®ÿ±ŸàŸÜÿ≤ (ÿ±ÿßÿ¨ÿπ)'] = (twoMonths.bronze?.officialAmount || 0) - (twoMonths.bronze?.promoAmount || 0);
                        rowData['ÿ≥ŸÑŸÅÿ± (ÿπÿØÿØ)'] = twoMonths.silver?.count || 0;
                        rowData['ÿ≥ŸÑŸÅÿ± (ÿπÿ±ÿ∂)'] = twoMonths.silver?.promoAmount || 0;
                        rowData['ÿ≥ŸÑŸÅÿ± (ÿ±ÿ≥ŸÖŸä)'] = twoMonths.silver?.officialAmount || 0;
                        rowData['ÿ≥ŸÑŸÅÿ± (ÿ±ÿßÿ¨ÿπ)'] = (twoMonths.silver?.officialAmount || 0) - (twoMonths.silver?.promoAmount || 0);
                        rowData['ÿ∞Ÿáÿ®Ÿä (ÿπÿØÿØ)'] = twoMonths.gold?.count || 0;
                        rowData['ÿ∞Ÿáÿ®Ÿä (ÿπÿ±ÿ∂)'] = twoMonths.gold?.promoAmount || 0;
                        rowData['ÿ∞Ÿáÿ®Ÿä (ÿ±ÿ≥ŸÖŸä)'] = twoMonths.gold?.officialAmount || 0;
                        rowData['ÿ∞Ÿáÿ®Ÿä (ÿ±ÿßÿ¨ÿπ)'] = (twoMonths.gold?.officialAmount || 0) - (twoMonths.gold?.promoAmount || 0);
                        rowData['ÿ®ŸÑÿßÿ™ŸäŸÜŸäŸàŸÖ (ÿπÿØÿØ)'] = twoMonths.platinum?.count || 0;
                        rowData['ÿ®ŸÑÿßÿ™ŸäŸÜŸäŸàŸÖ (ÿπÿ±ÿ∂)'] = twoMonths.platinum?.promoAmount || 0;
                        rowData['ÿ®ŸÑÿßÿ™ŸäŸÜŸäŸàŸÖ (ÿ±ÿ≥ŸÖŸä)'] = twoMonths.platinum?.officialAmount || 0;
                        rowData['ÿ®ŸÑÿßÿ™ŸäŸÜŸäŸàŸÖ (ÿ±ÿßÿ¨ÿπ)'] = (twoMonths.platinum?.officialAmount || 0) - (twoMonths.platinum?.promoAmount || 0);
                        rowData['ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä (ÿßŸÑÿ±ÿßÿ¨ÿπ)'] = twoMonths.total?.profit || 0;
                        if ((twoMonths.total?.count || 0) > 0) agentData.push(rowData);
                    }
                });
                
                if (agentData.length === 0) {
                    alert('ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™ ŸÑŸÑÿ™ÿµÿØŸäÿ±.');
                    return;
                }
                
                let monthYear = null;
                if (analyzedOfferType === 'basic') {
                    monthYear = extractMonthYearFromDetails(basicDetails) || extractMonthYearFromData(basicData);
                } else if (analyzedOfferType === 'advanced') {
                    monthYear = extractMonthYearFromDetails(advancedDetails) || extractMonthYearFromData(advancedData);
                } else if (analyzedOfferType === 'twoMonths') {
                    monthYear = extractMonthYearFromDetails(twoMonthsDetails) || extractMonthYearFromData(twoMonthsData);
                }
                
                let monthInfo = '';
                if (monthYear) {
                    const [year, month] = monthYear.split('-');
                    const monthIndex = parseInt(month) - 1;
                    if (monthIndex >= 0 && monthIndex < arabicMonths.length) {
                        monthInfo = `ŸÑÿ¥Ÿáÿ±  : ${arabicMonths[monthIndex]} ${year}`;
                    }
                }
                
                const wsData = [];
                const reportTitle = analyzedOfferType === 'basic' ? 'ÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑÿπÿ±ÿ∂ ÿßŸÑŸÖÿ¨ÿßŸÜŸä' :
                                   analyzedOfferType === 'advanced' ? 'ÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑÿπÿ±ÿ∂ ÿßŸÑŸÖÿÆŸÅÿ∂ ŸÑÿ´ŸÑÿßÿ´ÿ© ÿ£ÿ¥Ÿáÿ±' :
                                   'ÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑÿπÿ±ÿ∂ ÿßŸÑŸÖÿÆŸÅÿ∂ ŸÑÿ¥Ÿáÿ±ŸäŸÜ';
                wsData.push([reportTitle]);
                if (monthInfo) {
                    wsData.push([monthInfo]);
                }
                const now = new Date();
                const dateStr = `${now.getDate()}/${now.getMonth() + 1}/${now.getFullYear()} ${now.getHours()}:${String(now.getMinutes()).padStart(2, '0')}`;
                wsData.push([`ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ™ŸÇÿ±Ÿäÿ±: ${dateStr}`]);
                wsData.push([]);
                
                const headers = [];
                if (analyzedOfferType === 'basic') {
                    headers.push('ÿßÿ≥ŸÖ ÿßŸÑŸàŸÉŸäŸÑ', 'ŸÜÿ≥ÿ®ÿ© ÿßŸÑŸàŸÉŸäŸÑ', 'ÿ®ÿ±ŸàŸÜÿ≤ (ÿπÿØÿØ)', 'ÿ®ÿ±ŸàŸÜÿ≤ (ŸÖÿ®ŸÑÿ∫)', 'ÿ≥ŸÑŸÅÿ± (ÿπÿØÿØ)', 'ÿ≥ŸÑŸÅÿ± (ŸÖÿ®ŸÑÿ∫)', 
                                'ÿ∞Ÿáÿ®Ÿä (ÿπÿØÿØ)', 'ÿ∞Ÿáÿ®Ÿä (ŸÖÿ®ŸÑÿ∫)', 'ÿ®ŸÑÿßÿ™ŸäŸÜŸäŸàŸÖ (ÿπÿØÿØ)', 'ÿ®ŸÑÿßÿ™ŸäŸÜŸäŸàŸÖ (ŸÖÿ®ŸÑÿ∫)', 'ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä');
                } else {
                    headers.push('ÿßÿ≥ŸÖ ÿßŸÑŸàŸÉŸäŸÑ', 'ŸÜÿ≥ÿ®ÿ© ÿßŸÑŸàŸÉŸäŸÑ', 'ÿ®ÿ±ŸàŸÜÿ≤ (ÿπÿØÿØ)', 'ÿ®ÿ±ŸàŸÜÿ≤ (ÿπÿ±ÿ∂)', 'ÿ®ÿ±ŸàŸÜÿ≤ (ÿ±ÿ≥ŸÖŸä)', 'ÿ®ÿ±ŸàŸÜÿ≤ (ÿ±ÿßÿ¨ÿπ)',
                                'ÿ≥ŸÑŸÅÿ± (ÿπÿØÿØ)', 'ÿ≥ŸÑŸÅÿ± (ÿπÿ±ÿ∂)', 'ÿ≥ŸÑŸÅÿ± (ÿ±ÿ≥ŸÖŸä)', 'ÿ≥ŸÑŸÅÿ± (ÿ±ÿßÿ¨ÿπ)',
                                'ÿ∞Ÿáÿ®Ÿä (ÿπÿØÿØ)', 'ÿ∞Ÿáÿ®Ÿä (ÿπÿ±ÿ∂)', 'ÿ∞Ÿáÿ®Ÿä (ÿ±ÿ≥ŸÖŸä)', 'ÿ∞Ÿáÿ®Ÿä (ÿ±ÿßÿ¨ÿπ)',
                                'ÿ®ŸÑÿßÿ™ŸäŸÜŸäŸàŸÖ (ÿπÿØÿØ)', 'ÿ®ŸÑÿßÿ™ŸäŸÜŸäŸàŸÖ (ÿπÿ±ÿ∂)', 'ÿ®ŸÑÿßÿ™ŸäŸÜŸäŸàŸÖ (ÿ±ÿ≥ŸÖŸä)', 'ÿ®ŸÑÿßÿ™ŸäŸÜŸäŸàŸÖ (ÿ±ÿßÿ¨ÿπ)', 'ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä (ÿßŸÑÿ±ÿßÿ¨ÿπ)');
                }
                wsData.push(headers);
                
                agentData.forEach(row => {
                    const rowData = [];
                    headers.forEach(header => {
                        rowData.push(row[header] || '');
                    });
                    wsData.push(rowData);
                });
                
                const ws = XLSX.utils.aoa_to_sheet(wsData);
                const colWidths = [{ wch: 30 }, { wch: 12 }];
                if (analyzedOfferType === 'basic') {
                    for (let i = 0; i < 9; i++) colWidths.push({ wch: 15 });
                } else {
                    for (let i = 0; i < 17; i++) colWidths.push({ wch: 15 });
                }
                ws['!cols'] = colWidths;
                const sheetName = analyzedOfferType === 'basic' ? 'ÿßŸÑÿπÿ±ÿ∂ ÿßŸÑŸÖÿ¨ÿßŸÜŸä' : 
                                 analyzedOfferType === 'advanced' ? 'ŸÖÿÆŸÅÿ∂ 3 ÿ£ÿ¥Ÿáÿ±' : 'ŸÖÿÆŸÅÿ∂ ÿ¥Ÿáÿ±ŸäŸÜ';
                XLSX.utils.book_append_sheet(wb, ws, sheetName);
                const offerName = analyzedOfferType === 'basic' ? 'ÿßŸÑÿπÿ±ÿ∂_ÿßŸÑŸÖÿ¨ÿßŸÜŸä' : 
                                 analyzedOfferType === 'advanced' ? 'ŸÖÿÆŸÅÿ∂_3_ÿ£ÿ¥Ÿáÿ±' : 'ŸÖÿÆŸÅÿ∂_ÿ¥Ÿáÿ±ŸäŸÜ';
                const filename = `ÿ™ŸÇÿ±Ÿäÿ±_${offerName}_${formatDateForFilename(new Date())}.xlsx`;
                XLSX.writeFile(wb, filename);
                const offerNameAr = analyzedOfferType === 'basic' ? 'ÿßŸÑÿπÿ±ÿ∂ ÿßŸÑŸÖÿ¨ÿßŸÜŸä' : 
                                   analyzedOfferType === 'advanced' ? 'ŸÖÿÆŸÅÿ∂ 3 ÿ£ÿ¥Ÿáÿ±' : 'ŸÖÿÆŸÅÿ∂ ÿ¥Ÿáÿ±ŸäŸÜ';
                showSuccessMessage(`ÿ™ŸÖ ÿ™ÿµÿØŸäÿ± ÿ™ŸÇÿ±Ÿäÿ± ${offerNameAr} ŸÑŸÄ ${agentData.length} ŸàŸÉŸäŸÑ ÿ®ŸÜÿ¨ÿßÿ≠!`);
            } catch (error) {
                alert('ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿßŸÑÿ™ÿµÿØŸäÿ±: ' + error.message);
                console.error('Export error:', error);
            }
        }
        function printSummaryReport() {
            if (!agentReports || Object.keys(agentReports).length === 0) {
                alert('ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™ ŸÑŸÑÿ∑ÿ®ÿßÿπÿ©. Ÿäÿ±ÿ¨Ÿâ ÿ™ÿ≠ŸÑŸäŸÑ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸàŸÉŸÑÿßÿ° ÿ£ŸàŸÑÿßŸã.');
                return;
            }
            updateAgentSummary();
            window.print();
        }
        async function clearAgentReports(agentName) {
            if (!confirm(`ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ≠ÿ∞ŸÅ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ™ÿ≠ŸÑŸäŸÑÿßÿ™ ŸàÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÑŸÑŸàŸÉŸäŸÑ "${agentName}"ÿü\n\nÿ≥Ÿäÿ™ŸÖ ÿ≠ÿ∞ŸÅ:\n- ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑÿπÿ±ÿ∂ ÿßŸÑŸÖÿ¨ÿßŸÜŸä\n- ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑÿπÿ±ÿ∂ ÿßŸÑŸÖÿÆŸÅÿ∂ 3 ÿ£ÿ¥Ÿáÿ±\n- ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑÿπÿ±ÿ∂ ÿßŸÑŸÖÿÆŸÅÿ∂ ÿ¥Ÿáÿ±ŸäŸÜ\n- ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÜÿ≥ÿ®ÿ© ÿßŸÑŸÖÿ≠ŸÅŸàÿ∏ÿ©\n\nŸäŸÖŸÉŸÜŸÉ ÿ•ÿ¨ÿ±ÿßÿ° ÿ™ÿ≠ŸÑŸäŸÑÿßÿ™ ÿ¨ÿØŸäÿØÿ© ÿ®ÿπÿØ ÿßŸÑÿ≠ÿ∞ŸÅ.`)) {
                return;
            }
            if (agentReports[agentName]) {
                delete agentReports[agentName];
            }
            if (agentPercentages[agentName]) {
                delete agentPercentages[agentName];
                localStorage.setItem('agentPercentages', JSON.stringify(agentPercentages));
                if (supabaseClient) {
                    try {
                        const monthYear = localStorage.getItem('agentPercentages_monthYear') || getCurrentMonthYear();
                        await saveToDatabase('agent_percentages', agentPercentages, { monthYear: monthYear });
                    } catch (error) {
                        console.error('Error deleting agent percentage:', error);
                    }
                }
            }
            if (supabaseClient) {
                try {
                    const monthYear = getCurrentMonthYear();
                    const { data: basicArchive } = await supabaseClient
                        .from('analysis_archives')
                        .select('data')
                        .eq('month_year', monthYear)
                        .eq('analysis_type', 'basic')
                        .maybeSingle();
                    if (basicArchive && basicArchive.data && basicArchive.data.agentReports) {
                        delete basicArchive.data.agentReports[agentName];
                        await saveToDatabase('analysis_archives', basicArchive.data, { analysis_type: 'basic', monthYear: monthYear });
                    }
                    const { data: advancedArchive } = await supabaseClient
                        .from('analysis_archives')
                        .select('data')
                        .eq('month_year', monthYear)
                        .eq('analysis_type', 'advanced')
                        .maybeSingle();
                    if (advancedArchive && advancedArchive.data && advancedArchive.data.agentReports) {
                        delete advancedArchive.data.agentReports[agentName];
                        await saveToDatabase('analysis_archives', advancedArchive.data, { analysis_type: 'advanced', monthYear: monthYear });
                    }
                    const { data: twoMonthsArchive } = await supabaseClient
                        .from('analysis_archives')
                        .select('data')
                        .eq('month_year', monthYear)
                        .eq('analysis_type', 'two_months')
                        .maybeSingle();
                    if (twoMonthsArchive && twoMonthsArchive.data && twoMonthsArchive.data.agentReports) {
                        delete twoMonthsArchive.data.agentReports[agentName];
                        await saveToDatabase('analysis_archives', twoMonthsArchive.data, { analysis_type: 'two_months', monthYear: monthYear });
                    }
                } catch (error) {
                    console.error('Error clearing reports from database:', error);
                }
            }
            refreshAgentsList();
            updateAgentSummary();
            renderPercentageTable();
            showSuccessMessage(`ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ™ÿ≠ŸÑŸäŸÑÿßÿ™ Ÿàÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÜÿ≥ÿ®ÿ© ŸÑŸÑŸàŸÉŸäŸÑ "${agentName}" ÿ®ŸÜÿ¨ÿßÿ≠`);
            logActivity('ÿ≠ÿ∞ŸÅ ÿ™ÿ≠ŸÑŸäŸÑÿßÿ™ ŸàŸÉŸäŸÑ', `ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ™ÿ≠ŸÑŸäŸÑÿßÿ™ Ÿàÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÜÿ≥ÿ®ÿ© ŸÑŸÑŸàŸÉŸäŸÑ: ${agentName}`);
        }
        async function clearAllAgentReports() {
            if (!confirm('ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ≠ÿ∞ŸÅ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ™ÿ≠ŸÑŸäŸÑÿßÿ™ ŸÖŸÜ ÿ™ÿ®ŸàŸäÿ®ÿßÿ™ ÿßŸÑÿπÿ±Ÿàÿ∂ ŸàÿßŸÑŸÖŸÑÿÆÿµÿü\n\nÿ≥Ÿäÿ™ŸÖ ÿ≠ÿ∞ŸÅ:\n- ÿ¨ŸÖŸäÿπ ÿ™ÿ≠ŸÑŸäŸÑÿßÿ™ ÿßŸÑÿπÿ±ÿ∂ ÿßŸÑŸÖÿ¨ÿßŸÜŸä\n- ÿ¨ŸÖŸäÿπ ÿ™ÿ≠ŸÑŸäŸÑÿßÿ™ ÿßŸÑÿπÿ±ÿ∂ ÿßŸÑŸÖÿÆŸÅÿ∂ 3 ÿ£ÿ¥Ÿáÿ±\n- ÿ¨ŸÖŸäÿπ ÿ™ÿ≠ŸÑŸäŸÑÿßÿ™ ÿßŸÑÿπÿ±ÿ∂ ÿßŸÑŸÖÿÆŸÅÿ∂ ÿ¥Ÿáÿ±ŸäŸÜ\n- ÿ¨ŸÖŸäÿπ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÜÿ≥ÿ®\n\nŸäŸÖŸÉŸÜŸÉ ÿ•ÿ¨ÿ±ÿßÿ° ÿ™ÿ≠ŸÑŸäŸÑÿßÿ™ ÿ¨ÿØŸäÿØÿ© ÿ®ÿπÿØ ÿßŸÑÿ≠ÿ∞ŸÅ.')) {
                return;
            }
            
            agentReports = {};
            basicData = null;
            advancedData = null;
            twoMonthsData = null;
            basicDetails = [];
            advancedDetails = [];
            twoMonthsDetails = [];
            agentPercentages = {};
            
            document.getElementById('basicResults')?.classList.add('hidden');
            document.getElementById('advancedResults')?.classList.add('hidden');
            document.getElementById('twoMonthsResults')?.classList.add('hidden');
            document.getElementById('percentageResults')?.classList.add('hidden');
            
            localStorage.removeItem('basicData');
            localStorage.removeItem('advancedData');
            localStorage.removeItem('twoMonthsData');
            localStorage.removeItem('basicDetails');
            localStorage.removeItem('advancedDetails');
            localStorage.removeItem('twoMonthsDetails');
            localStorage.removeItem('basicResults');
            localStorage.removeItem('advancedResults');
            localStorage.removeItem('twoMonthsResults');
            localStorage.removeItem('agentReports');
            localStorage.removeItem('agentPercentages');
            localStorage.removeItem('agentPercentages_monthYear');
            
            document.getElementById('basicFileInput').value = '';
            document.getElementById('advancedFileInput').value = '';
            document.getElementById('twoMonthsFileInput').value = '';
            document.getElementById('percentageFileInput').value = '';
            
            if (supabaseClient) {
                try {
                    const monthYear = getCurrentMonthYear();
                    await Promise.all([
                        supabaseClient.from('agent_percentages').delete().eq('month_year', monthYear),
                        supabaseClient.from('analysis_archives').delete().eq('month_year', monthYear)
                    ]);
                    showSuccessMessage('ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ™ÿ≠ŸÑŸäŸÑÿßÿ™ ÿ®ŸÜÿ¨ÿßÿ≠');
                    logActivity('ÿ≠ÿ∞ŸÅ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ™ÿ≠ŸÑŸäŸÑÿßÿ™', 'ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ™ÿ≠ŸÑŸäŸÑÿßÿ™');
                } catch (error) {
                    console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ≠ÿ∞ŸÅ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖŸÜ ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™:', error);
                    showSuccessMessage('ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ™ÿ≠ŸÑŸäŸÑÿßÿ™. ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ÿ≠ÿ∞ŸÅ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖŸÜ ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™');
                }
            } else {
                showSuccessMessage('ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ™ÿ≠ŸÑŸäŸÑÿßÿ™ ÿ®ŸÜÿ¨ÿßÿ≠');
                logActivity('ÿ≠ÿ∞ŸÅ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ™ÿ≠ŸÑŸäŸÑÿßÿ™', 'ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ™ÿ≠ŸÑŸäŸÑÿßÿ™');
            }
            
            refreshAgentsList();
            updateAgentSummary();
            renderPercentageTable();
        }
        
        async function deleteAgentFromArchive(agentName, monthYear) {
            if (currentUserRole !== 'admin') {
                alert('ŸÑŸäÿ≥ ŸÑÿØŸäŸÉ ÿµŸÑÿßÿ≠Ÿäÿ© ŸÑÿ≠ÿ∞ŸÅ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖŸÜ ÿßŸÑÿ£ÿ±ÿ¥ŸäŸÅ. Ÿáÿ∞Ÿá ÿßŸÑŸàÿ∏ŸäŸÅÿ© ŸÖÿ™ÿßÿ≠ÿ© ŸÑŸÑŸÖÿØŸäÿ± ŸÅŸÇÿ∑.');
                return;
            }
            
            if (!confirm(`‚ö†Ô∏è ÿ™ÿ≠ÿ∞Ÿäÿ±: ÿ≥Ÿäÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿ¨ŸÖŸäÿπ ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑŸàŸÉŸäŸÑ "${agentName}" ŸÖŸÜ ÿßŸÑÿ£ÿ±ÿ¥ŸäŸÅ ŸÑŸÑÿ¥Ÿáÿ± ${monthYear}!\n\nÿ≥Ÿäÿ™ŸÖ ÿ≠ÿ∞ŸÅ:\n- ÿ¨ŸÖŸäÿπ ÿ™ÿ≠ŸÑŸäŸÑÿßÿ™ ÿßŸÑÿπÿ±ÿ∂ ÿßŸÑŸÖÿ¨ÿßŸÜŸä\n- ÿ¨ŸÖŸäÿπ ÿ™ÿ≠ŸÑŸäŸÑÿßÿ™ ÿßŸÑÿπÿ±ÿ∂ ÿßŸÑŸÖÿÆŸÅÿ∂ 3 ÿ£ÿ¥Ÿáÿ±\n- ÿ¨ŸÖŸäÿπ ÿ™ÿ≠ŸÑŸäŸÑÿßÿ™ ÿßŸÑÿπÿ±ÿ∂ ÿßŸÑŸÖÿÆŸÅÿ∂ ÿ¥Ÿáÿ±ŸäŸÜ\n- ÿ¨ŸÖŸäÿπ ÿßŸÑÿ™ŸÅÿßÿµŸäŸÑ ŸàÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≠ŸÅŸàÿ∏ÿ©\n\nŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿßŸÑŸÖÿ™ÿßÿ®ÿπÿ©ÿü`)) {
                return;
            }
            
            try {
                if (!supabaseClient) {
                    alert('ÿÆÿ∑ÿ£: ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ∫Ÿäÿ± ŸÖÿ™ÿµŸÑÿ©');
                    return;
                }
                
                const analysisTypes = ['basic', 'advanced', 'two_months'];
                for (const analysisType of analysisTypes) {
                    try {
                        const { data: archive } = await supabaseClient
                            .from('analysis_archives')
                            .select('data')
                            .eq('month_year', monthYear)
                            .eq('analysis_type', analysisType)
                            .maybeSingle();
                        
                        if (archive && archive.data) {
                            if (archive.data.agentReports && archive.data.agentReports[agentName]) {
                                delete archive.data.agentReports[agentName];
                            }
                            
                            if (Array.isArray(archive.data.details)) {
                                archive.data.details = archive.data.details.filter(detail => {
                                    const detailAgent = detail.agent || detail.Agent || detail.agentName || detail.AgentName || detail['ÿßÿ≥ŸÖ ÿßŸÑŸàŸÉŸäŸÑ'] || detail['ÿßŸÑŸàŸÉŸäŸÑ'];
                                    return normalizeAgentName(detailAgent) !== normalizeAgentName(agentName);
                                });
                            }
                            
                            if (Array.isArray(archive.data.data)) {
                                archive.data.data = archive.data.data.filter(item => {
                                    const itemAgent = item.agent || item.Agent || item.agentName || item.AgentName || item['ÿßÿ≥ŸÖ ÿßŸÑŸàŸÉŸäŸÑ'] || item['ÿßŸÑŸàŸÉŸäŸÑ'];
                                    return normalizeAgentName(itemAgent) !== normalizeAgentName(agentName);
                                });
                            }
                            
                            if (archive.data.results && archive.data.results.agentName === agentName) {
                                archive.data.results = null;
                            }
                            
                            await saveToDatabase('analysis_archives', archive.data, { analysis_type: analysisType, monthYear: monthYear });
                        }
                    } catch (error) {
                        console.error(`Error deleting ${analysisType} archive:`, error);
                    }
                }
                
                try {
                    const { data: percentagesArchive } = await supabaseClient
                        .from('agent_percentages')
                        .select('data')
                        .eq('month_year', monthYear)
                        .maybeSingle();
                    
                    if (percentagesArchive && percentagesArchive.data && percentagesArchive.data[agentName]) {
                        delete percentagesArchive.data[agentName];
                        await saveToDatabase('agent_percentages', percentagesArchive.data, { monthYear: monthYear });
                    }
                } catch (error) {
                    console.error('Error deleting agent percentage:', error);
                }
                
                showSuccessMessage(`‚úÖ ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿ¨ŸÖŸäÿπ ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑŸàŸÉŸäŸÑ "${agentName}" ŸÖŸÜ ÿßŸÑÿ£ÿ±ÿ¥ŸäŸÅ ÿ®ŸÜÿ¨ÿßÿ≠`);
                logActivity('ÿ≠ÿ∞ŸÅ ÿ™ŸÅÿßÿµŸäŸÑ ŸàŸÉŸäŸÑ ŸÖŸÜ ÿßŸÑÿ£ÿ±ÿ¥ŸäŸÅ', `ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑŸàŸÉŸäŸÑ "${agentName}" ŸÖŸÜ ÿßŸÑÿ£ÿ±ÿ¥ŸäŸÅ ŸÑŸÑÿ¥Ÿáÿ± ${monthYear}`);
                
                setTimeout(() => {
                    loadArchiveByAgent(monthYear);
                }, 1000);
                
            } catch (error) {
                console.error('Error deleting agent from archive:', error);
                alert('ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿ≠ÿ∞ŸÅ ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑŸàŸÉŸäŸÑ: ' + error.message);
            }
        }
        
        
        let scrollTimeout;
        window.addEventListener('scroll', function() {
            clearTimeout(scrollTimeout);
            scrollTimeout = setTimeout(() => {
                const currentTab = localStorage.getItem('currentTab') || 'basic';
                const currentScroll = window.scrollY || document.documentElement.scrollTop;
                localStorage.setItem(`scrollPosition_${currentTab}`, currentScroll.toString());
            }, 150);
        });
        let activityLog = JSON.parse(localStorage.getItem('activityLog') || '[]');
        function logActivity(action, details) {
            const logEntry = {
                id: Date.now(),
                timestamp: new Date().toISOString(),
                action: action,
                details: details,
                user: loggedInUser || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'
            };
            activityLog.unshift(logEntry);
            if (activityLog.length > 1000) activityLog = activityLog.slice(0, 1000);
            localStorage.setItem('activityLog', JSON.stringify(activityLog));
        }
        function refreshActivityLog() {
            const container = document.getElementById('activityLogContent');
            if (!container) return;
            if (activityLog.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿπŸÖŸÑŸäÿßÿ™ ŸÖÿ≥ÿ¨ŸÑÿ©</p>';
                return;
            }
            let html = '';
            activityLog.forEach(log => {
                const date = new Date(log.timestamp);
                const timeStr = date.toLocaleString('ar-IQ', { 
                    year: 'numeric', month: 'long', day: 'numeric',
                    hour: '2-digit', minute: '2-digit' 
                });
                html += `
                    <div class="activity-item">
                        <span class="activity-icon">${getActivityIcon(log.action)}</span>
                        <div class="activity-details">
                            <strong>${log.action}</strong>
                            <div style="color: #666; font-size: 0.9rem; margin-top: 5px;">${log.details}</div>
                            <div class="activity-time">${timeStr} - ${log.user}</div>
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }
        function getActivityIcon(action) {
            if (action.includes('ÿ™ÿ≠ŸÖŸäŸÑ') || action.includes('ÿ±ŸÅÿπ')) return '[ÿ±ŸÅÿπ]';
            if (action.includes('ÿ™ÿ≠ŸÑŸäŸÑ')) return '[ÿ™ÿ≠ŸÑŸäŸÑ]';
            if (action.includes('ÿ™ÿµÿØŸäÿ±')) return '[ÿ™ÿµÿØŸäÿ±]';
            if (action.includes('ÿ≠ŸÅÿ∏')) return '[ÿ≠ŸÅÿ∏]';
            if (action.includes('ÿ∑ÿ®ÿßÿπÿ©')) return '[ÿ∑ÿ®ÿßÿπÿ©]';
            if (action.includes('ÿ•ÿπÿØÿßÿØÿßÿ™')) return '[ÿ•ÿπÿØÿßÿØÿßÿ™]';
            if (action.includes('ŸÜÿ≥ÿÆ')) return '[ŸÜÿ≥ÿÆ]';
            if (action.includes('ŸÖÿ≥ÿ≠')) return '[ŸÖÿ≥ÿ≠]';
            return '[ÿπŸÖŸÑŸäÿ©]';
        }
        function filterActivityLog() {
            const searchTerm = document.getElementById('activitySearch').value.toLowerCase();
            const container = document.getElementById('activityLogContent');
            const items = container.querySelectorAll('.activity-item');
            items.forEach(item => {
                const text = item.textContent.toLowerCase();
                item.style.display = text.includes(searchTerm) ? 'flex' : 'none';
            });
        }
        function exportActivityLog() {
            if (activityLog.length === 0) {
                alert('ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿπŸÖŸÑŸäÿßÿ™ ŸÑŸÑÿ™ÿµÿØŸäÿ±');
                return;
            }
            const wb = XLSX.utils.book_new();
            const excelData = activityLog.map(log => ({
                'ÿßŸÑÿ™ÿßÿ±ŸäÿÆ ŸàÿßŸÑŸàŸÇÿ™': new Date(log.timestamp).toLocaleString('ar-IQ'),
                'ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°': log.action,
                'ÿßŸÑÿ™ŸÅÿßÿµŸäŸÑ': log.details,
                'ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ': log.user
            }));
            const ws = XLSX.utils.json_to_sheet(excelData);
            XLSX.utils.book_append_sheet(wb, ws, 'ÿ≥ÿ¨ŸÑ ÿßŸÑÿπŸÖŸÑŸäÿßÿ™');
            XLSX.writeFile(wb, `ÿ≥ÿ¨ŸÑ_ÿßŸÑÿπŸÖŸÑŸäÿßÿ™_${formatDateForFilename(new Date())}.xlsx`);
            logActivity('ÿ™ÿµÿØŸäÿ± ÿ≥ÿ¨ŸÑ ÿßŸÑÿπŸÖŸÑŸäÿßÿ™', 'ÿ™ŸÖ ÿ™ÿµÿØŸäÿ± ÿ≥ÿ¨ŸÑ ÿßŸÑÿπŸÖŸÑŸäÿßÿ™ ÿ•ŸÑŸâ Excel');
            showSuccessMessage('ÿ™ŸÖ ÿ™ÿµÿØŸäÿ± ÿ≥ÿ¨ŸÑ ÿßŸÑÿπŸÖŸÑŸäÿßÿ™ ÿ®ŸÜÿ¨ÿßÿ≠!');
        }
        function clearActivityLog() {
            if (confirm('ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ŸÖÿ≥ÿ≠ ÿ¨ŸÖŸäÿπ ÿ≥ÿ¨ŸÑ ÿßŸÑÿπŸÖŸÑŸäÿßÿ™ÿü')) {
                activityLog = [];
                localStorage.removeItem('activityLog');
                refreshActivityLog();
                logActivity('ŸÖÿ≥ÿ≠ ÿ≥ÿ¨ŸÑ ÿßŸÑÿπŸÖŸÑŸäÿßÿ™', 'ÿ™ŸÖ ŸÖÿ≥ÿ≠ ÿ¨ŸÖŸäÿπ ÿ≥ÿ¨ŸÑ ÿßŸÑÿπŸÖŸÑŸäÿßÿ™');
                showSuccessMessage('ÿ™ŸÖ ŸÖÿ≥ÿ≠ ÿ≥ÿ¨ŸÑ ÿßŸÑÿπŸÖŸÑŸäÿßÿ™');
            }
        }
        function loadSettings() {
            const saved = JSON.parse(localStorage.getItem('appSettings') || '{}');
            if (saved.bronze) {
                document.getElementById('priceBronze').value = saved.bronze;
                subscriptionPrices.basic['Iraqcell_Bronze_Profile_NEW'] = saved.bronze;
                subscriptionPrices.basic['Iraqcell_Bronze_Profile'] = saved.bronze;
            }
            if (saved.silver) {
                document.getElementById('priceSilver').value = saved.silver;
                subscriptionPrices.basic['Iraqcell_Silver_Profile_NEW'] = saved.silver;
                subscriptionPrices.basic['Iraqcell_Silver_Profile'] = saved.silver;
            }
            if (saved.gold) {
                document.getElementById('priceGold').value = saved.gold;
                subscriptionPrices.basic['Iraqcell_Gold_Profile_NEW'] = saved.gold;
                subscriptionPrices.basic['Iraqcell_Gold_Profile'] = saved.gold;
            }
            if (saved.platinum) {
                document.getElementById('pricePlatinum').value = saved.platinum;
                subscriptionPrices.basic['Iraqcell_Platinum_Profile_NEW'] = saved.platinum;
                subscriptionPrices.basic['Iraqcell_Platinum_Profile'] = saved.platinum;
            }
            if (saved.notifications !== undefined) document.getElementById('enableNotifications').checked = saved.notifications;
        }
        function savePriceSettings() {
            const bronze = parseFloat(document.getElementById('priceBronze').value);
            const silver = parseFloat(document.getElementById('priceSilver').value);
            const gold = parseFloat(document.getElementById('priceGold').value);
            const platinum = parseFloat(document.getElementById('pricePlatinum').value);
            subscriptionPrices.basic['Iraqcell_Bronze_Profile_NEW'] = bronze;
            subscriptionPrices.basic['Iraqcell_Bronze_Profile'] = bronze;
            subscriptionPrices.basic['Iraqcell_Silver_Profile_NEW'] = silver;
            subscriptionPrices.basic['Iraqcell_Silver_Profile'] = silver;
            subscriptionPrices.basic['Iraqcell_Gold_Profile_NEW'] = gold;
            subscriptionPrices.basic['Iraqcell_Gold_Profile'] = gold;
            subscriptionPrices.basic['Iraqcell_Platinum_Profile_NEW'] = platinum;
            subscriptionPrices.basic['Iraqcell_Platinum_Profile'] = platinum;
            const settings = {
                bronze, silver, gold, platinum,
                notifications: document.getElementById('enableNotifications').checked
            };
            localStorage.setItem('appSettings', JSON.stringify(settings));
            logActivity('ÿ≠ŸÅÿ∏ ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™', `ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿ£ÿ≥ÿπÿßÿ±: Bronze=${bronze}, Silver=${silver}, Gold=${gold}, Platinum=${platinum}`);
            showSuccessMessage('ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™ ÿ®ŸÜÿ¨ÿßÿ≠! ÿ≥Ÿäÿ™ŸÖ ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑÿ£ÿ≥ÿπÿßÿ± ÿßŸÑÿ¨ÿØŸäÿØÿ© ÿπŸÜÿØ ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ¨ÿØŸäÿØÿ©.');
        }
        function saveDefaultPercentage() {
            const defaultPercentage = parseFloat(document.getElementById('defaultAgentPercentage').value);
            if (defaultPercentage < 0 || defaultPercentage > 100) {
                alert('ÿßŸÑŸÜÿ≥ÿ®ÿ© ÿßŸÑŸÖÿ¶ŸàŸäÿ© Ÿäÿ¨ÿ® ÿ£ŸÜ ÿ™ŸÉŸàŸÜ ÿ®ŸäŸÜ 0 Ÿà 100');
                const saved = parseFloat(localStorage.getItem('defaultAgentPercentage')) || 16;
                document.getElementById('defaultAgentPercentage').value = saved;
                return;
            }
            localStorage.setItem('defaultAgentPercentage', defaultPercentage.toString());
            logActivity('ÿ≠ŸÅÿ∏ ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™', `ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÜÿ≥ÿ®ÿ© ÿßŸÑÿßŸÅÿ™ÿ±ÿßÿ∂Ÿäÿ© ŸÑŸÑŸàŸÉŸÑÿßÿ° ÿ•ŸÑŸâ ${defaultPercentage}%`);
            showSuccessMessage(`ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿßŸÑŸÜÿ≥ÿ®ÿ© ÿßŸÑÿßŸÅÿ™ÿ±ÿßÿ∂Ÿäÿ©: ${defaultPercentage}%`);
        }
        function backupData() {
            const backup = {
                timestamp: new Date().toISOString(),
                agentReports: agentReports,
                settings: JSON.parse(localStorage.getItem('appSettings') || '{}'),
                activityLog: activityLog
            };
            const dataStr = JSON.stringify(backup, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `backup_${formatDateForFilename(new Date())}.json`;
            link.click();
            URL.revokeObjectURL(url);
            logActivity('ŸÜÿ≥ÿÆ ÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿä', 'ÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ° ŸÜÿ≥ÿÆÿ© ÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ© ŸÖŸÜ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™');
            showSuccessMessage('ÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑŸÜÿ≥ÿÆÿ© ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ© ÿ®ŸÜÿ¨ÿßÿ≠!');
        }
        function restoreData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const backup = JSON.parse(event.target.result);
                        if (backup.agentReports) agentReports = backup.agentReports;
                        if (backup.settings) localStorage.setItem('appSettings', JSON.stringify(backup.settings));
                        if (backup.activityLog) {
                            activityLog = backup.activityLog;
                            localStorage.setItem('activityLog', JSON.stringify(activityLog));
                        }
                        loadSettings();
                        updateAgentSummary();
                        refreshActivityLog();
                        logActivity('ÿßÿ≥ÿ™ÿπÿßÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™', 'ÿ™ŸÖ ÿßÿ≥ÿ™ÿπÿßÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖŸÜ ÿßŸÑŸÜÿ≥ÿÆÿ© ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ©');
                        showSuccessMessage('ÿ™ŸÖ ÿßÿ≥ÿ™ÿπÿßÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ®ŸÜÿ¨ÿßÿ≠!');
                    } catch (error) {
                        alert('ÿÆÿ∑ÿ£ ŸÅŸä ŸÇÿ±ÿßÿ°ÿ© ÿßŸÑŸÖŸÑŸÅ: ' + error.message);
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }
        async function clearAllData() {
            if (!confirm('‚ö†Ô∏è ÿ™ÿ≠ÿ∞Ÿäÿ±: ÿ≥Ÿäÿ™ŸÖ ÿ™ÿµŸÅŸäÿ± ÿ¨ŸÖŸäÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖŸÜ ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸàÿßŸÑÿ®ÿØÿ° ŸÖŸÜ ÿ¨ÿØŸäÿØ!\n\nÿ≥Ÿäÿ™ŸÖ ÿ≠ÿ∞ŸÅ:\n- ÿ¨ŸÖŸäÿπ ÿßŸÑÿ™ÿ≠ŸÑŸäŸÑÿßÿ™ ŸÖŸÜ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ£ÿ¥Ÿáÿ± (ÿßŸÑÿπÿ±ÿ∂ ÿßŸÑŸÖÿ¨ÿßŸÜŸäÿå ŸÖÿÆŸÅÿ∂ 3 ÿ£ÿ¥Ÿáÿ±ÿå ŸÖÿÆŸÅÿ∂ ÿ¥Ÿáÿ±ŸäŸÜ)\n- ÿ¨ŸÖŸäÿπ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÜÿ≥ÿ® ŸÖŸÜ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ£ÿ¥Ÿáÿ±\n- ÿ¨ŸÖŸäÿπ ÿßŸÑÿ£ÿ±ÿ¥ŸäŸÅÿßÿ™ ŸÖŸÜ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ£ÿ¥Ÿáÿ±\n- ÿ¨ŸÖŸäÿπ ÿ≥ÿ¨ŸÑÿßÿ™ ÿßŸÑŸÜÿ¥ÿßÿ∑ ŸÖŸÜ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ£ÿ¥Ÿáÿ±\n\nÿ≥Ÿäÿ™ŸÖ ÿßŸÑÿßÿ≠ÿ™ŸÅÿßÿ∏ ŸÅŸÇÿ∑ ÿ®ŸÄ:\n- ÿ£ÿ≥ŸÖÿßÿ° ÿßŸÑŸàŸÉŸÑÿßÿ° ŸÅŸä ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸàŸÉŸÑÿßÿ°\n- ÿπÿ±Ÿàÿ∂ ÿßŸÑŸàŸÉŸÑÿßÿ° (B, S, G, P)\n- ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ\n\nŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿßŸÑŸÖÿ™ÿßÿ®ÿπÿ©ÿü')) {
                return;
            }
            
            try {
                const agentsBackup = agentsList.map(agent => ({
                    name: agent.name,
                    subName: agent.subName || '',
                    phone: agent.phone || '',
                    email: agent.email || '',
                    percentage: agent.percentage || 16
                }));
                
                agentReports = {};
                agentPercentages = {};
                activityLog = [];
                basicData = null;
                advancedData = null;
                twoMonthsData = null;
                basicDetails = [];
                advancedDetails = [];
                twoMonthsDetails = [];
                
                localStorage.clear();
                localStorage.setItem('agentsList', JSON.stringify(agentsBackup));
                
                if (supabaseClient) {
                    try {
                        const { error: analysisError } = await supabaseClient
                            .from('analysis_archives')
                            .delete()
                            .gte('id', 0); 
                        if (analysisError) {
                            console.error('Error deleting analysis archives:', analysisError);
                        } else {
                        }
                    } catch (e) {
                        console.error('Error deleting analysis archives:', e);
                    }
                    
                    try {
                        const { error: percentagesError } = await supabaseClient
                            .from('agent_percentages')
                            .delete()
                            .gte('id', 0); 
                        if (percentagesError) {
                            console.error('Error deleting agent percentages:', percentagesError);
                        } else {
                        }
                    } catch (e) {
                        console.error('Error deleting agent percentages:', e);
                    }
                    
                    try {
                        const { error: activityError } = await supabaseClient
                            .from('activity_logs')
                            .delete()
                            .gte('id', 0); 
                        if (activityError) {
                            console.error('Error deleting activity logs:', activityError);
                        } else {
                        }
                    } catch (e) {
                        console.error('Error deleting activity logs:', e);
                    }
                    
                    try {
                        await saveAgentsToDatabase();
                    } catch (e) {
                        console.error('Error updating agents list:', e);
                    }
                }
                
                refreshAgentsList();
                updateAgentSummary();
                renderPercentageTable();
                
                showSuccessMessage('‚úÖ ÿ™ŸÖ ÿ™ÿµŸÅŸäÿ± ÿ¨ŸÖŸäÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖŸÜ ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ®ŸÜÿ¨ÿßÿ≠! ÿ™ŸÖ ÿßŸÑÿßÿ≠ÿ™ŸÅÿßÿ∏ ÿ®ÿ£ÿ≥ŸÖÿßÿ° ÿßŸÑŸàŸÉŸÑÿßÿ° ŸÅŸÇÿ∑.');
                
                setTimeout(() => {
                    location.reload();
                }, 2000);
                
            } catch (error) {
                console.error('Error clearing data:', error);
                alert('ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿ™ÿµŸÅŸäÿ± ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™: ' + error.message);
            }
        }
        function loadActivityLog() {
            refreshActivityLog();
}
        async function ensureAgentExists(agentName) {
            if (!agentName || agentName === 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ') {
                return;
            }
            
            const normalizedAgentName = agentName.trim();
            if (!normalizedAgentName) {
                return;
            }
            
            const agentExists = agentsList.some(a => {
                const normalizedExistingName = (a.name || '').trim();
                return normalizedExistingName === normalizedAgentName;
            });
            
            if (!agentExists) {
                const newAgent = { 
                    name: normalizedAgentName,
                    subName: '',
                    phone: '', 
                    email: '',
                    percentage: 16
                };
                agentsList.push(newAgent);
                localStorage.setItem('agentsList', JSON.stringify(agentsList));
                
                if (supabaseClient) {
                try {
                    const saved = await saveAgentsToDatabase();
                    if (saved) {
                    } else {
                        console.warn(`‚ö† Failed to save agent "${normalizedAgentName}" to database, will retry on next operation`);
                    }
                } catch (err) {
                    console.error('Error saving agent to database:', err);
                }
                }
                
                logActivity('ÿ•ÿ∂ÿßŸÅÿ© ŸàŸÉŸäŸÑ ÿ™ŸÑŸÇÿßÿ¶Ÿä', `ÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸàŸÉŸäŸÑ "${normalizedAgentName}" ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã ŸÖŸÜ ŸÖŸÑŸÅ ÿßŸÑÿ™ÿ≠ŸÑŸäŸÑ`);
                showSuccessMessage(`ÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸàŸÉŸäŸÑ "${normalizedAgentName}" ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã ÿ•ŸÑŸâ ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸàŸÉŸÑÿßÿ°`);
            } else {
            }
        }
        async function saveAgentsToDatabase() {
            if (!supabaseClient) {
                return false;
            }
            try {
                const permanentMonthYear = '0000-00';
                const agentsData = agentsList.map(agent => ({
                    name: agent.name,
                    subName: agent.subName || '',
                    phone: agent.phone || '',
                    email: agent.email || '',
                    percentage: agent.percentage || 16
                }));
                const { data: existingArchive, error: checkError } = await supabaseClient
                    .from('agents_list')
                    .select('id, data')
                    .eq('month_year', permanentMonthYear)
                    .maybeSingle();
                if (!checkError && existingArchive) {
                    const { error: updateError } = await supabaseClient
                        .from('agents_list')
                        .update({
                            data: agentsData,
                            updated_at: new Date().toISOString()
                        })
                        .eq('id', existingArchive.id);
                    if (updateError) throw updateError;
                } else {
                    const { error: insertError } = await supabaseClient
                        .from('agents_list')
                        .insert({
                            month_year: permanentMonthYear,
                            data: agentsData,
                            created_at: new Date().toISOString(),
                            updated_at: new Date().toISOString()
                        });
                    if (insertError) throw insertError;
                }
                return true;
            } catch (error) {
                console.error('‚úó Error saving agents to database:', error);
                return false;
            }
        }
        let saveAgentsListToDatabaseTimeout = null;
        let isSavingAgentsList = false;
        async function saveAgentsListToDatabase(monthYear = null) {
            if (!supabaseClient) {
                return false;
            }
            if (isSavingAgentsList) {
                return false;
            }
            if (saveAgentsListToDatabaseTimeout) {
                clearTimeout(saveAgentsListToDatabaseTimeout);
            }
            return new Promise((resolve) => {
                saveAgentsListToDatabaseTimeout = setTimeout(async () => {
                    isSavingAgentsList = true;
                    try {
                        const result = await saveAgentsListToDatabaseInternal(monthYear);
                        resolve(result);
                    } finally {
                        isSavingAgentsList = false;
                        saveAgentsListToDatabaseTimeout = null;
                    }
                }, 2000);
            });
        }
        async function saveAgentsListToDatabaseInternal(monthYear = null) {
            if (!supabaseClient) {
                return false;
            }
            try {
                if (!monthYear) {
                    monthYear = getCurrentMonthYear();
                }
                const optimizeDetails = (details) => {
                    if (!Array.isArray(details) || details.length === 0) return [];
                    return details.slice(-200).map(detail => ({
                        username: detail.username,
                        subscription: detail.subscription,
                        agent: detail.agent,
                        date1: detail.date1,
                        date2: detail.date2,
                        date3: detail.date3,
                        daysDiff: detail.daysDiff,
                        type: detail.type
                    }));
                };
                const optimizeReport = (report) => {
                    if (!report) return null;
                    return {
                        bronze: report.bronze ? {
                            count: report.bronze.count,
                            amount: report.bronze.amount,
                            promoAmount: report.bronze.promoAmount,
                            officialAmount: report.bronze.officialAmount
                        } : null,
                        silver: report.silver ? {
                            count: report.silver.count,
                            amount: report.silver.amount,
                            promoAmount: report.silver.promoAmount,
                            officialAmount: report.silver.officialAmount
                        } : null,
                        gold: report.gold ? {
                            count: report.gold.count,
                            amount: report.gold.amount,
                            promoAmount: report.gold.promoAmount,
                            officialAmount: report.gold.officialAmount
                        } : null,
                        platinum: report.platinum ? {
                            count: report.platinum.count,
                            amount: report.platinum.amount,
                            promoAmount: report.platinum.promoAmount,
                            officialAmount: report.platinum.officialAmount
                        } : null,
                        total: report.total || null,
                        agentName: report.agentName || null
                    };
                };
                const agentsDataWithDetails = agentsList.map(agent => {
                    const agentName = agent.name;
                    const reports = agentReports[agentName] || {};
                    const basicDetailsForAgent = (basicDetails || []).filter(d => d && d.agent === agentName);
                    const advancedDetailsForAgent = (advancedDetails || []).filter(d => d && d.agent === agentName);
                    const twoMonthsDetailsForAgent = (twoMonthsDetails || []).filter(d => d && d.agent === agentName);
                    return {
                        name: agent.name,
                        subName: agent.subName || '',
                        phone: agent.phone || '',
                        email: agent.email || '',
                        percentage: agent.percentage || 16,
                        details: {
                            basic: optimizeDetails(basicDetailsForAgent),
                            advanced: optimizeDetails(advancedDetailsForAgent),
                            twoMonths: optimizeDetails(twoMonthsDetailsForAgent)
                        },
                        offers: {
                            basic: optimizeReport(reports.basic),
                            advanced: optimizeReport(reports.advanced),
                            twoMonths: optimizeReport(reports.twoMonths)
                        }
                    };
                });
                const checkPromise = supabaseClient
                    .from('agents_list')
                    .select('id, data')
                    .eq('month_year', monthYear)
                    .maybeSingle();
                const checkTimeout = new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('Check timeout')), 15000)
                );
                let existingArchive;
                let checkError = null;
                try {
                    const result = await Promise.race([checkPromise, checkTimeout]);
                    if (result && !result.error) {
                        existingArchive = result.data;
                    } else if (result && result.error) {
                        checkError = result.error;
                    }
                } catch (timeoutError) {
                    console.warn('Check timeout for agents_list, proceeding with insert');
                }
                if (!checkError && existingArchive) {
                    let existingAgents = existingArchive.data || [];
                    if (!Array.isArray(existingAgents)) {
                        existingAgents = [];
                    }
                    const existingAgentsMap = new Map();
                    existingAgents.forEach(agent => {
                        existingAgentsMap.set(agent.name, agent);
                    });
                    agentsDataWithDetails.forEach(newAgent => {
                        const existingAgent = existingAgentsMap.get(newAgent.name);
                        if (existingAgent) {
                            const hasNewBasic = newAgent.details.basic && newAgent.details.basic.length > 0;
                            const hasNewAdvanced = newAgent.details.advanced && newAgent.details.advanced.length > 0;
                            const hasNewTwoMonths = newAgent.details.twoMonths && newAgent.details.twoMonths.length > 0;
                            if (hasNewBasic || hasNewAdvanced || hasNewTwoMonths) {
                                existingAgent.details = {
                                    basic: newAgent.details.basic && newAgent.details.basic.length > 0 
                                        ? newAgent.details.basic 
                                        : (existingAgent.details?.basic || []),
                                    advanced: newAgent.details.advanced && newAgent.details.advanced.length > 0 
                                        ? newAgent.details.advanced 
                                        : (existingAgent.details?.advanced || []),
                                    twoMonths: newAgent.details.twoMonths && newAgent.details.twoMonths.length > 0 
                                        ? newAgent.details.twoMonths 
                                        : (existingAgent.details?.twoMonths || [])
                                };
                            }
                            existingAgent.offers = {
                                basic: newAgent.offers.basic || existingAgent.offers?.basic || null,
                                advanced: newAgent.offers.advanced || existingAgent.offers?.advanced || null,
                                twoMonths: newAgent.offers.twoMonths || existingAgent.offers?.twoMonths || null
                            };
                            if (!existingAgent.phone && newAgent.phone) existingAgent.phone = newAgent.phone;
                            if (!existingAgent.email && newAgent.email) existingAgent.email = newAgent.email;
                            if (!existingAgent.subName && newAgent.subName) existingAgent.subName = newAgent.subName;
                        } else {
                            existingAgents.push(newAgent);
                        }
                    });
                    const updatePromise = supabaseClient
                        .from('agents_list')
                        .update({
                            data: existingAgents,
                            updated_at: new Date().toISOString()
                        })
                        .eq('id', existingArchive.id);
                    const updateTimeout = new Promise((_, reject) => 
                        setTimeout(() => reject(new Error('Update timeout')), 90000)
                    );
                    try {
                        const { error: updateError } = await Promise.race([updatePromise, updateTimeout]);
                        if (updateError) throw updateError;
                    } catch (timeoutError) {
                        console.warn(`‚ö† Update timeout for agents_list (${monthYear}) - Data will be saved on next successful operation`);
                        return false;
                    }
                } else {
                    const insertPromise = supabaseClient
                        .from('agents_list')
                        .insert({
                            month_year: monthYear,
                            data: agentsDataWithDetails,
                            created_at: new Date().toISOString(),
                            updated_at: new Date().toISOString()
                        });
                    const insertTimeout = new Promise((_, reject) => 
                        setTimeout(() => reject(new Error('Insert timeout')), 90000)
                    );
                    try {
                        const { error: insertError } = await Promise.race([insertPromise, insertTimeout]);
                        if (insertError) throw insertError;
                    } catch (timeoutError) {
                        console.warn(`‚ö† Insert timeout for agents_list (${monthYear}) - Will retry on next operation`);
                        return false;
                    }
                }
                return true;
            } catch (error) {
                console.error('‚úó Error saving agents_list to database:', error);
                return false;
            }
        }
        let currentAgentSort = 'name';
        let currentAgentFilter = '';
        function refreshAgentsList() {
            renderAgentsList();
        }
        function filterAgents() {
            currentAgentFilter = document.getElementById('agentSearchInput').value.toLowerCase().trim();
            renderAgentsList();
        }
        function sortAgents() {
            currentAgentSort = document.getElementById('agentSortSelect').value;
            renderAgentsList();
        }
        function renderAgentsList() {
            const agentsListContainer = document.getElementById('agentsList');
            if (!agentsListContainer) return;
            if (agentsList.length === 0) {
                agentsListContainer.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #999;">
                        <p style="font-size: 1.2rem; margin-bottom: 20px;">ŸÑÿß ŸäŸàÿ¨ÿØ ŸàŸÉŸÑÿßÿ° ŸÖÿ≥ÿ¨ŸÑŸàŸÜ</p>
                        <p style="font-size: 0.9rem; color: #666;">ÿ≥Ÿäÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸàŸÉŸÑÿßÿ° ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã ÿπŸÜÿØ ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑŸÖŸÑŸÅÿßÿ™</p>
                    </div>
                `;
                document.getElementById('agentsCount').textContent = '0';
                return;
            }
            let filteredAgents = agentsList.filter(agent => {
                if (!currentAgentFilter) return true;
                return agent.name.toLowerCase().includes(currentAgentFilter) ||
                       (agent.phone && agent.phone.includes(currentAgentFilter)) ||
                       (agent.email && agent.email.toLowerCase().includes(currentAgentFilter));
            });
            filteredAgents = filteredAgents.map(agent => {
                const reports = agentReports[agent.name] || {};
                const totalBasic = reports.basic?.total.amount || 0;
                const totalAdvanced = reports.advanced?.total.profit || 0;
                const totalTwoMonths = reports.twoMonths?.total.profit || 0;
                const total = totalBasic + totalAdvanced + totalTwoMonths;
                const reportsCount = (totalBasic > 0 ? 1 : 0) + (totalAdvanced > 0 ? 1 : 0) + (totalTwoMonths > 0 ? 1 : 0);
                return {
                    ...agent,
                    index: agentsList.indexOf(agent),
                    total,
                    reportsCount
                };
            });
            filteredAgents.sort((a, b) => {
                switch(currentAgentSort) {
                    case 'name':
                        return a.name.localeCompare(b.name, 'ar');
                    case 'name-desc':
                        return b.name.localeCompare(a.name, 'ar');
                    case 'total-desc':
                        return b.total - a.total;
                    case 'total-asc':
                        return a.total - b.total;
                    case 'reports-desc':
                        return b.reportsCount - a.reportsCount;
                    case 'reports-asc':
                        return a.reportsCount - b.reportsCount;
                    default:
                        return 0;
                }
            });
            let html = '';
            filteredAgents.forEach((agent) => {
                const index = agent.index;
                const reports = agentReports[agent.name] || {};
                const totalBasic = reports.basic?.total.amount || 0;
                const totalAdvanced = reports.advanced?.total.profit || 0;
                const totalTwoMonths = reports.twoMonths?.total.profit || 0;
                const total = totalBasic + totalAdvanced + totalTwoMonths;
                const hasReports = total > 0;
                const reportsCount = (totalBasic > 0 ? 1 : 0) + (totalAdvanced > 0 ? 1 : 0) + (totalTwoMonths > 0 ? 1 : 0);
                const percentageData = agentPercentages[agent.name] || {};
                const hasPercentageData = percentageData.percentage !== undefined || percentageData.netPercentage !== undefined;
                const percentageAmount = percentageData.agentPercentageAmount || 0;
                const netPercentage = percentageData.netPercentage || 0;
                const deductions = percentageData.deductions || 0;
                const penalties = percentageData.penalties || 0;
                const percentageRate = percentageData.percentage || agent.percentage || 16;
                html += `
                    <div class="agent-card-improved">
                        <div class="agent-card-header-improved">
                            <div class="agent-name-section">
                                <h3 class="agent-name-title">${agent.name}</h3>
                                ${agent.subName ? `<p class="agent-name-subtitle">${agent.subName}</p>` : ''}
                                ${hasReports ? `<span class="agent-badge">${formatNumberEnglish(reportsCount)} ÿ™ŸÇÿ±Ÿäÿ±</span>` : '<span class="agent-badge-empty">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ™ŸÇÿßÿ±Ÿäÿ±</span>'}
                            </div>
                            <div class="agent-actions-improved">
                                <button class="btn-action btn-action-edit" onclick="showEditAgentModal(${index})" title="ÿ™ÿπÿØŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™">
                                    ÿ™ÿπÿØŸäŸÑ
                                </button>
                                <button class="btn-action btn-action-send" onclick="sendWhatsAppReport('${agent.name}')" title="ÿ•ÿ±ÿ≥ÿßŸÑ ÿ™ŸÇÿ±Ÿäÿ± Ÿàÿßÿ™ÿ≥ÿßÿ®" ${!hasReports ? 'disabled style="opacity: 0.5; cursor: not-allowed;"' : ''}>
                                    ÿ•ÿ±ÿ≥ÿßŸÑ
                                </button>
                                <button class="btn-action btn-action-delete" onclick="deleteAgent(${index})" title="ÿ≠ÿ∞ŸÅ ÿßŸÑŸàŸÉŸäŸÑ">
                                    ÿ≠ÿ∞ŸÅ
                                </button>
                            </div>
                        </div>
                        <div class="agent-info-section">
                            <div class="info-item-improved">
                                <span class="info-label">ÿßŸÑŸÜÿ≥ÿ®ÿ©:</span>
                                <input type="number" id="agentPercentage_${index}" class="info-value-input" value="${agent.percentage || 16}" min="0" max="100" step="0.01" onchange="updateAgentPercentage(${index}, this.value)" style="width: 80px; padding: 4px; text-align: center; direction: ltr; font-size: 0.8rem; border: 1px solid rgba(128, 28, 50, 0.2); border-radius: 6px; position: relative; z-index: 10; pointer-events: auto; cursor: text;">
                                <span style="margin-right: 5px; color: #801c32; font-weight: 700;">%</span>
                            </div>
                            ${agent.phone ? `
                                <div class="info-item-improved">
                                    <span class="info-label">Ÿáÿßÿ™ŸÅ:</span>
                                    <span class="info-value">${agent.phone}</span>
                                </div>
                            ` : ''}
                            ${agent.email ? `
                                <div class="info-item-improved">
                                    <span class="info-label">ÿ®ÿ±ŸäÿØ:</span>
                                    <span class="info-value">${agent.email}</span>
                                </div>
                            ` : ''}
                            ${!agent.phone && !agent.email ? `
                                <div class="info-item-improved">
                                    <span class="info-label-empty">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßÿ™ÿµÿßŸÑ</span>
                                </div>
                            ` : ''}
                        </div>
                        ${hasPercentageData ? `
                        <div class="agent-percentage-section" style="flex: 0 0 180px; min-width: 180px; max-width: 180px; padding-right: 12px; border-right: 1px solid rgba(128, 28, 50, 0.1); display: flex; flex-direction: column; gap: 4px;">
                            <div style="font-weight: 700; color: var(--primary-color); font-size: 0.75rem; margin-bottom: 4px;">üìä ŸÜÿ≥ÿ®ÿ© ÿßŸÑŸàŸÉŸäŸÑ</div>
                            <div style="background: rgba(128, 28, 50, 0.04); padding: 4px 6px; border-radius: 4px; border: 1px solid rgba(128, 28, 50, 0.15);">
                                <div style="font-size: 0.65rem; color: var(--text-secondary); margin-bottom: 2px;">ÿßŸÑŸÜÿ≥ÿ®ÿ©</div>
                                <div style="font-weight: 700; color: var(--primary-color); font-size: 0.8rem;">${formatNumber(percentageRate)}%</div>
                            </div>
                            <div style="background: rgba(128, 28, 50, 0.04); padding: 4px 6px; border-radius: 4px; border: 1px solid rgba(128, 28, 50, 0.15);">
                                <div style="font-size: 0.65rem; color: var(--text-secondary); margin-bottom: 2px;">ÿßŸÑŸÖÿ®ŸÑÿ∫</div>
                                <div style="font-weight: 700; color: #2d5016; font-size: 0.8rem;">${formatNumber(percentageAmount)} <span style="font-size: 0.65rem;">ÿØ.ÿπ</span></div>
                            </div>
                            <div style="background: rgba(128, 28, 50, 0.04); padding: 4px 6px; border-radius: 4px; border: 1px solid rgba(128, 28, 50, 0.15);">
                                <div style="font-size: 0.65rem; color: var(--text-secondary); margin-bottom: 2px;">ÿßŸÑÿµÿßŸÅŸä</div>
                                <div style="font-weight: 700; color: #2d5016; font-size: 0.85rem;">${formatNumber(netPercentage)} <span style="font-size: 0.65rem;">ÿØ.ÿπ</span></div>
                            </div>
                            ${(deductions > 0 || penalties > 0) ? `
                            <div style="display: flex; gap: 4px;">
                                ${deductions > 0 ? `
                                <div style="background: rgba(255, 193, 7, 0.1); padding: 4px 6px; border-radius: 4px; border: 1px solid rgba(255, 193, 7, 0.3); flex: 1;">
                                    <div style="font-size: 0.6rem; color: var(--text-secondary); margin-bottom: 2px;">ÿßÿ≥ÿ™ŸÇÿ∑ÿßÿπ</div>
                                    <div style="font-weight: 700; color: #f57c00; font-size: 0.75rem;">${formatNumber(deductions)} <span style="font-size: 0.6rem;">ÿØ.ÿπ</span></div>
                                </div>
                                ` : ''}
                                ${penalties > 0 ? `
                                <div style="background: rgba(244, 67, 54, 0.1); padding: 4px 6px; border-radius: 4px; border: 1px solid rgba(244, 67, 54, 0.3); flex: 1;">
                                    <div style="font-size: 0.6rem; color: var(--text-secondary); margin-bottom: 2px;">ÿ∫ÿ±ÿßŸÖÿ©</div>
                                    <div style="font-weight: 700; color: #d32f2f; font-size: 0.75rem;">${formatNumber(penalties)} <span style="font-size: 0.6rem;">ÿØ.ÿπ</span></div>
                                </div>
                                ` : ''}
                            </div>
                            ` : ''}
                        </div>
                        ` : ''}
                        <div class="agent-reports-section">
                            <div class="reports-grid">
                                ${totalBasic > 0 ? `
                                    <div class="report-item report-basic">
                                        <div class="report-label">ÿßŸÑÿπÿ±ÿ∂ ÿßŸÑŸÖÿ¨ÿßŸÜŸä</div>
                                        <div class="report-value">${formatNumber(totalBasic)} <span class="currency">ÿØ.ÿπ</span></div>
                                    </div>
                                ` : ''}
                                ${totalAdvanced > 0 ? `
                                    <div class="report-item report-advanced">
                                        <div class="report-label">ŸÖÿÆŸÅÿ∂ 3 ÿ£ÿ¥Ÿáÿ±</div>
                                        <div class="report-value">${formatNumber(totalAdvanced)} <span class="currency">ÿØ.ÿπ</span></div>
                                    </div>
                                ` : ''}
                                ${totalTwoMonths > 0 ? `
                                    <div class="report-item report-twomonths">
                                        <div class="report-label">ŸÖÿÆŸÅÿ∂ ÿ¥Ÿáÿ±ŸäŸÜ</div>
                                        <div class="report-value">${formatNumber(totalTwoMonths)} <span class="currency">ÿØ.ÿπ</span></div>
                                    </div>
                                ` : ''}
                            </div>
                            ${hasReports ? `
                                <div class="agent-total-section">
                                    <div class="total-label">ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä</div>
                                    <div class="total-value">${formatNumber(total)} <span class="currency">ÿØ.ÿπ</span></div>
                                </div>
                                <button class="btn btn-warning" onclick="clearAgentReports('${agent.name}')" style="padding: 5px 10px; font-size: 0.7rem; white-space: nowrap; flex-shrink: 0;">
                                    üóëÔ∏è ÿ≠ÿ∞ŸÅ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
                                </button>
                            ` : `
                                <div class="no-reports-message" style="flex: 1; text-align: center; padding: 4px 8px; background: rgba(128, 28, 50, 0.04); border-radius: 5px; border: 1px dashed rgba(128, 28, 50, 0.25);">
                                    <p style="color: #999; font-size: 0.7rem; margin: 0; font-style: italic;">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ™ŸÇÿßÿ±Ÿäÿ±</p>
                                </div>
                            `}
                        </div>
                    </div>
                `;
            });
            agentsListContainer.innerHTML = html;
            const countElement = document.getElementById('agentsCount');
            if (countElement) {
                countElement.textContent = filteredAgents.length;
            }
        }
        function showAddAgentModal() {
            document.getElementById('agentModalTitle').textContent = 'ÿ•ÿ∂ÿßŸÅÿ© ŸàŸÉŸäŸÑ ÿ¨ÿØŸäÿØ';
            document.getElementById('agentForm').reset();
            document.getElementById('agentForm').onsubmit = function(e) {
                e.preventDefault();
                addAgent();
            };
            document.getElementById('agentModal').classList.add('show');
        }
        function showEditAgentModal(index) {
            const agent = agentsList[index];
            document.getElementById('agentModalTitle').textContent = 'ÿ™ÿπÿØŸäŸÑ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸàŸÉŸäŸÑ';
            document.getElementById('agentName').value = agent.name;
            document.getElementById('agentSubName').value = agent.subName || '';
            document.getElementById('agentPhone').value = agent.phone || '';
            document.getElementById('agentEmail').value = agent.email || '';
            document.getElementById('agentForm').onsubmit = function(e) {
                e.preventDefault();
                updateAgent(index);
            };
            document.getElementById('agentModal').classList.add('show');
        }
        function closeAgentModal() {
            document.getElementById('agentModal').classList.remove('show');
        }
        async function addAgent() {
            const name = document.getElementById('agentName').value.trim();
            const subName = document.getElementById('agentSubName') ? document.getElementById('agentSubName').value.trim() : '';
            const phone = document.getElementById('agentPhone').value.trim();
            const email = document.getElementById('agentEmail').value.trim();
            if (!name) {
                alert('Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ÿßÿ≥ŸÖ ÿßŸÑŸàŸÉŸäŸÑ');
                return;
            }
            const normalizedName = name.trim();
            const agentExists = agentsList.some(a => {
                const normalizedExistingName = (a.name || '').trim();
                return normalizedExistingName === normalizedName;
            });
            if (agentExists) {
                alert('ÿßÿ≥ŸÖ ÿßŸÑŸàŸÉŸäŸÑ ŸÖŸàÿ¨ŸàÿØ ŸÖÿ≥ÿ®ŸÇÿßŸã');
                return;
            }
            const agentData = { 
                name: normalizedName, 
                subName: subName || '', 
                phone, 
                email,
                percentage: 16
            };
            agentsList.push(agentData);
            localStorage.setItem('agentsList', JSON.stringify(agentsList));
            
            if (supabaseClient) {
            try {
                const saved = await saveAgentsToDatabase();
                if (saved) {
                        showSuccessMessage(`ÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸàŸÉŸäŸÑ Ÿàÿ≠ŸÅÿ∏Ÿá ŸÅŸä ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™`);
                } else {
                    console.warn(`‚ö† Failed to save agent "${name}" to database, will retry on next operation`);
                }
            } catch (err) {
                console.error('Error saving agent to database:', err);
                }
            }
            refreshAgentsList();
            updateAgentsListForPercentage();
            closeAgentModal();
            showSuccessMessage('ÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸàŸÉŸäŸÑ ÿ®ŸÜÿ¨ÿßÿ≠');
            logActivity('ÿ•ÿ∂ÿßŸÅÿ© ŸàŸÉŸäŸÑ', `ÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© ŸàŸÉŸäŸÑ ÿ¨ÿØŸäÿØ: ${name}`);
        }
        function updateAgentPercentage(index, newPercentage) {
            const percentage = parseFloat(newPercentage) || 16;
            if (percentage < 0 || percentage > 100) {
                alert('ÿßŸÑŸÜÿ≥ÿ®ÿ© ÿßŸÑŸÖÿ¶ŸàŸäÿ© Ÿäÿ¨ÿ® ÿ£ŸÜ ÿ™ŸÉŸàŸÜ ÿ®ŸäŸÜ 0 Ÿà 100');
                const agent = agentsList[index];
                document.getElementById(`agentPercentage_${index}`).value = agent.percentage || 16;
                return;
            }
            const agent = agentsList[index];
            if (!agent) return;
            agent.percentage = percentage;
            localStorage.setItem('agentsList', JSON.stringify(agentsList));
            saveAgentsToDatabase().catch(err => console.error('Error saving agents to database:', err));
            refreshAgentsList();
            showSuccessMessage(`ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÜÿ≥ÿ®ÿ© ŸÑŸÑŸàŸÉŸäŸÑ "${agent.name}" ÿ•ŸÑŸâ ${percentage}%`);
            logActivity('ÿ™ÿπÿØŸäŸÑ ŸÜÿ≥ÿ®ÿ© ŸàŸÉŸäŸÑ', `ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ŸÜÿ≥ÿ®ÿ© ÿßŸÑŸàŸÉŸäŸÑ "${agent.name}" ÿ•ŸÑŸâ ${percentage}%`);
        }
        async function updateAgent(index) {
            const name = document.getElementById('agentName').value.trim();
            const subName = document.getElementById('agentSubName') ? document.getElementById('agentSubName').value.trim() : '';
            const phone = document.getElementById('agentPhone').value.trim();
            const email = document.getElementById('agentEmail').value.trim();
            if (!name) {
                alert('Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ÿßÿ≥ŸÖ ÿßŸÑŸàŸÉŸäŸÑ');
                return;
            }
            const oldName = agentsList[index].name;
            if (name !== oldName && agentsList.some((a, i) => i !== index && a.name === name)) {
                alert('ÿßÿ≥ŸÖ ÿßŸÑŸàŸÉŸäŸÑ ŸÖŸàÿ¨ŸàÿØ ŸÖÿ≥ÿ®ŸÇÿßŸã');
                return;
            }
            if (name !== oldName && agentReports[oldName]) {
                agentReports[name] = agentReports[oldName];
                delete agentReports[oldName];
            }
            const existingAgent = agentsList[index];
            const agentData = { 
                name, 
                subName: subName !== '' ? subName : (existingAgent.subName || ''), 
                phone: phone !== '' ? phone : (existingAgent.phone || ''), 
                email: email !== '' ? email : (existingAgent.email || ''),
                percentage: existingAgent.percentage || 16
            };
            agentsList[index] = agentData;
            localStorage.setItem('agentsList', JSON.stringify(agentsList));
            
            if (supabaseClient) {
            try {
                const saved = await saveAgentsToDatabase();
                if (saved) {
                        showSuccessMessage(`ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿπÿØŸäŸÑÿßÿ™ ŸÅŸä ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™`);
                } else {
                    console.warn(`‚ö† Failed to update agent "${name}" in database, will retry on next operation`);
                }
            } catch (err) {
                console.error('Error updating agent in database:', err);
                }
            }
            refreshAgentsList();
            updateAgentSummary();
            updateAgentsListForPercentage();
            closeAgentModal();
            showSuccessMessage('ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸàŸÉŸäŸÑ ÿ®ŸÜÿ¨ÿßÿ≠');
            logActivity('ÿ™ÿπÿØŸäŸÑ ŸàŸÉŸäŸÑ', `ÿ™ŸÖ ÿ™ÿπÿØŸäŸÑ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸàŸÉŸäŸÑ: ${name}`);
        }
        async function deleteAgent(index) {
            const agent = agentsList[index];
            if (!confirm(`ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ≠ÿ∞ŸÅ ÿßŸÑŸàŸÉŸäŸÑ "${agent.name}"ÿü\n\nÿ≥Ÿäÿ™ŸÖ ÿ≠ÿ∞ŸÅ:\n- ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸàŸÉŸäŸÑ ŸÖŸÜ ÿßŸÑŸÇÿßÿ¶ŸÖÿ©\n- ÿ¨ŸÖŸäÿπ ÿßŸÑÿ™ÿ≠ŸÑŸäŸÑÿßÿ™ ÿßŸÑŸÖÿ±ÿ™ÿ®ÿ∑ÿ© ÿ®Ÿáÿ∞ÿß ÿßŸÑŸàŸÉŸäŸÑ`)) return;
            const agentName = agent.name;
            agentsList.splice(index, 1);
            localStorage.setItem('agentsList', JSON.stringify(agentsList));
            if (agentReports[agentName]) {
                delete agentReports[agentName];
            }
            if (agentPercentages[agentName]) {
                delete agentPercentages[agentName];
                localStorage.setItem('agentPercentages', JSON.stringify(agentPercentages));
                if (supabaseClient) {
                    const savedMonthYear = localStorage.getItem('agentPercentages_monthYear') || getCurrentMonthYear();
                    saveToDatabase('agent_percentages', agentPercentages, { monthYear: savedMonthYear })
                        .catch(err => console.error('Error saving percentages after deletion:', err));
                }
            }
            if (supabaseClient) {
            try {
                const saved = await saveAgentsToDatabase();
                if (saved) {
                } else {
                    console.warn(`‚ö† Failed to delete agent "${agentName}" from database, will retry on next operation`);
                }
            } catch (err) {
                console.error('Error deleting agent from database:', err);
                }
            }
            refreshAgentsList();
            updateAgentsListForPercentage();
            updateAgentSummary();
            renderPercentageTable();
            showSuccessMessage('ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿßŸÑŸàŸÉŸäŸÑ Ÿàÿ¨ŸÖŸäÿπ ÿ®ŸäÿßŸÜÿßÿ™Ÿá ÿ®ŸÜÿ¨ÿßÿ≠');
            logActivity('ÿ≠ÿ∞ŸÅ ŸàŸÉŸäŸÑ', `ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿßŸÑŸàŸÉŸäŸÑ Ÿàÿ¨ŸÖŸäÿπ ÿ®ŸäÿßŸÜÿßÿ™Ÿá: ${agentName}`);
        }
        function sendWhatsAppReport(agentName) {
            const agent = agentsList.find(a => a.name === agentName);
            if (!agent) {
                alert('ÿßŸÑŸàŸÉŸäŸÑ ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ ŸÅŸä ÿßŸÑŸÇÿßÿ¶ŸÖÿ©');
                return;
            }
            if (!agent.phone) {
                alert('ŸÑŸÖ Ÿäÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿØ ÿ±ŸÇŸÖ Ÿáÿßÿ™ŸÅ ŸÑŸÑŸàŸÉŸäŸÑ');
                return;
            }
            showMessageCustomizationModal(agentName);
        }
        function showMessageCustomizationModal(agentName) {
            const reports = agentReports[agentName] || {};
            const agent = agentsList.find(a => a.name === agentName);
            const agentSubName = agent?.subName || '';
            document.getElementById('customMessageAgentName').textContent = agentName;
            let defaultMessage = `*${agentName}*`;
            if (agentSubName) {
                defaultMessage += `\n${agentSubName}`;
            }
            defaultMessage += `\n\nÿ™ÿ≠Ÿäÿ© ÿ∑Ÿäÿ®ÿ© \n\nŸÜŸàÿØ ÿ•ÿπŸÑÿßŸÖŸÉŸÖ ÿ®ÿßŸÑÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑÿÆÿßÿµ ÿ®ÿßŸÑŸÖÿ®ÿßŸÑÿ∫ ÿßŸÑŸÖÿ≥ÿ™ÿ≠ŸÇÿ©ÿå ŸàŸÉŸÖÿß ŸäŸÑŸä:\n\n`;
            const totalBasic = reports.basic?.total.amount || 0;
            const totalAdvanced = reports.advanced?.total.profit || 0;
            const totalTwoMonths = reports.twoMonths?.total.profit || 0;
            const selectedTotal = totalBasic + totalAdvanced + totalTwoMonths;
            const availableOffers = [];
            if (totalBasic > 0) availableOffers.push({ type: 'basic', amount: totalBasic });
            if (totalAdvanced > 0) availableOffers.push({ type: 'advanced', amount: totalAdvanced });
            if (totalTwoMonths > 0) availableOffers.push({ type: 'twoMonths', amount: totalTwoMonths });
            if (availableOffers.length > 1) {
                defaultMessage += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
            if (totalBasic > 0) {
                    defaultMessage += `*ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿπÿ±ÿ∂ ÿßŸÑŸÖÿ¨ÿßŸÜŸä: ${formatNumberEnglish(totalBasic)} ÿØŸäŸÜÿßÿ± ÿπÿ±ÿßŸÇŸä*\n`;
            }
            if (totalAdvanced > 0) {
                    defaultMessage += `*ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿπÿ±ÿ∂ ÿßŸÑŸÖÿÆŸÅÿ∂ ŸÑÿ´ŸÑÿßÿ´ÿ© ÿ£ÿ¥Ÿáÿ±: ${formatNumberEnglish(totalAdvanced)} ÿØŸäŸÜÿßÿ± ÿπÿ±ÿßŸÇŸä*\n`;
            }
            if (totalTwoMonths > 0) {
                    defaultMessage += `*ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿπÿ±ÿ∂ ÿßŸÑŸÖÿÆŸÅÿ∂ ŸÑÿ¥Ÿáÿ±ŸäŸÜ: ${formatNumberEnglish(totalTwoMonths)} ÿØŸäŸÜÿßÿ± ÿπÿ±ÿßŸÇŸä*\n`;
            }
                defaultMessage += `\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
                defaultMessage += `*ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÉŸÑŸä: ${formatNumberEnglish(selectedTotal)} ÿØŸäŸÜÿßÿ± ÿπÿ±ÿßŸÇŸä*\n`;
            }
            else if (availableOffers.length === 1) {
                const offer = availableOffers[0];
                defaultMessage += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
                if (offer.type === 'basic') {
                    defaultMessage += `*ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿπÿ±ÿ∂ ÿßŸÑŸÖÿ¨ÿßŸÜŸä: ${formatNumberEnglish(offer.amount)} ÿØŸäŸÜÿßÿ± ÿπÿ±ÿßŸÇŸä*\n`;
                } else if (offer.type === 'advanced') {
                    defaultMessage += `*ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿπÿ±ÿ∂ ÿßŸÑŸÖÿÆŸÅÿ∂ ŸÑÿ´ŸÑÿßÿ´ÿ© ÿ£ÿ¥Ÿáÿ±: ${formatNumberEnglish(offer.amount)} ÿØŸäŸÜÿßÿ± ÿπÿ±ÿßŸÇŸä*\n`;
                } else if (offer.type === 'twoMonths') {
                    defaultMessage += `*ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿπÿ±ÿ∂ ÿßŸÑŸÖÿÆŸÅÿ∂ ŸÑÿ¥Ÿáÿ±ŸäŸÜ: ${formatNumberEnglish(offer.amount)} ÿØŸäŸÜÿßÿ± ÿπÿ±ÿßŸÇŸä*\n`;
                }
            }
            else if (selectedTotal > 0) {
                defaultMessage += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
                defaultMessage += `*ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÉŸÑŸä: ${formatNumberEnglish(selectedTotal)} ÿØŸäŸÜÿßÿ± ÿπÿ±ÿßŸÇŸä*\n`;
            }
            defaultMessage += `\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
            defaultMessage += `Ÿäÿ±ÿ¨Ÿâ ÿßŸÑÿ™ŸÅÿ∂ŸÑ ÿ®ÿßŸÑÿßÿ∑ŸÑÿßÿπ ÿπŸÑŸâ ÿßŸÑŸÖŸÑŸÅ ÿßŸÑŸÖÿ±ŸÅŸÇ ŸÑŸÑÿßÿ∑ŸÑÿßÿπ ÿπŸÑŸâ ÿßŸÑÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑŸÉÿßŸÖŸÑÿ©.\n\n`;
            defaultMessage += `ŸÖÿπ ŸÅÿßÿ¶ŸÇ ÿßŸÑÿ¥ŸÉÿ± ŸàÿßŸÑÿ™ŸÇÿØŸäÿ±ÿå\n`;
            defaultMessage += `*ÿ¥ÿ±ŸÉÿ© ÿπÿ±ÿßŸÇ ÿ≥ŸäŸÑ ŸÑŸÑÿ•ÿ™ÿµÿßŸÑÿßÿ™*`;
            document.getElementById('customMessageText').value = defaultMessage;
            document.getElementById('customMessageAgentName').setAttribute('data-agent', agentName);
            document.getElementById('messageCustomizationModal').classList.add('show');
        }
        function generateSubscriptionTable(reportData, reportType) {
            let table = '';
            const categories = [
                { key: 'platinum', name: 'Platinum', emoji: 'üíé', arabicName: 'ÿ®ŸÑÿßÿ™ŸäŸÜŸäŸàŸÖ' },
                { key: 'gold', name: 'Gold', emoji: 'ü•á', arabicName: 'ŸÉŸàŸÑÿØ' },
                { key: 'silver', name: 'Silver', emoji: 'ü•à', arabicName: 'ÿ≥ŸÑŸÅÿ±' },
                { key: 'bronze', name: 'Bronze', emoji: 'ü•â', arabicName: 'ÿ®ÿ±ŸàŸÜÿ≤' }
            ];
            let hasData = false;
            categories.forEach(cat => {
                const category = reportData[cat.key];
                if (category && category.count > 0) {
                    hasData = true;
                    let amount = 0;
                    let price = 0;
                    if (reportType === 'basic') {
                        amount = category.amount || 0;
                        price = category.count > 0 ? Math.round(amount / category.count) : 0;
                    } else {
                        amount = (category.officialAmount || 0) - (category.promoAmount || 0);
                        price = category.count > 0 ? Math.round(amount / category.count) : 0;
                    }
                    table += `*${cat.arabicName} (${cat.name})*\n`;
                    table += `   ÿπÿØÿØ ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉÿßÿ™: ${formatNumberEnglish(category.count)}\n`;
                    table += `   ÿßŸÑÿ≥ÿπÿ± ÿßŸÑŸàÿßÿ≠ÿØ: ${formatNumberEnglish(price)} ÿØ.ÿπ\n`;
                    table += `   ÿßŸÑŸÖÿ¨ŸÖŸàÿπ: ${formatNumberEnglish(amount)} ÿØ.ÿπ\n\n`;
                }
            });
            if (hasData) {
                const totalCount = (reportData.platinum?.count || 0) + 
                                 (reportData.gold?.count || 0) + 
                                 (reportData.silver?.count || 0) + 
                                 (reportData.bronze?.count || 0);
                let totalAmount = 0;
                if (reportType === 'basic') {
                    totalAmount = reportData.total?.amount || 0;
                } else {
                    totalAmount = reportData.total?.profit || 0;
                }
                table += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
                table += `*ÿßŸÑŸÖÿ¨ŸÖŸàÿπ*\n`;
                table += `   ÿπÿØÿØ ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉÿßÿ™: ${formatNumberEnglish(totalCount)}\n`;
                table += `   ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä: ${formatNumberEnglish(totalAmount)} ÿØ.ÿπ\n`;
            }
            return table;
        }
        function closeMessageCustomizationModal() {
            document.getElementById('messageCustomizationModal').classList.remove('show');
        }
        function insertOfferInfo(type) {
            const textarea = document.getElementById('customMessageText');
            const cursorPos = textarea.selectionStart;
            const textBefore = textarea.value.substring(0, cursorPos);
            const textAfter = textarea.value.substring(cursorPos);
            let insertText = '';
            const agentName = document.getElementById('customMessageAgentName').getAttribute('data-agent');
            const reports = agentReports[agentName] || {};
            if (type === 'basic' && reports.basic) {
                insertText = ` ÿßŸÑÿπÿ±ÿ∂ ÿßŸÑŸÖÿ¨ÿßŸÜŸä: ${formatNumberEnglish(reports.basic.total.amount || 0)} ÿØŸäŸÜÿßÿ± ÿπÿ±ÿßŸÇŸä`;
            } else if (type === 'advanced' && reports.advanced) {
                insertText = ` ŸÖÿÆŸÅÿ∂ 3 ÿ£ÿ¥Ÿáÿ±: ${formatNumberEnglish(reports.advanced.total.profit || 0)} ÿØŸäŸÜÿßÿ± ÿπÿ±ÿßŸÇŸä`;
            } else if (type === 'twomonths' && reports.twoMonths) {
                insertText = ` ŸÖÿÆŸÅÿ∂ ÿ¥Ÿáÿ±ŸäŸÜ: ${formatNumberEnglish(reports.twoMonths.total.profit || 0)} ÿØŸäŸÜÿßÿ± ÿπÿ±ÿßŸÇŸä`;
            } else if (type === 'total') {
                const totalBasic = reports.basic?.total.amount || 0;
                const totalAdvanced = reports.advanced?.total.profit || 0;
                const totalTwoMonths = reports.twoMonths?.total.profit || 0;
                const total = totalBasic + totalAdvanced + totalTwoMonths;
                insertText = ` ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÉŸÑŸä: ${formatNumberEnglish(total)} ÿØŸäŸÜÿßÿ± ÿπÿ±ÿßŸÇŸä`;
            }
            if (insertText) {
                textarea.value = textBefore + insertText + '\n' + textAfter;
                textarea.selectionStart = textarea.selectionEnd = cursorPos + insertText.length + 1;
            }
        }
        function formatNumberEnglish(num) {
            if (num === null || num === undefined || isNaN(num)) return '0';
            return new Intl.NumberFormat('en-US').format(Math.floor(num));
        }
        function addOffersToMessage(message, agentName) {
            const reports = agentReports[agentName] || {};
            const totalBasic = reports.basic?.total.amount || 0;
            const totalAdvanced = reports.advanced?.total.profit || 0;
            const totalTwoMonths = reports.twoMonths?.total.profit || 0;
            let finalMessage = message;
            const hasDetailedTable = finalMessage.includes('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ') || 
                                     finalMessage.includes('ÿπÿØÿØ ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉÿßÿ™:') ||
                                     finalMessage.includes('ÿßŸÑÿ≥ÿπÿ±:') ||
                                     finalMessage.includes('ÿßŸÑŸÖÿ¨ŸÖŸàÿπ:');
            const hasBasicInMessage = finalMessage.includes('ÿßŸÑÿπÿ±ÿ∂ ÿßŸÑŸÖÿ¨ÿßŸÜŸä') || 
                                     finalMessage.includes('ÿßÿ¥ÿ™ÿ±ÿßŸÉ ÿßŸÑÿπÿ±ÿ∂ ÿßŸÑŸÖÿ¨ÿßŸÜŸä') ||
                                     finalMessage.includes('ÿßŸÑŸÖÿ¨ÿßŸÜŸä:') ||
                                     finalMessage.match(/ÿßŸÑŸÖÿ¨ÿßŸÜŸä[:\s]+[\d,]+/);
            const hasAdvancedInMessage = finalMessage.includes('ŸÖÿÆŸÅÿ∂ 3 ÿ£ÿ¥Ÿáÿ±') || 
                                         finalMessage.includes('ŸÖÿÆŸÅÿ∂ 3') ||
                                         finalMessage.includes('ÿ´ŸÑÿßÿ´ÿ© ÿ£ÿ¥Ÿáÿ±') ||
                                         finalMessage.includes('ÿ´ŸÑÿßÿ´ ÿ£ÿ¥Ÿáÿ±') ||
                                         finalMessage.includes('ÿßŸÑÿπÿ±ÿ∂ ÿßŸÑŸÖÿÆŸÅŸëŸéÿ∂ ŸÑÿ´ŸÑÿßÿ´ÿ© ÿ£ÿ¥Ÿáÿ±') ||
                                         finalMessage.includes('ÿßŸÑÿπÿ±ÿ∂ ÿßŸÑŸÖÿÆŸÅÿ∂ ŸÑÿ´ŸÑÿßÿ´ÿ© ÿ£ÿ¥Ÿáÿ±') ||
                                         finalMessage.match(/ŸÖÿÆŸÅ[ÿ∂ŸÅ]\s*3/);
            const hasTwoMonthsInMessage = finalMessage.includes('ŸÖÿÆŸÅÿ∂ ÿ¥Ÿáÿ±ŸäŸÜ') || 
                                          finalMessage.includes('ŸÖÿÆŸÅÿ∂ ÿ¥Ÿáÿ±ŸäŸÜ') ||
                                          finalMessage.includes('ÿ¥Ÿáÿ±ŸäŸÜ') ||
                                          finalMessage.includes('ÿßŸÑÿπÿ±ÿ∂ ÿßŸÑŸÖÿÆŸÅŸëŸéÿ∂ ŸÑÿ¥Ÿáÿ±ŸäŸÜ') ||
                                          finalMessage.includes('ÿßŸÑÿπÿ±ÿ∂ ÿßŸÑŸÖÿÆŸÅÿ∂ ŸÑÿ¥Ÿáÿ±ŸäŸÜ') ||
                                          finalMessage.match(/ŸÖÿÆŸÅ[ÿ∂ŸÅ]\s*ÿ¥Ÿáÿ±ŸäŸÜ/);
            const hasTotalInMessage = finalMessage.includes('ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÉŸÑŸä') || 
                                     finalMessage.includes('ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä:');
            if (hasDetailedTable) {
                return finalMessage;
            }
            if (totalBasic > 0 && !hasBasicInMessage) {
                finalMessage += `\n\n*ÿßŸÑÿπÿ±ÿ∂ ÿßŸÑŸÖÿ¨ÿßŸÜŸä*\n`;
                finalMessage += generateSubscriptionTable(reports.basic, 'basic');
            }
            if (totalAdvanced > 0 && !hasAdvancedInMessage) {
                finalMessage += `\n\n*ÿßŸÑÿπÿ±ÿ∂ ÿßŸÑŸÖÿÆŸÅÿ∂ ŸÑÿ´ŸÑÿßÿ´ÿ© ÿ£ÿ¥Ÿáÿ±*\n`;
                finalMessage += generateSubscriptionTable(reports.advanced, 'advanced');
            }
            if (totalTwoMonths > 0 && !hasTwoMonthsInMessage) {
                finalMessage += `\n\n*ÿßŸÑÿπÿ±ÿ∂ ÿßŸÑŸÖÿÆŸÅÿ∂ ŸÑÿ¥Ÿáÿ±ŸäŸÜ*\n`;
                finalMessage += generateSubscriptionTable(reports.twoMonths, 'twoMonths');
            }
                const total = totalBasic + totalAdvanced + totalTwoMonths;
            if (total > 0 && !hasTotalInMessage) {
                finalMessage += `\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
                finalMessage += `*ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÉŸÑŸä: ${formatNumberEnglish(total)} ÿØŸäŸÜÿßÿ± ÿπÿ±ÿßŸÇŸä*\n`;
            }
            return finalMessage;
        }
        function sendCustomizedWhatsAppMessage() {
            const agentName = document.getElementById('customMessageAgentName').getAttribute('data-agent');
            const agent = agentsList.find(a => a.name === agentName);
            if (!agent || !agent.phone) {
                alert('ÿÆÿ∑ÿ£ ŸÅŸä ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸàŸÉŸäŸÑ');
                return;
            }
            let message = document.getElementById('customMessageText').value.trim();
            if (!message) {
                alert('Ÿäÿ±ÿ¨Ÿâ ŸÉÿ™ÿßÿ®ÿ© ÿ±ÿ≥ÿßŸÑÿ© ŸÇÿ®ŸÑ ÿßŸÑÿ•ÿ±ÿ≥ÿßŸÑ');
                return;
            }
            message = addOffersToMessage(message, agentName);
            const fileType = 'excel';
            const fileInfo = getFileTypeInfo(fileType, agentName);
            const fileBlobPromise = getFileBlobPromise(agentName, fileType);
            fileBlobPromise.then((fileBlob) => {
                const phone = formatPhoneForWhatsApp(agent.phone);
                downloadFile(fileBlob, fileInfo.filename);
                const whatsappUrl = `https://wa.me/${phone}?text=${encodeURIComponent(message)}`;
                window.open(whatsappUrl, '_blank');
                logActivity('ÿ•ÿ±ÿ≥ÿßŸÑ ÿ™ŸÇÿ±Ÿäÿ± Ÿàÿßÿ™ÿ≥ÿßÿ®', `ÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ ŸÖŸÑŸÅ ${fileInfo.typeName} ŸÑŸÑŸàŸÉŸäŸÑ: ${agentName}`);
                closeMessageCustomizationModal();
            }).catch((error) => {
                console.error('Error generating file:', error);
                alert(`ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿ•ŸÜÿ¥ÿßÿ° ŸÖŸÑŸÅ ${fileInfo.typeName}. Ÿäÿ±ÿ¨Ÿâ ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ© ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ.`);
            });
        }
        function sendViaEmail() {
            const agentName = document.getElementById('customMessageAgentName').getAttribute('data-agent');
            const agent = agentsList.find(a => a.name === agentName);
            if (!agent || !agent.email) {
                alert('ŸÑŸÖ Ÿäÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿØ ÿ®ÿ±ŸäÿØ ÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä ŸÑŸÑŸàŸÉŸäŸÑ');
                return;
            }
            let message = document.getElementById('customMessageText').value.trim();
            if (!message) {
                alert('Ÿäÿ±ÿ¨Ÿâ ŸÉÿ™ÿßÿ®ÿ© ÿ±ÿ≥ÿßŸÑÿ© ŸÇÿ®ŸÑ ÿßŸÑÿ•ÿ±ÿ≥ÿßŸÑ');
                return;
            }
            message = addOffersToMessage(message, agentName);
            const fileType = 'excel';
            const fileInfo = getFileTypeInfo(fileType, agentName);
            const fileBlobPromise = getFileBlobPromise(agentName, fileType);
            fileBlobPromise.then(async (fileBlob) => {
                const subject = `ÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑŸÖÿ®ÿßŸÑÿ∫ ÿßŸÑŸÖÿ≥ÿ™ÿ≠ŸÇÿ© - ${agentName}`;
                const emailBody = encodeURIComponent(message);
                downloadFile(fileBlob, fileInfo.filename);
                const mailtoLink = `mailto:${agent.email}?subject=${encodeURIComponent(subject)}&body=${emailBody}`;
                window.location.href = mailtoLink;
                logActivity('ÿ•ÿ±ÿ≥ÿßŸÑ ÿ™ŸÇÿ±Ÿäÿ± ÿπÿ®ÿ± ÿßŸÑÿ®ÿ±ŸäÿØ', `ÿ™ŸÖ ÿ™ÿ≠ÿ∂Ÿäÿ± ŸÖŸÑŸÅ ${fileInfo.typeName} ŸàŸÅÿ™ÿ≠ ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä ŸÑŸÑŸàŸÉŸäŸÑ: ${agentName}`);
                showSuccessMessage(`ÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ ŸÖŸÑŸÅ ${fileInfo.typeName}. ÿ≥Ÿäÿ™ŸÖ ŸÅÿ™ÿ≠ ÿ®ÿ±ŸÜÿßŸÖÿ¨ ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä. Ÿäÿ±ÿ¨Ÿâ ÿ•ÿ±ŸÅÿßŸÇ ÿßŸÑŸÖŸÑŸÅ ŸäÿØŸàŸäÿßŸã.`);
                closeMessageCustomizationModal();
            }).catch((error) => {
                console.error('Error generating file:', error);
                alert(`ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿ•ŸÜÿ¥ÿßÿ° ŸÖŸÑŸÅ ${fileInfo.typeName}. Ÿäÿ±ÿ¨Ÿâ ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ© ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ.`);
            });
        }
        function arabicTextToImage(text, fontSize, color, width = 170) {
            return new Promise((resolve) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                ctx.font = `${fontSize}px Tajawal`;
                ctx.fillStyle = color;
                ctx.textAlign = 'right';
                ctx.textBaseline = 'middle';
                const metrics = ctx.measureText(text);
                canvas.width = Math.max(width, metrics.width + 20);
                canvas.height = fontSize + 10;
                ctx.font = `${fontSize}px Tajawal`;
                ctx.fillStyle = color;
                ctx.textAlign = 'right';
                ctx.textBaseline = 'middle';
                ctx.fillText(text, canvas.width - 10, canvas.height / 2);
                canvas.toBlob((blob) => {
                    const reader = new FileReader();
                    reader.onload = () => {
                        resolve(reader.result);
                    };
                    reader.readAsDataURL(blob);
                }, 'image/png');
            });
        }
        function generatePDFReportBlob(agentName) {
            return new Promise(async (resolve, reject) => {
                try {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF('landscape');
                    const reportInfo = getReportInfo(agentName);
                    const { reportType, reportData, reportTitle, agent, dateFrom, dateTo } = reportInfo;
                    let yPos = 15;
                    const startX = 10;
                    const pageWidth = doc.internal.pageSize.getWidth();
                    const titleImage = await arabicTextToImage(reportTitle, 11, '#000000', pageWidth - 20);
                    doc.addImage(titleImage, 'PNG', startX, yPos, pageWidth - 20, 8);
                    yPos += 12;
                    const colWidths = {
                        serial: 12,
                        agentName: 40,
                        platinumPrice: 15,
                        platinumCount: 12,
                        goldPrice: 15,
                        goldCount: 12,
                        silverPrice: 15,
                        silverCount: 12,
                        bronzePrice: 15,
                        bronzeCount: 12,
                        totalSubs: 18,
                        totalAmount: 20,
                        dateFrom: 18,
                        dateTo: 18
                    };
                    const totalTableWidth = Object.values(colWidths).reduce((a, b) => a + b, 0);
                    const tableStartX = (pageWidth - totalTableWidth) / 2;
                    yPos += 2;
                    const header1Height = 8;
                    const header2Height = 7;
                    const header3Height = 6;
                    doc.setFillColor(173, 216, 230);
                    doc.rect(tableStartX, yPos, colWidths.serial, header1Height + header2Height + header3Height, 'F');
                    const serialHeaderImg = await arabicTextToImage('ÿ™', 10, '#000000', colWidths.serial);
                    doc.addImage(serialHeaderImg, 'PNG', tableStartX + 2, yPos + header1Height + header2Height + 2, colWidths.serial - 4, 4);
                    doc.rect(tableStartX + colWidths.serial, yPos, colWidths.agentName, header1Height + header2Height + header3Height, 'F');
                    const agentNameHeaderImg = await arabicTextToImage('ÿßÿ≥ŸÖ ÿßŸÑŸàŸÉŸäŸÑ', 10, '#000000', colWidths.agentName);
                    doc.addImage(agentNameHeaderImg, 'PNG', tableStartX + colWidths.serial + 2, yPos + header1Height + header2Height + 2, colWidths.agentName - 4, 4);
                    const categoryWidth = colWidths.platinumPrice + colWidths.platinumCount + 
                                         colWidths.goldPrice + colWidths.goldCount + 
                                         colWidths.silverPrice + colWidths.silverCount + 
                                         colWidths.bronzePrice + colWidths.bronzeCount;
                    doc.rect(tableStartX + colWidths.serial + colWidths.agentName, yPos, categoryWidth, header1Height, 'F');
                    const categoryHeaderImg = await arabicTextToImage('ÿßŸÑŸÅÿ¶ÿ©', 10, '#000000', categoryWidth);
                    doc.addImage(categoryHeaderImg, 'PNG', tableStartX + colWidths.serial + colWidths.agentName + categoryWidth/2 - 15, yPos + 2, 30, 4);
                    doc.rect(tableStartX + colWidths.serial + colWidths.agentName + categoryWidth, yPos, colWidths.totalSubs, header1Height + header2Height + header3Height, 'F');
                    const totalSubsHeaderImg = await arabicTextToImage('ŸÖÿ¨ŸÖŸàÿπ ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉÿßÿ™', 9, '#000000', colWidths.totalSubs);
                    doc.addImage(totalSubsHeaderImg, 'PNG', tableStartX + colWidths.serial + colWidths.agentName + categoryWidth + 2, yPos + header1Height + header2Height + 2, colWidths.totalSubs - 4, 4);
                    doc.rect(tableStartX + colWidths.serial + colWidths.agentName + categoryWidth + colWidths.totalSubs, yPos, colWidths.totalAmount, header1Height + header2Height + header3Height, 'F');
                    const totalAmountHeaderImg = await arabicTextToImage('ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä', 9, '#000000', colWidths.totalAmount);
                    doc.addImage(totalAmountHeaderImg, 'PNG', tableStartX + colWidths.serial + colWidths.agentName + categoryWidth + colWidths.totalSubs + 2, yPos + header1Height + header2Height + 2, colWidths.totalAmount - 4, 4);
                    const dateWidth = colWidths.dateFrom + colWidths.dateTo;
                    doc.rect(tableStartX + colWidths.serial + colWidths.agentName + categoryWidth + colWidths.totalSubs + colWidths.totalAmount, yPos, dateWidth, header1Height, 'F');
                    const dateHeaderImg = await arabicTextToImage('ÿßŸÑÿ™ÿßÿ±ŸäÿÆ', 10, '#000000', dateWidth);
                    doc.addImage(dateHeaderImg, 'PNG', tableStartX + colWidths.serial + colWidths.agentName + categoryWidth + colWidths.totalSubs + colWidths.totalAmount + dateWidth/2 - 12, yPos + 2, 24, 4);
                    let currentX = tableStartX + colWidths.serial + colWidths.agentName;
                    doc.setFillColor(173, 216, 230);
                    doc.rect(currentX, yPos + header1Height, colWidths.platinumPrice + colWidths.platinumCount, header2Height, 'F');
                    const platinumHeaderImg = await arabicTextToImage('ÿ®ŸÑÿßÿ™ŸäŸÜŸäŸàŸÖ', 9, '#000000', colWidths.platinumPrice + colWidths.platinumCount);
                    doc.addImage(platinumHeaderImg, 'PNG', currentX + (colWidths.platinumPrice + colWidths.platinumCount)/2 - 15, yPos + header1Height + 1.5, 30, 4);
                    currentX += colWidths.platinumPrice + colWidths.platinumCount;
                    doc.rect(currentX, yPos + header1Height, colWidths.goldPrice + colWidths.goldCount, header2Height, 'F');
                    const goldHeaderImg = await arabicTextToImage('ŸÉŸàŸÑÿØ', 9, '#000000', colWidths.goldPrice + colWidths.goldCount);
                    doc.addImage(goldHeaderImg, 'PNG', currentX + (colWidths.goldPrice + colWidths.goldCount)/2 - 10, yPos + header1Height + 1.5, 20, 4);
                    currentX += colWidths.goldPrice + colWidths.goldCount;
                    doc.rect(currentX, yPos + header1Height, colWidths.silverPrice + colWidths.silverCount, header2Height, 'F');
                    const silverHeaderImg = await arabicTextToImage('ÿ≥ŸÑŸÅÿ±', 9, '#000000', colWidths.silverPrice + colWidths.silverCount);
                    doc.addImage(silverHeaderImg, 'PNG', currentX + (colWidths.silverPrice + colWidths.silverCount)/2 - 10, yPos + header1Height + 1.5, 20, 4);
                    currentX += colWidths.silverPrice + colWidths.silverCount;
                    doc.rect(currentX, yPos + header1Height, colWidths.bronzePrice + colWidths.bronzeCount, header2Height, 'F');
                    const bronzeHeaderImg = await arabicTextToImage('ÿ®ÿ±ŸàŸÜÿ≤', 9, '#000000', colWidths.bronzePrice + colWidths.bronzeCount);
                    doc.addImage(bronzeHeaderImg, 'PNG', currentX + (colWidths.bronzePrice + colWidths.bronzeCount)/2 - 10, yPos + header1Height + 1.5, 20, 4);
                    currentX = tableStartX + colWidths.serial + colWidths.agentName + categoryWidth + colWidths.totalSubs + colWidths.totalAmount;
                    doc.rect(currentX, yPos + header1Height, colWidths.dateFrom, header2Height + header3Height, 'F');
                    const dateFromHeaderImg = await arabicTextToImage('ŸÖŸÜ', 9, '#000000', colWidths.dateFrom);
                    doc.addImage(dateFromHeaderImg, 'PNG', currentX + colWidths.dateFrom/2 - 8, yPos + header1Height + header2Height + 1.5, 16, 4);
                    currentX += colWidths.dateFrom;
                    doc.rect(currentX, yPos + header1Height, colWidths.dateTo, header2Height + header3Height, 'F');
                    const dateToHeaderImg = await arabicTextToImage('ÿßŸÑŸâ', 9, '#000000', colWidths.dateTo);
                    doc.addImage(dateToHeaderImg, 'PNG', currentX + colWidths.dateTo/2 - 8, yPos + header1Height + header2Height + 1.5, 16, 4);
                    currentX = tableStartX + colWidths.serial + colWidths.agentName;
                    doc.setFillColor(173, 216, 230);
                    const priceLabelImg = await arabicTextToImage('ÿßŸÑÿ≥ÿπÿ±', 8, '#000000', 15);
                    const countLabelImg = await arabicTextToImage('ÿπÿØÿØ ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉÿßÿ™', 8, '#000000', 12);
                    doc.rect(currentX, yPos + header1Height + header2Height, colWidths.platinumPrice, header3Height, 'F');
                    doc.addImage(priceLabelImg, 'PNG', currentX + 2, yPos + header1Height + header2Height + 1, colWidths.platinumPrice - 4, 3.5);
                    currentX += colWidths.platinumPrice;
                    doc.rect(currentX, yPos + header1Height + header2Height, colWidths.platinumCount, header3Height, 'F');
                    doc.addImage(countLabelImg, 'PNG', currentX + 1, yPos + header1Height + header2Height + 1, colWidths.platinumCount - 2, 3.5);
                    currentX += colWidths.platinumCount;
                    doc.rect(currentX, yPos + header1Height + header2Height, colWidths.goldPrice, header3Height, 'F');
                    doc.addImage(priceLabelImg, 'PNG', currentX + 2, yPos + header1Height + header2Height + 1, colWidths.goldPrice - 4, 3.5);
                    currentX += colWidths.goldPrice;
                    doc.rect(currentX, yPos + header1Height + header2Height, colWidths.goldCount, header3Height, 'F');
                    doc.addImage(countLabelImg, 'PNG', currentX + 1, yPos + header1Height + header2Height + 1, colWidths.goldCount - 2, 3.5);
                    currentX += colWidths.goldCount;
                    doc.rect(currentX, yPos + header1Height + header2Height, colWidths.silverPrice, header3Height, 'F');
                    doc.addImage(priceLabelImg, 'PNG', currentX + 2, yPos + header1Height + header2Height + 1, colWidths.silverPrice - 4, 3.5);
                    currentX += colWidths.silverPrice;
                    doc.rect(currentX, yPos + header1Height + header2Height, colWidths.silverCount, header3Height, 'F');
                    doc.addImage(countLabelImg, 'PNG', currentX + 1, yPos + header1Height + header2Height + 1, colWidths.silverCount - 2, 3.5);
                    currentX += colWidths.silverCount;
                    doc.rect(currentX, yPos + header1Height + header2Height, colWidths.bronzePrice, header3Height, 'F');
                    doc.addImage(priceLabelImg, 'PNG', currentX + 2, yPos + header1Height + header2Height + 1, colWidths.bronzePrice - 4, 3.5);
                    currentX += colWidths.bronzePrice;
                    doc.rect(currentX, yPos + header1Height + header2Height, colWidths.bronzeCount, header3Height, 'F');
                    doc.addImage(countLabelImg, 'PNG', currentX + 1, yPos + header1Height + header2Height + 1, colWidths.bronzeCount - 2, 3.5);
                    doc.setDrawColor(0, 0, 0);
                    doc.setLineWidth(0.1);
                    let headerX = tableStartX;
                    for (let key in colWidths) {
                        doc.rect(headerX, yPos, colWidths[key], header1Height + header2Height + header3Height, 'S');
                        headerX += colWidths[key];
                    }
                    doc.rect(tableStartX + colWidths.serial + colWidths.agentName, yPos + header1Height, categoryWidth, header2Height, 'S');
                    doc.rect(tableStartX + colWidths.serial + colWidths.agentName + categoryWidth + colWidths.totalSubs + colWidths.totalAmount, yPos + header1Height, dateWidth, header2Height, 'S');
                    doc.rect(tableStartX + colWidths.serial + colWidths.agentName + categoryWidth + colWidths.totalSubs + colWidths.totalAmount, yPos + header1Height + header2Height, dateWidth, header3Height, 'S');
                    yPos += header1Height + header2Height + header3Height;
                    const cellHeight = 10;
                    doc.setFillColor(255, 255, 255);
                    doc.rect(tableStartX, yPos, totalTableWidth, cellHeight, 'F');
                    doc.setDrawColor(0, 0, 0);
                    doc.rect(tableStartX, yPos, totalTableWidth, cellHeight, 'S');
                    doc.text('1', tableStartX + colWidths.serial/2, yPos + 7, { align: 'center' });
                    doc.rect(tableStartX, yPos, colWidths.serial, cellHeight, 'S');
                    const agentNameText = agentName + (agent?.email ? ' / ' + agent.email : '');
                    const agentNameImg = await arabicTextToImage(agentNameText, 9, '#000000', colWidths.agentName - 4);
                    doc.addImage(agentNameImg, 'PNG', tableStartX + colWidths.serial + 2, yPos + 2, colWidths.agentName - 4, 6);
                    doc.rect(tableStartX + colWidths.serial, yPos, colWidths.agentName, cellHeight, 'S');
                    currentX = tableStartX + colWidths.serial + colWidths.agentName;
                    const { platinumCount, platinumPrice, goldCount, goldPrice, 
                            silverCount, silverPrice, bronzeCount, bronzePrice, 
                            totalSubs, totalAmount } = calculateCategoryPricesAndCounts(reportData, reportType);
                    doc.text(formatNumber(Math.round(platinumPrice)), currentX + colWidths.platinumPrice/2, yPos + 7, { align: 'center' });
                    doc.rect(currentX, yPos, colWidths.platinumPrice, cellHeight, 'S');
                    currentX += colWidths.platinumPrice;
                    doc.text(String(platinumCount), currentX + colWidths.platinumCount/2, yPos + 7, { align: 'center' });
                    doc.rect(currentX, yPos, colWidths.platinumCount, cellHeight, 'S');
                    currentX += colWidths.platinumCount;
                    doc.text(formatNumber(Math.round(goldPrice)), currentX + colWidths.goldPrice/2, yPos + 7, { align: 'center' });
                    doc.rect(currentX, yPos, colWidths.goldPrice, cellHeight, 'S');
                    currentX += colWidths.goldPrice;
                    doc.text(String(goldCount), currentX + colWidths.goldCount/2, yPos + 7, { align: 'center' });
                    doc.rect(currentX, yPos, colWidths.goldCount, cellHeight, 'S');
                    currentX += colWidths.goldCount;
                    doc.text(formatNumber(Math.round(silverPrice)), currentX + colWidths.silverPrice/2, yPos + 7, { align: 'center' });
                    doc.rect(currentX, yPos, colWidths.silverPrice, cellHeight, 'S');
                    currentX += colWidths.silverPrice;
                    doc.text(String(silverCount), currentX + colWidths.silverCount/2, yPos + 7, { align: 'center' });
                    doc.rect(currentX, yPos, colWidths.silverCount, cellHeight, 'S');
                    currentX += colWidths.silverCount;
                    doc.text(formatNumber(Math.round(bronzePrice)), currentX + colWidths.bronzePrice/2, yPos + 7, { align: 'center' });
                    doc.rect(currentX, yPos, colWidths.bronzePrice, cellHeight, 'S');
                    currentX += colWidths.bronzePrice;
                    doc.text(String(bronzeCount), currentX + colWidths.bronzeCount/2, yPos + 7, { align: 'center' });
                    doc.rect(currentX, yPos, colWidths.bronzeCount, cellHeight, 'S');
                    currentX += colWidths.bronzeCount;
                    doc.text(String(totalSubs), currentX + colWidths.totalSubs/2, yPos + 7, { align: 'center' });
                    doc.rect(currentX, yPos, colWidths.totalSubs, cellHeight, 'S');
                    currentX += colWidths.totalSubs;
                    doc.text(formatNumber(totalAmount), currentX + colWidths.totalAmount/2, yPos + 7, { align: 'center' });
                    doc.rect(currentX, yPos, colWidths.totalAmount, cellHeight, 'S');
                    currentX += colWidths.totalAmount;
                    doc.text(dateFrom, currentX + colWidths.dateFrom/2, yPos + 7, { align: 'center' });
                    doc.rect(currentX, yPos, colWidths.dateFrom, cellHeight, 'S');
                    currentX += colWidths.dateFrom;
                    doc.text(dateTo, currentX + colWidths.dateTo/2, yPos + 7, { align: 'center' });
                    doc.rect(currentX, yPos, colWidths.dateTo, cellHeight, 'S');
                    yPos += cellHeight;
                    doc.setFillColor(200, 200, 200);
                    doc.rect(tableStartX, yPos, totalTableWidth, cellHeight, 'F');
                    doc.setDrawColor(0, 0, 0);
                    doc.rect(tableStartX, yPos, totalTableWidth, cellHeight, 'S');
                    const totalLabelImg = await arabicTextToImage('ÿßŸÑŸÖÿ¨ŸÖŸàÿπ', 9, '#000000', colWidths.serial + colWidths.agentName);
                    doc.addImage(totalLabelImg, 'PNG', tableStartX + 2, yPos + 2, colWidths.serial + colWidths.agentName - 4, 6);
                    doc.rect(tableStartX, yPos, colWidths.serial + colWidths.agentName, cellHeight, 'S');
                    currentX = tableStartX + colWidths.serial + colWidths.agentName;
                    doc.text('', currentX + colWidths.platinumPrice/2, yPos + 7, { align: 'center' });
                    doc.rect(currentX, yPos, colWidths.platinumPrice, cellHeight, 'S');
                    currentX += colWidths.platinumPrice;
                    doc.text(String(platinumCount), currentX + colWidths.platinumCount/2, yPos + 7, { align: 'center' });
                    doc.rect(currentX, yPos, colWidths.platinumCount, cellHeight, 'S');
                    currentX += colWidths.platinumCount;
                    doc.text('', currentX + colWidths.goldPrice/2, yPos + 7, { align: 'center' });
                    doc.rect(currentX, yPos, colWidths.goldPrice, cellHeight, 'S');
                    currentX += colWidths.goldPrice;
                    doc.text(String(goldCount), currentX + colWidths.goldCount/2, yPos + 7, { align: 'center' });
                    doc.rect(currentX, yPos, colWidths.goldCount, cellHeight, 'S');
                    currentX += colWidths.goldCount;
                    doc.text('', currentX + colWidths.silverPrice/2, yPos + 7, { align: 'center' });
                    doc.rect(currentX, yPos, colWidths.silverPrice, cellHeight, 'S');
                    currentX += colWidths.silverPrice;
                    doc.text(String(silverCount), currentX + colWidths.silverCount/2, yPos + 7, { align: 'center' });
                    doc.rect(currentX, yPos, colWidths.silverCount, cellHeight, 'S');
                    currentX += colWidths.silverCount;
                    doc.text('', currentX + colWidths.bronzePrice/2, yPos + 7, { align: 'center' });
                    doc.rect(currentX, yPos, colWidths.bronzePrice, cellHeight, 'S');
                    currentX += colWidths.bronzePrice;
                    doc.text(String(bronzeCount), currentX + colWidths.bronzeCount/2, yPos + 7, { align: 'center' });
                    doc.rect(currentX, yPos, colWidths.bronzeCount, cellHeight, 'S');
                    currentX += colWidths.bronzeCount;
                    doc.text(String(totalSubs), currentX + colWidths.totalSubs/2, yPos + 7, { align: 'center' });
                    doc.rect(currentX, yPos, colWidths.totalSubs, cellHeight, 'S');
                    currentX += colWidths.totalSubs;
                    doc.text(formatNumber(totalAmount), currentX + colWidths.totalAmount/2, yPos + 7, { align: 'center' });
                    doc.rect(currentX, yPos, colWidths.totalAmount, cellHeight, 'S');
                    currentX += colWidths.totalAmount;
                    doc.text('', currentX + colWidths.dateFrom/2, yPos + 7, { align: 'center' });
                    doc.rect(currentX, yPos, colWidths.dateFrom, cellHeight, 'S');
                    currentX += colWidths.dateFrom;
                    doc.text('', currentX + colWidths.dateTo/2, yPos + 7, { align: 'center' });
                    doc.rect(currentX, yPos, colWidths.dateTo, cellHeight, 'S');
                    const pdfBlob = doc.output('blob');
                    resolve(pdfBlob);
                } catch (error) {
                    reject(error);
                }
            });
        }
        function generateExcelReportBlob(agentName) {
            return new Promise(async (resolve, reject) => {
                try {
                    const reportInfo = getReportInfo(agentName);
                    const { reportType, reportData, reportTitle, agent, dateFrom, dateTo } = reportInfo;
                    const reports = agentReports[agentName] || {};
                    const hasBasic = reports.basic && reports.basic.total && reports.basic.total.count > 0;
                    const hasAdvanced = reports.advanced && reports.advanced.total && reports.advanced.total.count > 0;
                    const hasTwoMonths = reports.twoMonths && reports.twoMonths.total && reports.twoMonths.total.count > 0;
                    const ExcelJS = window.ExcelJS;
                    if (!ExcelJS) {
                        return generateExcelReportBlobXLSX(agentName).then(resolve).catch(reject);
                    }
                    const workbook = new ExcelJS.Workbook();
                    const worksheet = workbook.addWorksheet('ÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑŸàŸÉŸäŸÑ');
                    worksheet.columns = [
                        { width: 35, key: 'type' },
                        { width: 20, key: 'count' },
                        { width: 20, key: 'price' },
                        { width: 20, key: 'total' }
                    ];
                    let currentRow = 1;
                    const titleRow = worksheet.getRow(currentRow);
                    titleRow.getCell(1).value = reportTitle || 'ÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑŸÖÿ®ÿßŸÑÿ∫ ÿßŸÑŸÖÿ≥ÿ™ÿ≠ŸÇÿ©';
                    titleRow.getCell(1).font = { bold: true, size: 18, color: { argb: 'FF801C32' } };
                    titleRow.getCell(1).alignment = { horizontal: 'center', vertical: 'middle' };
                    worksheet.mergeCells(currentRow, 1, currentRow, 4);
                    titleRow.height = 30;
                    currentRow++;
                    currentRow++;
                    worksheet.getRow(currentRow).getCell(1).value = `ÿßÿ≥ŸÖ ÿßŸÑŸàŸÉŸäŸÑ: ${agentName}`;
                    worksheet.getRow(currentRow).getCell(1).font = { bold: true, size: 12 };
                    currentRow++;
                    if (agent?.email) {
                        worksheet.getRow(currentRow).getCell(1).value = `ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä: ${agent.email}`;
                        worksheet.getRow(currentRow).getCell(1).font = { size: 12 };
                        currentRow++;
                    }
                    if (agent?.phone) {
                        worksheet.getRow(currentRow).getCell(1).value = `ÿ±ŸÇŸÖ ÿßŸÑŸáÿßÿ™ŸÅ: ${agent.phone}`;
                        worksheet.getRow(currentRow).getCell(1).font = { size: 12 };
                        currentRow++;
                    }
                    currentRow++;
                    const createTable = (title, data, startRow) => {
                        let row = startRow;
                        const sectionRow = worksheet.getRow(row);
                        sectionRow.getCell(1).value = title;
                        sectionRow.getCell(1).font = { bold: true, size: 14, color: { argb: 'FF801C32' } };
                        sectionRow.getCell(1).fill = {
                            type: 'pattern',
                            pattern: 'solid',
                            fgColor: { argb: 'FFF8F9FA' }
                        };
                        sectionRow.getCell(1).alignment = { horizontal: 'right', vertical: 'middle' };
                        sectionRow.getCell(1).border = {
                            top: { style: 'thin', color: { argb: 'FF801C32' } },
                            bottom: { style: 'thin', color: { argb: 'FF801C32' } },
                            left: { style: 'thin', color: { argb: 'FF801C32' } },
                            right: { style: 'thin', color: { argb: 'FF801C32' } }
                        };
                        worksheet.mergeCells(row, 1, row, 4);
                        sectionRow.height = 25;
                        row++;
                        const headerRow = worksheet.getRow(row);
                        const headers = ['ŸÜŸàÿπ ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ', 'ÿπÿØÿØ ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉÿßÿ™', 'ÿßŸÑÿ≥ÿπÿ± ÿßŸÑŸàÿßÿ≠ÿØ (ÿØ.ÿπ)', 'ÿßŸÑŸÖÿ¨ŸÖŸàÿπ (ÿØ.ÿπ)'];
                        headers.forEach((header, idx) => {
                            const cell = headerRow.getCell(idx + 1);
                            cell.value = header;
                            cell.font = { bold: true, size: 12, color: { argb: 'FFFFFFFF' } };
                            cell.fill = {
                                type: 'pattern',
                                pattern: 'solid',
                                fgColor: { argb: 'FF801C32' }
                            };
                            cell.alignment = { horizontal: 'center', vertical: 'middle', wrapText: true };
                            cell.border = {
                                top: { style: 'thin', color: { argb: 'FFFFFFFF' } },
                                bottom: { style: 'thin', color: { argb: 'FFFFFFFF' } },
                                left: { style: 'thin', color: { argb: 'FFFFFFFF' } },
                                right: { style: 'thin', color: { argb: 'FFFFFFFF' } }
                            };
                        });
                        headerRow.height = 25;
                        row++;
                        data.forEach((item, index) => {
                            const dataRow = worksheet.getRow(row);
                            const isTotalRow = item.type === 'ÿßŸÑŸÖÿ¨ŸÖŸàÿπ';
                            const isEven = index % 2 === 0;
                            const bgColor = isTotalRow ? 'FFE8F0F5' : (isEven ? 'FFFFFFFF' : 'FFF8F9FA');
                            dataRow.getCell(1).value = item.type;
                            dataRow.getCell(2).value = item.count;
                            dataRow.getCell(3).value = item.price || '';
                            dataRow.getCell(4).value = item.total;
                            for (let col = 1; col <= 4; col++) {
                                const cell = dataRow.getCell(col);
                                cell.font = isTotalRow ? { bold: true, size: 14 } : { size: 12 };
                                cell.fill = {
                                    type: 'pattern',
                                    pattern: 'solid',
                                    fgColor: { argb: bgColor }
                                };
                                cell.alignment = col === 1 ? 
                                    { horizontal: 'right', vertical: 'middle' } : 
                                    { horizontal: 'center', vertical: 'middle' };
                                cell.border = {
                                    top: { style: 'thin', color: { argb: 'FFDDDDDD' } },
                                    bottom: { style: 'thin', color: { argb: 'FFDDDDDD' } },
                                    left: { style: 'thin', color: { argb: 'FFDDDDDD' } },
                                    right: { style: 'thin', color: { argb: 'FFDDDDDD' } }
                                };
                            }
                            dataRow.height = 22;
                            row++;
                        });
                        row++;
                        return row;
                    };
                    if (hasBasic) {
                        const basicData = reports.basic;
                        const categories = [
                            { key: 'platinum', name: 'Platinum' },
                            { key: 'gold', name: 'Gold' },
                            { key: 'silver', name: 'Silver' },
                            { key: 'bronze', name: 'Bronze' }
                        ];
                        const tableData = [];
                        categories.forEach(cat => {
                            const category = basicData[cat.key] || { count: 0, amount: 0 };
                            const price = category.count > 0 ? Math.round((category.amount || 0) / category.count) : 0;
                            tableData.push({
                                type: cat.name,
                                count: formatNumberEnglish(category.count || 0),
                                price: formatNumberEnglish(price),
                                total: formatNumberEnglish(category.amount || 0)
                            });
                        });
                        tableData.push({
                            type: 'ÿßŸÑŸÖÿ¨ŸÖŸàÿπ',
                            count: formatNumberEnglish(basicData.total?.count || 0),
                            price: '',
                            total: formatNumberEnglish(basicData.total?.amount || 0)
                        });
                        currentRow = createTable('ÿßŸÑÿπÿ±ÿ∂ ÿßŸÑŸÖÿ¨ÿßŸÜŸä', tableData, currentRow);
                    }
                    if (hasAdvanced) {
                        const advancedData = reports.advanced;
                        const categories = [
                            { key: 'platinum', name: 'Platinum', category: 'P' },
                            { key: 'gold', name: 'Gold', category: 'G' },
                            { key: 'silver', name: 'Silver', category: 'S' },
                            { key: 'bronze', name: 'Bronze', category: 'B' }
                        ];
                        const tableData = [];
                        categories.forEach(cat => {
                            let category = advancedData[cat.key];
                            let count = 0;
                            let officialAmount = 0;
                            let promoAmount = 0;
                            if (category && (category.count > 0 || category.officialAmount > 0 || category.promoAmount > 0)) {
                                count = category.count || 0;
                                officialAmount = category.officialAmount || 0;
                                promoAmount = category.promoAmount || 0;
                            } else {
                                if (typeof advancedDetails !== 'undefined' && Array.isArray(advancedDetails) && advancedDetails.length > 0) {
                                    const currentAgentName = agentName || advancedData.agentName || '';
                                    const agentDetails = advancedDetails.filter(d => {
                                        const detailAgent = d.agent || d.Agent || d.agentName || d.AgentName || d['ÿßÿ≥ŸÖ ÿßŸÑŸàŸÉŸäŸÑ'] || d['ÿßŸÑŸàŸÉŸäŸÑ'] || '';
                                        const subType = d.subscription || d.Subscription || d['ŸÜŸàÿπ ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ'] || '';
                                        if (!detailAgent || detailAgent !== currentAgentName) return false;
                                        const detailCategory = getSubscriptionCategory(subType, detailAgent);
                                        return detailCategory === cat.category;
                                    });
                                    count = agentDetails.length;
                                    agentDetails.forEach(d => {
                                        const subType = d.subscription || d.Subscription || '';
                                        const detailAgent = d.agent || d.Agent || '';
                                        const detailCategory = getSubscriptionCategory(subType, detailAgent);
                                        if (detailCategory === cat.category) {
                                            const promo = d.promoPrice || getSubscriptionPrice(subType, detailCategory, 'advanced', 'promo');
                                            const official = d.officialPrice || getSubscriptionPrice(subType, detailCategory, 'advanced', 'official');
                                            promoAmount += promo || 0;
                                            officialAmount += official || 0;
                                        }
                                    });
                                }
                            }
                            const amount = officialAmount - promoAmount;
                            const price = count > 0 ? Math.round(amount / count) : 0;
                            tableData.push({
                                type: cat.name,
                                count: formatNumberEnglish(count),
                                price: formatNumberEnglish(price),
                                total: formatNumberEnglish(amount)
                            });
                        });
                        tableData.push({
                            type: 'ÿßŸÑŸÖÿ¨ŸÖŸàÿπ',
                            count: formatNumberEnglish(advancedData.total?.count || 0),
                            price: '',
                            total: formatNumberEnglish(advancedData.total?.profit || 0)
                        });
                        currentRow = createTable('ÿßŸÑÿπÿ±ÿ∂ ÿßŸÑŸÖÿÆŸÅÿ∂ ŸÑÿ´ŸÑÿßÿ´ÿ© ÿ£ÿ¥Ÿáÿ±', tableData, currentRow);
                    }
                    if (hasTwoMonths) {
                        const twoMonthsData = reports.twoMonths;
                        const categories = [
                            { key: 'platinum', name: 'Platinum' },
                            { key: 'gold', name: 'Gold' },
                            { key: 'silver', name: 'Silver' },
                            { key: 'bronze', name: 'Bronze' }
                        ];
                        const tableData = [];
                        categories.forEach(cat => {
                            const category = twoMonthsData[cat.key] || { count: 0, officialAmount: 0, promoAmount: 0 };
                            const amount = (category.officialAmount || 0) - (category.promoAmount || 0);
                            const price = category.count > 0 ? Math.round(amount / category.count) : 0;
                            tableData.push({
                                type: cat.name,
                                count: formatNumberEnglish(category.count || 0),
                                price: formatNumberEnglish(price),
                                total: formatNumberEnglish(amount)
                            });
                        });
                        tableData.push({
                            type: 'ÿßŸÑŸÖÿ¨ŸÖŸàÿπ',
                            count: formatNumberEnglish(twoMonthsData.total?.count || 0),
                            price: '',
                            total: formatNumberEnglish(twoMonthsData.total?.profit || 0)
                        });
                        currentRow = createTable('ÿßŸÑÿπÿ±ÿ∂ ÿßŸÑŸÖÿÆŸÅÿ∂ ŸÑÿ¥Ÿáÿ±ŸäŸÜ', tableData, currentRow);
                    }
                    const totalBasic = reports.basic?.total.amount || 0;
                    const totalAdvanced = reports.advanced?.total.profit || 0;
                    const totalTwoMonths = reports.twoMonths?.total.profit || 0;
                    const selectedTotal = totalBasic + totalAdvanced + totalTwoMonths;
                    if (selectedTotal > 0) {
                        currentRow++;
                        const totalSectionRow = worksheet.getRow(currentRow);
                        totalSectionRow.getCell(1).value = 'ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÉŸÑŸä';
                        totalSectionRow.getCell(1).font = { bold: true, size: 14, color: { argb: 'FF801C32' } };
                        totalSectionRow.getCell(1).fill = {
                            type: 'pattern',
                            pattern: 'solid',
                            fgColor: { argb: 'FFF8F9FA' }
                        };
                        totalSectionRow.getCell(1).border = {
                            top: { style: 'medium', color: { argb: 'FF801C32' } },
                            bottom: { style: 'medium', color: { argb: 'FF801C32' } },
                            left: { style: 'medium', color: { argb: 'FF801C32' } },
                            right: { style: 'medium', color: { argb: 'FF801C32' } }
                        };
                        worksheet.mergeCells(currentRow, 1, currentRow, 4);
                        totalSectionRow.height = 25;
                        currentRow++;
                        if (hasBasic) {
                            const row = worksheet.getRow(currentRow);
                            row.getCell(1).value = 'ÿßŸÑÿπÿ±ÿ∂ ÿßŸÑŸÖÿ¨ÿßŸÜŸä:';
                            row.getCell(4).value = formatNumberEnglish(totalBasic) + ' ÿØ.ÿπ';
                            row.getCell(1).font = { bold: true, size: 12 };
                            row.getCell(4).font = { bold: true, size: 12 };
                            row.getCell(4).alignment = { horizontal: 'center' };
                            currentRow++;
                        }
                        if (hasAdvanced) {
                            const row = worksheet.getRow(currentRow);
                            row.getCell(1).value = 'ÿßŸÑÿπÿ±ÿ∂ ÿßŸÑŸÖÿÆŸÅÿ∂ ŸÑÿ´ŸÑÿßÿ´ÿ© ÿ£ÿ¥Ÿáÿ±:';
                            row.getCell(4).value = formatNumberEnglish(totalAdvanced) + ' ÿØ.ÿπ';
                            row.getCell(1).font = { bold: true, size: 12 };
                            row.getCell(4).font = { bold: true, size: 12 };
                            row.getCell(4).alignment = { horizontal: 'center' };
                            currentRow++;
                        }
                        if (hasTwoMonths) {
                            const row = worksheet.getRow(currentRow);
                            row.getCell(1).value = 'ÿßŸÑÿπÿ±ÿ∂ ÿßŸÑŸÖÿÆŸÅÿ∂ ŸÑÿ¥Ÿáÿ±ŸäŸÜ:';
                            row.getCell(4).value = formatNumberEnglish(totalTwoMonths) + ' ÿØ.ÿπ';
                            row.getCell(1).font = { bold: true, size: 12 };
                            row.getCell(4).font = { bold: true, size: 12 };
                            row.getCell(4).alignment = { horizontal: 'center' };
                            currentRow++;
                        }
                        const finalTotalRow = worksheet.getRow(currentRow);
                        finalTotalRow.getCell(1).value = 'ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÉŸÑŸä:';
                        finalTotalRow.getCell(4).value = formatNumberEnglish(selectedTotal) + ' ÿØŸäŸÜÿßÿ± ÿπÿ±ÿßŸÇŸä';
                        finalTotalRow.getCell(1).font = { bold: true, size: 14, color: { argb: 'FF801C32' } };
                        finalTotalRow.getCell(4).font = { bold: true, size: 14, color: { argb: 'FF801C32' } };
                        finalTotalRow.getCell(4).alignment = { horizontal: 'center' };
                        finalTotalRow.getCell(1).fill = {
                            type: 'pattern',
                            pattern: 'solid',
                            fgColor: { argb: 'FFE8F0F5' }
                        };
                        finalTotalRow.getCell(4).fill = {
                            type: 'pattern',
                            pattern: 'solid',
                            fgColor: { argb: 'FFE8F0F5' }
                        };
                        finalTotalRow.getCell(1).border = {
                            top: { style: 'medium', color: { argb: 'FF801C32' } },
                            bottom: { style: 'medium', color: { argb: 'FF801C32' } },
                            left: { style: 'medium', color: { argb: 'FF801C32' } },
                            right: { style: 'thin', color: { argb: 'FF801C32' } }
                        };
                        finalTotalRow.getCell(4).border = {
                            top: { style: 'medium', color: { argb: 'FF801C32' } },
                            bottom: { style: 'medium', color: { argb: 'FF801C32' } },
                            left: { style: 'thin', color: { argb: 'FF801C32' } },
                            right: { style: 'medium', color: { argb: 'FF801C32' } }
                        };
                        finalTotalRow.height = 30;
                    }
                    const buffer = await workbook.xlsx.writeBuffer();
                    const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                    resolve(blob);
                } catch (error) {
                    console.error('Error generating Excel with ExcelJS:', error);
                    generateExcelReportBlobXLSX(agentName).then(resolve).catch(reject);
                }
            });
        }
        function generateExcelReportBlobXLSX(agentName) {
            return new Promise((resolve, reject) => {
                try {
                    const reportInfo = getReportInfo(agentName);
                    const { reportType, reportData, reportTitle, agent, dateFrom, dateTo } = reportInfo;
                    const reports = agentReports[agentName] || {};
                    const hasBasic = reports.basic && reports.basic.total && reports.basic.total.count > 0;
                    const hasAdvanced = reports.advanced && reports.advanced.total && reports.advanced.total.count > 0;
                    const hasTwoMonths = reports.twoMonths && reports.twoMonths.total && reports.twoMonths.total.count > 0;
                    const wsData = [];
                    wsData.push([reportTitle || 'ÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑŸÖÿ®ÿßŸÑÿ∫ ÿßŸÑŸÖÿ≥ÿ™ÿ≠ŸÇÿ©']);
                    wsData.push([`ÿßÿ≥ŸÖ ÿßŸÑŸàŸÉŸäŸÑ: ${agentName}`]);
                    if (hasBasic) {
                        wsData.push(['ÿßŸÑÿπÿ±ÿ∂ ÿßŸÑŸÖÿ¨ÿßŸÜŸä']);
                        wsData.push(['ŸÜŸàÿπ ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ', 'ÿπÿØÿØ ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉÿßÿ™', 'ÿßŸÑÿ≥ÿπÿ± ÿßŸÑŸàÿßÿ≠ÿØ (ÿØ.ÿπ)', 'ÿßŸÑŸÖÿ¨ŸÖŸàÿπ (ÿØ.ÿπ)']);
                        const basicData = reports.basic;
                        ['platinum', 'gold', 'silver', 'bronze'].forEach(key => {
                            const cat = basicData[key];
                            if (cat && cat.count > 0) {
                                const price = Math.round((cat.amount || 0) / cat.count);
                                wsData.push([
                                    key === 'platinum' ? 'ÿ®ŸÑÿßÿ™ŸäŸÜŸäŸàŸÖ (Platinum)' : 
                                    key === 'gold' ? 'ŸÉŸàŸÑÿØ (Gold)' : 
                                    key === 'silver' ? 'ÿ≥ŸÑŸÅÿ± (Silver)' : 'ÿ®ÿ±ŸàŸÜÿ≤ (Bronze)',
                                    formatNumberEnglish(cat.count),
                                    formatNumberEnglish(price),
                                    formatNumberEnglish(cat.amount || 0)
                                ]);
                            }
                        });
                        wsData.push(['ÿßŸÑŸÖÿ¨ŸÖŸàÿπ', formatNumberEnglish(basicData.total?.count || 0), '', formatNumberEnglish(basicData.total?.amount || 0)]);
                    }
                    const wb = XLSX.utils.book_new();
                    const ws = XLSX.utils.aoa_to_sheet(wsData);
                    ws['!cols'] = [{ wch: 30 }, { wch: 18 }, { wch: 18 }, { wch: 18 }];
                    XLSX.utils.book_append_sheet(wb, ws, 'ÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑŸàŸÉŸäŸÑ');
                    const excelBlob = XLSX.write(wb, { type: 'array', bookType: 'xlsx' });
                    const blob = new Blob([excelBlob], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                    resolve(blob);
                } catch (error) {
                    reject(error);
                }
            });
        }
        function toggleUserContactPopup(event) {
            if (event) {
                event.stopPropagation();
            }
            const popup = document.getElementById('userContactPopup');
            const sidebarUser = document.getElementById('sidebarUser');
            if (!popup || !sidebarUser) {
                return false;
            }
            
            const isShowing = popup.classList.contains('show');
            
            if (isShowing) {
                popup.style.animation = 'popupFadeOut 0.15s ease-out forwards';
                setTimeout(() => {
                    popup.classList.remove('show');
                    popup.style.display = 'none';
                    popup.style.opacity = '0';
                    popup.style.visibility = 'hidden';
                    popup.style.pointerEvents = 'none';
                    popup.style.animation = '';
                    if (sidebarUser) {
                        sidebarUser.style.transform = 'scale(1)';
                        sidebarUser.style.boxShadow = '0 4px 12px rgba(128, 28, 50, 0.4)';
                    }
                }, 150);
            } else {
                const allPopups = document.querySelectorAll('.user-contact-popup.show');
                allPopups.forEach(p => {
                    p.classList.remove('show');
                    p.style.display = 'none';
                    p.style.opacity = '0';
                    p.style.visibility = 'hidden';
                    p.style.pointerEvents = 'none';
                    p.style.animation = '';
                });
                
                const rect = sidebarUser.getBoundingClientRect();
                const popupWidth = 250;
                const popupHeight = 200;
                
                const sidebar = document.getElementById('sidebar');
                const sidebarRect = sidebar ? sidebar.getBoundingClientRect() : null;
                let left = sidebarRect ? sidebarRect.left - popupWidth - 10 : rect.left - popupWidth - 10;
                let top = rect.top;
                
                const windowWidth = window.innerWidth;
                const windowHeight = window.innerHeight;
                let finalLeft = left;
                let finalTop = top;
                
                if (finalLeft < 10) {
                    finalLeft = sidebarRect ? sidebarRect.right + 10 : rect.right + 10;
                }
                if (finalLeft + popupWidth > windowWidth - 10) {
                    finalLeft = windowWidth - popupWidth - 10;
                }
                if (finalTop + popupHeight > windowHeight - 10) {
                    finalTop = windowHeight - popupHeight - 10;
                }
                if (finalTop < 10) {
                    finalTop = 10;
                }
                
                popup.style.left = finalLeft + 'px';
                popup.style.top = finalTop + 'px';
                popup.style.zIndex = '10001';
                
                popup.style.removeProperty('opacity');
                
                popup.style.display = 'block';
                popup.style.visibility = 'visible';
                popup.style.pointerEvents = 'auto';
                popup.style.transform = 'translateY(0)';
                
                setTimeout(() => {
                    popup.classList.add('show');
                }, 10);
            }
            return false;
        }
        
        window.toggleUserContactPopup = toggleUserContactPopup;
        
        function switchUser() {
            if (confirm('ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿ™ÿ®ÿØŸäŸÑ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖÿü ÿ≥Ÿäÿ™ŸÖ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨ ŸÖŸÜ ÿßŸÑÿ≠ÿ≥ÿßÿ® ÿßŸÑÿ≠ÿßŸÑŸä.')) {
                loggedInUser = '';
                localStorage.removeItem('loggedInUser');
                localStorage.removeItem('currentUserRole');
                localStorage.removeItem('currentUserId');
                
                const dashboard = document.getElementById('dashboard');
                const loginScreen = document.getElementById('loginScreen');
                
                if (dashboard) {
                    dashboard.classList.add('hidden');
                    dashboard.style.display = 'none';
                }
                
                if (loginScreen) {
                    loginScreen.classList.remove('hidden');
                    loginScreen.style.display = 'flex';
                }
                
                const loginUsername = document.getElementById('loginUsername');
                const loginPassword = document.getElementById('loginPassword');
                const loginAlert = document.getElementById('loginAlert');
                
                if (loginUsername) loginUsername.value = '';
                if (loginPassword) loginPassword.value = '';
                if (loginAlert) loginAlert.innerHTML = '';
            }
        }
        
        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            const themeIcon = document.getElementById('themeToggleIcon');
            const themeText = document.getElementById('themeToggleText');
            if (themeIcon) {
                themeIcon.textContent = newTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
            }
        }
        function loadTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            const html = document.documentElement;
            html.setAttribute('data-theme', savedTheme);
            const themeIcon = document.getElementById('themeToggleIcon');
            const themeText = document.getElementById('themeToggleText');
            if (themeIcon) {
                themeIcon.textContent = savedTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
            }
        }
        
        function autoLoginFromMaster() {
            const autoUsername = sessionStorage.getItem('auto_login_username');
            const autoPassword = sessionStorage.getItem('auto_login_password');
            
            if (autoUsername && autoPassword) {
                const loginUsername = document.getElementById('loginUsername');
                const loginPassword = document.getElementById('loginPassword');
                
                if (loginUsername && loginPassword) {
                    loginUsername.value = autoUsername;
                    loginPassword.value = autoPassword;
                    
                    setTimeout(() => {
                        if (typeof handleLogin === 'function') {
                            handleLogin();
                        }
                    }, 500);
                    
                    sessionStorage.removeItem('auto_login_username');
                    sessionStorage.removeItem('auto_login_password');
                    sessionStorage.removeItem('auto_login_system');
                }
            }
        }
        
        window.addEventListener('message', function(event) {
            if (event.data && event.data.type === 'AUTO_LOGIN') {
                const loginUsername = document.getElementById('loginUsername');
                const loginPassword = document.getElementById('loginPassword');
                
                if (loginUsername && loginPassword) {
                    loginUsername.value = event.data.username || '';
                    loginPassword.value = event.data.password || '';
                    
                    setTimeout(() => {
                        if (typeof handleLogin === 'function') {
                            handleLogin();
                        }
                    }, 500);
                }
            }
        });
</script>
<div id="percentageSendOptionsModal" class="modal">
    <div class="modal-content" style="max-width: 400px;">
        <div class="modal-header">
            <h3>ÿßÿÆÿ™ÿ± ÿ∑ÿ±ŸäŸÇÿ© ÿßŸÑÿ•ÿ±ÿ≥ÿßŸÑ</h3>
            <button class="modal-close" onclick="closePercentageSendOptions()">&times;</button>
        </div>
        <div style="padding: 20px 0;">
            <p style="margin-bottom: 20px; color: var(--text-primary); text-align: center; font-weight: 600;">
                <strong>ÿßŸÑŸàŸÉŸäŸÑ:</strong> <span id="percentageSendAgentName"></span>
            </p>
            <div style="display: flex; flex-direction: column; gap: 15px;">
                <button class="btn btn-success" onclick="sendPercentageReportViaWhatsApp()" style="width: 100%; padding: 15px; font-size: 1rem;">
                    ÿ•ÿ±ÿ≥ÿßŸÑ ÿπÿ®ÿ± Ÿàÿßÿ™ÿ≥ÿßÿ®
                </button>
                <button class="btn btn-primary" onclick="sendPercentageReportViaEmail()" style="width: 100%; padding: 15px; font-size: 1rem;">
                    ÿ•ÿ±ÿ≥ÿßŸÑ ÿπÿ®ÿ± ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä
                </button>
            </div>
        </div>
        <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button type="button" class="btn btn-danger" style="flex: 1;" onclick="closePercentageSendOptions()">ÿ•ŸÑÿ∫ÿßÿ°</button>
        </div>
    </div>
</div>
</body>
</html>
