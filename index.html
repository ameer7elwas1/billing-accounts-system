<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù‚Ø³Ù… Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª </title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ“Š</text></svg>">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700;800;900&display=swap">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/exceljs@4.4.0/dist/exceljs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js" crossorigin="anonymous"></script>
    <script>
        (function() {
            fetch('js/config.js')
                .then(response => {
                    if (response.ok) {
                        const script = document.createElement('script');
                        script.src = 'js/config.js';
                        document.head.appendChild(script);
                    }
                })
                .catch(() => {
                });
        })();
    </script>
    <style>
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --bg-tertiary: #f0f0f0;
            --text-primary: #2c3e50;
            --text-secondary: #5a6c7d;
            --text-tertiary: #95a5a6;
            --border-color: #801c32;
            --border-light: rgba(128, 28, 50, 0.3);
            --primary-color: #801c32;
            --primary-hover: #9d2338;
            --primary-light: rgba(128, 28, 50, 0.1);
            --shadow-sm: rgba(128, 28, 50, 0.08);
            --shadow-md: rgba(128, 28, 50, 0.18);
            --shadow-lg: rgba(128, 28, 50, 0.28);
            --card-bg: #ffffff;
            --sidebar-bg: #f8f9fa;
            --nav-bg: rgba(255, 255, 255, 0.7);
            --nav-hover: rgba(128, 28, 50, 0.08);
            --input-bg: #ffffff;
            --input-border: #801c32;
            --input-focus: rgba(128, 28, 50, 0.4);
            --modal-bg: #ffffff;
            --table-bg: #ffffff;
            --table-header: #801c32;
            --table-border: #e0e0e0;
            --success-color: #28a745;
            --success-light: rgba(40, 167, 69, 0.1);
            --error-color: #dc3545;
            --error-light: rgba(220, 53, 69, 0.1);
            --info-color: #17a2b8;
            --info-light: rgba(23, 162, 184, 0.1);
            --warning-color: #ffc107;
            --warning-light: rgba(255, 193, 7, 0.1);
        }
        [data-theme="dark"] {
            --bg-primary: #1a1a1a;
            --bg-secondary: #2d2d2d;
            --bg-tertiary: #3a3a3a;
            --text-primary: #f0f0f0;
            --text-secondary: #d0d0d0;
            --text-tertiary: #a0a0a0;
            --border-color: rgba(255, 255, 255, 0.18);
            --border-light: rgba(255, 255, 255, 0.12);
            --primary-color: #ff4757;
            --primary-hover: #ff6b7a;
            --primary-light: rgba(255, 71, 87, 0.15);
            --shadow-sm: rgba(0, 0, 0, 0.4);
            --shadow-md: rgba(0, 0, 0, 0.6);
            --shadow-lg: rgba(0, 0, 0, 0.8);
            --card-bg: #2d2d2d;
            --sidebar-bg: #2d2d2d;
            --nav-bg: rgba(45, 45, 45, 0.85);
            --nav-hover: rgba(255, 71, 87, 0.18);
            --input-bg: #3a3a3a;
            --input-border: rgba(255, 255, 255, 0.25);
            --input-focus: rgba(255, 71, 87, 0.5);
            --modal-bg: #2d2d2d;
            --table-bg: #2d2d2d;
            --table-header: #ff4757;
            --table-border: #4a4a4a;
            --success-color: #4ade80;
            --success-light: rgba(74, 222, 128, 0.15);
            --error-color: #f87171;
            --error-light: rgba(248, 113, 113, 0.15);
            --info-color: #60a5fa;
            --info-light: rgba(96, 165, 250, 0.15);
            --warning-color: #fbbf24;
            --warning-light: rgba(251, 191, 36, 0.15);
        }
        [data-theme="dark"] * {
            text-shadow: none;
        }
        [data-theme="dark"] .nav-text,
        [data-theme="dark"] .nav-item,
        [data-theme="dark"] .section-title,
        [data-theme="dark"] .agent-name-title,
        [data-theme="dark"] .info-value,
        [data-theme="dark"] .result-card h3,
        [data-theme="dark"] .result-card .count {
            font-weight: 700;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }
        [data-theme="dark"] .text-primary,
        [data-theme="dark"] body,
        [data-theme="dark"] .main-content {
            color: #ffffff;
            font-weight: 400;
        }
        [data-theme="dark"] p,
        [data-theme="dark"] span,
        [data-theme="dark"] div,
        [data-theme="dark"] label,
        [data-theme="dark"] td,
        [data-theme="dark"] th {
            color: #ffffff !important;
        }
        [data-theme="dark"] .section,
        [data-theme="dark"] .section-title,
        [data-theme="dark"] .section h3,
        [data-theme="dark"] .section h4,
        [data-theme="dark"] .section p {
            color: #ffffff !important;
        }
        [data-theme="dark"] .agent-card-improved,
        [data-theme="dark"] .agent-card-improved * {
            color: #ffffff !important;
        }
        [data-theme="dark"] .settings-section,
        [data-theme="dark"] .settings-section * {
            color: #ffffff !important;
        }
        [data-theme="dark"] .info-item-improved,
        [data-theme="dark"] .info-item-improved * {
            color: #ffffff !important;
        }
        [data-theme="dark"] .info-label,
        [data-theme="dark"] .info-value,
        [data-theme="dark"] .info-label-empty {
            color: #ffffff !important;
        }
        [data-theme="dark"] .modal-content,
        [data-theme="dark"] .modal-content * {
            color: #ffffff !important;
        }
        [data-theme="dark"] input,
        [data-theme="dark"] textarea,
        [data-theme="dark"] select {
            color: #ffffff !important;
            background-color: #3a3a3a !important;
        }
        [data-theme="dark"] button {
            color: #ffffff !important;
        }
        [data-theme="dark"] .btn {
            color: #ffffff !important;
        }
        [data-theme="dark"] .btn-danger {
            background-color: #dc3545 !important;
            color: #ffffff !important;
        }
        [data-theme="dark"] .btn-success {
            background-color: #28a745 !important;
            color: #ffffff !important;
        }
        [data-theme="dark"] .btn-primary {
            background-color: #007bff !important;
            color: #ffffff !important;
        }
        [data-theme="dark"] .btn-info {
            background-color: #17a2b8 !important;
            color: #ffffff !important;
        }
        [data-theme="dark"] .btn-warning {
            background-color: #ffc107 !important;
            color: #000000 !important;
        }
        [data-theme="dark"] .btn-secondary {
            background-color: #6c757d !important;
            color: #ffffff !important;
            border-color: #6c757d !important;
        }
        [data-theme="dark"] .btn-secondary:hover {
            background-color: #5a6268 !important;
            border-color: #545b62 !important;
        }
        [data-theme="dark"] [style*="color: #801c32"],
        [data-theme="dark"] [style*="color:#801c32"] {
            color: #ff6b7a !important;
        }
        [data-theme="dark"] [style*="color: #28a745"],
        [data-theme="dark"] [style*="color:#28a745"] {
            color: #4ade80 !important;
        }
        [data-theme="dark"] [style*="color: #dc3545"],
        [data-theme="dark"] [style*="color:#dc3545"] {
            color: #f87171 !important;
        }
        [data-theme="dark"] [style*="color: #007bff"],
        [data-theme="dark"] [style*="color:#007bff"] {
            color: #60a5fa !important;
        }
        [data-theme="dark"] [style*="color: #17a2b8"],
        [data-theme="dark"] [style*="color:#17a2b8"] {
            color: #22d3ee !important;
        }
        [data-theme="dark"] [style*="color: #ffc107"],
        [data-theme="dark"] [style*="color:#ffc107"] {
            color: #fbbf24 !important;
        }
        [data-theme="dark"] [style*="background: #801c32"],
        [data-theme="dark"] [style*="background:#801c32"] {
            background: #ff4757 !important;
        }
        [data-theme="dark"] [style*="background: #28a745"],
        [data-theme="dark"] [style*="background:#28a745"] {
            background: #4ade80 !important;
        }
        [data-theme="dark"] [style*="background: #dc3545"],
        [data-theme="dark"] [style*="background:#dc3545"] {
            background: #f87171 !important;
        }
        [data-theme="dark"] [style*="background: #007bff"],
        [data-theme="dark"] [style*="background:#007bff"] {
            background: #60a5fa !important;
        }
        [data-theme="dark"] [style*="background: #17a2b8"],
        [data-theme="dark"] [style*="background:#17a2b8"] {
            background: #22d3ee !important;
        }
        [data-theme="dark"] [style*="background: #ffc107"],
        [data-theme="dark"] [style*="background:#ffc107"] {
            background: #fbbf24 !important;
        }
        [data-theme="dark"] [style*="border-color: #801c32"],
        [data-theme="dark"] [style*="border-color:#801c32"] {
            border-color: #ff4757 !important;
        }
        [data-theme="dark"] [style*="border-color: #28a745"],
        [data-theme="dark"] [style*="border-color:#28a745"] {
            border-color: #4ade80 !important;
        }
        [data-theme="dark"] [style*="border-color: #dc3545"],
        [data-theme="dark"] [style*="border-color:#dc3545"] {
            border-color: #f87171 !important;
        }
        [data-theme="dark"] td[style*="color: #801c32"],
        [data-theme="dark"] td[style*="color:#801c32"],
        [data-theme="dark"] span[style*="color: #801c32"],
        [data-theme="dark"] span[style*="color:#801c32"],
        [data-theme="dark"] strong[style*="color: #801c32"],
        [data-theme="dark"] strong[style*="color:#801c32"] {
            color: #ff6b7a !important;
        }
        [data-theme="dark"] td[style*="color: #28a745"],
        [data-theme="dark"] td[style*="color:#28a745"],
        [data-theme="dark"] span[style*="color: #28a745"],
        [data-theme="dark"] span[style*="color:#28a745"],
        [data-theme="dark"] div[style*="color: #28a745"],
        [data-theme="dark"] div[style*="color:#28a745"],
        [data-theme="dark"] strong[style*="color: #28a745"],
        [data-theme="dark"] strong[style*="color:#28a745"] {
            color: #4ade80 !important;
        }
        [data-theme="dark"] td[style*="color: #dc3545"],
        [data-theme="dark"] td[style*="color:#dc3545"],
        [data-theme="dark"] span[style*="color: #dc3545"],
        [data-theme="dark"] span[style*="color:#dc3545"],
        [data-theme="dark"] div[style*="color: #dc3545"],
        [data-theme="dark"] div[style*="color:#dc3545"],
        [data-theme="dark"] strong[style*="color: #dc3545"],
        [data-theme="dark"] strong[style*="color:#dc3545"] {
            color: #f87171 !important;
        }
        [data-theme="dark"] h4[style*="color: #dc3545"],
        [data-theme="dark"] h4[style*="color:#dc3545"] {
            color: #f87171 !important;
        }
        [data-theme="dark"] [style*="background: #fff3cd"] {
            background: #3a3a3a !important;
            border-color: #fbbf24 !important;
        }
        [data-theme="dark"] [style*="color: #856404"] {
            color: #fbbf24 !important;
        }
        [data-theme="dark"] [style*="color: #155724"] {
            color: #4ade80 !important;
        }
        [data-theme="dark"] [style*="background: #d4edda"] {
            background: #2d2d2d !important;
            border-color: #4ade80 !important;
        }
        [data-theme="dark"] table,
        [data-theme="dark"] table td,
        [data-theme="dark"] table th {
            color: #ffffff !important;
        }
        [data-theme="dark"] #percentageTable td,
        [data-theme="dark"] #percentageTable th {
            color: #ffffff !important;
        }
        [data-theme="dark"] [style*="color: #1a1a1a"],
        [data-theme="dark"] [style*="color:#1a1a1a"],
        [data-theme="dark"] [style*="color: #333"],
        [data-theme="dark"] [style*="color:#333"],
        [data-theme="dark"] [style*="color: #999"],
        [data-theme="dark"] [style*="color:#999"] {
            color: var(--text-primary) !important;
        }
        [data-theme="dark"] [style*="background: #ffffff"],
        [data-theme="dark"] [style*="background:#ffffff"],
        [data-theme="dark"] [style*="background: white"],
        [data-theme="dark"] [style*="background:white"] {
            background: var(--card-bg) !important;
        }
        [data-theme="dark"] [style*="background: rgba(128, 28, 50, 0.05)"] {
            background: rgba(255, 71, 87, 0.1) !important;
        }
        [data-theme="dark"] .section p[style*="color: #1a1a1a"],
        [data-theme="dark"] .section p[style*="color:#1a1a1a"] {
            color: var(--text-primary) !important;
        }
        [data-theme="dark"] label[style*="color: #1a1a1a"],
        [data-theme="dark"] label[style*="color:#1a1a1a"],
        [data-theme="dark"] label[style*="color: #801c32"],
        [data-theme="dark"] label[style*="color:#801c32"] {
            color: var(--text-primary) !important;
        }
        [data-theme="dark"] .search-input,
        [data-theme="dark"] .search-results,
        [data-theme="dark"] .search-result-item {
            background: var(--card-bg) !important;
            color: var(--text-primary) !important;
            border-color: var(--border-color) !important;
        }
        [data-theme="dark"] .search-result-item:hover {
            background: var(--nav-hover) !important;
        }
        [data-theme="dark"] .search-result-item .result-type {
            color: var(--primary-color) !important;
        }
        [data-theme="dark"] .search-result-item .result-title {
            color: var(--text-primary) !important;
        }
        [data-theme="dark"] .search-result-item .result-month {
            color: var(--text-secondary) !important;
        }
        [data-theme="dark"] #archiveContent,
        [data-theme="dark"] #archiveContent * {
            color: var(--text-primary) !important;
        }
        [data-theme="dark"] #archiveContent h3,
        [data-theme="dark"] #archiveContent h4,
        [data-theme="dark"] #archiveContent h5 {
            color: var(--primary-color) !important;
        }
        [data-theme="dark"] #archiveContent table,
        [data-theme="dark"] #archiveContent table td,
        [data-theme="dark"] #archiveContent table th {
            background: var(--table-bg) !important;
            color: var(--text-primary) !important;
            border-color: var(--table-border) !important;
        }
        [data-theme="dark"] #archiveContent table thead tr,
        [data-theme="dark"] #archiveContent table thead th {
            background: var(--bg-secondary) !important;
            color: var(--primary-color) !important;
        }
        [data-theme="dark"] #archiveContent table tbody tr:nth-child(even) {
            background: var(--bg-secondary) !important;
        }
        [data-theme="dark"] #archiveContent table tbody tr:nth-child(odd) {
            background: var(--card-bg) !important;
        }
        [data-theme="dark"] #searchResultsContainer,
        [data-theme="dark"] #searchResultsContainer * {
            color: var(--text-primary) !important;
        }
        [data-theme="dark"] #searchResultsContainer h4,
        [data-theme="dark"] #searchResultsContainer h5 {
            color: var(--primary-color) !important;
        }
        [data-theme="dark"] #searchResultsContainer strong {
            color: var(--text-primary) !important;
        }
        [data-theme="dark"] #searchResultsContainer [style*="background: var(--bg-secondary)"] {
            background: var(--bg-secondary) !important;
        }
        [data-theme="dark"] #searchResultsContainer [style*="background: var(--card-bg)"] {
            background: var(--card-bg) !important;
        }
        [data-theme="dark"] .settings-input {
            background: var(--input-bg) !important;
            color: var(--text-primary) !important;
            border-color: var(--input-border) !important;
        }
        [data-theme="dark"] .file-upload {
            background: var(--card-bg) !important;
            border-color: var(--border-color) !important;
            color: var(--text-primary) !important;
        }
        [data-theme="dark"] .file-upload:hover {
            background: var(--bg-secondary) !important;
        }
        [data-theme="dark"] .success-message {
            background: rgba(40, 167, 69, 0.2) !important;
            color: #90ee90 !important;
            border-color: #28a745 !important;
        }
        [data-theme="dark"] .error-message {
            background: rgba(220, 53, 69, 0.2) !important;
            color: #ff6b7a !important;
            border-color: #dc3545 !important;
        }
        [data-theme="dark"] #archivesList > div {
            background: var(--card-bg) !important;
            border-color: var(--border-color) !important;
            color: var(--text-primary) !important;
        }
        [data-theme="dark"] #archivesList > div:hover {
            background: var(--nav-hover) !important;
            border-color: var(--primary-color) !important;
        }
        [data-theme="dark"] [style*="background: var(--bg-primary)"] {
            background: var(--bg-primary) !important;
        }
        [data-theme="dark"] [style*="background: var(--bg-secondary)"] {
            background: var(--bg-secondary) !important;
        }
        [data-theme="dark"] [style*="background: var(--card-bg)"] {
            background: var(--card-bg) !important;
        }
        [data-theme="dark"] [style*="color: var(--text-secondary)"] {
            color: var(--text-secondary) !important;
        }
        [data-theme="dark"] [style*="color: var(--text-tertiary)"] {
            color: var(--text-tertiary) !important;
        }
        [data-theme="dark"] div[style*="background"],
        [data-theme="dark"] p[style*="background"],
        [data-theme="dark"] span[style*="background"] {
            background-color: var(--card-bg) !important;
        }
        [data-theme="dark"] .main-content,
        [data-theme="dark"] .main-content * {
            color: var(--text-primary);
        }
        [data-theme="dark"] .main-content h1,
        [data-theme="dark"] .main-content h2,
        [data-theme="dark"] .main-content h3,
        [data-theme="dark"] .main-content h4,
        [data-theme="dark"] .main-content h5,
        [data-theme="dark"] .main-content h6 {
            color: var(--text-primary);
        }
        [data-theme="dark"] p[style*="color: #1a1a1a"],
        [data-theme="dark"] p[style*="color:#1a1a1a"],
        [data-theme="dark"] div[style*="color: #1a1a1a"],
        [data-theme="dark"] div[style*="color:#1a1a1a"],
        [data-theme="dark"] span[style*="color: #1a1a1a"],
        [data-theme="dark"] span[style*="color:#1a1a1a"],
        [data-theme="dark"] label[style*="color: #1a1a1a"],
        [data-theme="dark"] label[style*="color:#1a1a1a"] {
            color: var(--text-primary) !important;
        }
        [data-theme="dark"] p[style*="color: #333"],
        [data-theme="dark"] p[style*="color:#333"],
        [data-theme="dark"] span[style*="color: #333"],
        [data-theme="dark"] span[style*="color:#333"] {
            color: var(--text-primary) !important;
        }
        [data-theme="dark"] p[style*="color: #999"],
        [data-theme="dark"] p[style*="color:#999"],
        [data-theme="dark"] td[style*="color: #999"],
        [data-theme="dark"] td[style*="color:#999"] {
            color: var(--text-secondary) !important;
        }
        [data-theme="dark"] tr[style*="background: #801c32"],
        [data-theme="dark"] tr[style*="background:#801c32"] {
            background: var(--primary-color) !important;
        }
        [data-theme="dark"] tr[style*="background: #801c32"] th,
        [data-theme="dark"] tr[style*="background:#801c32"] th,
        [data-theme="dark"] tr[style*="color: white"] th,
        [data-theme="dark"] tr[style*="color:white"] th {
            color: #ffffff !important;
        }
        [data-theme="dark"] [style*="border: 1px solid #ddd"],
        [data-theme="dark"] [style*="border:1px solid #ddd"],
        [data-theme="dark"] [style*="border: 1px solid #ddd"] {
            border-color: var(--table-border) !important;
        }
        [data-theme="dark"] div[style*="background: rgba(128, 28, 50, 0.05)"] {
            background: rgba(255, 71, 87, 0.15) !important;
        }
        [data-theme="dark"] .activity-item {
            background: var(--card-bg) !important;
            border-color: var(--border-color) !important;
            color: var(--text-primary) !important;
        }
        [data-theme="dark"] .results-grid,
        [data-theme="dark"] .result-card {
            background: var(--card-bg) !important;
            border-color: var(--border-color) !important;
            color: var(--text-primary) !important;
        }
        [data-theme="dark"] .result-card h3 {
            color: var(--text-primary) !important;
        }
        [data-theme="dark"] .result-card .count,
        [data-theme="dark"] .result-card .amount {
            color: var(--text-primary) !important;
        }
        [data-theme="dark"] .agent-card,
        [data-theme="dark"] .agent-card-improved {
            background: var(--card-bg) !important;
            border-color: var(--border-color) !important;
        }
        [data-theme="dark"] .summary-section,
        [data-theme="dark"] .summary-card {
            background: var(--card-bg) !important;
            border-color: var(--border-color) !important;
            color: var(--text-primary) !important;
        }
        [data-theme="dark"] .form-group,
        [data-theme="dark"] .form-group label {
            color: var(--text-primary) !important;
        }
        [data-theme="dark"] .section {
            background: transparent !important;
            color: var(--text-primary) !important;
        }
        [data-theme="dark"] [style*="color: white"],
        [data-theme="dark"] [style*="color:white"] {
            color: var(--text-primary) !important;
        }
        [data-theme="dark"] a {
            color: var(--primary-color) !important;
        }
        [data-theme="dark"] a:hover {
            color: var(--primary-hover) !important;
        }
        [data-theme="dark"] .loading {
            color: var(--text-primary) !important;
        }
        [data-theme="dark"] .empty-state {
            color: var(--text-secondary) !important;
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Cairo', 'Segoe UI', 'Arial', sans-serif;
        }
        body {
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            transition: background-color 0.3s ease, color 0.3s ease;
            font-size: 16px;
            font-weight: 500;
            line-height: 1.6;
            overflow-x: hidden;
        }
        input, textarea {
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            user-select: text;
        }
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 30%, var(--shadow-sm) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, var(--shadow-sm) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
            opacity: 0.5;
        }
        [data-theme="dark"] body::before {
            opacity: 0.3;
        }
        .container {
            display: flex;
            width: 100%;
            max-width: 100vw;
            min-height: 100vh;
            position: relative;
            z-index: 1;
            overflow-x: hidden;
            box-sizing: border-box;
        }
        .sidebar {
            width: 230px;
            max-width: 230px;
            background: linear-gradient(180deg, var(--sidebar-bg) 0%, rgba(255, 255, 255, 0.02) 100%);
            border-left: 3px solid var(--primary-color);
            box-shadow: 3px 0 20px rgba(0, 0, 0, 0.08), inset -1px 0 0 rgba(128, 28, 50, 0.1);
            position: fixed;
            right: 0;
            top: 0;
            bottom: 0;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            padding: 0;
            overflow: hidden;
            transition: transform 0.3s ease, background 0.3s ease, border-color 0.3s ease;
            box-sizing: border-box;
        }
        [data-theme="dark"] .sidebar {
            background: linear-gradient(180deg, var(--sidebar-bg) 0%, rgba(0, 0, 0, 0.2) 100%);
            box-shadow: 4px 0 25px rgba(0, 0, 0, 0.3), inset -1px 0 0 rgba(128, 28, 50, 0.2);
        }
        .sidebar.hidden {
            transform: translateX(100%);
        }
        .sidebar-toggle-external {
            display: none !important;
            position: fixed !important;
            top: 20px !important;
            right: 20px !important;
            z-index: 10001 !important;
        }
        .sidebar.hidden ~ .sidebar-toggle-external,
        .sidebar.hidden + .sidebar-toggle-external,
        body:has(.sidebar.hidden) .sidebar-toggle-external {
            display: flex !important;
        }
        .sidebar-toggle-btn {
            position: relative;
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, var(--primary-color), var(--primary-hover));
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            box-shadow: 0 2px 6px var(--shadow-sm);
            transition: all 0.3s ease;
            font-weight: 700;
        }
        .sidebar.hidden ~ .sidebar-toggle-btn,
        .sidebar.hidden + .sidebar-toggle-btn {
            display: flex;
        }
        .sidebar-toggle-btn:hover {
            background: linear-gradient(135deg, var(--primary-hover), var(--primary-color));
            transform: scale(1.05);
            box-shadow: 0 4px 12px var(--shadow-md);
        }
        .theme-toggle-btn-small {
            position: relative;
            width: 36px;
            height: 36px;
            background: var(--bg-secondary);
            border: 1.5px solid var(--border-light);
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
            transition: all 0.3s ease;
            padding: 0;
            margin: 0;
            box-shadow: 0 2px 4px var(--shadow-sm);
            flex-shrink: 0;
        }
        .theme-toggle-btn-small:hover {
            background: var(--bg-tertiary);
            border-color: var(--primary-color);
            transform: scale(1.05);
            box-shadow: 0 3px 8px var(--shadow-md);
        }
        .theme-toggle-btn-small:active {
            transform: scale(0.95);
        }
        .theme-toggle-btn-small span {
            display: inline-block;
            transition: transform 0.3s ease;
        }
        [data-theme="dark"] .theme-toggle-btn-small span {
            transform: rotate(180deg);
        }
        .sidebar.hidden .theme-toggle-btn-small {
            display: flex !important;
        }
        #loginScreen[style*="display: flex"] ~ .sidebar-toggle-btn,
        #loginScreen[style*="display: block"] ~ .sidebar-toggle-btn {
            display: none !important;
        }
        #dashboard[style*="display: none"] ~ .sidebar-toggle-btn,
        #dashboard[style*="display: none"] .sidebar-toggle-btn {
            display: none !important;
        }
        .sidebar-header {
            padding: 20px 15px 15px;
            border-bottom: 1.5px solid var(--border-color);
            margin-bottom: 8px;
            transition: border-color 0.3s ease;
            flex-shrink: 0;
            background: linear-gradient(135deg, rgba(128, 28, 50, 0.03) 0%, transparent 100%);
            overflow: visible;
            width: 100%;
            box-sizing: border-box;
            position: relative;
            min-height: 120px;
        }
        [data-theme="dark"] .sidebar-header {
            background: linear-gradient(135deg, rgba(128, 28, 50, 0.1) 0%, transparent 100%);
        }
        .sidebar-header-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin-bottom: 8px;
        }
        .sidebar-header h1 {
            font-size: 1.1rem;
            color: var(--primary-color);
            font-weight: 800;
            text-align: center;
            margin: 45px 0 15px 0;
            letter-spacing: 0.5px;
            flex: 1;
            line-height: 1.3;
            transition: color 0.3s ease;
            padding: 0 10px;
        }
        .search-container {
            margin: 10px 15px;
            position: relative;
        }
        .search-input {
            width: 100%;
            padding: 10px 40px 10px 15px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            background: var(--input-bg);
            color: var(--text-primary);
            font-size: 0.95rem;
            transition: all 0.3s ease;
        }
        .search-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px var(--shadow-sm);
        }
        .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
            font-size: 1.1rem;
            pointer-events: none;
        }
        .search-results {
            max-height: 400px;
            overflow-y: auto;
            margin-top: 10px;
            padding: 10px;
            background: var(--bg-secondary);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            display: none;
        }
        .search-results.active {
            display: block;
        }
        .search-result-item {
            padding: 8px;
            margin-bottom: 5px;
            background: var(--card-bg);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid var(--border-light);
        }
        .search-result-item:hover {
            background: var(--nav-hover);
            border-color: var(--primary-color);
        }
        .search-result-item .result-type {
            font-size: 0.75rem;
            color: var(--primary-color);
            font-weight: 600;
            margin-bottom: 3px;
        }
        .search-result-item .result-title {
            font-size: 0.9rem;
            color: var(--text-primary);
            font-weight: 500;
        }
        .search-result-item .result-month {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-top: 3px;
        }
        .sidebar-nav {
            flex: 1;
            padding: 8px 12px;
            overflow-y: auto;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            gap: 5px;
            min-height: 0;
            margin-top: 5px;
        }
        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 16px;
            margin-bottom: 6px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            color: var(--text-primary);
            font-weight: 600;
            font-size: 0.9rem;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            text-rendering: optimizeLegibility;
            position: relative;
            overflow: visible;
            background: linear-gradient(135deg, var(--nav-bg) 0%, rgba(255, 255, 255, 0.02) 100%);
            border: 1.5px solid rgba(128, 28, 50, 0.08);
            backdrop-filter: blur(10px);
            line-height: 1.5;
            flex-shrink: 0;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
            min-height: 48px;
            width: 100%;
        }
        [data-theme="dark"] .nav-item {
            color: #f5f5f5;
            background: linear-gradient(135deg, var(--nav-bg) 0%, rgba(255, 255, 255, 0.03) 100%);
            border-color: rgba(128, 28, 50, 0.15);
        }
        .nav-item::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 3px;
            height: 100%;
            background: linear-gradient(180deg, var(--primary-color) 0%, var(--primary-hover) 100%);
            transform: translateX(100%);
            transition: transform 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 0 12px 12px 0;
            box-shadow: 0 0 10px rgba(128, 28, 50, 0.35);
        }
        .nav-item::after {
            content: '';
            position: absolute;
            top: 50%;
            right: 0;
            width: 0;
            height: 0;
            background: radial-gradient(circle, rgba(128, 28, 50, 0.1) 0%, transparent 70%);
            border-radius: 50%;
            transform: translate(50%, -50%);
            transition: width 0.4s ease, height 0.4s ease;
            pointer-events: none;
        }
        .nav-item:hover::after {
            width: 150px;
            height: 150px;
        }
        .nav-item:hover::before,
        .nav-item.active::before {
            transform: translateX(0);
        }
        .nav-item:hover {
            background: linear-gradient(135deg, var(--nav-hover) 0%, rgba(128, 28, 50, 0.1) 100%);
            border-color: rgba(128, 28, 50, 0.2);
            transform: translateX(-2px);
            box-shadow: 0 4px 14px rgba(128, 28, 50, 0.12), 0 2px 6px rgba(0, 0, 0, 0.08);
            color: var(--primary-color);
        }
        .nav-item.active {
            background: linear-gradient(135deg, rgba(128, 28, 50, 0.15) 0%, rgba(128, 28, 50, 0.08) 100%);
            border-color: rgba(128, 28, 50, 0.35);
            color: var(--primary-color);
            font-weight: 700;
            box-shadow: 0 3px 12px rgba(128, 28, 50, 0.25), inset 0 0 24px rgba(128, 28, 50, 0.08);
            transform: translateX(-2px);
        }
        [data-theme="dark"] .nav-item.active {
            background: linear-gradient(135deg, rgba(128, 28, 50, 0.25) 0%, rgba(128, 28, 50, 0.15) 100%);
            border-color: rgba(128, 28, 50, 0.4);
            box-shadow: 0 2px 8px rgba(128, 28, 50, 0.3), inset 0 0 20px rgba(128, 28, 50, 0.1);
        }
        .nav-icon {
            font-size: 1.1rem;
            width: 28px;
            height: 28px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            background: linear-gradient(135deg, rgba(128, 28, 50, 0.1) 0%, rgba(128, 28, 50, 0.05) 100%);
            border-radius: 8px;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            font-weight: 500;
        }
        .nav-item:hover .nav-icon {
            background: linear-gradient(135deg, rgba(128, 28, 50, 0.18) 0%, rgba(128, 28, 50, 0.12) 100%);
            transform: scale(1.05);
        }
        .nav-item.active .nav-icon {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-hover) 100%);
            color: white;
            box-shadow: 0 3px 8px rgba(128, 28, 50, 0.35);
            transform: scale(1.05);
        }
        .nav-text {
            flex: 1;
            font-size: 0.9rem;
            font-weight: 600;
            letter-spacing: 0.2px;
            white-space: normal;
            overflow: visible;
            word-wrap: break-word;
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            text-rendering: optimizeLegibility;
            color: var(--text-primary);
            transition: color 0.25s ease, font-weight 0.25s ease;
        }
        .nav-item.active .nav-text {
            font-weight: 700;
            color: var(--primary-color);
        }
        .nav-item:hover .nav-text {
            font-weight: 600;
            color: var(--primary-color);
        }
        [data-theme="dark"] .nav-text {
            color: var(--text-primary);
        }
        [data-theme="dark"] .nav-item.active .nav-text {
            color: var(--primary-color);
        }
        [data-theme="dark"] .nav-item:hover .nav-text {
            color: var(--primary-color);
        }
        .sidebar-footer {
            padding: 6px 20px;
            border-top: 2px solid var(--border-color);
            margin-top: auto;
            transition: border-color 0.3s ease;
            flex-shrink: 0;
        }
        .user-info-sidebar {
            color: var(--primary-color);
            font-size: 14px;
            text-align: center;
            margin-bottom: 10px;
            font-weight: 600;
            transition: color 0.3s ease;
        }
        .sidebar-user-info {
            text-align: center;
            font-size: 0.9rem;
            color: var(--text-secondary);
            overflow: visible;
            margin-top: 0;
            padding: 0;
        }
        .sidebar-user-name {
            font-size: 0.9rem;
            font-weight: 700;
            color: var(--text-primary);
            margin: 0;
            padding: 6px 10px;
            cursor: pointer;
            position: relative;
            opacity: 1;
            overflow: visible;
            width: 100%;
            box-sizing: border-box;
        }
        .sidebar-user-name:hover {
            opacity: 0.9;
        }
        .user-contact-popup {
            position: fixed;
            background: var(--card-bg);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 15px 20px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
            min-width: 250px;
            max-width: 300px;
            z-index: 10001;
            display: none;
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
            transform: translateY(0);
            will-change: transform, opacity;
        }
        .user-contact-popup.show {
            display: block !important;
            opacity: 1 !important;
            visibility: visible !important;
            pointer-events: auto !important;
            animation: popupFadeIn 0.15s ease-out forwards;
        }
        @keyframes popupFadeIn {
            from {
                opacity: 0;
                transform: translateY(-5px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        @keyframes popupFadeOut {
            from {
                opacity: 1;
                transform: translateY(0);
            }
            to {
                opacity: 0;
                transform: translateY(-5px);
            }
        }
        .user-contact-popup::before {
            content: '';
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 8px solid transparent;
            border-bottom-color: var(--card-bg);
            filter: drop-shadow(0 -2px 4px rgba(0, 0, 0, 0.1));
            pointer-events: none;
        }
        .user-contact-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-light);
            font-size: 0.9rem;
        }
        .user-contact-item:last-child {
            border-bottom: none;
        }
        .user-contact-item a {
            color: var(--primary-color);
            text-decoration: none;
            transition: color 0.2s ease;
        }
        .user-contact-item a:hover {
            color: var(--primary-hover);
            text-decoration: underline;
        }
        .user-contact-icon {
            font-size: 1.0rem;
            width: 24px;
            text-align: center;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .user-contact-icon i {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .date-info-sidebar {
            color: #1a1a1a;
            font-size: 12px;
            text-align: center;
            transition: color 0.3s ease;
            font-weight: 600;
            background: #ffffff;
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
        }
        [data-theme="dark"] .date-info-sidebar {
            color: #801c32 !important;
            background: #ffffff !important;
            font-weight: 700;
            text-shadow: none;
            opacity: 1 !important;
            border-color: #801c32;
        }
        .main-content {
            flex: 1;
            margin-right: 250px;
            padding: 30px 25px;
            min-height: 100vh;
            transition: background-color 0.3s ease, color 0.3s ease;
            width: calc(100% - 250px);
            max-width: calc(100% - 250px);
            overflow-x: hidden;
            position: relative;
            z-index: 1;
            box-sizing: border-box;
        }
        .main-content.sidebar-hidden {
            margin-right: 0;
            width: 100%;
            max-width: 100%;
        }
        .login-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            width: 100%;
        }
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: var(--bg-primary);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 10000;
        }
        .login-container.hidden {
            display: none !important;
        }
        .login-card {
            background: var(--card-bg);
            border: 2px solid var(--border-color);
            border-radius: 16px;
            padding: 40px;
            box-shadow: 0 8px 24px var(--shadow-lg);
            width: 100%;
            max-width: 450px;
        }
        .login-card h1 {
            color: var(--primary-color);
            font-size: 1.8rem;
            font-weight: 700;
            text-align: center;
            margin-bottom: 30px;
        }
        .login-form {
            background: var(--card-bg);
            padding: 60px 50px;
            border-radius: 30px;
            box-shadow: 0 20px 60px var(--shadow-md);
            width: 100%;
            max-width: 480px;
            text-align: center;
            border: 3px solid var(--primary-color);
            position: relative;
            overflow: hidden;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        .login-form::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--primary-color);
            transition: background 0.3s ease;
        }
        .login-logo {
            font-size: 3.5rem;
            color: var(--primary-color);
            margin-bottom: 20px;
            font-weight: bold;
            transition: color 0.3s ease;
        }
        .login-title {
            font-size: 1.8rem;
            color: var(--primary-color);
            margin-bottom: 35px;
            font-weight: 600;
            transition: color 0.3s ease;
        }
        .form-group {
            margin-bottom: 20px;
            text-align: right;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-primary);
            font-weight: bold;
            transition: color 0.3s ease;
        }
        .form-group input {
            width: 100%;
            padding: 15px 20px;
            border: 2px solid var(--input-border);
            border-radius: 15px;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
            text-align: right;
            background: var(--input-bg);
            color: var(--text-primary);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            text-rendering: optimizeLegibility;
            line-height: 1.5;
        }
        .form-group input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 20px var(--shadow-md);
            transform: translateY(-2px);
            background: var(--input-bg);
            font-weight: 600;
        }
        .login-btn {
            width: 100%;
            padding: 15px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 15px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 25px var(--shadow-md);
        }
        .login-btn:hover {
            transform: translateY(-3px);
            background: var(--primary-hover);
            box-shadow: 0 12px 35px var(--shadow-lg);
        }
        .login-btn:active {
            transform: translateY(-1px);
        }
        .dashboard {
            display: flex;
            width: 100%;
            max-width: 100%;
            overflow-x: hidden;
            position: relative;
            box-sizing: border-box;
        }
        .dashboard.hidden {
            display: none !important;
        }
        .tab-content {
            display: none;
            width: 100%;
            max-width: 100%;
            overflow-x: hidden;
            box-sizing: border-box;
        }
        .tab-content.active {
            display: block;
            width: 100%;
            max-width: 100%;
            overflow-x: hidden;
            box-sizing: border-box;
        }
        .section {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1.5px solid var(--border-light);
            box-shadow: 
                0 4px 12px var(--shadow-sm),
                0 2px 6px var(--shadow-sm);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            overflow-x: hidden;
            color: var(--text-primary);
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
        }
        #percentageResults.section {
            overflow: visible;
            overflow-x: hidden;
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
            transition: none !important;
            animation: none !important;
        }
        #percentageResults.section::before {
            display: none !important;
        }
        #percentageResults.section:hover {
            transform: none !important;
        }
        #agentPercentageTab .section {
            transition: none !important;
            animation: none !important;
        }
        #agentPercentageTab .section::before {
            display: none !important;
        }
        #agentPercentageTab .section:hover {
            transform: none !important;
        }
        #percentageTableContainer * {
            transition: none !important;
            animation: none !important;
        }
        #percentageTable * {
            transition: none !important;
            animation: none !important;
        }
        #percentageTableContainer {
            width: 100% !important;
            max-width: 100% !important;
            box-sizing: border-box !important;
            overflow-x: auto !important;
            overflow-y: auto !important;
            will-change: scroll-position;
            contain: layout style paint;
            position: relative;
            isolation: isolate;
        }
        #percentageTableContainer::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        #percentageTableContainer::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        #percentageTableContainer::-webkit-scrollbar-thumb {
            background: #801c32;
            border-radius: 4px;
        }
        #percentageTableContainer::-webkit-scrollbar-thumb:hover {
            background: #a52d45;
        }
        #percentageTable {
            width: auto;
            min-width: 100%;
            table-layout: auto;
            border-collapse: collapse;
            box-sizing: border-box;
            display: table;
        }
        #percentageTable th,
        #percentageTable td {
            box-sizing: border-box;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        #agentPercentageTab {
            width: 100%;
            max-width: 100%;
            overflow-x: hidden;
            box-sizing: border-box;
        }
        #agentPercentageTab .section {
            width: 100%;
            max-width: 100%;
            overflow-x: hidden;
            box-sizing: border-box;
        }
        .section::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(
                45deg,
                transparent 30%,
                rgba(128, 28, 50, 0.05) 50%,
                transparent 70%
            );
            transform: rotate(45deg);
            transition: all 0.6s ease;
            opacity: 0;
        }
        .section:hover::before {
            display: none;
        }
        .section:hover {
            transform: none;
            box-shadow: 
                0 20px 50px var(--shadow-md),
                0 10px 30px var(--shadow-sm);
            border-color: var(--primary-color);
        }
        .section-title {
            font-size: 1.4rem;
            font-weight: 900;
            color: var(--primary-color);
            margin-bottom: 20px;
            padding-bottom: 14px;
            border-bottom: 3px solid var(--primary-color);
            display: flex;
            align-items: center;
            gap: 12px;
            letter-spacing: 0.5px;
            position: relative;
            transition: color 0.3s ease, border-color 0.3s ease;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            text-rendering: optimizeLegibility;
            line-height: 1.3;
            text-shadow: 0 2px 4px rgba(128, 28, 50, 0.15);
        }
        .file-upload {
            border: 2px dashed var(--primary-color);
            border-radius: 12px;
            padding: 30px 25px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 20px;
            background: var(--bg-secondary);
            position: relative;
            overflow: hidden;
            box-shadow: 
                0 10px 30px var(--shadow-sm),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
        }
        .file-upload::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(128, 28, 50, 0.1), transparent);
            transition: left 0.5s ease;
        }
        .file-upload:hover::before {
            left: 100%;
        }
        .file-upload:hover {
            transform: translateY(-2px);
            box-shadow: 
                0 8px 20px var(--shadow-md),
                0 4px 10px var(--shadow-sm),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            background: var(--bg-tertiary);
            border-color: var(--primary-color);
        }
        .file-upload.dragover {
            transform: scale(1.05);
            box-shadow: 
                0 25px 60px rgba(128, 28, 50, 0.2),
                0 15px 40px rgba(128, 28, 50, 0.15),
                inset 0 1px 0 rgba(255, 255, 255, 0.5);
            border-color: #801c32;
        }
        .file-upload p {
            margin: 0;
            font-size: 1.15rem;
            font-weight: 700;
            color: var(--primary-color);
            position: relative;
            z-index: 2;
            letter-spacing: 0.8px;
            transition: color 0.3s ease;
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 700;
            margin: 6px 5px;
            transition: all 0.3s ease;
            box-shadow: 
                0 3px 8px rgba(0, 0, 0, 0.12),
                0 2px 4px rgba(0, 0, 0, 0.08);
            position: relative;
            overflow: hidden;
            letter-spacing: 0.3px;
            color: #ffffff;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            text-rendering: optimizeLegibility;
            line-height: 1.4;
        }
        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255,255,255,0.3);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: all 0.6s ease;
        }
        .btn:active::before {
            width: 400px;
            height: 400px;
        }
        .btn-primary {
            background: var(--primary-color);
            box-shadow: 
                0 8px 25px var(--shadow-md),
                0 4px 15px var(--shadow-sm);
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            background: var(--primary-hover);
            box-shadow: 
                0 6px 16px var(--shadow-md),
                0 3px 8px var(--shadow-sm);
        }
        .btn-success {
            background: linear-gradient(135deg, #10b981, #059669);
            box-shadow: 
                0 8px 25px rgba(16, 185, 129, 0.4),
                0 4px 15px rgba(16, 185, 129, 0.3);
        }
        .btn-success:hover {
            transform: translateY(-2px);
            background: linear-gradient(135deg, #059669, #047857);
            box-shadow: 
                0 6px 16px rgba(16, 185, 129, 0.4),
                0 3px 8px rgba(16, 185, 129, 0.3);
        }
        .btn-warning {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            box-shadow: 
                0 8px 25px rgba(245, 158, 11, 0.4),
                0 4px 15px rgba(245, 158, 11, 0.3);
        }
        .btn-warning:hover {
            transform: translateY(-5px) scale(1.05);
            background: linear-gradient(135deg, #d97706, #b45309);
            box-shadow: 
                0 15px 40px rgba(245, 158, 11, 0.5),
                0 8px 25px rgba(245, 158, 11, 0.4);
        }
        .btn-danger {
            background: linear-gradient(180deg, #ef4444 0%, #dc2626 100%);
            color: #ffffff;
            border-color: rgba(239, 68, 68, 0.5);
        }
        .btn-danger:hover {
            background: linear-gradient(180deg, #dc2626 0%, #b91c1c 100%);
            transform: translateY(-2px);
            box-shadow: 
                0 8px 25px rgba(239, 68, 68, 0.4),
                0 0 20px rgba(239, 68, 68, 0.3);
        }
        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin: 20px 0;
            padding: 10px;
        }
        .agents-grid-improved {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
            margin: 20px 0;
            padding: 0;
            width: 100%;
            box-sizing: border-box;
        }
        .result-card {
            background: var(--card-bg);
            border-radius: 10px;
            padding: 12px 10px;
            text-align: center;
            box-shadow: 
                0 3px 10px var(--shadow-sm),
                0 2px 5px var(--shadow-sm);
            border: 1.5px solid var(--border-light);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            color: var(--text-primary);
        }
        .result-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(128, 28, 50, 0.1), transparent);
            transition: left 0.6s ease;
        }
        .result-card:hover::before {
            left: 100%;
        }
        .result-card:hover {
            transform: translateY(-2px);
            box-shadow: 
                0 6px 16px var(--shadow-md),
                0 3px 8px var(--shadow-sm);
            border-color: var(--primary-color);
        }
        .result-card.bronze {
            border-top: 3px solid #f59e0b;
        }
        .result-card.silver {
            border-top: 3px solid #94a3b8;
        }
        .result-card.gold {
            border-top: 3px solid #fbbf24;
        }
        .result-card.platinum {
            border-top: 3px solid #a855f7;
        }
        .result-card h3 {
            color: var(--primary-color);
            margin-bottom: 8px;
            font-size: 0.85rem;
            font-weight: 700;
            letter-spacing: 0.3px;
            position: relative;
            z-index: 2;
            text-transform: uppercase;
            transition: color 0.3s ease;
        }
        .result-card .count {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--primary-color);
            margin-bottom: 8px;
            line-height: 1.1;
            position: relative;
            z-index: 2;
            transition: color 0.3s ease;
        }
        .result-card .amount {
            color: var(--text-primary);
            font-weight: 600;
            font-size: 0.9rem;
            position: relative;
            z-index: 2;
            margin: 8px 0;
            padding: 6px 0;
            border-top: 1px solid var(--border-light);
            transition: color 0.3s ease, border-color 0.3s ease;
        }
        .result-card .amount:first-of-type {
            border-top: none;
        }
        .agent-summary-card {
            transition: all 0.3s ease;
        }
        .agent-summary-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 6px 16px var(--shadow-md);
            border-color: var(--primary-color);
        }
        .agent-info {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: 
                0 4px 12px var(--shadow-md),
                0 2px 6px var(--shadow-sm);
            position: relative;
            overflow: hidden;
            border: 2px solid var(--primary-color);
            color: var(--text-primary);
            transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
        }
        .agent-info::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(128, 28, 50, 0.05), transparent);
            transform: rotate(45deg);
        }
        .agent-info h3 {
            margin-bottom: 15px;
            font-size: 1.3rem;
            font-weight: 800;
            position: relative;
            z-index: 2;
            color: var(--primary-color);
            letter-spacing: 1px;
            text-transform: uppercase;
            transition: color 0.3s ease;
        }
        .agent-info p {
            position: relative;
            z-index: 2;
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--text-primary);
            transition: color 0.3s ease;
        }
        .hidden {
            display: none;
        }
        .loading {
            display: none;
            text-align: center;
            padding: 30px 20px;
            background: var(--card-bg);
            border-radius: 12px;
            margin: 20px 0;
            box-shadow: 
                0 4px 12px var(--shadow-md),
                0 2px 6px var(--shadow-sm);
            border: 2px solid var(--primary-color);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        .spinner {
            border: 4px solid var(--shadow-sm);
            border-top: 4px solid var(--primary-color);
            border-right: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            margin: 0 auto 15px;
            box-shadow: 
                0 0 20px var(--shadow-md),
                0 3px 10px var(--shadow-sm);
        }
        .loading p {
            color: var(--primary-color);
            font-weight: 700;
            font-size: 0.95rem;
            letter-spacing: 0.5px;
            transition: color 0.3s ease;
        }
        .error-message {
            background: var(--card-bg);
            color: #e53e3e;
            padding: 12px 18px;
            border-radius: 10px;
            margin: 15px 0;
            border: 2px solid #e53e3e;
            font-weight: 700;
            font-size: 0.9rem;
            box-shadow: 
                0 4px 12px var(--shadow-md),
                0 2px 6px var(--shadow-sm);
            letter-spacing: 0.3px;
            transition: background-color 0.3s ease;
        }
        .success-message {
            background: var(--card-bg);
            color: var(--primary-color);
            padding: 12px 18px;
            border-radius: 10px;
            margin: 15px 0;
            border: 2px solid var(--primary-color);
            font-weight: 700;
            font-size: 0.9rem;
            box-shadow: 
                0 4px 12px var(--shadow-md),
                0 2px 6px var(--shadow-sm);
            letter-spacing: 0.3px;
            transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
        }
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                position: relative;
                height: auto;
                border-left: none;
                border-bottom: 2px solid #801c32;
            }
            .main-content {
                margin-right: 0;
                padding: 20px;
            }
            .results-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            .section {
                padding: 25px 20px;
            }
            .section-title {
                font-size: 1.5rem;
            }
            .btn {
                padding: 12px 24px;
                font-size: 14px;
                margin: 8px 4px;
            }
            .file-upload {
                padding: 30px 20px;
            }
            .login-form {
                margin: 20px;
                padding: 40px 25px;
            }
        }
        .date-time-bar {
            width: 100%;
            text-align: center;
            margin: 10px 0 0 0;
        }
        #currentDateTime {
            font-size: 0.95rem;
            font-weight: 700;
            color: #801c32;
            background: #ffffff;
            padding: 8px 18px;
            border-radius: 6px;
            display: inline-block;
            letter-spacing: 1px;
            box-shadow: 
                0 3px 8px rgba(128, 28, 50, 0.12),
                0 0 0 1px rgba(128, 28, 50, 0.15);
            position: relative;
            z-index: 2;
            margin-top: 10px;
            border: 1.5px solid #801c32;
        }
        @media print {
            body * {
                visibility: hidden;
            }
            .dashboard, 
            .dashboard * {
                visibility: visible;
            }
            .login-screen {
                display: none !important;
            }
            .dashboard {
                display: block !important;
            }
            .header {
                background: #667eea !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            .tabs {
                display: none;
            }
            .tab-content {
                display: block !important;
            }
            .tab-content:not(.active) {
                display: none !important;
            }
            .btn {
                display: none;
            }
            .file-upload {
                display: none;
            }
            .results-grid {
                break-inside: avoid;
                page-break-inside: avoid;
            }
            .result-card {
                break-inside: avoid;
                page-break-inside: avoid;
                border: 1px solid #ccc !important;
            }
            .agent-info {
                background: #28a745 !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
        }
        .sidebar-header .author-name {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-align: center;
            margin: 8px auto 0;
            letter-spacing: 0.5px;
            padding: 0;
            background: transparent;
            border: none;
            display: block;
            width: 100%;
            box-shadow: none;
            cursor: default;
            pointer-events: none;
        }
        [data-theme="dark"] .sidebar-header .author-name {
            color: var(--text-primary) !important;
            opacity: 0.9;
        }
        .author-info-popup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border-radius: 24px;
            padding: 0;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.25), 0 10px 30px rgba(128, 28, 50, 0.15);
            border: 2px solid #801c32;
            z-index: 10001;
            min-width: 480px;
            max-width: 600px;
            width: 90%;
            overflow: hidden;
        }
        [data-theme="dark"] .author-info-popup {
            background: linear-gradient(135deg, #2d2d2d 0%, #1a1a1a 100%);
            border-color: #ff4757;
        }
        .author-info-popup.show {
            display: block;
        }
        .popup-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 10000;
            backdrop-filter: blur(6px);
        }
        .popup-overlay.show {
            display: block;
        }
        .popup-close {
            position: absolute;
            top: 15px;
            left: 15px;
            width: 36px;
            height: 36px;
            background: rgba(128, 28, 50, 0.1);
            border: 2px solid #801c32;
            border-radius: 50%;
            color: #801c32;
            font-size: 1.5rem;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            line-height: 1;
        }
        .popup-close:hover {
            background: #801c32;
            color: white;
            box-shadow: 0 4px 12px rgba(128, 28, 50, 0.4);
        }
        [data-theme="dark"] .popup-close {
            background: rgba(255, 71, 87, 0.15);
            border-color: #ff4757;
            color: #ff4757;
        }
        [data-theme="dark"] .popup-close:hover {
            background: #ff4757;
            color: white;
        }
        .popup-header {
            text-align: center;
            margin: 0;
            padding: 30px 40px 20px;
            background: linear-gradient(135deg, #801c32 0%, #a52d45 100%);
            color: white;
            position: relative;
        }
        [data-theme="dark"] .popup-header {
            background: linear-gradient(135deg, #ff4757 0%, #ff6b7a 100%);
        }
        .popup-header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 80px;
            height: 4px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 2px;
        }
        .popup-header h2 {
            color: white;
            font-size: 1.5rem;
            font-weight: 700;
            margin: 0;
            letter-spacing: 1px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        .popup-content {
            display: flex;
            flex-direction: column;
            gap: 16px;
            padding: 30px 40px;
            background: var(--bg-primary);
        }
        .info-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 18px 20px;
            background: var(--bg-secondary);
            border-radius: 16px;
            border: 2px solid var(--border-light);
            flex-direction: row-reverse;
            position: relative;
            overflow: hidden;
        }
        .info-item::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(180deg, #801c32 0%, #a52d45 100%);
        }
        [data-theme="dark"] .info-item::before {
            background: linear-gradient(180deg, #ff4757 0%, #ff6b7a 100%);
        }
        .info-item:hover {
            background: var(--bg-tertiary);
            border-color: var(--primary-color);
            box-shadow: 0 8px 20px var(--shadow-md);
        }
        .info-icon {
            font-size: 1.8rem;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, rgba(128, 28, 50, 0.1) 0%, rgba(128, 28, 50, 0.15) 100%);
            border-radius: 12px;
            flex-shrink: 0;
        }
        [data-theme="dark"] .info-icon {
            background: linear-gradient(135deg, rgba(255, 71, 87, 0.15) 0%, rgba(255, 71, 87, 0.25) 100%);
        }
        .info-item:hover .info-icon {
            background: linear-gradient(135deg, rgba(128, 28, 50, 0.2) 0%, rgba(128, 28, 50, 0.3) 100%);
        }
        [data-theme="dark"] .info-item:hover .info-icon {
            background: linear-gradient(135deg, rgba(255, 71, 87, 0.25) 0%, rgba(255, 71, 87, 0.35) 100%);
        }
        .info-text {
            flex: 0 0 auto;
            color: #1a1a1a;
            font-size: 0.9rem;
            font-weight: 600;
            min-width: 120px;
            text-align: left;
        }
        [data-theme="dark"] .info-text {
            color: #f5f5f5;
        }
        .info-value {
            color: var(--primary-color);
            font-weight: 700;
            font-size: 1rem;
            flex: 1;
            text-align: left;
            direction: ltr;
            white-space: nowrap;
        }
        [data-theme="dark"] .info-value {
            color: #ff6b7a;
        }
        .info-item:hover .info-value {
            color: var(--primary-color);
        }
        [data-theme="dark"] .info-item:hover .info-value {
            color: #ff4757;
        }
        .info-action {
            padding: 8px 18px;
            background: linear-gradient(135deg, #801c32 0%, #a52d45 100%);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 700;
            white-space: nowrap;
            flex-shrink: 0;
            box-shadow: 0 2px 8px rgba(128, 28, 50, 0.3);
            position: relative;
            overflow: hidden;
        }
        [data-theme="dark"] .info-action {
            background: linear-gradient(135deg, #ff4757 0%, #ff6b7a 100%);
            box-shadow: 0 2px 8px rgba(255, 71, 87, 0.3);
        }
        .info-action:hover {
            box-shadow: 0 4px 16px rgba(128, 28, 50, 0.4);
        }
        [data-theme="dark"] .info-action:hover {
            box-shadow: 0 4px 16px rgba(255, 71, 87, 0.4);
        }
        .settings-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 20px;
        }
        .settings-section {
            background: var(--card-bg);
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 2px 12px var(--shadow-sm);
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            color: var(--text-primary);
        }
        .settings-section::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(180deg, #801c32, #a52d45);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .settings-section:hover {
            box-shadow: 0 4px 20px rgba(128, 28, 50, 0.15);
            border-color: rgba(128, 28, 50, 0.3);
            transform: translateY(-2px);
        }
        .settings-section:hover::before {
            opacity: 1;
        }
        .settings-section h4 {
            color: var(--primary-color);
            margin-bottom: 18px;
            font-size: 1.1rem;
            font-weight: 700;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 12px;
            letter-spacing: 0.3px;
            transition: color 0.3s ease, border-color 0.3s ease;
        }
        .settings-group {
            margin-bottom: 18px;
        }
        .settings-group:last-child {
            margin-bottom: 0;
        }
        .settings-group label {
            display: block;
            color: #1a1a1a;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 0.9rem;
            transition: color 0.3s ease;
        }
        [data-theme="dark"] .settings-group label {
            color: #f5f5f5;
        }
        .settings-input {
            width: 100%;
            padding: 10px 14px;
            border: 2px solid var(--input-border);
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 500;
            transition: all 0.3s ease;
            background: var(--input-bg);
            color: var(--text-primary);
            box-sizing: border-box;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            text-rendering: optimizeLegibility;
            line-height: 1.5;
        }
        .settings-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px var(--shadow-sm);
            background: var(--input-bg);
            font-weight: 600;
        }
        .settings-input:hover {
            border-color: var(--border-color);
        }
        .settings-checkbox {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            padding: 8px;
            border-radius: 6px;
            transition: all 0.2s ease;
        }
        .settings-checkbox:hover {
            background: rgba(128, 28, 50, 0.05);
        }
        .settings-checkbox input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: #801c32;
        }
        .settings-section .btn {
            margin-top: 12px;
            width: 100%;
        }
        .settings-section .btn:not(:last-child) {
            margin-bottom: 10px;
        }
        .activity-log-container {
            background: #ffffff;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(128, 28, 50, 0.1);
            border: 1px solid rgba(128, 28, 50, 0.2);
            max-height: 600px;
            overflow-y: auto;
        }
        .activity-item {
            padding: 12px;
            margin-bottom: 10px;
            background: rgba(128, 28, 50, 0.05);
            border-radius: 8px;
            border-right: 4px solid #801c32;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }
        .activity-item:hover {
            background: rgba(128, 28, 50, 0.1);
            transform: translateX(-3px);
        }
        .activity-item .activity-icon {
            font-size: 1.5rem;
            margin-left: 10px;
        }
        .activity-item .activity-details {
            flex: 1;
        }
        .activity-item .activity-time {
            color: #1a1a1a;
            font-size: 0.85rem;
            font-weight: 600;
        }
        [data-theme="dark"] .activity-item .activity-time {
            color: #f5f5f5;
        }
        .agent-card {
            background: #ffffff;
            border-radius: 15px;
            padding: 20px;
            border: 2px solid #e0e0e0;
            box-shadow: 0 6px 20px rgba(128, 28, 50, 0.1);
            transition: all 0.3s ease;
            position: relative;
        }
        .agent-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 30px rgba(128, 28, 50, 0.15);
            border-color: #801c32;
        }
        .agent-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e0e0e0;
        }
        .agent-card-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: #801c32;
        }
        .agent-card-actions {
            display: flex;
            gap: 10px;
        }
        .agent-card-actions button {
            padding: 8px 15px;
            font-size: 0.9rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .btn-edit {
            background: #2C5F8D;
            color: white;
        }
        .btn-send {
            background: #25D366;
            color: white;
        }
        .btn-delete {
            background: #ef4444;
            color: white;
        }
        .agent-card-improved {
            background: var(--card-bg);
            border-radius: 10px;
            padding: 10px 15px;
            border: 2px solid rgba(128, 28, 50, 0.2);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: visible;
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 15px;
            color: #1a1a1a;
            width: 100%;
            box-sizing: border-box;
            min-height: auto;
        }
        [data-theme="dark"] .agent-card-improved {
            border: 2px solid rgba(255, 255, 255, 0.2);
            color: #f5f5f5;
        }
        .agent-card-improved::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, var(--primary-color), var(--primary-hover));
            transform: translateY(-100%);
            transition: transform 0.3s ease;
        }
        .agent-card-improved:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(128, 28, 50, 0.12);
            border-color: var(--primary-color);
        }
        .agent-card-improved:hover::before {
            transform: translateY(0);
        }
        .agent-card-header-improved {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: flex-start;
            gap: 6px;
            flex: 0 0 180px;
            min-width: 180px;
            max-width: 180px;
            padding-right: 12px;
            border-right: 1px solid rgba(128, 28, 50, 0.1);
            box-sizing: border-box;
        }
        .agent-name-section {
            flex: 1;
            min-width: 0;
            width: 100%;
            overflow: hidden;
            box-sizing: border-box;
        }
        .agent-name-title {
            font-size: 0.95rem;
            font-weight: 800;
            color: #1a1a1a;
            margin: 0 0 3px 0;
            line-height: 1.3;
            letter-spacing: 0.1px;
            word-wrap: break-word;
            overflow-wrap: break-word;
            transition: color 0.3s ease;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            width: 100%;
            box-sizing: border-box;
        }
        [data-theme="dark"] .agent-name-title {
            color: #f5f5f5;
        }
        .agent-name-subtitle {
            font-size: 0.75rem;
            font-weight: 600;
            color: #1a1a1a;
            margin: 0 0 4px 0;
            line-height: 1.3;
            transition: color 0.3s ease;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            width: 100%;
            box-sizing: border-box;
        }
        [data-theme="dark"] .agent-name-subtitle {
            color: #f5f5f5;
        }
        .agent-badge {
            display: inline-block;
            padding: 3px 8px;
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            border-radius: 10px;
            font-size: 0.65rem;
            font-weight: 700;
            box-shadow: 0 1px 4px rgba(40, 167, 69, 0.2);
            margin-top: 4px;
            letter-spacing: 0.1px;
        }
        .agent-badge-empty {
            display: inline-block;
            padding: 3px 8px;
            background: rgba(128, 28, 50, 0.08);
            color: #1a1a1a;
            border-radius: 10px;
            font-size: 0.65rem;
            font-weight: 600;
            margin-top: 4px;
            border: 1px solid rgba(128, 28, 50, 0.15);
        }
        [data-theme="dark"] .agent-badge-empty {
            color: #f5f5f5;
        }
        .agent-actions-improved {
            display: flex;
            gap: 4px;
            flex-shrink: 0;
            flex-wrap: wrap;
            align-items: center;
            justify-content: flex-start;
            min-width: auto;
            max-width: none;
            box-sizing: border-box;
            width: 100%;
        }
        .btn-action {
            padding: 5px 8px;
            min-width: 55px;
            width: auto;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 0.65rem;
            font-weight: 700;
            color: white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            letter-spacing: 0.05px;
            white-space: nowrap;
            line-height: 1.3;
            flex-shrink: 0;
        }
        .btn-action:hover:not(:disabled) {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
        }
        .btn-action:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        .btn-action-edit {
            background: linear-gradient(135deg, #2C5F8D, #1e4a6b);
        }
        .btn-action-edit:hover:not(:disabled) {
            background: linear-gradient(135deg, #1e4a6b, #153d5c);
        }
        .btn-action-send {
            background: linear-gradient(135deg, #25D366, #128C7E);
        }
        .btn-action-send:hover:not(:disabled) {
            background: linear-gradient(135deg, #128C7E, #0d6e5f);
        }
        .btn-action-delete {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }
        .btn-action-delete:hover:not(:disabled) {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
        }
        .agent-info-section {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 4px;
            flex-wrap: nowrap;
            flex: 0 0 200px;
            min-width: 200px;
            max-width: 200px;
            padding-right: 12px;
            border-right: 1px solid rgba(128, 28, 50, 0.1);
            box-sizing: border-box;
        }
        .info-item-improved {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 4px 8px;
            background: rgba(128, 28, 50, 0.04);
            border-radius: 5px;
            transition: all 0.25s ease;
            border: 1px solid rgba(128, 28, 50, 0.1);
            white-space: nowrap;
            margin: 0;
            box-sizing: border-box;
            width: 100%;
            clear: both;
            font-size: 0.75rem;
        }
        .info-item-improved:hover {
            background: rgba(128, 28, 50, 0.08);
            border-color: rgba(128, 28, 50, 0.2);
        }
        .info-label {
            font-weight: 600;
            color: #1a1a1a;
            min-width: 45px;
            font-size: 0.75rem;
            transition: color 0.3s ease;
        }
        [data-theme="dark"] .info-label {
            color: #f5f5f5;
        }
        .info-value {
            font-weight: 700;
            color: #1a1a1a;
            flex: 1;
            text-align: right;
            direction: ltr;
            font-size: 0.8rem;
            word-break: break-all;
            transition: color 0.3s ease;
        }
        [data-theme="dark"] .info-value {
            color: #f5f5f5;
        }
        .info-label-empty {
            color: #1a1a1a;
            font-style: italic;
            font-size: 0.85rem;
            text-align: center;
            width: 100%;
            padding: 8px;
            transition: color 0.3s ease;
        }
        [data-theme="dark"] .info-label-empty {
            color: #f5f5f5;
        }
        .agent-reports-section {
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 8px;
            flex: 1;
            min-width: 0;
            box-sizing: border-box;
            margin-top: 0;
            padding-top: 0;
            padding-right: 12px;
            border-right: 1px solid rgba(128, 28, 50, 0.1);
            flex-wrap: wrap;
        }
        .reports-grid {
            display: flex;
            flex-direction: row;
            gap: 6px;
            flex-wrap: wrap;
            align-items: center;
            margin-top: 0;
            margin-bottom: 0;
            flex: 1;
        }
        .report-item {
            padding: 6px 12px;
            border-radius: 6px;
            text-align: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid transparent;
            position: relative;
            overflow: hidden;
            min-width: 100px;
            max-width: 100px;
            flex: 1 1 100px;
            white-space: nowrap;
        }
        .report-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s ease;
        }
        .report-item:hover::before {
            left: 100%;
        }
        .report-item:hover {
            transform: translateY(-2px) scale(1.03);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            border-color: rgba(128, 28, 50, 0.3);
        }
        .report-basic {
            background: linear-gradient(135deg, #5b12fa 0%, #0629f1 100%);
            border-color: #e43007;
        }
        .report-basic .report-label,
        .report-basic .report-value,
        .report-basic .currency {
            color: #ffffff !important;
        }
        .report-advanced {
            background: linear-gradient(135deg, #f40202 0%, #fd0000 100%);
            border-color: #000000;
        }
        .report-advanced .report-label,
        .report-advanced .report-value,
        .report-advanced .currency {
            color: #ffffff !important;
        }
        .report-twomonths {
            background: linear-gradient(135deg, #00ff73 0%, #00f90c 100%);
            border-color: #f59e0b;
        }
        .report-twomonths .report-label,
        .report-twomonths .report-value,
        .report-twomonths .currency {
            color: #ffffff !important;
        }
        .report-label {
            font-size: 0.65rem;
            font-weight: 700;
            color: #1a1a1a;
            margin-bottom: 3px;
            letter-spacing: 0.1px;
        }
        [data-theme="dark"] .report-label {
            color: #f5f5f5;
        }
        [data-theme="dark"] .report-basic .report-label,
        [data-theme="dark"] .report-basic .report-value,
        [data-theme="dark"] .report-basic .currency {
            color: #ffffff !important;
        }
        [data-theme="dark"] .report-advanced .report-label,
        [data-theme="dark"] .report-advanced .report-value,
        [data-theme="dark"] .report-advanced .currency {
            color: #ffffff !important;
        }
        [data-theme="dark"] .report-twomonths .report-label,
        [data-theme="dark"] .report-twomonths .report-value,
        [data-theme="dark"] .report-twomonths .currency {
            color: #ffffff !important;
        }
        .report-value {
            font-size: 0.75rem;
            font-weight: 900;
            color: #1a1a1a;
            line-height: 1.2;
        }
        [data-theme="dark"] .report-value {
            color: #f5f5f5;
        }
        .currency {
            font-size: 0.65rem;
            font-weight: 600;
            color: #1a1a1a;
        }
        [data-theme="dark"] .currency {
            color: #f5f5f5;
        }
        .agent-total-section {
            background: linear-gradient(135deg, #801c32 0%, #a52d45 100%);
            padding: 6px 12px;
            border-radius: 6px;
            text-align: center;
            color: white;
            box-shadow: 0 2px 8px rgba(128, 28, 50, 0.2);
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.1);
            min-width: 100px;
            max-width: 100px;
            flex: 0 0 100px;
            white-space: nowrap;
            margin-top: 0;
        }
        .agent-total-section::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
        }
        .total-label {
            font-size: 0.7rem;
            font-weight: 700;
            margin-bottom: 2px;
            opacity: 0.95;
            letter-spacing: 0.1px;
            position: relative;
            z-index: 1;
        }
        .total-value {
            font-size: 0.9rem;
            font-weight: 900;
            line-height: 1.2;
            position: relative;
            z-index: 1;
        }
        .total-value .currency {
            font-size: 0.75rem;
            opacity: 0.95;
            color: rgba(255, 255, 255, 0.98);
            font-weight: 700;
        }
        .no-reports-message {
            text-align: center;
            padding: 10px 12px;
            background: rgba(128, 28, 50, 0.04);
            border-radius: 8px;
            border: 1px dashed rgba(128, 28, 50, 0.25);
            margin: 0;
            box-sizing: border-box;
            width: 100%;
            clear: both;
        }
        .no-reports-message p {
            color: #999;
            font-size: 0.75rem;
            margin: 0;
            font-style: italic;
            line-height: 1.4;
            padding: 0;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 10002;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
        }
        [data-theme="dark"] .modal {
            background: rgba(0, 0, 0, 0.8);
        }
        .modal.show {
            display: flex;
        }
        .modal-content {
            background: var(--modal-bg);
            padding: 30px;
            border-radius: 20px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px var(--shadow-lg);
            border: 3px solid var(--primary-color);
            color: var(--text-primary);
            transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--primary-color);
            transition: border-color 0.3s ease;
        }
        .modal-header h3 {
            color: var(--primary-color);
            font-size: 1.5rem;
            transition: color 0.3s ease;
        }
        .modal-close {
            background: transparent;
            border: none;
            font-size: 2rem;
            color: var(--primary-color);
            cursor: pointer;
            padding: 0;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s ease;
        }
        .modal-close:hover {
            background: var(--nav-hover);
        }
        .message-customization {
            max-width: 700px;
            width: 95%;
        }
        .offer-options {
            margin: 20px 0;
            padding: 15px;
            background: rgba(128, 28, 50, 0.05);
            border-radius: 10px;
        }
        .offer-options h4 {
            color: #801c32;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }
        .offer-checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 15px;
        }
        .offer-checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 15px;
            background: white;
            border-radius: 8px;
            border: 2px solid #e0e0e0;
            cursor: pointer;
            transition: all 0.3s ease;
            flex: 1;
            min-width: 150px;
        }
        .offer-checkbox-item:hover {
            border-color: #801c32;
            background: rgba(128, 28, 50, 0.05);
        }
        .offer-checkbox-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        .offer-checkbox-item label {
            cursor: pointer;
            font-weight: 600;
            flex: 1;
            margin: 0;
        }
        .message-textarea,
        textarea,
        select {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            text-rendering: optimizeLegibility;
            font-weight: 500;
            line-height: 1.6;
        }
        .message-textarea {
            width: 100%;
            min-height: 150px;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1rem;
            font-family: 'Cairo', 'Segoe UI', 'Arial', sans-serif;
            font-weight: 500;
            resize: vertical;
            direction: rtl;
            text-align: right;
            line-height: 1.6;
        }
        .message-textarea:focus {
            outline: none;
            border-color: #801c32;
            box-shadow: 0 0 0 3px rgba(128, 28, 50, 0.1);
            font-weight: 600;
        }
        .message-preview {
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 2px solid #e0e0e0;
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
            font-size: 0.95rem;
            direction: rtl;
            text-align: right;
        }
        .preview-label {
            font-weight: 700;
            color: #801c32;
            margin-bottom: 10px;
            display: block;
        }
        .info-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        .info-btn {
            padding: 8px 15px;
            background: #2C5F8D;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.3s ease;
        }
        .info-btn:hover {
            background: #1e4a6b;
            transform: none;
        }
        *,
        *::before,
        *::after {
            transition: none !important;
            animation: none !important;
        }
        *:hover,
        *:focus,
        *:active {
            transform: none !important;
        }
    </style>
</head>
<body>
    <div id="loginScreen" class="login-container">
        <div class="login-card">
            <h1>Ù‚Ø³Ù… Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</h1>
            <div id="loginAlert"></div>
            <div class="form-group">
                <label for="loginUsername">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
                <input type="text" id="loginUsername" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
            </div>
            <div class="form-group">
                <label for="loginPassword">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                <input type="password" id="loginPassword" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
            </div>
            <div class="btn-group" style="flex-direction: column;">
                <button class="btn btn-primary" id="loginButton" style="width: 100%;">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
            </div>
        </div>
    </div>

    <div class="container">
        <div id="dashboard" class="dashboard hidden">
            <button class="sidebar-toggle-btn sidebar-toggle-external" id="sidebarToggleBtnExternal" onclick="toggleSidebar()" title="Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©">
                â˜°
            </button>
            <div class="sidebar" id="sidebar">
                <div class="sidebar-header">
                    <div style="display: flex; gap: 10px; align-items: center; justify-content: flex-start; position: absolute; top: 15px; right: 15px; z-index: 10001; pointer-events: auto;">
                        <button class="theme-toggle-btn-small" onclick="toggleTheme()" id="themeToggleBtn" title="ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø¸Ù„Ù…/Ø§Ù„ÙØ§ØªØ­" style="pointer-events: auto; z-index: 10002;">
                            <span id="themeToggleIcon">ðŸŒ™</span>
                        </button>
                        <button class="sidebar-toggle-btn" id="sidebarToggleBtn" onclick="toggleSidebar()" title="Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©" style="pointer-events: auto; z-index: 10002;">
                            â˜°
                        </button>
                    </div>
                    <h1>Ù‚Ø³Ù… Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</h1>
                    <div class="sidebar-user-info" style="display: flex; flex-direction: column; align-items: center; gap: 8px; margin-top: 0;">
                        <div id="sidebarUser" class="sidebar-user-name" style="background: linear-gradient(135deg, #801c32, #a52d45); color: white; padding: 14px 18px; border-radius: 12px; font-weight: 700; font-size: 1rem; box-shadow: 0 4px 12px rgba(128, 28, 50, 0.4); text-align: center; letter-spacing: 0.5px; border: 2px solid rgba(255, 255, 255, 0.3); position: relative; cursor: pointer; user-select: none; -webkit-user-select: none; transition: all 0.3s ease; width: 100%; box-sizing: border-box;" onclick="toggleUserContactPopup(event)">
                            <div style="display: flex; flex-direction: column; align-items: center; gap: 4px;">
                                <div style="display: flex; align-items: center; justify-content: center; gap: 8px;">
                                    <span style="font-size: 1.3rem;"></span>
                                    <span style="font-size: 1.05rem; font-weight: 700;">Ameer Helwas</span>
                                </div>
                                <div style="font-size: 0.75rem; opacity: 0.9; font-weight: 500;"></div>
                            </div>
                            <div id="userContactPopup" class="user-contact-popup">
                                <div class="user-contact-item">
                                    <span class="user-contact-icon">
                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z" fill="#0078d4"/>
                                        </svg>
                                    </span>
                                    <a href="mailto:ameeralgaraawi@hotmail.com">Email</a>
                                </div>
                                <div class="user-contact-item">
                                    <span class="user-contact-icon">
                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z" fill="#E4405F"/>
                                        </svg>
                                    </span>
                                    <a href="https://instagram.com/ameer_7elwas" target="_blank">instagram</a>
                                </div>
                                <div class="user-contact-item">
                                    <span class="user-contact-icon">
                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M12 0C5.373 0 0 5.373 0 12s5.373 12 12 12 12-5.373 12-12S18.627 0 12 0zm5.894 8.221l-1.97 9.28c-.145.658-.537.818-1.084.508l-3-2.21-1.446 1.394c-.14.18-.357.295-.6.295-.002 0-.003 0-.005 0l.213-3.054 5.56-5.022c.24-.213-.054-.334-.373-.121l-6.869 4.326-2.96-.924c-.64-.203-.658-.64.135-.954l11.566-4.458c.538-.196 1.006.128.832.941z" fill="#0088cc"/>
                                        </svg>
                                    </span>
                                    <a href="https://t.me/ameer_7elwas" target="_blank">Telegram</a>
                                </div>
                                <div class="user-contact-item">
                                    <span class="user-contact-icon">
                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.98 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z" fill="#25D366"/>
                                        </svg>
                                    </span>
                                    <a href="https://wa.me/9647701024143" target="_blank">ÙˆØ§ØªØ³Ø§Ø¨</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="sidebar-nav">
                    <div class="nav-item active" onclick="switchTab('summary')">
                        <span class="nav-icon">ðŸ </span>
                        <span class="nav-text">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
                    </div>
                    <div class="nav-item" onclick="switchTab('basic')">
                        <span class="nav-icon">ðŸŽ</span>
                        <span class="nav-text">Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠ</span>
                    </div>
                    <div class="nav-item" onclick="switchTab('twoMonths')">
                        <span class="nav-icon">ðŸ“…</span>
                        <span class="nav-text">Ø¹Ø±Ø¶ Ø´Ù‡Ø±ÙŠÙ† Ù…Ø®ÙØ¶</span>
                    </div>
                    <div class="nav-item" onclick="switchTab('advanced')">
                        <span class="nav-icon">ðŸ“†</span>
                        <span class="nav-text">Ø¹Ø±Ø¶ 3 Ø£Ø´Ù‡Ø± Ù…Ø®ÙØ¶</span>
                    </div>
                    <div class="nav-item" onclick="switchTab('agents')">
                        <span class="nav-icon">ðŸ‘¥</span>
                        <span class="nav-text">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙˆÙƒÙ„Ø§Ø¡ ÙˆØ¹Ø±ÙˆØ¶Ù‡Ù…</span>
                    </div>
                    <div class="nav-item" onclick="switchTab('agentPercentage')">
                        <span class="nav-icon">ðŸ“Š</span>
                        <span class="nav-text">Ù†Ø³Ø¨Ø© Ø§Ù„ÙˆÙƒÙ„Ø§Ø¡</span>
                    </div>
                    <div class="nav-item" onclick="switchTab('ministryPercentage')">
                        <span class="nav-icon">ðŸ›ï¸</span>
                        <span class="nav-text">Ù†Ø³Ø¨Ø© Ø§Ù„ÙˆØ²Ø§Ø±Ø©</span>
                    </div>
                    <div class="nav-item" onclick="switchTab('activity')">
                        <span class="nav-icon">ðŸ“</span>
                        <span class="nav-text">Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</span>
                    </div>
                    <div class="nav-item" onclick="switchTab('settings')">
                        <span class="nav-icon">âš™ï¸</span>
                        <span class="nav-text">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</span>
                    </div>
                    <div class="nav-item" onclick="switchTab('archive')">
                        <span class="nav-icon">ðŸ“¦</span>
                        <span class="nav-text">Ø§Ù„Ø£Ø±Ø´ÙŠÙ</span>
                    </div>
                    <div class="nav-item admin-only" onclick="switchTab('users')" style="display: none;">
                        <span class="nav-icon">ðŸ‘¤</span>
                        <span class="nav-text">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</span>
                    </div>
                </div>
                <div class="sidebar-footer">
                    <button class="btn btn-secondary" onclick="switchUser()" style="width: 100%; background: #6c757d; border-color: #6c757d; color: white; display: flex; align-items: center; justify-content: space-between; padding: 12px 16px;" id="switchUserBtn">
                        <span id="switchUserBtnName" style="font-weight: 600;">${loggedInUser || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</span>
                        <span style="margin-right: 5px; font-size: 1.1rem;">â†»</span>
                    </button>
                    <div class="date-info-sidebar" id="currentDateTime" style="margin-top: 10px;"></div>
                </div>
            </div>
            <div class="main-content">
            <div id="basicTab" class="tab-content">
                <div class="section">
                    <h3 class="section-title">
                         Ø±ÙØ¹ Excel Ø§Ù„ÙˆÙƒÙŠÙ„ Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠ
                    </h3>
                    <div style="background: #fff3cd; border: 2px solid #ffc107; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                        <div style="display: flex; align-items: start; gap: 10px;">
                            <div style="font-size: 1.5rem; color: #ffc107;">âš ï¸</div>
                            <div style="flex: 1;">
                                <h4 style="margin: 0 0 15px 0; color: #856404; font-size: 1.1rem; font-weight: 700;">ØªÙ†Ø¨ÙŠÙ‡ Ù…Ù‡Ù…</h4>
                                <p style="margin: 0 0 15px 0; color: #856404; font-size: 0.95rem; line-height: 1.8;">
                                    ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ù…Ù„Ù Ø§Ù„Ù€ Excel Ø§Ù„Ù…Ø±ÙÙ‚ ÙŠØ¹ÙˆØ¯ Ø¥Ù„Ù‰ Ù†ÙØ³ Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ.
                                </p>
                                <p style="margin: 0 0 10px 0; color: #856404; font-size: 0.95rem; line-height: 1.8; font-weight: 600;">
                                    Ù„Ù† ÙŠØªÙ… Ø§Ø­ØªØ³Ø§Ø¨ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø¨ØµÙˆØ±Ø© ØµØ­ÙŠØ­Ø© ÙÙŠ Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„ØªØ§Ù„ÙŠØ©:
                                </p>
                                <ul style="margin: 0 0 15px 0; padding-right: 20px; color: #856404; font-size: 0.95rem; line-height: 1.8;">
                                    <li style="margin-bottom: 8px;">Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ù„Ù ÙŠØªØ¶Ù…Ù† Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø´Ù‡Ø± Ø³Ø§Ø¨Ù‚.</li>
                                    <li style="margin-bottom: 8px;">Ø£Ùˆ ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø¢Ù† Ù„ÙƒÙ† ØªØ§Ø±ÙŠØ® Ø¨ÙŠØ§Ù†Ø§ØªÙ‡ Ù‚Ø¯ÙŠÙ….</li>
                                </ul>
                                <div style="background: #d4edda; border: 1px solid #c3e6cb; border-radius: 6px; padding: 12px; margin-bottom: 10px;">
                                    <div style="display: flex; align-items: start; gap: 8px;">
                                        <div style="font-size: 1.2rem; color: #28a745;">âœ…</div>
                                        <div style="flex: 1;">
                                            <strong style="color: #155724; display: block; margin-bottom: 8px;">Ø¹Ù„Ù‰ Ø³Ø¨ÙŠÙ„ Ø§Ù„Ù…Ø«Ø§Ù„:</strong>
                                            <ul style="margin: 0; padding-right: 20px; color: #155724; font-size: 0.9rem; line-height: 1.8;">
                                                <li style="margin-bottom: 6px;">ÙÙŠ Ø´Ù‡Ø± ØªØ´Ø±ÙŠÙ† Ø§Ù„Ø£ÙˆÙ„ (10) ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø§Ù„Ù…Ù„Ù Ø®Ø§ØµÙ‹Ø§ Ø¨Ù†ÙØ³ Ø§Ù„Ø´Ù‡Ø± (10).</li>
                                                <li>ÙÙŠ Ø´Ù‡Ø± ØªØ´Ø±ÙŠÙ† Ø§Ù„Ø«Ø§Ù†ÙŠ (11) ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø§Ù„Ù…Ù„Ù Ø®Ø§ØµÙ‹Ø§ Ø¨Ø§Ù„Ø´Ù‡Ø± (11).</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                                <p style="margin: 0; color: #856404; font-size: 0.95rem; line-height: 1.8; font-weight: 600;">
                                       ØªÙØ¹Ø±Ø¶ Ù†ØªØ§Ø¦Ø¬ ØºÙŠØ± Ø¯Ù‚ÙŠÙ‚Ø© ÙÙŠ Ø­Ø§Ù„ Ø¹Ø¯Ù… ØªØ·Ø§Ø¨Ù‚ Ø§Ù„Ø´Ù‡Ø± Ø¨ÙŠÙ† ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ù„Ù ÙˆØ§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ.
                                </p>
                            </div>
                        </div>
                    </div>
                    <div class="file-upload" id="basicFileUpload">
                        <p> Ø§Ø³Ø­Ø¨ Ù…Ù„Ù Excel Ø£Ùˆ CSV Ù‡Ù†Ø§ Ø£Ùˆ Ø§Ù†Ù‚Ø± Ù„Ù„Ø§Ø®ØªÙŠØ§Ø±</p>
                        <input type="file" id="basicFileInput" accept=".xlsx,.xls,.csv" style="display: none;">
                    </div>
                </div>
                <div class="section">
                    <h3 class="section-title">
                         ØªØ­Ù„ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠ
                    </h3>
                    <p style="color: var(--text-primary); margin-bottom: 15px; font-size: 1rem; font-weight: 600;">
                    </p>
                    <button class="btn btn-primary" onclick="analyzeBasicData()">
                         ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                    </button>
                    <button class="btn btn-warning" onclick="resetBasicResults()">
                         Ù…Ø³Ø­ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
                    </button>
                </div>
                <div id="basicResults" class="section hidden">
                    <h3 class="section-title">
                         Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠ
                    </h3>
                    <div id="basicAgentInfo" class="agent-info"></div>
                    <div class="results-grid" id="basicResultsGrid"></div>
                    <div style="text-align: center; margin-top: 20px;">
                        <button class="btn btn-success" onclick="saveBasicReport()">
 Ø­ÙØ¸ Ø§Ù„ØªÙ‚Ø±ÙŠØ±
                        </button>
                        <button class="btn btn-warning" onclick="exportBasicData()">
 ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                        </button>
                        <button class="btn btn-success" onclick="exportBasicDetailsToExcel()">
 ØªØµØ¯ÙŠØ± Excel Ø¨Ø§Ù„ØªÙØ§ØµÙŠÙ„
                        </button>
                    </div>
                </div>
                <div id="basicLoading" class="loading">
                    <div class="spinner"></div>
                    <p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù„ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠ...</p>
                </div>
            </div>
            <div id="advancedTab" class="tab-content">
                <div class="section">
                    <h3 class="section-title">
 Ø±ÙØ¹ Excel Ø§Ù„ÙˆÙƒÙŠÙ„ Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø®ÙØ¶ Ù„Ø«Ù„Ø§Ø« Ø£Ø´Ù‡Ø±
                    </h3>
                    <div class="file-upload" id="advancedFileUpload">
                        <p> Ø§Ø³Ø­Ø¨ Ù…Ù„Ù Excel Ø£Ùˆ CSV Ù‡Ù†Ø§ Ø£Ùˆ Ø§Ù†Ù‚Ø± Ù„Ù„Ø§Ø®ØªÙŠØ§Ø±</p>
                        <input type="file" id="advancedFileInput" accept=".xlsx,.xls,.csv" style="display: none;">
                    </div>
                </div>
                <div class="section">
                    <h3 class="section-title">
                         ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø®ÙØ¶ Ù„Ø«Ù„Ø§Ø« Ø£Ø´Ù‡Ø±
                    </h3>
                    <p style="color: #1a1a1a; margin-bottom: 15px; font-size: 1rem; font-weight: 600;">
                         ÙŠØªÙ… Ø­Ø³Ø§Ø¨ Ø§Ù„ØªÙØ¹ÙŠÙ„ Ø¹Ù†Ø¯ ÙˆØ¬ÙˆØ¯ 3 Ø§Ø´ØªØ±Ø§ÙƒØ§Øª Ù„Ù†ÙØ³ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø®Ù„Ø§Ù„ 5 Ø£ÙŠØ§Ù…<br>
                         Ù…Ù‚Ø§Ø±Ù†Ø© Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø®ÙØ¶ Ù…Ø¹ Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ø±Ø³Ù…ÙŠØ© Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø±Ø§Ø¬Ø¹ Ù„Ù„ÙˆÙƒÙŠÙ„
                    </p>
                    <button class="btn btn-primary" onclick="analyzeAdvancedData()">
                         ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØªÙØ¹ÙŠÙ„Ø§Øª
                    </button>
                    <button class="btn btn-warning" onclick="resetAdvancedResults()">
                         Ù…Ø³Ø­ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
                    </button>
                </div>
                <div id="advancedResults" class="section hidden">
                    <h3 class="section-title">
                         ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª ÙˆØ§Ù„Ù…Ø¨Ø§Ù„Øº 
                    </h3>
                    <div id="advancedAgentInfo" class="agent-info"></div>
                    <div class="results-grid" id="advancedResultsGrid"></div>
                    <div style="text-align: center; margin-top: 20px;">
                        <button class="btn btn-success" onclick="saveAdvancedReport()">
 Ø­ÙØ¸ Ø§Ù„ØªÙ‚Ø±ÙŠØ±
                        </button>
                        <button class="btn btn-warning" onclick="exportAdvancedData()">
 ØªØµØ¯ÙŠØ± Ù„Ù„ÙˆÙƒÙŠÙ„
                        </button>
                        <button class="btn btn-success" onclick="exportAdvancedDetailsToExcel()">
 ØªØµØ¯ÙŠØ± Excel Ø¨Ø§Ù„ØªÙØ§ØµÙŠÙ„
                        </button>
                    </div>
                </div>
                <div id="advancedLoading" class="loading">
                    <div class="spinner"></div>
                    <p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø®ÙØ¶ Ù„Ø«Ù„Ø§Ø« Ø£Ø´Ù‡Ø±...</p>
                </div>
            </div>
            <div id="twoMonthsTab" class="tab-content">
                <div class="section">
                    <h3 class="section-title">
 Ø±ÙØ¹ Excel Ø§Ù„ÙˆÙƒÙŠÙ„ Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø®ÙØ¶ Ù„Ø´Ù‡Ø±ÙŠÙ†
                    </h3>
                    <div class="file-upload" id="twoMonthsFileUpload">
                        <p> Ø§Ø³Ø­Ø¨ Ù…Ù„Ù Excel Ø£Ùˆ CSV Ù‡Ù†Ø§ Ø£Ùˆ Ø§Ù†Ù‚Ø± Ù„Ù„Ø§Ø®ØªÙŠØ§Ø±</p>
                        <input type="file" id="twoMonthsFileInput" accept=".xlsx,.xls,.csv" style="display: none;">
                    </div>
                </div>
                <div class="section">
                    <h3 class="section-title">
                         ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø®ÙØ¶ Ù„Ø´Ù‡Ø±ÙŠÙ†
                    </h3>
                    <p style="color: #1a1a1a; margin-bottom: 15px; font-size: 1rem; font-weight: 600;">
                         ÙŠØªÙ… Ø­Ø³Ø§Ø¨ Ø§Ù„ØªÙØ¹ÙŠÙ„ Ø¹Ù†Ø¯ ÙˆØ¬ÙˆØ¯ 2 Ø§Ø´ØªØ±Ø§ÙƒØ§Øª Ù„Ù†ÙØ³ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø®Ù„Ø§Ù„ 5 Ø£ÙŠØ§Ù…<br>
                         Ù…Ù‚Ø§Ø±Ù†Ø© Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø®ÙØ¶ Ù…Ø¹ Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ø±Ø³Ù…ÙŠØ© Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø±Ø§Ø¬Ø¹ Ù„Ù„ÙˆÙƒÙŠÙ„
                    </p>
                    <button class="btn btn-primary" onclick="analyzeTwoMonthsData()">
                         ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØªÙØ¹ÙŠÙ„Ø§Øª
                    </button>
                    <button class="btn btn-warning" onclick="resetTwoMonthsResults()">
                         Ù…Ø³Ø­ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
                    </button>
                </div>
                <div id="twoMonthsResults" class="section hidden">
                    <h3 class="section-title">
                         ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª ÙˆØ§Ù„Ù…Ø¨Ø§Ù„Øº 
                    </h3>
                    <div id="twoMonthsAgentInfo" class="agent-info"></div>
                    <div class="results-grid" id="twoMonthsResultsGrid"></div>
                    <div style="text-align: center; margin-top: 20px;">
                        <button class="btn btn-success" onclick="saveTwoMonthsReport()">
 Ø­ÙØ¸ Ø§Ù„ØªÙ‚Ø±ÙŠØ±
                        </button>
                        <button class="btn btn-warning" onclick="exportTwoMonthsData()">
 ØªØµØ¯ÙŠØ± Ù„Ù„ÙˆÙƒÙŠÙ„
                        </button>
                        <button class="btn btn-success" onclick="exportTwoMonthsDetailsToExcel()">
 ØªØµØ¯ÙŠØ± Excel Ø¨Ø§Ù„ØªÙØ§ØµÙŠÙ„
                        </button>
                    </div>
                </div>
                <div id="twoMonthsLoading" class="loading">
                    <div class="spinner"></div>
                    <p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø®ÙØ¶ Ù„Ø´Ù‡Ø±ÙŠÙ†...</p>
                </div>
            </div>
            <div id="agentsTab" class="tab-content">
                <div class="section">
                    <h3 class="section-title"> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙˆÙƒÙ„Ø§Ø¡</h3>
                    <div style="margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                        <button class="btn btn-success" onclick="refreshAgentsList()"> ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</button>
                    </div>
                    <div class="agents-controls" style="margin-bottom: 20px; padding: 15px; background: rgba(128, 28, 50, 0.05); border-radius: 12px; display: flex; gap: 15px; flex-wrap: wrap; align-items: center; position: relative; z-index: 10;">
                        <div style="flex: 1; min-width: 250px; position: relative; z-index: 10;">
                            <input type="text" id="agentSearchInput" class="settings-input" placeholder="Ø¨Ø­Ø« Ø¹Ù† ÙˆÙƒÙŠÙ„..." onkeyup="filterAgents()" style="width: 100%; position: relative; z-index: 10; pointer-events: auto;">
                        </div>
                        <div style="display: flex; gap: 10px; align-items: center; position: relative; z-index: 10;">
                            <label style="font-weight: 600; color: var(--text-primary);">ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨:</label>
                            <select id="agentSortSelect" class="settings-input" onchange="sortAgents()" style="min-width: 180px; position: relative; z-index: 10; pointer-events: auto;">
                                <option value="name">Ø§Ù„Ø§Ø³Ù… (Ø£-ÙŠ)</option>
                                <option value="name-desc">Ø§Ù„Ø§Ø³Ù… (ÙŠ-Ø£)</option>
                                <option value="total-desc">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ (Ø§Ù„Ø£Ø¹Ù„Ù‰ Ø£ÙˆÙ„Ø§Ù‹)</option>
                                <option value="total-asc">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ (Ø§Ù„Ø£Ù‚Ù„ Ø£ÙˆÙ„Ø§Ù‹)</option>
                                <option value="reports-desc">Ø¹Ø¯Ø¯ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± (Ø§Ù„Ø£ÙƒØ«Ø± Ø£ÙˆÙ„Ø§Ù‹)</option>
                                <option value="reports-asc">Ø¹Ø¯Ø¯ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± (Ø§Ù„Ø£Ù‚Ù„ Ø£ÙˆÙ„Ø§Ù‹)</option>
                            </select>
                        </div>
                        <div style="color: var(--text-primary); font-size: 0.9rem; font-weight: 600;">
                            <span id="agentsCount">0</span> ÙˆÙƒÙŠÙ„
                        </div>
                    </div>
                    <div id="agentsList" class="agents-grid-improved"></div>
                </div>
            </div>
            <div id="summaryTab" class="tab-content active">
                <div class="section" style="background: linear-gradient(135deg, rgba(128, 28, 50, 0.08) 0%, rgba(255, 255, 255, 0.03) 100%); border-radius: 16px; padding: 20px; margin-bottom: 20px; border: 2px solid var(--border-light); box-shadow: 0 6px 18px rgba(0,0,0,0.08);">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 25px; flex-wrap: wrap; gap: 20px;">
                        <div style="flex: 1;">
                            <h3 class="section-title" style="margin: 0 0 10px 0; font-size: 1.5rem; color: var(--primary-color); font-weight: 900; text-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            </h3>
                            <p style="color: var(--text-secondary); font-size: 1rem; font-weight: 500; margin: 0;">
                               
                            </p>
                        </div>
                        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                            <button class="btn btn-primary" onclick="refreshSummary()" style="padding: 10px 18px; font-weight: 700; font-size: 0.85rem; border-radius: 8px; box-shadow: 0 3px 10px rgba(0,123,255,0.3);">
                                 ØªØ­Ø¯ÙŠØ«
                            </button>
                            <button class="btn btn-success" onclick="exportSummaryToExcel()" style="padding: 10px 18px; font-weight: 700; font-size: 0.85rem; border-radius: 8px; box-shadow: 0 3px 10px rgba(40,167,69,0.3);">
                                 Excel
                            </button>
                            <button class="btn btn-warning" onclick="clearAllAgentReports()" style="padding: 10px 18px; font-weight: 700; font-size: 0.85rem; border-radius: 8px; box-shadow: 0 3px 10px rgba(255,193,7,0.3);">
                                 Ù…Ø³Ø­
                            </button>
                        </div>
                    </div>
                </div>
                
                <div id="summaryTotals" class="section" style="margin-bottom: 30px;">
                    <div class="results-grid" id="summaryTotalsGrid"></div>
                </div>
                
                <div id="chartsSection" class="section" style="display: none; margin-bottom: 30px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                        <h3 class="section-title" style="margin: 0; font-size: 1.3rem; color: var(--primary-color); font-weight: 800;">   Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</h3>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px;">
                        <div style="background: var(--card-bg); border-radius: 12px; padding: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); border: 1px solid var(--border-color); transition: transform 0.3s ease, box-shadow 0.3s ease;" onmouseover="this.style.transform='translateY(-3px)'; this.style.boxShadow='0 6px 16px rgba(0,0,0,0.12)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)'">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                                <div style="font-size: 1.2rem;"></div>
                                <h4 style="margin: 0; color: var(--primary-color); font-size: 1rem; font-weight: 700;">ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø¹Ø±ÙˆØ¶</h4>
                            </div>
                            <canvas id="offersChart" style="max-height: 220px;"></canvas>
                        </div>
                        <div style="background: var(--card-bg); border-radius: 12px; padding: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); border: 1px solid var(--border-color); transition: transform 0.3s ease, box-shadow 0.3s ease;" onmouseover="this.style.transform='translateY(-3px)'; this.style.boxShadow='0 6px 16px rgba(0,0,0,0.12)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)'">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                                <div style="font-size: 1.2rem;"></div>
                                <h4 style="margin: 0; color: var(--primary-color); font-size: 1rem; font-weight: 700;">Ø£Ø¹Ù„Ù‰ Ø§Ù„ÙˆÙƒÙ„Ø§Ø¡</h4>
                            </div>
                            <canvas id="topAgentsChart" style="max-height: 220px;"></canvas>
                        </div>
                        <div style="background: var(--card-bg); border-radius: 12px; padding: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); border: 1px solid var(--border-color); transition: transform 0.3s ease, box-shadow 0.3s ease;" onmouseover="this.style.transform='translateY(-3px)'; this.style.boxShadow='0 6px 16px rgba(0,0,0,0.12)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)'">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                                <div style="font-size: 1.2rem;"></div>
                                <h4 style="margin: 0; color: var(--primary-color); font-size: 1rem; font-weight: 700;">ØªÙˆØ²ÙŠØ¹ Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª</h4>
                            </div>
                            <canvas id="subscriptionsChart" style="max-height: 220px;"></canvas>
                        </div>
                    </div>
                </div>
                
                <div id="summaryResults" class="section">
                    <h3 class="section-title" style="font-size: 1.2rem; margin-bottom: 15px;">
                        ðŸ‘¥ Ù…Ù„Ø®Øµ Ø§Ù„ÙˆÙƒÙ„Ø§Ø¡
                    </h3>
                    <div id="summaryContent">
                        <div style="text-align: center; padding: 60px 20px; background: var(--bg-secondary); border-radius: 12px; border: 2px dashed var(--border-color);">
                            <div style="font-size: 3rem; margin-bottom: 20px;"></div>
                            <p style="color: var(--text-secondary); font-size: 1.1rem; font-weight: 600; margin: 0;">
                                Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø¹Ø±Ø¶
                            </p>
                            <p style="color: var(--text-tertiary); font-size: 0.9rem; margin-top: 10px;">
                                ÙŠØ±Ø¬Ù‰ ØªØ­Ù„ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆÙƒÙ„Ø§Ø¡ Ø£ÙˆÙ„Ø§Ù‹
                            </p>
                        </div>
                    </div>
                </div>
            </div>
            <div id="agentPercentageTab" class="tab-content">
                <div class="section">
                    <h3 class="section-title"> Ù†Ø³Ø¨Ø© Ø§Ù„ÙˆÙƒÙ„Ø§Ø¡</h3>
                    <p style="color: #1a1a1a; margin-bottom: 20px; font-size: 1rem; font-weight: 600;">
                    </p>
                    <div style="margin-bottom: 20px; padding: 20px; background: rgba(128, 28, 50, 0.05); border-radius: 12px;">
                        <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #801c32;">Ø§Ø®ØªØ± Ø§Ù„ÙˆÙƒÙŠÙ„:</label>
                        <select id="selectedAgentForPercentage" class="settings-input" style="width: 100%; margin-bottom: 15px; position: relative; z-index: 10; pointer-events: auto;">
                            <option value="">-- Ø§Ø®ØªØ± ÙˆÙƒÙŠÙ„ --</option>
                        </select>
                        <div id="agentFileUploadSection" style="display: none;">
                            <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #801c32;">Ø±ÙØ¹ Ù…Ù„Ù Excel Ù„Ù„ÙˆÙƒÙŠÙ„:</label>
                            <div class="file-upload" id="percentageFileUpload">
                                <p> Ø§Ø³Ø­Ø¨ Ù…Ù„Ù Excel Ù‡Ù†Ø§ Ø£Ùˆ Ø§Ù†Ù‚Ø± Ù„Ù„Ø§Ø®ØªÙŠØ§Ø±</p>
                                <input type="file" id="percentageFileInput" accept=".xlsx,.xls" style="display: none;">
                            </div>
                            <div id="percentageFileName" class="success-message hidden" style="margin-top: 10px;"></div>
                            <div style="margin-top: 15px;">
                                <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #801c32;">Ø§Ù„Ù†Ø³Ø¨Ø©</label>
                                <input type="number" id="percentageRateSelect" class="settings-input" value="16" min="0" max="100" step="0.01" style="width: 200px; position: relative; z-index: 10; pointer-events: auto;" onchange="updatePercentageRate()">
                                <p style="margin-top: 5px; font-size: 0.85rem; color: var(--text-primary); font-weight: 600;" id="percentageRateInfo">
                                    Ø³ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© Ù„Ù„ÙˆÙƒÙŠÙ„ (16% Ø§ÙØªØ±Ø§Ø¶ÙŠ)
                                </p>
                            </div>
                            <div style="margin-top: 20px; display: flex; gap: 10px;">
                                <button class="btn btn-primary" onclick="analyzeAgentPercentageData()"> ØªØ­Ù„ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆÙƒÙŠÙ„</button>
                                <button class="btn btn-warning" onclick="resetPercentageData()"> Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="percentageResults" class="section hidden" style="padding: 20px; overflow: visible; overflow-x: hidden; width: 100%; max-width: 100%; box-sizing: border-box;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; width: 100%; max-width: 100%; box-sizing: border-box;">
                        <h3 class="section-title" style="margin: 0; font-size: 1.3rem; padding-bottom: 10px;"> Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø³Ø¨Ø© Ø§Ù„ÙˆÙƒÙ„Ø§Ø¡</h3>
                        <button class="btn btn-success" onclick="exportPercentageToExcel()" style="padding: 8px 16px; font-size: 0.85rem;">
                            ØªØµØ¯ÙŠØ± Excel
                        </button>
                    </div>
                    <div id="percentageTableContainer" style="overflow-x: auto; overflow-y: auto; max-height: 70vh; width: 100%; max-width: 100%; position: relative; z-index: 1; -webkit-overflow-scrolling: touch; overscroll-behavior: contain; box-sizing: border-box; will-change: scroll-position; contain: layout style paint;">
                        <table id="percentageTable" style="width: auto; min-width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.8rem; table-layout: auto; box-sizing: border-box;">
                            <thead>
                                <tr style="background: #801c32; color: white;">
                                    <th rowspan="2" style="padding: 8px 6px; text-align: center; border: 1px solid #ddd; vertical-align: middle; font-size: 0.75rem; font-weight: 600; background-color: #801c32;">Ø§Ø³Ù… Ø§Ù„ÙˆÙƒÙŠÙ„</th>
                                    <th rowspan="2" style="padding: 8px 6px; text-align: center; border: 1px solid #ddd; vertical-align: middle; font-size: 0.75rem; font-weight: 600;">B</th>
                                    <th rowspan="2" style="padding: 8px 6px; text-align: center; border: 1px solid #ddd; vertical-align: middle; font-size: 0.75rem; font-weight: 600;">S</th>
                                    <th rowspan="2" style="padding: 8px 6px; text-align: center; border: 1px solid #ddd; vertical-align: middle; font-size: 0.75rem; font-weight: 600;">G</th>
                                    <th rowspan="2" style="padding: 8px 6px; text-align: center; border: 1px solid #ddd; vertical-align: middle; font-size: 0.75rem; font-weight: 600;">P</th>
                                    <th rowspan="2" style="padding: 8px 6px; text-align: center; border: 1px solid #ddd; vertical-align: middle; font-size: 0.75rem; font-weight: 600;">Ù…Ø¬Ù…ÙˆØ¹<br>Ø§Ù„ØªÙØ¹ÙŠÙ„Ø§Øª</th>
                                    <th colspan="5" style="padding: 8px 6px; text-align: center; border: 1px solid #ddd; font-size: 0.75rem; font-weight: 600;">Ø§Ù„Ù…Ø¨Ø§Ù„Øº</th>
                                    <th colspan="4" style="padding: 8px 6px; text-align: center; border: 1px solid #ddd; font-size: 0.75rem; font-weight: 600;">16% Ù†Ø³Ø¨Ø© Ø§Ù„ÙˆÙƒÙŠÙ„</th>
                                    <th rowspan="2" style="padding: 8px 6px; text-align: center; border: 1px solid #ddd; vertical-align: middle; font-size: 0.75rem; font-weight: 600;">Ù†Ø³Ø¨Ø© Ø§Ù„ÙˆÙƒÙŠÙ„<br>16%</th>
                                    <th rowspan="2" style="padding: 8px 6px; text-align: center; border: 1px solid #ddd; vertical-align: middle; font-size: 0.75rem; font-weight: 600;">Ø§Ø³ØªÙ‚Ø·Ø§Ø¹Ø§Øª</th>
                                    <th rowspan="2" style="padding: 8px 6px; text-align: center; border: 1px solid #ddd; vertical-align: middle; font-size: 0.75rem; font-weight: 600;">ØºØ±Ø§Ù…Ø§Øª</th>
                                    <th rowspan="2" style="padding: 8px 6px; text-align: center; border: 1px solid #ddd; vertical-align: middle; font-size: 0.75rem; font-weight: 600;">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                                </tr>
                                <tr style="background: #801c32; color: white;">
                                    <th style="padding: 6px 4px; text-align: center; border: 1px solid #ddd; font-size: 0.7rem; font-weight: 500;">IQ.B</th>
                                    <th style="padding: 6px 4px; text-align: center; border: 1px solid #ddd; font-size: 0.7rem; font-weight: 500;">IQ.S</th>
                                    <th style="padding: 6px 4px; text-align: center; border: 1px solid #ddd; font-size: 0.7rem; font-weight: 500;">IQ.G</th>
                                    <th style="padding: 6px 4px; text-align: center; border: 1px solid #ddd; font-size: 0.7rem; font-weight: 500;">IQ.P</th>
                                    <th style="padding: 6px 4px; text-align: center; border: 1px solid #ddd; font-size: 0.7rem; font-weight: 500;">IQ.T</th>
                                    <th style="padding: 6px 4px; text-align: center; border: 1px solid #ddd; font-size: 0.7rem; font-weight: 500;">IQ.B%16</th>
                                    <th style="padding: 6px 4px; text-align: center; border: 1px solid #ddd; font-size: 0.7rem; font-weight: 500;">IQ.S%16</th>
                                    <th style="padding: 6px 4px; text-align: center; border: 1px solid #ddd; font-size: 0.7rem; font-weight: 500;">IQ.G%16</th>
                                    <th style="padding: 6px 4px; text-align: center; border: 1px solid #ddd; font-size: 0.7rem; font-weight: 500;">IQ.P%16</th>
                                </tr>
                            </thead>
                            <tbody id="percentageTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div id="ministryPercentageTab" class="tab-content">
                <div class="section">
                    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 25px; padding: 20px; background: linear-gradient(135deg, rgba(128, 28, 50, 0.1) 0%, rgba(128, 28, 50, 0.05) 100%); border-radius: 12px; border: 2px solid rgba(128, 28, 50, 0.2);">
                        <div style="width: 80px; height: 80px; background: linear-gradient(135deg, #801c32 0%, #a0263d 100%); border-radius: 15px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 15px rgba(128, 28, 50, 0.3);">
                            <span style="font-size: 45px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));">ðŸ›ï¸</span>
                        </div>
                        <div style="flex: 1;">
                            <h3 class="section-title" style="margin: 0 0 8px 0; font-size: 1.8rem; color: #801c32; font-weight: 800; text-shadow: 0 2px 4px rgba(0,0,0,0.1);">Ù†Ø³Ø¨Ø© Ø§Ù„ÙˆØ²Ø§Ø±Ø©</h3>
                            <p style="margin: 0; color: #666; font-size: 0.95rem; line-height: 1.5;">Ø­Ø³Ø§Ø¨ Ù†Ø³Ø¨Ø© Ø§Ù„ÙˆØ²Ø§Ø±Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª (Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ù‚Ø¯ÙŠÙ… ÙˆØ§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ø¬Ø¯ÙŠØ¯)</p>
                        </div>
                    </div>
                    <div style="margin-bottom: 20px; padding: 20px; background: rgba(128, 28, 50, 0.05); border-radius: 12px;">
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #801c32;">Ø±ÙØ¹ Ù…Ù„Ù Excel Ø¨Ø§Ù„ØªÙØ¹ÙŠÙ„Ø§Øª:</label>
                            <div class="file-upload" id="ministryFileUpload">
                                <p> Ø§Ø³Ø­Ø¨ Ù…Ù„Ù Excel Ù‡Ù†Ø§ Ø£Ùˆ Ø§Ù†Ù‚Ø± Ù„Ù„Ø§Ø®ØªÙŠØ§Ø±</p>
                                <input type="file" id="ministryFileInput" accept=".xlsx,.xls" style="display: none;">
                            </div>
                            <div id="ministryFileName" class="success-message hidden" style="margin-top: 10px;"></div>
                        </div>
                        <div style="margin-top: 20px; display: flex; gap: 10px;">
                            <button class="btn btn-primary" onclick="analyzeMinistryPercentageData()">ØªØ­Ù„ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø³Ø¨Ø© Ø§Ù„ÙˆØ²Ø§Ø±Ø©</button>
                            <button class="btn btn-warning" onclick="resetMinistryData()">Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
                        </div>
                    </div>
                </div>
                <div id="ministryResults" class="section hidden" style="padding: 20px; overflow: visible; overflow-x: hidden; width: 100%; max-width: 100%; box-sizing: border-box;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; width: 100%; max-width: 100%; box-sizing: border-box;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div style="width: 50px; height: 50px; background: linear-gradient(135deg, #801c32 0%, #a0263d 100%); border-radius: 10px; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 8px rgba(128, 28, 50, 0.25);">
                                <span style="font-size: 28px; filter: drop-shadow(0 1px 2px rgba(0,0,0,0.2));">ðŸ›ï¸</span>
                            </div>
                            <h3 class="section-title" style="margin: 0; font-size: 1.3rem; padding-bottom: 10px; color: #801c32; font-weight: 700;">Ù†Ø³Ø¨Ø© Ø§Ù„ÙˆØ²Ø§Ø±Ø©</h3>
                        </div>
                        <button class="btn btn-success" onclick="exportMinistryPercentageToExcel()" style="padding: 8px 16px; font-size: 0.85rem;">
                            ØªØµØ¯ÙŠØ± Excel
                        </button>
                    </div>
                    <div id="ministryTableContainer" style="overflow-x: auto; overflow-y: auto; max-height: 70vh; width: 100%; max-width: 100%; position: relative; z-index: 1; -webkit-overflow-scrolling: touch; overscroll-behavior: contain; box-sizing: border-box; will-change: scroll-position; contain: layout style paint;">
                        <table id="ministryTable" style="width: auto; min-width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.8rem; table-layout: auto; box-sizing: border-box;">
                            <thead>
                                <tr style="background: #801c32; color: white;">
                                    <th rowspan="2" style="padding: 8px 6px; text-align: center; border: 1px solid #ddd; vertical-align: middle; font-size: 0.75rem; font-weight: 600; background-color: #801c32;">Ù†ÙˆØ¹ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ</th>
                                    <th colspan="5" id="ministryOldProjectHeader" style="padding: 8px 6px; text-align: center; border: 1px solid #ddd; font-size: 0.75rem; font-weight: 600;">Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ù‚Ø¯ÙŠÙ… (50%)</th>
                                    <th colspan="5" id="ministryNewProjectHeader" style="padding: 8px 6px; text-align: center; border: 1px solid #ddd; font-size: 0.75rem; font-weight: 600;">Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ø¬Ø¯ÙŠØ¯ (27%)</th>
                                    <th rowspan="2" style="padding: 8px 6px; text-align: center; border: 1px solid #ddd; vertical-align: middle; font-size: 0.75rem; font-weight: 600;">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙƒÙ„ÙŠ</th>
                                </tr>
                                <tr style="background: #801c32; color: white;">
                                    <th style="padding: 6px 4px; text-align: center; border: 1px solid #ddd; font-size: 0.7rem; font-weight: 500;">Ø¹Ø¯Ø¯ Ø§Ù„ÙƒØ§Ø±ØªØ§Øª</th>
                                    <th style="padding: 6px 4px; text-align: center; border: 1px solid #ddd; font-size: 0.7rem; font-weight: 500;">Ø§Ù„Ø³Ø¹Ø±</th>
                                    <th style="padding: 6px 4px; text-align: center; border: 1px solid #ddd; font-size: 0.7rem; font-weight: 500;">Ø§Ù„Ù…Ø¨Ù„Øº</th>
                                    <th id="ministryOldProjectPercentageHeader" style="padding: 6px 4px; text-align: center; border: 1px solid #ddd; font-size: 0.7rem; font-weight: 500;">Ù†Ø³Ø¨Ø© Ø§Ù„ÙˆØ²Ø§Ø±Ø© 50%</th>
                                    <th style="padding: 6px 4px; text-align: center; border: 1px solid #ddd; font-size: 0.7rem; font-weight: 500;">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø³ØªØ­Ù‚</th>
                                    <th style="padding: 6px 4px; text-align: center; border: 1px solid #ddd; font-size: 0.7rem; font-weight: 500;">Ø¹Ø¯Ø¯ Ø§Ù„ÙƒØ§Ø±ØªØ§Øª</th>
                                    <th style="padding: 6px 4px; text-align: center; border: 1px solid #ddd; font-size: 0.7rem; font-weight: 500;">Ø§Ù„Ø³Ø¹Ø±</th>
                                    <th style="padding: 6px 4px; text-align: center; border: 1px solid #ddd; font-size: 0.7rem; font-weight: 500;">Ø§Ù„Ù…Ø¨Ù„Øº</th>
                                    <th id="ministryNewProjectPercentageHeader" style="padding: 6px 4px; text-align: center; border: 1px solid #ddd; font-size: 0.7rem; font-weight: 500;">Ù†Ø³Ø¨Ø© Ø§Ù„ÙˆØ²Ø§Ø±Ø© 27%</th>
                                    <th style="padding: 6px 4px; text-align: center; border: 1px solid #ddd; font-size: 0.7rem; font-weight: 500;">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø³ØªØ­Ù‚</th>
                                </tr>
                            </thead>
                            <tbody id="ministryTableBody">
                            </tbody>
                        </table>
                    </div>
                    <div id="ministrySummary" style="margin-top: 20px; padding: 15px; background: rgba(128, 28, 50, 0.05); border-radius: 8px; display: none;">
                        <h4 style="margin: 0 0 10px 0; color: #801c32; font-weight: 700;">Ù…Ù„Ø®Øµ Ø§Ù„Ù†ØªØ§Ø¦Ø¬</h4>
                        <div id="ministrySummaryContent"></div>
                    </div>
                    <div id="ministryPriceDifferences" class="section hidden" style="margin-top: 20px; padding: 15px; background: rgba(255, 193, 7, 0.1); border-radius: 8px; border: 2px solid rgba(255, 193, 7, 0.3);">
                        <h4 style="margin: 0 0 15px 0; color: #856404; font-weight: 700; display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 1.2rem;">âš ï¸</span>
                            Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª Ø§Ù„ØªÙŠ ÙÙŠÙ‡Ø§ Ø§Ø®ØªÙ„Ø§Ù ÙÙŠ Ø§Ù„Ø³Ø¹Ø±
                        </h4>
                        <div id="ministryPriceDifferencesContent" style="overflow-x: auto;">
                            <table id="priceDifferencesTable" style="width: 100%; border-collapse: collapse; font-size: 0.85rem;">
                                <thead>
                                    <tr style="background: #856404; color: white;">
                                        <th style="padding: 8px; text-align: center; border: 1px solid #ddd;">#</th>
                                        <th style="padding: 8px; text-align: center; border: 1px solid #ddd;">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
                                        <th style="padding: 8px; text-align: center; border: 1px solid #ddd;">ØªØ§Ø¨Ø¹ Ø¥Ù„Ù‰</th>
                                        <th style="padding: 8px; text-align: center; border: 1px solid #ddd;">Ù†ÙˆØ¹ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ</th>
                                        <th style="padding: 8px; text-align: center; border: 1px solid #ddd;"> Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</th>
                                        <th style="padding: 8px; text-align: center; border: 1px solid #ddd;">Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø±Ø³Ù…ÙŠ</th>
                                        <th style="padding: 8px; text-align: center; border: 1px solid #ddd;">Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…ÙƒØªÙˆØ¨</th>
                                        <th style="padding: 8px; text-align: center; border: 1px solid #ddd;">Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
                                        <th style="padding: 8px; text-align: center; border: 1px solid #ddd;">Ø§Ù„ÙØ±Ù‚</th>
                                    </tr>
                                </thead>
                                <tbody id="priceDifferencesTableBody">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div id="settingsTab" class="tab-content">
                <div class="section">
                    <h3 class="section-title"> Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h3>
                    <div class="settings-container">
                        <div class="settings-section">
                            <h4> Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ø³Ø¹Ø§Ø±</h4>
                            <div class="settings-group">
                                <label for="priceBronze"> Bronze</label>
                                <input type="number" id="priceBronze" class="settings-input" value="30000" min="0" step="1000">
                            </div>
                            <div class="settings-group">
                                <label for="priceSilver"> Silver</label>
                                <input type="number" id="priceSilver" class="settings-input" value="40000" min="0" step="1000">
                            </div>
                            <div class="settings-group">
                                <label for="priceGold"> Gold</label>
                                <input type="number" id="priceGold" class="settings-input" value="50000" min="0" step="1000">
                            </div>
                            <div class="settings-group">
                                <label for="pricePlatinum"> Platinum</label>
                                <input type="number" id="pricePlatinum" class="settings-input" value="65000" min="0" step="1000">
                            </div>
                            <button class="btn btn-primary" onclick="savePriceSettings()"> Ø­ÙØ¸</button>
                        </div>
                        <div class="settings-section">
                            <h4> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h4>
                            <button class="btn btn-success" onclick="backupData()"> Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠ</button>
                            <button class="btn btn-warning" onclick="restoreData()"> Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
                            <button class="btn btn-danger" onclick="clearAllData()"> Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
                        </div>
                        <div class="settings-section">
                            <h4> Ø§Ù„Ù†Ø³Ø¨ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©</h4>
                            <div class="settings-group">
                                <label for="defaultAgentPercentage">Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù„Ù„ÙˆÙƒÙ„Ø§Ø¡ Ø§Ù„Ø¬Ø¯Ø¯ (%):</label>
                                <input type="number" id="defaultAgentPercentage" class="settings-input" value="16" min="0" max="100" step="0.01" onchange="saveDefaultPercentage()">
                                <p style="margin-top: 5px; font-size: 0.85rem; color: var(--text-primary); font-weight: 600;"></p>
                            </div>
                        </div>
                        <div class="settings-section">
                            <h4> Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù†Ø³Ø¨Ø© Ø§Ù„ÙˆØ²Ø§Ø±Ø©</h4>
                            <div class="settings-group">
                                <label for="ministryOldProjectPercentage">Ù†Ø³Ø¨Ø© Ø§Ù„ÙˆØ²Ø§Ø±Ø© Ù„Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ù‚Ø¯ÙŠÙ… (%):</label>
                                <input type="number" id="ministryOldProjectPercentage" class="settings-input" value="50" min="0" max="100" step="0.01" onchange="saveMinistryPercentages()">
                                <p style="margin-top: 5px; font-size: 0.85rem; color: var(--text-primary); font-weight: 600;">Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø¦ÙˆÙŠØ© Ù„Ù„ÙˆØ²Ø§Ø±Ø© Ù…Ù† Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ù‚Ø¯ÙŠÙ…</p>
                            </div>
                            <div class="settings-group">
                                <label for="ministryNewProjectPercentage">Ù†Ø³Ø¨Ø© Ø§Ù„ÙˆØ²Ø§Ø±Ø© Ù„Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ø¬Ø¯ÙŠØ¯ (%):</label>
                                <input type="number" id="ministryNewProjectPercentage" class="settings-input" value="27" min="0" max="100" step="0.01" onchange="saveMinistryPercentages()">
                                <p style="margin-top: 5px; font-size: 0.85rem; color: var(--text-primary); font-weight: 600;">Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø¦ÙˆÙŠØ© Ù„Ù„ÙˆØ²Ø§Ø±Ø© Ù…Ù† Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ø¬Ø¯ÙŠØ¯</p>
                            </div>
                            <button class="btn btn-primary" onclick="saveMinistryPercentages()" style="margin-top: 10px;"> Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù†Ø³Ø¨Ø© Ø§Ù„ÙˆØ²Ø§Ø±Ø©</button>
                        </div>
                        <div class="settings-section">
                            <h4> Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</h4>
                            <label class="settings-checkbox">
                                <input type="checkbox" id="enableNotifications" checked>
                                <span style="font-weight: 500; color: #333;">ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</span>
                            </label>
                            <p style="margin-top: 12px; font-size: 0.85rem; color: var(--text-primary); line-height: 1.5; font-weight: 600;">
                                Ø¹Ù†Ø¯ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§ØªØŒ Ø³ÙŠØªÙ… Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ø¦Ù„ ØªØ£ÙƒÙŠØ¯ Ø¹Ù†Ø¯ Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª
                            </p>
                        </div>
                    </div>
                </div>
            </div>
            <div id="activityTab" class="tab-content">
                <div class="section">
                    <h3 class="section-title"> Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</h3>
                    <div class="activity-controls" style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                        <input type="text" id="activitySearch" placeholder=" Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø³Ø¬Ù„..." class="settings-input" style="flex: 1; min-width: 200px;" onkeyup="filterActivityLog()">
                        <button class="btn btn-primary" onclick="refreshActivityLog()"> ØªØ­Ø¯ÙŠØ«</button>
                        <button id="exportActivityBtn" class="btn btn-success" onclick="exportActivityLog()" style="display: none;"> ØªØµØ¯ÙŠØ±</button>
                        <button id="clearActivityBtn" class="btn btn-danger" onclick="clearActivityLog()" style="display: none;"> Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„</button>
                    </div>
                    <div id="activityLogContent" class="activity-log-container"></div>
                </div>
            </div>
            <div id="archiveTab" class="tab-content">
                <div class="section" style="background: linear-gradient(135deg, rgba(128, 28, 50, 0.05) 0%, rgba(255, 255, 255, 0.02) 100%); border-radius: 20px; padding: 30px; margin-bottom: 30px; border: 2px solid var(--border-light); box-shadow: 0 8px 24px rgba(0,0,0,0.08);">
                    <h3 class="section-title" style="font-size: 1.8rem; margin-bottom: 25px;">ðŸ“ Ø§Ù„Ø£Ø±Ø´ÙŠÙ - Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª ÙˆØ§Ù„ØªÙØ§ØµÙŠÙ„</h3>
                    <div style="margin-bottom: 25px; display: flex; gap: 15px; flex-wrap: wrap; align-items: center; padding: 20px; background: var(--bg-secondary); border-radius: 12px; border: 1px solid var(--border-light);">
                        <label for="archiveMonthSelect" style="font-weight: 700; color: var(--primary-color); font-size: 1rem;">Ø§Ø®ØªØ± Ø§Ù„Ø´Ù‡Ø±:</label>
                        <input type="month" id="archiveMonthSelect" class="settings-input" style="width: 220px; padding: 12px; font-weight: 600; font-size: 1rem;" onchange="loadArchiveByAgent()">
                        <button class="btn btn-primary" onclick="loadArchiveByAgent()" style="padding: 12px 24px; font-weight: 700; font-size: 0.95rem;">ðŸ“¥ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø±Ø´ÙŠÙ</button>
                        <button class="btn btn-success" onclick="refreshArchivesList()" style="padding: 12px 24px; font-weight: 700; font-size: 0.95rem;">ðŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</button>
                    </div>
                    <div id="archivesListContainer" style="margin-bottom: 25px; padding: 20px; background: var(--card-bg); border-radius: 12px; border: 1px solid var(--border-color);">
                        <h4 style="font-size: 1.2rem; font-weight: 800; color: var(--primary-color); margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid var(--border-color);">ðŸ“‹ Ø§Ù„Ø£Ø±Ø´ÙŠÙØ§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©:</h4>
                        <div id="archivesList" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 15px; margin-top: 15px;"></div>
                    </div>
                    <div id="archiveContentContainer">
                        <div id="archiveAgentsList" style="background: var(--card-bg); padding: 25px; border-radius: 16px; border: 2px solid var(--border-color); margin-bottom: 25px; display: none; box-shadow: 0 4px 16px rgba(0,0,0,0.08);">
                            <div style="margin-bottom: 20px;">
                                <h4 style="font-size: 1.1rem; font-weight: 800; color: var(--primary-color); margin-bottom: 15px;">ðŸ” Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† ÙˆÙƒÙŠÙ„</h4>
                                <input type="text" id="archiveAgentSearch" class="settings-input" 
                                       placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„ÙˆÙƒÙŠÙ„ Ù„Ù„Ø¨Ø­Ø«..." 
                                       style="width: 100%; padding: 14px 18px; font-size: 1rem; font-weight: 600; border-radius: 10px; border: 2px solid var(--border-color);"
                                       onkeyup="filterArchiveAgents(this.value)">
                            </div>
                            <div id="archiveAgentsListContent" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 15px;">
                            </div>
                        </div>
                        <div id="archiveContent" style="background: var(--card-bg); padding: 30px; border-radius: 16px; border: 2px solid var(--border-color); min-height: 200px; box-shadow: 0 4px 16px rgba(0,0,0,0.08);">
                            <div style="text-align: center; padding: 40px 20px;">
                                <div style="font-size: 4rem; margin-bottom: 20px;">ðŸ“</div>
                                <p style="text-align: center; color: var(--text-secondary); font-size: 1.1rem; font-weight: 600; margin-bottom: 10px;">Ø§Ø®ØªØ± Ø´Ù‡Ø±Ø§Ù‹ Ù„Ø¹Ø±Ø¶ Ø£Ø±Ø´ÙŠÙ Ø§Ù„ÙˆÙƒÙ„Ø§Ø¡</p>
                                <p style="text-align: center; color: var(--text-tertiary); font-size: 0.95rem;">Ø³ÙŠØªÙ… Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª ÙˆØ§Ù„ØªÙØ§ØµÙŠÙ„ Ù„Ù„Ø´Ù‡Ø± Ø§Ù„Ù…Ø­Ø¯Ø¯</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="usersTab" class="tab-content">
                <div class="section" style="background: var(--card-bg); border-radius: 12px; padding: 25px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 2px solid var(--border-color);">
                        <h3 class="section-title" style="margin: 0; font-size: 1.5rem; color: var(--primary-color);">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h3>
                        <div class="btn-group" style="gap: 10px;">
                            <button class="btn btn-primary" onclick="openAddUserModal()" style="padding: 10px 20px; font-weight: 600;">
                                <span style="margin-left: 8px;">âž•</span> Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯
                            </button>
                            <button class="btn btn-secondary" onclick="loadUsers()" style="padding: 10px 20px;">
                                <span style="margin-left: 8px;">ðŸ”„</span> ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
                            </button>
                        </div>
                    </div>
                    <div id="usersAlert" style="margin-bottom: 20px;"></div>
                    <div id="usersList" style="min-height: auto;">
                        <div style="text-align: center; padding: 40px;">
                            <div class="spinner" style="margin: 0 auto 20px;"></div>
                            <p style="color: var(--text-secondary); font-size: 1rem;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="addUserModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="addUserModalTitle">Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯</h3>
                <button class="modal-close" onclick="closeAddUserModal()">&times;</button>
            </div>
            <div id="addUserAlert"></div>
            <input type="hidden" id="editUserId" value="">
            <div class="form-group">
                <label for="userUsername">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… *</label>
                <input type="text" id="userUsername" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ù„Ù„ØªØ³Ø¬ÙŠÙ„)">
            </div>
            <div class="form-group">
                <label for="userFullName">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„ *</label>
                <input type="text" id="userFullName" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„">
            </div>
            <div class="form-group">
                <label for="userPassword">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± <span id="passwordRequired">*</span></label>
                <input type="password" id="userPassword" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± (Ø§ØªØ±ÙƒÙ‡ ÙØ§Ø±ØºØ§Ù‹ Ø¹Ù†Ø¯ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù„Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„ÙƒÙ„Ù…Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©)">
                <small style="color: var(--text-secondary); font-size: 0.85rem; display: block; margin-top: 5px;" id="passwordHint" style="display: none;">Ø¹Ù†Ø¯ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ØŒ Ø§ØªØ±ÙƒÙ‡ ÙØ§Ø±ØºØ§Ù‹ Ù„Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ©</small>
            </div>
            <div class="form-group">
                <label for="userRole">Ø§Ù„Ø¯ÙˆØ± *</label>
                <select id="userRole">
                    <option value="employee">Ù…ÙˆØ¸Ù</option>
                    <option value="admin">Ù…Ø¯ÙŠØ±</option>
                </select>
            </div>
            <div class="btn-group" style="margin-top: 20px;">
                <button class="btn btn-secondary" onclick="closeAddUserModal()">Ø¥Ù„ØºØ§Ø¡</button>
                <button class="btn btn-primary" onclick="saveUser()">Ø­ÙØ¸</button>
            </div>
        </div>
    </div>
    <div id="messageCustomizationModal" class="modal">
        <div class="modal-content message-customization">
            <div class="modal-header">
                <h3>ØªØ®ØµÙŠØµ Ø±Ø³Ø§Ù„Ø© Ø§Ù„ÙˆÙƒÙŠÙ„</h3>
                <button class="modal-close" onclick="closeMessageCustomizationModal()">&times;</button>
            </div>
            <div style="margin-bottom: 20px;">
                <strong style="color: #801c32; font-size: 1.1rem;">Ø§Ù„ÙˆÙƒÙŠÙ„:</strong>
                <span id="customMessageAgentName" style="font-size: 1.1rem; font-weight: 600;" data-agent=""></span>
            </div>
            <div style="margin: 20px 0;">
                <label for="customMessageText" class="preview-label">Ù†Øµ Ø§Ù„Ø±Ø³Ø§Ù„Ø©:</label>
                <textarea id="customMessageText" class="message-textarea" rows="10"></textarea>
            </div>
            <div style="display: flex; gap: 15px; justify-content: flex-end; margin-top: 20px;">
                <button class="btn btn-danger" onclick="closeMessageCustomizationModal()">Ø¥Ù„ØºØ§Ø¡</button>
                <button class="btn btn-success" onclick="sendViaEmail()">Ø¥Ø±Ø³Ø§Ù„ Ø¹Ø¨Ø± Ø§Ù„Ø¨Ø±ÙŠØ¯</button>
                <button class="btn btn-primary" onclick="sendCustomizedWhatsAppMessage()">Ø¥Ø±Ø³Ø§Ù„ ÙˆØ§ØªØ³Ø§Ø¨</button>
            </div>
        </div>
    </div>
    <div id="agentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="agentModalTitle">Ø¥Ø¶Ø§ÙØ© ÙˆÙƒÙŠÙ„</h3>
                <button class="modal-close" onclick="closeAgentModal()">&times;</button>
            </div>
            <form id="agentForm">
                <div class="form-group">
                    <label for="agentName">Ø§Ø³Ù… Ø§Ù„Ù„ÙˆØ­Ø© *</label>
                    <input type="text" id="agentName" class="settings-input" required>
                </div>
                <div class="form-group">
                    <label for="agentSubName">Ø§Ø³Ù… Ø§Ù„ÙˆÙƒÙŠÙ„ :</label>
                    <input type="text" id="agentSubName" class="settings-input" placeholder=" ">
                </div>
                <div class="form-group">
                    <label for="agentPhone">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ (ÙˆØ§ØªØ³Ø§Ø¨):</label>
                    <input type="tel" id="agentPhone" class="settings-input" placeholder="Ù…Ø«Ø§Ù„: 07701234567">
                </div>
                <div class="form-group">
                    <label for="agentEmail">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ:</label>
                    <input type="email" id="agentEmail" class="settings-input" placeholder="example@email.com">
                </div>
                <div style="display: flex; gap: 15px; justify-content: flex-end; margin-top: 20px;">
                    <button type="button" class="btn btn-danger" onclick="closeAgentModal()">Ø¥Ù„ØºØ§Ø¡</button>
                    <button type="submit" class="btn btn-primary">Ø­ÙØ¸</button>
                </div>
            </form>
        </div>
    </div>
    <script>
let agentReports = {};
        let agentsList = JSON.parse(localStorage.getItem('agentsList') || '[]');
        let lastActivityTime = Date.now();
        let autoLogoutTimer = null;
        const AUTO_LOGOUT_TIME = 2 * 60 * 60 * 1000;
        let basicData = null;
        let advancedData = null;
        let twoMonthsData = null;
        let twoMonthsDetails = []; 
        let advancedDetails = [];
        let basicDetails = [];
        let percentageData = null;
        let agentPercentages = JSON.parse(localStorage.getItem('agentPercentages') || '{}');
        let ministryData = null;
        let ministryResults = null;
        let ministryOldProjectPercentage = parseFloat(localStorage.getItem('ministryOldProjectPercentage')) || 50;
        let ministryNewProjectPercentage = parseFloat(localStorage.getItem('ministryNewProjectPercentage')) || 27;
        const SUPABASE_URL = (typeof window !== 'undefined' && typeof window.SUPABASE_URL !== 'undefined') ? window.SUPABASE_URL : 'https://qcbcjyhqgxwuqutzkxrh.supabase.co';
        const SUPABASE_ANON_KEY = (typeof window !== 'undefined' && typeof window.SUPABASE_ANON_KEY !== 'undefined') ? window.SUPABASE_ANON_KEY : 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFjYmNqeWhxZ3h3dXF1dHpreHJoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTEyMDE3NjQsImV4cCI6MjA2Njc3Nzc2NH0.y-hQVa6nzBpCMpXL7XbcWPMGafATvnMez3lAmFvb2zY';
        const SYSTEM_NAME = 'billing_accounts';
        let supabaseClient = null;
        let loggedInUser = '';
        let currentUserRole = 'employee';
        let currentUserId = null;
        
        async function initSupabase() {
            try {
                if (typeof supabase !== 'undefined') {
                    supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                } else {
                }
            } catch (error) {
            }
        }
        
        async function supabaseRequest(table, method = 'GET', data = null, filters = '', customHeaders = {}) {
            const url = `${SUPABASE_URL}/rest/v1/${table}${filters}`;
            const options = {
                method: method,
                headers: {
                    'apikey': SUPABASE_ANON_KEY,
                    'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                    'Content-Type': 'application/json',
                    'Prefer': 'return=representation',
                    ...customHeaders
                }
            };
            
            if (data && (method === 'POST' || method === 'PATCH' || method === 'PUT')) {
                options.body = JSON.stringify(data);
            }
            
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 30000);
                options.signal = controller.signal;
                
                const response = await fetch(url, options);
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Supabase error: ${response.status} - ${errorText}`);
                }
                const result = await response.json();
                return result;
            } catch (error) {
                if (error.name === 'AbortError') {
                    throw new Error('Request timeout - ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰');
                }
                if (error.message && error.message.includes('Failed to fetch')) {
                    throw new Error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª - ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„');
                }
                throw error;
            }
        }
        
        async function hashPassword(password) {
            const encoder = new TextEncoder();
            const data = encoder.encode(password);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }
        
        function showAlert(alertDiv, message, type = 'info') {
            if (!alertDiv) return;
            alertDiv.innerHTML = `<div style="padding: 12px; border-radius: 8px; margin-bottom: 15px; background: ${type === 'error' ? '#f8d7da' : type === 'success' ? '#d4edda' : '#d1ecf1'}; color: ${type === 'error' ? '#721c24' : type === 'success' ? '#155724' : '#0c5460'}; border: 1px solid ${type === 'error' ? '#f5c6cb' : type === 'success' ? '#c3e6cb' : '#bee5eb'};">
                ${message}
            </div>`;
            setTimeout(() => {
                alertDiv.innerHTML = '';
            }, 5000);
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        async function handleLogin() {
            const usernameInput = document.getElementById('loginUsername');
            const passwordInput = document.getElementById('loginPassword');
            const alertDiv = document.getElementById('loginAlert');
            if (!usernameInput || !passwordInput) return;
            const username = usernameInput.value.trim();
            const password = passwordInput.value.trim();

            if (!username || !password) {
                showAlert(alertDiv, 'ÙŠØ±Ø¬Ù‰ ØªØ¹Ø¨Ø¦Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„.', 'error');
                return;
            }

            showAlert(alertDiv, 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...', 'info');

            try {
                const passwordHash = await hashPassword(password);
                
                let filter = `?username=eq.${encodeURIComponent(username)}`;
                let users = await supabaseRequest('users', 'GET', null, filter);
                if (users && users.length > 0) {
                    users = users.filter(user => {
                        if (user.system_name !== undefined && user.system_name !== null && user.system_name !== '') {
                            return user.system_name === SYSTEM_NAME;
                        }
                        return true;
                    });
                }
                
                if (users && users.length > 0) {
                    const user = users[0];
                    
                    if (!user.is_active) {
                        showAlert(alertDiv, 'Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø¹Ø·Ù„. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ù…Ø¯ÙŠØ±.', 'error');
                        return;
                    }
                    
                    if (user.password_hash === passwordHash) {
                        try {
                            await supabaseRequest('users', 'PATCH', { last_login: new Date().toISOString() }, `?id=eq.${user.id}`);
                        } catch (e) {
                        }
                        
                        loggedInUser = user.full_name;
                        currentUserRole = user.role;
                        currentUserId = user.id;
                        
                        localStorage.setItem('loggedInUser', user.full_name);
                        localStorage.setItem('currentUserRole', user.role);
                        localStorage.setItem('currentUserId', user.id);
                        
                        showMainApp();
                    } else {
                        showAlert(alertDiv, 'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©.', 'error');
                    }
                } else {
                    try {
                        let systemUsers = await supabaseRequest('users', 'GET', null, `?select=username,is_active`);
                        if (systemUsers && systemUsers.length > 0) {
                            systemUsers = systemUsers.filter(user => {
                                if (user.system_name !== undefined && user.system_name !== null && user.system_name !== '') {
                                    return user.system_name === SYSTEM_NAME;
                                }
                                return true;
                            });
                        }
                        if (!systemUsers || systemUsers.length === 0) {
                            showAlert(alertDiv, 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù†Ø¸Ø§Ù…. ÙŠØ±Ø¬Ù‰ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø¯ÙŠØ± Ø£ÙˆÙ„Ø§Ù‹. Ø§Ø³ØªØ®Ø¯Ù… Ù…Ù„Ù check_and_create_admin.sql', 'error');
                        } else {
                            const foundUser = systemUsers.find(u => u.username === username);
                            if (foundUser && !foundUser.is_active) {
                                showAlert(alertDiv, 'Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø¹Ø·Ù„. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ù…Ø¯ÙŠØ±.', 'error');
                            } else {
                                showAlert(alertDiv, 'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©.', 'error');
                            }
                        }
                    } catch (e) {
                        console.error('Error checking users:', e);
                        showAlert(alertDiv, 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†. ØªØ£ÙƒØ¯ Ù…Ù† ØªÙ†ÙÙŠØ° ÙƒÙˆØ¯ SQL Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….', 'error');
                    }
                }
            } catch (error) {
                showAlert(alertDiv, `Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„: ${error.message}. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª ÙˆØ§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.`, 'error');
            }
        }
        
        function showMainApp() {
            const loginScreen = document.getElementById('loginScreen');
            const dashboard = document.getElementById('dashboard');
            
            if (loginScreen) {
                loginScreen.classList.add('hidden');
                loginScreen.style.display = 'none';
            }
            
            if (dashboard) {
                dashboard.classList.remove('hidden');
                dashboard.style.display = 'flex';
            }
            
            const switchUserText = document.getElementById('switchUserText');
            if (switchUserText) {
                switchUserText.textContent = loggedInUser || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
            }
            const switchUserBtnName = document.getElementById('switchUserBtnName');
            if (switchUserBtnName) {
                switchUserBtnName.textContent = loggedInUser || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
            }
            
            updateAdminTabsVisibility();
            updateActivityLogButtonsVisibility();
            updateCurrentDate();
            
            setTimeout(() => {
                updateAgentSummary();
            }, 500);
            
            resetAutoLogoutTimer();
        }
        
        function resetAutoLogoutTimer() {
            lastActivityTime = Date.now();
            if (autoLogoutTimer) {
                clearTimeout(autoLogoutTimer);
            }
            autoLogoutTimer = setTimeout(() => {
                if (confirm('ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù†Ø´Ø§Ø· Ù„Ù…Ø¯Ø© Ø³Ø§Ø¹ØªÙŠÙ†. Ø³ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.\n\nÙ‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ø¨Ù‚Ø§Ø¡ Ù…ØªØµÙ„Ø§Ù‹ØŸ')) {
                    resetAutoLogoutTimer();
                } else {
                    handleLogout(true);
                }
            }, AUTO_LOGOUT_TIME);
        }
        
        ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart', 'click'].forEach(event => {
            document.addEventListener(event, () => {
                if (loggedInUser) {
                    resetAutoLogoutTimer();
                }
            });
        });
        
        function handleLogout(isAutoLogout = false) {
            if (!isAutoLogout && !confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ')) {
                return;
            }
            
            if (autoLogoutTimer) {
                clearTimeout(autoLogoutTimer);
                autoLogoutTimer = null;
            }
            
            localStorage.removeItem('loggedInUser');
            localStorage.removeItem('currentUserRole');
            localStorage.removeItem('currentUserId');
            
            loggedInUser = '';
            currentUserRole = '';
            currentUserId = null;
            
            const dashboard = document.getElementById('dashboard');
            const loginScreen = document.getElementById('loginScreen');
            
            if (dashboard) {
                dashboard.classList.add('hidden');
                dashboard.style.display = 'none';
            }
            
            if (loginScreen) {
                loginScreen.classList.remove('hidden');
                loginScreen.style.display = 'flex';
            }
            
            const loginUsername = document.getElementById('loginUsername');
            const loginPassword = document.getElementById('loginPassword');
            const loginAlert = document.getElementById('loginAlert');
            
            if (loginUsername) loginUsername.value = '';
            if (loginPassword) loginPassword.value = '';
            if (loginAlert) loginAlert.innerHTML = '';
            
        }
        
        function updateAdminTabsVisibility() {
            const adminTabs = document.querySelectorAll('.admin-only');
            if (currentUserRole === 'admin') {
                adminTabs.forEach(tab => {
                    tab.style.display = 'block';
                });
            } else {
                adminTabs.forEach(tab => tab.style.display = 'none');
            }
        }
        function updateActivityLogButtonsVisibility() {
            const exportBtn = document.getElementById('exportActivityBtn');
            const clearBtn = document.getElementById('clearActivityBtn');
            if (currentUserRole === 'admin') {
                if (exportBtn) exportBtn.style.display = 'inline-block';
                if (clearBtn) clearBtn.style.display = 'inline-block';
            } else {
                if (exportBtn) exportBtn.style.display = 'none';
                if (clearBtn) clearBtn.style.display = 'none';
            }
        }
        
        async function loadUsers() {
            if (currentUserRole !== 'admin') {
                document.getElementById('usersList').innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 20px;">Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø©.</p>';
                return;
            }
            
            try {
                let allUsers = [];
                let from = 0;
                const batchSize = 1000;
                let hasMore = true;
                
                while (hasMore) {
                    const to = from + batchSize - 1;
                    try {
                        const batch = await supabaseRequest('users', 'GET', null, `?system_name=eq.${SYSTEM_NAME}&order=created_at.desc`, {
                            'Range': `${from}-${to}`
                        });
                        if (Array.isArray(batch) && batch.length > 0) {
                            allUsers = allUsers.concat(batch);
                            if (batch.length < batchSize) {
                                hasMore = false;
                            } else {
                                from += batchSize;
                            }
                        } else {
                            hasMore = false;
                        }
                    } catch (rangeError) {
                        try {
                            const batch = await supabaseRequest('users', 'GET', null, `?system_name=eq.${SYSTEM_NAME}&order=created_at.desc&limit=${batchSize}`);
                            if (Array.isArray(batch) && batch.length > 0) {
                                allUsers = allUsers.concat(batch);
                            }
                        } catch (e) {
                            console.warn('Error fetching batch:', e);
                        }
                        hasMore = false;
                    }
                }
                
                if (allUsers.length === 0) {
                    try {
                        const usersWithoutSystem = await supabaseRequest('users', 'GET', null, `?system_name=is.null&order=created_at.desc&limit=200`);
                        if (Array.isArray(usersWithoutSystem) && usersWithoutSystem.length > 0) {
                            allUsers = usersWithoutSystem;
                        }
                    } catch (e) {
                    }
                    
                    if (allUsers.length === 0) {
                        try {
                            const allUsersSimple = await supabaseRequest('users', 'GET', null, `?order=created_at.desc&limit=200`);
                            if (Array.isArray(allUsersSimple) && allUsersSimple.length > 0) {
                                allUsers = allUsersSimple;
                            }
                        } catch (e2) {
                        }
                    }
                }
                
                let filteredUsers = allUsers.filter(user => {
                    const userSystem = user.system_name || '';
                    return userSystem === SYSTEM_NAME || !userSystem || userSystem === '';
                });
                
                for (const user of filteredUsers) {
                    if (!user.system_name || user.system_name === null || user.system_name === '') {
                        try {
                            await supabaseRequest('users', 'PATCH', { system_name: SYSTEM_NAME }, `?id=eq.${user.id}`);
                            user.system_name = SYSTEM_NAME;
                        } catch (updateError) {
                        }
                    }
                }
                
                if (filteredUsers.length === 0) {
                    try {
                        const allUsersSimple = await supabaseRequest('users', 'GET', null, `?order=created_at.desc&limit=200`);
                        if (Array.isArray(allUsersSimple) && allUsersSimple.length > 0) {
                            filteredUsers = allUsersSimple.filter(user => {
                                const userSystem = user.system_name || '';
                                return userSystem === SYSTEM_NAME || !userSystem || userSystem === '';
                            });
                            
                            for (const user of filteredUsers) {
                                if (!user.system_name || user.system_name === null || user.system_name === '') {
                                    try {
                                        await supabaseRequest('users', 'PATCH', { system_name: SYSTEM_NAME }, `?id=eq.${user.id}`);
                                        user.system_name = SYSTEM_NAME;
                                    } catch (updateError) {
                                    }
                                }
                            }
                        }
                    } catch (e) {
                    }
                }
                
                displayUsers(filteredUsers);
            } catch (error) {
                console.error('Error loading users:', error);
                const errorMsg = error.message || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
                document.getElementById('usersList').innerHTML = `<p style="text-align: center; color: var(--error-color); padding: 20px;">Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†: ${errorMsg}</p>`;
            }
        }
        
        function displayUsers(users) {
            const container = document.getElementById('usersList');
            if (!users || users.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px; background: var(--bg-secondary); border-radius: 12px; border: 2px dashed var(--border-light);">
                        <div style="font-size: 3rem; margin-bottom: 15px;">ðŸ‘¥</div>
                        <p style="color: var(--text-secondary); font-size: 1.1rem; font-weight: 600;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù…Ø³Ø¬Ù„ÙŠÙ†</p>
                        <p style="color: var(--text-tertiary); font-size: 0.9rem; margin-top: 10px;">Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ "Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯" Ù„Ø¥Ø¶Ø§ÙØ© Ø£ÙˆÙ„ Ù…Ø³ØªØ®Ø¯Ù…</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = `
                <div style="margin-bottom: 20px; padding: 15px; background: linear-gradient(135deg, var(--primary-light) 0%, rgba(128, 28, 50, 0.05) 100%); border-radius: 10px; border: 1px solid var(--border-light);">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 1.5rem;">ðŸ“Š</span>
                        <div>
                            <strong style="color: var(--primary-color); font-size: 1.1rem;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†:</strong>
                            <span style="color: var(--text-primary); font-size: 1.2rem; font-weight: 700; margin-right: 5px;">${users.length}</span>
                            <span style="color: var(--text-secondary);">Ù…Ø³ØªØ®Ø¯Ù…</span>
                        </div>
                    </div>
                </div>
                <div style="overflow-x: auto; border-radius: 12px; border: 1px solid var(--border-color); box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                    <table class="agents-stats-table" style="width: 100%; margin: 0;">
                        <thead style="background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-hover) 100%); color: white;">
                            <tr>
                                <th style="padding: 15px; font-weight: 700;">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
                                <th style="padding: 15px; font-weight: 700;">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</th>
                                <th style="padding: 15px; font-weight: 700;">Ø§Ù„Ø¯ÙˆØ±</th>
                                <th style="padding: 15px; font-weight: 700;">Ø§Ù„Ù†Ø¸Ø§Ù…</th>
                                <th style="padding: 15px; font-weight: 700;">Ø¢Ø®Ø± ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„</th>
                                <th style="padding: 15px; font-weight: 700;">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡</th>
                                <th style="padding: 15px; font-weight: 700;">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                <th style="padding: 15px; font-weight: 700;">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${users.map((user, index) => {
                                const usernameSafe = escapeHtml(user.username || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯');
                                const fullNameSafe = escapeHtml(user.full_name || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯');
                                const usernameEscaped = (user.username || '').replace(/\\/g, '\\\\').replace(/'/g, "\\'").replace(/"/g, '&quot;');
                                const fullNameEscaped = (user.full_name || '').replace(/\\/g, '\\\\').replace(/'/g, "\\'").replace(/"/g, '&quot;');
                                const roleEscaped = (user.role || 'employee').replace(/\\/g, '\\\\').replace(/'/g, "\\'").replace(/"/g, '&quot;');
                                const rowBg = index % 2 === 0 ? 'var(--bg-primary)' : 'var(--bg-secondary)';
                                return `
                                <tr style="background: ${rowBg}; transition: background 0.2s ease;">
                                    <td style="padding: 15px;"><strong style="color: var(--primary-color);">${usernameSafe}</strong></td>
                                    <td style="padding: 15px;">${fullNameSafe}</td>
                                    <td style="padding: 15px;">
                                        <span style="display: inline-block; padding: 5px 12px; border-radius: 20px; font-weight: 600; font-size: 0.9rem; background: ${user.role === 'admin' ? 'rgba(220, 53, 69, 0.1)' : 'rgba(40, 167, 69, 0.1)'}; color: ${user.role === 'admin' ? '#dc3545' : '#28a745'};">
                                            ${user.role === 'admin' ? 'ðŸ‘‘ Ù…Ø¯ÙŠØ±' : 'ðŸ‘¤ Ù…ÙˆØ¸Ù'}
                                        </span>
                                    </td>
                                    <td style="padding: 15px;">
                                        <span style="display: inline-block; padding: 5px 10px; border-radius: 8px; font-weight: 600; font-size: 0.85rem; background: ${user.system_name === SYSTEM_NAME ? 'rgba(40, 167, 69, 0.1)' : (user.system_name ? 'rgba(220, 53, 69, 0.1)' : 'rgba(255, 193, 7, 0.1)')}; color: ${user.system_name === SYSTEM_NAME ? '#28a745' : (user.system_name ? '#dc3545' : '#ffc107')};">
                                            ${user.system_name === SYSTEM_NAME ? 'âœ“ Ù‡Ø°Ø§ Ø§Ù„Ù†Ø¸Ø§Ù…' : (user.system_name ? `âœ— ${user.system_name}` : 'âš  Ù‚Ø¯ÙŠÙ…')}
                                        </span>
                                        ${user.system_name !== SYSTEM_NAME && user.system_name ? `<button class="btn btn-sm" style="padding: 4px 10px; font-size: 0.75rem; margin-top: 5px; background: var(--info-color); color: white; border: none; border-radius: 6px; cursor: pointer; transition: all 0.2s ease;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'" onclick="fixUserSystem(${user.id}, '${usernameEscaped}')" title="ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Ø¸Ø§Ù…">ðŸ”„ ØªØ­Ø¯ÙŠØ«</button>` : ''}
                                    </td>
                                    <td style="padding: 15px; color: var(--text-secondary); font-size: 0.9rem;">${user.last_login ? new Date(user.last_login).toLocaleString('en-GB', {year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit'}) : '<span style="color: var(--text-tertiary);">âŒ Ù„Ù… ÙŠØ³Ø¬Ù„ Ø¯Ø®ÙˆÙ„</span>'}</td>
                                    <td style="padding: 15px; color: var(--text-secondary); font-size: 0.9rem;">${user.created_at ? new Date(user.created_at).toLocaleString('en-GB', {year: 'numeric', month: '2-digit', day: '2-digit'}) : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td>
                                    <td style="padding: 15px;">
                                        <span style="display: inline-block; padding: 5px 12px; border-radius: 20px; font-weight: 600; font-size: 0.9rem; background: ${user.is_active ? 'rgba(40, 167, 69, 0.1)' : 'rgba(220, 53, 69, 0.1)'}; color: ${user.is_active ? '#28a745' : '#dc3545'};">
                                            ${user.is_active ? 'âœ… Ù†Ø´Ø·' : 'âŒ Ù…Ø¹Ø·Ù„'}
                                        </span>
                                    </td>
                                    <td style="padding: 15px;">
                                        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                            <button class="btn btn-primary" style="padding: 8px 14px; font-size: 0.85rem; border-radius: 6px; transition: all 0.2s ease;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'" onclick="openEditUserModal(${user.id}, '${usernameEscaped}', '${fullNameEscaped}', '${roleEscaped}', ${user.is_active})">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
                                            <button class="btn btn-warning" style="padding: 8px 14px; font-size: 0.85rem; border-radius: 6px; transition: all 0.2s ease;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'" onclick="toggleUserStatus(${user.id}, ${!user.is_active})">${user.is_active ? 'â¸ï¸ ØªØ¹Ø·ÙŠÙ„' : 'â–¶ï¸ ØªÙØ¹ÙŠÙ„'}</button>
                                            ${user.id !== currentUserId ? `<button class="btn btn-danger" style="padding: 8px 14px; font-size: 0.85rem; border-radius: 6px; transition: all 0.2s ease;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'" onclick="deleteUser(${user.id}, '${usernameEscaped}')">ðŸ—‘ï¸ Ø­Ø°Ù</button>` : '<span style="color: var(--text-tertiary); font-size: 0.85rem; padding: 8px;">(Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ)</span>'}
                                        </div>
                                    </td>
                                </tr>
                            `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }
        
        function openAddUserModal() {
            if (currentUserRole !== 'admin') {
                showAlert(document.getElementById('usersAlert'), 'Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†.', 'error');
                return;
            }
            const modal = document.getElementById('addUserModal');
            if (modal) {
                modal.classList.add('show');
                modal.style.display = 'flex';
            }
            const modalTitle = document.getElementById('addUserModalTitle');
            const editUserIdEl = document.getElementById('editUserId');
            const userUsernameEl = document.getElementById('userUsername');
            const userFullNameEl = document.getElementById('userFullName');
            const userPasswordEl = document.getElementById('userPassword');
            const passwordRequiredEl = document.getElementById('passwordRequired');
            const passwordHintEl = document.getElementById('passwordHint');
            const userRoleEl = document.getElementById('userRole');
            const addUserAlertEl = document.getElementById('addUserAlert');
            if (modalTitle) modalTitle.textContent = 'Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯';
            if (editUserIdEl) editUserIdEl.value = '';
            if (userUsernameEl) {
                userUsernameEl.value = '';
                userUsernameEl.disabled = false;
            }
            if (userFullNameEl) userFullNameEl.value = '';
            if (userPasswordEl) {
                userPasswordEl.value = '';
                userPasswordEl.required = true;
            }
            if (passwordRequiredEl) passwordRequiredEl.style.display = 'inline';
            if (passwordHintEl) passwordHintEl.style.display = 'none';
            if (userRoleEl) userRoleEl.value = 'employee';
            if (addUserAlertEl) addUserAlertEl.innerHTML = '';
        }
        
        function openEditUserModal(userId, username, fullName, role, isActive) {
            if (currentUserRole !== 'admin') {
                showAlert(document.getElementById('usersAlert'), 'Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†.', 'error');
                return;
            }
            const modal = document.getElementById('addUserModal');
            if (modal) {
                modal.classList.add('show');
                modal.style.display = 'flex';
            }
            const modalTitleEl = document.getElementById('addUserModalTitle');
            const editUserIdEl = document.getElementById('editUserId');
            const userUsernameEl = document.getElementById('userUsername');
            const userFullNameEl = document.getElementById('userFullName');
            const userPasswordEl = document.getElementById('userPassword');
            const passwordRequiredEl = document.getElementById('passwordRequired');
            const passwordHintEl = document.getElementById('passwordHint');
            const userRoleEl = document.getElementById('userRole');
            const addUserAlertEl = document.getElementById('addUserAlert');
            if (modalTitleEl) modalTitleEl.textContent = 'ØªØ¹Ø¯ÙŠÙ„ Ù…Ø³ØªØ®Ø¯Ù…';
            if (editUserIdEl) editUserIdEl.value = userId;
            if (userUsernameEl) {
                userUsernameEl.value = username;
                userUsernameEl.disabled = true;
            }
            if (userFullNameEl) userFullNameEl.value = fullName;
            if (userPasswordEl) {
                userPasswordEl.value = '';
                userPasswordEl.required = false;
            }
            if (passwordRequiredEl) passwordRequiredEl.style.display = 'none';
            if (passwordHintEl) passwordHintEl.style.display = 'block';
            if (userRoleEl) userRoleEl.value = role;
            if (addUserAlertEl) addUserAlertEl.innerHTML = '';
        }
        
        function closeAddUserModal() {
            const modal = document.getElementById('addUserModal');
            if (modal) {
                modal.classList.remove('show');
                modal.style.display = 'none';
            }
        }
        
        async function saveUser() {
            if (currentUserRole !== 'admin') {
                showAlert(document.getElementById('addUserAlert'), 'Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ø¥Ø¶Ø§ÙØ©/ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†.', 'error');
                return;
            }
            
            const editUserIdEl = document.getElementById('editUserId');
            const userUsernameEl = document.getElementById('userUsername');
            const userFullNameEl = document.getElementById('userFullName');
            const userPasswordEl = document.getElementById('userPassword');
            const userRoleEl = document.getElementById('userRole');
            const alertDiv = document.getElementById('addUserAlert');
            if (!editUserIdEl || !userUsernameEl || !userFullNameEl || !userRoleEl) return;
            const editUserId = editUserIdEl.value;
            const username = userUsernameEl.value.trim();
            const fullName = userFullNameEl.value.trim();
            const password = userPasswordEl ? userPasswordEl.value.trim() : '';
            const role = userRoleEl.value;
            
            if (!username || !fullName) {
                showAlert(alertDiv, 'ÙŠØ±Ø¬Ù‰ ØªØ¹Ø¨Ø¦Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©.', 'error');
                return;
            }
            
            if (!editUserId && !password) {
                showAlert(alertDiv, 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±.', 'error');
                return;
            }
            
            try {
                const userData = {
                    full_name: fullName,
                    role: role,
                    system_name: SYSTEM_NAME
                };
                
                if (editUserId) {
                    userData.system_name = SYSTEM_NAME;
                    if (password) {
                        const passwordHash = await hashPassword(password);
                        userData.password_hash = passwordHash;
                    }
                    await supabaseRequest('users', 'PATCH', userData, `?id=eq.${editUserId}`);
                    showAlert(alertDiv, 'ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­', 'success');
                } else {
                    if (!password) {
                        showAlert(alertDiv, 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±.', 'error');
                        return;
                    }
                    
                    let usernameExistsInCurrentSystem = false;
                    try {
                        const existingUserFilter = `?username=eq.${encodeURIComponent(username)}`;
                        const existingUsers = await supabaseRequest('users', 'GET', null, existingUserFilter);
                        
                        if (Array.isArray(existingUsers) && existingUsers.length > 0) {
                            const filtered = existingUsers.filter(user => {
                                if (user.system_name !== undefined && user.system_name !== null && user.system_name !== '') {
                                    return user.system_name === SYSTEM_NAME;
                                }
                                return true;
                            });
                            
                            if (filtered.length > 0) {
                                usernameExistsInCurrentSystem = true;
                                showAlert(alertDiv, 'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù†Ø¸Ø§Ù…. ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ø³Ù… Ù…Ø³ØªØ®Ø¯Ù… Ø¢Ø®Ø±.', 'error');
                                return;
                            }
                        }
                    } catch (checkError) {
                        console.warn('Error checking username (will try to create anyway):', checkError);
                    }
                    
                    const passwordHash = await hashPassword(password);
                    userData.username = username;
                    userData.password_hash = passwordHash;
                    userData.is_active = true;
                    userData.system_name = SYSTEM_NAME;
                    
                    try {
                        const result = await supabaseRequest('users', 'POST', userData);
                        showAlert(alertDiv, 'ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­', 'success');
                    } catch (createError) {
                        const errorMsg = createError.message || createError.toString() || '';
                        
                        if (errorMsg.includes('duplicate') || errorMsg.includes('23505') || errorMsg.includes('409') || errorMsg.includes('unique')) {
                            try {
                                const existingUserFilter = `?username=eq.${encodeURIComponent(username)}`;
                                const existingUsers = await supabaseRequest('users', 'GET', null, existingUserFilter);
                                
                                if (Array.isArray(existingUsers) && existingUsers.length > 0) {
                                    const existingUser = existingUsers[0];
                                    
                                    if (existingUser.system_name && existingUser.system_name !== SYSTEM_NAME) {
                                        const updateData = {
                                            system_name: SYSTEM_NAME,
                                            full_name: fullName,
                                            role: role
                                        };
                                        
                                        if (password) {
                                            const passwordHash = await hashPassword(password);
                                            updateData.password_hash = passwordHash;
                                        }
                                        
                                        await supabaseRequest('users', 'PATCH', updateData, `?id=eq.${existingUser.id}`);
                                        showAlert(alertDiv, `ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… "${username}" ÙˆØ¥Ø¶Ø§ÙØªÙ‡ Ø¥Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ù†Ø¸Ø§Ù… Ø¨Ù†Ø¬Ø§Ø­`, 'success');
                                        
                                        closeAddUserModal();
                                        setTimeout(() => {
                                            loadUsers();
                                        }, 1000);
                                        return;
                                    } else if (existingUser.system_name === SYSTEM_NAME) {
                                        showAlert(alertDiv, 'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù†Ø¸Ø§Ù…. ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ø³Ù… Ù…Ø³ØªØ®Ø¯Ù… Ø¢Ø®Ø±.', 'error');
                                        return;
                                    } else {
                                        const updateData = {
                                            system_name: SYSTEM_NAME,
                                            full_name: fullName,
                                            role: role
                                        };
                                        
                                        if (password) {
                                            const passwordHash = await hashPassword(password);
                                            updateData.password_hash = passwordHash;
                                        }
                                        
                                        await supabaseRequest('users', 'PATCH', updateData, `?id=eq.${existingUser.id}`);
                                        showAlert(alertDiv, `ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… "${username}" ÙˆØ¥Ø¶Ø§ÙØªÙ‡ Ø¥Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ù†Ø¸Ø§Ù… Ø¨Ù†Ø¬Ø§Ø­`, 'success');
                                        
                                        closeAddUserModal();
                                        setTimeout(() => {
                                            loadUsers();
                                        }, 1000);
                                        return;
                                    }
                                } else {
                                    showAlert(alertDiv, 'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„. ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ø³Ù… Ù…Ø³ØªØ®Ø¯Ù… Ø¢Ø®Ø±.', 'error');
                                    return;
                                }
                            } catch (checkError) {
                                showAlert(alertDiv, 'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„. ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ø³Ù… Ù…Ø³ØªØ®Ø¯Ù… Ø¢Ø®Ø±.', 'error');
                                return;
                            }
                        }
                        
                        throw createError;
                    }
                }
                
                closeAddUserModal();
                setTimeout(() => {
                    loadUsers();
                }, 500);
            } catch (error) {
                const errorMessage = error.message || error.toString() || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
                if (errorMessage.includes('duplicate key') || errorMessage.includes('23505') || errorMessage.includes('409')) {
                    showAlert(alertDiv, 'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„. ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ø³Ù… Ù…Ø³ØªØ®Ø¯Ù… Ø¢Ø®Ø±.', 'error');
                } else if (errorMessage.includes('Failed to fetch') || errorMessage.includes('network')) {
                    showAlert(alertDiv, 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª ÙˆØ§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.', 'error');
                } else {
                    showAlert(alertDiv, `Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${errorMessage}`, 'error');
                }
            }
        }
        
        async function toggleUserStatus(userId, newStatus) {
            if (currentUserRole !== 'admin') {
                showAlert(document.getElementById('usersAlert'), 'Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†.', 'error');
                return;
            }
            
            try {
                await supabaseRequest('users', 'PATCH', { is_active: newStatus }, `?id=eq.${userId}`);
                loadUsers();
            } catch (error) {
                showAlert(document.getElementById('usersAlert'), 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….', 'error');
            }
        }
        
        async function deleteUser(userId, username = '') {
            if (currentUserRole !== 'admin') {
                showAlert(document.getElementById('usersAlert'), 'Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†.', 'error');
                return;
            }
            
            const confirmMessage = username 
                ? `Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… "${username}"ØŸ\n\nØªØ­Ø°ÙŠØ±: Ø³ÙŠØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹.`
                : 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŸ\n\nØªØ­Ø°ÙŠØ±: Ø³ÙŠØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹.';
            
            if (!confirm(confirmMessage)) {
                return;
            }
            
            try {
                await supabaseRequest('users', 'DELETE', null, `?id=eq.${userId}`);
                loadUsers();
                showAlert(document.getElementById('usersAlert'), `ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… "${username || userId}" Ø¨Ù†Ø¬Ø§Ø­`, 'success');
            } catch (error) {
                showAlert(document.getElementById('usersAlert'), `Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${error.message}`, 'error');
            }
        }
        function getCurrentMonthYear() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            return `${year}-${month}`;
        }
        function extractMonthYearFromDetails(details) {
            if (!details || !Array.isArray(details) || details.length === 0) {
                return null;
            }
            for (const detail of details) {
                let dateObj = null;
                let dateField = detail.date1 || detail.date2 || detail.date3 || 
                               detail.date || detail.dateStr || detail.createdAt || 
                               detail['ColumnB'] || detail[1];
                if (!dateField) continue;
                try {
                    if (dateField instanceof Date) {
                        dateObj = dateField;
                    } else if (typeof dateField === 'number' && dateField > 40000) {
                        dateObj = new Date((dateField - 25569) * 86400 * 1000);
                    } else if (typeof dateField === 'string') {
                        const dateStr = dateField.trim();
                        const ddmmyyyy = dateStr.match(/^(\d{1,2})[-\/](\d{1,2})[-\/](\d{4})$/);
                        if (ddmmyyyy) {
                            dateObj = new Date(parseInt(ddmmyyyy[3]), parseInt(ddmmyyyy[2]) - 1, parseInt(ddmmyyyy[1]));
                        } else {
                            const yyyymmdd = dateStr.match(/^(\d{4})[-\/](\d{1,2})[-\/](\d{1,2})$/);
                            if (yyyymmdd) {
                                dateObj = new Date(parseInt(yyyymmdd[1]), parseInt(yyyymmdd[2]) - 1, parseInt(yyyymmdd[3]));
                            } else {
                                dateObj = new Date(dateField);
                            }
                        }
                    } else {
                        dateObj = new Date(dateField);
                    }
                    if (dateObj && !isNaN(dateObj.getTime())) {
                        const year = dateObj.getFullYear();
                        const month = String(dateObj.getMonth() + 1).padStart(2, '0');
                        return `${year}-${month}`;
                    }
                } catch (e) {
                    continue;
                }
            }
            return null;
        }
        function extractMonthYearFromData(data) {
            if (!data || !Array.isArray(data) || data.length === 0) {
                return null;
            }
            for (const row of data) {
                const dateField = row['ColumnB'] || row[1] || row.createdAt || row.date;
                if (!dateField) continue;
                try {
                    let dateObj = null;
                    if (dateField instanceof Date) {
                        dateObj = dateField;
                    } else if (typeof dateField === 'number' && dateField > 40000) {
                        dateObj = new Date((dateField - 25569) * 86400 * 1000);
                    } else if (typeof dateField === 'string') {
                        const dateStr = dateField.trim();
                        const ddmmyyyy = dateStr.match(/^(\d{1,2})[-\/](\d{1,2})[-\/](\d{4})$/);
                        if (ddmmyyyy) {
                            dateObj = new Date(parseInt(ddmmyyyy[3]), parseInt(ddmmyyyy[2]) - 1, parseInt(ddmmyyyy[1]));
                        } else {
                            const yyyymmdd = dateStr.match(/^(\d{4})[-\/](\d{1,2})[-\/](\d{1,2})$/);
                            if (yyyymmdd) {
                                dateObj = new Date(parseInt(yyyymmdd[1]), parseInt(yyyymmdd[2]) - 1, parseInt(yyyymmdd[3]));
                            } else {
                                dateObj = new Date(dateField);
                            }
                        }
                    } else {
                        dateObj = new Date(dateField);
                    }
                    if (dateObj && !isNaN(dateObj.getTime())) {
                        const year = dateObj.getFullYear();
                        const month = String(dateObj.getMonth() + 1).padStart(2, '0');
                        return `${year}-${month}`;
                    }
                } catch (e) {
                    continue;
                }
            }
            return null;
        }
        const arabicMonths = [
            'ÙƒØ§Ù†ÙˆÙ† Ø§Ù„Ø«Ø§Ù†ÙŠ', 'Ø´Ø¨Ø§Ø·', 'Ø¢Ø°Ø§Ø±', 'Ù†ÙŠØ³Ø§Ù†', 'Ø£ÙŠØ§Ø±', 'Ø­Ø²ÙŠØ±Ø§Ù†',
            'ØªÙ…ÙˆØ²', 'Ø¢Ø¨', 'Ø£ÙŠÙ„ÙˆÙ„', 'ØªØ´Ø±ÙŠÙ† Ø§Ù„Ø£ÙˆÙ„', 'ØªØ´Ø±ÙŠÙ† Ø§Ù„Ø«Ø§Ù†ÙŠ', 'ÙƒØ§Ù†ÙˆÙ† Ø§Ù„Ø£ÙˆÙ„'
        ];
        const subscriptionPrices = {
            basic: {
                'Iraqcell_Bronze_Profile_NEW': 30000,
                'Iraqcell_Bronze_Profile': 30000,
                'Iraqcell_Silver_Profile_NEW': 40000,
                'Iraqcell_Silver_Profile': 40000,
                'Iraqcell_Gold_Profile_NEW': 50000,
                'Iraqcell_Gold_Profile': 50000,
                'Iraqcell_Platinum_Profile_NEW': 65000,
                'Iraqcell_Platinum_Profile': 65000
            },
            advanced: {
                promo: {
                    'Iraqcell_Bronze_Profile_NEW': 75000,
                    'Iraqcell_Bronze_Profile': 75000,
                    'Iraqcell_Silver_Profile_NEW': 105000,
                    'Iraqcell_Silver_Profile': 105000,
                    'Iraqcell_Gold_Profile_NEW': 120000,
                    'Iraqcell_Gold_Profile': 120000,
                    'Iraqcell_Platinum_Profile_NEW': 165000,
                    'Iraqcell_Platinum_Profile': 165000
                },
                official: {
                    'Iraqcell_Bronze_Profile_NEW': 90000,
                    'Iraqcell_Bronze_Profile': 90000,
                    'Iraqcell_Silver_Profile_NEW': 120000,
                    'Iraqcell_Silver_Profile': 120000,
                    'Iraqcell_Gold_Profile_NEW': 150000,
                    'Iraqcell_Gold_Profile': 150000,
                    'Iraqcell_Platinum_Profile_NEW': 195000,
                    'Iraqcell_Platinum_Profile': 195000
                }
            },
            twoMonths: {
                promo: {
                    'Iraqcell_Bronze_Profile_NEW': 50000,
                    'Iraqcell_Bronze_Profile': 50000,
                    'Iraqcell_Silver_Profile_NEW': 70000, 
                    'Iraqcell_Silver_Profile': 70000,
                    'Iraqcell_Gold_Profile_NEW': 80000, 
                    'Iraqcell_Gold_Profile': 80000,
                    'Iraqcell_Platinum_Profile_NEW': 110000,
                    'Iraqcell_Platinum_Profile': 110000
                }
            }
        };
        function getSubscriptionCategory(subscriptionName, agentName) {
            if (!subscriptionName) return '';
            const subscription = String(subscriptionName).trim();
            if (subscription.includes('Platinum') || subscription.includes('Ø¨Ù„Ø§ØªÙŠÙ†ÙŠÙˆÙ…') || subscription.toLowerCase().includes('platinum')) {
                return 'P';
            } else if (subscription.includes('Gold') || subscription.includes('ÙƒÙˆÙ„Ø¯') || subscription.toLowerCase().includes('gold')) {
                return 'G';
            } else if (subscription.includes('Silver') || subscription.includes('Ø³Ù„ÙØ±') || subscription.toLowerCase().includes('silver')) {
                return 'S';
            } else if (subscription.includes('Bronze') || subscription.includes('Ø¨Ø±ÙˆÙ†Ø²') || subscription.toLowerCase().includes('bronze')) {
                return 'B';
            }
            return '';
        }
        function getSubscriptionPrice(subscriptionName, category, type = 'basic', priceType = 'basic') {
            if (!subscriptionName || !category) return 0;
            const subType = String(subscriptionName).trim();
            const defaultNames = {
                'B': 'Iraqcell_Bronze_Profile_NEW',
                'S': 'Iraqcell_Silver_Profile_NEW',
                'G': 'Iraqcell_Gold_Profile_NEW',
                'P': 'Iraqcell_Platinum_Profile_NEW'
            };
            if (type === 'basic') {
                if (subscriptionPrices.basic[subType]) {
                    return subscriptionPrices.basic[subType];
                }
            } else if (type === 'advanced') {
                if (priceType === 'promo' && subscriptionPrices.advanced.promo[subType]) {
                    return subscriptionPrices.advanced.promo[subType];
                } else if (priceType === 'official' && subscriptionPrices.advanced.official[subType]) {
                    return subscriptionPrices.advanced.official[subType];
                }
            } else if (type === 'twoMonths') {
                if (subscriptionPrices.twoMonths.promo && subscriptionPrices.twoMonths.promo[subType]) {
                    return subscriptionPrices.twoMonths.promo[subType];
                }
            }
            const defaultName = defaultNames[category];
            if (!defaultName) return 0;
            if (type === 'basic') {
                return subscriptionPrices.basic[defaultName] || 0;
            } else if (type === 'advanced') {
                if (priceType === 'promo') {
                    return subscriptionPrices.advanced.promo[defaultName] || 0;
                } else if (priceType === 'official') {
                    return subscriptionPrices.advanced.official[defaultName] || 0;
                }
            } else if (type === 'twoMonths') {
                return subscriptionPrices.twoMonths.promo[defaultName] || 0;
            }
            return 0;
        }
        function setupPercentageFileUpload() {
            const fileUpload = document.getElementById('percentageFileUpload');
            const fileInput = document.getElementById('percentageFileInput');
            if (!fileUpload || !fileInput) return;
            fileUpload.addEventListener('click', () => fileInput.click());
            fileUpload.addEventListener('dragover', (e) => {
                e.preventDefault();
                fileUpload.style.background = 'rgba(128, 28, 50, 0.1)';
            });
            fileUpload.addEventListener('dragleave', () => {
                fileUpload.style.background = '';
            });
            fileUpload.addEventListener('drop', (e) => {
                e.preventDefault();
                fileUpload.style.background = '';
                if (e.dataTransfer.files.length > 0) {
                    fileInput.files = e.dataTransfer.files;
                    handlePercentageFileUpload(e.dataTransfer.files[0]);
                }
            });
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handlePercentageFileUpload(e.target.files[0]);
                }
            });
        }
        function handlePercentageFileUpload(file) {
            const fileName = file.name;
            const selectedAgentEl = document.getElementById('selectedAgentForPercentage');
            if (!selectedAgentEl) return;
            const selectedAgent = selectedAgentEl.value;
            if (!selectedAgent) {
                alert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± ÙˆÙƒÙŠÙ„ Ø£ÙˆÙ„Ø§Ù‹');
                const percentageFileInputEl = document.getElementById('percentageFileInput');
                if (percentageFileInputEl) percentageFileInputEl.value = '';
                return;
            }
            const percentageFileNameEl = document.getElementById('percentageFileName');
            if (percentageFileNameEl) {
                percentageFileNameEl.textContent = `ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù: ${fileName}`;
                percentageFileNameEl.classList.remove('hidden');
            }
            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                percentageData = {
                    agentName: selectedAgent,
                    data: XLSX.utils.sheet_to_json(firstSheet, { header: 1 }),
                    fileName: fileName
                };
                showSuccessMessage(`ØªÙ… ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ø§Ù„ÙˆÙƒÙŠÙ„ "${selectedAgent}" Ø¨Ù†Ø¬Ø§Ø­. Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ "ØªØ­Ù„ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆÙƒÙŠÙ„" Ù„Ù„Ø¨Ø¯Ø¡`);
                logActivity('Ø±ÙØ¹ Ù…Ù„Ù Ù†Ø³Ø¨Ø© Ø§Ù„ÙˆÙƒÙ„Ø§Ø¡', `ØªÙ… Ø±ÙØ¹ Ù…Ù„Ù Ù„Ù„ÙˆÙƒÙŠÙ„ ${selectedAgent}: ${fileName}`);
            };
            reader.readAsArrayBuffer(file);
        }
        function onAgentSelectedForPercentage() {
            const selectedAgentEl = document.getElementById('selectedAgentForPercentage');
            if (!selectedAgentEl) return;
            const selectedAgent = selectedAgentEl.value;
            const agentFileUploadSectionEl = document.getElementById('agentFileUploadSection');
            const percentageFileInputEl = document.getElementById('percentageFileInput');
            const percentageFileNameEl = document.getElementById('percentageFileName');
            const percentageRateSelectEl = document.getElementById('percentageRateSelect');
            const percentageRateInfoEl = document.getElementById('percentageRateInfo');
            if (selectedAgent) {
                if (agentFileUploadSectionEl) agentFileUploadSectionEl.style.display = 'block';
                if (percentageFileInputEl) percentageFileInputEl.value = '';
                if (percentageFileNameEl) percentageFileNameEl.classList.add('hidden');
                percentageData = null;
                const agent = agentsList.find(a => a.name === selectedAgent);
                if (agent && agent.percentage) {
                    if (percentageRateSelectEl) percentageRateSelectEl.value = agent.percentage;
                    if (percentageRateInfoEl) percentageRateInfoEl.textContent = 
                        `Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© Ù„Ù„ÙˆÙƒÙŠÙ„: ${agent.percentage}%`;
                } else {
                    if (percentageRateSelectEl) percentageRateSelectEl.value = 16;
                    if (percentageRateInfoEl) percentageRateInfoEl.textContent = 
                        'Ø³ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©: 16%';
                }
            } else {
                if (agentFileUploadSectionEl) agentFileUploadSectionEl.style.display = 'none';
            }
        }
        function updatePercentageRate() {
            const selectedAgent = document.getElementById('selectedAgentForPercentage').value;
            const newRate = parseFloat(document.getElementById('percentageRateSelect').value) || 16;
            if (newRate < 0 || newRate > 100) {
                alert('Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø¦ÙˆÙŠØ© ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ø¨ÙŠÙ† 0 Ùˆ 100');
                const agent = agentsList.find(a => a.name === selectedAgent);
                document.getElementById('percentageRateSelect').value = agent ? (agent.percentage || 16) : 16;
                return;
            }
            if (selectedAgent) {
                const agent = agentsList.find(a => a.name === selectedAgent);
                if (agent) {
                    agent.percentage = newRate;
                    localStorage.setItem('agentsList', JSON.stringify(agentsList));
                    document.getElementById('percentageRateInfo').textContent = 
                        `ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Ø³Ø¨Ø© Ù„Ù„ÙˆÙƒÙŠÙ„: ${newRate}%`;
                    showSuccessMessage(`ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Ø³Ø¨Ø© Ù„Ù„ÙˆÙƒÙŠÙ„ "${selectedAgent}" Ø¥Ù„Ù‰ ${newRate}%`);
                }
            }
        }
        function updateAgentsListForPercentage() {
            const select = document.getElementById('selectedAgentForPercentage');
            if (!select) return;
            const currentValue = select.value;
            select.innerHTML = '<option value="">-- Ø§Ø®ØªØ± ÙˆÙƒÙŠÙ„ --</option>';
            if (Array.isArray(agentsList)) {
            agentsList.forEach(agent => {
                const option = document.createElement('option');
                option.value = agent.name;
                option.textContent = agent.name;
                select.appendChild(option);
            });
            }
            if (currentValue) {
                select.value = currentValue;
            }
            select.removeEventListener('change', onAgentSelectedForPercentage);
            select.addEventListener('change', onAgentSelectedForPercentage);
        }
        async function analyzeAgentPercentageData() {
            if (!percentageData || !percentageData.data || percentageData.data.length === 0) {
                alert('ÙŠØ±Ø¬Ù‰ Ø±ÙØ¹ Ù…Ù„Ù Excel Ø£ÙˆÙ„Ø§Ù‹');
                return;
            }
            const selectedAgent = percentageData.agentName;
            if (!selectedAgent) {
                alert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± ÙˆÙƒÙŠÙ„ Ø£ÙˆÙ„Ø§Ù‹');
                return;
            }
            const agent = agentsList.find(a => a.name === selectedAgent);
            let percentageRate = parseFloat(document.getElementById('percentageRateSelect').value) || 16;
            if (agent && agent.percentage) {
                percentageRate = agent.percentage;
                document.getElementById('percentageRateSelect').value = percentageRate;
                showSuccessMessage(`ØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© Ù„Ù„ÙˆÙƒÙŠÙ„: ${percentageRate}%`);
            }
            try {
                const data = percentageData.data;
                let headerRow = -1;
                for (let i = 0; i < Math.min(10, data.length); i++) {
                    const row = data[i];
                    const rowText = row.join(' ').toLowerCase();
                    if ((rowText.includes('profile') || rowText.includes('Ù†ÙˆØ¹') || rowText.includes('type')) && 
                        (rowText.includes('amount') || rowText.includes('Ù…Ø¨Ù„Øº') || row.length > 5)) {
                        headerRow = i;
                        break;
                    }
                }
                if (headerRow === -1) {
                    headerRow = 0;
                }
                const headers = data[headerRow] || [];
                const profileCol = findColumnIndex(headers, ['profile', 'Ù†ÙˆØ¹', 'type', 'h']);
                const amountCol = findColumnIndex(headers, ['amount', 'Ù…Ø¨Ù„Øº', 'Ù‚ÙŠÙ…Ø©', 'l']);
                if (profileCol < 0 || amountCol < 0) {
                    alert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø£Ø¹Ù…Ø¯Ø© Profile Type Ùˆ Amount ÙÙŠ Ø§Ù„Ù…Ù„Ù. ØªØ£ÙƒØ¯ Ù…Ù† ØµØ­Ø© Ø§Ù„Ù…Ù„Ù.');
                    return;
                }
                await analyzeSubscriptionFileWithSystemPrices(data, headerRow, profileCol, amountCol, selectedAgent, percentageRate);
            } catch (error) {
                console.error('Error analyzing percentage data:', error);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ' + error.message);
            }
        }
        async function analyzeSubscriptionFileWithSystemPrices(data, headerRow, profileCol, amountCol, agentName, percentageRate) {
            const hasExistingData = agentPercentages[agentName] && (
                agentPercentages[agentName].iqT > 0 || 
                agentPercentages[agentName].totalCount > 0
            );
            
            let keepDeductions = false;
            if (hasExistingData) {
                const existing = agentPercentages[agentName];
                if (existing.deductions > 0 || existing.penalties > 0) {
                    keepDeductions = confirm(`âš ï¸ ÙŠÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­ÙÙˆØ¸Ø© Ù„Ù„ÙˆÙƒÙŠÙ„ "${agentName}"\n\nÙ‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø§Ù„Ø§Ø³ØªÙ‚Ø·Ø§Ø¹Ø§Øª ÙˆØ§Ù„ØºØ±Ø§Ù…Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©ØŸ\n\n- Ù†Ø¹Ù…: Ø³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ù…Ø¹ Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø§Ù„Ø§Ø³ØªÙ‚Ø·Ø§Ø¹Ø§Øª ÙˆØ§Ù„ØºØ±Ø§Ù…Ø§Øª\n- Ø¥Ù„ØºØ§Ø¡: Ø³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù…Ø§ ÙÙŠ Ø°Ù„Ùƒ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø§Ø³ØªÙ‚Ø·Ø§Ø¹Ø§Øª ÙˆØ§Ù„ØºØ±Ø§Ù…Ø§Øª Ø¥Ù„Ù‰ ØµÙØ±`);
                }
                
                if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆÙƒÙŠÙ„ "${agentName}"ØŸ\n\nØ³ÙŠØªÙ… Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù…Ù† Ø§Ù„Ù…Ù„Ù.`)) {
                    return;
                }
            }
            
            let countP = 0, countG = 0, countS = 0, countB = 0;
            for (let i = headerRow + 1; i < data.length; i++) {
                const row = data[i];
                if (!row || row.length === 0) continue;
                const profileType = (row[profileCol] || '').toString().trim();
                const amount = parseFloat(row[amountCol]) || 0;
                if (!profileType) continue;
                const category = getSubscriptionCategory(profileType, agentName);
                if (!category) continue;
                switch(category) {
                    case 'P':
                        countP++;
                        break;
                    case 'G':
                        countG++;
                        break;
                    case 'S':
                        countS++;
                        break;
                    case 'B':
                        countB++;
                        break;
                }
            }
            const officialPriceP = subscriptionPrices.basic['Iraqcell_Platinum_Profile_NEW'] || 65000;
            const officialPriceG = subscriptionPrices.basic['Iraqcell_Gold_Profile_NEW'] || 50000;
            const officialPriceS = subscriptionPrices.basic['Iraqcell_Silver_Profile_NEW'] || 40000;
            const officialPriceB = subscriptionPrices.basic['Iraqcell_Bronze_Profile_NEW'] || 30000;
            const iqP = countP * officialPriceP;
            const iqG = countG * officialPriceG;
            const iqS = countS * officialPriceS;
            const iqB = countB * officialPriceB;
            const iqT = iqP + iqG + iqS + iqB;
            const iqPPercent = iqP * (percentageRate / 100);
            const iqGPercent = iqG * (percentageRate / 100);
            const iqSPercent = iqS * (percentageRate / 100);
            const iqBPercent = iqB * (percentageRate / 100);
            const agentPercentageAmount = iqPPercent + iqGPercent + iqSPercent + iqBPercent;
            const agent = agentsList.find(a => a.name === agentName);
            const agentPhone = agent?.phone || '';
            const agentEmail = agent?.email || '';
            
            const existing = agentPercentages[agentName];
            
            if (!existing) {
                agentPercentages[agentName] = {
                    percentage: percentageRate,
                    iqT: iqT,
                    iqP: iqP,
                    iqG: iqG,
                    iqS: iqS,
                    iqB: iqB,
                    iqPPercent: iqPPercent,
                    iqGPercent: iqGPercent,
                    iqSPercent: iqSPercent,
                    iqBPercent: iqBPercent,
                    agentPercentageAmount: agentPercentageAmount,
                    deductions: 0,
                    penalties: 0,
                    netPercentage: agentPercentageAmount,
                    totalCount: countP + countG + countS + countB,
                    countP: countP,
                    countG: countG,
                    countS: countS,
                    countB: countB,
                    phone: agentPhone,
                    email: agentEmail
                };
            } else {
                agentPercentages[agentName] = {
                    percentage: percentageRate,
                    iqT: iqT,
                    iqP: iqP,
                    iqG: iqG,
                    iqS: iqS,
                    iqB: iqB,
                    iqPPercent: iqPPercent,
                    iqGPercent: iqGPercent,
                    iqSPercent: iqSPercent,
                    iqBPercent: iqBPercent,
                    agentPercentageAmount: agentPercentageAmount,
                    deductions: keepDeductions ? (existing.deductions || 0) : 0,
                    penalties: keepDeductions ? (existing.penalties || 0) : 0,
                    netPercentage: agentPercentageAmount - (keepDeductions ? (existing.deductions || 0) : 0) - (keepDeductions ? (existing.penalties || 0) : 0),
                    totalCount: countP + countG + countS + countB,
                    countP: countP,
                    countG: countG,
                    countS: countS,
                    countB: countB,
                    phone: agentPhone || existing.phone || '',
                    email: agentEmail || existing.email || ''
                };
            }
            renderPercentageTable();
            const extractedMonthYear = extractMonthYearFromData(percentageData.data);
            const monthYear = extractedMonthYear || getCurrentMonthYear();
            
            try {
                localStorage.setItem('agentPercentages', JSON.stringify(agentPercentages));
                localStorage.setItem('agentPercentages_monthYear', monthYear);
            } catch (e) {
                console.warn('âš  Failed to save to localStorage:', e);
            }
            
            if (supabaseClient) {
                try {
                    const saved = await saveToDatabase('agent_percentages', agentPercentages, { monthYear: monthYear });
                    if (saved) {
                    } else {
                    }
                } catch (error) {
                    console.error('âœ— Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ù†Ø³Ø¨ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
                }
                
                try {
                    await saveToDatabase('analysis_archives', {
                        data: percentageData.data || [],
                        details: [],
                        results: {},
                        agentReports: agentReports
                    }, { analysis_type: 'percentage', monthYear: monthYear });
                } catch (error) {
                    console.error('âœ— Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø£Ø±Ø´ÙŠÙ:', error);
                }
            }
            showSuccessMessage(`ØªÙ… ØªØ­Ù„ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆÙƒÙŠÙ„ "${agentName}" Ø¨Ù†Ø¬Ø§Ø­. Ø§Ù„Ù†Ø³Ø¨Ø©: ${percentageRate}% - Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: ${formatNumber(iqT)} Ø¯.Ø¹`);
            logActivity('ØªØ­Ù„ÙŠÙ„ Ù†Ø³Ø¨Ø© Ø§Ù„ÙˆÙƒÙ„Ø§Ø¡', `ØªÙ… ØªØ­Ù„ÙŠÙ„ Ù…Ù„Ù Ø§Ù„ÙˆÙƒÙŠÙ„ ${agentName}: ${countP}P, ${countG}G, ${countS}S, ${countB}B - Ø§Ù„Ù†Ø³Ø¨Ø©: ${percentageRate}%`);
        }
        async function analyzeDirectPercentageFile(headers, headerRow) {
            const agentNameCol = findColumnIndex(headers, ['Ø§Ø³Ù…', 'ÙˆÙƒÙŠÙ„', 'Ø§Ù„ÙˆÙƒÙŠÙ„', 'name']);
            const iqTCol = findColumnIndex(headers, ['IQ.T', 'IQT', 'IQ', 'Øª']);
            const iqPCol = findColumnIndex(headers, ['IQ.P', 'IQP', 'P']);
            const iqGCol = findColumnIndex(headers, ['IQ.G', 'IQG', 'G']);
            const iqSCol = findColumnIndex(headers, ['IQ.S', 'IQS', 'S']);
            const iqBCol = findColumnIndex(headers, ['IQ.B', 'IQB', 'B']);
            const agentPercentageCol = findColumnIndex(headers, ['Ù†Ø³Ø¨Ø©', 'Ø§Ù„ÙˆÙƒÙŠÙ„', 'Ù†Ø³Ø¨Ø© Ø§Ù„ÙˆÙƒÙŠÙ„']);
            let defaultPercentage = 15;
            for (let i = 0; i < headers.length; i++) {
                const header = (headers[i] || '').toString().toUpperCase();
                if (header.includes('%16') || header.includes('16%')) {
                    defaultPercentage = 16;
                    break;
                } else if (header.includes('%15') || header.includes('15%')) {
                    defaultPercentage = 15;
                    break;
                }
            }
            for (let i = headerRow + 1; i < percentageData.length; i++) {
                const row = percentageData[i];
                if (!row || row.length === 0) continue;
                const agentName = row[agentNameCol];
                if (!agentName || agentName === 'Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹' || agentName.toString().trim() === '') continue;
                let agentPercentage = defaultPercentage;
                let agentPercentageAmount = 0;
                for (let j = 0; j < headers.length; j++) {
                    const header = (headers[j] || '').toString().toUpperCase();
                    if (header.includes('P%16') || header.includes('G%16') || header.includes('S%16') || header.includes('B%16')) {
                        agentPercentage = 16;
                        break;
                    } else if (header.includes('P%15') || header.includes('G%15') || header.includes('S%15') || header.includes('B%15')) {
                        agentPercentage = 15;
                        break;
                    }
                }
                const iqT = parseFloat(row[iqTCol]) || 0;
                const iqP = parseFloat(row[iqPCol]) || 0;
                const iqG = parseFloat(row[iqGCol]) || 0;
                const iqS = parseFloat(row[iqSCol]) || 0;
                const iqB = parseFloat(row[iqBCol]) || 0;
                if (agentPercentageCol >= 0 && row[agentPercentageCol]) {
                    agentPercentageAmount = parseFloat(row[agentPercentageCol]) || 0;
                } else {
                    agentPercentageAmount = calculateAgentPercentage(iqT, iqP, iqG, iqS, iqB, agentPercentage);
                }
                saveAgentPercentage(agentName, agentPercentage, iqT, iqP, iqG, iqS, iqB, agentPercentageAmount);
            }
            renderPercentageTable();
            const extractedMonthYear = extractMonthYearFromData(percentageData.data);
            const monthYear = extractedMonthYear || getCurrentMonthYear();
            
            try {
                localStorage.setItem('agentPercentages', JSON.stringify(agentPercentages));
                localStorage.setItem('agentPercentages_monthYear', monthYear);
            } catch (e) {
                console.warn('âš  Failed to save to localStorage:', e);
            }
            
            if (supabaseClient) {
                try {
                    const saved = await saveToDatabase('agent_percentages', agentPercentages, { monthYear: monthYear });
                    if (saved) {
                    } else {
                    }
                } catch (error) {
                    console.error('âœ— Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ù†Ø³Ø¨ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
                }
                
                try {
                    await saveToDatabase('analysis_archives', {
                        data: percentageData.data || [],
                        details: [],
                        results: {},
                        agentReports: agentReports
                    }, { analysis_type: 'percentage', monthYear: monthYear });
                } catch (error) {
                    console.error('âœ— Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø£Ø±Ø´ÙŠÙ:', error);
                }
            }
            showSuccessMessage('ØªÙ… ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
            logActivity('ØªØ­Ù„ÙŠÙ„ Ù†Ø³Ø¨Ø© Ø§Ù„ÙˆÙƒÙ„Ø§Ø¡', 'ØªÙ… ØªØ­Ù„ÙŠÙ„ Ù…Ù„Ù Ù†Ø³Ø¨Ø© Ø§Ù„ÙˆÙƒÙ„Ø§Ø¡ Ø¨Ù†Ø¬Ø§Ø­');
        }
        async function analyzeSubscriptionPercentageFile(headers, headerRow) {
            const agentNameCol = findColumnIndex(headers, ['Ø§Ø³Ù…', 'ÙˆÙƒÙŠÙ„', 'Ø§Ù„ÙˆÙƒÙŠÙ„', 'name', 'f', 'c']);
            const profileCol = findColumnIndex(headers, ['profile', 'Ù†ÙˆØ¹', 'type', 'h']);
            const amountCol = findColumnIndex(headers, ['amount', 'Ù…Ø¨Ù„Øº', 'Ù‚ÙŠÙ…Ø©', 'l']);
            const emailCol = findColumnIndex(headers, ['email', 'Ø¨Ø±ÙŠØ¯', 'e', 'p']);
            const percentageInput = prompt('ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù†Ø³Ø¨Ø©:\n1 - 15%\n2 - 16%', '1');
            const agentPercentage = (percentageInput === '2' || percentageInput === '16') ? 16 : 15;
            const agentData = {};
            for (let i = headerRow + 1; i < percentageData.length; i++) {
                const row = percentageData[i];
                if (!row || row.length === 0) continue;
                let agentName = '';
                if (agentNameCol >= 0 && row[agentNameCol]) {
                    agentName = (row[agentNameCol] || '').toString().trim();
                }
                if (!agentName && emailCol >= 0 && row[emailCol]) {
                    const email = (row[emailCol] || '').toString().trim();
                    if (email.includes('@')) {
                        agentName = email.split('@')[0];
                    } else {
                        agentName = email;
                    }
                }
                if (!agentName) {
                    for (let j = 0; j < row.length; j++) {
                        const cell = (row[j] || '').toString().trim();
                        if (cell && !/^\d+$/.test(cell) && !cell.includes('-') && !cell.includes('@') && cell.length > 2) {
                            agentName = cell;
                            break;
                        }
                    }
                }
                if (!agentName || agentName === '') continue;
                let profileType = '';
                if (profileCol >= 0 && row[profileCol]) {
                    profileType = (row[profileCol] || '').toString().trim();
                }
                let amount = 0;
                if (amountCol >= 0 && row[amountCol]) {
                    amount = parseFloat(row[amountCol]) || 0;
                }
                const category = getSubscriptionCategory(profileType, agentName) || 'B';
                if (!agentData[agentName]) {
                    agentData[agentName] = { 
                        P: 0, G: 0, S: 0, B: 0,
                        countP: 0, countG: 0, countS: 0, countB: 0
                    };
                }
                agentData[agentName][category] += amount;
                agentData[agentName]['count' + category] += 1;
            }
            for (const agentName in agentData) {
                const data = agentData[agentName];
                const iqP = data.P || 0;
                const iqG = data.G || 0;
                const iqS = data.S || 0;
                const iqB = data.B || 0;
                const iqT = iqP + iqG + iqS + iqB;
                const countP = data.countP || 0;
                const countG = data.countG || 0;
                const countS = data.countS || 0;
                const countB = data.countB || 0;
                const totalCount = countP + countG + countS + countB;
                const agentPercentageAmount = calculateAgentPercentage(iqT, iqP, iqG, iqS, iqB, agentPercentage);
                saveAgentPercentageWithCounts(
                    agentName, 
                    agentPercentage, 
                    iqT, iqP, iqG, iqS, iqB, 
                    agentPercentageAmount,
                    totalCount, countP, countG, countS, countB
                );
            }
            renderPercentageTable();
            const extractedMonthYear = extractMonthYearFromData(percentageData.data);
            const monthYear = extractedMonthYear || getCurrentMonthYear();
            
            try {
                localStorage.setItem('agentPercentages', JSON.stringify(agentPercentages));
                localStorage.setItem('agentPercentages_monthYear', monthYear);
            } catch (e) {
                console.warn('âš  Failed to save to localStorage:', e);
            }
            
            if (supabaseClient) {
                try {
                    const saved = await saveToDatabase('agent_percentages', agentPercentages, { monthYear: monthYear });
                    if (saved) {
                    } else {
                    }
                } catch (error) {
                    console.error('âœ— Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ù†Ø³Ø¨ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
                }
                
                try {
                    await saveToDatabase('analysis_archives', {
                        data: percentageData.data || [],
                        details: [],
                        results: {},
                        agentReports: agentReports
                    }, { analysis_type: 'percentage', monthYear: monthYear });
                } catch (error) {
                    console.error('âœ— Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø£Ø±Ø´ÙŠÙ:', error);
                }
            }
            showSuccessMessage(`ØªÙ… ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­. ØªÙ… Ø­Ø³Ø§Ø¨ Ø§Ù„Ù†Ø³Ø¨Ø© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… ${agentPercentage}%`);
            logActivity('ØªØ­Ù„ÙŠÙ„ Ù†Ø³Ø¨Ø© Ø§Ù„ÙˆÙƒÙ„Ø§Ø¡', `ØªÙ… ØªØ­Ù„ÙŠÙ„ Ù…Ù„Ù Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª ÙˆØ­Ø³Ø§Ø¨ Ø§Ù„Ù†Ø³Ø¨ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… ${agentPercentage}%`);
        }
        function saveAgentPercentage(agentName, percentage, iqT, iqP, iqG, iqS, iqB, agentPercentageAmount) {
            const agent = agentsList.find(a => a.name === agentName);
            const agentPhone = agent?.phone || '';
            const agentEmail = agent?.email || '';
            const hasExistingData = agentPercentages[agentName] && (
                agentPercentages[agentName].iqT > 0 || 
                agentPercentages[agentName].totalCount > 0
            );
            
            if (!agentPercentages[agentName]) {
                agentPercentages[agentName] = {
                    percentage: percentage,
                    iqT: iqT,
                    iqP: iqP,
                    iqG: iqG,
                    iqS: iqS,
                    iqB: iqB,
                    agentPercentageAmount: agentPercentageAmount,
                    deductions: 0,
                    penalties: 0,
                    netPercentage: agentPercentageAmount,
                    totalCount: 0,
                    countP: 0,
                    countG: 0,
                    countS: 0,
                    countB: 0,
                    phone: agentPhone,
                    email: agentEmail
                };
            } else {
                const existing = agentPercentages[agentName];
                const keepDeductions = hasExistingData && (existing.deductions > 0 || existing.penalties > 0);
                
                agentPercentages[agentName].percentage = percentage;
                agentPercentages[agentName].iqT = iqT;
                agentPercentages[agentName].iqP = iqP;
                agentPercentages[agentName].iqG = iqG;
                agentPercentages[agentName].iqS = iqS;
                agentPercentages[agentName].iqB = iqB;
                agentPercentages[agentName].agentPercentageAmount = agentPercentageAmount;
                agentPercentages[agentName].deductions = keepDeductions ? (existing.deductions || 0) : 0;
                agentPercentages[agentName].penalties = keepDeductions ? (existing.penalties || 0) : 0;
                agentPercentages[agentName].netPercentage = agentPercentageAmount - 
                    (keepDeductions ? (existing.deductions || 0) : 0) - 
                    (keepDeductions ? (existing.penalties || 0) : 0);
                if (agentPhone) {
                    agentPercentages[agentName].phone = agentPhone;
                }
                if (agentEmail) {
                    agentPercentages[agentName].email = agentEmail;
                }
            }
        }
        function saveAgentPercentageWithCounts(agentName, percentage, iqT, iqP, iqG, iqS, iqB, agentPercentageAmount, totalCount, countP, countG, countS, countB) {
            const agent = agentsList.find(a => a.name === agentName);
            const agentPhone = agent?.phone || '';
            const agentEmail = agent?.email || '';
            const hasExistingData = agentPercentages[agentName] && (
                agentPercentages[agentName].iqT > 0 || 
                agentPercentages[agentName].totalCount > 0
            );
            
            if (!agentPercentages[agentName]) {
                agentPercentages[agentName] = {
                    percentage: percentage,
                    iqT: iqT,
                    iqP: iqP,
                    iqG: iqG,
                    iqS: iqS,
                    iqB: iqB,
                    agentPercentageAmount: agentPercentageAmount,
                    deductions: 0,
                    penalties: 0,
                    netPercentage: agentPercentageAmount,
                    totalCount: totalCount,
                    countP: countP,
                    countG: countG,
                    countS: countS,
                    countB: countB,
                    phone: agentPhone,
                    email: agentEmail
                };
            } else {
                const existing = agentPercentages[agentName];
                const keepDeductions = hasExistingData && (existing.deductions > 0 || existing.penalties > 0);
                
                agentPercentages[agentName].percentage = percentage;
                agentPercentages[agentName].iqT = iqT;
                agentPercentages[agentName].iqP = iqP;
                agentPercentages[agentName].iqG = iqG;
                agentPercentages[agentName].iqS = iqS;
                agentPercentages[agentName].iqB = iqB;
                agentPercentages[agentName].agentPercentageAmount = agentPercentageAmount;
                agentPercentages[agentName].totalCount = totalCount;
                agentPercentages[agentName].countP = countP;
                agentPercentages[agentName].countG = countG;
                agentPercentages[agentName].countS = countS;
                agentPercentages[agentName].countB = countB;
                agentPercentages[agentName].deductions = keepDeductions ? (existing.deductions || 0) : 0;
                agentPercentages[agentName].penalties = keepDeductions ? (existing.penalties || 0) : 0;
                agentPercentages[agentName].netPercentage = agentPercentageAmount - 
                    (keepDeductions ? (existing.deductions || 0) : 0) - 
                    (keepDeductions ? (existing.penalties || 0) : 0);
                if (agentPhone) {
                    agentPercentages[agentName].phone = agentPhone;
                }
                if (agentEmail) {
                    agentPercentages[agentName].email = agentEmail;
                }
            }
        }
        function findColumnIndex(headers, keywords) {
            for (let i = 0; i < headers.length; i++) {
                const header = (headers[i] || '').toString().toLowerCase();
                if (keywords.some(keyword => header.includes(keyword.toLowerCase()))) {
                    return i;
                }
            }
            return -1;
        }
        function calculateAgentPercentage(iqT, iqP, iqG, iqS, iqB, percentage) {
            const rate = percentage / 100;
            return (iqP * rate) + (iqG * rate) + (iqS * rate) + (iqB * rate);
        }
        function renderPercentageTable() {
            const tbody = document.getElementById('percentageTableBody');
            if (!tbody) return;
            if (isRenderingTable) return;
            isRenderingTable = true;
            const activeElement = document.activeElement;
            let savedFocus = null;
            if (activeElement && activeElement.tagName === 'INPUT' && 
                activeElement.hasAttribute('data-agent-name') && 
                activeElement.hasAttribute('data-field-type')) {
                savedFocus = {
                    agentName: activeElement.getAttribute('data-agent-name'),
                    fieldType: activeElement.getAttribute('data-field-type'),
                    value: activeElement.value
                };
            }
            tbody.innerHTML = '';
            if (!agentPercentages || typeof agentPercentages !== 'object') {
                tbody.innerHTML = '<tr><td colspan="19" style="text-align: center; padding: 15px; color: #999; font-size: 0.85rem;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø¹Ø±Ø¶</td></tr>';
                isRenderingTable = false;
                return;
            }
            const agents = Object.keys(agentPercentages);
            if (agents.length === 0) {
                tbody.innerHTML = '<tr><td colspan="19" style="text-align: center; padding: 15px; color: #999; font-size: 0.85rem;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø¹Ø±Ø¶</td></tr>';
                isRenderingTable = false;
                return;
            }
            let totalIQT = 0, totalIQP = 0, totalIQG = 0, totalIQS = 0, totalIQB = 0;
            let totalIQPPercent = 0, totalIQGPercent = 0, totalIQSPercent = 0, totalIQBPercent = 0;
            let totalCountP = 0, totalCountG = 0, totalCountS = 0, totalCountB = 0;
            let totalAgentPercentage = 0;
            agents.forEach(agentName => {
                const data = agentPercentages[agentName] || {};
                const row = document.createElement('tr');
                row.style.borderBottom = '1px solid #ddd';
                const percentage = data.percentage || 15;
                const rate = percentage / 100;
                const iqPPercent = data.iqPPercent !== undefined ? data.iqPPercent : ((data.iqP || 0) * rate);
                const iqGPercent = data.iqGPercent !== undefined ? data.iqGPercent : ((data.iqG || 0) * rate);
                const iqSPercent = data.iqSPercent !== undefined ? data.iqSPercent : ((data.iqS || 0) * rate);
                const iqBPercent = data.iqBPercent !== undefined ? data.iqBPercent : ((data.iqB || 0) * rate);
                totalIQT += data.iqT || 0;
                totalIQP += data.iqP || 0;
                totalIQG += data.iqG || 0;
                totalIQS += data.iqS || 0;
                totalIQB += data.iqB || 0;
                totalIQPPercent += iqPPercent;
                totalIQGPercent += iqGPercent;
                totalIQSPercent += iqSPercent;
                totalIQBPercent += iqBPercent;
                totalCountP += data.countP || 0;
                totalCountG += data.countG || 0;
                totalCountS += data.countS || 0;
                totalCountB += data.countB || 0;
                
                const agent = agentsList.find(a => a.name === agentName);
                const totalActivations = (data.countB || 0) + (data.countS || 0) + (data.countG || 0) + (data.countP || 0);
                const totalAgentPercentageAmount = Math.round(iqBPercent) + Math.round(iqSPercent) + Math.round(iqGPercent) + Math.round(iqPPercent);
                const netAgentPercentage = totalAgentPercentageAmount - (data.deductions || 0) - (data.penalties || 0);
                totalAgentPercentage += totalAgentPercentageAmount;
                
                row.innerHTML = `
                    <td style="padding: 6px 4px; text-align: center; border: 1px solid #ddd; font-weight: 600; font-size: 0.75rem; background-color: #801c32; color: white;">${agentName}</td>
                    <td style="padding: 6px 4px; text-align: center; border: 1px solid #ddd; direction: ltr; font-size: 0.7rem;">${data.countB || 0}</td>
                    <td style="padding: 6px 4px; text-align: center; border: 1px solid #ddd; direction: ltr; font-size: 0.7rem;">${data.countS || 0}</td>
                    <td style="padding: 6px 4px; text-align: center; border: 1px solid #ddd; direction: ltr; font-size: 0.7rem;">${data.countG || 0}</td>
                    <td style="padding: 6px 4px; text-align: center; border: 1px solid #ddd; direction: ltr; font-size: 0.7rem;">${data.countP || 0}</td>
                    <td style="padding: 6px 4px; text-align: center; border: 1px solid #ddd; direction: ltr; font-size: 0.7rem; font-weight: 600;">${totalActivations}</td>
                    <td style="padding: 6px 4px; text-align: center; border: 1px solid #ddd; direction: ltr; font-size: 0.7rem;">${formatNumber(data.iqB || 0)}</td>
                    <td style="padding: 6px 4px; text-align: center; border: 1px solid #ddd; direction: ltr; font-size: 0.7rem;">${formatNumber(data.iqS || 0)}</td>
                    <td style="padding: 6px 4px; text-align: center; border: 1px solid #ddd; direction: ltr; font-size: 0.7rem;">${formatNumber(data.iqG || 0)}</td>
                    <td style="padding: 6px 4px; text-align: center; border: 1px solid #ddd; direction: ltr; font-size: 0.7rem;">${formatNumber(data.iqP || 0)}</td>
                    <td style="padding: 6px 4px; text-align: center; border: 1px solid #ddd; direction: ltr; font-size: 0.7rem;">${formatNumber(data.iqT || 0)}</td>
                    <td style="padding: 6px 4px; text-align: center; border: 1px solid #ddd; direction: ltr; font-weight: 600; color: #2C5F8D; font-size: 0.7rem;">${formatNumber(Math.round(iqBPercent))}</td>
                    <td style="padding: 6px 4px; text-align: center; border: 1px solid #ddd; direction: ltr; font-weight: 600; color: #2C5F8D; font-size: 0.7rem;">${formatNumber(Math.round(iqSPercent))}</td>
                    <td style="padding: 6px 4px; text-align: center; border: 1px solid #ddd; direction: ltr; font-weight: 600; color: #2C5F8D; font-size: 0.7rem;">${formatNumber(Math.round(iqGPercent))}</td>
                    <td style="padding: 6px 4px; text-align: center; border: 1px solid #ddd; direction: ltr; font-weight: 600; color: #2C5F8D; font-size: 0.7rem;">${formatNumber(Math.round(iqPPercent))}</td>
                    <td style="padding: 6px 4px; text-align: center; border: 1px solid #ddd; direction: ltr; font-weight: bold; color: #801c32; font-size: 0.85rem;">${formatNumber(netAgentPercentage)}</td>
                    <td style="padding: 6px 4px; text-align: center; border: 1px solid #ddd; position: relative; z-index: 10;">
                        <input type="number" id="deduction_${agentName.replace(/[^a-zA-Z0-9]/g, '_')}" value="${data.deductions || 0}" 
                               data-agent-name="${agentName}"
                               data-field-type="deduction"
                               style="width: 80px; padding: 4px; text-align: center; direction: ltr; font-size: 0.7rem; position: relative; z-index: 10; pointer-events: auto; cursor: text; -webkit-user-select: text; -moz-user-select: text; user-select: text; border: 1px solid #ccc; border-radius: 4px;" 
                               step="0.01" min="0" placeholder="0">
                    </td>
                    <td style="padding: 6px 4px; text-align: center; border: 1px solid #ddd; position: relative; z-index: 10;">
                        <input type="number" id="penalty_${agentName.replace(/[^a-zA-Z0-9]/g, '_')}" value="${data.penalties || 0}" 
                               data-agent-name="${agentName}"
                               data-field-type="penalty"
                               style="width: 80px; padding: 4px; text-align: center; direction: ltr; font-size: 0.7rem; position: relative; z-index: 10; pointer-events: auto; cursor: text; -webkit-user-select: text; -moz-user-select: text; user-select: text; border: 1px solid #ccc; border-radius: 4px;" 
                               step="0.01" min="0" placeholder="0">
                    </td>
                    <td style="padding: 6px 4px; text-align: center; border: 1px solid #ddd;">
                        <button class="btn btn-success" onclick="showPercentageSendOptions('${agentName}')" style="padding: 4px 8px; font-size: 0.7rem; margin-left: 3px;">Ø¥Ø±Ø³Ø§Ù„</button>
                        <button class="btn btn-info" onclick="downloadPercentagePDF('${agentName}')" style="padding: 4px 8px; font-size: 0.7rem; margin-left: 3px; background-color: #dc3545; border-color: #dc3545;">PDF</button>
                        <button class="btn btn-danger" onclick="deletePercentage('${agentName}')" style="padding: 4px 8px; font-size: 0.7rem;">Ø­Ø°Ù</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            const totalRow = document.createElement('tr');
            totalRow.style.borderTop = '3px solid #801c32';
            totalRow.style.background = '#f8f9fa';
            totalRow.style.fontWeight = 'bold';
            const totalActivationsSum = totalCountB + totalCountS + totalCountG + totalCountP;
            const totalAgentPercentageSum = Math.round(totalIQBPercent) + Math.round(totalIQSPercent) + Math.round(totalIQGPercent) + Math.round(totalIQPPercent);
            
            let totalDeductions = 0;
            let totalPenalties = 0;
            if (Array.isArray(agents) && agentPercentages) {
            agents.forEach(agentName => {
                    const data = agentPercentages[agentName] || {};
                totalDeductions += data.deductions || 0;
                totalPenalties += data.penalties || 0;
            });
            }
            const netTotalAgentPercentage = totalAgentPercentageSum - totalDeductions - totalPenalties;
            
            totalRow.innerHTML = `
                <td style="padding: 8px 6px; text-align: center; border: 1px solid #ddd; font-weight: bold; font-size: 0.8rem;">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</td>
                <td style="padding: 8px 6px; text-align: center; border: 1px solid #ddd; direction: ltr; font-weight: bold; font-size: 0.75rem;">${totalCountB}</td>
                <td style="padding: 8px 6px; text-align: center; border: 1px solid #ddd; direction: ltr; font-weight: bold; font-size: 0.75rem;">${totalCountS}</td>
                <td style="padding: 8px 6px; text-align: center; border: 1px solid #ddd; direction: ltr; font-weight: bold; font-size: 0.75rem;">${totalCountG}</td>
                <td style="padding: 8px 6px; text-align: center; border: 1px solid #ddd; direction: ltr; font-weight: bold; font-size: 0.75rem;">${totalCountP}</td>
                <td style="padding: 8px 6px; text-align: center; border: 1px solid #ddd; direction: ltr; font-weight: bold; font-size: 0.75rem;">${totalActivationsSum}</td>
                <td style="padding: 8px 6px; text-align: center; border: 1px solid #ddd; direction: ltr; font-weight: bold; font-size: 0.75rem;">${formatNumber(totalIQB)}</td>
                <td style="padding: 8px 6px; text-align: center; border: 1px solid #ddd; direction: ltr; font-weight: bold; font-size: 0.75rem;">${formatNumber(totalIQS)}</td>
                <td style="padding: 8px 6px; text-align: center; border: 1px solid #ddd; direction: ltr; font-weight: bold; font-size: 0.75rem;">${formatNumber(totalIQG)}</td>
                <td style="padding: 8px 6px; text-align: center; border: 1px solid #ddd; direction: ltr; font-weight: bold; font-size: 0.75rem;">${formatNumber(totalIQP)}</td>
                <td style="padding: 8px 6px; text-align: center; border: 1px solid #ddd; direction: ltr; font-weight: bold; font-size: 0.75rem;">${formatNumber(totalIQT)}</td>
                <td style="padding: 8px 6px; text-align: center; border: 1px solid #ddd; direction: ltr; font-weight: bold; color: #2C5F8D; font-size: 0.75rem;">${formatNumber(Math.round(totalIQBPercent))}</td>
                <td style="padding: 8px 6px; text-align: center; border: 1px solid #ddd; direction: ltr; font-weight: bold; color: #2C5F8D; font-size: 0.75rem;">${formatNumber(Math.round(totalIQSPercent))}</td>
                <td style="padding: 8px 6px; text-align: center; border: 1px solid #ddd; direction: ltr; font-weight: bold; color: #2C5F8D; font-size: 0.75rem;">${formatNumber(Math.round(totalIQGPercent))}</td>
                <td style="padding: 8px 6px; text-align: center; border: 1px solid #ddd; direction: ltr; font-weight: bold; color: #2C5F8D; font-size: 0.75rem;">${formatNumber(Math.round(totalIQPPercent))}</td>
                <td style="padding: 8px 6px; text-align: center; border: 1px solid #ddd; direction: ltr; font-weight: bold; color: #801c32; font-size: 0.9rem;">${formatNumber(netTotalAgentPercentage)}</td>
                <td style="padding: 8px 6px; text-align: center; border: 1px solid #ddd; direction: ltr; font-weight: bold; font-size: 0.75rem;">${formatNumber(totalDeductions)}</td>
                <td style="padding: 8px 6px; text-align: center; border: 1px solid #ddd; direction: ltr; font-weight: bold; font-size: 0.75rem;">${formatNumber(totalPenalties)}</td>
                <td style="padding: 8px 6px; text-align: center; border: 1px solid #ddd;"></td>
            `;
            tbody.appendChild(totalRow);
            const percentageResults = document.getElementById('percentageResults');
            if (percentageResults) {
                percentageResults.classList.remove('hidden');
            }
            setupPercentageTableEventListeners();
                        if (savedFocus) {
                setTimeout(() => {
                            const inputId = savedFocus.fieldType === 'deduction' 
                                ? `deduction_${savedFocus.agentName.replace(/[^a-zA-Z0-9]/g, '_')}`
                                : `penalty_${savedFocus.agentName.replace(/[^a-zA-Z0-9]/g, '_')}`;
                            const input = document.getElementById(inputId);
                            if (input) {
                                    try {
                                        input.value = savedFocus.value;
                            input.focus();
                                        if (input.setSelectionRange) {
                                            input.setSelectionRange(input.value.length, input.value.length);
                                        }
                                    } catch (err) {
                                    }
                            }
                }, 100);
                        }
                isRenderingTable = false;
        }
        async function exportPercentageToExcel() {
            if (!agentPercentages || Object.keys(agentPercentages).length === 0) {
                alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±. ÙŠØ±Ø¬Ù‰ ØªØ­Ù„ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆÙƒÙ„Ø§Ø¡ Ø£ÙˆÙ„Ø§Ù‹.');
                return;
            }
            try {
                const workbook = new ExcelJS.Workbook();
                const worksheet = workbook.addWorksheet('Ù†Ø³Ø¨Ø© Ø§Ù„ÙˆÙƒÙ„Ø§Ø¡');
                let totalIQT = 0, totalIQP = 0, totalIQG = 0, totalIQS = 0, totalIQB = 0;
                let totalIQPPercent = 0, totalIQGPercent = 0, totalIQSPercent = 0, totalIQBPercent = 0;
                let totalCountP = 0, totalCountG = 0, totalCountS = 0, totalCountB = 0;
                
                const headerRow1 = worksheet.addRow([
                    'Ø§Ø³Ù… Ø§Ù„ÙˆÙƒÙŠÙ„',
                    'B',
                    'S',
                    'G',
                    'P',
                    'Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ØªÙØ¹ÙŠÙ„Ø§Øª',
                    '', '', '', '', '',
                    '', '', '', '',
                    'Ù†Ø³Ø¨Ø© Ø§Ù„ÙˆÙƒÙŠÙ„ %16',
                    'Ø§Ø³ØªÙ‚Ø·Ø§Ø¹Ø§Øª',
                    'ØºØ±Ø§Ù…Ø§Øª'
                ]);
                
                const headerRow2 = worksheet.addRow([
                    '',
                    '',
                    '',
                    '',
                    '',
                    '',
                    'IQ.B', 'IQ.S', 'IQ.G', 'IQ.P', 'IQ.T',
                    'IQ.B%16', 'IQ.S%16', 'IQ.G%16', 'IQ.P%16',
                    '',
                    '',
                    ''
                ]);
                [headerRow1, headerRow2].forEach((row, rowIndex) => {
                    row.height = 25;
                    row.eachCell((cell, colNumber) => {
                        let bgColor = 'FF801C32';
                        let textColor = 'FFFFFFFF';
                        
                        if (rowIndex === 0) {
                            if (colNumber === 1) {
                                bgColor = 'FF801C32';
                                textColor = 'FFFFFFFF';
                            } else if (colNumber >= 2 && colNumber <= 5) {
                                bgColor = 'FFFFFFFF';
                                textColor = 'FF000000';
                            } else if (colNumber === 6) {
                                bgColor = 'FFFFFFFF';
                                textColor = 'FF000000';
                            } else if (colNumber >= 7 && colNumber <= 11) {
                                bgColor = 'FF801C32';
                                textColor = 'FFFFFFFF';
                            } else if (colNumber >= 12 && colNumber <= 15) {
                                bgColor = 'FF801C32';
                                textColor = 'FFFFFFFF';
                            } else if (colNumber >= 16 && colNumber <= 18) {
                                bgColor = 'FF801C32';
                                textColor = 'FFFFFFFF';
                            }
                        } else {
                            if (colNumber >= 7 && colNumber <= 11) {
                                bgColor = 'FF801C32';
                                textColor = 'FFFFFFFF';
                            } else if (colNumber >= 12 && colNumber <= 15) {
                                bgColor = 'FF801C32';
                                textColor = 'FFFFFFFF';
                            }
                        }
                        
                        cell.fill = {
                            type: 'pattern',
                            pattern: 'solid',
                            fgColor: { argb: bgColor }
                        };
                        cell.font = {
                            bold: true,
                            size: 12,
                            color: { argb: textColor }
                        };
                        cell.alignment = {
                            horizontal: 'center',
                            vertical: 'middle',
                            wrapText: true
                        };
                        cell.border = {
                            top: { style: 'medium', color: { argb: 'FF000000' } },
                            bottom: { style: 'medium', color: { argb: 'FF000000' } },
                            left: { style: 'medium', color: { argb: 'FF000000' } },
                            right: { style: 'medium', color: { argb: 'FF000000' } }
                        };
                    });
                });
                
                worksheet.mergeCells('G1:K1');
                worksheet.mergeCells('L1:O1');
                worksheet.mergeCells('P1:P2');
                worksheet.mergeCells('Q1:Q2');
                worksheet.mergeCells('R1:R2');
                const agents = Object.keys(agentPercentages).sort();
                agents.forEach(agentName => {
                    const data = agentPercentages[agentName];
                    const agent = agentsList.find(a => a.name === agentName);
                    const agentSubName = agent?.subName || '';
                    const agentDisplayName = agentSubName ? `${agentName}\n${agentSubName}` : agentName;
                    const percentage = data.percentage || 15;
                    const rate = percentage / 100;
                    const iqPPercent = data.iqPPercent !== undefined ? data.iqPPercent : ((data.iqP || 0) * rate);
                    const iqGPercent = data.iqGPercent !== undefined ? data.iqGPercent : ((data.iqG || 0) * rate);
                    const iqSPercent = data.iqSPercent !== undefined ? data.iqSPercent : ((data.iqS || 0) * rate);
                    const iqBPercent = data.iqBPercent !== undefined ? data.iqBPercent : ((data.iqB || 0) * rate);
                    const totalActivations = (data.countB || 0) + (data.countS || 0) + (data.countG || 0) + (data.countP || 0);
                    const totalAgentPercentageAmount = Math.round(iqBPercent) + Math.round(iqSPercent) + Math.round(iqGPercent) + Math.round(iqPPercent);
                    const netAgentPercentage = totalAgentPercentageAmount - (data.deductions || 0) - (data.penalties || 0);
                    
                    const row = worksheet.addRow([
                        agentDisplayName,
                        data.countB || 0,
                        data.countS || 0,
                        data.countG || 0,
                        data.countP || 0,
                        totalActivations,
                        data.iqB || 0,
                        data.iqS || 0,
                        data.iqG || 0,
                        data.iqP || 0,
                        data.iqT || 0,
                        Math.round(iqBPercent),
                        Math.round(iqSPercent),
                        Math.round(iqGPercent),
                        Math.round(iqPPercent),
                        netAgentPercentage,
                        data.deductions || 0,
                        data.penalties || 0
                    ]);
                    row.height = 20;
                    const isEvenRow = row.number % 2 === 0;
                    const bgColor = isEvenRow ? 'FFF8F9FA' : 'FFFFFFFF';
                    row.eachCell((cell, colNumber) => {
                        if (colNumber >= 2 && typeof cell.value === 'number') {
                            cell.numFmt = '#,##0';
                        }
                        
                        let fontColor = 'FF000000';
                        let fontSize = 11;
                        let isBold = false;
                        let cellBgColor = bgColor;
                        
                        if (colNumber === 1) {
                            cellBgColor = 'FF801C32';
                            fontColor = 'FFFFFFFF';
                            isBold = true;
                            cell.alignment = {
                                horizontal: 'center',
                                vertical: 'middle',
                                wrapText: true
                            };
                        } else if (colNumber >= 12 && colNumber <= 15) {
                            fontColor = 'FF2C5F8D';
                            isBold = true;
                        } else if (colNumber === 16) {
                            fontColor = 'FF801C32';
                            fontSize = 12;
                            isBold = true;
                        }
                        cell.fill = {
                            type: 'pattern',
                            pattern: 'solid',
                            fgColor: { argb: cellBgColor }
                        };
                        cell.font = {
                            size: fontSize,
                            color: { argb: fontColor },
                            bold: isBold
                        };
                        cell.alignment = {
                            horizontal: 'center',
                            vertical: 'middle'
                        };
                        cell.border = {
                            top: { style: 'thin', color: { argb: 'FFDDDDDD' } },
                            bottom: { style: 'thin', color: { argb: 'FFDDDDDD' } },
                            left: { style: 'thin', color: { argb: 'FFDDDDDD' } },
                            right: { style: 'thin', color: { argb: 'FFDDDDDD' } }
                        };
                    });
                    totalIQT += data.iqT || 0;
                    totalIQP += data.iqP || 0;
                    totalIQG += data.iqG || 0;
                    totalIQS += data.iqS || 0;
                    totalIQB += data.iqB || 0;
                    totalIQPPercent += iqPPercent;
                    totalIQGPercent += iqGPercent;
                    totalIQSPercent += iqSPercent;
                    totalIQBPercent += iqBPercent;
                    totalCountP += data.countP || 0;
                    totalCountG += data.countG || 0;
                    totalCountS += data.countS || 0;
                    totalCountB += data.countB || 0;
                });
                
                const totalActivationsSum = totalCountB + totalCountS + totalCountG + totalCountP;
                const totalAgentPercentageSum = Math.round(totalIQBPercent) + Math.round(totalIQSPercent) + Math.round(totalIQGPercent) + Math.round(totalIQPPercent);
                
                let totalDeductions = 0;
                let totalPenalties = 0;
                agents.forEach(agentName => {
                    const data = agentPercentages[agentName];
                    totalDeductions += data.deductions || 0;
                    totalPenalties += data.penalties || 0;
                });
                const netTotalAgentPercentage = totalAgentPercentageSum - totalDeductions - totalPenalties;
                
                const totalRow = worksheet.addRow([
                    'Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹',
                    totalCountB,
                    totalCountS,
                    totalCountG,
                    totalCountP,
                    totalActivationsSum,
                    totalIQB,
                    totalIQS,
                    totalIQG,
                    totalIQP,
                    totalIQT,
                    Math.round(totalIQBPercent),
                    Math.round(totalIQSPercent),
                    Math.round(totalIQGPercent),
                    Math.round(totalIQPPercent),
                    netTotalAgentPercentage,
                    totalDeductions,
                    totalPenalties
                ]);
                totalRow.height = 25;
                totalRow.eachCell((cell, colNumber) => {
                    if (colNumber >= 2 && typeof cell.value === 'number') {
                        cell.numFmt = '#,##0';
                    }
                    let fontColor = 'FF000000';
                    let fontSize = 12;
                    cell.fill = {
                        type: 'pattern',
                        pattern: 'solid',
                        fgColor: { argb: 'FFF8F9FA' }
                    };
                    cell.font = {
                        bold: true,
                        size: fontSize,
                        color: { argb: fontColor }
                    };
                    cell.alignment = {
                        horizontal: 'center',
                        vertical: 'middle'
                    };
                    cell.border = {
                        top: { style: 'thick', color: { argb: 'FF801C32' } },
                        bottom: { style: 'medium', color: { argb: 'FF000000' } },
                        left: { style: 'thin', color: { argb: 'FFDDDDDD' } },
                        right: { style: 'thin', color: { argb: 'FFDDDDDD' } }
                    };
                });
                worksheet.columns = [
                    { width: 25 },
                    { width: 10 },
                    { width: 10 },
                    { width: 10 },
                    { width: 10 },
                    { width: 15 },
                    { width: 15 },
                    { width: 15 },
                    { width: 15 },
                    { width: 15 },
                    { width: 15 },
                    { width: 15 },
                    { width: 15 },
                    { width: 15 },
                    { width: 15 },
                    { width: 18 },
                    { width: 12 },
                    { width: 12 }
                ];
                const now = new Date();
                const dateStr = `${now.getDate()}_${now.getMonth() + 1}_${now.getFullYear()}`;
                const filename = `Ù†Ø³Ø¨Ø©_Ø§Ù„ÙˆÙƒÙ„Ø§Ø¡_${dateStr}.xlsx`;
                const buffer = await workbook.xlsx.writeBuffer();
                const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                ""
                const url = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = filename;
                link.click();
                window.URL.revokeObjectURL(url);
                showSuccessMessage(`ØªÙ… ØªØµØ¯ÙŠØ± Ø¨ÙŠØ§Ù†Ø§Øª ${agents.length} ÙˆÙƒÙŠÙ„ Ø¥Ù„Ù‰ Ù…Ù„Ù Excel Ø¨Ù†Ø¬Ø§Ø­!`);
                logActivity('ØªØµØ¯ÙŠØ± Ù†Ø³Ø¨Ø© Ø§Ù„ÙˆÙƒÙ„Ø§Ø¡', `ØªÙ… ØªØµØ¯ÙŠØ± Ø¨ÙŠØ§Ù†Ø§Øª ${agents.length} ÙˆÙƒÙŠÙ„ Ø¥Ù„Ù‰ Excel`);
            } catch (error) {
                console.error('Error exporting to Excel:', error);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØµØ¯ÙŠØ±: ' + error.message);
            }
        }
        function updateDeduction(agentName, value, skipRender = false) {
            if (!agentPercentages[agentName]) return;
            const deduction = parseFloat(value) || 0;
            agentPercentages[agentName].deductions = deduction;
            
            const data = agentPercentages[agentName];
            const percentage = data.percentage || 15;
            const rate = percentage / 100;
            const iqPPercent = data.iqPPercent !== undefined ? data.iqPPercent : ((data.iqP || 0) * rate);
            const iqGPercent = data.iqGPercent !== undefined ? data.iqGPercent : ((data.iqG || 0) * rate);
            const iqSPercent = data.iqSPercent !== undefined ? data.iqSPercent : ((data.iqS || 0) * rate);
            const iqBPercent = data.iqBPercent !== undefined ? data.iqBPercent : ((data.iqB || 0) * rate);
            const agentPercentageAmount = data.agentPercentageAmount || (Math.round(iqBPercent) + Math.round(iqSPercent) + Math.round(iqGPercent) + Math.round(iqPPercent));
            
            if (!data.agentPercentageAmount) {
                agentPercentages[agentName].agentPercentageAmount = agentPercentageAmount;
            }
            
            agentPercentages[agentName].netPercentage = agentPercentageAmount - 
                deduction - (agentPercentages[agentName].penalties || 0);
            localStorage.setItem('agentPercentages', JSON.stringify(agentPercentages));
            if (supabaseClient && !skipRender) {
                const savedMonthYear = localStorage.getItem('agentPercentages_monthYear') || getCurrentMonthYear();
                saveToDatabase('agent_percentages', agentPercentages, { monthYear: savedMonthYear })
                    .then(saved => {
                        if (saved) {
                        }
                    })
                    .catch(err => console.error('Error saving deduction to database:', err));
            }
            if (!skipRender) {
                lastPercentageDataHash = '';
                loadPercentageData();
                logActivity('ØªØ­Ø¯ÙŠØ« Ø§Ø³ØªÙ‚Ø·Ø§Ø¹', `ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø§Ø³ØªÙ‚Ø·Ø§Ø¹ Ù„Ù„ÙˆÙƒÙŠÙ„ ${agentName}: ${formatNumber(deduction)}`);
            }
        }
        function updatePenalty(agentName, value, skipRender = false) {
            if (!agentPercentages[agentName]) return;
            const penalty = parseFloat(value) || 0;
            agentPercentages[agentName].penalties = penalty;
            
            const data = agentPercentages[agentName];
            const percentage = data.percentage || 15;
            const rate = percentage / 100;
            const iqPPercent = data.iqPPercent !== undefined ? data.iqPPercent : ((data.iqP || 0) * rate);
            const iqGPercent = data.iqGPercent !== undefined ? data.iqGPercent : ((data.iqG || 0) * rate);
            const iqSPercent = data.iqSPercent !== undefined ? data.iqSPercent : ((data.iqS || 0) * rate);
            const iqBPercent = data.iqBPercent !== undefined ? data.iqBPercent : ((data.iqB || 0) * rate);
            const agentPercentageAmount = data.agentPercentageAmount || (Math.round(iqBPercent) + Math.round(iqSPercent) + Math.round(iqGPercent) + Math.round(iqPPercent));
            
            if (!data.agentPercentageAmount) {
                agentPercentages[agentName].agentPercentageAmount = agentPercentageAmount;
            }
            
            agentPercentages[agentName].netPercentage = agentPercentageAmount - 
                (agentPercentages[agentName].deductions || 0) - penalty;
            localStorage.setItem('agentPercentages', JSON.stringify(agentPercentages));
            if (supabaseClient && !skipRender) {
                const savedMonthYear = localStorage.getItem('agentPercentages_monthYear') || getCurrentMonthYear();
                saveToDatabase('agent_percentages', agentPercentages, { monthYear: savedMonthYear })
                    .then(saved => {
                        if (saved) {
                        }
                    })
                    .catch(err => console.error('Error saving penalty to database:', err));
            }
            if (!skipRender) {
                lastPercentageDataHash = '';
                loadPercentageData();
                logActivity('ØªØ­Ø¯ÙŠØ« ØºØ±Ø§Ù…Ø©', `ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ØºØ±Ø§Ù…Ø© Ù„Ù„ÙˆÙƒÙŠÙ„ ${agentName}: ${formatNumber(penalty)}`);
            }
        }
        async function deletePercentage(agentName) {
            if (confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø³Ø¨Ø© Ø§Ù„ÙˆÙƒÙŠÙ„ "${agentName}"ØŸ`)) {
                delete agentPercentages[agentName];
                localStorage.setItem('agentPercentages', JSON.stringify(agentPercentages));
                lastPercentageDataHash = '';
                if (supabaseClient) {
                    try {
                        const savedMonthYear = localStorage.getItem('agentPercentages_monthYear') || getCurrentMonthYear();
                        const saved = await saveToDatabase('agent_percentages', agentPercentages, { monthYear: savedMonthYear });
                        if (saved) {
                        }
                    } catch (error) {
                        console.error('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
                    }
                }
                renderPercentageTable();
                logActivity('Ø­Ø°Ù Ù†Ø³Ø¨Ø© ÙˆÙƒÙŠÙ„', `ØªÙ… Ø­Ø°Ù Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø³Ø¨Ø© Ø§Ù„ÙˆÙƒÙŠÙ„: ${agentName}`);
            }
        }
        async function updateAgentPhone(agentName, phone) {
            if (!agentPercentages[agentName]) return;
            agentPercentages[agentName].phone = phone || '';
            const agent = agentsList.find(a => a.name === agentName);
            if (agent) {
                agent.phone = phone || '';
                localStorage.setItem('agentsList', JSON.stringify(agentsList));
                try {
                    const saved = await saveAgentsToDatabase();
                    if (saved) {
                    } else {
                    }
                } catch (err) {
                    console.error('Error saving agent phone to database:', err);
                }
            }
            localStorage.setItem('agentPercentages', JSON.stringify(agentPercentages));
            logActivity('ØªØ­Ø¯ÙŠØ« Ø±Ù‚Ù… Ù‡Ø§ØªÙ ÙˆÙƒÙŠÙ„', `ØªÙ… ØªØ­Ø¯ÙŠØ« Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ù„Ù„ÙˆÙƒÙŠÙ„ ${agentName}: ${phone}`);
            showSuccessMessage(`ØªÙ… ØªØ­Ø¯ÙŠØ« Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ù„Ù„ÙˆÙƒÙŠÙ„: ${agentName}`);
        }
        function showPercentageSendOptions(agentName) {
            if (!agentName) {
                alert('Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ø³Ù… Ø§Ù„ÙˆÙƒÙŠÙ„');
                return;
            }
            const modal = document.getElementById('percentageSendOptionsModal');
            const agentNameSpan = document.getElementById('percentageSendAgentName');
            if (!modal || !agentNameSpan) {
                alert('Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù†Ø§ÙØ°Ø©');
                return;
            }
            let agent = agentsList.find(a => a.name === agentName);
            if (!agent) {
                const percentageData = agentPercentages[agentName];
                if (percentageData && (percentageData.phone || percentageData.email)) {
                    agent = {
                        name: agentName,
                        phone: percentageData.phone || '',
                        email: percentageData.email || ''
                    };
                } else {
                    alert('Ø§Ù„ÙˆÙƒÙŠÙ„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©. ÙŠØ±Ø¬Ù‰ Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙˆÙƒÙŠÙ„ ÙÙŠ ØªØ¨ÙˆÙŠØ¨ "Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙˆÙƒÙ„Ø§Ø¡" ÙˆØ¥Ø¶Ø§ÙØ© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„.');
                    return;
                }
            }
            const phone = agentPercentages[agentName]?.phone || agent?.phone;
            const email = agentPercentages[agentName]?.email || agent?.email;
            if (!phone && !email) {
                alert('Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø±Ù‚Ù… Ù‡Ø§ØªÙ Ø£Ùˆ Ø¨Ø±ÙŠØ¯ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù„Ù„ÙˆÙƒÙŠÙ„. ÙŠØ±Ø¬Ù‰ Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„ ÙÙŠ ØªØ¨ÙˆÙŠØ¨ "Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙˆÙƒÙ„Ø§Ø¡"');
                return;
            }
            agentNameSpan.textContent = agentName;
            modal.setAttribute('data-agent-name', agentName);
            modal.classList.add('show');
        }
        function closePercentageSendOptions() {
            const modal = document.getElementById('percentageSendOptionsModal');
            if (modal) {
                modal.classList.remove('show');
            }
        }
        function sendPercentageReportViaWhatsApp() {
            const modal = document.getElementById('percentageSendOptionsModal');
            if (!modal) {
                alert('Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„');
                return;
            }
            const agentName = modal.getAttribute('data-agent-name');
            if (!agentName) {
                alert('Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ø³Ù… Ø§Ù„ÙˆÙƒÙŠÙ„');
                return;
            }
            closePercentageSendOptions();
            sendPercentageReport(agentName, 'ÙˆØ§ØªØ³Ø§Ø¨');
        }
        function sendPercentageReportViaEmail() {
            const modal = document.getElementById('percentageSendOptionsModal');
            if (!modal) {
                alert('Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„');
                return;
            }
            const agentName = modal.getAttribute('data-agent-name');
            if (!agentName) {
                alert('Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ø³Ù… Ø§Ù„ÙˆÙƒÙŠÙ„');
                return;
            }
            closePercentageSendOptions();
            sendPercentageReport(agentName, 'email');
        }
        function sendPercentageReport(agentName, method = 'ÙˆØ§ØªØ³Ø§Ø¨') {
            let agent = agentsList.find(a => a.name === agentName);
            if (!agent) {
                const percentageData = agentPercentages[agentName];
                if (percentageData && (percentageData.phone || percentageData.email)) {
                    agent = {
                        name: agentName,
                        phone: percentageData.phone || '',
                        email: percentageData.email || ''
                    };
                } else {
                    alert('Ø§Ù„ÙˆÙƒÙŠÙ„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©. ÙŠØ±Ø¬Ù‰ Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙˆÙƒÙŠÙ„ ÙÙŠ ØªØ¨ÙˆÙŠØ¨ "Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙˆÙƒÙ„Ø§Ø¡" ÙˆØ¥Ø¶Ø§ÙØ© Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ.');
                    return;
                }
            }
            if (agent && agentPercentages[agentName]) {
                if (agent.phone) {
                    agentPercentages[agentName].phone = agent.phone;
                }
                if (agent.email) {
                    agentPercentages[agentName].email = agent.email;
                }
                localStorage.setItem('agentPercentages', JSON.stringify(agentPercentages));
            }
            const phone = agentPercentages[agentName]?.phone || agent?.phone;
            const email = agentPercentages[agentName]?.email || agent?.email;
            const data = agentPercentages[agentName];
            if (!data) {
                alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ÙˆÙƒÙŠÙ„');
                return;
            }
            if (method === 'ÙˆØ§ØªØ³Ø§Ø¨' && !phone) {
                alert('Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø±Ù‚Ù… Ù‡Ø§ØªÙ Ù„Ù„ÙˆÙƒÙŠÙ„. ÙŠØ±Ø¬Ù‰ Ø¥Ø¶Ø§ÙØ© Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ÙÙŠ ØªØ¨ÙˆÙŠØ¨ "Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙˆÙƒÙ„Ø§Ø¡"');
                return;
            }
            if (method === 'email' && !email) {
                alert('Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø¨Ø±ÙŠØ¯ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù„Ù„ÙˆÙƒÙŠÙ„. ÙŠØ±Ø¬Ù‰ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ÙÙŠ ØªØ¨ÙˆÙŠØ¨ "Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙˆÙƒÙ„Ø§Ø¡"');
                return;
            }
            let message = `*${agentName}*\n\n`;
            message += `ØªØ­ÙŠØ© Ø·ÙŠØ¨Ø© \n\n`;
            message += `Ù†ÙˆØ¯ Ø¥Ø¹Ù„Ø§Ù…ÙƒÙ… Ø¨Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø®Ø§Øµ Ø¨Ù†Ø³Ø¨Ø© Ø§Ù„ÙˆÙƒÙŠÙ„ØŒ ÙˆÙƒÙ…Ø§ ÙŠÙ„ÙŠ:\n\n`;
            message += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
            const percentage = data.percentage || 15;
            const rate = percentage / 100;
            const iqPPercent = data.iqPPercent !== undefined ? data.iqPPercent : ((data.iqP || 0) * rate);
            const iqGPercent = data.iqGPercent !== undefined ? data.iqGPercent : ((data.iqG || 0) * rate);
            const iqSPercent = data.iqSPercent !== undefined ? data.iqSPercent : ((data.iqS || 0) * rate);
            const iqBPercent = data.iqBPercent !== undefined ? data.iqBPercent : ((data.iqB || 0) * rate);
            message += `*Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„ØµØ§ÙÙŠØ©: ${formatNumberEnglish(data.netPercentage || 0)} Ø¯ÙŠÙ†Ø§Ø± Ø¹Ø±Ø§Ù‚ÙŠ*\n`;
            if ((data.deductions || 0) > 0) {
                message += `*Ø§Ù„Ø§Ø³ØªÙ‚Ø·Ø§Ø¹Ø§Øª: ${formatNumberEnglish(data.deductions || 0)} Ø¯ÙŠÙ†Ø§Ø± Ø¹Ø±Ø§Ù‚ÙŠ*\n`;
            }
            if ((data.penalties || 0) > 0) {
                message += `*Ø§Ù„ØºØ±Ø§Ù…Ø§Øª: ${formatNumberEnglish(data.penalties || 0)} Ø¯ÙŠÙ†Ø§Ø± Ø¹Ø±Ø§Ù‚ÙŠ*\n`;
            }
            message += `\n`;
            message += `\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
            message += `ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªÙØ¶Ù„ Ø¨Ø§Ù„Ø§Ø·Ù„Ø§Ø¹ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø±ÙÙ‚ Ù„Ù„Ø§Ø·Ù„Ø§Ø¹ Ø¹Ù„Ù‰ Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙƒØ§Ù…Ù„Ø©.\n\n`;
            message += `Ù…Ø¹ ÙØ§Ø¦Ù‚ Ø§Ù„Ø´ÙƒØ± ÙˆØ§Ù„ØªÙ‚Ø¯ÙŠØ±ØŒ\n`;
            message += `*Ø´Ø±ÙƒØ© Ø¹Ø±Ø§Ù‚ Ø³ÙŠÙ„ Ù„Ù„Ø¥ØªØµØ§Ù„Ø§Øª*`;
            generatePercentageExcelReport(agentName).then((excelBlob) => {
                const filename = `ØªÙ‚Ø±ÙŠØ±_Ù†Ø³Ø¨Ø©_${agentName}_${formatDateForFilename(new Date())}.xlsx`;
                downloadFile(excelBlob, filename);
                if (method === 'ÙˆØ§ØªØ³Ø§Ø¨') {
                    const formattedPhone = formatPhoneForWhatsApp(phone);
                    const whatsappUrl = `https://wa.me/${formattedPhone}?text=${encodeURIComponent(message)}`;
                    window.open(whatsappUrl, '_blank');
                    logActivity('Ø¥Ø±Ø³Ø§Ù„ ØªÙ‚Ø±ÙŠØ± Ù†Ø³Ø¨Ø© ÙˆÙƒÙŠÙ„ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨', `ØªÙ… Ø¥Ø±Ø³Ø§Ù„ ØªÙ‚Ø±ÙŠØ± Ù†Ø³Ø¨Ø© Ø§Ù„ÙˆÙƒÙŠÙ„: ${agentName}`);
                    showSuccessMessage(`ØªÙ… Ø¥Ø±Ø³Ø§Ù„ ØªÙ‚Ø±ÙŠØ± Ù†Ø³Ø¨Ø© Ø§Ù„ÙˆÙƒÙŠÙ„ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨: ${agentName}`);
                } else if (method === 'email') {
                    const subject = encodeURIComponent(`ØªÙ‚Ø±ÙŠØ± Ù†Ø³Ø¨Ø© Ø§Ù„ÙˆÙƒÙŠÙ„ - ${agentName}`);
                    const body = encodeURIComponent(message.replace(/\*/g, ''));
                    const mailtoUrl = `mailto:${email}?subject=${subject}&body=${body}`;
                    window.open(mailtoUrl, '_blank');
                    logActivity('Ø¥Ø±Ø³Ø§Ù„ ØªÙ‚Ø±ÙŠØ± Ù†Ø³Ø¨Ø© ÙˆÙƒÙŠÙ„ Ø¹Ø¨Ø± Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ', `ØªÙ… Ø¥Ø±Ø³Ø§Ù„ ØªÙ‚Ø±ÙŠØ± Ù†Ø³Ø¨Ø© Ø§Ù„ÙˆÙƒÙŠÙ„: ${agentName}`);
                    showSuccessMessage(`ØªÙ… ÙØªØ­ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù„Ø¥Ø±Ø³Ø§Ù„ ØªÙ‚Ø±ÙŠØ± Ù†Ø³Ø¨Ø© Ø§Ù„ÙˆÙƒÙŠÙ„: ${agentName}`);
                }
            }).catch((error) => {
                console.error('Error generating Excel:', error);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Excel. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
            });
        }
        function generatePercentageExcelReport(agentName) {
            return new Promise(async (resolve, reject) => {
                try {
                    const data = agentPercentages[agentName];
                    if (!data) {
                        reject(new Error('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ÙˆÙƒÙŠÙ„'));
                        return;
                    }
                    const agent = agentsList.find(a => a.name === agentName);
                    const ExcelJS = window.ExcelJS;
                    if (!ExcelJS) {
                        reject(new Error('ExcelJS ØºÙŠØ± Ù…ØªÙˆÙØ±'));
                        return;
                    }
                    const workbook = new ExcelJS.Workbook();
                    const worksheet = workbook.addWorksheet('ØªÙ‚Ø±ÙŠØ± Ù†Ø³Ø¨Ø© Ø§Ù„ÙˆÙƒÙŠÙ„');
                    worksheet.columns = [
                        { width: 30, key: 'type' },
                        { width: 20, key: 'count' },
                        { width: 20, key: 'amount' },
                        { width: 20, key: 'percentage' }
                    ];
                    let currentRow = 1;
                    const titleRow = worksheet.getRow(currentRow);
                    titleRow.getCell(1).value = 'ØªÙ‚Ø±ÙŠØ± Ù†Ø³Ø¨Ø© Ø§Ù„ÙˆÙƒÙŠÙ„';
                    titleRow.getCell(1).font = { bold: true, size: 18, color: { argb: 'FF801C32' } };
                    titleRow.getCell(1).alignment = { horizontal: 'center', vertical: 'middle' };
                    worksheet.mergeCells(currentRow, 1, currentRow, 4);
                    titleRow.height = 30;
                    currentRow++;
                    currentRow++;
                    worksheet.getRow(currentRow).getCell(1).value = `Ø§Ø³Ù… Ø§Ù„ÙˆÙƒÙŠÙ„: ${agentName}`;
                    worksheet.getRow(currentRow).getCell(1).font = { bold: true, size: 12 };
                    currentRow++;
                    if (agent?.email) {
                        worksheet.getRow(currentRow).getCell(1).value = `Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ: ${agent.email}`;
                        worksheet.getRow(currentRow).getCell(1).font = { size: 12 };
                        currentRow++;
                    }
                    if (agent?.phone) {
                        worksheet.getRow(currentRow).getCell(1).value = `Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ: ${agent.phone}`;
                        worksheet.getRow(currentRow).getCell(1).font = { size: 12 };
                        currentRow++;
                    }
                    currentRow++;
                    const percentage = data.percentage || 15;
                    const rate = percentage / 100;
                    currentRow++;
                    const sectionRow = worksheet.getRow(currentRow);
                    sectionRow.getCell(1).value = 'ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª';
                    sectionRow.getCell(1).font = { bold: true, size: 14, color: { argb: 'FF801C32' } };
                    sectionRow.getCell(1).fill = {
                        type: 'pattern',
                        pattern: 'solid',
                        fgColor: { argb: 'FFF8F9FA' }
                    };
                    sectionRow.getCell(1).alignment = { horizontal: 'right', vertical: 'middle' };
                    sectionRow.getCell(1).border = {
                        top: { style: 'thin', color: { argb: 'FF801C32' } },
                        bottom: { style: 'thin', color: { argb: 'FF801C32' } },
                        left: { style: 'thin', color: { argb: 'FF801C32' } },
                        right: { style: 'thin', color: { argb: 'FF801C32' } }
                    };
                    worksheet.mergeCells(currentRow, 1, currentRow, 4);
                    sectionRow.height = 25;
                    currentRow++;
                    const headerRow = worksheet.getRow(currentRow);
                    const headers = ['Ù†ÙˆØ¹ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ', 'Ø¹Ø¯Ø¯ Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª', 'Ø§Ù„Ù…Ø¨Ù„Øº (Ø¯.Ø¹)', 'Ù†Ø³Ø¨Ø© Ø§Ù„ÙˆÙƒÙŠÙ„ (Ø¯.Ø¹)'];
                    headers.forEach((header, idx) => {
                        const cell = headerRow.getCell(idx + 1);
                        cell.value = header;
                        cell.font = { bold: true, size: 12, color: { argb: 'FFFFFFFF' } };
                        cell.fill = {
                            type: 'pattern',
                            pattern: 'solid',
                            fgColor: { argb: 'FF801C32' }
                        };
                        cell.alignment = { horizontal: 'center', vertical: 'middle', wrapText: true };
                        cell.border = {
                            top: { style: 'thin', color: { argb: 'FFFFFFFF' } },
                            bottom: { style: 'thin', color: { argb: 'FFFFFFFF' } },
                            left: { style: 'thin', color: { argb: 'FFFFFFFF' } },
                            right: { style: 'thin', color: { argb: 'FFFFFFFF' } }
                        };
                    });
                    headerRow.height = 25;
                    currentRow++;
                    const categories = [
                        { key: 'platinum', name: 'Platinum', count: data.countP || 0, amount: data.iqP || 0 },
                        { key: 'gold', name: 'Gold', count: data.countG || 0, amount: data.iqG || 0 },
                        { key: 'silver', name: 'Silver', count: data.countS || 0, amount: data.iqS || 0 },
                        { key: 'bronze', name: 'Bronze', count: data.countB || 0, amount: data.iqB || 0 }
                    ];
                    categories.forEach((cat, index) => {
                        const iqPPercent = cat.key === 'platinum' ? (data.iqPPercent !== undefined ? data.iqPPercent : ((data.iqP || 0) * rate)) :
                                          cat.key === 'gold' ? (data.iqGPercent !== undefined ? data.iqGPercent : ((data.iqG || 0) * rate)) :
                                          cat.key === 'silver' ? (data.iqSPercent !== undefined ? data.iqSPercent : ((data.iqS || 0) * rate)) :
                                          (data.iqBPercent !== undefined ? data.iqBPercent : ((data.iqB || 0) * rate));
                        const dataRow = worksheet.getRow(currentRow);
                        const isEven = index % 2 === 0;
                        const bgColor = isEven ? 'FFFFFFFF' : 'FFF8F9FA';
                        dataRow.getCell(1).value = cat.name;
                        dataRow.getCell(2).value = formatNumberEnglish(cat.count);
                        dataRow.getCell(3).value = formatNumberEnglish(cat.amount);
                        dataRow.getCell(4).value = formatNumberEnglish(Math.round(iqPPercent));
                        for (let col = 1; col <= 4; col++) {
                            const cell = dataRow.getCell(col);
                            cell.font = { size: 12 };
                            cell.fill = {
                                type: 'pattern',
                                pattern: 'solid',
                                fgColor: { argb: bgColor }
                            };
                            cell.alignment = col === 1 ? 
                                { horizontal: 'right', vertical: 'middle' } : 
                                { horizontal: 'center', vertical: 'middle' };
                            cell.border = {
                                top: { style: 'thin', color: { argb: 'FFDDDDDD' } },
                                bottom: { style: 'thin', color: { argb: 'FFDDDDDD' } },
                                left: { style: 'thin', color: { argb: 'FFDDDDDD' } },
                                right: { style: 'thin', color: { argb: 'FFDDDDDD' } }
                            };
                        }
                        dataRow.height = 22;
                        currentRow++;
                    });
                    const totalDataRow = worksheet.getRow(currentRow);
                    const totalCount = (data.countP || 0) + (data.countG || 0) + (data.countS || 0) + (data.countB || 0);
                    const totalAmount = (data.iqP || 0) + (data.iqG || 0) + (data.iqS || 0) + (data.iqB || 0);
                    const totalPercent = Math.round((data.iqPPercent !== undefined ? data.iqPPercent : ((data.iqP || 0) * rate)) +
                                                   (data.iqGPercent !== undefined ? data.iqGPercent : ((data.iqG || 0) * rate)) +
                                                   (data.iqSPercent !== undefined ? data.iqSPercent : ((data.iqS || 0) * rate)) +
                                                   (data.iqBPercent !== undefined ? data.iqBPercent : ((data.iqB || 0) * rate)));
                    totalDataRow.getCell(1).value = 'Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹';
                    totalDataRow.getCell(2).value = formatNumberEnglish(totalCount);
                    totalDataRow.getCell(3).value = formatNumberEnglish(totalAmount);
                    totalDataRow.getCell(4).value = formatNumberEnglish(totalPercent);
                    for (let col = 1; col <= 4; col++) {
                        const cell = totalDataRow.getCell(col);
                        cell.font = { bold: true, size: 12 };
                        cell.fill = {
                            type: 'pattern',
                            pattern: 'solid',
                            fgColor: { argb: 'FFE8F0F5' }
                        };
                        cell.alignment = col === 1 ? 
                            { horizontal: 'right', vertical: 'middle' } : 
                            { horizontal: 'center', vertical: 'middle' };
                        cell.border = {
                            top: { style: 'medium', color: { argb: 'FF801C32' } },
                            bottom: { style: 'medium', color: { argb: 'FF801C32' } },
                            left: { style: 'medium', color: { argb: 'FF801C32' } },
                            right: { style: 'medium', color: { argb: 'FF801C32' } }
                        };
                    }
                    totalDataRow.height = 25;
                    currentRow++;
                    currentRow++;
                    const summaryRow = worksheet.getRow(currentRow);
                    summaryRow.getCell(1).value = 'Ù†Ø³Ø¨Ø© Ø§Ù„ÙˆÙƒÙŠÙ„';
                    summaryRow.getCell(4).value = formatNumberEnglish(data.agentPercentageAmount || 0);
                    summaryRow.getCell(1).font = { bold: true, size: 12 };
                    summaryRow.getCell(4).font = { bold: true, size: 12 };
                    summaryRow.getCell(4).alignment = { horizontal: 'center' };
                    currentRow++;
                    if ((data.deductions || 0) > 0) {
                        const deductionRow = worksheet.getRow(currentRow);
                        deductionRow.getCell(1).value = 'Ø§Ù„Ø§Ø³ØªÙ‚Ø·Ø§Ø¹Ø§Øª';
                        deductionRow.getCell(4).value = formatNumberEnglish(data.deductions || 0);
                        deductionRow.getCell(1).font = { bold: true, size: 12 };
                        deductionRow.getCell(4).font = { bold: true, size: 12 };
                        deductionRow.getCell(4).alignment = { horizontal: 'center' };
                        currentRow++;
                    }
                    if ((data.penalties || 0) > 0) {
                        const penaltyRow = worksheet.getRow(currentRow);
                        penaltyRow.getCell(1).value = 'Ø§Ù„ØºØ±Ø§Ù…Ø§Øª';
                        penaltyRow.getCell(4).value = formatNumberEnglish(data.penalties || 0);
                        penaltyRow.getCell(1).font = { bold: true, size: 12 };
                        penaltyRow.getCell(4).font = { bold: true, size: 12 };
                        penaltyRow.getCell(4).alignment = { horizontal: 'center' };
                        currentRow++;
                    }
                    const netRow = worksheet.getRow(currentRow);
                    netRow.getCell(1).value = 'Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„ØµØ§ÙÙŠØ©';
                    netRow.getCell(4).value = formatNumberEnglish(data.netPercentage || 0);
                    netRow.getCell(1).font = { bold: true, size: 14, color: { argb: 'FF801C32' } };
                    netRow.getCell(4).font = { bold: true, size: 14, color: { argb: 'FF801C32' } };
                    netRow.getCell(4).alignment = { horizontal: 'center' };
                    netRow.getCell(1).fill = {
                        type: 'pattern',
                        pattern: 'solid',
                        fgColor: { argb: 'FFE8F0F5' }
                    };
                    netRow.getCell(4).fill = {
                        type: 'pattern',
                        pattern: 'solid',
                        fgColor: { argb: 'FFE8F0F5' }
                    };
                    netRow.getCell(1).border = {
                        top: { style: 'medium', color: { argb: 'FF801C32' } },
                        bottom: { style: 'medium', color: { argb: 'FF801C32' } },
                        left: { style: 'medium', color: { argb: 'FF801C32' } },
                        right: { style: 'thin', color: { argb: 'FF801C32' } }
                    };
                    netRow.getCell(4).border = {
                        top: { style: 'medium', color: { argb: 'FF801C32' } },
                        bottom: { style: 'medium', color: { argb: 'FF801C32' } },
                        left: { style: 'thin', color: { argb: 'FF801C32' } },
                        right: { style: 'medium', color: { argb: 'FF801C32' } }
                    };
                    netRow.height = 30;
                    const buffer = await workbook.xlsx.writeBuffer();
                    const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                    resolve(blob);
                } catch (error) {
                    reject(error);
                }
            });
        }
        function downloadPercentagePDF(agentName) {
            generatePercentagePDFReport(agentName).then((pdfBlob) => {
                const safeName = agentName.replace(/[^a-zA-Z0-9_]/g, '_');
                const filename = `ØªÙ‚Ø±ÙŠØ±_Ù†Ø³Ø¨Ø©_${safeName}_${formatDateForFilename(new Date())}.pdf`;
                downloadFile(pdfBlob, filename);
                logActivity('ØªØ­Ù…ÙŠÙ„ ØªÙ‚Ø±ÙŠØ± Ù†Ø³Ø¨Ø© PDF', `ØªÙ… ØªØ­Ù…ÙŠÙ„ ØªÙ‚Ø±ÙŠØ± Ù†Ø³Ø¨Ø© PDF Ù„Ù„ÙˆÙƒÙŠÙ„: ${agentName}`);
                showSuccessMessage(`ØªÙ… ØªØ­Ù…ÙŠÙ„ ØªÙ‚Ø±ÙŠØ± PDF Ù„Ù„ÙˆÙƒÙŠÙ„: ${agentName}`);
            }).catch((error) => {
                console.error('Error generating PDF:', error);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù PDF. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
            });
        }
        function generatePercentagePDFReport(agentName) {
            return new Promise(async (resolve, reject) => {
                try {
                    const data = agentPercentages[agentName];
                    if (!data) {
                        reject(new Error('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ÙˆÙƒÙŠÙ„'));
                        return;
                    }
                    const { jsPDF } = window.jspdf;
                    if (!jsPDF) {
                        reject(new Error('jsPDF ØºÙŠØ± Ù…ØªÙˆÙØ±'));
                        return;
                    }
                    const doc = new jsPDF('portrait', 'mm', 'a4');
                    const pageWidth = doc.internal.pageSize.getWidth();
                    const pageHeight = doc.internal.pageSize.getHeight();
                    let yPos = 15;
                    doc.setFontSize(18);
                    doc.setTextColor(128, 28, 50);
                    doc.setFont('helvetica', 'bold');
                    const titleText = 'Agent Percentage Report';
                    const titleWidth = doc.getTextWidth(titleText);
                    doc.text(titleText, (pageWidth - titleWidth) / 2, yPos);
                    yPos += 15;
                    const agent = agentsList.find(a => a.name === agentName);
                    doc.setFontSize(12);
                    doc.setTextColor(0, 0, 0);
                    doc.setFont('helvetica', 'bold');
                    doc.text(`Agent Name: ${agentName}`, 20, yPos);
                    yPos += 8;
                    if (agent?.email) {
                        doc.setFont('helvetica', 'normal');
                        doc.setFontSize(12);
                        doc.text(`Email: ${agent.email}`, 20, yPos);
                        yPos += 7;
                    }
                    if (agent?.phone) {
                        doc.text(`Phone Number: ${agent.phone}`, 20, yPos);
                        yPos += 7;
                    }
                    yPos += 5;
                    const percentage = data.percentage || 15;
                    const rate = percentage / 100;
                    const iqPPercent = data.iqPPercent !== undefined ? data.iqPPercent : ((data.iqP || 0) * rate);
                    const iqGPercent = data.iqGPercent !== undefined ? data.iqGPercent : ((data.iqG || 0) * rate);
                    const iqSPercent = data.iqSPercent !== undefined ? data.iqSPercent : ((data.iqS || 0) * rate);
                    const iqBPercent = data.iqBPercent !== undefined ? data.iqBPercent : ((data.iqB || 0) * rate);
                    const tableData = [
                        ['Platinum', formatNumberEnglish(data.countP || 0), formatNumberEnglish(data.iqP || 0), formatNumberEnglish(Math.round(iqPPercent))],
                        ['Gold', formatNumberEnglish(data.countG || 0), formatNumberEnglish(data.iqG || 0), formatNumberEnglish(Math.round(iqGPercent))],
                        ['Silver', formatNumberEnglish(data.countS || 0), formatNumberEnglish(data.iqS || 0), formatNumberEnglish(Math.round(iqSPercent))],
                        ['Bronze', formatNumberEnglish(data.countB || 0), formatNumberEnglish(data.iqB || 0), formatNumberEnglish(Math.round(iqBPercent))],
                    ];
                    const totalCount = (data.countP || 0) + (data.countG || 0) + (data.countS || 0) + (data.countB || 0);
                    const totalAmount = (data.iqP || 0) + (data.iqG || 0) + (data.iqS || 0) + (data.iqB || 0);
                    const totalPercent = Math.round(iqPPercent + iqGPercent + iqSPercent + iqBPercent);
                    tableData.push([
                        'Total',
                        formatNumberEnglish(totalCount),
                        formatNumberEnglish(totalAmount),
                        formatNumberEnglish(totalPercent)
                    ]);
                    doc.autoTable({
                        startY: yPos,
                        head: [['Profile Type', 'Count', 'Amount (IQD)', 'Agent Percentage (IQD)']],
                        body: tableData,
                        theme: 'striped',
                        headStyles: {
                            fillColor: [128, 28, 50],
                            textColor: [255, 255, 255],
                            fontStyle: 'bold',
                            fontSize: 12,
                            halign: 'center'
                        },
                        bodyStyles: {
                            fontSize: 12,
                            halign: 'center'
                        },
                        columnStyles: {
                            0: { halign: 'left' },
                            1: { halign: 'center' },
                            2: { halign: 'center' },
                            3: { halign: 'center' }
                        },
                        didParseCell: function(data) {
                            if (data.row.index === tableData.length - 1) {
                                data.cell.styles.fillColor = [232, 240, 245];
                                data.cell.styles.fontStyle = 'bold';
                                data.cell.styles.fontSize = 12;
                            }
                        },
                        margin: { left: 20, right: 20 }
                    });
                    yPos = doc.lastAutoTable.finalY + 15;
                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'bold');
                    doc.text(`Agent Percentage: ${formatNumberEnglish(data.agentPercentageAmount || 0)} IQD`, 20, yPos);
                    yPos += 10;
                    if ((data.deductions || 0) > 0) {
                        doc.setFont('helvetica', 'normal');
                        doc.text(`Deductions: ${formatNumberEnglish(data.deductions || 0)} IQD`, 20, yPos);
                        yPos += 10;
                    }
                    if ((data.penalties || 0) > 0) {
                        doc.text(`Penalties: ${formatNumberEnglish(data.penalties || 0)} IQD`, 20, yPos);
                        yPos += 10;
                    }
                    doc.setFontSize(14);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(128, 28, 50);
                    doc.text(`Net Percentage: ${formatNumberEnglish(data.netPercentage || 0)} IQD`, 20, yPos);
                    const pdfBlob = doc.output('blob');
                    resolve(pdfBlob);
                } catch (error) {
                    reject(error);
                }
            });
        }
        async function resetPercentageData() {
            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ø³Ø¨ØŸ')) {
                return;
            }
            
            percentageData = null;
            agentPercentages = {};
            localStorage.removeItem('agentPercentages');
            localStorage.removeItem('agentPercentages_monthYear');
            lastPercentageDataHash = '';
            document.getElementById('percentageFileName').classList.add('hidden');
            document.getElementById('percentageResults').classList.add('hidden');
            document.getElementById('percentageFileInput').value = '';
            document.getElementById('selectedAgentForPercentage').value = '';
            document.getElementById('agentFileUploadSection').style.display = 'none';
            
            if (supabaseClient) {
                try {
                    const monthYear = getCurrentMonthYear();
                    const { error: deleteError } = await supabaseClient
                        .from('agent_percentages')
                        .delete()
                        .eq('month_year', monthYear);
                    
                    if (deleteError) {
                        console.error('Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', deleteError);
                        showSuccessMessage('ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
                    } else {
                        showSuccessMessage('ØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ø³Ø¨ Ø¨Ù†Ø¬Ø§Ø­');
                        logActivity('Ù…Ø³Ø­ Ù†Ø³Ø¨Ø© Ø§Ù„ÙˆÙƒÙ„Ø§Ø¡', 'ØªÙ… Ø­Ø°Ù Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø³Ø¨Ø© Ø§Ù„ÙˆÙƒÙ„Ø§Ø¡');
                    }
                } catch (error) {
                    console.error('Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
                    showSuccessMessage('ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ©. Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
                }
            } else {
                showSuccessMessage('ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
                logActivity('Ù…Ø³Ø­ Ù†Ø³Ø¨Ø© Ø§Ù„ÙˆÙƒÙ„Ø§Ø¡', 'ØªÙ… Ù…Ø³Ø­ Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø³Ø¨Ø© Ø§Ù„ÙˆÙƒÙ„Ø§Ø¡');
            }
            
            renderPercentageTable();
        }
        function setupMinistryFileUpload() {
            const fileUpload = document.getElementById('ministryFileUpload');
            const fileInput = document.getElementById('ministryFileInput');
            if (!fileUpload || !fileInput) return;
            fileUpload.addEventListener('click', () => fileInput.click());
            fileUpload.addEventListener('dragover', (e) => {
                e.preventDefault();
                fileUpload.style.background = 'rgba(128, 28, 50, 0.1)';
            });
            fileUpload.addEventListener('dragleave', () => {
                fileUpload.style.background = '';
            });
            fileUpload.addEventListener('drop', (e) => {
                e.preventDefault();
                fileUpload.style.background = '';
                if (e.dataTransfer.files.length > 0) {
                    fileInput.files = e.dataTransfer.files;
                    handleMinistryFileUpload(e.dataTransfer.files[0]);
                }
            });
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleMinistryFileUpload(e.target.files[0]);
                }
            });
        }
        function handleMinistryFileUpload(file) {
            const fileName = file.name;
            document.getElementById('ministryFileName').textContent = `ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù: ${fileName}`;
            document.getElementById('ministryFileName').classList.remove('hidden');
            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                ministryData = {
                    data: XLSX.utils.sheet_to_json(firstSheet, { header: 1 }),
                    fileName: fileName
                };
                showSuccessMessage(`ØªÙ… ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Excel Ø¨Ù†Ø¬Ø§Ø­. Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ "ØªØ­Ù„ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø³Ø¨Ø© Ø§Ù„ÙˆØ²Ø§Ø±Ø©" Ù„Ù„Ø¨Ø¯Ø¡`);
                logActivity('Ø±ÙØ¹ Ù…Ù„Ù Ù†Ø³Ø¨Ø© Ø§Ù„ÙˆØ²Ø§Ø±Ø©', `ØªÙ… Ø±ÙØ¹ Ù…Ù„Ù: ${fileName}`);
            };
            reader.readAsArrayBuffer(file);
        }
        function analyzeMinistryPercentageData() {
            if (!ministryData || !ministryData.data || ministryData.data.length === 0) {
                alert('ÙŠØ±Ø¬Ù‰ Ø±ÙØ¹ Ù…Ù„Ù Excel Ø£ÙˆÙ„Ø§Ù‹');
                return;
            }
            ministryOldProjectPercentage = parseFloat(localStorage.getItem('ministryOldProjectPercentage')) || 50;
            ministryNewProjectPercentage = parseFloat(localStorage.getItem('ministryNewProjectPercentage')) || 27;
            try {
                const data = ministryData.data;
                if (data.length < 2) {
                    alert('Ø§Ù„Ù…Ù„Ù Ù„Ø§ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª ÙƒØ§ÙÙŠØ©');
                    return;
                }
                const headerRow = data[0];
                let subscriptionColumnIndex = -1;
                let usernameColumnIndex = -1;
                let agentColumnIndex = -1;
                for (let i = 0; i < headerRow.length; i++) {
                    const header = String(headerRow[i] || '').toLowerCase().trim();
                    if (header.includes('Ù†ÙˆØ¹') && header.includes('Ø§Ø´ØªØ±Ø§Ùƒ') || 
                        header.includes('subscription') || 
                        header.includes('profile') ||
                        header.includes('type')) {
                        subscriptionColumnIndex = i;
                    }
                    if ((header.includes('user') && header.includes('name')) ||
                        header.includes('username') ||
                        (header.includes('Ø§Ø³Ù…') && (header.includes('Ù…Ø³ØªØ®Ø¯Ù…') || header.includes('user'))) ||
                        header === 'user' || header === 'username') {
                        usernameColumnIndex = i;
                    }
                    if (header.includes('ÙˆÙƒÙŠÙ„') || header.includes('agent') || 
                        header.includes('Ø§Ù„ÙˆÙƒÙŠÙ„') || i === 6) {
                        agentColumnIndex = i;
                    }
                }
                if (agentColumnIndex === -1 && headerRow.length > 6) {
                    agentColumnIndex = 6;
                }
                if (subscriptionColumnIndex === -1) {
                    for (let i = 0; i < headerRow.length; i++) {
                        const header = String(headerRow[i] || '').toLowerCase().trim();
                        if (header.includes('iraqcell') || header.includes('bronze') || 
                            header.includes('silver') || header.includes('gold') || 
                            header.includes('platinum')) {
                            subscriptionColumnIndex = i;
                            break;
                        }
                    }
                }
                if (subscriptionColumnIndex === -1) {
                    alert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¹Ù…ÙˆØ¯ Ù†ÙˆØ¹ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ù…Ù„Ù ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¹Ù…ÙˆØ¯ Ø¨Ù†ÙˆØ¹ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ');
                    return;
                }
                const oldProjectSubscriptions = {
                    'Iraqcell_Bronze_Profile': { count: 0, totalAmount: 0, price: 0 },
                    'Iraqcell_Silver_Profile': { count: 0, totalAmount: 0, price: 0 },
                    'Iraqcell_Gold_Profile': { count: 0, totalAmount: 0, price: 0 },
                    'Iraqcell_Platinum_Profile': { count: 0, totalAmount: 0, price: 0 }
                };
                const newProjectSubscriptions = {
                    'Iraqcell_Bronze_Profile_NEW': { count: 0, totalAmount: 0, price: 0 },
                    'Iraqcell_Silver_Profile_NEW': { count: 0, totalAmount: 0, price: 0 },
                    'Iraqcell_Gold_Profile_NEW': { count: 0, totalAmount: 0, price: 0 },
                    'Iraqcell_Platinum_Profile_NEW': { count: 0, totalAmount: 0, price: 0 }
                };
                const priceDifferences = [];
                const oldProjectDetails = [];
                const newProjectDetails = [];
                let amountColumnIndex = -1;
                let userPriceColumnIndex = -1;
                for (let i = 0; i < headerRow.length; i++) {
                    const header = String(headerRow[i] || '').toLowerCase().trim();
                    if (header.includes('user') && header.includes('price')) {
                        userPriceColumnIndex = i;
                    }
                    if (header.includes('Ù…Ø¨Ù„Øº') || header.includes('amount') || 
                        header.includes('Ø³Ø¹Ø±') || header.includes('price') ||
                        header.includes('ÙØ¦Ø©')) {
                        if (amountColumnIndex === -1) {
                            amountColumnIndex = i;
                        }
                    }
                }
                if (userPriceColumnIndex >= 0) {
                    amountColumnIndex = userPriceColumnIndex;
                }
                for (let i = 1; i < data.length; i++) {
                    const row = data[i];
                    if (!row || row.length === 0) continue;
                    const subscriptionType = String(row[subscriptionColumnIndex] || '').trim();
                    if (!subscriptionType) continue;
                    let subscriptionKey = null;
                    let isNewProject = false;
                    if (subscriptionType.includes('Bronze') || subscriptionType.includes('Ø¨Ø±ÙˆÙ†Ø²')) {
                        subscriptionKey = subscriptionType.includes('NEW') || subscriptionType.includes('_NEW') ? 
                            'Iraqcell_Bronze_Profile_NEW' : 'Iraqcell_Bronze_Profile';
                        isNewProject = subscriptionType.includes('NEW') || subscriptionType.includes('_NEW');
                    } else if (subscriptionType.includes('Silver') || subscriptionType.includes('Ø³Ù„ÙØ±')) {
                        subscriptionKey = subscriptionType.includes('NEW') || subscriptionType.includes('_NEW') ? 
                            'Iraqcell_Silver_Profile_NEW' : 'Iraqcell_Silver_Profile';
                        isNewProject = subscriptionType.includes('NEW') || subscriptionType.includes('_NEW');
                    } else if (subscriptionType.includes('Gold') || subscriptionType.includes('ÙƒÙˆÙ„Ø¯')) {
                        subscriptionKey = subscriptionType.includes('NEW') || subscriptionType.includes('_NEW') ? 
                            'Iraqcell_Gold_Profile_NEW' : 'Iraqcell_Gold_Profile';
                        isNewProject = subscriptionType.includes('NEW') || subscriptionType.includes('_NEW');
                    } else if (subscriptionType.includes('Platinum') || subscriptionType.includes('Ø¨Ù„Ø§ØªÙŠÙ†ÙŠÙˆÙ…')) {
                        subscriptionKey = subscriptionType.includes('NEW') || subscriptionType.includes('_NEW') ? 
                            'Iraqcell_Platinum_Profile_NEW' : 'Iraqcell_Platinum_Profile';
                        isNewProject = subscriptionType.includes('NEW') || subscriptionType.includes('_NEW');
                    }
                    if (!subscriptionKey) continue;
                    let amount = 0;
                    let price = 0;
                    const category = subscriptionKey.includes('Bronze') ? 'B' : 
                                   subscriptionKey.includes('Silver') ? 'S' : 
                                   subscriptionKey.includes('Gold') ? 'G' : 'P';
                    
                    const officialPrice = getSubscriptionPrice(subscriptionKey, category, 'basic');
                    
                    let userPrice = 0;
                    if (amountColumnIndex >= 0 && row[amountColumnIndex] !== undefined && row[amountColumnIndex] !== null) {
                        const priceValue = String(row[amountColumnIndex]).trim();
                        if (priceValue !== '' && priceValue !== '0' && priceValue !== 'null' && priceValue !== 'undefined') {
                            userPrice = parseFloat(priceValue);
                            if (isNaN(userPrice) || userPrice <= 0) {
                                userPrice = 0;
                            }
                        }
                    }
                    
                    const username = usernameColumnIndex >= 0 && row[usernameColumnIndex] 
                        ? String(row[usernameColumnIndex]).trim() 
                        : (row[0] || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯');
                    const agentName = agentColumnIndex >= 0 && row[agentColumnIndex] 
                        ? String(row[agentColumnIndex]).trim() 
                        : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                    
           
                    if (userPrice === 0 || isNaN(userPrice)) {
                        price = officialPrice;
                        amount = officialPrice;
                    } else if (userPrice < officialPrice) {
                        price = officialPrice;
                        amount = officialPrice;
                        priceDifferences.push({
                            username: username || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
                            agentName: agentName || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
                            subscriptionType: subscriptionType,
                            officialPrice: officialPrice,
                            userPrice: userPrice,
                            usedPrice: officialPrice,
                            difference: officialPrice - userPrice,
                            projectType: isNewProject ? 'Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ø¬Ø¯ÙŠØ¯' : 'Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ù‚Ø¯ÙŠÙ…'
                        });
                    } else if (userPrice > officialPrice) {
                        price = userPrice;
                        amount = userPrice;
                        priceDifferences.push({
                            username: username || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
                            agentName: agentName || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
                            subscriptionType: subscriptionType,
                            officialPrice: officialPrice,
                            userPrice: userPrice,
                            usedPrice: userPrice,
                            difference: userPrice - officialPrice,
                            projectType: isNewProject ? 'Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ø¬Ø¯ÙŠØ¯' : 'Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ù‚Ø¯ÙŠÙ…'
                        });
                    } else {
                        price = officialPrice;
                        amount = officialPrice;
                    }
                    
                    const subscriptionDetail = {
                        username: username || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
                        agentName: agentName || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
                        subscriptionType: subscriptionType,
                        officialPrice: officialPrice,
                        userPrice: userPrice || 0,
                        usedPrice: price,
                        amount: amount,
                        category: category,
                        rowData: row
                    };
                    
                    if (isNewProject && newProjectSubscriptions[subscriptionKey]) {
                        newProjectSubscriptions[subscriptionKey].count++;
                        newProjectSubscriptions[subscriptionKey].totalAmount += amount;
                        if (newProjectSubscriptions[subscriptionKey].count === 1) {
                            newProjectSubscriptions[subscriptionKey].price = price;
                        } else {
                            const avgPrice = newProjectSubscriptions[subscriptionKey].totalAmount / newProjectSubscriptions[subscriptionKey].count;
                            newProjectSubscriptions[subscriptionKey].price = Math.round(avgPrice);
                        }
                        newProjectDetails.push(subscriptionDetail);
                    } else if (!isNewProject && oldProjectSubscriptions[subscriptionKey]) {
                        oldProjectSubscriptions[subscriptionKey].count++;
                        oldProjectSubscriptions[subscriptionKey].totalAmount += amount;
                        if (oldProjectSubscriptions[subscriptionKey].count === 1) {
                            oldProjectSubscriptions[subscriptionKey].price = price;
                        } else {
                            const avgPrice = oldProjectSubscriptions[subscriptionKey].totalAmount / oldProjectSubscriptions[subscriptionKey].count;
                            oldProjectSubscriptions[subscriptionKey].price = Math.round(avgPrice);
                        }
                        oldProjectDetails.push(subscriptionDetail);
                    }
                }
                ministryResults = {
                    oldProject: {},
                    newProject: {},
                    totals: {
                        oldProject: { totalCount: 0, totalAmount: 0, ministryAmount: 0 },
                        newProject: { totalCount: 0, totalAmount: 0, ministryAmount: 0 },
                        grandTotal: 0
                    },
                    priceDifferences: priceDifferences,
                    oldProjectDetails: oldProjectDetails,
                    newProjectDetails: newProjectDetails,
                    headerRow: headerRow
                };
                const subscriptionTypes = ['Bronze', 'Silver', 'Gold', 'Platinum'];
                subscriptionTypes.forEach(type => {
                    const oldKey = `Iraqcell_${type}_Profile`;
                    const newKey = `Iraqcell_${type}_Profile_NEW`;
                    const oldData = oldProjectSubscriptions[oldKey] || { count: 0, totalAmount: 0, price: 0 };
                    const newData = newProjectSubscriptions[newKey] || { count: 0, totalAmount: 0, price: 0 };
                    const oldMinistryAmount = oldData.totalAmount * (ministryOldProjectPercentage / 100);
                    const newMinistryAmount = newData.totalAmount * (ministryNewProjectPercentage / 100);
                    let oldPrice = oldData.price;
                    let newPrice = newData.price;
                    if (oldPrice === 0 && oldData.count > 0) {
                        const category = type === 'Bronze' ? 'B' : type === 'Silver' ? 'S' : type === 'Gold' ? 'G' : 'P';
                        oldPrice = getSubscriptionPrice(oldKey, category, 'basic');
                    }
                    if (newPrice === 0 && newData.count > 0) {
                        const category = type === 'Bronze' ? 'B' : type === 'Silver' ? 'S' : type === 'Gold' ? 'G' : 'P';
                        newPrice = getSubscriptionPrice(newKey, category, 'basic');
                    }
                    ministryResults.oldProject[type] = {
                        count: oldData.count,
                        amount: oldData.totalAmount,
                        price: oldPrice,
                        ministryPercentage: ministryOldProjectPercentage,
                        ministryAmount: oldMinistryAmount
                    };
                    ministryResults.newProject[type] = {
                        count: newData.count,
                        amount: newData.totalAmount,
                        price: newPrice,
                        ministryPercentage: ministryNewProjectPercentage,
                        ministryAmount: newMinistryAmount
                    };
                    ministryResults.totals.oldProject.totalCount += oldData.count;
                    ministryResults.totals.oldProject.totalAmount += oldData.totalAmount;
                    ministryResults.totals.oldProject.ministryAmount += oldMinistryAmount;
                    ministryResults.totals.newProject.totalCount += newData.count;
                    ministryResults.totals.newProject.totalAmount += newData.totalAmount;
                    ministryResults.totals.newProject.ministryAmount += newMinistryAmount;
                });
                ministryResults.totals.grandTotal = ministryResults.totals.oldProject.ministryAmount + 
                                                     ministryResults.totals.newProject.ministryAmount;
                renderMinistryTable();
                document.getElementById('ministryResults').classList.remove('hidden');
                showSuccessMessage('ØªÙ… ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
                logActivity('ØªØ­Ù„ÙŠÙ„ Ù†Ø³Ø¨Ø© Ø§Ù„ÙˆØ²Ø§Ø±Ø©', 'ØªÙ… ØªØ­Ù„ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø³Ø¨Ø© Ø§Ù„ÙˆØ²Ø§Ø±Ø© Ø¨Ù†Ø¬Ø§Ø­');
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ' + error.message);
            }
        }
        function renderMinistryTable() {
            if (!ministryResults) return;
            ministryOldProjectPercentage = parseFloat(localStorage.getItem('ministryOldProjectPercentage')) || 50;
            ministryNewProjectPercentage = parseFloat(localStorage.getItem('ministryNewProjectPercentage')) || 27;
            const tbody = document.getElementById('ministryTableBody');
            if (!tbody) return;
            tbody.innerHTML = '';
            const subscriptionTypes = [
                { key: 'Bronze', name: 'Bronze', price: 30000 },
                { key: 'Silver', name: 'Silver', price: 40000 },
                { key: 'Gold', name: 'Gold', price: 50000 },
                { key: 'Platinum', name: 'Platinum', price: 65000 }
            ];
            subscriptionTypes.forEach(type => {
                const oldData = ministryResults.oldProject[type.key] || { count: 0, amount: 0, price: 0, ministryAmount: 0 };
                const newData = ministryResults.newProject[type.key] || { count: 0, amount: 0, price: 0, ministryAmount: 0 };
                const row = document.createElement('tr');
                const oldPercentage = ministryOldProjectPercentage;
                const newPercentage = ministryNewProjectPercentage;
                const oldMinistryAmount = oldData.amount * (oldPercentage / 100);
                const newMinistryAmount = newData.amount * (newPercentage / 100);
                const oldPrice = oldData.price || 0;
                const newPrice = newData.price || 0;
                row.innerHTML = `
                    <td style="padding: 8px 6px; text-align: center; border: 1px solid #ddd; font-weight: 600;">${type.name}</td>
                    <td style="padding: 8px 6px; text-align: center; border: 1px solid #ddd; direction: ltr;">${formatNumber(oldData.count)}</td>
                    <td style="padding: 8px 6px; text-align: center; border: 1px solid #ddd; direction: ltr;">${formatNumber(oldPrice)}</td>
                    <td style="padding: 8px 6px; text-align: center; border: 1px solid #ddd; direction: ltr;">${formatNumber(oldData.amount)}</td>
                    <td style="padding: 8px 6px; text-align: center; border: 1px solid #ddd; direction: ltr;">${oldPercentage}%</td>
                    <td style="padding: 8px 6px; text-align: center; border: 1px solid #ddd; direction: ltr; font-weight: 600; color: #801c32;">${formatNumber(oldMinistryAmount)}</td>
                    <td style="padding: 8px 6px; text-align: center; border: 1px solid #ddd; direction: ltr;">${formatNumber(newData.count)}</td>
                    <td style="padding: 8px 6px; text-align: center; border: 1px solid #ddd; direction: ltr;">${formatNumber(newPrice)}</td>
                    <td style="padding: 8px 6px; text-align: center; border: 1px solid #ddd; direction: ltr;">${formatNumber(newData.amount)}</td>
                    <td style="padding: 8px 6px; text-align: center; border: 1px solid #ddd; direction: ltr;">${newPercentage}%</td>
                    <td style="padding: 8px 6px; text-align: center; border: 1px solid #ddd; direction: ltr; font-weight: 600; color: #801c32;">${formatNumber(newMinistryAmount)}</td>
                    <td style="padding: 8px 6px; text-align: center; border: 1px solid #ddd; direction: ltr; font-weight: 700; color: #801c32; font-size: 0.9rem;">${formatNumber(oldMinistryAmount + newMinistryAmount)}</td>
                `;
                tbody.appendChild(row);
            });
            const totalRow = document.createElement('tr');
            totalRow.style.borderTop = '3px solid #801c32';
            totalRow.style.background = '#f8f9fa';
            totalRow.style.fontWeight = 'bold';
            const totals = ministryResults.totals;
            const recalculatedOldMinistryAmount = totals.oldProject.totalAmount * (ministryOldProjectPercentage / 100);
            const recalculatedNewMinistryAmount = totals.newProject.totalAmount * (ministryNewProjectPercentage / 100);
            const recalculatedGrandTotal = recalculatedOldMinistryAmount + recalculatedNewMinistryAmount;
            totalRow.innerHTML = `
                <td style="padding: 8px 6px; text-align: center; border: 1px solid #ddd; font-weight: bold; font-size: 0.9rem;">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</td>
                <td style="padding: 8px 6px; text-align: center; border: 1px solid #ddd; direction: ltr; font-weight: bold; font-size: 0.85rem;">${formatNumber(totals.oldProject.totalCount)}</td>
                <td style="padding: 8px 6px; text-align: center; border: 1px solid #ddd; direction: ltr; font-weight: bold; font-size: 0.85rem;">-</td>
                <td style="padding: 8px 6px; text-align: center; border: 1px solid #ddd; direction: ltr; font-weight: bold; font-size: 0.85rem;">${formatNumber(totals.oldProject.totalAmount)}</td>
                <td style="padding: 8px 6px; text-align: center; border: 1px solid #ddd; direction: ltr; font-weight: bold; font-size: 0.85rem;">${ministryOldProjectPercentage}%</td>
                <td style="padding: 8px 6px; text-align: center; border: 1px solid #ddd; direction: ltr; font-weight: bold; font-size: 0.85rem; color: #801c32;">${formatNumber(recalculatedOldMinistryAmount)}</td>
                <td style="padding: 8px 6px; text-align: center; border: 1px solid #ddd; direction: ltr; font-weight: bold; font-size: 0.85rem;">${formatNumber(totals.newProject.totalCount)}</td>
                <td style="padding: 8px 6px; text-align: center; border: 1px solid #ddd; direction: ltr; font-weight: bold; font-size: 0.85rem;">-</td>
                <td style="padding: 8px 6px; text-align: center; border: 1px solid #ddd; direction: ltr; font-weight: bold; font-size: 0.85rem;">${formatNumber(totals.newProject.totalAmount)}</td>
                <td style="padding: 8px 6px; text-align: center; border: 1px solid #ddd; direction: ltr; font-weight: bold; font-size: 0.85rem;">${ministryNewProjectPercentage}%</td>
                <td style="padding: 8px 6px; text-align: center; border: 1px solid #ddd; direction: ltr; font-weight: bold; font-size: 0.85rem; color: #801c32;">${formatNumber(recalculatedNewMinistryAmount)}</td>
                <td style="padding: 8px 6px; text-align: center; border: 1px solid #ddd; direction: ltr; font-weight: bold; font-size: 1rem; color: #801c32;">${formatNumber(recalculatedGrandTotal)}</td>
            `;
            tbody.appendChild(totalRow);
            const summaryDiv = document.getElementById('ministrySummary');
            const summaryContent = document.getElementById('ministrySummaryContent');
            if (summaryDiv && summaryContent) {
                const summaryOldMinistryAmount = totals.oldProject.totalAmount * (ministryOldProjectPercentage / 100);
                const summaryNewMinistryAmount = totals.newProject.totalAmount * (ministryNewProjectPercentage / 100);
                const summaryGrandTotal = summaryOldMinistryAmount + summaryNewMinistryAmount;
                summaryContent.innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-top: 10px;">
                        <div style="padding: 12px; background: white; border-radius: 8px; border: 1px solid #ddd;">
                            <div style="font-size: 0.85rem; color: #666; margin-bottom: 5px;">Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ù‚Ø¯ÙŠÙ… (${ministryOldProjectPercentage}%)</div>
                            <div style="font-size: 1.2rem; font-weight: 700; color: #801c32;">${formatNumber(summaryOldMinistryAmount)} Ø¯.Ø¹</div>
                        </div>
                        <div style="padding: 12px; background: white; border-radius: 8px; border: 1px solid #ddd;">
                            <div style="font-size: 0.85rem; color: #666; margin-bottom: 5px;">Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ø¬Ø¯ÙŠØ¯ (${ministryNewProjectPercentage}%)</div>
                            <div style="font-size: 1.2rem; font-weight: 700; color: #801c32;">${formatNumber(summaryNewMinistryAmount)} Ø¯.Ø¹</div>
                        </div>
                        <div style="padding: 12px; background: #801c32; border-radius: 8px; color: white;">
                            <div style="font-size: 0.85rem; margin-bottom: 5px; opacity: 0.9;">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙƒÙ„ÙŠ</div>
                            <div style="font-size: 1.4rem; font-weight: 700;">${formatNumber(summaryGrandTotal)} Ø¯.Ø¹</div>
                        </div>
                    </div>
                `;
                summaryDiv.style.display = 'block';
            }
            
            renderPriceDifferences();
        }
        function renderPriceDifferences() {
            if (!ministryResults || !ministryResults.priceDifferences || ministryResults.priceDifferences.length === 0) {
                const differencesSection = document.getElementById('ministryPriceDifferences');
                if (differencesSection) {
                    differencesSection.classList.add('hidden');
                }
                return;
            }
            
            const differencesSection = document.getElementById('ministryPriceDifferences');
            const differencesTbody = document.getElementById('priceDifferencesTableBody');
            if (!differencesSection || !differencesTbody) return;
            
            differencesSection.classList.remove('hidden');
            differencesTbody.innerHTML = '';
            
            ministryResults.priceDifferences.forEach((diff, index) => {
                const row = document.createElement('tr');
                const isLower = diff.userPrice < diff.officialPrice;
                const rowColor = isLower ? 'rgba(220, 53, 69, 0.1)' : 'rgba(40, 167, 69, 0.1)';
                row.style.background = rowColor;
                
                const differenceText = isLower 
                    ? `-${formatNumber(diff.difference)} (Ø£Ù‚Ù„ Ù…Ù† Ø§Ù„Ø±Ø³Ù…ÙŠ)` 
                    : `+${formatNumber(diff.difference)} (Ø£ÙƒØ«Ø± Ù…Ù† Ø§Ù„Ø±Ø³Ù…ÙŠ)`;
                const differenceColor = isLower ? '#dc3545' : '#28a745';
                
                const agentDisplay = diff.agentName && diff.agentName !== 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' 
                    ? `  ${diff.agentName}` 
                    : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                row.innerHTML = `
                    <td style="padding: 8px; text-align: center; border: 1px solid #ddd;">${index + 1}</td>
                    <td style="padding: 8px; text-align: center; border: 1px solid #ddd;">${diff.username}</td>
                    <td style="padding: 8px; text-align: center; border: 1px solid #ddd; font-weight: 500;">${agentDisplay}</td>
                    <td style="padding: 8px; text-align: center; border: 1px solid #ddd;">${diff.subscriptionType}</td>
                    <td style="padding: 8px; text-align: center; border: 1px solid #ddd;">${diff.projectType}</td>
                    <td style="padding: 8px; text-align: center; border: 1px solid #ddd; direction: ltr;">${formatNumber(diff.officialPrice)} Ø¯.Ø¹</td>
                    <td style="padding: 8px; text-align: center; border: 1px solid #ddd; direction: ltr;">${formatNumber(diff.userPrice)} Ø¯.Ø¹</td>
                    <td style="padding: 8px; text-align: center; border: 1px solid #ddd; direction: ltr; font-weight: 600; color: #801c32;">${formatNumber(diff.usedPrice)} Ø¯.Ø¹</td>
                    <td style="padding: 8px; text-align: center; border: 1px solid #ddd; direction: ltr; font-weight: 600; color: ${differenceColor};">${differenceText}</td>
                `;
                differencesTbody.appendChild(row);
            });
        }
        async function exportMinistryPercentageToExcel() {
            if (!ministryResults) {
                alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±');
                return;
            }
            ministryOldProjectPercentage = parseFloat(localStorage.getItem('ministryOldProjectPercentage')) || 50;
            ministryNewProjectPercentage = parseFloat(localStorage.getItem('ministryNewProjectPercentage')) || 27;
            
            const currentDate = new Date();
            const dateStr = formatDateForFilename(currentDate);
            
            try {
                const ExcelJS = window.ExcelJS;
                if (!ExcelJS) {
                    exportMinistryPercentageToExcelXLSX();
                    return;
                }
                
                const workbook = new ExcelJS.Workbook();
                
                if (ministryResults.oldProjectDetails && ministryResults.oldProjectDetails.length > 0) {
                    await addProjectToWorkbook(workbook, 'old', ministryResults.oldProjectDetails, ministryOldProjectPercentage, dateStr, ExcelJS);
                }
                
                if (ministryResults.newProjectDetails && ministryResults.newProjectDetails.length > 0) {
                    await addProjectToWorkbook(workbook, 'new', ministryResults.newProjectDetails, ministryNewProjectPercentage, dateStr, ExcelJS);
                }
                
                const buffer = await workbook.xlsx.writeBuffer();
                const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `Ù†Ø³Ø¨Ø©_Ø§Ù„ÙˆØ²Ø§Ø±Ø©_${dateStr}.xlsx`;
                link.click();
                
                showSuccessMessage('ØªÙ… ØªØµØ¯ÙŠØ± Ù…Ù„Ù Excel Ø¨Ù†Ø¬Ø§Ø­');
                logActivity('ØªØµØ¯ÙŠØ± Ù†Ø³Ø¨Ø© Ø§Ù„ÙˆØ²Ø§Ø±Ø©', 'ØªÙ… ØªØµØ¯ÙŠØ± Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø³Ø¨Ø© Ø§Ù„ÙˆØ²Ø§Ø±Ø© Ø¥Ù„Ù‰ Excel');
            } catch (error) {
                console.error('Error exporting to Excel:', error);
                exportMinistryPercentageToExcelXLSX();
            }
        }
        async function addProjectToWorkbook(workbook, projectType, details, percentage, dateStr, ExcelJS) {
            const projectName = projectType === 'old' ? 'Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ù‚Ø¯ÙŠÙ…' : 'Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ø¬Ø¯ÙŠØ¯';
            
            const summaryWorksheet = workbook.addWorksheet(`Ù…Ù„Ø®Øµ ${projectName}`);
            summaryWorksheet.mergeCells('A1:F1');
            const titleRow = summaryWorksheet.getRow(1);
            titleRow.getCell(1).value = `  - ${projectName}`;
            titleRow.getCell(1).font = { bold: true, size: 16, color: { argb: 'FF801C32' } };
            titleRow.getCell(1).alignment = { horizontal: 'center', vertical: 'middle' };
            titleRow.height = 30;
            
            summaryWorksheet.mergeCells('A2:F2');
            const dateRow = summaryWorksheet.getRow(2);
            dateRow.getCell(1).value = `Ø§Ù„ØªØ§Ø±ÙŠØ®: ${dateStr}`;
            dateRow.getCell(1).font = { size: 12 };
            dateRow.getCell(1).alignment = { horizontal: 'center' };
            dateRow.height = 20;
            
            summaryWorksheet.mergeCells('A3:F3');
            const percentageRow = summaryWorksheet.getRow(3);
            percentageRow.getCell(1).value = `Ù†Ø³Ø¨Ø© Ø§Ù„ÙˆØ²Ø§Ø±Ø©: ${percentage}%`;
            percentageRow.getCell(1).font = { size: 12, bold: true };
            percentageRow.getCell(1).alignment = { horizontal: 'center' };
            percentageRow.height = 20;
            
            summaryWorksheet.addRow([]);
            
            const headerRow = summaryWorksheet.addRow([
                'Ù†ÙˆØ¹ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ',
                'Ø¹Ø¯Ø¯ Ø§Ù„ÙƒØ§Ø±ØªØ§Øª',
                'Ø§Ù„Ø³Ø¹Ø±',
                'Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ',
                `Ù†Ø³Ø¨Ø© Ø§Ù„ÙˆØ²Ø§Ø±Ø© ${percentage}%`,
                'Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø³ØªØ­Ù‚'
            ]);
            headerRow.font = { bold: true, size: 12, color: { argb: 'FFFFFFFF' } };
            headerRow.fill = {
                type: 'pattern',
                pattern: 'solid',
                fgColor: { argb: 'FF801C32' }
            };
            headerRow.alignment = { horizontal: 'center', vertical: 'middle' };
            headerRow.height = 25;
            headerRow.eachCell((cell) => {
                cell.border = {
                    top: { style: 'thin', color: { argb: 'FF000000' } },
                    bottom: { style: 'thin', color: { argb: 'FF000000' } },
                    left: { style: 'thin', color: { argb: 'FF000000' } },
                    right: { style: 'thin', color: { argb: 'FF000000' } }
                };
            });
            
            const summaryByType = {
                'Bronze': { count: 0, totalAmount: 0, price: 0 },
                'Silver': { count: 0, totalAmount: 0, price: 0 },
                'Gold': { count: 0, totalAmount: 0, price: 0 },
                'Platinum': { count: 0, totalAmount: 0, price: 0 }
            };
            
            details.forEach(detail => {
                let type = '';
                if (detail.subscriptionType.includes('Bronze') || detail.subscriptionType.includes('Ø¨Ø±ÙˆÙ†Ø²')) {
                    type = 'Bronze';
                } else if (detail.subscriptionType.includes('Silver') || detail.subscriptionType.includes('Ø³Ù„ÙØ±')) {
                    type = 'Silver';
                } else if (detail.subscriptionType.includes('Gold') || detail.subscriptionType.includes('ÙƒÙˆÙ„Ø¯')) {
                    type = 'Gold';
                } else if (detail.subscriptionType.includes('Platinum') || detail.subscriptionType.includes('Ø¨Ù„Ø§ØªÙŠÙ†ÙŠÙˆÙ…')) {
                    type = 'Platinum';
                }
                
                if (type && summaryByType[type]) {
                    summaryByType[type].count++;
                    summaryByType[type].totalAmount += detail.amount;
                    if (summaryByType[type].count === 1) {
                        summaryByType[type].price = detail.usedPrice;
                    } else {
                        summaryByType[type].price = Math.round(summaryByType[type].totalAmount / summaryByType[type].count);
                    }
                }
            });
            
            const subscriptionTypes = ['Bronze', 'Silver', 'Gold', 'Platinum'];
            let totalCount = 0;
            let totalAmount = 0;
            let totalMinistryAmount = 0;
            
            subscriptionTypes.forEach(type => {
                const data = summaryByType[type];
                if (data.count > 0) {
                    const ministryAmount = data.totalAmount * (percentage / 100);
                    const dataRow = summaryWorksheet.addRow([
                        type,
                        data.count,
                        data.price,
                        data.totalAmount,
                        `${percentage}%`,
                        ministryAmount
                    ]);
                    dataRow.eachCell((cell, colNumber) => {
                        if (colNumber >= 2 && typeof cell.value === 'number') {
                            cell.numFmt = '#,##0';
                        }
                        cell.font = { size: 11 };
                        cell.alignment = { horizontal: 'center', vertical: 'middle' };
                        cell.border = {
                            top: { style: 'thin', color: { argb: 'FFDDDDDD' } },
                            bottom: { style: 'thin', color: { argb: 'FFDDDDDD' } },
                            left: { style: 'thin', color: { argb: 'FFDDDDDD' } },
                            right: { style: 'thin', color: { argb: 'FFDDDDDD' } }
                        };
                    });
                    totalCount += data.count;
                    totalAmount += data.totalAmount;
                    totalMinistryAmount += ministryAmount;
                }
            });
            
            summaryWorksheet.addRow([]);
            const totalRow = summaryWorksheet.addRow([
                'Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹',
                totalCount,
                '-',
                totalAmount,
                '',
                totalMinistryAmount
            ]);
            totalRow.font = { bold: true, size: 12 };
            totalRow.fill = {
                type: 'pattern',
                pattern: 'solid',
                fgColor: { argb: 'FFF8F9FA' }
            };
            totalRow.eachCell((cell, colNumber) => {
                if (colNumber >= 2 && typeof cell.value === 'number') {
                    cell.numFmt = '#,##0';
                }
                cell.font = { bold: true, size: 12 };
                cell.alignment = { horizontal: 'center', vertical: 'middle' };
                cell.border = {
                    top: { style: 'thick', color: { argb: 'FF801C32' } },
                    bottom: { style: 'medium', color: { argb: 'FF000000' } },
                    left: { style: 'thin', color: { argb: 'FFDDDDDD' } },
                    right: { style: 'thin', color: { argb: 'FFDDDDDD' } }
                };
            });
            
            summaryWorksheet.columns = [
                { width: 20 },
                { width: 18 },
                { width: 15 },
                { width: 18 },
                { width: 20 },
                { width: 20 }
            ];
            
            const detailsWorksheet = workbook.addWorksheet(`ØªÙØ§ØµÙŠÙ„ ${projectName}`);
            detailsWorksheet.mergeCells('A1:K1');
            const detailsTitleRow = detailsWorksheet.getRow(1);
            detailsTitleRow.getCell(1).value = `ØªÙØ§ØµÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª - ${projectName}`;
            detailsTitleRow.getCell(1).font = { bold: true, size: 16, color: { argb: 'FF801C32' } };
            detailsTitleRow.getCell(1).alignment = { horizontal: 'center', vertical: 'middle' };
            detailsTitleRow.height = 30;
            
            detailsWorksheet.mergeCells('A2:K2');
            const detailsDateRow = detailsWorksheet.getRow(2);
            detailsDateRow.getCell(1).value = `Ø§Ù„ØªØ§Ø±ÙŠØ®: ${dateStr}`;
            detailsDateRow.getCell(1).font = { size: 12 };
            detailsDateRow.getCell(1).alignment = { horizontal: 'center' };
            detailsDateRow.height = 20;
            
            detailsWorksheet.mergeCells('A3:K3');
            const detailsPercentageRow = detailsWorksheet.getRow(3);
            detailsPercentageRow.getCell(1).value = `Ù†Ø³Ø¨Ø© Ø§Ù„ÙˆØ²Ø§Ø±Ø©: ${percentage}%`;
            detailsPercentageRow.getCell(1).font = { size: 12, bold: true };
            detailsPercentageRow.getCell(1).alignment = { horizontal: 'center' };
            detailsPercentageRow.height = 20;
            
            detailsWorksheet.addRow([]);
            
            const detailsHeaderRow = detailsWorksheet.addRow([
                '#',
                'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…',
                'ØªØ§Ø¨Ø¹ Ø¥Ù„Ù‰',
                'Ù†ÙˆØ¹ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ',
                'Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø±Ø³Ù…ÙŠ',
                'Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…ÙƒØªÙˆØ¨',
                'Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…',
                'Ø§Ù„Ù…Ø¨Ù„Øº',
                `Ù†Ø³Ø¨Ø© Ø§Ù„ÙˆØ²Ø§Ø±Ø© ${percentage}%`,
                'Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø³ØªØ­Ù‚',
                'Ù…Ù„Ø§Ø­Ø¸Ø§Øª'
            ]);
            detailsHeaderRow.font = { bold: true, size: 12, color: { argb: 'FFFFFFFF' } };
            detailsHeaderRow.fill = {
                type: 'pattern',
                pattern: 'solid',
                fgColor: { argb: 'FF801C32' }
            };
            detailsHeaderRow.alignment = { horizontal: 'center', vertical: 'middle' };
            detailsHeaderRow.height = 25;
            detailsHeaderRow.eachCell((cell) => {
                cell.border = {
                    top: { style: 'thin', color: { argb: 'FF000000' } },
                    bottom: { style: 'thin', color: { argb: 'FF000000' } },
                    left: { style: 'thin', color: { argb: 'FF000000' } },
                    right: { style: 'thin', color: { argb: 'FF000000' } }
                };
            });
            
            details.forEach((detail, index) => {
                const ministryAmount = detail.amount * (percentage / 100);
                const hasDifference = detail.userPrice > 0 && detail.userPrice !== detail.officialPrice;
                const note = hasDifference 
                    ? (detail.userPrice < detail.officialPrice 
                        ? 'Ø§Ù„Ø³Ø¹Ø± Ø£Ù‚Ù„ Ù…Ù† Ø§Ù„Ø±Ø³Ù…ÙŠ - ØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø±Ø³Ù…ÙŠ'
                        : 'Ø§Ù„Ø³Ø¹Ø± Ø£ÙƒØ«Ø± Ù…Ù† Ø§Ù„Ø±Ø³Ù…ÙŠ - ØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…ÙƒØªÙˆØ¨')
                    : '';
                
                const dataRow = detailsWorksheet.addRow([
                    index + 1,
                    detail.username,
                    detail.agentName,
                    detail.subscriptionType,
                    detail.officialPrice,
                    detail.userPrice || detail.officialPrice,
                    detail.usedPrice,
                    detail.amount,
                    `${percentage}%`,
                    ministryAmount,
                    note
                ]);
                dataRow.eachCell((cell, colNumber) => {
                    if (colNumber >= 5 && colNumber <= 11 && typeof cell.value === 'number') {
                        cell.numFmt = '#,##0';
                    }
                    cell.font = { size: 11 };
                    cell.alignment = { horizontal: 'center', vertical: 'middle' };
                    cell.border = {
                        top: { style: 'thin', color: { argb: 'FFDDDDDD' } },
                        bottom: { style: 'thin', color: { argb: 'FFDDDDDD' } },
                        left: { style: 'thin', color: { argb: 'FFDDDDDD' } },
                        right: { style: 'thin', color: { argb: 'FFDDDDDD' } }
                    };
                });
            });
            
            detailsWorksheet.addRow([]);
            const detailsTotalRow = detailsWorksheet.addRow([
                'Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹',
                '',
                '',
                '',
                '',
                '',
                '',
                totalAmount,
                '',
                totalMinistryAmount,
                ''
            ]);
            detailsTotalRow.font = { bold: true, size: 12 };
            detailsTotalRow.fill = {
                type: 'pattern',
                pattern: 'solid',
                fgColor: { argb: 'FFF8F9FA' }
            };
            detailsTotalRow.eachCell((cell, colNumber) => {
                if (colNumber >= 8 && typeof cell.value === 'number') {
                    cell.numFmt = '#,##0';
                }
                cell.font = { bold: true, size: 12 };
                cell.alignment = { horizontal: 'center', vertical: 'middle' };
                cell.border = {
                    top: { style: 'thick', color: { argb: 'FF801C32' } },
                    bottom: { style: 'medium', color: { argb: 'FF000000' } },
                    left: { style: 'thin', color: { argb: 'FFDDDDDD' } },
                    right: { style: 'thin', color: { argb: 'FFDDDDDD' } }
                };
            });
            
            detailsWorksheet.columns = [
                { width: 8 },
                { width: 20 },
                { width: 20 },
                { width: 25 },
                { width: 15 },
                { width: 15 },
                { width: 15 },
                { width: 15 },
                { width: 18 },
                { width: 18 },
                { width: 40 }
            ];
            
            const projectDifferences = ministryResults.priceDifferences.filter(diff => 
                diff.projectType === projectName
            );
            
            if (projectDifferences.length > 0) {
                const differencesWorksheet = workbook.addWorksheet(`Ø§Ø®ØªÙ„Ø§ÙØ§Øª ${projectName}`);
                differencesWorksheet.mergeCells('A1:I1');
                const diffTitleRow = differencesWorksheet.getRow(1);
                diffTitleRow.getCell(1).value = `Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª Ø§Ù„ØªÙŠ ÙÙŠÙ‡Ø§ Ø§Ø®ØªÙ„Ø§Ù ÙÙŠ Ø§Ù„Ø³Ø¹Ø± - ${projectName}`;
                diffTitleRow.getCell(1).font = { bold: true, size: 16, color: { argb: 'FF801C32' } };
                diffTitleRow.getCell(1).alignment = { horizontal: 'center', vertical: 'middle' };
                diffTitleRow.height = 30;
                
                differencesWorksheet.mergeCells('A2:I2');
                const diffDateRow = differencesWorksheet.getRow(2);
                diffDateRow.getCell(1).value = `Ø§Ù„ØªØ§Ø±ÙŠØ®: ${dateStr}`;
                diffDateRow.getCell(1).font = { size: 12 };
                diffDateRow.getCell(1).alignment = { horizontal: 'center' };
                diffDateRow.height = 20;
                
                differencesWorksheet.addRow([]);
                
                const diffHeaderRow = differencesWorksheet.addRow([
                    '#',
                    'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…',
                    'ØªØ§Ø¨Ø¹ Ø¥Ù„Ù‰',
                    'Ù†ÙˆØ¹ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ',
                    'Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø±Ø³Ù…ÙŠ',
                    'Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…ÙƒØªÙˆØ¨',
                    'Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…',
                    'Ø§Ù„ÙØ±Ù‚',
                    'Ù…Ù„Ø§Ø­Ø¸Ø§Øª'
                ]);
                diffHeaderRow.font = { bold: true, size: 12, color: { argb: 'FFFFFFFF' } };
                diffHeaderRow.fill = {
                    type: 'pattern',
                    pattern: 'solid',
                    fgColor: { argb: 'FF801C32' }
                };
                diffHeaderRow.alignment = { horizontal: 'center', vertical: 'middle' };
                diffHeaderRow.height = 25;
                diffHeaderRow.eachCell((cell) => {
                    cell.border = {
                        top: { style: 'thin', color: { argb: 'FF000000' } },
                        bottom: { style: 'thin', color: { argb: 'FF000000' } },
                        left: { style: 'thin', color: { argb: 'FF000000' } },
                        right: { style: 'thin', color: { argb: 'FF000000' } }
                    };
                });
                
                let totalDifference = 0;
                projectDifferences.forEach((diff, index) => {
                    const isLower = diff.userPrice < diff.officialPrice;
                    const note = isLower 
                        ? ' Ø§Ù„ØªØ­Ø§Ø³Ø¨ Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø±Ø³Ù…ÙŠ' 
                        : ' Ø§Ù„ØªØ­Ø§Ø³Ø¨ Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…ÙƒØªÙˆØ¨';
                    
                    totalDifference += Math.abs(diff.difference);
                    
                    const diffDataRow = differencesWorksheet.addRow([
                        index + 1,
                        diff.username,
                        diff.agentName,
                        diff.subscriptionType,
                        diff.officialPrice,
                        diff.userPrice,
                        diff.usedPrice,
                        diff.difference,
                        note
                    ]);
                    diffDataRow.eachCell((cell, colNumber) => {
                        if (colNumber >= 5 && colNumber <= 8 && typeof cell.value === 'number') {
                            cell.numFmt = '#,##0';
                        }
                        cell.font = { size: 11 };
                        cell.alignment = { horizontal: 'center', vertical: 'middle' };
                        cell.border = {
                            top: { style: 'thin', color: { argb: 'FFDDDDDD' } },
                            bottom: { style: 'thin', color: { argb: 'FFDDDDDD' } },
                            left: { style: 'thin', color: { argb: 'FFDDDDDD' } },
                            right: { style: 'thin', color: { argb: 'FFDDDDDD' } }
                        };
                    });
                });
                
                differencesWorksheet.addRow([]);
                const diffTotalRow = differencesWorksheet.addRow([
                    'Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹',
                    '',
                    '',
                    '',
                    '',
                    '',
                    '',
                    totalDifference,
                    ''
                ]);
                diffTotalRow.font = { bold: true, size: 12 };
                diffTotalRow.fill = {
                    type: 'pattern',
                    pattern: 'solid',
                    fgColor: { argb: 'FFF8F9FA' }
                };
                diffTotalRow.eachCell((cell, colNumber) => {
                    if (colNumber === 8 && typeof cell.value === 'number') {
                        cell.numFmt = '#,##0';
                    }
                    cell.alignment = { horizontal: 'center', vertical: 'middle' };
                    cell.border = {
                        top: { style: 'thick', color: { argb: 'FF801C32' } },
                        bottom: { style: 'medium', color: { argb: 'FF000000' } },
                        left: { style: 'thin', color: { argb: 'FFDDDDDD' } },
                        right: { style: 'thin', color: { argb: 'FFDDDDDD' } }
                    };
                });
                
                differencesWorksheet.columns = [
                    { width: 8 },
                    { width: 20 },
                    { width: 20 },
                    { width: 25 },
                    { width: 15 },
                    { width: 15 },
                    { width: 15 },
                    { width: 15 },
                    { width: 40 }
                ];
            }
        }
        function exportMinistryPercentageToExcelXLSX() {
            if (!ministryResults) {
                alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±');
                return;
            }
            ministryOldProjectPercentage = parseFloat(localStorage.getItem('ministryOldProjectPercentage')) || 50;
            ministryNewProjectPercentage = parseFloat(localStorage.getItem('ministryNewProjectPercentage')) || 27;
            
            const dateStr = formatDateForFilename(new Date());
            
            try {
                const wb = XLSX.utils.book_new();
                
                if (ministryResults.oldProjectDetails && ministryResults.oldProjectDetails.length > 0) {
                    addProjectToWorkbookXLSX(wb, 'old', ministryResults.oldProjectDetails, ministryOldProjectPercentage, dateStr);
                }
                
                if (ministryResults.newProjectDetails && ministryResults.newProjectDetails.length > 0) {
                    addProjectToWorkbookXLSX(wb, 'new', ministryResults.newProjectDetails, ministryNewProjectPercentage, dateStr);
                }
                
                const filename = `Ù†Ø³Ø¨Ø©_Ø§Ù„ÙˆØ²Ø§Ø±Ø©_${dateStr}.xlsx`;
                XLSX.writeFile(wb, filename);
                
                showSuccessMessage('ØªÙ… ØªØµØ¯ÙŠØ± Ù…Ù„Ù Excel Ø¨Ù†Ø¬Ø§Ø­');
                logActivity('ØªØµØ¯ÙŠØ± Ù†Ø³Ø¨Ø© Ø§Ù„ÙˆØ²Ø§Ø±Ø©', 'ØªÙ… ØªØµØ¯ÙŠØ± Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø³Ø¨Ø© Ø§Ù„ÙˆØ²Ø§Ø±Ø© Ø¥Ù„Ù‰ Excel');
            } catch (error) {
                console.error('Error exporting to Excel:', error);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
            }
        }
        function addProjectToWorkbookXLSX(wb, projectType, details, percentage, dateStr) {
            const projectName = projectType === 'old' ? 'Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ù‚Ø¯ÙŠÙ…' : 'Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ø¬Ø¯ÙŠØ¯';
            
            const summaryData = [];
            summaryData.push([`- ${projectName}`]);
            summaryData.push([`Ø§Ù„ØªØ§Ø±ÙŠØ®: ${dateStr}`]);
            summaryData.push([`Ù†Ø³Ø¨Ø© Ø§Ù„ÙˆØ²Ø§Ø±Ø©: ${percentage}%`]);
            summaryData.push([]);
            summaryData.push([
                'Ù†ÙˆØ¹ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ',
                'Ø¹Ø¯Ø¯ Ø§Ù„ÙƒØ§Ø±ØªØ§Øª',
                'Ø§Ù„Ø³Ø¹Ø±',
                'Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ',
                `Ù†Ø³Ø¨Ø© Ø§Ù„ÙˆØ²Ø§Ø±Ø© ${percentage}%`,
                'Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø³ØªØ­Ù‚'
            ]);
            
            const summaryByType = {
                'Bronze': { count: 0, totalAmount: 0, price: 0 },
                'Silver': { count: 0, totalAmount: 0, price: 0 },
                'Gold': { count: 0, totalAmount: 0, price: 0 },
                'Platinum': { count: 0, totalAmount: 0, price: 0 }
            };
            
            details.forEach(detail => {
                let type = '';
                if (detail.subscriptionType.includes('Bronze') || detail.subscriptionType.includes('Ø¨Ø±ÙˆÙ†Ø²')) {
                    type = 'Bronze';
                } else if (detail.subscriptionType.includes('Silver') || detail.subscriptionType.includes('Ø³Ù„ÙØ±')) {
                    type = 'Silver';
                } else if (detail.subscriptionType.includes('Gold') || detail.subscriptionType.includes('ÙƒÙˆÙ„Ø¯')) {
                    type = 'Gold';
                } else if (detail.subscriptionType.includes('Platinum') || detail.subscriptionType.includes('Ø¨Ù„Ø§ØªÙŠÙ†ÙŠÙˆÙ…')) {
                    type = 'Platinum';
                }
                
                if (type && summaryByType[type]) {
                    summaryByType[type].count++;
                    summaryByType[type].totalAmount += detail.amount;
                    if (summaryByType[type].count === 1) {
                        summaryByType[type].price = detail.usedPrice;
                    } else {
                        summaryByType[type].price = Math.round(summaryByType[type].totalAmount / summaryByType[type].count);
                    }
                }
            });
            
            const subscriptionTypes = ['Bronze', 'Silver', 'Gold', 'Platinum'];
            let totalCount = 0;
            let totalAmount = 0;
            let totalMinistryAmount = 0;
            
            subscriptionTypes.forEach(type => {
                const data = summaryByType[type];
                if (data.count > 0) {
                    const ministryAmount = data.totalAmount * (percentage / 100);
                    summaryData.push([
                        type,
                        data.count,
                        data.price,
                        data.totalAmount,
                        `${percentage}%`,
                        ministryAmount
                    ]);
                    totalCount += data.count;
                    totalAmount += data.totalAmount;
                    totalMinistryAmount += ministryAmount;
                }
            });
            
            summaryData.push([]);
            summaryData.push([
                'Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹',
                totalCount,
                '-',
                totalAmount,
                '',
                totalMinistryAmount
            ]);
            
            const wsSummary = XLSX.utils.aoa_to_sheet(summaryData);
            XLSX.utils.book_append_sheet(wb, wsSummary, `Ù…Ù„Ø®Øµ ${projectName}`);
            
            const detailsData = [];
            detailsData.push([`ØªÙØ§ØµÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª - ${projectName}`]);
            detailsData.push([`Ø§Ù„ØªØ§Ø±ÙŠØ®: ${dateStr}`]);
            detailsData.push([`Ù†Ø³Ø¨Ø© Ø§Ù„ÙˆØ²Ø§Ø±Ø©: ${percentage}%`]);
            detailsData.push([]);
            detailsData.push([
                '#',
                'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…',
                'ØªØ§Ø¨Ø¹ Ø¥Ù„Ù‰',
                'Ù†ÙˆØ¹ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ',
                'Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø±Ø³Ù…ÙŠ',
                'Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…ÙƒØªÙˆØ¨',
                'Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…',
                'Ø§Ù„Ù…Ø¨Ù„Øº',
                `Ù†Ø³Ø¨Ø© Ø§Ù„ÙˆØ²Ø§Ø±Ø© ${percentage}%`,
                'Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø³ØªØ­Ù‚',
                'Ù…Ù„Ø§Ø­Ø¸Ø§Øª'
            ]);
            
            details.forEach((detail, index) => {
                const ministryAmount = detail.amount * (percentage / 100);
                const hasDifference = detail.userPrice > 0 && detail.userPrice !== detail.officialPrice;
                const note = hasDifference 
                    ? (detail.userPrice < detail.officialPrice 
                        ? 'Ø§Ù„Ø³Ø¹Ø± Ø£Ù‚Ù„ Ù…Ù† Ø§Ù„Ø±Ø³Ù…ÙŠ - ØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø±Ø³Ù…ÙŠ'
                        : 'Ø§Ù„Ø³Ø¹Ø± Ø£ÙƒØ«Ø± Ù…Ù† Ø§Ù„Ø±Ø³Ù…ÙŠ - ØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…ÙƒØªÙˆØ¨')
                    : '';
                
                detailsData.push([
                    index + 1,
                    detail.username,
                    detail.agentName,
                    detail.subscriptionType,
                    detail.officialPrice,
                    detail.userPrice || detail.officialPrice,
                    detail.usedPrice,
                    detail.amount,
                    `${percentage}%`,
                    ministryAmount,
                    note
                ]);
            });
            
            detailsData.push([]);
            detailsData.push([
                'Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹',
                '',
                '',
                '',
                '',
                '',
                '',
                totalAmount,
                '',
                totalMinistryAmount,
                ''
            ]);
            
            const wsDetails = XLSX.utils.aoa_to_sheet(detailsData);
            XLSX.utils.book_append_sheet(wb, wsDetails, `ØªÙØ§ØµÙŠÙ„ ${projectName}`);
            
            const projectDifferences = ministryResults.priceDifferences.filter(diff => 
                diff.projectType === projectName
            );
            
            if (projectDifferences.length > 0) {
                const differencesData = [];
                differencesData.push([`Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª Ø§Ù„ØªÙŠ ÙÙŠÙ‡Ø§ Ø§Ø®ØªÙ„Ø§Ù ÙÙŠ Ø§Ù„Ø³Ø¹Ø± - ${projectName}`]);
                differencesData.push([`Ø§Ù„ØªØ§Ø±ÙŠØ®: ${dateStr}`]);
                differencesData.push([]);
                differencesData.push([
                    '#',
                    'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…',
                    'ØªØ§Ø¨Ø¹ Ø¥Ù„Ù‰',
                    'Ù†ÙˆØ¹ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ',
                    'Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø±Ø³Ù…ÙŠ',
                    'Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…ÙƒØªÙˆØ¨',
                    'Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…',
                    'Ø§Ù„ÙØ±Ù‚',
                    'Ù…Ù„Ø§Ø­Ø¸Ø§Øª'
                ]);
                
                projectDifferences.forEach((diff, index) => {
                    const isLower = diff.userPrice < diff.officialPrice;
                    const note = isLower 
                        ? ' Ø§Ù„ØªØ­Ø§Ø³Ø¨ Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø±Ø³Ù…ÙŠ' 
                        : ' Ø§Ù„ØªØ­Ø§Ø³Ø¨ Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…ÙƒØªÙˆØ¨';
                    
                    differencesData.push([
                        index + 1,
                        diff.username,
                        diff.agentName,
                        diff.subscriptionType,
                        diff.officialPrice,
                        diff.userPrice,
                        diff.usedPrice,
                        diff.difference,
                        note
                    ]);
                });
                
                const wsDifferences = XLSX.utils.aoa_to_sheet(differencesData);
                XLSX.utils.book_append_sheet(wb, wsDifferences, `Ø§Ø®ØªÙ„Ø§ÙØ§Øª ${projectName}`);
            }
        }
        function resetMinistryData() {
            if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ')) {
                ministryData = null;
                ministryResults = null;
                document.getElementById('ministryFileName').classList.add('hidden');
                document.getElementById('ministryResults').classList.add('hidden');
                document.getElementById('ministryFileInput').value = '';
                document.getElementById('ministryTableBody').innerHTML = '';
                document.getElementById('ministrySummary').style.display = 'none';
                showSuccessMessage('ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
                logActivity('Ù…Ø³Ø­ Ù†Ø³Ø¨Ø© Ø§Ù„ÙˆØ²Ø§Ø±Ø©', 'ØªÙ… Ù…Ø³Ø­ Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø³Ø¨Ø© Ø§Ù„ÙˆØ²Ø§Ø±Ø©');
            }
        }
        function saveMinistryPercentages() {
            const oldProjectPercentage = parseFloat(document.getElementById('ministryOldProjectPercentage').value);
            const newProjectPercentage = parseFloat(document.getElementById('ministryNewProjectPercentage').value);
            
            if (oldProjectPercentage < 0 || oldProjectPercentage > 100) {
                alert('Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ù‚Ø¯ÙŠÙ… ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ø¨ÙŠÙ† 0 Ùˆ 100');
                const saved = parseFloat(localStorage.getItem('ministryOldProjectPercentage')) || 50;
                document.getElementById('ministryOldProjectPercentage').value = saved;
                return;
            }
            
            if (newProjectPercentage < 0 || newProjectPercentage > 100) {
                alert('Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ø¬Ø¯ÙŠØ¯ ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ø¨ÙŠÙ† 0 Ùˆ 100');
                const saved = parseFloat(localStorage.getItem('ministryNewProjectPercentage')) || 27;
                document.getElementById('ministryNewProjectPercentage').value = saved;
                return;
            }
            
            ministryOldProjectPercentage = oldProjectPercentage;
            ministryNewProjectPercentage = newProjectPercentage;
            localStorage.setItem('ministryOldProjectPercentage', oldProjectPercentage.toString());
            localStorage.setItem('ministryNewProjectPercentage', newProjectPercentage.toString());
            
            const oldProjectHeader = document.getElementById('ministryOldProjectHeader');
            const newProjectHeader = document.getElementById('ministryNewProjectHeader');
            const oldProjectPercentageHeader = document.getElementById('ministryOldProjectPercentageHeader');
            const newProjectPercentageHeader = document.getElementById('ministryNewProjectPercentageHeader');
            
            if (oldProjectHeader) {
                oldProjectHeader.textContent = `Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ù‚Ø¯ÙŠÙ… (${oldProjectPercentage}%)`;
            }
            if (newProjectHeader) {
                newProjectHeader.textContent = `Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ø¬Ø¯ÙŠØ¯ (${newProjectPercentage}%)`;
            }
            if (oldProjectPercentageHeader) {
                oldProjectPercentageHeader.textContent = `Ù†Ø³Ø¨Ø© Ø§Ù„ÙˆØ²Ø§Ø±Ø© ${oldProjectPercentage}%`;
            }
            if (newProjectPercentageHeader) {
                newProjectPercentageHeader.textContent = `Ù†Ø³Ø¨Ø© Ø§Ù„ÙˆØ²Ø§Ø±Ø© ${newProjectPercentage}%`;
            }
            
            if (ministryResults) {
                const subscriptionTypes = ['Bronze', 'Silver', 'Gold', 'Platinum'];
                subscriptionTypes.forEach(type => {
                    const oldData = ministryResults.oldProject[type];
                    const newData = ministryResults.newProject[type];
                    if (oldData) {
                        oldData.ministryPercentage = oldProjectPercentage;
                        oldData.ministryAmount = oldData.amount * (oldProjectPercentage / 100);
                    }
                    if (newData) {
                        newData.ministryPercentage = newProjectPercentage;
                        newData.ministryAmount = newData.amount * (newProjectPercentage / 100);
                    }
                });
                ministryResults.totals.oldProject.ministryAmount = 0;
                ministryResults.totals.newProject.ministryAmount = 0;
                subscriptionTypes.forEach(type => {
                    const oldData = ministryResults.oldProject[type];
                    const newData = ministryResults.newProject[type];
                    if (oldData) {
                        ministryResults.totals.oldProject.ministryAmount += oldData.ministryAmount;
                    }
                    if (newData) {
                        ministryResults.totals.newProject.ministryAmount += newData.ministryAmount;
                    }
                });
                ministryResults.totals.grandTotal = ministryResults.totals.oldProject.ministryAmount + 
                                                     ministryResults.totals.newProject.ministryAmount;
                renderMinistryTable();
            }
            
            logActivity('Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª', `ØªÙ… ØªØ­Ø¯ÙŠØ« Ù†Ø³Ø¨Ø© Ø§Ù„ÙˆØ²Ø§Ø±Ø©: Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ù‚Ø¯ÙŠÙ… ${oldProjectPercentage}% ÙˆØ§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ø¬Ø¯ÙŠØ¯ ${newProjectPercentage}%`);
            showSuccessMessage(`ØªÙ… Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù†Ø³Ø¨Ø© Ø§Ù„ÙˆØ²Ø§Ø±Ø©: Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ù‚Ø¯ÙŠÙ… ${oldProjectPercentage}% ÙˆØ§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ø¬Ø¯ÙŠØ¯ ${newProjectPercentage}%`);
        }
        function loadMinistryPercentages() {
            const oldProjectPercentage = parseFloat(localStorage.getItem('ministryOldProjectPercentage')) || 50;
            const newProjectPercentage = parseFloat(localStorage.getItem('ministryNewProjectPercentage')) || 27;
            
            ministryOldProjectPercentage = oldProjectPercentage;
            ministryNewProjectPercentage = newProjectPercentage;
            
            const oldProjectInput = document.getElementById('ministryOldProjectPercentage');
            const newProjectInput = document.getElementById('ministryNewProjectPercentage');
            
            if (oldProjectInput) {
                oldProjectInput.value = oldProjectPercentage;
            }
            if (newProjectInput) {
                newProjectInput.value = newProjectPercentage;
            }
            
            const oldProjectHeader = document.getElementById('ministryOldProjectHeader');
            const newProjectHeader = document.getElementById('ministryNewProjectHeader');
            const oldProjectPercentageHeader = document.getElementById('ministryOldProjectPercentageHeader');
            const newProjectPercentageHeader = document.getElementById('ministryNewProjectPercentageHeader');
            
            if (oldProjectHeader) {
                oldProjectHeader.textContent = `Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ù‚Ø¯ÙŠÙ… (${oldProjectPercentage}%)`;
            }
            if (newProjectHeader) {
                newProjectHeader.textContent = `Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ø¬Ø¯ÙŠØ¯ (${newProjectPercentage}%)`;
            }
            if (oldProjectPercentageHeader) {
                oldProjectPercentageHeader.textContent = `Ù†Ø³Ø¨Ø© Ø§Ù„ÙˆØ²Ø§Ø±Ø© ${oldProjectPercentage}%`;
            }
            if (newProjectPercentageHeader) {
                newProjectPercentageHeader.textContent = `Ù†Ø³Ø¨Ø© Ø§Ù„ÙˆØ²Ø§Ø±Ø© ${newProjectPercentage}%`;
            }
        }
        let lastPercentageDataHash = '';
        let isRenderingTable = false;
        let renderPercentageTableTimeout = null;
        function loadPercentageData() {
            if (isRenderingTable) return;
            if (renderPercentageTableTimeout) {
                clearTimeout(renderPercentageTableTimeout);
            }
            const currentDataHash = JSON.stringify(agentPercentages);
            if (currentDataHash !== lastPercentageDataHash) {
                lastPercentageDataHash = currentDataHash;
                renderPercentageTableTimeout = setTimeout(() => {
                    if (Object.keys(agentPercentages).length > 0 && !isRenderingTable) {
                        renderPercentageTable();
                    }
                    renderPercentageTableTimeout = null;
                }, 1000);
            }
        }
        function setupPercentageTableEventListeners() {
                const tbody = document.getElementById('percentageTableBody');
            if (!tbody) return;
            const oldInputs = tbody.querySelectorAll('input[data-agent-name]');
            oldInputs.forEach(input => {
                const newInput = input.cloneNode(true);
                input.parentNode.replaceChild(newInput, input);
            });
            tbody.addEventListener('input', function(e) {
                const input = e.target;
                if (input && input.tagName === 'INPUT' && input.hasAttribute('data-agent-name') && input.hasAttribute('data-field-type')) {
                    const agentName = input.getAttribute('data-agent-name');
                    const fieldType = input.getAttribute('data-field-type');
                    const value = parseFloat(input.value) || 0;
                    if (fieldType === 'deduction') {
                        updateDeduction(agentName, value, true);
                    } else if (fieldType === 'penalty') {
                        updatePenalty(agentName, value, true);
                    }
                }
            });
            tbody.addEventListener('change', function(e) {
                const input = e.target;
                if (input && input.tagName === 'INPUT' && input.hasAttribute('data-agent-name') && input.hasAttribute('data-field-type')) {
                    const agentName = input.getAttribute('data-agent-name');
                    const fieldType = input.getAttribute('data-field-type');
                    const value = parseFloat(input.value) || 0;
                    if (fieldType === 'deduction') {
                        updateDeduction(agentName, value, false);
                    } else if (fieldType === 'penalty') {
                        updatePenalty(agentName, value, false);
                    }
                }
            });
            tbody.addEventListener('blur', function(e) {
                const input = e.target;
                if (input && input.tagName === 'INPUT' && input.hasAttribute('data-agent-name') && input.hasAttribute('data-field-type')) {
                    const agentName = input.getAttribute('data-agent-name');
                    const fieldType = input.getAttribute('data-field-type');
                    const value = parseFloat(input.value) || 0;
                    if (fieldType === 'deduction') {
                        updateDeduction(agentName, value, false);
                    } else if (fieldType === 'penalty') {
                        updatePenalty(agentName, value, false);
                    }
                }
            }, true);
        }
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.querySelector('.main-content');
            const toggleBtn = document.getElementById('sidebarToggleBtn');
            const toggleBtnExternal = document.getElementById('sidebarToggleBtnExternal');
            if (!sidebar || !mainContent || !toggleBtn) return;
            const isHidden = sidebar.classList.contains('hidden');
            if (isHidden) {
                sidebar.classList.remove('hidden');
                mainContent.classList.remove('sidebar-hidden');
                toggleBtn.textContent = 'â˜°';
                toggleBtn.title = 'Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©';
                if (toggleBtnExternal) {
                    toggleBtnExternal.style.display = 'none';
                    toggleBtnExternal.title = 'Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©';
                }
                localStorage.setItem('sidebarHidden', 'false');
            } else {
                sidebar.classList.add('hidden');
                mainContent.classList.add('sidebar-hidden');
                toggleBtn.textContent = 'â˜°';
                toggleBtn.title = 'Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©';
                if (toggleBtnExternal) {
                    toggleBtnExternal.style.display = 'flex';
                    toggleBtnExternal.title = 'Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©';
                }
                localStorage.setItem('sidebarHidden', 'true');
            }
        }
        function loadSidebarState() {
            const sidebarHidden = localStorage.getItem('sidebarHidden') === 'true';
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.querySelector('.main-content');
            const toggleBtn = document.getElementById('sidebarToggleBtn');
            const toggleBtnExternal = document.getElementById('sidebarToggleBtnExternal');
            if (sidebar && mainContent && toggleBtn) {
                if (sidebarHidden) {
                    sidebar.classList.add('hidden');
                    mainContent.classList.add('sidebar-hidden');
                    toggleBtn.title = 'Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©';
                    if (toggleBtnExternal) {
                        toggleBtnExternal.style.display = 'flex';
                        toggleBtnExternal.title = 'Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©';
                    }
                } else {
                    sidebar.classList.remove('hidden');
                    mainContent.classList.remove('sidebar-hidden');
                    toggleBtn.title = 'Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©';
                    if (toggleBtnExternal) {
                        toggleBtnExternal.style.display = 'none';
                        toggleBtnExternal.title = 'Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©';
                    }
                }
            }
        }
        const saveLocks = new Map();
        const archiveSaveLocks = new Map();
        const displayLocks = new Map();
        
        async function saveToDatabase(tableName, data, options = {}) {
            if (!supabaseClient) {
                return false;
            }
            
            const lockKey = `${tableName}_${options.monthYear || getCurrentMonthYear()}_${options.analysis_type || ''}`;
            
            if (saveLocks.has(lockKey)) {
                const startTime = Date.now();
                let waitCount = 0;
                while (saveLocks.has(lockKey) && (Date.now() - startTime) < 30000) {
                    await new Promise(resolve => setTimeout(resolve, 200));
                    waitCount++;
                    if (waitCount === 10) {
                        console.warn(`âš  Save already in progress for ${lockKey}, waiting...`);
                    }
                }
                if (saveLocks.has(lockKey)) {
                    console.warn(`âš  Timeout waiting for previous save to complete for ${lockKey}`);
                    return false;
                }
            }
            
            saveLocks.set(lockKey, true);
            
            try {
                let monthYear = options.monthYear || getCurrentMonthYear();
                const { analysis_type } = options;
                let dataString = JSON.stringify(data);
                const originalSize = dataString.length;
                if (originalSize > 5000000) {
                    console.warn(`Data size: ${(originalSize / 1024 / 1024).toFixed(2)}MB, optimizing...`);
                    if (tableName === 'analysis_archives' && data.agentReports) {
                        const optimizedData = {
                            ...data,
                            details: Array.isArray(data.details) ? data.details.map(detail => ({
                                username: detail.username,
                                subscription: detail.subscription,
                                agent: detail.agent,
                                date1: detail.date1,
                                date2: detail.date2,
                                date3: detail.date3,
                                daysDiff: detail.daysDiff,
                                type: detail.type
                            })).slice(0, 10000) : data.details, 
                            data: Array.isArray(data.data) ? data.data.slice(0, 500) : data.data,
                            agentReports: data.agentReports ? Object.keys(data.agentReports).reduce((acc, key) => {
                                const report = data.agentReports[key];
                                if (report && report.advanced) {
                                    acc[key] = {
                                        advanced: {
                                            bronze: report.advanced.bronze,
                                            silver: report.advanced.silver,
                                            gold: report.advanced.gold,
                                            platinum: report.advanced.platinum,
                                            total: report.advanced.total,
                                            agentName: report.advanced.agentName
                                        }
                                    };
                                }
                                return acc;
                            }, {}) : data.agentReports
                        };
                        data = optimizedData;
                        dataString = JSON.stringify(data);
                    }
                }
                dataString = JSON.stringify(data);
                if (dataString.length > 10000000) { 
                    console.warn(`Data still too large after optimization (${(dataString.length / 1024 / 1024).toFixed(2)}MB), applying aggressive reduction...`);
                    if (tableName === 'analysis_archives' && data.details) {
                        const optimizedDetails = Array.isArray(data.details) ? data.details.map(detail => ({
                            username: detail.username,
                            subscription: detail.subscription,
                            agent: detail.agent,
                            date1: detail.date1,
                            date2: detail.date2,
                            date3: detail.date3,
                            daysDiff: detail.daysDiff,
                            type: detail.type,
                            price: detail.price,
                            promoPrice: detail.promoPrice,
                            officialPrice: detail.officialPrice
                        })).slice(0, 5000) : data.details;
                        data = {
                            ...data,
                            details: optimizedDetails,
                            data: Array.isArray(data.data) ? data.data.slice(0, 200) : data.data,
                            agentReports: data.agentReports ? Object.keys(data.agentReports).reduce((acc, key) => {
                                const report = data.agentReports[key];
                                if (report) {
                                    acc[key] = {};
                                    if (report.basic) {
                                        acc[key].basic = {
                                            bronze: report.basic.bronze,
                                            silver: report.basic.silver,
                                            gold: report.basic.gold,
                                            platinum: report.basic.platinum,
                                            total: report.basic.total,
                                            agentName: report.basic.agentName
                                        };
                                    }
                                    if (report.advanced) {
                                        acc[key].advanced = {
                                            bronze: report.advanced.bronze,
                                            silver: report.advanced.silver,
                                            gold: report.advanced.gold,
                                            platinum: report.advanced.platinum,
                                            total: report.advanced.total,
                                            agentName: report.advanced.agentName
                                        };
                                    }
                                    if (report.twoMonths) {
                                        acc[key].twoMonths = {
                                            bronze: report.twoMonths.bronze,
                                            silver: report.twoMonths.silver,
                                            gold: report.twoMonths.gold,
                                            platinum: report.twoMonths.platinum,
                                            total: report.twoMonths.total,
                                            agentName: report.twoMonths.agentName
                                        };
                                    }
                                }
                                return acc;
                            }, {}) : data.agentReports
                        };
                        dataString = JSON.stringify(data);
                    }
                }
                let archiveData = {
                    month_year: monthYear,
                    data: data,
                    created_at: new Date().toISOString(),
                    updated_at: new Date().toISOString()
                };
                if (tableName === 'analysis_archives' && analysis_type) {
                    archiveData.analysis_type = analysis_type;
                }
                let existingArchive;
                const checkPromise = tableName === 'analysis_archives' && analysis_type
                    ? supabaseClient
                        .from(tableName)
                        .select('id, data')
                        .eq('month_year', monthYear)
                        .eq('analysis_type', analysis_type)
                        .maybeSingle()
                    : supabaseClient
                        .from(tableName)
                        .select('id, data')
                        .eq('month_year', monthYear)
                        .maybeSingle();
                const checkTimeout = new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('Check timeout')), 10000)
                );
                try {
                    const { data: existing, error: checkError } = await Promise.race([checkPromise, checkTimeout]);
                    if (!checkError) existingArchive = existing;
                } catch (timeoutError) {
                }
                if (existingArchive) {
                    let mergedData = { ...data };
                    if (tableName === 'analysis_archives' && existingArchive.data) {
                        const newAnalysisType = analysis_type;
                        const newAgentNames = data.agentReports ? Object.keys(data.agentReports) : [];
                        const newAgentName = newAgentNames.length > 0 ? newAgentNames[0] : null;
                        
                        if (existingArchive.data.agentReports && data.agentReports) {
                            mergedData.agentReports = { ...existingArchive.data.agentReports };
                            
                            Object.keys(data.agentReports).forEach(agentName => {
                                const normalizedNewAgent = normalizeAgentName(agentName);
                                const normalizedExistingAgents = Object.keys(mergedData.agentReports).map(a => normalizeAgentName(a));
                                
                                let existingAgentName = null;
                                for (const existingAgent of Object.keys(mergedData.agentReports)) {
                                    if (normalizeAgentName(existingAgent) === normalizedNewAgent) {
                                        existingAgentName = existingAgent;
                                        break;
                                    }
                                }
                                
                                if (existingAgentName) {
                                    if (!mergedData.agentReports[existingAgentName]) {
                                        mergedData.agentReports[existingAgentName] = {};
                                    }
                                    
                                    if (data.agentReports[agentName].basic && newAnalysisType === 'basic') {
                                        mergedData.agentReports[existingAgentName].basic = data.agentReports[agentName].basic;
                                    }
                                    if (data.agentReports[agentName].advanced && newAnalysisType === 'advanced') {
                                        mergedData.agentReports[existingAgentName].advanced = data.agentReports[agentName].advanced;
                                    }
                                    if (data.agentReports[agentName].twoMonths && newAnalysisType === 'two_months') {
                                        mergedData.agentReports[existingAgentName].twoMonths = data.agentReports[agentName].twoMonths;
                                    }
                                } else {
                                    mergedData.agentReports[agentName] = { ...data.agentReports[agentName] };
                                }
                            });
                        } else if (data.agentReports) {
                            mergedData.agentReports = data.agentReports;
                        } else if (existingArchive.data.agentReports) {
                            mergedData.agentReports = existingArchive.data.agentReports;
                        }
                        
                        if (Array.isArray(existingArchive.data.details) && Array.isArray(data.details) && newAgentName) {
                            const normalizedNewAgent = normalizeAgentName(newAgentName);
                            
                            const otherAgentsDetails = existingArchive.data.details.filter(detail => {
                                const detailAgent = detail.agent || detail.Agent || detail.agentName || detail.AgentName || detail['Ø§Ø³Ù… Ø§Ù„ÙˆÙƒÙŠÙ„'] || detail['Ø§Ù„ÙˆÙƒÙŠÙ„'] || '';
                                return normalizeAgentName(detailAgent) !== normalizedNewAgent;
                            });
                            
                            const newDetailsMap = new Map();
                            data.details.forEach(detail => {
                                const detailKey = `${detail.username || ''}_${detail.subscription || ''}_${detail.date || detail.dateStr || detail.date1 || detail.date2 || detail.date3 || ''}_${detail.type || ''}`;
                                if (!newDetailsMap.has(detailKey)) {
                                    newDetailsMap.set(detailKey, detail);
                                }
                            });
                            
                            mergedData.details = [...otherAgentsDetails, ...Array.from(newDetailsMap.values())];
                        } else if (Array.isArray(data.details)) {
                            const detailsMap = new Map();
                            data.details.forEach(detail => {
                                const detailKey = `${detail.username || ''}_${detail.subscription || ''}_${detail.date || detail.dateStr || detail.date1 || detail.date2 || detail.date3 || ''}_${detail.type || ''}`;
                                if (!detailsMap.has(detailKey)) {
                                    detailsMap.set(detailKey, detail);
                                }
                            });
                            mergedData.details = Array.from(detailsMap.values());
                        } else if (Array.isArray(existingArchive.data.details)) {
                            mergedData.details = existingArchive.data.details;
                        }
                        
                        if (Array.isArray(existingArchive.data.data) && Array.isArray(data.data) && newAgentName) {
                            const normalizedNewAgent = normalizeAgentName(newAgentName);
                            
                            const otherAgentsData = existingArchive.data.data.filter(item => {
                                const itemAgent = item.agent || item.Agent || item.agentName || item.AgentName || item['ColumnF'] || item[5] || item['Ø§Ø³Ù… Ø§Ù„ÙˆÙƒÙŠÙ„'] || item['Ø§Ù„ÙˆÙƒÙŠÙ„'] || '';
                                return normalizeAgentName(itemAgent) !== normalizedNewAgent;
                            });
                            
                            const newDataMap = new Map();
                            data.data.forEach(item => {
                                const itemKey = JSON.stringify(item);
                                if (!newDataMap.has(itemKey)) {
                                    newDataMap.set(itemKey, item);
                                }
                            });
                            
                            mergedData.data = [...otherAgentsData, ...Array.from(newDataMap.values())];
                        } else if (Array.isArray(data.data)) {
                            const dataMap = new Map();
                            data.data.forEach(item => {
                                const itemKey = JSON.stringify(item);
                                if (!dataMap.has(itemKey)) {
                                    dataMap.set(itemKey, item);
                                }
                            });
                            mergedData.data = Array.from(dataMap.values());
                        } else if (Array.isArray(existingArchive.data.data)) {
                            mergedData.data = existingArchive.data.data;
                        }
                        
                        if (data.results) {
                            if (data.results.agentName && newAgentName && normalizeAgentName(data.results.agentName) === normalizeAgentName(newAgentName)) {
                                mergedData.results = data.results;
                            } else if (existingArchive.data.results) {
                                if (existingArchive.data.results.agentName && newAgentName && 
                                    normalizeAgentName(existingArchive.data.results.agentName) === normalizeAgentName(newAgentName)) {
                                    mergedData.results = data.results;
                                } else {
                                    mergedData.results = existingArchive.data.results;
                                }
                            } else {
                                mergedData.results = data.results;
                            }
                        } else if (existingArchive.data.results) {
                            mergedData.results = existingArchive.data.results;
                        }
                    }
                    const updateData = {
                        data: mergedData,
                        updated_at: new Date().toISOString()
                    };
                    let query = supabaseClient
                        .from(tableName)
                        .update(updateData)
                        .eq('id', existingArchive.id);
                    if (tableName === 'analysis_archives' && analysis_type) {
                        query = query.eq('analysis_type', analysis_type);
                    }
                    const updatePromise = query;
                    let timeoutDuration = 45000;
                    if (tableName === 'analysis_archives') {
                        if (analysis_type === 'advanced' || analysis_type === 'two_months') {
                            timeoutDuration = 120000; 
                        } else {
                            timeoutDuration = 60000; 
                        }
                    }
                    const updateTimeout = new Promise((_, reject) => 
                        setTimeout(() => reject(new Error('Update timeout')), timeoutDuration)
                    );
                    try {
                        const { error: updateError } = await Promise.race([updatePromise, updateTimeout]);
                        if (updateError) {
                            if (updateError.message && updateError.message.includes('timeout')) {
                                const dataSize = JSON.stringify(mergedData || data).length;
                                if (dataSize > 5000000) {
                                    console.warn(`âš  Update timeout for ${tableName}${analysis_type ? ' (' + analysis_type + ')' : ''} - Data too large (${(dataSize / 1024 / 1024).toFixed(2)}MB). Will retry on next operation.`);
                                } else {
                                    console.warn(`âš  Update timeout for ${tableName}${analysis_type ? ' (' + analysis_type + ')' : ''} - Data is too large for localStorage backup`);
                                    try {
                                        const backupKey = `${tableName}_${monthYear}${analysis_type ? '_' + analysis_type : ''}`;
                                        const backupData = mergedData || data;
                                        const backupString = JSON.stringify(backupData);
                                        if (backupString.length <= 2000000) {
                                            localStorage.setItem(backupKey, backupString);
                                        } else {
                                            console.warn(`âš  Backup data too large (${(backupString.length / 1024 / 1024).toFixed(2)}MB), skipping localStorage backup. Data will be saved on next successful database operation.`);
                                        }
                                    } catch (e) {
                                        if (e.name === 'QuotaExceededError') {
                                            console.warn(`âš  localStorage quota exceeded for backup. Data will be saved on next successful database operation.`);
                                        } else {
                                            console.error('Failed to save backup:', e);
                                        }
                                    }
                                }
                                return false;
                            }
                            throw updateError;
                        }
                    } catch (timeoutError) {
                        if (timeoutError.message && timeoutError.message.includes('timeout')) {
                            console.warn(`âš  Update timeout for ${tableName}${analysis_type ? ' (' + analysis_type + ')' : ''} - Data is too large for localStorage backup`);
                            try {
                                const backupKey = `${tableName}_${monthYear}${analysis_type ? '_' + analysis_type : ''}`;
                                const backupData = mergedData || data;
                                const backupString = JSON.stringify(backupData);
                                if (backupString.length <= 2000000) {
                                    localStorage.setItem(backupKey, backupString);
                                } else {
                                    console.warn(`âš  Backup data too large (${(backupString.length / 1024 / 1024).toFixed(2)}MB), skipping localStorage backup. Data will be saved on next successful database operation.`);
                                }
                            } catch (e) {
                                if (e.name === 'QuotaExceededError') {
                                    console.warn(`âš  localStorage quota exceeded for backup. Data will be saved on next successful database operation.`);
                                } else {
                                    console.error('Failed to save backup:', e);
                                }
                            }
                            return false;
                        }
                        throw timeoutError;
                    }
                } else {
                    const insertPromise = supabaseClient
                        .from(tableName)
                        .insert(archiveData);
                    let timeoutDuration = 45000;
                    if (tableName === 'analysis_archives') {
                        if (analysis_type === 'advanced' || analysis_type === 'two_months') {
                            timeoutDuration = 120000; 
                        } else {
                            timeoutDuration = 60000; 
                        }
                    }
                    const insertTimeout = new Promise((_, reject) => 
                        setTimeout(() => reject(new Error('Insert timeout')), timeoutDuration)
                    );
                    try {
                        const { error: insertError } = await Promise.race([insertPromise, insertTimeout]);
                        if (insertError) {
                            if (insertError.message && insertError.message.includes('timeout')) {
                                console.warn(`âš  Insert timeout for ${tableName}${analysis_type ? ' (' + analysis_type + ')' : ''} - Data will be saved in localStorage`);
                                try {
                                    const backupKey = `${tableName}_${monthYear}${analysis_type ? '_' + analysis_type : ''}`;
                                    localStorage.setItem(backupKey, JSON.stringify(data));
                                } catch (e) {
                                    console.error('Failed to save backup:', e);
                                }
                                return false;
                            }
                            throw insertError;
                        }
                    } catch (timeoutError) {
                        if (timeoutError.message && timeoutError.message.includes('timeout')) {
                            console.warn(`âš  Insert timeout for ${tableName}${analysis_type ? ' (' + analysis_type + ')' : ''} - Data is too large for localStorage backup`);
                            try {
                                const backupKey = `${tableName}_${monthYear}${analysis_type ? '_' + analysis_type : ''}`;
                                const backupString = JSON.stringify(data);
                                if (backupString.length <= 2000000) {
                                    localStorage.setItem(backupKey, backupString);
                                } else {
                                    console.warn(`âš  Backup data too large (${(backupString.length / 1024 / 1024).toFixed(2)}MB), skipping localStorage backup. Data will be saved on next successful database operation.`);
                                }
                            } catch (e) {
                                if (e.name === 'QuotaExceededError') {
                                    console.warn(`âš  localStorage quota exceeded for backup. Data will be saved on next successful database operation.`);
                                } else {
                                    console.error('Failed to save backup:', e);
                                }
                            }
                            return false;
                        }
                        throw timeoutError;
                    }
                }
                return true;
            } catch (error) {
                console.error(`âœ— Error saving to ${tableName}:`, error);
                try {
                    const backupKey = `${tableName}_${getCurrentMonthYear()}${options.analysis_type ? '_' + options.analysis_type : ''}`;
                    const backupString = JSON.stringify(data);
                    if (backupString.length <= 2000000) {
                        localStorage.setItem(backupKey, backupString);
                    } else {
                        console.warn(`âš  Backup data too large (${(backupString.length / 1024 / 1024).toFixed(2)}MB), skipping localStorage backup. Data will be saved on next successful database operation.`);
                    }
                } catch (e) {
                    if (e.name === 'QuotaExceededError') {
                        console.warn(`âš  localStorage quota exceeded for backup. Data will be saved on next successful database operation.`);
                    } else {
                        console.error('Failed to save backup:', e);
                    }
                }
                return false;
            } finally {
                saveLocks.delete(lockKey);
            }
        }
        async function loadDataFromDatabase() {
            if (!supabaseClient) {
                console.error('âœ— Supabase not initialized! Cannot load data.');
                alert('Ø®Ø·Ø£: Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ù…ØªØµÙ„Ø©. ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©.');
                return;
            }
            try {
                const monthYear = getCurrentMonthYear();
                let savedAgents = JSON.parse(localStorage.getItem('agentsList') || '[]');
                const { data: permanentAgentsArchive } = await supabaseClient
                    .from('agents_list')
                    .select('data')
                    .eq('month_year', '0000-00')
                    .maybeSingle();
                if (permanentAgentsArchive && permanentAgentsArchive.data) {
                    const permanentAgents = permanentAgentsArchive.data;
                    const agentsMap = new Map();
                    
                    permanentAgents.forEach(permanentAgent => {
                        agentsMap.set(permanentAgent.name, {
                            name: permanentAgent.name,
                            subName: permanentAgent.subName || '',
                            phone: permanentAgent.phone || '',
                            email: permanentAgent.email || '',
                            percentage: permanentAgent.percentage || 16
                        });
                    });
                    
                    savedAgents.forEach(agent => {
                        const existingAgent = agentsMap.get(agent.name);
                        if (existingAgent) {
                            if (!existingAgent.phone && agent.phone) existingAgent.phone = agent.phone;
                            if (!existingAgent.email && agent.email) existingAgent.email = agent.email;
                            if (!existingAgent.subName && agent.subName) existingAgent.subName = agent.subName;
                            if (existingAgent.percentage === undefined && agent.percentage !== undefined) {
                                existingAgent.percentage = agent.percentage;
                            }
                        } else {
                            agentsMap.set(agent.name, {
                                name: agent.name,
                                subName: agent.subName || '',
                                phone: agent.phone || '',
                                email: agent.email || '',
                                percentage: agent.percentage || 16
                            });
                        }
                    });
                    
                    agentsList = Array.from(agentsMap.values());
                    localStorage.setItem('agentsList', JSON.stringify(agentsList));
                } else {
                    agentsList = savedAgents;
                }
                const savedPercentages = localStorage.getItem('agentPercentages');
                const savedMonthYear = localStorage.getItem('agentPercentages_monthYear');
                if (savedPercentages) {
                    try {
                        const parsedPercentages = JSON.parse(savedPercentages);
                        if (parsedPercentages && Object.keys(parsedPercentages).length > 0) {
                            agentPercentages = parsedPercentages;
                            const percentageResults = document.getElementById('percentageResults');
                            if (percentageResults) {
                                percentageResults.classList.remove('hidden');
                            }
                            const percentageFileName = document.getElementById('percentageFileName');
                            if (percentageFileName) {
                                percentageFileName.textContent = savedMonthYear 
                                    ? `ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ­Ù„ÙŠÙ„ (${savedMonthYear})`
                                    : 'ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ­Ù„ÙŠÙ„';
                                percentageFileName.classList.remove('hidden');
                            }
                            renderPercentageTable();
                            if (supabaseClient) {
                                let percentagesArchive = null;
                                const { data: currentMonthArchive, error: currentMonthError } = await supabaseClient
                                    .from('agent_percentages')
                                    .select('data, month_year')
                                    .eq('month_year', monthYear)
                                    .maybeSingle();
                                if (!currentMonthError && currentMonthArchive && currentMonthArchive.data && Object.keys(currentMonthArchive.data).length > 0) {
                                    percentagesArchive = currentMonthArchive;
                                    Object.keys(percentagesArchive.data).forEach(agentName => {
                                        if (!agentPercentages[agentName]) {
                                            agentPercentages[agentName] = percentagesArchive.data[agentName];
                                        }
                                    });
                                    localStorage.setItem('agentPercentages', JSON.stringify(agentPercentages));
                                    localStorage.setItem('agentPercentages_monthYear', percentagesArchive.month_year || monthYear);
                                    renderPercentageTable();
                                } else {
                                    const currentDate = new Date();
                                    for (let i = 0; i < 3; i++) {
                                        const checkDate = new Date(currentDate.getFullYear(), currentDate.getMonth() - i, 1);
                                        const checkMonthYear = `${checkDate.getFullYear()}-${String(checkDate.getMonth() + 1).padStart(2, '0')}`;
                                        const { data: archiveData, error: archiveError } = await supabaseClient
                                            .from('agent_percentages')
                                            .select('data, month_year')
                                            .eq('month_year', checkMonthYear)
                                            .maybeSingle();
                                        if (!archiveError && archiveData && archiveData.data && Object.keys(archiveData.data).length > 0) {
                                            percentagesArchive = archiveData;
                                            Object.keys(percentagesArchive.data).forEach(agentName => {
                                                if (!agentPercentages[agentName]) {
                                                    agentPercentages[agentName] = percentagesArchive.data[agentName];
                                                }
                                            });
                                            localStorage.setItem('agentPercentages', JSON.stringify(agentPercentages));
                                            localStorage.setItem('agentPercentages_monthYear', percentagesArchive.month_year || checkMonthYear);
                                            renderPercentageTable();
                                            break;
                                        }
                                    }
                                }
                            }
                            return; 
                        }
                    } catch (e) {
                        console.error('Error parsing saved percentages from localStorage:', e);
                    }
                }
                let percentagesArchive = null;
                const { data: currentMonthArchive, error: currentMonthError } = await supabaseClient
                    .from('agent_percentages')
                    .select('data, month_year')
                    .eq('month_year', monthYear)
                    .maybeSingle();
                if (!currentMonthError && currentMonthArchive && currentMonthArchive.data && Object.keys(currentMonthArchive.data).length > 0) {
                    percentagesArchive = currentMonthArchive;
                } else {
                    const currentDate = new Date();
                    for (let i = 0; i < 3; i++) {
                        const checkDate = new Date(currentDate.getFullYear(), currentDate.getMonth() - i, 1);
                        const checkMonthYear = `${checkDate.getFullYear()}-${String(checkDate.getMonth() + 1).padStart(2, '0')}`;
                        const { data: archiveData, error: archiveError } = await supabaseClient
                            .from('agent_percentages')
                            .select('data, month_year')
                            .eq('month_year', checkMonthYear)
                            .maybeSingle();
                        if (!archiveError && archiveData && archiveData.data && Object.keys(archiveData.data).length > 0) {
                            percentagesArchive = archiveData;
                            break;
                        }
                    }
                }
                if (percentagesArchive && percentagesArchive.data) {
                    agentPercentages = percentagesArchive.data;
                    localStorage.setItem('agentPercentages', JSON.stringify(agentPercentages));
                    localStorage.setItem('agentPercentages_monthYear', percentagesArchive.month_year || monthYear);
                    if (Object.keys(agentPercentages).length > 0) {
                        const percentageResults = document.getElementById('percentageResults');
                        if (percentageResults) {
                            percentageResults.classList.remove('hidden');
                        }
                        const percentageFileName = document.getElementById('percentageFileName');
                        if (percentageFileName) {
                            percentageFileName.textContent = `ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (${percentagesArchive.month_year || monthYear})`;
                            percentageFileName.classList.remove('hidden');
                        }
                        renderPercentageTable();
                    }
                } else {
                    agentPercentages = {};
                }
                const { data: basicArchive } = await supabaseClient
                    .from('analysis_archives')
                    .select('data')
                    .eq('month_year', monthYear)
                    .eq('analysis_type', 'basic')
                    .maybeSingle();
                
                const { data: advancedArchive } = await supabaseClient
                    .from('analysis_archives')
                    .select('data')
                    .eq('month_year', monthYear)
                    .eq('analysis_type', 'advanced')
                    .maybeSingle();
                
                const { data: twoMonthsArchive } = await supabaseClient
                    .from('analysis_archives')
                    .select('data')
                    .eq('month_year', monthYear)
                    .eq('analysis_type', 'two_months')
                    .maybeSingle();
                
                if (basicArchive && basicArchive.data && basicArchive.data.agentReports) {
                    Object.keys(basicArchive.data.agentReports).forEach(agentName => {
                        if (!agentReports[agentName]) {
                            agentReports[agentName] = {};
                        }
                        if (basicArchive.data.agentReports[agentName].basic) {
                            agentReports[agentName].basic = basicArchive.data.agentReports[agentName].basic;
                        }
                    });
                }
                
                if (advancedArchive && advancedArchive.data && advancedArchive.data.agentReports) {
                    Object.keys(advancedArchive.data.agentReports).forEach(agentName => {
                        if (!agentReports[agentName]) {
                            agentReports[agentName] = {};
                        }
                        if (advancedArchive.data.agentReports[agentName].advanced) {
                            agentReports[agentName].advanced = advancedArchive.data.agentReports[agentName].advanced;
                        }
                    });
                }
                
                if (twoMonthsArchive && twoMonthsArchive.data && twoMonthsArchive.data.agentReports) {
                    Object.keys(twoMonthsArchive.data.agentReports).forEach(agentName => {
                        if (!agentReports[agentName]) {
                            agentReports[agentName] = {};
                        }
                        if (twoMonthsArchive.data.agentReports[agentName].twoMonths) {
                            agentReports[agentName].twoMonths = twoMonthsArchive.data.agentReports[agentName].twoMonths;
                        }
                    });
                }
                
                if (Object.keys(agentReports).length > 0) {
                    try {
                        const agentReportsString = JSON.stringify(agentReports);
                        if (agentReportsString.length <= 2000000) {
                            localStorage.setItem('agentReports', agentReportsString);
                        }
                    } catch (e) {
                        console.warn('Could not save agentReports to localStorage:', e);
                    }
                }
                
                basicData = null;
                basicDetails = [];
                advancedData = null;
                advancedDetails = [];
                twoMonthsData = null;
                twoMonthsDetails = [];
                const { data: activityArchive, error: activityError } = await supabaseClient
                    .from('activity_logs')
                    .select('data')
                    .eq('month_year', monthYear)
                    .maybeSingle();
                if (!activityError && activityArchive && activityArchive.data) {
                    activityLog = activityArchive.data;
                } else {
                    activityLog = [];
                }
            } catch (error) {
                console.error('âœ— Error loading from database:', error);
                alert('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ' + error.message);
            }
        }
        async function getArchiveForMonth(tableName, monthYear) {
            if (!supabaseClient) {
                console.error('âœ— Supabase not initialized');
                return null;
            }
            if (!monthYear || monthYear.length !== 7) {
                console.error(`âœ— Invalid month_year format: ${monthYear}`);
                return null;
            }
            try {
                let query = supabaseClient
                    .from(tableName)
                    .select('*')
                    .eq('month_year', monthYear);
                const { data, error } = await query.maybeSingle();
                if (error) {
                    console.error(`âœ— Error loading archive for ${tableName} - ${monthYear}:`, error);
                    console.error('Error details:', {
                        message: error.message,
                        details: error.details,
                        hint: error.hint,
                        code: error.code
                    });
                    return null;
                }
                if (!data) {
                    return null;
                }
                return data;
            } catch (error) {
                console.error(`âœ— Exception loading archive for ${tableName} - ${monthYear}:`, error);
                console.error('Exception details:', error);
                return null;
            }
        }
        async function listArchives(tableName) {
            if (!supabaseClient) return [];
            try {
                const { data, error } = await supabaseClient
                    .from(tableName)
                    .select('month_year, created_at, updated_at')
                    .order('month_year', { ascending: false });
                if (error) throw error;
                return data || [];
            } catch (error) {
                console.error(`âœ— Error listing archives:`, error);
                return [];
            }
        }
        async function searchInDatabase(searchQuery, options = {}) {
            if (!supabaseClient) {
                console.error('Supabase not initialized');
                return { results: [], error: 'Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ù…ØªØµÙ„Ø©' };
            }
            if (!searchQuery || searchQuery.trim().length < 2) {
                return { results: [], error: 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù†Øµ Ø¨Ø­Ø« (Ø­Ø±ÙÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„)' };
            }
            const query = searchQuery.trim().toLowerCase();
            const results = {
                agents: [],
                percentages: [],
                analyses: [],
                archives: [],
                activities: []
            };
            try {
                if (options.searchAgents !== false) {
                    const { data: agentsData, error: agentsError } = await supabaseClient
                        .from('agents_list')
                        .select('*')
                        .order('month_year', { ascending: false })
                        .limit(100);
                    if (!agentsError && agentsData) {
                        agentsData.forEach(archive => {
                            if (archive.data && Array.isArray(archive.data)) {
                                archive.data.forEach(agent => {
                                    const agentName = (agent.name || '').toLowerCase();
                                    if (agentName.includes(query)) {
                                        results.agents.push({
                                            month_year: archive.month_year,
                                            agent: agent,
                                            match: 'name'
                                        });
                                    }
                                });
                            }
                        });
                    }
                }
                if (options.searchPercentages !== false) {
                    const { data: percentagesData, error: percentagesError } = await supabaseClient
                        .from('agent_percentages')
                        .select('*')
                        .order('month_year', { ascending: false })
                        .limit(100);
                    if (!percentagesError && percentagesData) {
                        percentagesData.forEach(archive => {
                            if (archive.data && typeof archive.data === 'object') {
                                Object.keys(archive.data).forEach(agentName => {
                                    if (agentName.toLowerCase().includes(query)) {
                                        results.percentages.push({
                                            month_year: archive.month_year,
                                            agentName: agentName,
                                            data: archive.data[agentName]
                                        });
                                    }
                                });
                            }
                        });
                    }
                }
                if (options.searchAnalyses !== false) {
                    const { data: analysesData, error: analysesError } = await supabaseClient
                        .from('analysis_archives')
                        .select('*')
                        .order('month_year', { ascending: false })
                        .limit(100);
                    if (!analysesError && analysesData) {
                        analysesData.forEach(archive => {
                            if (archive.data) {
                                if (archive.data.details && Array.isArray(archive.data.details)) {
                                    const matchingDetails = archive.data.details.filter(detail => {
                                        const username = (detail.username || '').toLowerCase();
                                        const agent = (detail.agent || detail.Agent || detail.agentName || detail.AgentName || detail['Ø§Ø³Ù… Ø§Ù„ÙˆÙƒÙŠÙ„'] || detail['Ø§Ù„ÙˆÙƒÙŠÙ„'] || '').toLowerCase();
                                        const subscription = (detail.subscription || '').toLowerCase();
                                        return username.includes(query) || agent.includes(query) || subscription.includes(query);
                                    });
                                    if (matchingDetails.length > 0) {
                                        results.analyses.push({
                                            month_year: archive.month_year,
                                            analysis_type: archive.analysis_type,
                                            matches: matchingDetails.length,
                                            sample: matchingDetails[0]
                                        });
                                    }
                                }
                                if (archive.data.agentReports) {
                                    Object.keys(archive.data.agentReports).forEach(agentName => {
                                        if (agentName.toLowerCase().includes(query)) {
                                            results.analyses.push({
                                                month_year: archive.month_year,
                                                analysis_type: archive.analysis_type,
                                                agentName: agentName,
                                                report: archive.data.agentReports[agentName]
                                            });
                                        }
                                    });
                                }
                            }
                        });
                    }
                }
                if (options.searchActivities !== false) {
                    const { data: activitiesData, error: activitiesError } = await supabaseClient
                        .from('activity_logs')
                        .select('*')
                        .order('month_year', { ascending: false })
                        .limit(100);
                    if (!activitiesError && activitiesData) {
                        activitiesData.forEach(archive => {
                            if (archive.data && Array.isArray(archive.data)) {
                                const matchingActivities = archive.data.filter(activity => {
                                    const action = (activity.action || '').toLowerCase();
                                    const details = (activity.details || '').toLowerCase();
                                    const user = (activity.user || '').toLowerCase();
                                    return action.includes(query) || details.includes(query) || user.includes(query);
                                });
                                if (matchingActivities.length > 0) {
                                    results.activities.push({
                                        month_year: archive.month_year,
                                        matches: matchingActivities.length,
                                        activities: matchingActivities
                                    });
                                }
                            }
                        });
                    }
                }
                return { results, error: null };
            } catch (error) {
                console.error('Error searching database:', error);
                return { results: null, error: error.message };
            }
        }
        function searchInCurrentData(searchQuery) {
            if (!searchQuery || searchQuery.trim().length < 2) {
                return { results: [], error: 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù†Øµ Ø¨Ø­Ø« (Ø­Ø±ÙÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„)' };
            }
            const query = searchQuery.trim().toLowerCase();
            const results = {
                agents: [],
                percentages: [],
                basicDetails: [],
                advancedDetails: [],
                twoMonthsDetails: [],
                activities: []
            };
            if (Array.isArray(agentsList)) {
                agentsList.forEach(agent => {
                    const name = (agent.name || '').toLowerCase();
                    if (name.includes(query)) {
                        results.agents.push(agent);
                    }
                });
            }
            if (agentPercentages && typeof agentPercentages === 'object') {
                Object.keys(agentPercentages).forEach(agentName => {
                    if (agentName.toLowerCase().includes(query)) {
                        results.percentages.push({
                            agentName: agentName,
                            data: agentPercentages[agentName]
                        });
                    }
                });
            }
            if (Array.isArray(basicDetails)) {
                basicDetails.forEach(detail => {
                    const username = (detail.username || '').toLowerCase();
                    const agent = (detail.agent || detail.Agent || detail.agentName || detail.AgentName || detail['Ø§Ø³Ù… Ø§Ù„ÙˆÙƒÙŠÙ„'] || detail['Ø§Ù„ÙˆÙƒÙŠÙ„'] || '').toLowerCase();
                    if (username.includes(query) || agent.includes(query)) {
                        results.basicDetails.push(detail);
                    }
                });
            }
            if (Array.isArray(advancedDetails)) {
                advancedDetails.forEach(detail => {
                    const username = (detail.username || '').toLowerCase();
                    const agent = (detail.agent || detail.Agent || detail.agentName || detail.AgentName || detail['Ø§Ø³Ù… Ø§Ù„ÙˆÙƒÙŠÙ„'] || detail['Ø§Ù„ÙˆÙƒÙŠÙ„'] || '').toLowerCase();
                    if (username.includes(query) || agent.includes(query)) {
                        results.advancedDetails.push(detail);
                    }
                });
            }
            if (Array.isArray(twoMonthsDetails)) {
                twoMonthsDetails.forEach(detail => {
                    const username = (detail.username || '').toLowerCase();
                    const agent = (detail.agent || detail.Agent || detail.agentName || detail.AgentName || detail['Ø§Ø³Ù… Ø§Ù„ÙˆÙƒÙŠÙ„'] || detail['Ø§Ù„ÙˆÙƒÙŠÙ„'] || '').toLowerCase();
                    if (username.includes(query) || agent.includes(query)) {
                        results.twoMonthsDetails.push(detail);
                    }
                });
            }
            if (Array.isArray(activityLog)) {
                activityLog.forEach(activity => {
                    const action = (activity.action || '').toLowerCase();
                    const details = (activity.details || '').toLowerCase();
                    if (action.includes(query) || details.includes(query)) {
                        results.activities.push(activity);
                    }
                });
            }
            return { results, error: null };
        }
        let searchTimeout = null;
        async function handleGlobalSearch(event) {
            const query = event.target.value.trim();
            const resultsDiv = document.getElementById('searchResults');
            if (query.length < 2) {
                resultsDiv.classList.remove('active');
                return;
            }
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(async () => {
                const currentResults = searchInCurrentData(query);
                const dbResults = await searchInDatabase(query, {
                    searchAgents: true,
                    searchPercentages: true,
                    searchAnalyses: true,
                    searchActivities: true
                });
                displayQuickSearchResults(currentResults, dbResults, query);
            }, 300);
        }
        function showSearchResults() {
            const input = document.getElementById('globalSearchInput');
            const resultsDiv = document.getElementById('searchResults');
            if (input.value.trim().length >= 2) {
                resultsDiv.classList.add('active');
            }
        }
        function displayQuickSearchResults(currentResults, dbResults, query) {
            const resultsDiv = document.getElementById('searchResults');
            let html = '';
            const totalResults = 
                (currentResults.results.agents.length || 0) +
                (currentResults.results.percentages.length || 0) +
                (currentResults.results.basicDetails.length || 0) +
                (currentResults.results.advancedDetails.length || 0) +
                (currentResults.results.twoMonthsDetails.length || 0) +
                (dbResults.results?.agents.length || 0) +
                (dbResults.results?.percentages.length || 0) +
                (dbResults.results?.analyses.length || 0);
            if (totalResults === 0) {
                html = '<div style="padding: 10px; text-align: center; color: var(--text-secondary);">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</div>';
            } else {
                if (currentResults.results.agents.length > 0) {
                    currentResults.results.agents.slice(0, 3).forEach(agent => {
                        html += `<div class="search-result-item" onclick="switchTab('agents'); highlightAgent('${agent.name}')">
                            <div class="result-type">ÙˆÙƒÙŠÙ„ - Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ</div>
                            <div class="result-title">${agent.name}</div>
                        </div>`;
                    });
                }
                if (dbResults.results?.agents.length > 0) {
                    dbResults.results.agents.slice(0, 3).forEach(item => {
                        html += `<div class="search-result-item" onclick="switchTab('archive'); loadArchiveByAgent('${item.month_year}')">
                            <div class="result-type">ÙˆÙƒÙŠÙ„ - ${item.month_year}</div>
                            <div class="result-title">${item.agent.name}</div>
                        </div>`;
                    });
                }
                if (totalResults > 6) {
                    html += `<div class="search-result-item" style="text-align: center; font-weight: 600; color: var(--text-secondary);">
                        ... Ùˆ ${totalResults - 6} Ù†ØªÙŠØ¬Ø© Ø£Ø®Ø±Ù‰
                    </div>`;
                }
            }
            resultsDiv.innerHTML = html;
            resultsDiv.classList.add('active');
        }
        async function refreshArchivesList() {
            if (!supabaseClient) {
                document.getElementById('archivesList').innerHTML = '<p style="color: var(--text-secondary);">Supabase ØºÙŠØ± Ù…ØªØµÙ„</p>';
                return;
            }
            try {
                const allArchives = {};
                const agentCounts = {};
                const tables = ['agents_list', 'agent_percentages', 'analysis_archives', 'activity_logs'];
                for (const table of tables) {
                    const archives = await listArchives(table);
                    for (const archive of archives) {
                        if (!allArchives[archive.month_year]) {
                            allArchives[archive.month_year] = [];
                            agentCounts[archive.month_year] = 0;
                        }
                        allArchives[archive.month_year].push(table);
                            }
                            }
                const months = Object.keys(allArchives).filter(month => month !== '0000-00').sort().reverse();
                const container = document.getElementById('archivesList');
                if (months.length === 0) {
                    container.innerHTML = '<p style="color: var(--text-secondary);">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø±Ø´ÙŠÙØ§Øª Ù…ØªØ§Ø­Ø©</p>';
                    return;
                }
                const realCounts = {};
                for (const month of months) {
                    try {
                        const percentagesArchive = await getArchiveForMonth('agent_percentages', month);
                        const agentsListArchive = await getArchiveForMonth('agents_list', month);
                        const { data: basicArchiveData } = await supabaseClient.from('analysis_archives').select('*').eq('month_year', month).eq('analysis_type', 'basic').maybeSingle();
                        const { data: advancedArchiveData } = await supabaseClient.from('analysis_archives').select('*').eq('month_year', month).eq('analysis_type', 'advanced').maybeSingle();
                        const { data: twoMonthsArchiveData } = await supabaseClient.from('analysis_archives').select('*').eq('month_year', month).eq('analysis_type', 'two_months').maybeSingle();
                        const basicArchive = basicArchiveData ? { data: basicArchiveData.data } : null;
                        const advancedArchive = advancedArchiveData ? { data: advancedArchiveData.data } : null;
                        const twoMonthsArchive = twoMonthsArchiveData ? { data: twoMonthsArchiveData.data } : null;
                        let percentages = {};
                        if (percentagesArchive && percentagesArchive.data && typeof percentagesArchive.data === 'object') {
                            Object.keys(percentagesArchive.data).forEach(agentName => {
                                const normalized = normalizeAgentName(agentName);
                                if (!percentages[normalized]) {
                                    percentages[normalized] = {
                                        ...percentagesArchive.data[agentName],
                                        originalName: agentName
                                    };
                                }
                            });
                        }
                        if (agentsListArchive && agentsListArchive.data && Array.isArray(agentsListArchive.data)) {
                            agentsListArchive.data.forEach(agent => {
                                if (agent && agent.name) {
                                    const normalized = normalizeAgentName(agent.name);
                                    if (!percentages[normalized]) {
                                        percentages[normalized] = {
                                            originalName: agent.name,
                                            percentage: agent.percentage || 15,
                                            iqT: 0,
                                            iqP: 0,
                                            iqG: 0,
                                            iqS: 0,
                                            iqB: 0,
                                            agentPercentageAmount: 0,
                                            netPercentage: 0
                                        };
                                    }
                                }
                            });
                        }
                        const agentNames = Object.keys(percentages);
                        const checkAgentHasAnalyses = (normalizedName, displayName) => {
                            const possibleNames = [displayName, normalizedName];
                            if (percentagesArchive && percentagesArchive.data) {
                                Object.keys(percentagesArchive.data).forEach(name => {
                                    if (normalizeAgentName(name) === normalizedName) {
                                        possibleNames.push(name);
                                    }
                                });
                            }
                            if (agentsListArchive && agentsListArchive.data && Array.isArray(agentsListArchive.data)) {
                                agentsListArchive.data.forEach(agent => {
                                    if (agent && agent.name && normalizeAgentName(agent.name) === normalizedName) {
                                        possibleNames.push(agent.name);
                                    }
                                });
                            }
                            const nameMatches = (name) => {
                                if (!name) return false;
                                const normalizedNameToCheck = normalizeAgentName(name);
                                return possibleNames.some(pn => normalizeAgentName(pn) === normalizedNameToCheck);
                            };
                            const archives = [basicArchive, advancedArchive, twoMonthsArchive];
                            for (const archive of archives) {
                                if (archive && archive.data) {
                                    if (archive.data.agentReports && typeof archive.data.agentReports === 'object') {
                                        for (const archiveAgentName of Object.keys(archive.data.agentReports)) {
                                            if (nameMatches(archiveAgentName)) {
                                                const agentReport = archive.data.agentReports[archiveAgentName];
                                                if (agentReport && (agentReport.basic || agentReport.advanced || agentReport.twoMonths || agentReport.two_months)) {
                                                    return true;
                                                }
                                            }
                                        }
                                    }
                                    if (Array.isArray(archive.data.details) && archive.data.details.length > 0) {
                                        for (const detail of archive.data.details) {
                                            const agent = detail.agent || detail.Agent || detail.agentName || detail.AgentName || detail['Ø§Ø³Ù… Ø§Ù„ÙˆÙƒÙŠÙ„'] || detail['Ø§Ù„ÙˆÙƒÙŠÙ„'];
                                            if (nameMatches(agent)) {
                                                return true;
                                            }
                                        }
                                    }
                                }
                            }
                            return false;
                        };
                        const filteredCount = agentNames.filter(normalizedName => {
                            const agentData = percentages[normalizedName];
                            const displayName = agentData.originalName || normalizedName;
                            const hasPercentageData = agentData.percentage !== undefined && 
                                                     agentData.percentage !== null && 
                                                     agentData.percentage > 0 &&
                                                     (agentData.agentPercentageAmount > 0 || 
                                                      agentData.iqT > 0 || 
                                                      (agentData.iqP + agentData.iqG + agentData.iqS + agentData.iqB) > 0);
                            const hasAnalyses = checkAgentHasAnalyses(normalizedName, displayName);
                            return hasPercentageData && hasAnalyses;
                        }).length;
                        realCounts[month] = filteredCount;
                    } catch (err) {
                        console.error(`Error calculating count for ${month}:`, err);
                        realCounts[month] = 0;
                    }
                }
                container.innerHTML = months.map(month => {
                    const count = realCounts[month] || 0;
                    return `
                        <div style="background: var(--card-bg); padding: 15px; border-radius: 8px; border: 1px solid var(--border-color); cursor: pointer;" 
                             onclick="loadArchiveByAgent('${month}')">
                            <div style="font-weight: 600; margin-bottom: 5px;">${month}</div>
                            <div style="font-size: 0.85rem; color: var(--text-secondary);">${count} ÙˆÙƒÙŠÙ„</div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error refreshing archives list:', error);
                document.getElementById('archivesList').innerHTML = '<p style="color: red;">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø±Ø´ÙŠÙØ§Øª</p>';
            }
        }
        function normalizeAgentName(agentName) {
            if (!agentName) return '';
            return agentName.toLowerCase().replace(/[_-]/g, '-');
        }
        async function loadArchiveByAgent(monthYear = null) {
            if (!supabaseClient) {
                document.getElementById('archiveContent').innerHTML = '<p style="color: red;">Supabase ØºÙŠØ± Ù…ØªØµÙ„</p>';
                return;
            }
            if (!monthYear) {
                const monthInput = document.getElementById('archiveMonthSelect');
                if (monthInput && monthInput.value) {
                    monthYear = monthInput.value.substring(0, 7);
                } else {
                    monthYear = getCurrentMonthYear();
                }
            }
            try {
                const container = document.getElementById('archiveContent');
                container.innerHTML = '<p style="text-align: center;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø±Ø´ÙŠÙ...</p>';
                const percentagesArchive = await getArchiveForMonth('agent_percentages', monthYear);
                const agentsListArchive = await getArchiveForMonth('agents_list', monthYear);
                const { data: basicArchiveData, error: basicError } = await supabaseClient.from('analysis_archives').select('*').eq('month_year', monthYear).eq('analysis_type', 'basic').maybeSingle();
                const { data: advancedArchiveData, error: advancedError } = await supabaseClient.from('analysis_archives').select('*').eq('month_year', monthYear).eq('analysis_type', 'advanced').maybeSingle();
                const { data: twoMonthsArchiveData, error: twoMonthsError } = await supabaseClient.from('analysis_archives').select('*').eq('month_year', monthYear).eq('analysis_type', 'two_months').maybeSingle();
                const basicArchive = { 
                    data: basicArchiveData ? basicArchiveData.data : null, 
                    error: basicError,
                    raw: basicArchiveData 
                };
                const advancedArchive = { 
                    data: advancedArchiveData ? advancedArchiveData.data : null, 
                    error: advancedError,
                    raw: advancedArchiveData 
                };
                const twoMonthsArchive = { 
                    data: twoMonthsArchiveData ? twoMonthsArchiveData.data : null, 
                    error: twoMonthsError,
                    raw: twoMonthsArchiveData 
                };
                let percentages = {};
                const agentsListMap = {};
                const normalizedToOriginal = {}; 
                if (percentagesArchive && percentagesArchive.data && typeof percentagesArchive.data === 'object' && Object.keys(percentagesArchive.data).length > 0) {
                    Object.keys(percentagesArchive.data).forEach(agentName => {
                        const normalized = normalizeAgentName(agentName);
                        normalizedToOriginal[normalized] = agentName;
                        if (!percentages[normalized]) {
                            percentages[normalized] = {
                                ...percentagesArchive.data[agentName],
                                originalName: agentName 
                            };
                        } else {
                            const existing = percentages[normalized];
                            const newData = percentagesArchive.data[agentName];
                            if (newData.percentage !== undefined && newData.percentage !== null) {
                                existing.percentage = newData.percentage;
                            }
                            existing.originalName = agentName;
                            Object.keys(newData).forEach(key => {
                                if (key !== 'percentage' && key !== 'originalName' && newData[key] !== undefined && newData[key] !== null) {
                                    if (Array.isArray(newData[key])) {
                                        existing[key] = newData[key];
                                    } else if (typeof newData[key] === 'object' && newData[key] !== null) {
                                        existing[key] = { ...existing[key], ...newData[key] };
                                    } else {
                                        existing[key] = newData[key];
                                    }
                                }
                            });
                        }
                    });
                }
                if (agentsListArchive && agentsListArchive.data && Array.isArray(agentsListArchive.data) && agentsListArchive.data.length > 0) {
                    agentsListArchive.data.forEach(agent => {
                        if (agent && agent.name) {
                            const normalized = normalizeAgentName(agent.name);
                            if (!normalizedToOriginal[normalized]) {
                                normalizedToOriginal[normalized] = agent.name;
                            }
                            agentsListMap[normalized] = agent;
                            if (!percentages[normalized]) {
                                percentages[normalized] = {
                                    originalName: agent.name,
                                    percentage: agent.percentage || 15, 
                                    iqT: 0,
                                    iqP: 0,
                                    iqG: 0,
                                    iqS: 0,
                                    iqB: 0,
                                    agentPercentageAmount: 0,
                                    netPercentage: 0,
                                    offers: agent.offers || {},
                                    details: agent.details || {}
                                };
                            } else {
                                if (agent.offers) {
                                    percentages[normalized].offers = { ...percentages[normalized].offers, ...agent.offers };
                                }
                                if (agent.details) {
                                    percentages[normalized].details = { ...percentages[normalized].details, ...agent.details };
                                }
                                if (!percentages[normalized].percentage && agent.percentage) {
                                    percentages[normalized].percentage = agent.percentage;
                                }
                            }
                        }
                    });
                }
                if (Object.keys(percentages).length === 0) {
                    const displayMonth = monthYear === '0000-00' ? 'Ù‚Ø§Ø¦Ù…Ø© Ø¯Ø§Ø¦Ù…Ø©' : monthYear;
                    container.innerHTML = `<h4 style="margin-bottom: 20px; text-align: center; color: var(--primary-color);">Ø£Ø±Ø´ÙŠÙ ${displayMonth}</h4>
                        <div style="text-align: center; color: var(--text-secondary); padding: 20px;">
                            <p style="margin-bottom: 15px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</p>
                        </div>`;
                    return;
                }
                const agentNames = Object.keys(percentages).sort();
                const displayMonth = monthYear === '0000-00' ? 'Ù‚Ø§Ø¦Ù…Ø© Ø¯Ø§Ø¦Ù…Ø©' : monthYear;
                const checkAgentHasAnalyses = (normalizedName, displayName) => {
                        const possibleNames = [displayName, normalizedName];
                        if (percentagesArchive && percentagesArchive.data) {
                            Object.keys(percentagesArchive.data).forEach(name => {
                                if (normalizeAgentName(name) === normalizedName) {
                                    possibleNames.push(name);
                                }
                            });
                        }
                        if (agentsListArchive && agentsListArchive.data && Array.isArray(agentsListArchive.data)) {
                            agentsListArchive.data.forEach(agent => {
                                if (agent && agent.name && normalizeAgentName(agent.name) === normalizedName) {
                                    possibleNames.push(agent.name);
                                }
                            });
                        }
                        const nameMatches = (name) => {
                            if (!name) return false;
                            const normalizedNameToCheck = normalizeAgentName(name);
                            return possibleNames.some(pn => normalizeAgentName(pn) === normalizedNameToCheck);
                        };
                        if (basicArchive && basicArchive.data) {
                            if (basicArchive.data.agentReports && typeof basicArchive.data.agentReports === 'object') {
                                for (const archiveAgentName of Object.keys(basicArchive.data.agentReports)) {
                                    if (nameMatches(archiveAgentName)) {
                                        const agentReport = basicArchive.data.agentReports[archiveAgentName];
                                        if (agentReport && agentReport.basic) {
                                            if (typeof agentReport.basic === 'object' && Object.keys(agentReport.basic).length > 0) {
                                                return true;
                                            }
                                            if (agentReport.basic) {
                                                return true;
                                            }
                                        }
                                    }
                                }
                            }
                            if (basicArchive.data.results) {
                                if (typeof basicArchive.data.results === 'object') {
                                    if (basicArchive.data.results.agentName && nameMatches(basicArchive.data.results.agentName)) {
                                        return true;
                                    }
                                    for (const key of Object.keys(basicArchive.data.results)) {
                                        if (nameMatches(key)) {
                                            const result = basicArchive.data.results[key];
                                            if (result && (result.basic || (typeof result === 'object' && Object.keys(result).length > 0))) {
                                                return true;
                                            }
                                        }
                                    }
                                }
                            }
                            if (Array.isArray(basicArchive.data.details) && basicArchive.data.details.length > 0) {
                                for (const detail of basicArchive.data.details) {
                                    const agent = detail.agent || detail.Agent || detail.agentName || detail.AgentName || detail['Ø§Ø³Ù… Ø§Ù„ÙˆÙƒÙŠÙ„'] || detail['Ø§Ù„ÙˆÙƒÙŠÙ„'];
                                    if (nameMatches(agent)) {
                                        return true;
                                    }
                                }
                            }
                            if (Array.isArray(basicArchive.data.data) && basicArchive.data.data.length > 0) {
                                for (const item of basicArchive.data.data) {
                                    const agent = item.agent || item.Agent || item.agentName || item.AgentName || item['Ø§Ø³Ù… Ø§Ù„ÙˆÙƒÙŠÙ„'] || item['Ø§Ù„ÙˆÙƒÙŠÙ„'];
                                    if (nameMatches(agent)) {
                                        return true;
                                    }
                                }
                            }
                        }
                        if (advancedArchive && advancedArchive.data) {
                            if (advancedArchive.data.agentReports && typeof advancedArchive.data.agentReports === 'object') {
                                for (const archiveAgentName of Object.keys(advancedArchive.data.agentReports)) {
                                    if (nameMatches(archiveAgentName)) {
                                        const agentReport = advancedArchive.data.agentReports[archiveAgentName];
                                        if (agentReport && agentReport.advanced) {
                                            if (typeof agentReport.advanced === 'object' && Object.keys(agentReport.advanced).length > 0) {
                                                return true;
                                            }
                                            if (agentReport.advanced) {
                                                return true;
                                            }
                                        }
                                    }
                                }
                            }
                            if (advancedArchive.data.results) {
                                if (typeof advancedArchive.data.results === 'object') {
                                    if (advancedArchive.data.results.agentName && nameMatches(advancedArchive.data.results.agentName)) {
                                        return true;
                                    }
                                    for (const key of Object.keys(advancedArchive.data.results)) {
                                        if (nameMatches(key)) {
                                            const result = advancedArchive.data.results[key];
                                            if (result && (result.advanced || (typeof result === 'object' && Object.keys(result).length > 0))) {
                                                return true;
                                            }
                                        }
                                    }
                                }
                            }
                            if (Array.isArray(advancedArchive.data.details) && advancedArchive.data.details.length > 0) {
                                for (const detail of advancedArchive.data.details) {
                                    const agent = detail.agent || detail.Agent || detail.agentName || detail.AgentName || detail['Ø§Ø³Ù… Ø§Ù„ÙˆÙƒÙŠÙ„'] || detail['Ø§Ù„ÙˆÙƒÙŠÙ„'];
                                    if (nameMatches(agent)) {
                                        return true;
                                    }
                                }
                            }
                            if (Array.isArray(advancedArchive.data.data) && advancedArchive.data.data.length > 0) {
                                for (const item of advancedArchive.data.data) {
                                    const agent = item.agent || item.Agent || item.agentName || item.AgentName || item['Ø§Ø³Ù… Ø§Ù„ÙˆÙƒÙŠÙ„'] || item['Ø§Ù„ÙˆÙƒÙŠÙ„'];
                                    if (nameMatches(agent)) {
                                        return true;
                                    }
                                }
                            }
                        }
                        if (twoMonthsArchive && twoMonthsArchive.data) {
                            if (twoMonthsArchive.data.agentReports && typeof twoMonthsArchive.data.agentReports === 'object') {
                                for (const archiveAgentName of Object.keys(twoMonthsArchive.data.agentReports)) {
                                    if (nameMatches(archiveAgentName)) {
                                        const agentReport = twoMonthsArchive.data.agentReports[archiveAgentName];
                                        const twoMonthsData = agentReport.twoMonths || agentReport.two_months;
                                        if (agentReport && twoMonthsData) {
                                            if (typeof twoMonthsData === 'object' && Object.keys(twoMonthsData).length > 0) {
                                                return true;
                                            }
                                            if (twoMonthsData) {
                                                return true;
                                            }
                                        }
                                    }
                                }
                            }
                            if (twoMonthsArchive.data.results) {
                                if (typeof twoMonthsArchive.data.results === 'object') {
                                    if (twoMonthsArchive.data.results.agentName && nameMatches(twoMonthsArchive.data.results.agentName)) {
                                        return true;
                                    }
                                    for (const key of Object.keys(twoMonthsArchive.data.results)) {
                                        if (nameMatches(key)) {
                                            const result = twoMonthsArchive.data.results[key];
                                            if (result && (result.twoMonths || result.two_months || (typeof result === 'object' && Object.keys(result).length > 0))) {
                                                return true;
                                            }
                                        }
                                    }
                                }
                            }
                            if (Array.isArray(twoMonthsArchive.data.details) && twoMonthsArchive.data.details.length > 0) {
                                for (const detail of twoMonthsArchive.data.details) {
                                    const agent = detail.agent || detail.Agent || detail.agentName || detail.AgentName || detail['Ø§Ø³Ù… Ø§Ù„ÙˆÙƒÙŠÙ„'] || detail['Ø§Ù„ÙˆÙƒÙŠÙ„'];
                                    if (nameMatches(agent)) {
                                        return true;
                                    }
                                }
                            }
                            if (Array.isArray(twoMonthsArchive.data.data) && twoMonthsArchive.data.data.length > 0) {
                                for (const item of twoMonthsArchive.data.data) {
                                    const agent = item.agent || item.Agent || item.agentName || item.AgentName || item['Ø§Ø³Ù… Ø§Ù„ÙˆÙƒÙŠÙ„'] || item['Ø§Ù„ÙˆÙƒÙŠÙ„'];
                                    if (nameMatches(agent)) {
                                        return true;
                                    }
                                }
                            }
                        }
                        return false;
                    };
                const agentsListContainer = document.getElementById('archiveAgentsList');
                const agentsListContent = document.getElementById('archiveAgentsListContent');
                const archiveContent = document.getElementById('archiveContent');
                if (agentsListContainer && agentsListContent) {
                    agentsListContainer.style.display = 'block';
                    archiveContent.style.display = 'none';
                    const filteredAgents = agentNames.filter(normalizedName => {
                        const agentData = percentages[normalizedName];
                        const displayName = agentData.originalName || normalizedName;
                        const hasPercentageData = agentData.percentage !== undefined && 
                                                 agentData.percentage !== null && 
                                                 agentData.percentage > 0 &&
                                                 (agentData.agentPercentageAmount > 0 || 
                                                  agentData.iqT > 0 || 
                                                  (agentData.iqP + agentData.iqG + agentData.iqS + agentData.iqB) > 0);
                        const hasAnalyses = checkAgentHasAnalyses(normalizedName, displayName);
                        const shouldInclude = hasPercentageData && hasAnalyses;
                        if (!shouldInclude) {
                        }
                        return shouldInclude;
                    });
                    let agentsListHTML = `<h4 style="margin-bottom: 15px; text-align: center; color: var(--primary-color);">Ø£Ø±Ø´ÙŠÙ ${displayMonth} - ${filteredAgents.length} ÙˆÙƒÙŠÙ„</h4>`;
                    if (filteredAgents.length === 0) {
                        agentsListHTML += `
                            <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                                <p style="font-size: 1.1rem; margin-bottom: 10px;">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆÙƒÙ„Ø§Ø¡ Ù„Ø¯ÙŠÙ‡Ù… Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø³Ø¨Ø© ÙˆØªØ­Ù„ÙŠÙ„Ø§Øª ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø£Ø±Ø´ÙŠÙ</p>
                                <p style="font-size: 0.9rem;">ÙŠØªÙ… Ø¹Ø±Ø¶ Ø§Ù„ÙˆÙƒÙ„Ø§Ø¡ Ø§Ù„Ø°ÙŠÙ† Ù„Ø¯ÙŠÙ‡Ù… Ù†Ø³Ø¨Ø© ÙˆØªØ­Ù„ÙŠÙ„Ø§Øª Ø¹Ø±ÙˆØ¶ ÙÙ‚Ø·</p>
                            </div>
                        `;
                    } else {
                        filteredAgents.forEach(normalizedName => {
                            const agentData = percentages[normalizedName];
                            const displayName = agentData.originalName || normalizedName;
                            const hasAnalyses = checkAgentHasAnalyses(normalizedName, displayName);
                            agentsListHTML += `
                                <div class="archive-agent-card" onclick="showArchiveAgentDetails('${normalizedName}', '${monthYear}')" 
                                 style="background: var(--bg-secondary); padding: 15px; border-radius: 8px; border: 2px solid var(--border-color); cursor: pointer; transition: all 0.3s;"
                                 onmouseover="this.style.borderColor='var(--primary-color)'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.1)'"
                                 onmouseout="this.style.borderColor='var(--border-color)'; this.style.transform='translateY(0)'; this.style.boxShadow='none'"
                                     data-agent-name="${displayName}">
                                    <div style="font-weight: 700; font-size: 1.1rem; color: var(--primary-color); margin-bottom: 8px;">${displayName}</div>
                                <div style="font-size: 0.9rem; color: var(--text-secondary);">
                                    ${agentData.percentage ? `<div>Ø§Ù„Ù†Ø³Ø¨Ø©: ${agentData.percentage}%</div>` : ''}
                                    ${agentData.agentPercentageAmount ? `<div>Ø§Ù„Ù…Ø¨Ù„Øº: ${formatNumber(agentData.agentPercentageAmount)} Ø¯.Ø¹</div>` : ''}
                                        <div style="color: #28a745; margin-top: 5px;">âœ“ Ù„Ø¯ÙŠÙ‡ ØªØ­Ù„ÙŠÙ„Ø§Øª</div>
                                </div>
                            </div>
                        `;
                    });
                    }
                    agentsListContent.innerHTML = agentsListHTML;
                }
                window.currentArchiveMonthYear = monthYear;
                const filteredAgentsForStorage = agentNames.filter(normalizedName => {
                    const agentData = percentages[normalizedName];
                    const displayName = agentData.originalName || normalizedName;
                    const hasPercentageData = agentData.percentage !== undefined && 
                                             agentData.percentage !== null && 
                                             agentData.percentage > 0 &&
                                             (agentData.agentPercentageAmount > 0 || 
                                              agentData.iqT > 0 || 
                                              (agentData.iqP + agentData.iqG + agentData.iqS + agentData.iqB) > 0);
                    const hasAnalyses = checkAgentHasAnalyses(normalizedName, displayName);
                    return hasPercentageData && hasAnalyses;
                });
                window.currentArchiveAgentNames = filteredAgentsForStorage;
                window.currentArchivePercentages = percentages;
                window.normalizedToOriginal = normalizedToOriginal;
                window.currentBasicArchive = basicArchive;
                window.currentAdvancedArchive = advancedArchive;
                window.currentTwoMonthsArchive = twoMonthsArchive;
                window.currentPercentagesArchive = percentagesArchive;
                return;
                let html = `<h4 style="margin-bottom: 20px; text-align: center; color: var(--primary-color);">Ø£Ø±Ø´ÙŠÙ ${displayMonth} </h4>`;
                for (const agentName of agentNames) {
                    const agentData = percentages[agentName];
                    html += `<div style="margin-bottom: 30px; border: 2px solid var(--primary-color); border-radius: 12px; padding: 20px; background: var(--card-bg); box-shadow: var(--shadow-md);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid var(--primary-color); padding-bottom: 10px;">
                            <h3 style="margin: 0; color: var(--primary-color); font-size: 1.3rem;">${agentName}</h3>
                            <div style="display: flex; gap: 10px;">
                            <button class="btn btn-success" onclick="exportAgentArchiveReport('${agentName}', '${monthYear}')" style="font-size: 0.9rem; padding: 8px 15px;">
                                    ðŸ“¥ ØªØµØ¯ÙŠØ± Excel
                            </button>
                                <button class="btn btn-danger" onclick="printArchivePDF('${agentName}', '${monthYear}')" style="font-size: 0.9rem; padding: 8px 15px; background-color: #dc3545; border-color: #dc3545;">
                                    ðŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© PDF
                                </button>
                            </div>
                        </div>`;
                    html += `<div style="margin-bottom: 20px; background: var(--bg-secondary); padding: 15px; border-radius: 8px; border: 1px solid var(--border-color);">
                        <h4 style="margin-bottom: 15px; color: var(--primary-color); border-bottom: 1px solid var(--border-color); padding-bottom: 8px;">Ù…Ù„Ø®Øµ Ø§Ù„Ù†Ø³Ø¨ ÙˆØ§Ù„ØªÙØ§ØµÙŠÙ„</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 15px;">
                            <div><strong>Ø§Ù„Ù†Ø³Ø¨Ø© :</strong> ${agentData.percentage || 0}%</div>
                            <div><strong>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙƒÙ„ÙŠ:</strong> ${formatNumber(agentData.iqT || 0)} Ø¯.Ø¹</div>
                            <div><strong>Ù†Ø³Ø¨Ø© Ø§Ù„ÙˆÙƒÙŠÙ„:</strong> ${formatNumber(agentData.agentPercentageAmount || 0)} Ø¯.Ø¹</div>
                            ${agentData.deductions ? `<div style="color: #dc3545;"><strong>Ø§Ù„Ø§Ø³ØªÙ‚Ø·Ø§Ø¹:</strong> ${formatNumber(agentData.deductions)} Ø¯.Ø¹</div>` : '<div><strong>Ø§Ù„Ø§Ø³ØªÙ‚Ø·Ø§Ø¹:</strong> 0 Ø¯.Ø¹</div>'}
                            ${agentData.penalties ? `<div style="color: #dc3545;"><strong>Ø§Ù„ØºØ±Ø§Ù…Ø©:</strong> ${formatNumber(agentData.penalties)} Ø¯.Ø¹</div>` : '<div><strong>Ø§Ù„ØºØ±Ø§Ù…Ø©:</strong> 0 Ø¯.Ø¹</div>'}
                            <div style="font-weight: 700; color: var(--primary-color); font-size: 1.1rem;"><strong>Ø§Ù„ØµØ§ÙÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ:</strong> ${formatNumber(agentData.netPercentage || 0)} Ø¯.Ø¹</div>
                        </div>`;
                        if (agentData.iqP || agentData.iqG || agentData.iqS || agentData.iqB || agentData.countP || agentData.countG || agentData.countS || agentData.countB) {
                            const totalCount = (Number(agentData.countB) || 0) + (Number(agentData.countG) || 0) + (Number(agentData.countS) || 0) + (Number(agentData.countP) || 0);
                            const totalAmount = (Number(agentData.iqB) || 0) + (Number(agentData.iqG) || 0) + (Number(agentData.iqS) || 0) + (Number(agentData.iqP) || 0);
                            html += `<div style="margin-top: 15px; padding-top: 15px; border-top: 2px solid var(--border-color);">
                                <strong style="color: var(--primary-color); font-size: 1.05rem;">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù†Ø³Ø¨Ø© Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ:</strong>
                                <div style="margin-top: 15px; background: var(--bg-primary); padding: 15px; border-radius: 8px; overflow-x: auto;">
                                    <table style="width: 100%; border-collapse: collapse; min-width: 600px;">
                                        <thead>
                                            <tr style="background: var(--bg-secondary); font-weight: 600;">
                                                <th style="padding: 10px; text-align: right; border: 1px solid var(--border-color);">Ù†ÙˆØ¹ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ</th>
                                                <th style="padding: 10px; text-align: center; border: 1px solid var(--border-color);">Ø§Ù„Ø¹Ø¯Ø¯</th>
                                                <th style="padding: 10px; text-align: right; border: 1px solid var(--border-color);">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                                                <th style="padding: 10px; text-align: right; border: 1px solid var(--border-color);"> Ø§Ù„Ø³Ø¹Ø±</th>
                                                <th style="padding: 10px; text-align: right; border: 1px solid var(--border-color);">Ù†Ø³Ø¨Ø© Ø§Ù„ÙˆÙƒÙŠÙ„ (${agentData.percentage || 0}%)</th>
                                                <th style="padding: 10px; text-align: right; border: 1px solid var(--border-color);">Ù…Ø¨Ù„Øº Ø§Ù„Ù†Ø³Ø¨Ø©</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                    ${agentData.countB || agentData.iqB ? `
                                                <tr style="border-bottom: 1px solid var(--border-color);">
                                                    <td style="padding: 8px; text-align: right; border: 1px solid var(--border-color); font-weight: 600; color: var(--primary-color);">Bronze </td>
                                                    <td style="padding: 8px; text-align: center; border: 1px solid var(--border-color);">${Number(agentData.countB) || 0}</td>
                                                    <td style="padding: 8px; text-align: right; border: 1px solid var(--border-color);">${formatNumber(Number(agentData.iqB) || 0)} Ø¯.Ø¹</td>
                                                    <td style="padding: 8px; text-align: right; border: 1px solid var(--border-color);">${agentData.iqB && agentData.countB ? formatNumber((Number(agentData.iqB) / Number(agentData.countB)) || 0) : 0} Ø¯.Ø¹</td>
                                                    <td style="padding: 8px; text-align: right; border: 1px solid var(--border-color);">${agentData.percentage || 0}%</td>
                                                    <td style="padding: 8px; text-align: right; border: 1px solid var(--border-color); font-weight: 600; color: #28a745;">${formatNumber(((Number(agentData.iqB) || 0) * (Number(agentData.percentage) || 0)) / 100)} Ø¯.Ø¹</td>
                                                </tr>
                                    ` : ''}
                                    ${agentData.countG || agentData.iqG ? `
                                                <tr style="border-bottom: 1px solid var(--border-color);">
                                                    <td style="padding: 8px; text-align: right; border: 1px solid var(--border-color); font-weight: 600; color: var(--primary-color);">Gold </td>
                                                    <td style="padding: 8px; text-align: center; border: 1px solid var(--border-color);">${Number(agentData.countG) || 0}</td>
                                                    <td style="padding: 8px; text-align: right; border: 1px solid var(--border-color);">${formatNumber(Number(agentData.iqG) || 0)} Ø¯.Ø¹</td>
                                                    <td style="padding: 8px; text-align: right; border: 1px solid var(--border-color);">${agentData.iqG && agentData.countG ? formatNumber((Number(agentData.iqG) / Number(agentData.countG)) || 0) : 0} Ø¯.Ø¹</td>
                                                    <td style="padding: 8px; text-align: right; border: 1px solid var(--border-color);">${agentData.percentage || 0}%</td>
                                                    <td style="padding: 8px; text-align: right; border: 1px solid var(--border-color); font-weight: 600; color: #28a745;">${formatNumber(((Number(agentData.iqG) || 0) * (Number(agentData.percentage) || 0)) / 100)} Ø¯.Ø¹</td>
                                                </tr>
                                    ` : ''}
                                    ${agentData.countS || agentData.iqS ? `
                                                <tr style="border-bottom: 1px solid var(--border-color);">
                                                    <td style="padding: 8px; text-align: right; border: 1px solid var(--border-color); font-weight: 600; color: var(--primary-color);">Silver </td>
                                                    <td style="padding: 8px; text-align: center; border: 1px solid var(--border-color);">${Number(agentData.countS) || 0}</td>
                                                    <td style="padding: 8px; text-align: right; border: 1px solid var(--border-color);">${formatNumber(Number(agentData.iqS) || 0)} Ø¯.Ø¹</td>
                                                    <td style="padding: 8px; text-align: right; border: 1px solid var(--border-color);">${agentData.iqS && agentData.countS ? formatNumber((Number(agentData.iqS) / Number(agentData.countS)) || 0) : 0} Ø¯.Ø¹</td>
                                                    <td style="padding: 8px; text-align: right; border: 1px solid var(--border-color);">${agentData.percentage || 0}%</td>
                                                    <td style="padding: 8px; text-align: right; border: 1px solid var(--border-color); font-weight: 600; color: #28a745;">${formatNumber(((Number(agentData.iqS) || 0) * (Number(agentData.percentage) || 0)) / 100)} Ø¯.Ø¹</td>
                                                </tr>
                                    ` : ''}
                                    ${agentData.countP || agentData.iqP ? `
                                                <tr style="border-bottom: 1px solid var(--border-color);">
                                                    <td style="padding: 8px; text-align: right; border: 1px solid var(--border-color); font-weight: 600; color: var(--primary-color);">Platinum </td>
                                                    <td style="padding: 8px; text-align: center; border: 1px solid var(--border-color);">${Number(agentData.countP) || 0}</td>
                                                    <td style="padding: 8px; text-align: right; border: 1px solid var(--border-color);">${formatNumber(Number(agentData.iqP) || 0)} Ø¯.Ø¹</td>
                                                    <td style="padding: 8px; text-align: right; border: 1px solid var(--border-color);">${agentData.iqP && agentData.countP ? formatNumber((Number(agentData.iqP) / Number(agentData.countP)) || 0) : 0} Ø¯.Ø¹</td>
                                                    <td style="padding: 8px; text-align: right; border: 1px solid var(--border-color);">${agentData.percentage || 0}%</td>
                                                    <td style="padding: 8px; text-align: right; border: 1px solid var(--border-color); font-weight: 600; color: #28a745;">${formatNumber(((Number(agentData.iqP) || 0) * (Number(agentData.percentage) || 0)) / 100)} Ø¯.Ø¹</td>
                                                </tr>
                                    ` : ''}
                                            <tr style="background: var(--bg-secondary); font-weight: 700; border-top: 2px solid var(--primary-color);">
                                                <td style="padding: 10px; text-align: right; border: 1px solid var(--border-color); color: var(--primary-color);">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</td>
                                                <td style="padding: 10px; text-align: center; border: 1px solid var(--border-color); color: var(--primary-color);">${totalCount}</td>
                                                <td style="padding: 10px; text-align: right; border: 1px solid var(--border-color); color: var(--primary-color);">${formatNumber(totalAmount)} Ø¯.Ø¹</td>
                                                <td style="padding: 10px; text-align: right; border: 1px solid var(--border-color); color: var(--primary-color);">${totalCount > 0 ? formatNumber(totalAmount / totalCount) : 0} Ø¯.Ø¹</td>
                                                <td style="padding: 10px; text-align: right; border: 1px solid var(--border-color); color: var(--primary-color);">${agentData.percentage || 0}%</td>
                                                <td style="padding: 10px; text-align: right; border: 1px solid var(--border-color); color: var(--primary-color);">${formatNumber(agentData.agentPercentageAmount || 0)} Ø¯.Ø¹</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>`;
                        }
                        html += `</div>`;
                    const agentAnalyses = [];
                    const agentFromList = agentsListMap[agentName];
                    const getAgentResults = (archiveData, agentName, type) => {
                        if (!archiveData || !archiveData.data) {
                            return null;
                        }
                        if (archiveData.data.agentReports && archiveData.data.agentReports[agentName]) {
                            const agentReport = archiveData.data.agentReports[agentName];
                            if (type === 'basic' && agentReport.basic) {
                                return agentReport.basic;
                            }
                            if (type === 'advanced' && agentReport.advanced) {
                                return agentReport.advanced;
                            }
                            if (type === 'two_months' && agentReport.twoMonths) {
                                return agentReport.twoMonths;
                            }
                        }
                        if (archiveData.data.results) {
                            const results = archiveData.data.results;
                            if (results.agentName === agentName) {
                                return results;
                            }
                            if (typeof results === 'object' && results[agentName]) {
                                if (type === 'basic' && results[agentName].basic) return results[agentName].basic;
                                if (type === 'advanced' && results[agentName].advanced) return results[agentName].advanced;
                                if (type === 'two_months' && results[agentName].twoMonths) return results[agentName].twoMonths;
                            }
                        }
                        return null;
                    };
                    if (agentFromList && agentFromList.offers) {
                        if (agentFromList.offers.basic) {
                            const basicResults = agentFromList.offers.basic;
                            const basicDetails = agentFromList.details && agentFromList.details.basic ? agentFromList.details.basic : [];
                            if (!agentAnalyses.find(a => a.type === 'basic')) {
                                agentAnalyses.push({
                                    type: 'basic',
                                    name: 'Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠ',
                                    results: basicResults,
                                    details: basicDetails,
                                    fileData: []
                                });
                            }
                        }
                        if (agentFromList.offers.advanced) {
                            const advancedResults = agentFromList.offers.advanced;
                            const advancedDetails = agentFromList.details && agentFromList.details.advanced ? agentFromList.details.advanced : [];
                            if (!agentAnalyses.find(a => a.type === 'advanced')) {
                                agentAnalyses.push({
                                    type: 'advanced',
                                    name: 'Ø¹Ø±Ø¶ 3 Ø£Ø´Ù‡Ø± Ù…Ø®ÙØ¶',
                                    results: advancedResults,
                                    details: advancedDetails,
                                    fileData: []
                                });
                            }
                        }
                        if (agentFromList.offers.twoMonths) {
                            const twoMonthsResults = agentFromList.offers.twoMonths;
                            const twoMonthsDetails = agentFromList.details && agentFromList.details.twoMonths ? agentFromList.details.twoMonths : [];
                            if (!agentAnalyses.find(a => a.type === 'two_months')) {
                                agentAnalyses.push({
                                    type: 'two_months',
                                    name: 'Ø¹Ø±Ø¶ Ø´Ù‡Ø±ÙŠÙ† Ù…Ø®ÙØ¶',
                                    results: twoMonthsResults,
                                    details: twoMonthsDetails,
                                    fileData: []
                                });
                            }
                        }
                    }
                    if (basicArchive && basicArchive.data) {
                        const agentDetails = (basicArchive.data.details || []).filter(d => {
                            const agent = d.agent || d.Agent || d.agentName || d.AgentName || d['Ø§Ø³Ù… Ø§Ù„ÙˆÙƒÙŠÙ„'] || d['Ø§Ù„ÙˆÙƒÙŠÙ„'];
                            return agent === agentName;
                        });
                        const basicResults = getAgentResults(basicArchive, agentName, 'basic');
                        let directResults = null;
                        if (basicArchive.data.results) {
                            if (basicArchive.data.results.agentName === agentName) {
                                directResults = basicArchive.data.results;
                            }
                        }
                        const finalResults = basicResults || directResults;
                        const hasArchive = basicArchive.data && Object.keys(basicArchive.data).length > 0;
                        const hasAgentData = finalResults || agentDetails.length > 0 || hasArchive;
                        if (hasAgentData || hasArchive) {
                            if (!agentAnalyses.find(a => a.type === 'basic')) {
                            const agentFileData = Array.isArray(basicArchive.data.data) ? 
                                basicArchive.data.data.filter(d => {
                                    const agent = d.agent || d.Agent || d.agentName || d.AgentName || d['Ø§Ø³Ù… Ø§Ù„ÙˆÙƒÙŠÙ„'] || d['Ø§Ù„ÙˆÙƒÙŠÙ„'];
                                    return agent === agentName;
                                }) : [];
                            agentAnalyses.push({
                                type: 'basic',
                                name: 'Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠ',
                                results: finalResults,
                                details: agentDetails,
                                fileData: agentFileData.length > 0 ? agentFileData : null
                            });
                            }
                        }
                    } else {
                    }
                    if (advancedArchive && advancedArchive.data) {
                        const agentDetails = (advancedArchive.data.details || []).filter(d => {
                            const agent = d.agent || d.Agent || d.agentName || d.AgentName || d['Ø§Ø³Ù… Ø§Ù„ÙˆÙƒÙŠÙ„'] || d['Ø§Ù„ÙˆÙƒÙŠÙ„'];
                            return agent === agentName;
                        });
                        const advancedResults = getAgentResults(advancedArchive, agentName, 'advanced');
                        let directResults = null;
                        if (advancedArchive.data.results) {
                            if (advancedArchive.data.results.agentName === agentName) {
                                directResults = advancedArchive.data.results;
                            }
                        }
                        const finalResults = advancedResults || directResults;
                        const hasArchive = advancedArchive.data && Object.keys(advancedArchive.data).length > 0;
                        const hasAgentData = finalResults || agentDetails.length > 0 || hasArchive;
                        if (hasAgentData || hasArchive) {
                            if (!agentAnalyses.find(a => a.type === 'advanced')) {
                            const agentFileData = Array.isArray(advancedArchive.data.data) ? 
                                advancedArchive.data.data.filter(d => {
                                    const agent = d.agent || d.Agent || d.agentName || d.AgentName || d['Ø§Ø³Ù… Ø§Ù„ÙˆÙƒÙŠÙ„'] || d['Ø§Ù„ÙˆÙƒÙŠÙ„'];
                                    return agent === agentName;
                                }) : [];
                            agentAnalyses.push({
                                type: 'advanced',
                                name: '3 Ø£Ø´Ù‡Ø± Ù…Ø®ÙØ¶',
                                results: finalResults,
                                details: agentDetails,
                                fileData: agentFileData.length > 0 ? agentFileData : null
                            });
                            }
                        }
                    } else {
                    }
                    if (twoMonthsArchive && twoMonthsArchive.data) {
                        const agentDetails = (twoMonthsArchive.data.details || []).filter(d => {
                            const agent = d.agent || d.Agent || d.agentName || d.AgentName || d['Ø§Ø³Ù… Ø§Ù„ÙˆÙƒÙŠÙ„'] || d['Ø§Ù„ÙˆÙƒÙŠÙ„'];
                            return agent === agentName;
                        });
                        const twoMonthsResults = getAgentResults(twoMonthsArchive, agentName, 'two_months');
                        let directResults = null;
                        if (twoMonthsArchive.data.results) {
                            if (twoMonthsArchive.data.results.agentName === agentName) {
                                directResults = twoMonthsArchive.data.results;
                            }
                        }
                        const finalResults = twoMonthsResults || directResults;
                        const hasArchive = twoMonthsArchive.data && Object.keys(twoMonthsArchive.data).length > 0;
                        const hasAgentData = finalResults || agentDetails.length > 0 || hasArchive;
                        if (hasAgentData || hasArchive) {
                            if (!agentAnalyses.find(a => a.type === 'two_months')) {
                            const agentFileData = Array.isArray(twoMonthsArchive.data.data) ? 
                                twoMonthsArchive.data.data.filter(d => {
                                    const agent = d.agent || d.Agent || d.agentName || d.AgentName || d['Ø§Ø³Ù… Ø§Ù„ÙˆÙƒÙŠÙ„'] || d['Ø§Ù„ÙˆÙƒÙŠÙ„'];
                                    return agent === agentName;
                                }) : [];
                            agentAnalyses.push({
                                type: 'two_months',
                                name: 'Ø´Ù‡Ø±ÙŠÙ† Ù…Ø®ÙØ¶',
                                results: finalResults,
                                details: agentDetails,
                                fileData: agentFileData.length > 0 ? agentFileData : null
                            });
                            }
                        }
                    } else {
                    }
                    if (agentAnalyses.length > 0) {
                        html += `<div style="margin-bottom: 20px;">
                            <h4 style="margin-bottom: 15px; color: var(--primary-color);">ØªØ­Ù„ÙŠÙ„Ø§Øª Ø§Ù„Ø¹Ø±ÙˆØ¶</h4>`;
                        agentAnalyses.forEach(analysis => {
                            html += `<div style="margin-bottom: 20px; background: var(--bg-secondary); padding: 15px; border-radius: 8px; border-left: 4px solid var(--primary-color);">
                                <h5 style="margin-bottom: 10px; color: var(--primary-color);">${analysis.name}</h5>`;
                            if (analysis.results && analysis.results.total) {
                                html += `<div style="background: var(--bg-primary); padding: 12px; border-radius: 6px; margin-bottom: 15px; border: 1px solid var(--border-color);">
                                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-bottom: 10px;">
                                        <div><strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª:</strong> ${analysis.results.total.count || 0}</div>
                                        ${analysis.results.total.amount ? `<div><strong>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</strong> ${formatNumber(analysis.results.total.amount)} Ø¯.Ø¹</div>` : ''}
                                        ${analysis.results.total.promoAmount ? `<div><strong>Ù…Ø¨Ù„Øº Ø§Ù„Ø¹Ø±Ø¶:</strong> ${formatNumber(analysis.results.total.promoAmount)} Ø¯.Ø¹</div>` : ''}
                                        ${analysis.results.total.officialAmount ? `<div><strong>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø±Ø³Ù…ÙŠ:</strong> ${formatNumber(analysis.results.total.officialAmount)} Ø¯.Ø¹</div>` : ''}
                                        ${analysis.results.total.profit ? `<div style="font-weight: 700; color: #28a745;"><strong>Ø§Ù„Ø±Ø¨Ø­/Ø§Ù„Ø±Ø§Ø¬Ø¹:</strong> ${formatNumber(analysis.results.total.profit)} Ø¯.Ø¹</div>` : ''}
                                    </div>`;
                                if (analysis.results.bronze || analysis.results.silver || analysis.results.gold || analysis.results.platinum) {
                                    html += `<div style="margin-top: 15px; padding-top: 15px; border-top: 2px solid var(--border-color);">
                                        <strong style="color: var(--primary-color);">ØªÙØ§ØµÙŠÙ„ Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ:</strong>
                                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; margin-top: 10px;">
                                            ${analysis.results.bronze ? `
                                                <div style="background: var(--bg-secondary); padding: 10px; border-radius: 6px; border: 1px solid var(--border-color);">
                                                    <div style="font-weight: 600; color: var(--primary-color); margin-bottom: 5px;">Bronze</div>
                                                    <div style="font-size: 0.9rem;"><strong>Ø§Ù„Ø¹Ø¯Ø¯:</strong> ${analysis.results.bronze.count || 0}</div>
                                                    ${analysis.results.bronze.amount ? `<div style="font-size: 0.9rem;"><strong>Ø§Ù„Ù…Ø¨Ù„Øº:</strong> ${formatNumber(analysis.results.bronze.amount)} Ø¯.Ø¹</div>` : ''}
                                                    ${analysis.results.bronze.promoAmount ? `<div style="font-size: 0.85rem; color: var(--text-secondary);"><strong>Ø¹Ø±Ø¶:</strong> ${formatNumber(analysis.results.bronze.promoAmount)} Ø¯.Ø¹</div>` : ''}
                                                    ${analysis.results.bronze.officialAmount ? `<div style="font-size: 0.85rem; color: var(--text-secondary);"><strong>Ø±Ø³Ù…ÙŠ:</strong> ${formatNumber(analysis.results.bronze.officialAmount)} Ø¯.Ø¹</div>` : ''}
                                                </div>
                                            ` : ''}
                                            ${analysis.results.silver ? `
                                                <div style="background: var(--bg-secondary); padding: 10px; border-radius: 6px; border: 1px solid var(--border-color);">
                                                    <div style="font-weight: 600; color: var(--primary-color); margin-bottom: 5px;">Silver</div>
                                                    <div style="font-size: 0.9rem;"><strong>Ø§Ù„Ø¹Ø¯Ø¯:</strong> ${analysis.results.silver.count || 0}</div>
                                                    ${analysis.results.silver.amount ? `<div style="font-size: 0.9rem;"><strong>Ø§Ù„Ù…Ø¨Ù„Øº:</strong> ${formatNumber(analysis.results.silver.amount)} Ø¯.Ø¹</div>` : ''}
                                                    ${analysis.results.silver.promoAmount ? `<div style="font-size: 0.85rem; color: var(--text-secondary);"><strong>Ø¹Ø±Ø¶:</strong> ${formatNumber(analysis.results.silver.promoAmount)} Ø¯.Ø¹</div>` : ''}
                                                    ${analysis.results.silver.officialAmount ? `<div style="font-size: 0.85rem; color: var(--text-secondary);"><strong>Ø±Ø³Ù…ÙŠ:</strong> ${formatNumber(analysis.results.silver.officialAmount)} Ø¯.Ø¹</div>` : ''}
                                                </div>
                                            ` : ''}
                                            ${analysis.results.gold ? `
                                                <div style="background: var(--bg-secondary); padding: 10px; border-radius: 6px; border: 1px solid var(--border-color);">
                                                    <div style="font-weight: 600; color: var(--primary-color); margin-bottom: 5px;">Gold</div>
                                                    <div style="font-size: 0.9rem;"><strong>Ø§Ù„Ø¹Ø¯Ø¯:</strong> ${analysis.results.gold.count || 0}</div>
                                                    ${analysis.results.gold.amount ? `<div style="font-size: 0.9rem;"><strong>Ø§Ù„Ù…Ø¨Ù„Øº:</strong> ${formatNumber(analysis.results.gold.amount)} Ø¯.Ø¹</div>` : ''}
                                                    ${analysis.results.gold.promoAmount ? `<div style="font-size: 0.85rem; color: var(--text-secondary);"><strong>Ø¹Ø±Ø¶:</strong> ${formatNumber(analysis.results.gold.promoAmount)} Ø¯.Ø¹</div>` : ''}
                                                    ${analysis.results.gold.officialAmount ? `<div style="font-size: 0.85rem; color: var(--text-secondary);"><strong>Ø±Ø³Ù…ÙŠ:</strong> ${formatNumber(analysis.results.gold.officialAmount)} Ø¯.Ø¹</div>` : ''}
                                                </div>
                                            ` : ''}
                                            ${analysis.results.platinum ? `
                                                <div style="background: var(--bg-secondary); padding: 10px; border-radius: 6px; border: 1px solid var(--border-color);">
                                                    <div style="font-weight: 600; color: var(--primary-color); margin-bottom: 5px;">Platinum</div>
                                                    <div style="font-size: 0.9rem;"><strong>Ø§Ù„Ø¹Ø¯Ø¯:</strong> ${analysis.results.platinum.count || 0}</div>
                                                    ${analysis.results.platinum.amount ? `<div style="font-size: 0.9rem;"><strong>Ø§Ù„Ù…Ø¨Ù„Øº:</strong> ${formatNumber(analysis.results.platinum.amount)} Ø¯.Ø¹</div>` : ''}
                                                    ${analysis.results.platinum.promoAmount ? `<div style="font-size: 0.85rem; color: var(--text-secondary);"><strong>Ø¹Ø±Ø¶:</strong> ${formatNumber(analysis.results.platinum.promoAmount)} Ø¯.Ø¹</div>` : ''}
                                                    ${analysis.results.platinum.officialAmount ? `<div style="font-size: 0.85rem; color: var(--text-secondary);"><strong>Ø±Ø³Ù…ÙŠ:</strong> ${formatNumber(analysis.results.platinum.officialAmount)} Ø¯.Ø¹</div>` : ''}
                                                </div>
                                            ` : ''}
                                        </div>
                                    </div>`;
                                }
                                html += `</div>`;
                            } else if (analysis.details && Array.isArray(analysis.details) && analysis.details.length > 0) {
                                const totalCount = analysis.details.length;
                                let totalAmount = 0;
                                let totalPromoAmount = 0;
                                let totalOfficialAmount = 0;
                                analysis.details.forEach(detail => {
                                    if (detail.price) totalAmount += Number(detail.price) || 0;
                                    if (detail.promoPrice) totalPromoAmount += Number(detail.promoPrice) || 0;
                                    if (detail.officialPrice) totalOfficialAmount += Number(detail.officialPrice) || 0;
                                });
                                html += `<div style="background: var(--bg-primary); padding: 12px; border-radius: 6px; margin-bottom: 15px; border: 1px solid var(--border-color);">
                                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-bottom: 10px;">
                                        <div><strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª:</strong> ${totalCount}</div>
                                        ${totalAmount > 0 ? `<div><strong>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</strong> ${formatNumber(totalAmount)} Ø¯.Ø¹</div>` : ''}
                                        ${totalPromoAmount > 0 ? `<div><strong>Ù…Ø¨Ù„Øº Ø§Ù„Ø¹Ø±Ø¶:</strong> ${formatNumber(totalPromoAmount)} Ø¯.Ø¹</div>` : ''}
                                        ${totalOfficialAmount > 0 ? `<div><strong>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø±Ø³Ù…ÙŠ:</strong> ${formatNumber(totalOfficialAmount)} Ø¯.Ø¹</div>` : ''}
                                        ${totalOfficialAmount > 0 && totalPromoAmount > 0 ? `<div style="font-weight: 700; color: #28a745;"><strong>Ø§Ù„Ø±Ø¨Ø­/Ø§Ù„Ø±Ø§Ø¬Ø¹:</strong> ${formatNumber(totalOfficialAmount - totalPromoAmount)} Ø¯.Ø¹</div>` : ''}
                                    </div>
                                </div>`;
                            } else {
                                html += `<div style="background: var(--bg-primary); padding: 12px; border-radius: 6px; margin-bottom: 15px; border: 1px solid var(--border-color); text-align: center; color: var(--text-secondary);">
                                    <p>Ø§Ù„Ø£Ø±Ø´ÙŠÙ Ù…ÙˆØ¬ÙˆØ¯ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø±Ø¶ ÙˆÙ„ÙƒÙ† Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙØ§ØµÙŠÙ„ Ù…Ø­Ø¯Ø¯Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„ÙˆÙƒÙŠÙ„</p>
                                    <p style="font-size: 0.9rem; margin-top: 5px;">Ù‚Ø¯ ØªÙƒÙˆÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­ÙÙˆØ¸Ø© Ø¨Ø´ÙƒÙ„ Ù…Ø®ØªÙ„Ù Ø£Ùˆ Ù„Ù… ÙŠØªÙ… ØªØ­Ù„ÙŠÙ„Ù‡Ø§ Ù„Ù‡Ø°Ø§ Ø§Ù„ÙˆÙƒÙŠÙ„</p>
                                </div>`;
                            }
                            if (analysis.details && analysis.details.length > 0) {
                                html += `<div style="margin-top: 15px;">
                                    <strong style="color: var(--primary-color); font-size: 1.05rem;">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª Ø§Ù„ÙƒØ§Ù…Ù„Ø© (${analysis.details.length}):</strong>
                                    <div style="background: var(--bg-primary); padding: 10px; border-radius: 8px; margin-top: 5px; max-height: 600px; overflow-y: auto; overflow-x: auto; font-size: 0.85rem;">
                                        <table style="width: 100%; border-collapse: collapse; min-width: 800px;">
                                            <thead>
                                                <tr style="background: var(--bg-secondary); font-weight: 600; position: sticky; top: 0; z-index: 10;">
                                                    <th style="padding: 8px; text-align: center; border: 1px solid var(--border-color);">#</th>
                                                    <th style="padding: 8px; text-align: right; border: 1px solid var(--border-color);">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
                                                    <th style="padding: 8px; text-align: right; border: 1px solid var(--border-color);">Ù†ÙˆØ¹ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ</th>
                                                    <th style="padding: 8px; text-align: right; border: 1px solid var(--border-color);">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                                    <th style="padding: 8px; text-align: right; border: 1px solid var(--border-color);">Ø§Ù„Ø³Ø¹Ø±</th>
                                                    <th style="padding: 8px; text-align: right; border: 1px solid var(--border-color);">Ø³Ø¹Ø± Ø§Ù„Ø¹Ø±Ø¶</th>
                                                    <th style="padding: 8px; text-align: right; border: 1px solid var(--border-color);">Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø±Ø³Ù…ÙŠ</th>
                                                    ${analysis.type === 'advanced' || analysis.type === 'two_months' ? `
                                                        <th style="padding: 8px; text-align: right; border: 1px solid var(--border-color);">ØªØ§Ø±ÙŠØ® 1</th>
                                                        <th style="padding: 8px; text-align: right; border: 1px solid var(--border-color);">ØªØ§Ø±ÙŠØ® 2</th>
                                                        ${analysis.type === 'advanced' ? `<th style="padding: 8px; text-align: right; border: 1px solid var(--border-color);">ØªØ§Ø±ÙŠØ® 3</th>` : ''}
                                                        <th style="padding: 8px; text-align: center; border: 1px solid var(--border-color);">Ø§Ù„ÙØ±Ù‚ Ø¨Ø§Ù„Ø£ÙŠØ§Ù…</th>
                                                    ` : ''}
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${(Array.isArray(analysis.details) ? analysis.details : []).map((detail, idx) => {
                                                    const date1 = detail.date1 || '';
                                                    const date2 = detail.date2 || '';
                                                    const date3 = detail.date3 || '';
                                                    const dateStr = detail.dateStr || detail.date || detail.createdAt || date1 || '';
                                                    let price = detail.price;
                                                    let promoPrice = detail.promoPrice;
                                                    let officialPrice = detail.officialPrice;
                                                    if (!price && !promoPrice && !officialPrice && detail.subscription) {
                                                        const category = getSubscriptionCategory(detail.subscription, detail.agent || '');
                                                        if (category) {
                                                            if (analysis.type === 'basic') {
                                                                price = getSubscriptionPrice(detail.subscription, category, 'basic');
                                                                promoPrice = price;
                                                                officialPrice = price;
                                                            } else if (analysis.type === 'advanced') {
                                                                promoPrice = getSubscriptionPrice(detail.subscription, category, 'advanced', 'promo');
                                                                officialPrice = getSubscriptionPrice(detail.subscription, category, 'advanced', 'official');
                                                            } else if (analysis.type === 'two_months') {
                                                                promoPrice = getSubscriptionPrice(detail.subscription, category, 'twoMonths', 'promo');
                                                                const monthlyOfficialPrice = getSubscriptionPrice(detail.subscription, category, 'basic');
                                                                officialPrice = monthlyOfficialPrice * 2;
                                                            }
                                                        }
                                                    }
                                                    const priceStr = price ? formatNumber(price) + ' Ø¯.Ø¹' : '-';
                                                    const promoPriceStr = promoPrice ? formatNumber(promoPrice) + ' Ø¯.Ø¹' : '-';
                                                    const officialPriceStr = officialPrice ? formatNumber(officialPrice) + ' Ø¯.Ø¹' : '-';
                                                    return `
                                                    <tr style="border-bottom: 1px solid var(--border-color); ${idx % 2 === 0 ? 'background: var(--bg-primary);' : 'background: var(--card-bg);'}">
                                                        <td style="padding: 6px; text-align: center; border: 1px solid var(--border-color);">${idx + 1}</td>
                                                        <td style="padding: 6px; text-align: right; border: 1px solid var(--border-color);">${detail.username || ''}</td>
                                                        <td style="padding: 6px; text-align: right; border: 1px solid var(--border-color);">${detail.subscription || ''}</td>
                                                        <td style="padding: 6px; text-align: right; border: 1px solid var(--border-color);">${dateStr}</td>
                                                        <td style="padding: 6px; text-align: right; border: 1px solid var(--border-color);">${priceStr}</td>
                                                        <td style="padding: 6px; text-align: right; border: 1px solid var(--border-color); color: #28a745; font-weight: 600;">${promoPriceStr}</td>
                                                        <td style="padding: 6px; text-align: right; border: 1px solid var(--border-color); color: #dc3545; font-weight: 600;">${officialPriceStr}</td>
                                                        ${analysis.type === 'advanced' || analysis.type === 'two_months' ? `
                                                            <td style="padding: 6px; text-align: right; border: 1px solid var(--border-color);">${date1}</td>
                                                            <td style="padding: 6px; text-align: right; border: 1px solid var(--border-color);">${date2}</td>
                                                            ${analysis.type === 'advanced' ? `<td style="padding: 6px; text-align: right; border: 1px solid var(--border-color);">${date3}</td>` : ''}
                                                            <td style="padding: 6px; text-align: center; border: 1px solid var(--border-color); font-weight: 600;">${detail.daysDiff !== undefined && detail.daysDiff !== null ? detail.daysDiff : '-'}</td>
                                                        ` : ''}
                                                    </tr>
                                                `;
                                                }).join('')}
                                            </tbody>
                                        </table>
                                    </div>
                                    <div style="margin-top: 10px; padding: 10px; background: var(--bg-secondary); border-radius: 6px; text-align: center; color: var(--text-secondary); font-size: 0.9rem;">
                                        <strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</strong> ${analysis.details.length} Ø§Ø´ØªØ±Ø§Ùƒ
                                    </div>
                                </div>`;
                            }
                            if (analysis.fileData && Array.isArray(analysis.fileData) && analysis.fileData.length > 0) {
                                html += `<div style="margin-top: 15px;">
                                    <strong>Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø­Ù…Ù„:</strong>
                                    <div style="background: var(--bg-primary); padding: 10px; border-radius: 8px; margin-top: 5px; font-size: 0.9rem;">
                                        Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ø¬Ù„Ø§Øª: ${analysis.fileData.length}
                                    </div>
                                </div>`;
                            }
                            html += `</div>`;
                        });
                        html += `</div>`;
                    } else {
                        html += `<div style="margin-bottom: 20px; padding: 15px; background: var(--bg-secondary); border-radius: 8px; text-align: center; color: var(--text-secondary);">
                            <p>Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ­Ù„ÙŠÙ„Ø§Øª Ù…Ø³Ø¬Ù„Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„ÙˆÙƒÙŠÙ„ ÙÙŠ Ø§Ù„Ø£Ø±Ø´ÙŠÙ</p>
                            <p style="font-size: 0.9rem; margin-top: 10px; color: var(--text-tertiary);">ØªØ£ÙƒØ¯ Ù…Ù† ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø£ÙˆÙ„Ø§Ù‹ Ù…Ù† ØµÙØ­Ø§Øª "Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠ" Ø£Ùˆ "3 Ø£Ø´Ù‡Ø± Ù…Ø®ÙØ¶" Ø£Ùˆ "Ø´Ù‡Ø±ÙŠÙ† Ù…Ø®ÙØ¶"</p>
                        </div>`;
                    }
                    html += `</div>`;
                }
                if (currentUserRole === 'admin') {
                    html += `
                        <div style="margin-top: 30px; padding: 20px; background: rgba(220, 53, 69, 0.1); border-radius: 12px; border: 2px solid rgba(220, 53, 69, 0.3);">
                            <h4 style="color: #dc3545; margin-bottom: 15px; font-weight: 700;">âš ï¸ Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù…Ø¯ÙŠØ± - Ø­Ø°Ù ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙˆÙƒÙŠÙ„</h4>
                            <p style="color: var(--text-secondary); margin-bottom: 15px; font-size: 0.95rem;">ÙŠÙ…ÙƒÙ†Ùƒ Ø­Ø°Ù ØªÙØ§ØµÙŠÙ„ Ù‡Ø°Ø§ Ø§Ù„ÙˆÙƒÙŠÙ„ Ù…Ù† Ø§Ù„Ø£Ø±Ø´ÙŠÙ. Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª ÙˆØ§Ù„ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„ÙˆÙƒÙŠÙ„ Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø¹Ø±ÙˆØ¶.</p>
                            <button class="btn btn-danger" onclick="deleteAgentFromArchive('${displayName}', '${monthYear}')" style="padding: 12px 24px; font-weight: 600; font-size: 1rem;">
                                ðŸ—‘ï¸ Ø­Ø°Ù ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙˆÙƒÙŠÙ„ "${displayName}" Ù…Ù† Ø§Ù„Ø£Ø±Ø´ÙŠÙ
                            </button>
                        </div>
                    `;
                }
                if (false) {
                container.innerHTML = html;
                }
            } catch (error) {
                console.error('Error loading archive:', error);
                const errorMessage = error.message || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
                const errorDetails = error.details || error.hint || '';
                const container = document.getElementById('archiveContent');
                if (container) {
                    container.innerHTML = `
                    <div style="padding: 20px; text-align: center;">
                        <h4 style="color: #dc3545; margin-bottom: 15px;">âš ï¸ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø±Ø´ÙŠÙ</h4>
                        <p style="color: var(--text-secondary); margin-bottom: 10px;"><strong>Ø§Ù„Ø®Ø·Ø£:</strong> ${errorMessage}</p>
                        ${errorDetails ? `<p style="color: var(--text-tertiary); font-size: 0.9rem;">${errorDetails}</p>` : ''}
                        <div style="margin-top: 20px; padding: 15px; background: var(--bg-secondary); border-radius: 8px; text-align: right;">
                            <p style="font-weight: 600; margin-bottom: 10px;">Ø­Ù„ÙˆÙ„ Ù…Ù‚ØªØ±Ø­Ø©:</p>
                            <ul style="text-align: right; font-size: 0.9rem;">
                                <li>ØªØ£ÙƒØ¯ Ù…Ù† Ø§ØªØµØ§Ù„ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</li>
                                <li>ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ù…Ø­Ø¯Ø¯ ØµØ­ÙŠØ­ (${monthYear})</li>
                                <li>ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­ÙÙˆØ¸Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±</li>
                                <li>Ø­Ø§ÙˆÙ„ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©</li>
                            </ul>
                        </div>
                    </div>`;
                }
            }
        }
        function filterArchiveAgents(searchQuery) {
            const searchLower = searchQuery.toLowerCase().trim();
            const agentCards = document.querySelectorAll('.archive-agent-card');
            if (!searchLower) {
                agentCards.forEach(card => {
                    card.style.display = 'block';
                });
                return;
            }
            agentCards.forEach(card => {
                const agentName = card.getAttribute('data-agent-name') || '';
                if (agentName.toLowerCase().includes(searchLower)) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        }
        async function showArchiveAgentDetails(normalizedName, monthYear = null) {
            if (!monthYear) {
                monthYear = window.currentArchiveMonthYear || getCurrentMonthYear();
            }
            const agentsListContainer = document.getElementById('archiveAgentsList');
            const archiveContent = document.getElementById('archiveContent');
            if (agentsListContainer) {
                agentsListContainer.style.display = 'none';
            }
            if (archiveContent) {
                archiveContent.style.display = 'block';
                archiveContent.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙˆÙƒÙŠÙ„...</p>';
            }
            if (!supabaseClient) {
                archiveContent.innerHTML = '<p style="color: red;">Supabase ØºÙŠØ± Ù…ØªØµÙ„</p>';
                return;
            }
            try {
                const storedPercentages = window.currentArchivePercentages || {};
                const agentData = storedPercentages[normalizedName];
                const displayName = agentData?.originalName || normalizedName;
                if (!agentData) {
                    archiveContent.innerHTML = `
                        <div style="text-align: center; padding: 20px;">
                            <button class="btn btn-secondary" onclick="goBackToArchiveAgentsList()" style="margin-bottom: 20px; background: linear-gradient(135deg, #801c32, #a52d45); color: #fff; border: none; padding: 12px 24px; font-weight: 700; box-shadow: 0 4px 12px rgba(128, 28, 50, 0.3); transition: all 0.3s ease;">â† Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙˆÙƒÙ„Ø§Ø¡</button>
                            <p style="color: var(--text-secondary);">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„ÙˆÙƒÙŠÙ„ ÙÙŠ Ø§Ù„Ø£Ø±Ø´ÙŠÙ</p>
                        </div>
                    `;
                    return;
                }
                const percentagesArchive = await getArchiveForMonth('agent_percentages', monthYear);
                const { data: basicArchiveData } = await supabaseClient.from('analysis_archives').select('*').eq('month_year', monthYear).eq('analysis_type', 'basic').maybeSingle();
                const { data: advancedArchiveData } = await supabaseClient.from('analysis_archives').select('*').eq('month_year', monthYear).eq('analysis_type', 'advanced').maybeSingle();
                const { data: twoMonthsArchiveData } = await supabaseClient.from('analysis_archives').select('*').eq('month_year', monthYear).eq('analysis_type', 'two_months').maybeSingle();
                const possibleNames = [displayName, normalizedName];
                if (percentagesArchive && percentagesArchive.data) {
                    Object.keys(percentagesArchive.data).forEach(name => {
                        if (normalizeAgentName(name) === normalizedName) {
                            possibleNames.push(name);
                        }
                    });
                }
                const filterDetailsByAgent = (details, agentNames) => {
                    if (!details || !Array.isArray(details)) return [];
                    return details.filter(d => {
                        const agent = d.agent || d.Agent || d.agentName || d.AgentName || d['Ø§Ø³Ù… Ø§Ù„ÙˆÙƒÙŠÙ„'] || d['Ø§Ù„ÙˆÙƒÙŠÙ„'];
                        return agentNames.some(name => normalizeAgentName(agent) === normalizeAgentName(name));
                    });
                };
                const getAgentResultsFromArchive = (archiveData, agentNames, type) => {
                    if (!archiveData || !archiveData.data) return null;
                    for (const agentName of agentNames) {
                    if (archiveData.data.agentReports && archiveData.data.agentReports[agentName]) {
                        const agentReport = archiveData.data.agentReports[agentName];
                        if (type === 'basic' && agentReport.basic) return agentReport.basic;
                        if (type === 'advanced' && agentReport.advanced) return agentReport.advanced;
                        if (type === 'two_months' && agentReport.twoMonths) return agentReport.twoMonths;
                    }
                    if (archiveData.data.results) {
                        if (archiveData.data.results.agentName === agentName) {
                            return archiveData.data.results;
                        }
                        if (archiveData.data.results[agentName]) {
                            if (type === 'basic' && archiveData.data.results[agentName].basic) return archiveData.data.results[agentName].basic;
                            if (type === 'advanced' && archiveData.data.results[agentName].advanced) return archiveData.data.results[agentName].advanced;
                            if (type === 'two_months' && archiveData.data.results[agentName].twoMonths) return archiveData.data.results[agentName].twoMonths;
                        }
                    }
                    }
                    return null;
                };
                const basicArchive = basicArchiveData ? { data: basicArchiveData.data, raw: basicArchiveData } : null;
                const advancedArchive = advancedArchiveData ? { data: advancedArchiveData.data, raw: advancedArchiveData } : null;
                const twoMonthsArchive = twoMonthsArchiveData ? { data: twoMonthsArchiveData.data, raw: twoMonthsArchiveData } : null;
                
                const { data: agentsListArchive } = await supabaseClient
                    .from('agents_list')
                    .select('*')
                    .eq('month_year', monthYear)
                    .maybeSingle();
                
                let savedBasicResults = null;
                let savedAdvancedResults = null;
                let savedTwoMonthsResults = null;
                let savedBasicDetails = [];
                let savedAdvancedDetails = [];
                let savedTwoMonthsDetails = [];
                
                if (agentsListArchive && agentsListArchive.data && Array.isArray(agentsListArchive.data)) {
                    const agentFromList = agentsListArchive.data.find(a => {
                        if (!a || !a.name) return false;
                        return possibleNames.some(name => normalizeAgentName(a.name) === normalizeAgentName(name));
                    });
                    
                    if (agentFromList) {
                        if (agentFromList.offers && agentFromList.offers.basic) {
                            savedBasicResults = agentFromList.offers.basic.results;
                        }
                        if (agentFromList.offers && agentFromList.offers.advanced) {
                            savedAdvancedResults = agentFromList.offers.advanced.results;
                        }
                        if (agentFromList.offers && agentFromList.offers.two_months) {
                            savedTwoMonthsResults = agentFromList.offers.two_months.results;
                        }
                        if (agentFromList.details && agentFromList.details.basic) {
                            savedBasicDetails = agentFromList.details.basic;
                        }
                        if (agentFromList.details && agentFromList.details.advanced) {
                            savedAdvancedDetails = agentFromList.details.advanced;
                        }
                        if (agentFromList.details && agentFromList.details.two_months) {
                            savedTwoMonthsDetails = agentFromList.details.two_months;
                        }
                    }
                }
                
                const agentBasicDetails = (basicArchive ? filterDetailsByAgent(basicArchive.data.details, possibleNames) : []).concat(savedBasicDetails);
                const agentAdvancedDetails = (advancedArchive ? filterDetailsByAgent(advancedArchive.data.details, possibleNames) : []).concat(savedAdvancedDetails);
                const agentTwoMonthsDetails = (twoMonthsArchive ? filterDetailsByAgent(twoMonthsArchive.data.details, possibleNames) : []).concat(savedTwoMonthsDetails);
                const basicResults = savedBasicResults || (basicArchive ? getAgentResultsFromArchive(basicArchive, possibleNames, 'basic') : null);
                const advancedResults = savedAdvancedResults || (advancedArchive ? getAgentResultsFromArchive(advancedArchive, possibleNames, 'advanced') : null);
                const twoMonthsResults = savedTwoMonthsResults || (twoMonthsArchive ? getAgentResultsFromArchive(twoMonthsArchive, possibleNames, 'two_months') : null);
                const displayMonth = monthYear === '0000-00' ? 'Ù‚Ø§Ø¦Ù…Ø© Ø¯Ø§Ø¦Ù…Ø©' : monthYear;
                let html = `
                    <div style="margin-bottom: 20px;">
                        <button class="btn btn-secondary" onclick="goBackToArchiveAgentsList()" style="margin-bottom: 15px;">â† Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙˆÙƒÙ„Ø§Ø¡</button>
                        <h4 style="margin-bottom: 20px; text-align: center; color: var(--primary-color);">Ø£Ø±Ø´ÙŠÙ ${displayMonth} - ${displayName}</h4>
                    </div>
                `;
                html += `<div style="margin-bottom: 30px; border: 2px solid var(--primary-color); border-radius: 12px; padding: 20px; background: var(--card-bg); box-shadow: var(--shadow-md);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid var(--primary-color); padding-bottom: 10px;">
                        <h3 style="margin: 0; color: var(--primary-color); font-size: 1.3rem;">${displayName}</h3>
                        <div style="display: flex; gap: 10px;">
                        <button class="btn btn-success" onclick="exportAgentArchiveReport('${displayName}', '${monthYear}')" style="font-size: 0.9rem; padding: 8px 15px;">
                                ðŸ“¥ ØªØµØ¯ÙŠØ± Excel
                        </button>
                            <button class="btn btn-danger" onclick="printArchivePDF('${displayName}', '${monthYear}')" style="font-size: 0.9rem; padding: 8px 15px; background-color: #dc3545; border-color: #dc3545;">
                                ðŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© PDF
                            </button>
                        </div>
                    </div>`;
                html += `<div style="margin-bottom: 20px; background: var(--bg-secondary); padding: 15px; border-radius: 8px; border: 1px solid var(--border-color);">
                    <h4 style="margin-bottom: 15px; color: var(--primary-color); border-bottom: 1px solid var(--border-color); padding-bottom: 8px;">Ù…Ù„Ø®Øµ Ø§Ù„Ù†Ø³Ø¨ ÙˆØ§Ù„ØªÙØ§ØµÙŠÙ„</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 15px;">
                        <div><strong>Ø§Ù„Ù†Ø³Ø¨Ø© :</strong> ${agentData.percentage || 0}%</div>
                        <div><strong>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙƒÙ„ÙŠ:</strong> ${formatNumber(agentData.iqT || 0)} Ø¯.Ø¹</div>
                        <div><strong>Ù†Ø³Ø¨Ø© Ø§Ù„ÙˆÙƒÙŠÙ„:</strong> ${formatNumber(agentData.agentPercentageAmount || 0)} Ø¯.Ø¹</div>
                        ${agentData.deductions ? `<div style="color: #dc3545;"><strong>Ø§Ù„Ø§Ø³ØªÙ‚Ø·Ø§Ø¹:</strong> ${formatNumber(agentData.deductions)} Ø¯.Ø¹</div>` : '<div><strong>Ø§Ù„Ø§Ø³ØªÙ‚Ø·Ø§Ø¹:</strong> 0 Ø¯.Ø¹</div>'}
                        ${agentData.penalties ? `<div style="color: #dc3545;"><strong>Ø§Ù„ØºØ±Ø§Ù…Ø©:</strong> ${formatNumber(agentData.penalties)} Ø¯.Ø¹</div>` : '<div><strong>Ø§Ù„ØºØ±Ø§Ù…Ø©:</strong> 0 Ø¯.Ø¹</div>'}
                        <div style="font-weight: 700; color: var(--primary-color); font-size: 1.1rem;"><strong>Ø§Ù„ØµØ§ÙÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ:</strong> ${formatNumber(agentData.netPercentage || 0)} Ø¯.Ø¹</div>
                    </div>`;
                html += `<div style="margin-bottom: 20px;">
                    <h4 style="margin-bottom: 15px; color: var(--primary-color);">ØªØ­Ù„ÙŠÙ„Ø§Øª Ø§Ù„Ø¹Ø±ÙˆØ¶</h4>
                    <p style="color: var(--text-secondary);">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙØ§ØµÙŠÙ„...</p>
                </div>`;
                html += `</div>`;
                archiveContent.innerHTML = html;
                setTimeout(async () => {
                    await loadFullAgentArchiveDetails(agentName, agentData, monthYear, basicResults, advancedResults, twoMonthsResults, agentBasicDetails, agentAdvancedDetails, agentTwoMonthsDetails, basicArchive, advancedArchive, twoMonthsArchive);
                }, 100);
            } catch (error) {
                console.error('Error loading agent archive details:', error);
                archiveContent.innerHTML = `
                    <div style="text-align: center; padding: 20px;">
                        <button class="btn btn-secondary" onclick="goBackToArchiveAgentsList()" style="margin-bottom: 20px;">â† Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙˆÙƒÙ„Ø§Ø¡</button>
                        <p style="color: red;">Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙˆÙƒÙŠÙ„: ${error.message}</p>
                    </div>
                `;
            }
        }
        function goBackToArchiveAgentsList() {
            const agentsListContainer = document.getElementById('archiveAgentsList');
            const archiveContent = document.getElementById('archiveContent');
            if (agentsListContainer) {
                agentsListContainer.style.display = 'block';
            }
            if (archiveContent) {
                archiveContent.style.display = 'none';
            }
            const searchInput = document.getElementById('archiveAgentSearch');
            if (searchInput) {
                searchInput.value = '';
                filterArchiveAgents('');
            }
        }
        async function loadFullAgentArchiveDetails(agentName, agentData, monthYear, basicResults, advancedResults, twoMonthsResults, agentBasicDetails, agentAdvancedDetails, agentTwoMonthsDetails, basicArchive, advancedArchive, twoMonthsArchive) {
            const archiveContent = document.getElementById('archiveContent');
            if (!archiveContent) return;
            const existingHTML = archiveContent.innerHTML;
            const analysesStart = existingHTML.indexOf('<h4 style="margin-bottom: 15px; color: var(--primary-color);">ØªØ­Ù„ÙŠÙ„Ø§Øª Ø§Ù„Ø¹Ø±ÙˆØ¶</h4>');
            if (analysesStart === -1) return;
            let analysesHTML = '<h4 style="margin-bottom: 15px; color: var(--primary-color);">ØªØ­Ù„ÙŠÙ„Ø§Øª Ø§Ù„Ø¹Ø±ÙˆØ¶</h4>';
            const agentAnalyses = [];
            if (basicResults || agentBasicDetails.length > 0) {
                agentAnalyses.push({
                    type: 'basic',
                    name: 'Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠ',
                    results: basicResults,
                    details: agentBasicDetails
                });
            }
            if (advancedResults || agentAdvancedDetails.length > 0) {
                agentAnalyses.push({
                    type: 'advanced',
                    name: 'Ø¹Ø±Ø¶ 3 Ø£Ø´Ù‡Ø± Ù…Ø®ÙØ¶',
                    results: advancedResults,
                    details: agentAdvancedDetails
                });
            }
            if (twoMonthsResults || agentTwoMonthsDetails.length > 0) {
                agentAnalyses.push({
                    type: 'two_months',
                    name: 'Ø¹Ø±Ø¶ Ø´Ù‡Ø±ÙŠÙ† Ù…Ø®ÙØ¶',
                    results: twoMonthsResults,
                    details: agentTwoMonthsDetails
                });
            }
            if (agentAnalyses.length > 0) {
                agentAnalyses.forEach(analysis => {
                    const analysisType = analysis.type;
                    const typeColors = {
                        'basic': { bg: '#e8f5e9', border: '#4caf50', text: '#2e7d32' },
                        'advanced': { bg: '#e3f2fd', border: '#2196f3', text: '#1565c0' },
                        'two_months': { bg: '#fff3e0', border: '#ff9800', text: '#e65100' }
                    };
                    const colors = typeColors[analysisType] || typeColors['basic'];
                    
                    analysesHTML += `<div style="margin-bottom: 20px; background: ${colors.bg}; padding: 15px; border-radius: 8px; border-left: 4px solid ${colors.border};">
                        <h5 style="margin-bottom: 10px; color: ${colors.text}; font-weight: 700; font-size: 1.1rem;">${analysis.name}</h5>`;
                    if (analysis.results && analysis.results.total) {
                        const total = analysis.results.total;
                        analysesHTML += `<div style="background: white; padding: 15px; border-radius: 6px; margin-bottom: 15px; border: 1px solid ${colors.border};">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 15px;">
                                <div style="background: #f5f5f5; padding: 10px; border-radius: 6px;">
                                    <div style="font-size: 0.85rem; color: #666; margin-bottom: 5px;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª</div>
                                    <div style="font-size: 1.3rem; font-weight: 700; color: ${colors.text};">${formatNumber(total.count || 0)}</div>
                                </div>
                                ${total.amount ? `<div style="background: #f5f5f5; padding: 10px; border-radius: 6px;">
                                    <div style="font-size: 0.85rem; color: #666; margin-bottom: 5px;">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</div>
                                    <div style="font-size: 1.2rem; font-weight: 700; color: ${colors.text};">${formatNumber(total.amount)} Ø¯.Ø¹</div>
                                </div>` : ''}
                                ${total.promoAmount ? `<div style="background: #f5f5f5; padding: 10px; border-radius: 6px;">
                                    <div style="font-size: 0.85rem; color: #666; margin-bottom: 5px;">Ù…Ø¨Ù„Øº Ø§Ù„Ø¹Ø±Ø¶</div>
                                    <div style="font-size: 1.2rem; font-weight: 700; color: ${colors.text};">${formatNumber(total.promoAmount)} Ø¯.Ø¹</div>
                                </div>` : ''}
                                ${total.officialAmount ? `<div style="background: #f5f5f5; padding: 10px; border-radius: 6px;">
                                    <div style="font-size: 0.85rem; color: #666; margin-bottom: 5px;">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø±Ø³Ù…ÙŠ</div>
                                    <div style="font-size: 1.2rem; font-weight: 700; color: ${colors.text};">${formatNumber(total.officialAmount)} Ø¯.Ø¹</div>
                                </div>` : ''}
                                ${total.profit !== undefined ? `<div style="background: #e8f5e9; padding: 10px; border-radius: 6px; border: 2px solid #4caf50;">
                                    <div style="font-size: 0.85rem; color: #2e7d32; margin-bottom: 5px;">Ø§Ù„Ø±Ø§Ø¬Ø¹ Ù„Ù„ÙˆÙƒÙŠÙ„</div>
                                    <div style="font-size: 1.3rem; font-weight: 700; color: #2e7d32;">${formatNumber(total.profit)} Ø¯.Ø¹</div>
                                </div>` : ''}
                            </div>`;
                        if (analysis.results.bronze || analysis.results.silver || analysis.results.gold || analysis.results.platinum) {
                            analysesHTML += `<div style="margin-top: 15px; padding-top: 15px; border-top: 2px solid ${colors.border};">
                                <div style="font-weight: 600; margin-bottom: 10px; color: ${colors.text};">Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ:</div>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">`;
                            ['bronze', 'silver', 'gold', 'platinum'].forEach(cat => {
                                const catData = analysis.results[cat];
                                if (catData && (catData.count > 0 || catData.amount > 0 || catData.promoAmount > 0)) {
                                    const catNames = { bronze: 'Bronze', silver: 'Silver', gold: 'Gold', platinum: 'Platinum' };
                                    analysesHTML += `<div style="background: white; padding: 10px; border-radius: 6px; border: 1px solid ${colors.border};">
                                        <div style="font-weight: 600; color: ${colors.text}; margin-bottom: 5px;">${catNames[cat]}</div>
                                        <div style="font-size: 0.9rem;">Ø§Ù„Ø¹Ø¯Ø¯: ${formatNumber(catData.count || 0)}</div>
                                        ${catData.amount ? `<div style="font-size: 0.9rem;">Ø§Ù„Ù…Ø¨Ù„Øº: ${formatNumber(catData.amount)} Ø¯.Ø¹</div>` : ''}
                                        ${catData.promoAmount ? `<div style="font-size: 0.9rem;">Ø¹Ø±Ø¶: ${formatNumber(catData.promoAmount)} Ø¯.Ø¹</div>` : ''}
                                        ${catData.officialAmount ? `<div style="font-size: 0.9rem;">Ø±Ø³Ù…ÙŠ: ${formatNumber(catData.officialAmount)} Ø¯.Ø¹</div>` : ''}
                                    </div>`;
                                }
                            });
                            analysesHTML += `</div></div>`;
                        }
                        analysesHTML += `</div>`;
                    } else if (analysis.details && analysis.details.length > 0) {
                        analysesHTML += `<div style="background: white; padding: 12px; border-radius: 6px; margin-bottom: 15px; border: 1px solid ${colors.border};">
                            <div style="font-size: 1.1rem; font-weight: 600; color: ${colors.text};">
                                Ø¹Ø¯Ø¯ Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª: <span style="color: ${colors.border};">${formatNumber(analysis.details.length)}</span>
                            </div>
                        </div>`;
                    }
                    if (analysis.details && analysis.details.length > 0) {
                        analysesHTML += `<div style="margin-top: 15px;">
                            <strong style="color: var(--primary-color);">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª (${analysis.details.length}):</strong>
                            <div style="background: var(--bg-primary); padding: 10px; border-radius: 8px; margin-top: 5px; max-height: 400px; overflow-y: auto; font-size: 0.85rem;">
                                <table style="width: 100%; border-collapse: collapse;">
                                    <thead>
                                        <tr style="background: var(--bg-secondary); font-weight: 600;">
                                            <th style="padding: 8px; text-align: center; border: 1px solid var(--border-color);">#</th>
                                            <th style="padding: 8px; text-align: right; border: 1px solid var(--border-color);">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
                                            <th style="padding: 8px; text-align: right; border: 1px solid var(--border-color);">Ù†ÙˆØ¹ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ</th>
                                            <th style="padding: 8px; text-align: right; border: 1px solid var(--border-color);">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${analysis.details.slice(0, 100).map((detail, idx) => `
                                            <tr style="border-bottom: 1px solid var(--border-color);">
                                                <td style="padding: 6px; text-align: center; border: 1px solid var(--border-color);">${idx + 1}</td>
                                                <td style="padding: 6px; text-align: right; border: 1px solid var(--border-color);">${detail.username || ''}</td>
                                                <td style="padding: 6px; text-align: right; border: 1px solid var(--border-color);">${detail.subscription || ''}</td>
                                                <td style="padding: 6px; text-align: right; border: 1px solid var(--border-color);">${detail.dateStr || detail.date || ''}</td>
                                            </tr>
                                        `).join('')}
                                        ${analysis.details.length > 100 ? `<tr><td colspan="4" style="text-align: center; padding: 10px; color: var(--text-secondary);">... Ùˆ ${analysis.details.length - 100} Ø³Ø¬Ù„ Ø¥Ø¶Ø§ÙÙŠ</td></tr>` : ''}
                                    </tbody>
                                </table>
                            </div>
                        </div>`;
                    }
                    analysesHTML += `</div>`;
                });
            } else {
                analysesHTML += `<div style="padding: 15px; background: var(--bg-secondary); border-radius: 8px; text-align: center; color: var(--text-secondary);">
                    <p>Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ­Ù„ÙŠÙ„Ø§Øª Ù…Ø³Ø¬Ù„Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„ÙˆÙƒÙŠÙ„ ÙÙŠ Ø§Ù„Ø£Ø±Ø´ÙŠÙ</p>
                </div>`;
            }
            const beforeAnalyses = existingHTML.substring(0, analysesStart);
            const afterAnalysesStart = existingHTML.indexOf('</div>', analysesStart + 200);
            const afterAnalyses = afterAnalysesStart !== -1 ? existingHTML.substring(afterAnalysesStart + 6) : '';
            archiveContent.innerHTML = beforeAnalyses + analysesHTML + afterAnalyses;
        }
        function applyExcelStyling(ws, numRows, numCols) {
            if (!ws || !ws['!ref']) return;
            const range = XLSX.utils.decode_range(ws['!ref']);
            const maxCol = Math.max(range.e.c, numCols - 1);
            const headerRows = new Set();
            const titleRows = new Set();
            const separatorRows = new Set();
            const totalRows = new Set();
            for (let r = 0; r <= range.e.r; r++) {
                const cellAddress = XLSX.utils.encode_cell({ r: r, c: 0 });
                const cell = ws[cellAddress];
                if (cell && cell.v) {
                    const value = String(cell.v);
                    if (value.includes('â•â•â•â•')) {
                        separatorRows.add(r);
                    }
                    else if (value.includes('ØªÙ‚Ø±ÙŠØ±') || value.includes('ØªØ­Ù„ÙŠÙ„') || value.includes('Ù…Ù„Ø®Øµ') || value.includes('Ù…Ø¹Ù„ÙˆÙ…Ø§Øª')) {
                        titleRows.add(r);
                    }
                    else if (value === 'Ø§Ù„Ù†ÙˆØ¹' || value === 'Ø§Ù„Ø¹Ø¯Ø¯' || value === 'Ø§Ù„Ù…Ø¨Ù„Øº' || value === '#' || value === 'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…' || 
                             value === 'Ø§Ø³Ù… Ø§Ù„ÙˆÙƒÙŠÙ„' || value === 'Ø§Ù„Ø´Ù‡Ø±' || value === 'ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØµØ¯ÙŠØ±' || value === 'Ù†Ø³Ø¨Ø© Ø§Ù„ÙˆÙƒÙŠÙ„' ||
                             value === 'Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙƒÙ„ÙŠ' || value === 'Ù†Ø³Ø¨Ø© Ø§Ù„ÙˆÙƒÙŠÙ„' || value === 'Ø§Ù„Ø§Ø³ØªÙ‚Ø·Ø§Ø¹' || value === 'Ø§Ù„ØºØ±Ø§Ù…Ø©' ||
                             value === 'Ø§Ù„ØµØ§ÙÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ' || value === 'Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ' || value === 'Ù…Ø¨Ù„Øº Ø§Ù„Ø¹Ø±Ø¶' || value === 'Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø±Ø³Ù…ÙŠ' ||
                             value === 'Ø§Ù„Ø±Ø¨Ø­/Ø§Ù„Ø±Ø§Ø¬Ø¹' || value === 'Ø³Ø¹Ø± Ø§Ù„Ø¹Ø±Ø¶' || value === 'Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø±Ø³Ù…ÙŠ' || value === 'Ø§Ù„Ø³Ø¹Ø±' ||
                             value === ' Ø§Ù„Ø³Ø¹Ø±' || value === 'Ù†Ø³Ø¨Ø© Ø§Ù„ÙˆÙƒÙŠÙ„' || value === 'Ù…Ø¨Ù„Øº Ø§Ù„Ù†Ø³Ø¨Ø©' || value === 'Ù†ÙˆØ¹ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ' ||
                             value === 'Ø§Ù„ØªØ§Ø±ÙŠØ®' || value === 'ØªØ§Ø±ÙŠØ® 1' || value === 'ØªØ§Ø±ÙŠØ® 2' || value === 'ØªØ§Ø±ÙŠØ® 3' || value === 'Ø§Ù„ÙØ±Ù‚ Ø¨Ø§Ù„Ø£ÙŠØ§Ù…') {
                        headerRows.add(r);
                    }
                    if (value === 'Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ') {
                        totalRows.add(r);
                    }
                }
            }
            for (let r = 0; r <= range.e.r; r++) {
                const isSeparatorRow = separatorRows.has(r);
                const isTitleRow = titleRows.has(r);
                const isHeaderRow = headerRows.has(r);
                const isTotalRow = totalRows.has(r);
                const isEvenRow = r % 2 === 0 && !isTitleRow && !isHeaderRow && !isSeparatorRow && !isTotalRow;
                for (let c = 0; c <= maxCol; c++) {
                    const cellAddress = XLSX.utils.encode_cell({ r: r, c: c });
                    if (!ws[cellAddress]) continue;
                    let bgColor = isEvenRow ? "F2F2F2" : "FFFFFF";
                    let fontSize = 11;
                    let isBold = false;
                    let borderStyle = "thin";
                    let borderColor = "CCCCCC";
                    if (isSeparatorRow) {
                        bgColor = "E8F4F8";
                        fontSize = 10;
                        isBold = false;
                        borderStyle = "thin";
                        borderColor = "CCCCCC";
                    }
                    else if (isTitleRow) {
                        bgColor = "E8F4F8";
                        fontSize = 14;
                        isBold = true;
                        borderStyle = "medium";
                        borderColor = "000000";
                    }
                    else if (isHeaderRow) {
                        bgColor = "801C32";
                        fontSize = 12;
                        isBold = true;
                        borderStyle = "medium";
                        borderColor = "000000";
                    }
                    else if (isTotalRow) {
                        bgColor = "FFF8F9FA";
                        fontSize = 12;
                        isBold = true;
                        borderStyle = "thick";
                        borderColor = "801C32";
                    }
                    if (ws[cellAddress].t === 'n' && c >= 1) {
                        ws[cellAddress].z = '#,##0';
                    }
                    ws[cellAddress].s = {
                        fill: {
                            fgColor: { rgb: bgColor }
                        },
                        font: {
                            bold: isBold,
                            sz: fontSize,
                            color: { rgb: isHeaderRow ? "FFFFFF" : "000000" }
                        },
                        alignment: {
                            horizontal: c === 0 ? "right" : "center",
                            vertical: "center",
                            wrapText: isTitleRow || isHeaderRow
                        },
                        border: {
                            top: { style: borderStyle, color: { rgb: borderColor } },
                            bottom: { style: borderStyle, color: { rgb: borderColor } },
                            left: { style: borderStyle, color: { rgb: borderColor } },
                            right: { style: borderStyle, color: { rgb: borderColor } }
                        }
                    };
                }
            }
            if (!ws['!rows']) {
                ws['!rows'] = [];
            }
            for (let r = 0; r <= range.e.r; r++) {
                if (separatorRows.has(r)) {
                    ws['!rows'][r] = { hpt: 15 };
                } else if (titleRows.has(r)) {
                    ws['!rows'][r] = { hpt: 25 };
                } else if (headerRows.has(r)) {
                    ws['!rows'][r] = { hpt: 30 };
                } else if (totalRows.has(r)) {
                    ws['!rows'][r] = { hpt: 25 };
                } else {
                    ws['!rows'][r] = { hpt: 20 };
                }
            }
            if (!ws['!cols']) {
                ws['!cols'] = [];
            }
            for (let c = 0; c <= maxCol; c++) {
                ws['!cols'][c] = { wch: c === 0 ? 25 : (c === 1 ? 15 : 18) };
            }
        }
        async function exportAgentArchiveReport(agentName, monthYear) {
            if (!supabaseClient) {
                alert('Supabase ØºÙŠØ± Ù…ØªØµÙ„');
                return;
            }
            try {
                showSuccessMessage('Ø¬Ø§Ø±ÙŠ ØªØ­Ø¶ÙŠØ± Ø§Ù„ØªÙ‚Ø±ÙŠØ±...');
                const percentagesArchive = await getArchiveForMonth('agent_percentages', monthYear);
                const { data: basicArchiveData } = await supabaseClient.from('analysis_archives').select('*').eq('month_year', monthYear).eq('analysis_type', 'basic').maybeSingle();
                const { data: advancedArchiveData } = await supabaseClient.from('analysis_archives').select('*').eq('month_year', monthYear).eq('analysis_type', 'advanced').maybeSingle();
                const { data: twoMonthsArchiveData } = await supabaseClient.from('analysis_archives').select('*').eq('month_year', monthYear).eq('analysis_type', 'two_months').maybeSingle();
                if (!percentagesArchive || !percentagesArchive.data || !percentagesArchive.data[agentName]) {
                    alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„ÙˆÙƒÙŠÙ„ ÙÙŠ Ø§Ù„Ø£Ø±Ø´ÙŠÙ');
                    return;
                }
                const agentData = percentagesArchive.data[agentName];
                const filterDetailsByAgent = (details, agentName) => {
                    if (!details || !Array.isArray(details)) return [];
                    return details.filter(d => {
                        const agent = d.agent || d.Agent || d.agentName || d.AgentName || d['Ø§Ø³Ù… Ø§Ù„ÙˆÙƒÙŠÙ„'] || d['Ø§Ù„ÙˆÙƒÙŠÙ„'];
                        return agent === agentName;
                    });
                };
                const getAgentResultsFromArchive = (archiveData, agentName, type) => {
                    if (!archiveData || !archiveData.data) return null;
                    if (archiveData.data.agentReports && archiveData.data.agentReports[agentName]) {
                        const agentReport = archiveData.data.agentReports[agentName];
                        if (type === 'basic' && agentReport.basic) {
                            return agentReport.basic;
                        }
                        if (type === 'advanced' && agentReport.advanced) {
                            return agentReport.advanced;
                        }
                        if (type === 'two_months' && agentReport.twoMonths) {
                            return agentReport.twoMonths;
                        }
                    }
                    if (archiveData.data.results) {
                        if (archiveData.data.results.agentName === agentName) {
                            return archiveData.data.results;
                        }
                        if (archiveData.data.results[agentName]) {
                            if (type === 'basic' && archiveData.data.results[agentName].basic) {
                                return archiveData.data.results[agentName].basic;
                            }
                            if (type === 'advanced' && archiveData.data.results[agentName].advanced) {
                                return archiveData.data.results[agentName].advanced;
                            }
                            if (type === 'two_months' && archiveData.data.results[agentName].twoMonths) {
                                return archiveData.data.results[agentName].twoMonths;
                            }
                        }
                    }
                    return null;
                };
                const basicArchive = basicArchiveData ? { data: basicArchiveData.data, raw: basicArchiveData } : null;
                const advancedArchive = advancedArchiveData ? { data: advancedArchiveData.data, raw: advancedArchiveData } : null;
                const twoMonthsArchive = twoMonthsArchiveData ? { data: twoMonthsArchiveData.data, raw: twoMonthsArchiveData } : null;
                const agentBasicDetails = basicArchive ? filterDetailsByAgent(basicArchive.data.details, agentName) : [];
                const agentAdvancedDetails = advancedArchive ? filterDetailsByAgent(advancedArchive.data.details, agentName) : [];
                const agentTwoMonthsDetails = twoMonthsArchive ? filterDetailsByAgent(twoMonthsArchive.data.details, agentName) : [];
                const basicResults = basicArchive ? getAgentResultsFromArchive(basicArchive, agentName, 'basic') : null;
                const advancedResults = advancedArchive ? getAgentResultsFromArchive(advancedArchive, agentName, 'advanced') : null;
                const twoMonthsResults = twoMonthsArchive ? getAgentResultsFromArchive(twoMonthsArchive, agentName, 'two_months') : null;
                const wb = XLSX.utils.book_new();
                const totalCount = (Number(agentData.countB) || 0) + (Number(agentData.countG) || 0) + (Number(agentData.countS) || 0) + (Number(agentData.countP) || 0);
                const totalAmount = (Number(agentData.iqB) || 0) + (Number(agentData.iqG) || 0) + (Number(agentData.iqS) || 0) + (Number(agentData.iqP) || 0);
                const percentageData = [
                    ['â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'],
                    ['ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø§Ø±Ø´ÙŠÙ '],
                    ['â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'],
                    [],
                    ['Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªÙ‚Ø±ÙŠØ±'],
                    ['Ø§Ø³Ù… Ø§Ù„ÙˆÙƒÙŠÙ„', (() => {
                        const agent = agentsList.find(a => a.name === agentName);
                        const agentSubName = agent?.subName || '';
                        return agentSubName ? `${agentName}\n${agentSubName}` : agentName;
                    })()],
                    ['Ø§Ù„Ø´Ù‡Ø±', monthYear],
                    ['ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØµØ¯ÙŠØ±', new Date().toLocaleString('ar-IQ')],
                    [],
                    ['â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'],
                    ['Ù…Ù„Ø®Øµ Ø§Ù„Ù†Ø³Ø¨ ÙˆØ§Ù„ØªÙØ§ØµÙŠÙ„'],
                    ['â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'],
                    [],
                    ['Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©'],
                    ['Ù†Ø³Ø¨Ø© Ø§Ù„ÙˆÙƒÙŠÙ„ ', `${agentData.percentage || 0}%`],
                    ['Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙƒÙ„ÙŠ', `${formatNumber(agentData.iqT || 0)} Ø¯.Ø¹`],
                    ['Ù†Ø³Ø¨Ø© Ø§Ù„ÙˆÙƒÙŠÙ„', `${formatNumber(agentData.agentPercentageAmount || 0)} Ø¯.Ø¹`],
                    [],
                    ['Ø§Ù„Ø§Ø³ØªÙ‚Ø·Ø§Ø¹Ø§Øª ÙˆØ§Ù„ØºØ±Ø§Ù…Ø§Øª'],
                    ['Ø§Ù„Ø§Ø³ØªÙ‚Ø·Ø§Ø¹', `${formatNumber(agentData.deductions || 0)} Ø¯.Ø¹`],
                    ['Ø§Ù„ØºØ±Ø§Ù…Ø©', `${formatNumber(agentData.penalties || 0)} Ø¯.Ø¹`],
                    [],
                    ['Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ'],
                    ['Ø§Ù„ØµØ§ÙÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ', `${formatNumber(agentData.netPercentage || 0)} Ø¯.Ø¹`],
                    [],
                    ['â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'],
                    ['ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù†Ø³Ø¨Ø© Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ'],
                    ['â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'],
                    [],
                    ['Ø§Ù„Ù†ÙˆØ¹', 'Ø§Ù„Ø¹Ø¯Ø¯', 'Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ', ' Ø§Ù„Ø³Ø¹Ø±', 'Ù†Ø³Ø¨Ø© Ø§Ù„ÙˆÙƒÙŠÙ„', 'Ù…Ø¨Ù„Øº Ø§Ù„Ù†Ø³Ø¨Ø©'],
                    ['Bronze ', Number(agentData.countB) || 0, formatNumber(Number(agentData.iqB) || 0) + ' Ø¯.Ø¹', agentData.countB ? formatNumber((Number(agentData.iqB) / Number(agentData.countB)) || 0) + ' Ø¯.Ø¹' : '0 Ø¯.Ø¹', (agentData.percentage || 0) + '%', formatNumber(((Number(agentData.iqB) || 0) * (Number(agentData.percentage) || 0)) / 100) + ' Ø¯.Ø¹'],
                    ['Gold ', Number(agentData.countG) || 0, formatNumber(Number(agentData.iqG) || 0) + ' Ø¯.Ø¹', agentData.countG ? formatNumber((Number(agentData.iqG) / Number(agentData.countG)) || 0) + ' Ø¯.Ø¹' : '0 Ø¯.Ø¹', (agentData.percentage || 0) + '%', formatNumber(((Number(agentData.iqG) || 0) * (Number(agentData.percentage) || 0)) / 100) + ' Ø¯.Ø¹'],
                    ['Silver ', Number(agentData.countS) || 0, formatNumber(Number(agentData.iqS) || 0) + ' Ø¯.Ø¹', agentData.countS ? formatNumber((Number(agentData.iqS) / Number(agentData.countS)) || 0) + ' Ø¯.Ø¹' : '0 Ø¯.Ø¹', (agentData.percentage || 0) + '%', formatNumber(((Number(agentData.iqS) || 0) * (Number(agentData.percentage) || 0)) / 100) + ' Ø¯.Ø¹'],
                    ['Platinum ', Number(agentData.countP) || 0, formatNumber(Number(agentData.iqP) || 0) + ' Ø¯.Ø¹', agentData.countP ? formatNumber((Number(agentData.iqP) / Number(agentData.countP)) || 0) + ' Ø¯.Ø¹' : '0 Ø¯.Ø¹', (agentData.percentage || 0) + '%', formatNumber(((Number(agentData.iqP) || 0) * (Number(agentData.percentage) || 0)) / 100) + ' Ø¯.Ø¹'],
                    [],
                    ['Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ', totalCount, formatNumber(totalAmount) + ' Ø¯.Ø¹', totalCount > 0 ? formatNumber(totalAmount / totalCount) + ' Ø¯.Ø¹' : '0 Ø¯.Ø¹', (agentData.percentage || 0) + '%', formatNumber(agentData.agentPercentageAmount || 0) + ' Ø¯.Ø¹']
                ];
                const ws1 = XLSX.utils.aoa_to_sheet(percentageData);
                applyExcelStyling(ws1, percentageData.length, percentageData[0] ? percentageData[0].length : 0);
                XLSX.utils.book_append_sheet(wb, ws1, 'Ù…Ù„Ø®Øµ Ø§Ù„Ù†Ø³Ø¨');
                if (basicResults || agentBasicDetails.length > 0) {
                    let totalCount = basicResults ? (basicResults.total.count || 0) : agentBasicDetails.length;
                    let totalAmount = 0;
                    if (basicResults && basicResults.total.amount) {
                        totalAmount = basicResults.total.amount;
                    } else {
                        agentBasicDetails.forEach(d => {
                            if (d.price) totalAmount += Number(d.price) || 0;
                        });
                    }
                    const basicSheetData = [
                        ['â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'],
                        ['ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠ'],
                        ['â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'],
                        [],
                        ['Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªØ­Ù„ÙŠÙ„'],
                        ['Ø§Ø³Ù… Ø§Ù„ÙˆÙƒÙŠÙ„', agentName],
                        ['Ø§Ù„Ø´Ù‡Ø±', monthYear],
                        [],
                        ['â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'],
                        ['Ù…Ù„Ø®Øµ Ø§Ù„ØªØ­Ù„ÙŠÙ„'],
                        ['â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'],
                        [],
                        ['Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ', totalCount],
                        ['Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ', `${formatNumber(totalAmount)} Ø¯.Ø¹`],
                        [],
                        ['â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'],
                        ['ØªÙØ§ØµÙŠÙ„ Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ'],
                        ['â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'],
                        [],
                        ['Ø§Ù„Ù†ÙˆØ¹', 'Ø§Ù„Ø¹Ø¯Ø¯', 'Ø§Ù„Ù…Ø¨Ù„Øº'],
                        ['Bronze', (basicResults && basicResults.bronze && basicResults.bronze.count !== undefined) ? Number(basicResults.bronze.count) : 0, (basicResults && basicResults.bronze && basicResults.bronze.amount) ? `${formatNumber(basicResults.bronze.amount)} Ø¯.Ø¹` : '0 Ø¯.Ø¹'],
                        ['Silver', (basicResults && basicResults.silver && basicResults.silver.count !== undefined) ? Number(basicResults.silver.count) : 0, (basicResults && basicResults.silver && basicResults.silver.amount) ? `${formatNumber(basicResults.silver.amount)} Ø¯.Ø¹` : '0 Ø¯.Ø¹'],
                        ['Gold', (basicResults && basicResults.gold && basicResults.gold.count !== undefined) ? Number(basicResults.gold.count) : 0, (basicResults && basicResults.gold && basicResults.gold.amount) ? `${formatNumber(basicResults.gold.amount)} Ø¯.Ø¹` : '0 Ø¯.Ø¹'],
                        ['Platinum', (basicResults && basicResults.platinum && basicResults.platinum.count !== undefined) ? Number(basicResults.platinum.count) : 0, (basicResults && basicResults.platinum && basicResults.platinum.amount) ? `${formatNumber(basicResults.platinum.amount)} Ø¯.Ø¹` : '0 Ø¯.Ø¹'],
                        [],
                        ['â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'],
                        ['ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª Ø§Ù„ÙƒØ§Ù…Ù„Ø©'],
                        ['â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'],
                        [],
                        ['#', 'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…', 'Ù†ÙˆØ¹ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ', 'Ø§Ù„ØªØ§Ø±ÙŠØ®', 'Ø§Ù„Ø³Ø¹Ø±', 'Ø³Ø¹Ø± Ø§Ù„Ø¹Ø±Ø¶', 'Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø±Ø³Ù…ÙŠ']
                    ];
                    agentBasicDetails.forEach((detail, idx) => {
                        const dateStr = detail.dateStr || detail.date || detail.createdAt || detail.date1 || '';
                        let price = detail.price;
                        let promoPrice = detail.promoPrice;
                        let officialPrice = detail.officialPrice;
                        if (!price && !promoPrice && !officialPrice && detail.subscription) {
                            const category = getSubscriptionCategory(detail.subscription, detail.agent || '');
                            if (category) {
                                price = getSubscriptionPrice(detail.subscription, category, 'basic');
                                promoPrice = price;
                                officialPrice = price;
                            }
                        }
                        const priceStr = price ? `${formatNumber(price)} Ø¯.Ø¹` : '-';
                        const promoPriceStr = promoPrice ? `${formatNumber(promoPrice)} Ø¯.Ø¹` : '-';
                        const officialPriceStr = officialPrice ? `${formatNumber(officialPrice)} Ø¯.Ø¹` : '-';
                        basicSheetData.push([
                            idx + 1,
                            detail.username || '',
                            detail.subscription || '',
                            dateStr,
                            priceStr,
                            promoPriceStr,
                            officialPriceStr
                        ]);
                    });
                    const ws2 = XLSX.utils.aoa_to_sheet(basicSheetData);
                    applyExcelStyling(ws2, basicSheetData.length, basicSheetData[0] ? basicSheetData[0].length : 0);
                    XLSX.utils.book_append_sheet(wb, ws2, 'Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠ');
                }
                if (advancedResults || agentAdvancedDetails.length > 0) {
                    let totalCount = advancedResults ? (advancedResults.total.count || 0) : agentAdvancedDetails.length;
                    let totalPromoAmount = 0;
                    let totalOfficialAmount = 0;
                    if (advancedResults && advancedResults.total) {
                        totalPromoAmount = advancedResults.total.promoAmount || 0;
                        totalOfficialAmount = advancedResults.total.officialAmount || 0;
                    } else {
                        agentAdvancedDetails.forEach(d => {
                            if (d.promoPrice) totalPromoAmount += Number(d.promoPrice) || 0;
                            if (d.officialPrice) totalOfficialAmount += Number(d.officialPrice) || 0;
                        });
                    }
                    const totalProfit = totalOfficialAmount - totalPromoAmount;
                    const agent = agentsList.find(a => a.name === agentName);
                    const agentSubName = agent?.subName || '';
                    const agentDisplayName = agentSubName ? `${agentName}\n${agentSubName}` : agentName;
                    
                    const advancedSheetData = [
                        ['â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'],
                        ['ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø®ÙØ¶ Ù„Ø«Ù„Ø§Ø« Ø£Ø´Ù‡Ø±'],
                        ['â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'],
                        [],
                        ['Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªØ­Ù„ÙŠÙ„'],
                        ['Ø§Ø³Ù… Ø§Ù„ÙˆÙƒÙŠÙ„', agentDisplayName],
                        ['Ø§Ù„Ø´Ù‡Ø±', monthYear],
                        [],
                        ['â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'],
                        ['Ù…Ù„Ø®Øµ Ø§Ù„ØªØ­Ù„ÙŠÙ„'],
                        ['â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'],
                        [],
                        ['Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ', totalCount],
                        ['Ù…Ø¨Ù„Øº Ø§Ù„Ø¹Ø±Ø¶', `${formatNumber(totalPromoAmount)} Ø¯.Ø¹`],
                        ['Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø±Ø³Ù…ÙŠ', `${formatNumber(totalOfficialAmount)} Ø¯.Ø¹`],
                        ['Ø§Ù„Ø±Ø¨Ø­/Ø§Ù„Ø±Ø§Ø¬Ø¹', `${formatNumber(totalProfit)} Ø¯.Ø¹`],
                        [],
                        ['â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'],
                        ['ØªÙØ§ØµÙŠÙ„ Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ'],
                        ['â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'],
                        [],
                        ['Ø§Ù„Ù†ÙˆØ¹', 'Ø§Ù„Ø¹Ø¯Ø¯', 'Ù…Ø¨Ù„Øº Ø§Ù„Ø¹Ø±Ø¶', 'Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø±Ø³Ù…ÙŠ', 'Ø§Ù„Ø±Ø¨Ø­/Ø§Ù„Ø±Ø§Ø¬Ø¹'],
                        ['Bronze', (advancedResults && advancedResults.bronze && advancedResults.bronze.count !== undefined) ? Number(advancedResults.bronze.count) : 0, 
                         (advancedResults && advancedResults.bronze && advancedResults.bronze.promoAmount) ? `${formatNumber(advancedResults.bronze.promoAmount)} Ø¯.Ø¹` : '0 Ø¯.Ø¹',
                         (advancedResults && advancedResults.bronze && advancedResults.bronze.officialAmount) ? `${formatNumber(advancedResults.bronze.officialAmount)} Ø¯.Ø¹` : '0 Ø¯.Ø¹',
                         (advancedResults && advancedResults.bronze && advancedResults.bronze.officialAmount && advancedResults.bronze.promoAmount) ? `${formatNumber(advancedResults.bronze.officialAmount - advancedResults.bronze.promoAmount)} Ø¯.Ø¹` : '0 Ø¯.Ø¹'],
                        ['Silver', (advancedResults && advancedResults.silver && advancedResults.silver.count !== undefined) ? Number(advancedResults.silver.count) : 0,
                         (advancedResults && advancedResults.silver && advancedResults.silver.promoAmount) ? `${formatNumber(advancedResults.silver.promoAmount)} Ø¯.Ø¹` : '0 Ø¯.Ø¹',
                         (advancedResults && advancedResults.silver && advancedResults.silver.officialAmount) ? `${formatNumber(advancedResults.silver.officialAmount)} Ø¯.Ø¹` : '0 Ø¯.Ø¹',
                         (advancedResults && advancedResults.silver && advancedResults.silver.officialAmount && advancedResults.silver.promoAmount) ? `${formatNumber(advancedResults.silver.officialAmount - advancedResults.silver.promoAmount)} Ø¯.Ø¹` : '0 Ø¯.Ø¹'],
                        ['Gold', (advancedResults && advancedResults.gold && advancedResults.gold.count !== undefined) ? Number(advancedResults.gold.count) : 0,
                         (advancedResults && advancedResults.gold && advancedResults.gold.promoAmount) ? `${formatNumber(advancedResults.gold.promoAmount)} Ø¯.Ø¹` : '0 Ø¯.Ø¹',
                         (advancedResults && advancedResults.gold && advancedResults.gold.officialAmount) ? `${formatNumber(advancedResults.gold.officialAmount)} Ø¯.Ø¹` : '0 Ø¯.Ø¹',
                         (advancedResults && advancedResults.gold && advancedResults.gold.officialAmount && advancedResults.gold.promoAmount) ? `${formatNumber(advancedResults.gold.officialAmount - advancedResults.gold.promoAmount)} Ø¯.Ø¹` : '0 Ø¯.Ø¹'],
                        ['Platinum', (advancedResults && advancedResults.platinum && advancedResults.platinum.count !== undefined) ? Number(advancedResults.platinum.count) : 0,
                         (advancedResults && advancedResults.platinum && advancedResults.platinum.promoAmount) ? `${formatNumber(advancedResults.platinum.promoAmount)} Ø¯.Ø¹` : '0 Ø¯.Ø¹',
                         (advancedResults && advancedResults.platinum && advancedResults.platinum.officialAmount) ? `${formatNumber(advancedResults.platinum.officialAmount)} Ø¯.Ø¹` : '0 Ø¯.Ø¹',
                         (advancedResults && advancedResults.platinum && advancedResults.platinum.officialAmount && advancedResults.platinum.promoAmount) ? `${formatNumber(advancedResults.platinum.officialAmount - advancedResults.platinum.promoAmount)} Ø¯.Ø¹` : '0 Ø¯.Ø¹'],
                        [],
                        ['â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'],
                        ['ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª Ø§Ù„ÙƒØ§Ù…Ù„Ø©'],
                        ['â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'],
                        [],
                        ['#', 'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…', 'Ù†ÙˆØ¹ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ', 'Ø§Ù„ØªØ§Ø±ÙŠØ®', 'ØªØ§Ø±ÙŠØ® 1', 'ØªØ§Ø±ÙŠØ® 2', 'ØªØ§Ø±ÙŠØ® 3', 'Ø§Ù„ÙØ±Ù‚ Ø¨Ø§Ù„Ø£ÙŠØ§Ù…', 'Ø³Ø¹Ø± Ø§Ù„Ø¹Ø±Ø¶', 'Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø±Ø³Ù…ÙŠ']
                    ];
                    agentAdvancedDetails.forEach((detail, idx) => {
                        const date1 = detail.date1 || '';
                        const date2 = detail.date2 || '';
                        const date3 = detail.date3 || '';
                        const dateStr = detail.dateStr || detail.date || detail.createdAt || date1 || '';
                        const daysDiff = detail.daysDiff !== undefined && detail.daysDiff !== null ? detail.daysDiff : '-';
                        let promoPrice = detail.promoPrice;
                        let officialPrice = detail.officialPrice;
                        if (!promoPrice && !officialPrice && detail.subscription) {
                            const category = getSubscriptionCategory(detail.subscription, detail.agent || '');
                            if (category) {
                                promoPrice = getSubscriptionPrice(detail.subscription, category, 'advanced', 'promo');
                                officialPrice = getSubscriptionPrice(detail.subscription, category, 'advanced', 'official');
                            }
                        }
                        const promoPriceStr = promoPrice ? `${formatNumber(promoPrice)} Ø¯.Ø¹` : '-';
                        const officialPriceStr = officialPrice ? `${formatNumber(officialPrice)} Ø¯.Ø¹` : '-';
                        advancedSheetData.push([
                            idx + 1,
                            detail.username || '',
                            detail.subscription || '',
                            dateStr,
                            date1,
                            date2,
                            date3,
                            daysDiff,
                            promoPriceStr,
                            officialPriceStr
                        ]);
                    });
                    const ws3 = XLSX.utils.aoa_to_sheet(advancedSheetData);
                    applyExcelStyling(ws3, advancedSheetData.length, advancedSheetData[0] ? advancedSheetData[0].length : 0);
                    XLSX.utils.book_append_sheet(wb, ws3, '3 Ø£Ø´Ù‡Ø± Ù…Ø®ÙØ¶');
                }
                if (twoMonthsResults || agentTwoMonthsDetails.length > 0) {
                    let totalCount = twoMonthsResults ? (twoMonthsResults.total.count || 0) : agentTwoMonthsDetails.length;
                    let totalPromoAmount = 0;
                    let totalOfficialAmount = 0;
                    if (twoMonthsResults && twoMonthsResults.total) {
                        totalPromoAmount = twoMonthsResults.total.promoAmount || 0;
                        totalOfficialAmount = twoMonthsResults.total.officialAmount || 0;
                    } else {
                        agentTwoMonthsDetails.forEach(d => {
                            if (d.promoPrice) totalPromoAmount += Number(d.promoPrice) || 0;
                            if (d.officialPrice) totalOfficialAmount += Number(d.officialPrice) || 0;
                        });
                    }
                    const totalProfit = totalOfficialAmount - totalPromoAmount;
                    const agent = agentsList.find(a => a.name === agentName);
                    const agentSubName = agent?.subName || '';
                    const agentDisplayName = agentSubName ? `${agentName}\n${agentSubName}` : agentName;
                    
                    const twoMonthsSheetData = [
                        ['â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'],
                        ['ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø®ÙØ¶ Ù„Ø´Ù‡Ø±ÙŠÙ†'],
                        ['â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'],
                        [],
                        ['Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªØ­Ù„ÙŠÙ„'],
                        ['Ø§Ø³Ù… Ø§Ù„ÙˆÙƒÙŠÙ„', agentDisplayName],
                        ['Ø§Ù„Ø´Ù‡Ø±', monthYear],
                        [],
                        ['â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'],
                        ['Ù…Ù„Ø®Øµ Ø§Ù„ØªØ­Ù„ÙŠÙ„'],
                        ['â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'],
                        [],
                        ['Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ', totalCount],
                        ['Ù…Ø¨Ù„Øº Ø§Ù„Ø¹Ø±Ø¶', `${formatNumber(totalPromoAmount)} Ø¯.Ø¹`],
                        ['Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø±Ø³Ù…ÙŠ', `${formatNumber(totalOfficialAmount)} Ø¯.Ø¹`],
                        ['Ø§Ù„Ø±Ø¨Ø­/Ø§Ù„Ø±Ø§Ø¬Ø¹', `${formatNumber(totalProfit)} Ø¯.Ø¹`],
                        [],
                        ['â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'],
                        ['ØªÙØ§ØµÙŠÙ„ Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ'],
                        ['â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'],
                        [],
                        ['Ø§Ù„Ù†ÙˆØ¹', 'Ø§Ù„Ø¹Ø¯Ø¯', 'Ù…Ø¨Ù„Øº Ø§Ù„Ø¹Ø±Ø¶', 'Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø±Ø³Ù…ÙŠ', 'Ø§Ù„Ø±Ø¨Ø­/Ø§Ù„Ø±Ø§Ø¬Ø¹'],
                        ['Bronze', (twoMonthsResults && twoMonthsResults.bronze && twoMonthsResults.bronze.count !== undefined) ? Number(twoMonthsResults.bronze.count) : 0,
                         (twoMonthsResults && twoMonthsResults.bronze && twoMonthsResults.bronze.promoAmount) ? `${formatNumber(twoMonthsResults.bronze.promoAmount)} Ø¯.Ø¹` : '0 Ø¯.Ø¹',
                         (twoMonthsResults && twoMonthsResults.bronze && twoMonthsResults.bronze.officialAmount) ? `${formatNumber(twoMonthsResults.bronze.officialAmount)} Ø¯.Ø¹` : '0 Ø¯.Ø¹',
                         (twoMonthsResults && twoMonthsResults.bronze && twoMonthsResults.bronze.officialAmount && twoMonthsResults.bronze.promoAmount) ? `${formatNumber(twoMonthsResults.bronze.officialAmount - twoMonthsResults.bronze.promoAmount)} Ø¯.Ø¹` : '0 Ø¯.Ø¹'],
                        ['Silver', (twoMonthsResults && twoMonthsResults.silver && twoMonthsResults.silver.count !== undefined) ? Number(twoMonthsResults.silver.count) : 0,
                         (twoMonthsResults && twoMonthsResults.silver && twoMonthsResults.silver.promoAmount) ? `${formatNumber(twoMonthsResults.silver.promoAmount)} Ø¯.Ø¹` : '0 Ø¯.Ø¹',
                         (twoMonthsResults && twoMonthsResults.silver && twoMonthsResults.silver.officialAmount) ? `${formatNumber(twoMonthsResults.silver.officialAmount)} Ø¯.Ø¹` : '0 Ø¯.Ø¹',
                         (twoMonthsResults && twoMonthsResults.silver && twoMonthsResults.silver.officialAmount && twoMonthsResults.silver.promoAmount) ? `${formatNumber(twoMonthsResults.silver.officialAmount - twoMonthsResults.silver.promoAmount)} Ø¯.Ø¹` : '0 Ø¯.Ø¹'],
                        ['Gold', (twoMonthsResults && twoMonthsResults.gold && twoMonthsResults.gold.count !== undefined) ? Number(twoMonthsResults.gold.count) : 0,
                         (twoMonthsResults && twoMonthsResults.gold && twoMonthsResults.gold.promoAmount) ? `${formatNumber(twoMonthsResults.gold.promoAmount)} Ø¯.Ø¹` : '0 Ø¯.Ø¹',
                         (twoMonthsResults && twoMonthsResults.gold && twoMonthsResults.gold.officialAmount) ? `${formatNumber(twoMonthsResults.gold.officialAmount)} Ø¯.Ø¹` : '0 Ø¯.Ø¹',
                         (twoMonthsResults && twoMonthsResults.gold && twoMonthsResults.gold.officialAmount && twoMonthsResults.gold.promoAmount) ? `${formatNumber(twoMonthsResults.gold.officialAmount - twoMonthsResults.gold.promoAmount)} Ø¯.Ø¹` : '0 Ø¯.Ø¹'],
                        ['Platinum', (twoMonthsResults && twoMonthsResults.platinum && twoMonthsResults.platinum.count !== undefined) ? Number(twoMonthsResults.platinum.count) : 0,
                         (twoMonthsResults && twoMonthsResults.platinum && twoMonthsResults.platinum.promoAmount) ? `${formatNumber(twoMonthsResults.platinum.promoAmount)} Ø¯.Ø¹` : '0 Ø¯.Ø¹',
                         (twoMonthsResults && twoMonthsResults.platinum && twoMonthsResults.platinum.officialAmount) ? `${formatNumber(twoMonthsResults.platinum.officialAmount)} Ø¯.Ø¹` : '0 Ø¯.Ø¹',
                         (twoMonthsResults && twoMonthsResults.platinum && twoMonthsResults.platinum.officialAmount && twoMonthsResults.platinum.promoAmount) ? `${formatNumber(twoMonthsResults.platinum.officialAmount - twoMonthsResults.platinum.promoAmount)} Ø¯.Ø¹` : '0 Ø¯.Ø¹'],
                        [],
                        ['â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'],
                        ['ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª Ø§Ù„ÙƒØ§Ù…Ù„Ø©'],
                        ['â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'],
                        [],
                        ['#', 'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…', 'Ù†ÙˆØ¹ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ', 'Ø§Ù„ØªØ§Ø±ÙŠØ®', 'ØªØ§Ø±ÙŠØ® 1', 'ØªØ§Ø±ÙŠØ® 2', 'Ø§Ù„ÙØ±Ù‚ Ø¨Ø§Ù„Ø£ÙŠØ§Ù…', 'Ø³Ø¹Ø± Ø§Ù„Ø¹Ø±Ø¶', 'Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø±Ø³Ù…ÙŠ']
                    ];
                    agentTwoMonthsDetails.forEach((detail, idx) => {
                        const date1 = detail.date1 || '';
                        const date2 = detail.date2 || '';
                        const dateStr = detail.dateStr || detail.date || detail.createdAt || date1 || '';
                        const daysDiff = detail.daysDiff !== undefined && detail.daysDiff !== null ? detail.daysDiff : '-';
                        let promoPrice = detail.promoPrice;
                        let officialPrice = detail.officialPrice;
                        if (!promoPrice && !officialPrice && detail.subscription) {
                            const category = getSubscriptionCategory(detail.subscription, detail.agent || '');
                            if (category) {
                                promoPrice = getSubscriptionPrice(detail.subscription, category, 'twoMonths', 'promo');
                                const monthlyOfficialPrice = getSubscriptionPrice(detail.subscription, category, 'basic');
                                officialPrice = monthlyOfficialPrice * 2;
                            }
                        }
                        const promoPriceStr = promoPrice ? `${formatNumber(promoPrice)} Ø¯.Ø¹` : '-';
                        const officialPriceStr = officialPrice ? `${formatNumber(officialPrice)} Ø¯.Ø¹` : '-';
                        twoMonthsSheetData.push([
                            idx + 1,
                            detail.username || '',
                            detail.subscription || '',
                            dateStr,
                            date1,
                            date2,
                            daysDiff,
                            promoPriceStr,
                            officialPriceStr
                        ]);
                    });
                    const ws4 = XLSX.utils.aoa_to_sheet(twoMonthsSheetData);
                    applyExcelStyling(ws4, twoMonthsSheetData.length, twoMonthsSheetData[0] ? twoMonthsSheetData[0].length : 0);
                    XLSX.utils.book_append_sheet(wb, ws4, 'Ø´Ù‡Ø±ÙŠÙ† Ù…Ø®ÙØ¶');
                }
                const filename = `ØªÙ‚Ø±ÙŠØ±_${agentName}_${monthYear}_${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, filename);
                showSuccessMessage(`ØªÙ… ØªØµØ¯ÙŠØ± ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙˆÙƒÙŠÙ„ ${agentName} Ø¨Ù†Ø¬Ø§Ø­`);
                await logActivity('ØªØµØ¯ÙŠØ± ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ø±Ø´ÙŠÙ', `ØªÙ… ØªØµØ¯ÙŠØ± ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ø±Ø´ÙŠÙ Ø§Ù„ÙƒØ§Ù…Ù„ Ù„Ù„ÙˆÙƒÙŠÙ„ ${agentName} Ù„Ø´Ù‡Ø± ${monthYear}`);
            } catch (error) {
                console.error('Error exporting agent archive report:', error);
                alert('Ø®Ø·Ø£ ÙÙŠ ØªØµØ¯ÙŠØ± Ø§Ù„ØªÙ‚Ø±ÙŠØ±: ' + error.message);
            }
        }
        async function printArchivePDF(agentName, monthYear) {
            if (!supabaseClient) {
                alert('Supabase ØºÙŠØ± Ù…ØªØµÙ„');
                return;
            }
            try {
                showSuccessMessage('Ø¬Ø§Ø±ÙŠ ØªØ­Ø¶ÙŠØ± Ø§Ù„ØªÙ‚Ø±ÙŠØ±...');
                const percentagesArchive = await getArchiveForMonth('agent_percentages', monthYear);
                if (!percentagesArchive || !percentagesArchive.data || !percentagesArchive.data[agentName]) {
                    alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„ÙˆÙƒÙŠÙ„ ÙÙŠ Ø§Ù„Ø£Ø±Ø´ÙŠÙ');
                    return;
                }
                const agentData = percentagesArchive.data[agentName];
                const agent = agentsList.find(a => a.name === agentName);
                const { data: basicArchiveData } = await supabaseClient.from('analysis_archives').select('*').eq('month_year', monthYear).eq('analysis_type', 'basic').maybeSingle();
                const { data: advancedArchiveData } = await supabaseClient.from('analysis_archives').select('*').eq('month_year', monthYear).eq('analysis_type', 'advanced').maybeSingle();
                const { data: twoMonthsArchiveData } = await supabaseClient.from('analysis_archives').select('*').eq('month_year', monthYear).eq('analysis_type', 'two_months').maybeSingle();
                const getAgentResultsFromArchive = (archiveData, agentName, type) => {
                    if (!archiveData || !archiveData.data) return null;
                    if (archiveData.data.agentReports && archiveData.data.agentReports[agentName]) {
                        const agentReport = archiveData.data.agentReports[agentName];
                        if (type === 'basic' && agentReport.basic) return agentReport.basic;
                        if (type === 'advanced' && agentReport.advanced) return agentReport.advanced;
                        if (type === 'two_months' && agentReport.twoMonths) return agentReport.twoMonths;
                    }
                    if (archiveData.data.results) {
                        if (archiveData.data.results.agentName === agentName) {
                            return archiveData.data.results;
                        }
                        if (archiveData.data.results[agentName]) {
                            if (type === 'basic' && archiveData.data.results[agentName].basic) return archiveData.data.results[agentName].basic;
                            if (type === 'advanced' && archiveData.data.results[agentName].advanced) return archiveData.data.results[agentName].advanced;
                            if (type === 'two_months' && archiveData.data.results[agentName].twoMonths) return archiveData.data.results[agentName].twoMonths;
                        }
                    }
                    return null;
                };
                const basicResults = basicArchiveData ? getAgentResultsFromArchive({ data: basicArchiveData.data }, agentName, 'basic') : null;
                const advancedResults = advancedArchiveData ? getAgentResultsFromArchive({ data: advancedArchiveData.data }, agentName, 'advanced') : null;
                const twoMonthsResults = twoMonthsArchiveData ? getAgentResultsFromArchive({ data: twoMonthsArchiveData.data }, agentName, 'two_months') : null;
                generateArchivePDFReport(agentName, monthYear, agentData, agent, basicResults, advancedResults, twoMonthsResults).then((pdfBlob) => {
                    const safeName = agentName.replace(/[^a-zA-Z0-9_]/g, '_');
                    const filename = `Agent_Archive_Report_${safeName}_${monthYear}_${formatDateForFilename(new Date())}.pdf`;
                    downloadFile(pdfBlob, filename);
                    logActivity('Ø·Ø¨Ø§Ø¹Ø© ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ø±Ø´ÙŠÙ PDF', `ØªÙ… Ø·Ø¨Ø§Ø¹Ø© ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ø±Ø´ÙŠÙ PDF Ù„Ù„ÙˆÙƒÙŠÙ„ ${agentName} Ù„Ø´Ù‡Ø± ${monthYear}`);
                    showSuccessMessage(`ØªÙ… Ø·Ø¨Ø§Ø¹Ø© ØªÙ‚Ø±ÙŠØ± PDF Ù„Ù„ÙˆÙƒÙŠÙ„ ${agentName} Ø¨Ù†Ø¬Ø§Ø­`);
                }).catch((error) => {
                    console.error('Error generating PDF:', error);
                    alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù PDF. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
                });
            } catch (error) {
                console.error('Error printing archive PDF:', error);
                alert('Ø®Ø·Ø£ ÙÙŠ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±: ' + error.message);
            }
        }
        function generateArchivePDFReport(agentName, monthYear, agentData, agent, basicResults = null, advancedResults = null, twoMonthsResults = null) {
            return new Promise(async (resolve, reject) => {
                try {
                    const { jsPDF } = window.jspdf;
                    if (!jsPDF) {
                        reject(new Error('jsPDF ØºÙŠØ± Ù…ØªÙˆÙØ±'));
                        return;
                    }
                    const doc = new jsPDF('portrait', 'mm', 'a4');
                    const pageWidth = doc.internal.pageSize.getWidth();
                    const pageHeight = doc.internal.pageSize.getHeight();
                    let yPos = 15;
                    doc.setFontSize(20);
                    doc.setTextColor(128, 28, 50);
                    doc.setFont('helvetica', 'bold');
                    const titleText = 'Agent Archive Report';
                    const titleWidth = doc.getTextWidth(titleText);
                    doc.text(titleText, (pageWidth - titleWidth) / 2, yPos);
                    yPos += 12;
                    doc.setFontSize(14);
                    doc.setTextColor(0, 0, 0);
                    doc.setFont('helvetica', 'bold');
                    doc.text(`Agent Name: ${agentName}`, 20, yPos);
                    yPos += 8;
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(12);
                    doc.text(`Month: ${monthYear}`, 20, yPos);
                    yPos += 8;
                    doc.text(`Export Date: ${new Date().toLocaleString('en-US')}`, 20, yPos);
                    yPos += 10;
                    if (agent?.phone) {
                        doc.text(`Phone Number: ${agent.phone}`, 20, yPos);
                        yPos += 8;
                    }
                    if (agent?.email) {
                        doc.text(`Email: ${agent.email}`, 20, yPos);
                        yPos += 8;
                    }
                    yPos += 5;
                    doc.setFontSize(16);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(128, 28, 50);
                    doc.text('Summary of Percentages and Details', 20, yPos);
                    yPos += 10;
                    doc.setFontSize(12);
                    doc.setTextColor(0, 0, 0);
                    doc.setFont('helvetica', 'normal');
                    doc.text(`Percentage: ${agentData.percentage || 0}%`, 20, yPos);
                    yPos += 8;
                    doc.text(`Total Amount: ${formatNumberEnglish(agentData.iqT || 0)} IQD`, 20, yPos);
                    yPos += 8;
                    doc.setFont('helvetica', 'bold');
                    doc.text(`Agent Percentage: ${formatNumberEnglish(agentData.agentPercentageAmount || 0)} IQD`, 20, yPos);
                    yPos += 10;
                    if ((agentData.deductions || 0) > 0) {
                        doc.setFont('helvetica', 'normal');
                        doc.setTextColor(220, 53, 69);
                        doc.text(`Deductions: ${formatNumberEnglish(agentData.deductions || 0)} IQD`, 20, yPos);
                        yPos += 8;
                    }
                    if ((agentData.penalties || 0) > 0) {
                        doc.setTextColor(220, 53, 69);
                        doc.text(`Penalties: ${formatNumberEnglish(agentData.penalties || 0)} IQD`, 20, yPos);
                        yPos += 8;
                    }
                    doc.setFontSize(14);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(128, 28, 50);
                    doc.text(`Net Amount: ${formatNumberEnglish(agentData.netPercentage || 0)} IQD`, 20, yPos);
                    yPos += 15;
                    if (agentData.iqP || agentData.iqG || agentData.iqS || agentData.iqB || 
                        agentData.countP || agentData.countG || agentData.countS || agentData.countB) {
                        doc.setFontSize(14);
                        doc.setFont('helvetica', 'bold');
                        doc.setTextColor(128, 28, 50);
                        doc.text('Percentage Details by Profile Type', 20, yPos);
                        yPos += 10;
                        const percentageTableData = [];
                        if (agentData.countB || agentData.iqB) {
                            const percentageAmount = ((Number(agentData.iqB) || 0) * (Number(agentData.percentage) || 0)) / 100;
                            percentageTableData.push([
                                'Bronze ',
                                formatNumberEnglish(Number(agentData.countB) || 0),
                                formatNumberEnglish(Number(agentData.iqB) || 0),
                                formatNumberEnglish(Math.round(percentageAmount))
                            ]);
                        }
                        if (agentData.countG || agentData.iqG) {
                            const percentageAmount = ((Number(agentData.iqG) || 0) * (Number(agentData.percentage) || 0)) / 100;
                            percentageTableData.push([
                                'Gold ',
                                formatNumberEnglish(Number(agentData.countG) || 0),
                                formatNumberEnglish(Number(agentData.iqG) || 0),
                                formatNumberEnglish(Math.round(percentageAmount))
                            ]);
                        }
                        if (agentData.countS || agentData.iqS) {
                            const percentageAmount = ((Number(agentData.iqS) || 0) * (Number(agentData.percentage) || 0)) / 100;
                            percentageTableData.push([
                                'Silver ',
                                formatNumberEnglish(Number(agentData.countS) || 0),
                                formatNumberEnglish(Number(agentData.iqS) || 0),
                                formatNumberEnglish(Math.round(percentageAmount))
                            ]);
                        }
                        if (agentData.countP || agentData.iqP) {
                            const percentageAmount = ((Number(agentData.iqP) || 0) * (Number(agentData.percentage) || 0)) / 100;
                            percentageTableData.push([
                                'Platinum ',
                                formatNumberEnglish(Number(agentData.countP) || 0),
                                formatNumberEnglish(Number(agentData.iqP) || 0),
                                formatNumberEnglish(Math.round(percentageAmount))
                            ]);
                        }
                        const totalCount = (Number(agentData.countB) || 0) + (Number(agentData.countG) || 0) + 
                                         (Number(agentData.countS) || 0) + (Number(agentData.countP) || 0);
                        const totalAmount = (Number(agentData.iqB) || 0) + (Number(agentData.iqG) || 0) + 
                                          (Number(agentData.iqS) || 0) + (Number(agentData.iqP) || 0);
                        percentageTableData.push([
                            'Total',
                            formatNumberEnglish(totalCount),
                            formatNumberEnglish(totalAmount),
                            formatNumberEnglish(Math.round(agentData.agentPercentageAmount || 0))
                        ]);
                        doc.autoTable({
                            startY: yPos,
                            head: [['Profile Type', 'Count', 'Total Amount', 'Percentage Amount']],
                            body: percentageTableData,
                            theme: 'striped',
                            headStyles: {
                                fillColor: [128, 28, 50],
                                textColor: [255, 255, 255],
                                fontStyle: 'bold',
                                fontSize: 12,
                                halign: 'center'
                            },
                            bodyStyles: {
                                fontSize: 12,
                                halign: 'center'
                            },
                            columnStyles: {
                                0: { halign: 'left' },
                                1: { halign: 'center' },
                                2: { halign: 'center' },
                                3: { halign: 'center' }
                            },
                            didParseCell: function(data) {
                                if (data.row.index === percentageTableData.length - 1) {
                                    data.cell.styles.fillColor = [248, 249, 250];
                                    data.cell.styles.fontStyle = 'bold';
                                    data.cell.styles.fontSize = 12;
                                }
                            },
                            margin: { left: 20, right: 20 }
                        });
                        yPos = doc.lastAutoTable.finalY + 10;
                    }
                    if (basicResults || advancedResults || twoMonthsResults) {
                        if (yPos > pageHeight - 50) {
                            doc.addPage();
                            yPos = 15;
                        }
                        doc.setFontSize(14);
                        doc.setFont('helvetica', 'bold');
                        doc.setTextColor(128, 28, 50);
                        doc.text('Offers Summary', 20, yPos);
                        yPos += 10;
                        const offersTableData = [];
                        if (basicResults && basicResults.total) {
                            const basicAmount = basicResults.total.amount || 0;
                            const basicCount = basicResults.total.count || 0;
                            offersTableData.push([
                                'Free Offer',
                                formatNumberEnglish(basicCount),
                                formatNumberEnglish(basicAmount) + ' IQD'
                            ]);
                        }
                        if (advancedResults && advancedResults.total) {
                            const advancedProfit = advancedResults.total.profit || 0;
                            const advancedCount = advancedResults.total.count || 0;
                            offersTableData.push([
                                '3 Months Discounted',
                                formatNumberEnglish(advancedCount),
                                formatNumberEnglish(advancedProfit) + ' IQD'
                            ]);
                        }
                        if (twoMonthsResults && twoMonthsResults.total) {
                            const twoMonthsProfit = twoMonthsResults.total.profit || 0;
                            const twoMonthsCount = twoMonthsResults.total.count || 0;
                            offersTableData.push([
                                '2 Months Discounted',
                                formatNumberEnglish(twoMonthsCount),
                                formatNumberEnglish(twoMonthsProfit) + ' IQD'
                            ]);
                        }
                        if (offersTableData.length > 0) {
                            let totalOffersCount = 0;
                            let totalOffersAmount = 0;
                            if (basicResults && basicResults.total) {
                                totalOffersCount += (basicResults.total.count || 0);
                                totalOffersAmount += (basicResults.total.amount || 0);
                            }
                            if (advancedResults && advancedResults.total) {
                                totalOffersCount += (advancedResults.total.count || 0);
                                totalOffersAmount += (advancedResults.total.profit || 0);
                            }
                            if (twoMonthsResults && twoMonthsResults.total) {
                                totalOffersCount += (twoMonthsResults.total.count || 0);
                                totalOffersAmount += (twoMonthsResults.total.profit || 0);
                            }
                            offersTableData.push([
                                'Total',
                                formatNumberEnglish(totalOffersCount),
                                formatNumberEnglish(totalOffersAmount) + ' IQD'
                            ]);
                            doc.autoTable({
                                startY: yPos,
                                head: [['Offer Type', 'Profiles Count', 'Net Amount']],
                                body: offersTableData,
                                theme: 'striped',
                                headStyles: {
                                    fillColor: [128, 28, 50],
                                    textColor: [255, 255, 255],
                                    fontStyle: 'bold',
                                    fontSize: 12,
                                    halign: 'center'
                                },
                                bodyStyles: {
                                    fontSize: 12,
                                    halign: 'center'
                                },
                                columnStyles: {
                                    0: { halign: 'left' },
                                    1: { halign: 'center' },
                                    2: { halign: 'center' }
                                },
                                didParseCell: function(data) {
                                    if (data.row.index === offersTableData.length - 1) {
                                        data.cell.styles.fillColor = [248, 249, 250];
                                        data.cell.styles.fontStyle = 'bold';
                                        data.cell.styles.fontSize = 12;
                                    }
                                },
                                margin: { left: 20, right: 20 }
                            });
                            yPos = doc.lastAutoTable.finalY + 10;
                        }
                    }
                    if (yPos > pageHeight - 30) {
                        doc.addPage();
                        yPos = 15;
                    }
                    const pdfBlob = doc.output('blob');
                    resolve(pdfBlob);
                } catch (error) {
                    reject(error);
                }
            });
        }
        document.addEventListener('DOMContentLoaded', async function() {
            const savedUser = localStorage.getItem('loggedInUser');
            const savedRole = localStorage.getItem('currentUserRole');
            const savedUserId = localStorage.getItem('currentUserId');
            
            if (savedUser && savedRole && savedUserId) {
                const loginScreen = document.getElementById('loginScreen');
                const dashboard = document.getElementById('dashboard');
                if (loginScreen) {
                    loginScreen.style.display = 'none';
                    loginScreen.classList.add('hidden');
                }
                if (dashboard) {
                    dashboard.style.display = 'flex';
                    dashboard.classList.remove('hidden');
                }
            }
            
            await initSupabase();
            
            const loginButton = document.getElementById('loginButton');
            const loginPassword = document.getElementById('loginPassword');
            const loginUsername = document.getElementById('loginUsername');
            
            if (loginButton) {
                loginButton.addEventListener('click', handleLogin);
            }
            
            if (loginPassword) {
                loginPassword.addEventListener('keydown', function(event) {
                    if (event.key === 'Enter') {
                        event.preventDefault();
                        if (typeof handleLogin === 'function') {
                            handleLogin();
                        }
                    }
                });
            }
            
            if (loginUsername) {
                loginUsername.addEventListener('keydown', function(event) {
                    if (event.key === 'Enter') {
                        event.preventDefault();
                        loginPassword?.focus();
                    }
                });
            }
            
            if (savedUser && savedRole && savedUserId) {
                loggedInUser = savedUser;
                currentUserRole = savedRole;
                currentUserId = savedUserId;
                showMainApp();
            } else {
                const loginScreen = document.getElementById('loginScreen');
                const dashboard = document.getElementById('dashboard');
                if (loginScreen) {
                    loginScreen.style.display = 'flex';
                    loginScreen.classList.remove('hidden');
                }
                if (dashboard) {
                    dashboard.style.display = 'none';
                    dashboard.classList.add('hidden');
                }
            }
            
            await loadDataFromDatabase();
            updateCurrentDate();
            setupPercentageFileUpload();
            setupPercentageTableEventListeners();
            setupFileUploads();
            setupMinistryFileUpload();
            loadSidebarState();
            loadPercentageData();
            loadSettings();
            loadMinistryPercentages();
            loadActivityLog();
            restoreTabAndScroll();
            restoreScrollPosition();
            setupScrollPositionSaving();
            loadTheme();
            const savedDefaultPercentage = parseFloat(localStorage.getItem('defaultAgentPercentage')) || 16;
            const defaultPercentageInput = document.getElementById('defaultAgentPercentage');
            if (defaultPercentageInput) {
                defaultPercentageInput.value = savedDefaultPercentage;
            }
            const select = document.getElementById('selectedAgentForPercentage');
            if (select) {
                updateAgentsListForPercentage();
            }
            setTimeout(async () => {
                await restoreSavedData();
                if (Object.keys(agentReports).length > 0) {
                    updateAgentSummary();
                }
            }, 500);
            autoLoginFromMaster();
            
            setTimeout(() => {
                const popup = document.getElementById('userContactPopup');
                const sidebarUserBtn = document.getElementById('sidebarUser');
                
                if (popup && sidebarUserBtn) {
                    popup.addEventListener('mouseenter', function(e) {
                        e.stopPropagation();
                    });
                    
                    popup.addEventListener('mouseleave', function(e) {
                        e.stopPropagation();
                    });
                    
                    popup.addEventListener('click', function(e) {
                        e.stopPropagation();
                    });
                    
                    const links = popup.querySelectorAll('a');
                    links.forEach(link => {
                        link.addEventListener('click', function(e) {
                            e.stopPropagation();
                        });
                    });
                    
                }
            }, 1000);
        });
        window.addEventListener('beforeunload', function() {
            try {
                const scrollPosition = window.scrollY || document.documentElement.scrollTop;
                localStorage.setItem('pageScrollPosition', scrollPosition.toString());
                
                if (agentReports && Object.keys(agentReports).length > 0) {
                    const agentReportsSummary = Object.keys(agentReports).reduce((acc, agentName) => {
                        acc[agentName] = {};
                        if (agentReports[agentName].basic) {
                            acc[agentName].basic = {
                                total: agentReports[agentName].basic.total || null,
                                agentName: agentReports[agentName].basic.agentName || null
                            };
                        }
                        if (agentReports[agentName].advanced) {
                            acc[agentName].advanced = {
                                total: agentReports[agentName].advanced.total || null,
                                agentName: agentReports[agentName].advanced.agentName || null
                            };
                        }
                        if (agentReports[agentName].twoMonths) {
                            acc[agentName].twoMonths = {
                                total: agentReports[agentName].twoMonths.total || null,
                                agentName: agentReports[agentName].twoMonths.agentName || null
                            };
                        }
                        return acc;
                    }, {});
                    saveDataToStorage('agentReports', agentReportsSummary);
                }
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù‚Ø¨Ù„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„:', error);
            }
        });
        function updateCurrentDate() {
            const now = new Date();
            const arabicDate = formatArabicDate(now);
            document.getElementById('currentDateTime').textContent = arabicDate;
        }
        function formatArabicDate(date) {
            const day = date.getDate().toString();
            const month = arabicMonths[date.getMonth()];
            const year = date.getFullYear().toString();
            return `${day} ${month} ${year}`;
        }
        function switchTab(tabName) {
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            if (event && event.target.closest('.nav-item')) {
                event.target.closest('.nav-item').classList.add('active');
            } else {
                const navItems = document.querySelectorAll('.nav-item');
                if (tabName === 'summary') navItems[0]?.classList.add('active');
                else if (tabName === 'basic') navItems[1]?.classList.add('active');
                else if (tabName === 'twoMonths') navItems[2]?.classList.add('active');
                else if (tabName === 'advanced') navItems[3]?.classList.add('active');
                else if (tabName === 'agents') navItems[4]?.classList.add('active');
                else if (tabName === 'agentPercentage') navItems[5]?.classList.add('active');
                else if (tabName === 'ministryPercentage') navItems[6]?.classList.add('active');
                else if (tabName === 'activity') navItems[7]?.classList.add('active');
                else if (tabName === 'settings') navItems[8]?.classList.add('active');
                else if (tabName === 'archive') navItems[9]?.classList.add('active');
                else if (tabName === 'users') navItems[10]?.classList.add('active');
            }
            const tabElement = document.getElementById(tabName + 'Tab');
            if (tabElement) {
                tabElement.classList.add('active');
                localStorage.setItem('currentTab', tabName);
                const currentScroll = window.scrollY || document.documentElement.scrollTop;
                localStorage.setItem(`scrollPosition_${tabName}`, currentScroll.toString());
                
                if (tabName === 'summary') {
                    updateAgentSummary();
                } else if (tabName === 'agents') {
                    renderAgentsList();
                } else if (tabName === 'agentPercentage') {
                    updateAgentsListForPercentage();
                } else if (tabName === 'ministryPercentage') {
                } else if (tabName === 'activity') {
                    setTimeout(() => refreshActivityLog(), 100);
                } else if (tabName === 'archive') {
                    setTimeout(() => refreshArchivesList(), 100);
                } else if (tabName === 'users') {
                    loadUsers();
                }
            }
        }
        
        function restoreTabAndScroll() {
            const savedTab = localStorage.getItem('currentTab');
            if (savedTab) {
                setTimeout(() => {
                    const originalEvent = window.event;
                    window.event = null;
                    switchTab(savedTab);
                    window.event = originalEvent;
                    
                    const savedScrollPosition = localStorage.getItem(`scrollPosition_${savedTab}`);
                    if (savedScrollPosition) {
                        setTimeout(() => {
                            window.scrollTo({
                                top: parseInt(savedScrollPosition),
                                behavior: 'auto'
                            });
                        }, 400);
                    }
                }, 200);
            }
        }
        function setupScrollPositionSaving() {
            let scrollTimeout;
            window.addEventListener('scroll', function() {
                clearTimeout(scrollTimeout);
                scrollTimeout = setTimeout(function() {
                    const scrollPosition = window.scrollY || document.documentElement.scrollTop;
                    localStorage.setItem('pageScrollPosition', scrollPosition.toString());
                }, 150);
            }, { passive: true });
        }
        function restoreScrollPosition() {
            const savedScrollPosition = localStorage.getItem('pageScrollPosition');
            if (savedScrollPosition) {
                setTimeout(() => {
                    window.scrollTo({
                        top: parseInt(savedScrollPosition),
                        behavior: 'auto'
                    });
                }, 100);
            }
        }
        function setupFileUploads() {
            setupFileUpload('basic');
            setupFileUpload('advanced');
            setupFileUpload('twoMonths');
        }
        function setupFileUpload(type) {
            const uploadDiv = document.getElementById(type + 'FileUpload');
            const fileInput = document.getElementById(type + 'FileInput');
            uploadDiv.addEventListener('click', () => fileInput.click());
            uploadDiv.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadDiv.classList.add('dragover');
            });
            uploadDiv.addEventListener('dragleave', () => {
                uploadDiv.classList.remove('dragover');
            });
            uploadDiv.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadDiv.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFileSelect(files[0], type);
                }
            });
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleFileSelect(e.target.files[0], type);
                }
            });
        }
        function handleFileSelect(file, type) {
            const fileName = document.getElementById(type + 'FileName');
            if (fileName) {
            fileName.textContent = `ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù„Ù: ${file.name}`;
            fileName.classList.remove('hidden');
            }
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    if (file.name.toLowerCase().endsWith('.csv')) {
                        Papa.parse(e.target.result, {
                            header: false,
                            skipEmptyLines: true,
                            complete: function(results) {
                                const processedData = convertArrayToObjects(results.data);
                                if (type === 'basic') {
                                    basicData = processedData;
                                } else if (type === 'advanced') {
                                    advancedData = processedData;
                                } else {
                                    twoMonthsData = processedData;
                                }
                                showSuccessMessage(`ØªÙ… ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù CSV Ø¨Ù†Ø¬Ø§Ø­ - ${results.data.length} ØµÙ`);
                            }
                        });
                    } else if (file.name.toLowerCase().match(/\.(xlsx|xls)$/)) {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { 
                            header: 1,
                            defval: "",
                            raw: false
                        });
                        const processedData = convertArrayToObjects(jsonData);
                        if (type === 'basic') {
                            basicData = processedData;
                        } else if (type === 'advanced') {
                            advancedData = processedData;
                        } else {
                            twoMonthsData = processedData;
                        }
                        showSuccessMessage(`ØªÙ… ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Excel Ø¨Ù†Ø¬Ø§Ø­ - ${jsonData.length} ØµÙ`);
                    } else {
                        alert('Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…. ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù Excel (.xlsx, .xls) Ø£Ùˆ CSV');
                    }
                } catch (error) {
                    alert('Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù: ' + error.message);
                    console.error('File reading error:', error);
                }
            };
            if (file.name.toLowerCase().match(/\.(xlsx|xls)$/)) {
                reader.readAsArrayBuffer(file);
            } else {
                reader.readAsText(file);
            }
        }
        function convertArrayToObjects(arrayData) {
            if (!arrayData || arrayData.length === 0) return [];
            const headers = arrayData[0];
            const result = [];
            for (let i = 1; i < arrayData.length; i++) {
                const obj = {};
                for (let j = 0; j < headers.length; j++) {
                    obj[`Column${String.fromCharCode(65 + j)}`] = arrayData[i][j] || '';
                    obj[j] = arrayData[i][j] || '';
                }
                result.push(obj);
            }
            return result;
        }
        function saveDataToStorage(key, data) {
            const largeDataKeys = ['basicData', 'advancedData', 'twoMonthsData', 'basicDetails', 'advancedDetails', 'twoMonthsDetails'];
            if (largeDataKeys.includes(key)) {
                return;
            }
            try {
                const dataString = JSON.stringify(data);
                if (dataString.length > 2000000) {
                    console.warn(`âš  Skipping save to localStorage for ${key}: data too large (${(dataString.length / 1024 / 1024).toFixed(2)}MB)`);
                    return;
                }
                localStorage.setItem(key, dataString);
            } catch (error) {
                if (error.name === 'QuotaExceededError') {
                    console.warn(`âš  Quota exceeded for ${key}, skipping localStorage save. Data is saved in database.`);
                    try {
                        localStorage.removeItem('basicData');
                        localStorage.removeItem('advancedData');
                        localStorage.removeItem('twoMonthsData');
                        localStorage.removeItem('basicDetails');
                        localStorage.removeItem('advancedDetails');
                        localStorage.removeItem('twoMonthsDetails');
                        const dataString = JSON.stringify(data);
                        if (dataString.length <= 2000000) {
                            localStorage.setItem(key, dataString);
                        }
                } catch (e) {
                        console.warn(`âš  Could not free up space for ${key}, data is saved in database only`);
                    }
                } else {
                    console.error(`Error saving ${key} to storage:`, error);
                }
            }
        }
        function loadDataFromStorage(key, defaultValue = null) {
            try {
                const saved = localStorage.getItem(key);
                if (saved) {
                    return JSON.parse(saved);
                }
            } catch (error) {
                console.error(`Error loading ${key} from storage:`, error);
            }
            return defaultValue;
        }
        async function restoreSavedData() {
            try {
                const savedBasicData = loadDataFromStorage('basicData');
                if (savedBasicData && savedBasicData.length > 0) {
                    basicData = savedBasicData;
                }
                const savedAdvancedData = loadDataFromStorage('advancedData');
                if (savedAdvancedData && savedAdvancedData.length > 0) {
                    advancedData = savedAdvancedData;
                }
                const savedTwoMonthsData = loadDataFromStorage('twoMonthsData');
                if (savedTwoMonthsData && savedTwoMonthsData.length > 0) {
                    twoMonthsData = savedTwoMonthsData;
                }
                const savedBasicDetails = loadDataFromStorage('basicDetails', []);
                if (savedBasicDetails.length > 0) {
                    basicDetails = savedBasicDetails;
                }
                const savedAdvancedDetails = loadDataFromStorage('advancedDetails', []);
                if (savedAdvancedDetails.length > 0) {
                    advancedDetails = savedAdvancedDetails;
                }
                const savedTwoMonthsDetails = loadDataFromStorage('twoMonthsDetails', []);
                if (savedTwoMonthsDetails.length > 0) {
                    twoMonthsDetails = savedTwoMonthsDetails;
                }
                if (supabaseClient) {
                    try {
                        const monthYear = getCurrentMonthYear();
                        const { data: basicArchive } = await supabaseClient
                            .from('analysis_archives')
                            .select('data')
                            .eq('month_year', monthYear)
                            .eq('analysis_type', 'basic')
                            .maybeSingle();
                        
                        const { data: advancedArchive } = await supabaseClient
                            .from('analysis_archives')
                            .select('data')
                            .eq('month_year', monthYear)
                            .eq('analysis_type', 'advanced')
                            .maybeSingle();
                        
                        const { data: twoMonthsArchive } = await supabaseClient
                            .from('analysis_archives')
                            .select('data')
                            .eq('month_year', monthYear)
                            .eq('analysis_type', 'two_months')
                            .maybeSingle();
                        
                        if (basicArchive && basicArchive.data && basicArchive.data.agentReports) {
                            Object.keys(basicArchive.data.agentReports).forEach(agentName => {
                                if (!agentReports[agentName]) {
                                    agentReports[agentName] = {};
                                }
                                if (basicArchive.data.agentReports[agentName].basic) {
                                    agentReports[agentName].basic = basicArchive.data.agentReports[agentName].basic;
                                }
                            });
                        }
                        
                        if (advancedArchive && advancedArchive.data && advancedArchive.data.agentReports) {
                            Object.keys(advancedArchive.data.agentReports).forEach(agentName => {
                                if (!agentReports[agentName]) {
                                    agentReports[agentName] = {};
                                }
                                if (advancedArchive.data.agentReports[agentName].advanced) {
                                    agentReports[agentName].advanced = advancedArchive.data.agentReports[agentName].advanced;
                                }
                            });
                        }
                        
                        if (twoMonthsArchive && twoMonthsArchive.data && twoMonthsArchive.data.agentReports) {
                            Object.keys(twoMonthsArchive.data.agentReports).forEach(agentName => {
                                if (!agentReports[agentName]) {
                                    agentReports[agentName] = {};
                                }
                                if (twoMonthsArchive.data.agentReports[agentName].twoMonths) {
                                    agentReports[agentName].twoMonths = twoMonthsArchive.data.agentReports[agentName].twoMonths;
                                }
                            });
                        }
                    } catch (e) {
                        console.warn('Error loading agentReports from database in restoreSavedData:', e);
                    }
                }
                
                if (Object.keys(agentReports).length === 0) {
                    const savedAgentReports = loadDataFromStorage('agentReports', {});
                    if (savedAgentReports && Object.keys(savedAgentReports).length > 0) {
                        agentReports = savedAgentReports;
                    }
                }
                
                if (Object.keys(agentReports).length > 0) {
                    try {
                        const agentReportsString = JSON.stringify(agentReports);
                        if (agentReportsString.length <= 2000000) {
                            localStorage.setItem('agentReports', agentReportsString);
                        }
                    } catch (e) {
                        console.warn('Could not save agentReports to localStorage:', e);
                    }
                }
                
                const savedBasicResults = loadDataFromStorage('basicResults');
                if (savedBasicResults && savedBasicResults.total && savedBasicResults.total.count > 0) {
                    await displayBasicResults(savedBasicResults);
                }
                const savedAdvancedResults = loadDataFromStorage('advancedResults');
                if (savedAdvancedResults && savedAdvancedResults.total && savedAdvancedResults.total.count > 0) {
                    await displayAdvancedResults(savedAdvancedResults);
                }
                const savedTwoMonthsResults = loadDataFromStorage('twoMonthsResults');
                if (savedTwoMonthsResults && savedTwoMonthsResults.total && savedTwoMonthsResults.total.count > 0) {
                    await displayTwoMonthsResults(savedTwoMonthsResults);
                }
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©:', error);
            }
        }
        function showSuccessMessage(message) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'success-message';
            messageDiv.textContent = message;
            messageDiv.style.position = 'fixed';
            messageDiv.style.top = '20px';
            messageDiv.style.right = '20px';
            messageDiv.style.zIndex = '9999';
            messageDiv.style.maxWidth = '300px';
            document.body.appendChild(messageDiv);
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.parentNode.removeChild(messageDiv);
                }
            }, 3000);
        }
        let isAnalyzingBasic = false;
        let isAnalyzingAdvanced = false;
        let isAnalyzingTwoMonths = false;
        function analyzeBasicData() {
            if (isAnalyzingBasic) {
                showSuccessMessage('Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±...');
                return;
            }
            if (!basicData) {
                alert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø£ÙˆÙ„Ø§Ù‹');
                return;
            }
            isAnalyzingBasic = true;
            basicDetails = [];
            showLoading('basic');
                try {
                    const results = processBasicData(basicData);
                    if (results.total.count === 0) {
                        alert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª ØµØ§Ù„Ø­Ø© Ù„Ù„ØªØ­Ù„ÙŠÙ„. ØªØ£ÙƒØ¯ Ù…Ù† ØµØ­Ø© ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù…Ù„Ù.');
                        hideLoading('basic');
                    isAnalyzingBasic = false;
                        return;
                    }
                    displayBasicResults(results);
                    hideLoading('basic');
                    showSuccessMessage(`ØªÙ… ØªØ­Ù„ÙŠÙ„ ${results.total.count} Ø§Ø´ØªØ±Ø§Ùƒ Ù…Ø¬Ø§Ù†ÙŠ Ø¨Ù†Ø¬Ø§Ø­`);
                isAnalyzingBasic = false;
                } catch (error) {
                    alert('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù„ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠ: ' + error.message);
                    hideLoading('basic');
                isAnalyzingBasic = false;
                }
        }
        function processBasicData(data) {
            const results = {
                bronze: { count: 0, amount: 0 },
                silver: { count: 0, amount: 0 },
                gold: { count: 0, amount: 0 },
                platinum: { count: 0, amount: 0 },
                total: { count: 0, amount: 0 },
                agentName: ''
            };
            if (data.length === 0) return results;
            results.agentName = data[0]['ColumnF'] || data[0][5] || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
            for (let i = 0; i < data.length; i++) {
                const row = data[i];
                const id = row['ColumnA'] || row[0];
                const createdAt = row['ColumnB'] || row[1];
                const username = row['ColumnC'] || row[2];
                const subscription = row['ColumnI'] || row[8];
                const count = row['ColumnP'] || row[15];
                const agent = row['ColumnF'] || row[5] || '';
                if (!createdAt || !username || !subscription || count != 1) continue;
                const subType = String(subscription).trim();
                const agentName = String(agent).trim();
                const category = getSubscriptionCategory(subType, agentName);
                if (!category) continue;
                const price = getSubscriptionPrice(subType, category, 'basic');
                if (price > 0) {
                    basicDetails.push({
                        username: String(username).trim(),
                        subscription: subType,
                        agent: agentName,
                        date: createdAt,
                        dateStr: createdAt,
                        createdAt: createdAt,
                        price: price,
                        promoPrice: price,
                        officialPrice: price,
                        type: 'Ù…Ø¬Ø§Ù†ÙŠ'
                    });
                    switch(category) {
                        case 'B':
                        results.bronze.count++;
                        results.bronze.amount += price;
                            break;
                        case 'S':
                        results.silver.count++;
                        results.silver.amount += price;
                            break;
                        case 'G':
                        results.gold.count++;
                        results.gold.amount += price;
                            break;
                        case 'P':
                        results.platinum.count++;
                        results.platinum.amount += price;
                            break;
                    }
                }
            }
            results.total.count = results.bronze.count + results.silver.count + results.gold.count + results.platinum.count;
            results.total.amount = results.bronze.amount + results.silver.amount + results.gold.amount + results.platinum.amount;
            return results;
        }
        async function saveAgentAnalysisToArchive(agentName, analysisType, analysisData) {
            if (!supabaseClient) {
                return;
            }
            const monthYear = analysisData.monthYear || getCurrentMonthYear();
            const normalizedAgentName = normalizeAgentName(agentName);
            const archiveLockKey = `archive_${agentName}_${analysisType}_${monthYear}`;
            
            if (archiveSaveLocks.has(archiveLockKey)) {
                return;
            }
            
            archiveSaveLocks.set(archiveLockKey, true);
            
            try {
                try {
                    const archiveData = {
                        agentName: agentName,
                        analysisType: analysisType,
                        monthYear: monthYear,
                        analysisDate: analysisData.analysisDate || new Date().toISOString(),
                        results: analysisData.results,
                        details: Array.isArray(analysisData.details) ? analysisData.details.slice(0, 500) : [],
                        data: Array.isArray(analysisData.data) ? analysisData.data.slice(0, 200) : []
                    };
                    const existingArchives = JSON.parse(localStorage.getItem('agentAnalysesArchive') || '{}');
                    if (!existingArchives[monthYear]) {
                        existingArchives[monthYear] = {};
                    }
                    existingArchives[monthYear][agentName] = existingArchives[monthYear][agentName] || {};
                    existingArchives[monthYear][agentName][analysisType] = archiveData;
                    const dataString = JSON.stringify(existingArchives);
                    if (dataString.length > 1500000) {
                        const monthYearKey = monthYear;
                        const agentKey = agentName;
                        if (existingArchives[monthYearKey] && existingArchives[monthYearKey][agentKey]) {
                            delete existingArchives[monthYearKey][agentKey][analysisType];
                            const reducedString = JSON.stringify(existingArchives);
                            if (reducedString.length <= 1500000) {
                                localStorage.setItem('agentAnalysesArchive', reducedString);
                            }
                        }
                    } else {
                        localStorage.setItem('agentAnalysesArchive', dataString);
                    }
                } catch (e) {
                    if (e.name === 'QuotaExceededError') {
                        try {
                            const existingArchives = JSON.parse(localStorage.getItem('agentAnalysesArchive') || '{}');
                            const monthYearKey = monthYear;
                            const agentKey = agentName;
                            if (existingArchives[monthYearKey] && existingArchives[monthYearKey][agentKey] && existingArchives[monthYearKey][agentKey][analysisType]) {
                                delete existingArchives[monthYearKey][agentKey][analysisType];
                                localStorage.setItem('agentAnalysesArchive', JSON.stringify(existingArchives));
                            }
                        } catch (cleanupError) {
                        }
                    }
                }
                
                const { data: existingAgentsList } = await supabaseClient
                    .from('agents_list')
                    .select('*')
                    .eq('month_year', monthYear)
                    .maybeSingle();
                
                let agentsListData = existingAgentsList?.data || [];
                if (!Array.isArray(agentsListData)) {
                    agentsListData = [];
                }
                
                let agentIndex = agentsListData.findIndex(a => normalizeAgentName(a.name) === normalizedAgentName);
                if (agentIndex === -1) {
                    agentsListData.push({
                        name: agentName,
                        percentage: 16,
                        offers: {},
                        details: {}
                    });
                    agentIndex = agentsListData.length - 1;
                }
                
                if (!agentsListData[agentIndex].offers) {
                    agentsListData[agentIndex].offers = {};
                }
                if (!agentsListData[agentIndex].details) {
                    agentsListData[agentIndex].details = {};
                }
                
                agentsListData[agentIndex].offers[analysisType] = {
                    results: analysisData.results,
                    analysisDate: analysisData.analysisDate || new Date().toISOString()
                };
                
                if (analysisData.details && analysisData.details.length > 0) {
                    const uniqueDetails = [];
                    const detailsMap = new Map();
                    
                    analysisData.details.forEach(detail => {
                        const key = `${detail.username || ''}_${detail.subscription || ''}_${detail.date || detail.dateStr || detail.date1 || detail.date2 || detail.date3 || ''}_${detail.type || ''}`;
                        if (!detailsMap.has(key)) {
                            detailsMap.set(key, detail);
                            uniqueDetails.push(detail);
                        }
                    });
                    
                    agentsListData[agentIndex].details[analysisType] = uniqueDetails;
                } else {
                    delete agentsListData[agentIndex].details[analysisType];
                }
                
                await saveToDatabase('agents_list', agentsListData, { monthYear: monthYear });
                
                } catch (error) {
                    console.error('Error saving agent analysis to archive:', error);
                } finally {
                    archiveSaveLocks.delete(archiveLockKey);
                }
            }
        async function displayBasicResults(results) {
            await ensureAgentExists(results.agentName);
            if (!agentReports[results.agentName]) {
                agentReports[results.agentName] = {};
            }
            agentReports[results.agentName].basic = results;
            const monthYear = extractMonthYearFromDetails(basicDetails) || 
                             extractMonthYearFromData(basicData) || 
                             getCurrentMonthYear();
            
            try {
                const agentReportsString = JSON.stringify(agentReports);
                if (agentReportsString.length <= 2000000) {
                    localStorage.setItem('agentReports', agentReportsString);
                }
            } catch (e) {
                console.warn('Could not save agentReports to localStorage:', e);
            }
            
            await saveAgentAnalysisToArchive(results.agentName, 'basic', {
                results: results,
                details: basicDetails,
                data: basicData,
                monthYear: monthYear,
                analysisDate: new Date().toISOString()
            });
            
            saveToDatabase('analysis_archives', {
                data: basicData,
                details: basicDetails,
                results: results,
                agentReports: agentReports
            }, { analysis_type: 'basic', monthYear: monthYear }).catch(err => console.error('Error saving basic analysis:', err));
            saveAgentsListToDatabase(monthYear).catch(err => console.error('Error saving agents list:', err));
            const agentInfo = document.getElementById('basicAgentInfo');
            agentInfo.innerHTML = `
                <h3> Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠ</h3>
                <p><strong>Ø§Ø³Ù… Ø§Ù„ÙˆÙƒÙŠÙ„:</strong> ${results.agentName}</p>
                <p><strong>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ­Ù„ÙŠÙ„:</strong> ${formatArabicDate(new Date())}</p>
                <p><strong>Ù†ÙˆØ¹ Ø§Ù„ØªØ­Ù„ÙŠÙ„:</strong> Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠ</p>
            `;
            const resultsGrid = document.getElementById('basicResultsGrid');
            resultsGrid.innerHTML = `
                <div class="result-card bronze">
                    <h3> Bronze</h3>
                    <div class="count">${results.bronze.count}</div>
                    <div class="amount">${formatNumber(results.bronze.amount)} Ø¯.Ø¹</div>
                </div>
                <div class="result-card silver">
                    <h3> Silver</h3>
                    <div class="count">${results.silver.count}</div>
                    <div class="amount">${formatNumber(results.silver.amount)} Ø¯.Ø¹</div>
                </div>
                <div class="result-card gold">
                    <h3> Gold</h3>
                    <div class="count">${results.gold.count}</div>
                    <div class="amount">${formatNumber(results.gold.amount)} Ø¯.Ø¹</div>
                </div>
                <div class="result-card platinum">
                    <h3> Platinum</h3>
                    <div class="count">${results.platinum.count}</div>
                    <div class="amount">${formatNumber(results.platinum.amount)} Ø¯.Ø¹</div>
                </div>
                <div class="result-card">
                    <h3> Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</h3>
                    <div class="count">${results.total.count}</div>
                    <div class="amount">${formatNumber(results.total.amount)} Ø¯.Ø¹</div>
                </div>
            `;
            document.getElementById('basicResults').classList.remove('hidden');
            updateAgentSummary();
            logActivity('ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª - Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠ', `ØªÙ… ØªØ­Ù„ÙŠÙ„ ${results.total.count} Ø§Ø´ØªØ±Ø§Ùƒ Ù…Ø¬Ø§Ù†ÙŠ Ù„Ù„ÙˆÙƒÙŠÙ„ ${results.agentName}`);
        }
        function analyzeAdvancedData() {
            if (isAnalyzingAdvanced) {
                showSuccessMessage('Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±...');
                return;
            }
            if (!advancedData) {
                alert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø£ÙˆÙ„Ø§Ù‹');
                return;
            }
            isAnalyzingAdvanced = true;
            advancedDetails = [];
            showLoading('advanced');
                try {
                    const results = processAdvancedData(advancedData);
                    if (results.total.count === 0) {
                        alert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ØªÙØ¹ÙŠÙ„Ø§Øª ØµØ§Ù„Ø­Ø© Ù„Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø®ÙØ¶. ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ 3 Ø§Ø´ØªØ±Ø§ÙƒØ§Øª Ø®Ù„Ø§Ù„ 5 Ø£ÙŠØ§Ù… Ù„Ù†ÙØ³ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….');
                        hideLoading('advanced');
                    isAnalyzingAdvanced = false;
                        return;
                    }
                    displayAdvancedResults(results);
                    hideLoading('advanced');
                    showSuccessMessage(`ØªÙ… ØªØ­Ù„ÙŠÙ„ ${results.total.count} ØªÙØ¹ÙŠÙ„ Ù„Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø®ÙØ¶ Ø¨Ù†Ø¬Ø§Ø­`);
                isAnalyzingAdvanced = false;
                } catch (error) {
                    alert('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù„ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø®ÙØ¶: ' + error.message);
                    hideLoading('advanced');
                isAnalyzingAdvanced = false;
                }
        }
        function processAdvancedData(data) {
            const results = {
                bronze: { count: 0, promoAmount: 0, officialAmount: 0 },
                silver: { count: 0, promoAmount: 0, officialAmount: 0 },
                gold: { count: 0, promoAmount: 0, officialAmount: 0 },
                platinum: { count: 0, promoAmount: 0, officialAmount: 0 },
                total: { count: 0, promoAmount: 0, officialAmount: 0, profit: 0 },
                agentName: ''
            };
            if (data.length === 0) return results;
            results.agentName = data[0]['ColumnF'] || data[0][5] || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
            const userSubscriptions = {};
            const subscriptionDetails = {};
            data.forEach(row => {
                const id = row['ColumnA'] || row[0];
                const createdAt = row['ColumnB'] || row[1];
                const username = row['ColumnC'] || row[2];
                const subscription = row['ColumnI'] || row[8];
                const agent = row['ColumnF'] || row[5] || '';
                if (!createdAt || !username || !subscription) return;
                let dateObj;
                try {
                    if (createdAt instanceof Date) {
                        dateObj = createdAt;
                    } else {
                        if (typeof createdAt === 'number' && createdAt > 40000) {
                            dateObj = new Date((createdAt - 25569) * 86400 * 1000);
                        } else {
                            dateObj = new Date(createdAt);
                        }
                    }
                    if (isNaN(dateObj.getTime())) {
                        return;
                    }
                } catch (e) {
                    return;
                }
                const key = `${String(username).trim()}|${String(subscription).trim()}`;
                if (!userSubscriptions[key]) {
                    userSubscriptions[key] = [];
                    subscriptionDetails[key] = [];
                }
                userSubscriptions[key].push(dateObj);
                subscriptionDetails[key].push({
                    date: dateObj,
                    dateStr: createdAt,
                    username: String(username).trim(),
                    subscription: String(subscription).trim(),
                    agent: String(agent).trim()
                });
            });
            Object.keys(userSubscriptions).forEach(key => {
                const [username, subscription] = key.split('|');
                const dates = userSubscriptions[key].sort((a, b) => a - b);
                const details = subscriptionDetails[key];
                let activations = 0;
                const used = new Array(dates.length).fill(false);
                const activationDetails = [];
                let found = true;
                while (found) {
                    found = false;
                for (let i = 0; i < dates.length - 2; i++) {
                    if (used[i]) continue;
                    for (let j = i + 1; j < dates.length - 1; j++) {
                        if (used[j]) continue;
                        for (let k = j + 1; k < dates.length; k++) {
                            if (used[k]) continue;
                            const daysDiff = (dates[k] - dates[i]) / (1000 * 60 * 60 * 24);
                            if (daysDiff <= 5) {
                                used[i] = used[j] = used[k] = true;
                                activations++;
                                    const subType = details[i].subscription.trim();
                                    const agentName = details[i].agent || '';
                                    const category = getSubscriptionCategory(subType, agentName);
                                    const promoPrice = category ? getSubscriptionPrice(subType, category, 'advanced', 'promo') : 0;
                                    const officialPrice = category ? getSubscriptionPrice(subType, category, 'advanced', 'official') : 0;
                                    activationDetails.push({
                                        username: details[i].username,
                                        subscription: details[i].subscription,
                                        agent: details[i].agent,
                                        date: details[i].dateStr,
                                        dateStr: details[i].dateStr,
                                        createdAt: details[i].dateStr,
                                        date1: details[i].dateStr,
                                        date2: details[j].dateStr,
                                        date3: details[k].dateStr,
                                        daysDiff: Math.round(daysDiff * 100) / 100,
                                        promoPrice: promoPrice,
                                        officialPrice: officialPrice,
                                        type: 'Ø«Ù„Ø§Ø« Ø£Ø´Ù‡Ø±'
                                    });
                                    found = true;
                                break;
                            }
                        }
                            if (found) break;
                        }
                        if (found) break;
                    }
                }
                advancedDetails.push(...activationDetails);
                if (activations > 0) {
                    const subType = subscription.trim();
                    const agentName = details[0]?.agent || '';
                    const category = getSubscriptionCategory(subType, agentName);
                    if (category) {
                        const promoPrice = getSubscriptionPrice(subType, category, 'advanced', 'promo');
                        const officialPrice = getSubscriptionPrice(subType, category, 'advanced', 'official');
                        switch(category) {
                            case 'B':
                        results.bronze.count += activations;
                        results.bronze.promoAmount += activations * promoPrice;
                        results.bronze.officialAmount += activations * officialPrice;
                                break;
                            case 'S':
                        results.silver.count += activations;
                        results.silver.promoAmount += activations * promoPrice;
                        results.silver.officialAmount += activations * officialPrice;
                                break;
                            case 'G':
                        results.gold.count += activations;
                        results.gold.promoAmount += activations * promoPrice;
                        results.gold.officialAmount += activations * officialPrice;
                                break;
                            case 'P':
                        results.platinum.count += activations;
                        results.platinum.promoAmount += activations * promoPrice;
                        results.platinum.officialAmount += activations * officialPrice;
                                break;
                        }
                    }
                }
            });
            results.total.count = results.bronze.count + results.silver.count + results.gold.count + results.platinum.count;
            results.total.promoAmount = results.bronze.promoAmount + results.silver.promoAmount + results.gold.promoAmount + results.platinum.promoAmount;
            results.total.officialAmount = results.bronze.officialAmount + results.silver.officialAmount + results.gold.officialAmount + results.platinum.officialAmount;
            results.total.profit = results.total.officialAmount - results.total.promoAmount;
            return results;
        }
        async function displayAdvancedResults(results) {
            const displayLockKey = `display_advanced_${results.agentName}_${getCurrentMonthYear()}`;
            if (displayLocks.has(displayLockKey)) {
                return;
            }
            displayLocks.set(displayLockKey, true);
            
            try {
                await ensureAgentExists(results.agentName);
                if (!agentReports[results.agentName]) {
                    agentReports[results.agentName] = {};
                }
                agentReports[results.agentName].advanced = results;
                const monthYear = extractMonthYearFromDetails(advancedDetails) || 
                                 extractMonthYearFromData(advancedData) || 
                                 getCurrentMonthYear();
                
                try {
                    const agentReportsString = JSON.stringify(agentReports);
                    if (agentReportsString.length <= 2000000) {
                        localStorage.setItem('agentReports', agentReportsString);
                    }
                } catch (e) {
                }
                
                await saveAgentAnalysisToArchive(results.agentName, 'advanced', {
                    results: results,
                    details: advancedDetails,
                    data: advancedData,
                    monthYear: monthYear,
                    analysisDate: new Date().toISOString()
                });
                
                saveToDatabase('analysis_archives', {
                    data: advancedData,
                    details: advancedDetails,
                    results: results,
                    agentReports: agentReports
                }, { analysis_type: 'advanced', monthYear: monthYear }).then(saved => {
                    if (saved) {
                    } else {
                        console.warn('âš  Advanced analysis save failed or timed out. Data is saved in database only (too large for localStorage).');
                    }
                }).catch(err => {
                    console.error('Error saving advanced analysis:', err);
                });
                
                saveAgentsListToDatabase(monthYear).then(saved => {
                    if (saved) {
                    }
                }).catch(err => {
                    console.error('Error saving agents list:', err);
                });
                
                const agentInfo = document.getElementById('advancedAgentInfo');
                agentInfo.innerHTML = `
                    <h3>Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø®ÙØ¶ Ù„Ø«Ù„Ø§Ø« Ø£Ø´Ù‡Ø±</h3>
                    <p><strong>Ø§Ø³Ù… Ø§Ù„ÙˆÙƒÙŠÙ„:</strong> ${results.agentName}</p>
                    <p><strong>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ­Ù„ÙŠÙ„:</strong> ${formatArabicDate(new Date())}</p>
                    <p><strong>Ù†ÙˆØ¹ Ø§Ù„ØªØ­Ù„ÙŠÙ„:</strong> Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø®ÙØ¶ Ù„Ø«Ù„Ø§Ø« Ø£Ø´Ù‡Ø±</p>
                    <p><strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±Ø§Ø¬Ø¹ Ù„Ù„ÙˆÙƒÙŠÙ„ :</strong> ${formatNumber(results.total.profit)} Ø¯.Ø¹</p>
                `;
                const resultsGrid = document.getElementById('advancedResultsGrid');
                resultsGrid.innerHTML = `
                    <div class="result-card bronze">
                        <h3> Bronze</h3>
                        <div class="count">${results.bronze.count}</div>
                        <div class="amount">Ø¹Ø±Ø¶: ${formatNumber(results.bronze.promoAmount)} Ø¯.Ø¹</div>
                        <div class="amount">Ø±Ø³Ù…ÙŠ: ${formatNumber(results.bronze.officialAmount)} Ø¯.Ø¹</div>
                    </div>
                    <div class="result-card silver">
                        <h3> Silver</h3>
                        <div class="count">${results.silver.count}</div>
                        <div class="amount">Ø¹Ø±Ø¶: ${formatNumber(results.silver.promoAmount)} Ø¯.Ø¹</div>
                        <div class="amount">Ø±Ø³Ù…ÙŠ: ${formatNumber(results.silver.officialAmount)} Ø¯.Ø¹</div>
                    </div>
                    <div class="result-card gold">
                        <h3> Gold</h3>
                        <div class="count">${results.gold.count}</div>
                        <div class="amount">Ø¹Ø±Ø¶: ${formatNumber(results.gold.promoAmount)} Ø¯.Ø¹</div>
                        <div class="amount">Ø±Ø³Ù…ÙŠ: ${formatNumber(results.gold.officialAmount)} Ø¯.Ø¹</div>
                    </div>
                    <div class="result-card platinum">
                        <h3> Platinum</h3>
                        <div class="count">${results.platinum.count}</div>
                        <div class="amount">Ø¹Ø±Ø¶: ${formatNumber(results.platinum.promoAmount)} Ø¯.Ø¹</div>
                        <div class="amount">Ø±Ø³Ù…ÙŠ: ${formatNumber(results.platinum.officialAmount)} Ø¯.Ø¹</div>
                    </div>
                    <div class="result-card">
                        <h3> Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</h3>
                        <div class="count">${results.total.count}</div>
                        <div class="amount">Ø¹Ø±Ø¶: ${formatNumber(results.total.promoAmount)} Ø¯.Ø¹</div>
                        <div class="amount">Ø±Ø³Ù…ÙŠ: ${formatNumber(results.total.officialAmount)} Ø¯.Ø¹</div>
                    </div>
                `;
                document.getElementById('advancedResults').classList.remove('hidden');
                updateAgentSummary();
                logActivity('ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª - 3 Ø£Ø´Ù‡Ø±', `ØªÙ… ØªØ­Ù„ÙŠÙ„ ${results.total.count} ØªÙØ¹ÙŠÙ„ Ù„Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø®ÙØ¶ 3 Ø£Ø´Ù‡Ø± Ù„Ù„ÙˆÙƒÙŠÙ„ ${results.agentName}`);
            } finally {
                setTimeout(() => {
                    displayLocks.delete(displayLockKey);
                }, 5000);
            }
            updateAgentSummary();
            logActivity('ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª - 3 Ø£Ø´Ù‡Ø±', `ØªÙ… ØªØ­Ù„ÙŠÙ„ ${results.total.count} ØªÙØ¹ÙŠÙ„ Ù„Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø®ÙØ¶ 3 Ø£Ø´Ù‡Ø± Ù„Ù„ÙˆÙƒÙŠÙ„ ${results.agentName}`);
        }
        function analyzeTwoMonthsData() {
            if (isAnalyzingTwoMonths) {
                showSuccessMessage('Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±...');
                return;
            }
            if (!twoMonthsData) {
                alert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø£ÙˆÙ„Ø§Ù‹');
                return;
            }
            isAnalyzingTwoMonths = true;
            twoMonthsDetails = [];
            showLoading('twoMonths');
                try {
                    const results = processTwoMonthsData(twoMonthsData);
                    if (results.total.count === 0) {
                        alert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ØªÙØ¹ÙŠÙ„Ø§Øª ØµØ§Ù„Ø­Ø© Ù„Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø®ÙØ¶ Ù„Ø´Ù‡Ø±ÙŠÙ†. ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ 2 Ø§Ø´ØªØ±Ø§ÙƒØ§Øª Ø®Ù„Ø§Ù„ 5 Ø£ÙŠØ§Ù… Ù„Ù†ÙØ³ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….');
                        hideLoading('twoMonths');
                    isAnalyzingTwoMonths = false;
                        return;
                    }
                    displayTwoMonthsResults(results);
                    hideLoading('twoMonths');
                    showSuccessMessage(`ØªÙ… ØªØ­Ù„ÙŠÙ„ ${results.total.count} ØªÙØ¹ÙŠÙ„ Ù„Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø®ÙØ¶ Ù„Ø´Ù‡Ø±ÙŠÙ† Ø¨Ù†Ø¬Ø§Ø­`);
                isAnalyzingTwoMonths = false;
                } catch (error) {
                    alert('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù„ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø®ÙØ¶ Ù„Ø´Ù‡Ø±ÙŠÙ†: ' + error.message);
                    hideLoading('twoMonths');
                isAnalyzingTwoMonths = false;
                }
        }
        function processTwoMonthsData(data) {
            const results = {
                bronze: { count: 0, promoAmount: 0, officialAmount: 0 },
                silver: { count: 0, promoAmount: 0, officialAmount: 0 },
                gold: { count: 0, promoAmount: 0, officialAmount: 0 },
                platinum: { count: 0, promoAmount: 0, officialAmount: 0 },
                total: { count: 0, promoAmount: 0, officialAmount: 0, profit: 0 },
                agentName: '',
                dateFrom: null,
                dateTo: null
            };
            if (data.length === 0) return results;
            results.agentName = data[0]['ColumnF'] || data[0][5] || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
            const userSubscriptions = {};
            const subscriptionDetails = {};
            data.forEach(row => {
                const id = row['ColumnA'] || row[0];
                const createdAt = row['ColumnB'] || row[1];
                const username = row['ColumnC'] || row[2];
                const subscription = row['ColumnI'] || row[8];
                const agent = row['ColumnF'] || row[5] || '';
                if (!createdAt || !username || !subscription) return;
                let dateObj;
                try {
                    if (createdAt instanceof Date) {
                        dateObj = createdAt;
                    } else {
                        if (typeof createdAt === 'number' && createdAt > 40000) {
                            dateObj = new Date((createdAt - 25569) * 86400 * 1000);
                        } else {
                            dateObj = new Date(createdAt);
                        }
                    }
                    if (isNaN(dateObj.getTime())) {
                        return;
                    }
                } catch (e) {
                    return;
                }
                const key = `${String(username).trim()}|${String(subscription).trim()}`;
                if (!userSubscriptions[key]) {
                    userSubscriptions[key] = [];
                    subscriptionDetails[key] = [];
                }
                userSubscriptions[key].push(dateObj);
                subscriptionDetails[key].push({
                    date: dateObj,
                    dateStr: createdAt,
                    username: String(username).trim(),
                    subscription: String(subscription).trim(),
                    agent: String(agent).trim()
                });
            });
            Object.keys(userSubscriptions).forEach(key => {
                const [username, subscription] = key.split('|');
                let dates = userSubscriptions[key].sort((a, b) => a - b);
                const details = subscriptionDetails[key].sort((a, b) => a.date - b.date);
                const usedForThreeMonths = new Array(dates.length).fill(false);
                for (let i = 0; i < dates.length - 2; i++) {
                    if (usedForThreeMonths[i]) continue;
                    for (let j = i + 1; j < dates.length - 1; j++) {
                        if (usedForThreeMonths[j]) continue;
                        for (let k = j + 1; k < dates.length; k++) {
                            if (usedForThreeMonths[k]) continue;
                            const daysDiff = (dates[k] - dates[i]) / (1000 * 60 * 60 * 24);
                            if (daysDiff >= 0 && daysDiff <= 5) {
                                usedForThreeMonths[i] = true;
                                usedForThreeMonths[j] = true;
                                usedForThreeMonths[k] = true;
                                break;
                            }
                        }
                    }
                }
                const remainingDates = dates.filter((date, index) => !usedForThreeMonths[index]);
                const remainingDetails = details.filter((detail, index) => !usedForThreeMonths[index]);
                let activations = 0;
                const used = new Array(remainingDates.length).fill(false);
                const activationDetails = [];
                for (let i = 0; i < remainingDates.length - 1; i++) {
                    if (used[i]) continue;
                    for (let j = i + 1; j < remainingDates.length; j++) {
                        if (used[j]) continue;
                        const daysDiff = (remainingDates[j] - remainingDates[i]) / (1000 * 60 * 60 * 24);
                        if (daysDiff >= 0 && daysDiff <= 5) {
                            used[i] = true;
                            used[j] = true;
                            activations++;
                            const subType = remainingDetails[i].subscription.trim();
                            const agentName = remainingDetails[i].agent || '';
                            const category = getSubscriptionCategory(subType, agentName);
                            const promoPrice = category ? getSubscriptionPrice(subType, category, 'twoMonths', 'promo') : 0;
                            const monthlyOfficialPrice = category ? getSubscriptionPrice(subType, category, 'basic') : 0;
                            const officialPrice = monthlyOfficialPrice * 2;
                            activationDetails.push({
                                username: remainingDetails[i].username,
                                subscription: remainingDetails[i].subscription,
                                agent: remainingDetails[i].agent,
                                date: remainingDetails[i].dateStr,
                                dateStr: remainingDetails[i].dateStr,
                                createdAt: remainingDetails[i].dateStr,
                                date1: remainingDetails[i].dateStr,
                                date2: remainingDetails[j].dateStr,
                                daysDiff: Math.round(daysDiff * 100) / 100,
                                promoPrice: promoPrice,
                                officialPrice: officialPrice,
                                type: 'Ø´Ù‡Ø±ÙŠÙ†'
                            });
                            break;
                        }
                    }
                }
                twoMonthsDetails.push(...activationDetails);
                if (activations > 0) {
                    const subType = subscription.trim();
                    const agentName = remainingDetails[0]?.agent || '';
                    const category = getSubscriptionCategory(subType, agentName);
                    if (category) {
                        const promoPrice = getSubscriptionPrice(subType, category, 'twoMonths');
                        const monthlyOfficialPrice = getSubscriptionPrice(subType, category, 'basic');
                    const officialPrice = monthlyOfficialPrice * 2;
                        switch(category) {
                            case 'B':
                        results.bronze.count += activations;
                        results.bronze.promoAmount += activations * promoPrice;
                        results.bronze.officialAmount += activations * officialPrice;
                                break;
                            case 'S':
                        results.silver.count += activations;
                        results.silver.promoAmount += activations * promoPrice;
                        results.silver.officialAmount += activations * officialPrice;
                                break;
                            case 'G':
                        results.gold.count += activations;
                        results.gold.promoAmount += activations * promoPrice;
                        results.gold.officialAmount += activations * officialPrice;
                                break;
                            case 'P':
                        results.platinum.count += activations;
                        results.platinum.promoAmount += activations * promoPrice;
                        results.platinum.officialAmount += activations * officialPrice;
                                break;
                        }
                    }
                }
            });
            results.total.count = results.bronze.count + results.silver.count + results.gold.count + results.platinum.count;
            results.total.promoAmount = results.bronze.promoAmount + results.silver.promoAmount + results.gold.promoAmount + results.platinum.promoAmount;
            results.total.officialAmount = results.bronze.officialAmount + results.silver.officialAmount + results.gold.officialAmount + results.platinum.officialAmount;
            results.total.profit = results.total.officialAmount - results.total.promoAmount;
            return results;
        }
        async function displayTwoMonthsResults(results) {
            const displayLockKey = `display_two_months_${results.agentName}_${getCurrentMonthYear()}`;
            if (displayLocks.has(displayLockKey)) {
                return;
            }
            displayLocks.set(displayLockKey, true);
            
            try {
                await ensureAgentExists(results.agentName);
                if (!agentReports[results.agentName]) {
                    agentReports[results.agentName] = {};
                }
                agentReports[results.agentName].twoMonths = results;
                const monthYear = extractMonthYearFromDetails(twoMonthsDetails) || 
                                 extractMonthYearFromData(twoMonthsData) || 
                                 getCurrentMonthYear();
                
                try {
                    const agentReportsString = JSON.stringify(agentReports);
                    if (agentReportsString.length <= 2000000) {
                        localStorage.setItem('agentReports', agentReportsString);
                    }
                } catch (e) {
                }
                
                await saveAgentAnalysisToArchive(results.agentName, 'two_months', {
                    results: results,
                    details: twoMonthsDetails,
                    data: twoMonthsData,
                    monthYear: monthYear,
                    analysisDate: new Date().toISOString()
                });
                
                saveToDatabase('analysis_archives', {
                    data: twoMonthsData,
                    details: twoMonthsDetails,
                    results: results,
                    agentReports: agentReports
                }, { analysis_type: 'two_months', monthYear: monthYear }).then(saved => {
                    if (!saved) {
                        console.warn('âš  Two months analysis save failed or timed out. Data is saved in database only (too large for localStorage).');
                    }
                }).catch(err => {
                    console.error('Error saving two months analysis:', err);
                });
                
                saveAgentsListToDatabase(monthYear).catch(err => console.error('Error saving agents list:', err));
                
                const agentInfo = document.getElementById('twoMonthsAgentInfo');
                agentInfo.innerHTML = `
                    <h3>Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø®ÙØ¶ Ù„Ø´Ù‡Ø±ÙŠÙ†</h3>
                    <p><strong>Ø§Ø³Ù… Ø§Ù„ÙˆÙƒÙŠÙ„:</strong> ${results.agentName}</p>
                    <p><strong>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ­Ù„ÙŠÙ„:</strong> ${formatArabicDate(new Date())}</p>
                    <p><strong>Ù†ÙˆØ¹ Ø§Ù„ØªØ­Ù„ÙŠÙ„:</strong> Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø®ÙØ¶ Ù„Ø´Ù‡Ø±ÙŠÙ†</p>
                    <p><strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±Ø§Ø¬Ø¹ Ù„Ù„ÙˆÙƒÙŠÙ„ :</strong> ${formatNumber(results.total.profit)} Ø¯.Ø¹</p>
                `;
                const resultsGrid = document.getElementById('twoMonthsResultsGrid');
                resultsGrid.innerHTML = `
                    <div class="result-card bronze">
                        <h3> Bronze</h3>
                        <div class="count">${results.bronze.count}</div>
                        <div class="amount">Ø¹Ø±Ø¶: ${formatNumber(results.bronze.promoAmount)} Ø¯.Ø¹</div>
                        <div class="amount">Ø±Ø³Ù…ÙŠ: ${formatNumber(results.bronze.officialAmount)} Ø¯.Ø¹</div>
                        <div class="amount" style="color: #28a745; font-weight: 700; margin-top: 5px;">Ø±Ø§Ø¬Ø¹: ${formatNumber(results.bronze.officialAmount - results.bronze.promoAmount)} Ø¯.Ø¹</div>
                    </div>
                    <div class="result-card silver">
                        <h3> Silver</h3>
                        <div class="count">${results.silver.count}</div>
                        <div class="amount">Ø¹Ø±Ø¶: ${formatNumber(results.silver.promoAmount)} Ø¯.Ø¹</div>
                        <div class="amount">Ø±Ø³Ù…ÙŠ: ${formatNumber(results.silver.officialAmount)} Ø¯.Ø¹</div>
                        <div class="amount" style="color: #28a745; font-weight: 700; margin-top: 5px;">Ø±Ø§Ø¬Ø¹: ${formatNumber(results.silver.officialAmount - results.silver.promoAmount)} Ø¯.Ø¹</div>
                    </div>
                    <div class="result-card gold">
                        <h3> Gold</h3>
                        <div class="count">${results.gold.count}</div>
                        <div class="amount">Ø¹Ø±Ø¶: ${formatNumber(results.gold.promoAmount)} Ø¯.Ø¹</div>
                        <div class="amount">Ø±Ø³Ù…ÙŠ: ${formatNumber(results.gold.officialAmount)} Ø¯.Ø¹</div>
                        <div class="amount" style="color: #28a745; font-weight: 700; margin-top: 5px;">Ø±Ø§Ø¬Ø¹: ${formatNumber(results.gold.officialAmount - results.gold.promoAmount)} Ø¯.Ø¹</div>
                    </div>
                    <div class="result-card platinum">
                        <h3> Platinum</h3>
                        <div class="count">${results.platinum.count}</div>
                        <div class="amount">Ø¹Ø±Ø¶: ${formatNumber(results.platinum.promoAmount)} Ø¯.Ø¹</div>
                        <div class="amount">Ø±Ø³Ù…ÙŠ: ${formatNumber(results.platinum.officialAmount)} Ø¯.Ø¹</div>
                        <div class="amount" style="color: #28a745; font-weight: 700; margin-top: 5px;">Ø±Ø§Ø¬Ø¹: ${formatNumber(results.platinum.officialAmount - results.platinum.promoAmount)} Ø¯.Ø¹</div>
                    </div>
                    <div class="result-card">
                        <h3> Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</h3>
                        <div class="count">${results.total.count}</div>
                        <div class="amount">Ø¹Ø±Ø¶: ${formatNumber(results.total.promoAmount)} Ø¯.Ø¹</div>
                        <div class="amount">Ø±Ø³Ù…ÙŠ: ${formatNumber(results.total.officialAmount)} Ø¯.Ø¹</div>
                        <div class="amount" style="color: #28a745; font-weight: 700; margin-top: 5px; font-size: 1.2rem;">Ø±Ø§Ø¬Ø¹ Ø§Ù„ÙƒÙ„ÙŠ: ${formatNumber(results.total.profit)} Ø¯.Ø¹</div>
                    </div>
                `;
                document.getElementById('twoMonthsResults').classList.remove('hidden');
                updateAgentSummary();
                logActivity('ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª - Ø´Ù‡Ø±ÙŠÙ†', `ØªÙ… ØªØ­Ù„ÙŠÙ„ ${results.total.count} ØªÙØ¹ÙŠÙ„ Ù„Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø®ÙØ¶ Ø´Ù‡Ø±ÙŠÙ† Ù„Ù„ÙˆÙƒÙŠÙ„ ${results.agentName}`);
            } finally {
                setTimeout(() => {
                    displayLocks.delete(displayLockKey);
                }, 5000);
            }
        }
        function showLoading(type) {
            document.getElementById(type + 'Loading').style.display = 'block';
        }
        function hideLoading(type) {
            document.getElementById(type + 'Loading').style.display = 'none';
        }
        function formatNumber(num) {
            if (num === null || num === undefined || isNaN(num)) return '0';
            return new Intl.NumberFormat('en-US').format(Math.floor(num));
        }
        async function resetBasicResults() {
            if (confirm('Ø³ÙŠØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.\n\nÙ‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ')) {
                document.getElementById('basicResults').classList.add('hidden');
                document.getElementById('basicFileInput').value = '';
                basicData = null;
                basicDetails = [];
                localStorage.removeItem('basicData');
                localStorage.removeItem('basicDetails');
                localStorage.removeItem('basicResults');
                Object.keys(agentReports).forEach(agent => {
                    if (agentReports[agent].basic) {
                        delete agentReports[agent].basic;
                        if (Object.keys(agentReports[agent]).length === 0) {
                            delete agentReports[agent];
                        }
                    }
                });
                showSuccessMessage('ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
            }
        }
        async function resetAdvancedResults() {
            if (confirm('Ø³ÙŠØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.\n\nÙ‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ')) {
                document.getElementById('advancedResults').classList.add('hidden');
                document.getElementById('advancedFileInput').value = '';
                advancedData = null;
                advancedDetails = [];
                localStorage.removeItem('advancedData');
                localStorage.removeItem('advancedDetails');
                localStorage.removeItem('advancedResults');
                Object.keys(agentReports).forEach(agent => {
                    if (agentReports[agent].advanced) {
                        delete agentReports[agent].advanced;
                        if (Object.keys(agentReports[agent]).length === 0) {
                            delete agentReports[agent];
                        }
                    }
                });
                showSuccessMessage('ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
            }
        }
        async function resetTwoMonthsResults() {
            if (confirm('Ø³ÙŠØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.\n\nÙ‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ')) {
                document.getElementById('twoMonthsResults').classList.add('hidden');
                document.getElementById('twoMonthsFileInput').value = '';
                twoMonthsData = null;
                twoMonthsDetails = [];
                localStorage.removeItem('twoMonthsData');
                localStorage.removeItem('twoMonthsDetails');
                localStorage.removeItem('twoMonthsResults');
                Object.keys(agentReports).forEach(agent => {
                    if (agentReports[agent].twoMonths) {
                        delete agentReports[agent].twoMonths;
                        if (Object.keys(agentReports[agent]).length === 0) {
                            delete agentReports[agent];
                        }
                    }
                });
                showSuccessMessage('ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
            }
        }
        function saveBasicReport() {
            if (!basicData || document.getElementById('basicResults').classList.contains('hidden')) {
                alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù„Ø­ÙØ¸Ù‡Ø§. ÙŠØ±Ø¬Ù‰ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø£ÙˆÙ„Ø§Ù‹.');
                return;
            }
            const results = processBasicData(basicData);
            const csvContent = generateBasicReportCSV(results);
            downloadCSV(csvContent, `ØªÙ‚Ø±ÙŠØ±_Ø£Ø³Ø§Ø³ÙŠ_${results.agentName}_${formatDateForFilename(new Date())}.csv`);
            logActivity('ØªØµØ¯ÙŠØ± ØªÙ‚Ø±ÙŠØ±', `ØªÙ… ØªØµØ¯ÙŠØ± ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠ Ù„Ù„ÙˆÙƒÙŠÙ„ ${results.agentName}`);
            showSuccessMessage('ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¨Ù†Ø¬Ø§Ø­!');
        }
        function saveAdvancedReport() {
            if (!advancedData || document.getElementById('advancedResults').classList.contains('hidden')) {
                alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù„Ø­ÙØ¸Ù‡Ø§. ÙŠØ±Ø¬Ù‰ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø£ÙˆÙ„Ø§Ù‹.');
                return;
            }
            const results = processAdvancedData(advancedData);
            const csvContent = generateAdvancedReportCSV(results);
            downloadCSV(csvContent, `ØªÙ‚Ø±ÙŠØ±_ØªÙØ¹ÙŠÙ„Ø§Øª_${results.agentName}_${formatDateForFilename(new Date())}.csv`);
            logActivity('ØªØµØ¯ÙŠØ± ØªÙ‚Ø±ÙŠØ±', `ØªÙ… ØªØµØ¯ÙŠØ± ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø®ÙØ¶ 3 Ø£Ø´Ù‡Ø± Ù„Ù„ÙˆÙƒÙŠÙ„ ${results.agentName}`);
            showSuccessMessage('ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¨Ù†Ø¬Ø§Ø­!');
        }
        function saveTwoMonthsReport() {
            if (!twoMonthsData || document.getElementById('twoMonthsResults').classList.contains('hidden')) {
                alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù„Ø­ÙØ¸Ù‡Ø§. ÙŠØ±Ø¬Ù‰ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø£ÙˆÙ„Ø§Ù‹.');
                return;
            }
            const results = processTwoMonthsData(twoMonthsData);
            const csvContent = generateTwoMonthsReportCSV(results);
            downloadCSV(csvContent, `ØªÙ‚Ø±ÙŠØ±_Ø´Ù‡Ø±ÙŠÙ†_${results.agentName}_${formatDateForFilename(new Date())}.csv`);
            logActivity('ØªØµØ¯ÙŠØ± ØªÙ‚Ø±ÙŠØ±', `ØªÙ… ØªØµØ¯ÙŠØ± ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø®ÙØ¶ Ø´Ù‡Ø±ÙŠÙ† Ù„Ù„ÙˆÙƒÙŠÙ„ ${results.agentName}`);
            showSuccessMessage('ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¨Ù†Ø¬Ø§Ø­!');
        }
        function generateBasicReportCSV(results) {
            const header = 'Ù†ÙˆØ¹ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ,Ø§Ù„Ø¹Ø¯Ø¯,Ø§Ù„Ù…Ø¨Ù„Øº (Ø¯.Ø¹)\n';
            const rows = [
                `Bronze,${results.bronze.count},${results.bronze.amount}`,
                `Silver,${results.silver.count},${results.silver.amount}`,
                `Gold,${results.gold.count},${results.gold.amount}`,
                `Platinum,${results.platinum.count},${results.platinum.amount}`,
                `Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹,${results.total.count},${results.total.amount}`
            ].join('\n');
            return header + rows;
        }
        function generateAdvancedReportCSV(results) {
            const header = 'Ù†ÙˆØ¹ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ,Ø¹Ø¯Ø¯ Ø§Ù„ØªÙØ¹ÙŠÙ„Ø§Øª,Ù…Ø¨Ù„Øº Ø§Ù„Ø¹Ø±Ø¶ (Ø¯.Ø¹),Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø±Ø³Ù…ÙŠ (Ø¯.Ø¹),Ø§Ù„Ø±Ø¨Ø­ (Ø¯.Ø¹)\n';
            const rows = [
                `Bronze,${results.bronze.count},${results.bronze.promoAmount},${results.bronze.officialAmount},${results.bronze.officialAmount - results.bronze.promoAmount}`,
                `Silver,${results.silver.count},${results.silver.promoAmount},${results.silver.officialAmount},${results.silver.officialAmount - results.silver.promoAmount}`,
                `Gold,${results.gold.count},${results.gold.promoAmount},${results.gold.officialAmount},${results.gold.officialAmount - results.gold.promoAmount}`,
                `Platinum,${results.platinum.count},${results.platinum.promoAmount},${results.platinum.officialAmount},${results.platinum.officialAmount - results.platinum.promoAmount}`,
                `Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹,${results.total.count},${results.total.promoAmount},${results.total.officialAmount},${results.total.profit}`
            ].join('\n');
            return header + rows;
        }
        function generateTwoMonthsReportCSV(results) {
            const header = 'Ù†ÙˆØ¹ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ,Ø¹Ø¯Ø¯ Ø§Ù„ØªÙØ¹ÙŠÙ„Ø§Øª,Ù…Ø¨Ù„Øº Ø§Ù„Ø¹Ø±Ø¶ (Ø¯.Ø¹),Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø±Ø³Ù…ÙŠ (Ø¯.Ø¹),Ø§Ù„Ø±Ø¨Ø­ (Ø¯.Ø¹)\n';
            const rows = [
                `Bronze,${results.bronze.count},${results.bronze.promoAmount},${results.bronze.officialAmount},${results.bronze.officialAmount - results.bronze.promoAmount}`,
                `Silver,${results.silver.count},${results.silver.promoAmount},${results.silver.officialAmount},${results.silver.officialAmount - results.silver.promoAmount}`,
                `Gold,${results.gold.count},${results.gold.promoAmount},${results.gold.officialAmount},${results.gold.officialAmount - results.gold.promoAmount}`,
                `Platinum,${results.platinum.count},${results.platinum.promoAmount},${results.platinum.officialAmount},${results.platinum.officialAmount - results.platinum.promoAmount}`,
                `Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹,${results.total.count},${results.total.promoAmount},${results.total.officialAmount},${results.total.profit}`
            ].join('\n');
            return header + rows;
        }
        function downloadCSV(content, filename) {
            const blob = new Blob(['\ufeff' + content], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        function formatDateForFilename(date) {
            return date.toISOString().split('T')[0];
        }
        function getReportInfo(agentName) {
            const reports = agentReports[agentName] || {};
            const agent = agentsList.find(a => a.name === agentName);
            const reportType = reports.twoMonths && (reports.twoMonths.total?.count > 0) ? 'twoMonths' : 
                              reports.advanced && (reports.advanced.total?.count > 0) ? 'advanced' : 
                              'basic';
            let reportData = {};
            let reportTitle = '';
            const getMonthFromDetails = (details) => {
                if (!details || !Array.isArray(details) || details.length === 0) {
                    return null;
                }
                for (const detail of details) {
                    let dateObj = null;
                    let dateField = detail.date1 || detail.date2 || detail.date3 || 
                                   detail.date || detail.dateStr || detail.createdAt || 
                                   detail['ColumnB'] || detail[1];
                    if (!dateField) continue;
                    try {
                        if (dateField instanceof Date) {
                            dateObj = dateField;
                        } else if (typeof dateField === 'number' && dateField > 40000) {
                            dateObj = new Date((dateField - 25569) * 86400 * 1000);
                        } else if (typeof dateField === 'string') {
                            const dateStr = dateField.trim();
                            const ddmmyyyy = dateStr.match(/^(\d{1,2})[-\/](\d{1,2})[-\/](\d{4})$/);
                            if (ddmmyyyy) {
                                dateObj = new Date(parseInt(ddmmyyyy[3]), parseInt(ddmmyyyy[2]) - 1, parseInt(ddmmyyyy[1]));
                            } else {
                                const yyyymmdd = dateStr.match(/^(\d{4})[-\/](\d{1,2})[-\/](\d{1,2})$/);
                                if (yyyymmdd) {
                                    dateObj = new Date(parseInt(yyyymmdd[1]), parseInt(yyyymmdd[2]) - 1, parseInt(yyyymmdd[3]));
                                } else {
                                    dateObj = new Date(dateField);
                                }
                            }
                        } else {
                            dateObj = new Date(dateField);
                        }
                        if (dateObj && !isNaN(dateObj.getTime())) {
                            return {
                                month: dateObj.getMonth() + 1,
                                year: dateObj.getFullYear()
                            };
                        }
                    } catch (e) {
                        continue;
                    }
                }
                return null;
            };
            let detectedMonth = null;
            let detectedYear = null;
            if (reportType === 'twoMonths') {
                reportData = reports.twoMonths || {};
                let details = reportData.details || [];
                if (details.length === 0) {
                    details = (twoMonthsDetails || []).filter(d => {
                        const agent = d.agent || d.Agent || d.agentName || d.AgentName || d['Ø§Ø³Ù… Ø§Ù„ÙˆÙƒÙŠÙ„'] || d['Ø§Ù„ÙˆÙƒÙŠÙ„'];
                        return agent === agentName;
                    });
                }
                const monthInfo = getMonthFromDetails(details);
                if (monthInfo) {
                    detectedMonth = monthInfo.month;
                    detectedYear = monthInfo.year;
                }
            } else if (reportType === 'advanced') {
                reportData = reports.advanced || {};
                let details = reportData.details || [];
                if (details.length === 0) {
                    details = (advancedDetails || []).filter(d => {
                        const agent = d.agent || d.Agent || d.agentName || d.AgentName || d['Ø§Ø³Ù… Ø§Ù„ÙˆÙƒÙŠÙ„'] || d['Ø§Ù„ÙˆÙƒÙŠÙ„'];
                        return agent === agentName;
                    });
                }
                const monthInfo = getMonthFromDetails(details);
                if (monthInfo) {
                    detectedMonth = monthInfo.month;
                    detectedYear = monthInfo.year;
                }
            } else {
                reportData = reports.basic || {};
                let details = reportData.details || [];
                if (details.length === 0) {
                    details = (basicDetails || []).filter(d => {
                        const agent = d.agent || d.Agent || d.agentName || d.AgentName || d['Ø§Ø³Ù… Ø§Ù„ÙˆÙƒÙŠÙ„'] || d['Ø§Ù„ÙˆÙƒÙŠÙ„'];
                        return agent === agentName;
                    });
                }
                const monthInfo = getMonthFromDetails(details);
                if (monthInfo) {
                    detectedMonth = monthInfo.month;
                    detectedYear = monthInfo.year;
                }
            }
            const today = new Date();
            const month = detectedMonth || (today.getMonth() + 1);
            const year = detectedYear || today.getFullYear();
            const monthName = arabicMonths[month - 1];
            const dateFrom = `1/${month}/${year}`;
            const dateTo = `${new Date(year, month, 0).getDate()}/${month}/${year}`;
            if (reportType === 'twoMonths') {
                if (reportData.dateFrom && reportData.dateTo) {
                    const dateFromParts = reportData.dateFrom.split('/');
                    const monthFrom = parseInt(dateFromParts[1]);
                    const yearFrom = parseInt(dateFromParts[2]);
                    const monthNameFrom = arabicMonths[monthFrom - 1];
                    reportTitle = `ÙƒØ´Ù ØªÙØ¹ÙŠÙ„Ø§Øª Ø§Ù„ÙˆÙƒÙ„Ø§Ø¡ Ø¹Ù† Ø§Ù„Ø¹Ø±Ø¶ (Ø´Ù‡Ø±ÙŠÙ†) Ø§Ù„Ù…Ø®ÙØ¶ Ù„Ø´Ù‡Ø± ${monthNameFrom}`;
                } else {
                    reportTitle = `ÙƒØ´Ù ØªÙØ¹ÙŠÙ„Ø§Øª Ø§Ù„ÙˆÙƒÙ„Ø§Ø¡ Ø¹Ù† Ø§Ù„Ø¹Ø±Ø¶ (Ø´Ù‡Ø±ÙŠÙ†) Ø§Ù„Ù…Ø®ÙØ¶ Ù„Ø´Ù‡Ø± ${monthName}`;
                }
            } else if (reportType === 'advanced') {
                reportTitle = `ÙƒØ´Ù ØªÙØ¹ÙŠÙ„Ø§Øª Ø§Ù„ÙˆÙƒÙ„Ø§Ø¡ Ø¹Ù† Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø®ÙØ¶ Ù„Ø«Ù„Ø§Ø«Ø© Ø£Ø´Ù‡Ø± Ù„Ø´Ù‡Ø± ${monthName}`;
            } else {
                reportTitle = `ÙƒØ´Ù ØªÙØ¹ÙŠÙ„Ø§Øª Ø§Ù„ÙˆÙƒÙ„Ø§Ø¡ Ø¹Ù† Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠ Ù„Ø´Ù‡Ø± ${monthName}`;
            }
            return {
                reportType,
                reportData,
                reportTitle,
                agent,
                dateFrom,
                dateTo
            };
        }
        function calculateCategoryPricesAndCounts(reportData, reportType) {
            const categories = ['platinum', 'gold', 'silver', 'bronze'];
            const result = {};
            categories.forEach(category => {
                const count = reportData[category]?.count || 0;
                result[`${category}Count`] = count;
                if (reportType === 'twoMonths' || reportType === 'advanced') {
                    const officialAmount = reportData[category]?.officialAmount || 0;
                    const promoAmount = reportData[category]?.promoAmount || 0;
                    result[`${category}Price`] = count > 0 ? Math.round((officialAmount - promoAmount) / count) : 0;
                } else {
                    const amount = reportData[category]?.amount || 0;
                    result[`${category}Price`] = count > 0 ? Math.round(amount / count) : 0;
                }
            });
            result.totalSubs = result.platinumCount + result.goldCount + result.silverCount + result.bronzeCount;
            result.totalAmount = reportData.total?.profit || reportData.total?.amount || 0;
            return result;
        }
        function downloadFile(blob, filename) {
            const downloadUrl = URL.createObjectURL(blob);
            const downloadLink = document.createElement('a');
            downloadLink.href = downloadUrl;
            downloadLink.download = filename;
            downloadLink.style.display = 'none';
            document.body.appendChild(downloadLink);
            downloadLink.click();
            setTimeout(() => {
                document.body.removeChild(downloadLink);
                URL.revokeObjectURL(downloadUrl);
            }, 1000);
        }
        function getReportFilename(agentName, extension) {
            const safeName = agentName.replace(/[^a-zA-Z0-9_]/g, '_');
            return `ØªÙ‚Ø±ÙŠØ±_${safeName}_${formatDateForFilename(new Date())}.${extension}`;
        }
        function getFileBlobPromise(agentName, fileType) {
                    return generateExcelReportBlob(agentName);
        }
        function getFileTypeInfo(fileType, agentName) {
            const typeMap = {
                'excel': { ext: 'xlsx', name: 'Excel' }
            };
            const info = typeMap[fileType] || typeMap['excel'];
            return {
                extension: info.ext,
                typeName: info.name,
                filename: getReportFilename(agentName, info.ext)
            };
        }
        function formatPhoneForWhatsApp(phone) {
            let cleanPhone = phone.replace(/[^0-9]/g, '');
            if (cleanPhone.startsWith('0')) {
                cleanPhone = '964' + cleanPhone.substring(1);
            } else if (!cleanPhone.startsWith('964') && cleanPhone.length <= 10) {
                cleanPhone = '964' + cleanPhone;
            }
            return cleanPhone;
        }
        function exportBasicData() {
            if (!basicData) {
                alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±. ÙŠØ±Ø¬Ù‰ ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø£ÙˆÙ„Ø§Ù‹.');
                return;
            }
            const filteredData = basicData.filter(row => {
                const count = row['ColumnP'] || row[15];
                return count == 1;
            });
            const csvContent = convertDataToCSV(filteredData);
            downloadCSV(csvContent, `Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª_Ø§Ù„Ù…ÙÙ„ØªØ±Ø©_${formatDateForFilename(new Date())}.csv`);
            alert('ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­!');
        }
        function exportAdvancedData() {
            if (!advancedData) {
                alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±. ÙŠØ±Ø¬Ù‰ ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø£ÙˆÙ„Ø§Ù‹.');
                return;
            }
            const results = processAdvancedData(advancedData);
            const csvContent = generateAdvancedReportCSV(results);
            downloadCSV(csvContent, `ØªÙ‚Ø±ÙŠØ±_ÙˆÙƒÙŠÙ„_${results.agentName}_${formatDateForFilename(new Date())}.csv`);
            alert('ØªÙ… ØªØµØ¯ÙŠØ± Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆÙƒÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­!');
        }
        function exportTwoMonthsData() {
            if (!twoMonthsData) {
                alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±. ÙŠØ±Ø¬Ù‰ ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø£ÙˆÙ„Ø§Ù‹.');
                return;
            }
            const results = processTwoMonthsData(twoMonthsData);
            const csvContent = generateTwoMonthsReportCSV(results);
            downloadCSV(csvContent, `ØªÙ‚Ø±ÙŠØ±_Ø´Ù‡Ø±ÙŠÙ†_ÙˆÙƒÙŠÙ„_${results.agentName}_${formatDateForFilename(new Date())}.csv`);
            alert('ØªÙ… ØªØµØ¯ÙŠØ± Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø®ÙØ¶ Ù„Ø´Ù‡Ø±ÙŠÙ† Ø¨Ù†Ø¬Ø§Ø­!');
        }
        function exportTwoMonthsDetailsToExcel() {
            if (!twoMonthsDetails || twoMonthsDetails.length === 0) {
                alert('Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙØ§ØµÙŠÙ„ Ù„Ù„ØªØµØ¯ÙŠØ±. ÙŠØ±Ø¬Ù‰ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø£ÙˆÙ„Ø§Ù‹.');
                return;
            }
            try {
                const wb = XLSX.utils.book_new();
                const excelData = twoMonthsDetails.map((detail, index) => {
                    const agent = agentsList.find(a => a.name === detail.agent);
                    const agentSubName = agent?.subName || '';
                    const agentDisplayName = agentSubName ? `${detail.agent}\n${agentSubName}` : detail.agent;
                    
                    return {
                        'Ø±Ù‚Ù…': index + 1,
                        'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…': detail.username,
                        'Ù†ÙˆØ¹ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ': detail.subscription,
                        'Ø§Ø³Ù… Ø§Ù„ÙˆÙƒÙŠÙ„': agentDisplayName,
                        'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø§Ù„Ø£ÙˆÙ„': detail.date1,
                        'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø§Ù„Ø«Ø§Ù†ÙŠ': detail.date2,
                        'Ø§Ù„ÙØ±Ù‚ Ø¨Ø§Ù„Ø£ÙŠØ§Ù…': detail.daysDiff,
                        'Ù†ÙˆØ¹ Ø§Ù„ØªÙØ¹ÙŠÙ„': detail.type,
                        'Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…Ø®ÙØ¶ (Ø¯.Ø¹)': subscriptionPrices.twoMonths.promo[detail.subscription] || 0,
                        'Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø±Ø³Ù…ÙŠ (Ø¯.Ø¹)': (subscriptionPrices.basic[detail.subscription] || 0) * 2,
                        'Ø§Ù„Ø±Ø§Ø¬Ø¹ Ù„Ù„ÙˆÙƒÙŠÙ„ (Ø¯.Ø¹)': ((subscriptionPrices.basic[detail.subscription] || 0) * 2) - (subscriptionPrices.twoMonths.promo[detail.subscription] || 0)
                    };
                });
                const ws = XLSX.utils.json_to_sheet(excelData);
                ws['!cols'] = [
                    { wch: 8 },
                    { wch: 25 },
                    { wch: 30 },
                    { wch: 20 },
                    { wch: 20 },
                    { wch: 20 },
                    { wch: 12 },
                    { wch: 15 },
                    { wch: 18 },
                    { wch: 18 },
                    { wch: 18 }
                ];
                XLSX.utils.book_append_sheet(wb, ws, 'ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªÙØ¹ÙŠÙ„Ø§Øª');
                const agentName = twoMonthsDetails.length > 0 ? twoMonthsDetails[0].agent : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                const filename = `ØªÙØ§ØµÙŠÙ„_Ø§Ù„ØªÙØ¹ÙŠÙ„Ø§Øª_Ø´Ù‡Ø±ÙŠÙ†_${agentName}_${formatDateForFilename(new Date())}.xlsx`;
                XLSX.writeFile(wb, filename);
                showSuccessMessage(`ØªÙ… ØªØµØ¯ÙŠØ± ${twoMonthsDetails.length} ØªÙØ¹ÙŠÙ„ Ø¥Ù„Ù‰ Ù…Ù„Ù Excel Ø¨Ù†Ø¬Ø§Ø­!`);
            } catch (error) {
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØµØ¯ÙŠØ±: ' + error.message);
                console.error('Export error:', error);
            }
        }
        function exportAdvancedDetailsToExcel() {
            if (!advancedDetails || advancedDetails.length === 0) {
                alert('Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙØ§ØµÙŠÙ„ Ù„Ù„ØªØµØ¯ÙŠØ±. ÙŠØ±Ø¬Ù‰ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø£ÙˆÙ„Ø§Ù‹.');
                return;
            }
            try {
                const wb = XLSX.utils.book_new();
                const excelData = advancedDetails.map((detail, index) => {
                    const agent = agentsList.find(a => a.name === detail.agent);
                    const agentSubName = agent?.subName || '';
                    const agentDisplayName = agentSubName ? `${detail.agent}\n${agentSubName}` : detail.agent;
                    
                    return {
                        'Ø±Ù‚Ù…': index + 1,
                        'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…': detail.username,
                        'Ù†ÙˆØ¹ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ': detail.subscription,
                        'Ø§Ø³Ù… Ø§Ù„ÙˆÙƒÙŠÙ„': agentDisplayName,
                        'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø§Ù„Ø£ÙˆÙ„': detail.date1,
                        'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø§Ù„Ø«Ø§Ù†ÙŠ': detail.date2,
                        'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø§Ù„Ø«Ø§Ù„Ø«': detail.date3,
                        'Ø§Ù„ÙØ±Ù‚ Ø¨Ø§Ù„Ø£ÙŠØ§Ù…': detail.daysDiff,
                        'Ù†ÙˆØ¹ Ø§Ù„ØªÙØ¹ÙŠÙ„': detail.type,
                        'Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…Ø®ÙØ¶ (Ø¯.Ø¹)': subscriptionPrices.advanced.promo[detail.subscription] || 0,
                        'Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø±Ø³Ù…ÙŠ (Ø¯.Ø¹)': subscriptionPrices.advanced.official[detail.subscription] || 0,
                        'Ø§Ù„Ø±Ø§Ø¬Ø¹ Ù„Ù„ÙˆÙƒÙŠÙ„ (Ø¯.Ø¹)': (subscriptionPrices.advanced.official[detail.subscription] || 0) - (subscriptionPrices.advanced.promo[detail.subscription] || 0)
                    };
                });
                const ws = XLSX.utils.json_to_sheet(excelData);
                ws['!cols'] = [
                    { wch: 8 },
                    { wch: 25 },
                    { wch: 30 },
                    { wch: 20 },
                    { wch: 20 },
                    { wch: 20 },
                    { wch: 20 },
                    { wch: 12 },
                    { wch: 15 },
                    { wch: 18 },
                    { wch: 18 },
                    { wch: 18 }
                ];
                XLSX.utils.book_append_sheet(wb, ws, 'ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªÙØ¹ÙŠÙ„Ø§Øª');
                const agentName = advancedDetails.length > 0 ? advancedDetails[0].agent : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                const filename = `ØªÙØ§ØµÙŠÙ„_Ø§Ù„ØªÙØ¹ÙŠÙ„Ø§Øª_Ø«Ù„Ø§Ø«_Ø£Ø´Ù‡Ø±_${agentName}_${formatDateForFilename(new Date())}.xlsx`;
                XLSX.writeFile(wb, filename);
                showSuccessMessage(`ØªÙ… ØªØµØ¯ÙŠØ± ${advancedDetails.length} ØªÙØ¹ÙŠÙ„ Ø¥Ù„Ù‰ Ù…Ù„Ù Excel Ø¨Ù†Ø¬Ø§Ø­!`);
            } catch (error) {
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØµØ¯ÙŠØ±: ' + error.message);
                console.error('Export error:', error);
            }
        }
        function exportBasicDetailsToExcel() {
            if (!basicDetails || basicDetails.length === 0) {
                alert('Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙØ§ØµÙŠÙ„ Ù„Ù„ØªØµØ¯ÙŠØ±. ÙŠØ±Ø¬Ù‰ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø£ÙˆÙ„Ø§Ù‹.');
                return;
            }
            try {
                const wb = XLSX.utils.book_new();
                const excelData = basicDetails.map((detail, index) => {
                    const agent = agentsList.find(a => a.name === detail.agent);
                    const agentSubName = agent?.subName || '';
                    const agentDisplayName = agentSubName ? `${detail.agent}\n${agentSubName}` : detail.agent;
                    
                    return {
                        'Ø±Ù‚Ù…': index + 1,
                        'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…': detail.username,
                        'Ù†ÙˆØ¹ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ': detail.subscription,
                        'Ø§Ø³Ù… Ø§Ù„ÙˆÙƒÙŠÙ„': agentDisplayName,
                        'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ': detail.date,
                        'Ù†ÙˆØ¹ Ø§Ù„Ø¹Ø±Ø¶': detail.type,
                        'Ø§Ù„Ù…Ø¨Ù„Øº (Ø¯.Ø¹)': detail.price
                    };
                });
                const ws = XLSX.utils.json_to_sheet(excelData);
                ws['!cols'] = [
                    { wch: 8 },
                    { wch: 25 },
                    { wch: 30 },
                    { wch: 20 },
                    { wch: 20 },
                    { wch: 15 },
                    { wch: 15 }
                ];
                XLSX.utils.book_append_sheet(wb, ws, 'ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª');
                const agentName = basicDetails.length > 0 ? basicDetails[0].agent : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                const filename = `ØªÙØ§ØµÙŠÙ„_Ø§Ù„Ø¹Ø±Ø¶_Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠ_${agentName}_${formatDateForFilename(new Date())}.xlsx`;
                XLSX.writeFile(wb, filename);
                showSuccessMessage(`ØªÙ… ØªØµØ¯ÙŠØ± ${basicDetails.length} Ø§Ø´ØªØ±Ø§Ùƒ Ø¥Ù„Ù‰ Ù…Ù„Ù Excel Ø¨Ù†Ø¬Ø§Ø­!`);
            } catch (error) {
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØµØ¯ÙŠØ±: ' + error.message);
                console.error('Export error:', error);
            }
        }
        function convertDataToCSV(data) {
            if (!data || data.length === 0) return '';
            const headers = ['ID', 'Ø§Ù„ØªØ§Ø±ÙŠØ®', 'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…', 'Ù†ÙˆØ¹ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ', 'Ø§Ù„ÙˆÙƒÙŠÙ„'];
            let csv = headers.join(',') + '\n';
            data.forEach(row => {
                const rowData = [
                    row['ColumnA'] || row[0] || '',
                    row['ColumnB'] || row[1] || '',
                    row['ColumnC'] || row[2] || '',
                    row['ColumnI'] || row[8] || '',
                    row['ColumnF'] || row[5] || ''
                ];
                csv += rowData.map(field => `"${field}"`).join(',') + '\n';
            });
            return csv;
        }
        function updateAgentSummary() {
            const switchUserText = document.getElementById('switchUserText');
            if (switchUserText) {
                switchUserText.textContent = loggedInUser || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
            }
            const switchUserBtnName = document.getElementById('switchUserBtnName');
            if (switchUserBtnName) {
                switchUserBtnName.textContent = loggedInUser || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
            }
            
            if (!agentReports || Object.keys(agentReports).length === 0) {
                document.getElementById('summaryContent').innerHTML = `
                    <div style="text-align: center; padding: 60px 20px; background: var(--bg-secondary); border-radius: 12px; border: 2px dashed var(--border-color);">
                        <div style="font-size: 3rem; margin-bottom: 20px;">ðŸ“Š</div>
                        <p style="color: var(--text-secondary); font-size: 1.1rem; font-weight: 600; margin: 0;">
                            Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø¹Ø±Ø¶
                        </p>
                        <p style="color: var(--text-tertiary); font-size: 0.9rem; margin-top: 10px;">
                            ÙŠØ±Ø¬Ù‰ ØªØ­Ù„ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆÙƒÙ„Ø§Ø¡ Ø£ÙˆÙ„Ø§Ù‹
                        </p>
                    </div>
                `;
                document.getElementById('summaryTotals').style.display = 'none';
                document.getElementById('chartsSection').style.display = 'none';
                return;
            }
            let totalBasicAll = 0;
            let totalAdvancedAll = 0;
            let totalTwoMonthsAll = 0;
            let totalAllAgents = 0;
            let agentsCount = 0;
            let summaryHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 15px; margin-bottom: 20px;">
            `;
            const sortedAgents = Object.entries(agentReports).sort((a, b) => {
                let totalA = 0;
                let totalB = 0;
                if (a[1].basic && a[1].basic.total && a[1].basic.total.amount > 0) totalA += a[1].basic.total.amount;
                if (a[1].advanced && a[1].advanced.total && a[1].advanced.total.profit > 0) totalA += a[1].advanced.total.profit;
                if (a[1].twoMonths && a[1].twoMonths.total && a[1].twoMonths.total.profit > 0) totalA += a[1].twoMonths.total.profit;
                if (b[1].basic && b[1].basic.total && b[1].basic.total.amount > 0) totalB += b[1].basic.total.amount;
                if (b[1].advanced && b[1].advanced.total && b[1].advanced.total.profit > 0) totalB += b[1].advanced.total.profit;
                if (b[1].twoMonths && b[1].twoMonths.total && b[1].twoMonths.total.profit > 0) totalB += b[1].twoMonths.total.profit;
                return totalB - totalA;
            });
            sortedAgents.forEach(([agentName, report]) => {
                let totalBasic = (report.basic && report.basic.total && report.basic.total.amount > 0) ? report.basic.total.amount : 0;
                let totalAdvanced = (report.advanced && report.advanced.total && report.advanced.total.profit > 0) ? report.advanced.total.profit : 0;
                let totalTwoMonths = (report.twoMonths && report.twoMonths.total && report.twoMonths.total.profit > 0) ? report.twoMonths.total.profit : 0;
                let totalAll = 0;
                let offersCount = 0;
                if (totalBasic > 0) {
                    totalAll += totalBasic;
                    offersCount++;
                }
                if (totalAdvanced > 0) {
                    totalAll += totalAdvanced;
                    offersCount++;
                }
                if (totalTwoMonths > 0) {
                    totalAll += totalTwoMonths;
                    offersCount++;
                }
                if (totalAll > 0) {
                    agentsCount++;
                }
                totalBasicAll += totalBasic;
                totalAdvancedAll += totalAdvanced;
                totalTwoMonthsAll += totalTwoMonths;
                totalAllAgents += totalAll;
                
                let agentOffersHTML = '';
                if (report.basic && totalBasic > 0) {
                    agentOffersHTML += `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 10px; background: rgba(34, 197, 94, 0.1); border-radius: 6px; margin-bottom: 6px; border-right: 2px solid #22c55e;">
                            <span style="font-weight: 600; color: var(--text-primary); font-size: 0.85rem;">ðŸ†“ Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠ</span>
                            <span style="font-weight: 700; color: #22c55e; font-size: 0.85rem;">${formatNumber(totalBasic)} Ø¯.Ø¹</span>
                        </div>
                    `;
                }
                if (report.advanced && totalAdvanced > 0) {
                    agentOffersHTML += `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 10px; background: rgba(59, 130, 246, 0.1); border-radius: 6px; margin-bottom: 6px; border-right: 2px solid #3b82f6;">
                            <span style="font-weight: 600; color: var(--text-primary); font-size: 0.85rem;">ðŸ“‰ Ù…Ø®ÙØ¶ 3 Ø£Ø´Ù‡Ø±</span>
                            <span style="font-weight: 700; color: #3b82f6; font-size: 0.85rem;">${formatNumber(totalAdvanced)} Ø¯.Ø¹</span>
                        </div>
                    `;
                }
                if (report.twoMonths && totalTwoMonths > 0) {
                    agentOffersHTML += `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 10px; background: rgba(168, 85, 247, 0.1); border-radius: 6px; margin-bottom: 6px; border-right: 2px solid #a855f7;">
                            <span style="font-weight: 600; color: var(--text-primary); font-size: 0.85rem;">ðŸ“‰ Ù…Ø®ÙØ¶ Ø´Ù‡Ø±ÙŠÙ†</span>
                            <span style="font-weight: 700; color: #a855f7; font-size: 0.85rem;">${formatNumber(totalTwoMonths)} Ø¯.Ø¹</span>
                        </div>
                    `;
                }
                
                if (totalAll > 0) {
                    const agentPercentage = totalAllAgents > 0 ? ((totalAll / totalAllAgents) * 100).toFixed(1) : 0;
                    summaryHTML += `
                        <div class="agent-summary-card" style="background: var(--card-bg); border: 2px solid var(--border-color); border-radius: 12px; padding: 16px; box-shadow: 0 3px 12px var(--shadow-sm); transition: all 0.3s ease; position: relative; overflow: hidden;">
                            <div style="position: absolute; top: 0; right: 0; width: 45px; height: 45px; background: linear-gradient(135deg, rgba(128, 28, 50, 0.1), rgba(165, 45, 69, 0.05)); border-radius: 0 0 0 40px;"></div>
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; padding-bottom: 10px; border-bottom: 2px solid var(--border-color); position: relative; z-index: 2;">
                                <h3 style="margin: 0; font-size: 1rem; font-weight: 800; color: var(--primary-color); text-shadow: 0 1px 2px rgba(0,0,0,0.1);">${agentName}</h3>
                                <span style="background: linear-gradient(135deg, var(--primary-color), var(--primary-hover)); color: #fff; padding: 4px 10px; border-radius: 16px; font-size: 0.7rem; font-weight: 700; box-shadow: 0 2px 6px rgba(128, 28, 50, 0.3);">${offersCount} Ø¹Ø±Ø¶</span>
                            </div>
                            <div style="margin-bottom: 12px; position: relative; z-index: 2;">
                                ${agentOffersHTML}
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: linear-gradient(135deg, rgba(128, 28, 50, 0.12), rgba(165, 45, 69, 0.08)); border-radius: 8px; border-top: 2px solid var(--primary-color); margin-top: 8px; position: relative; z-index: 2; box-shadow: 0 2px 6px rgba(128, 28, 50, 0.1);">
                                <div>
                                    <span style="font-weight: 700; color: var(--text-primary); font-size: 0.85rem; display: block; margin-bottom: 3px;">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</span>
                                    <span style="font-size: 0.7rem; color: var(--text-secondary); font-weight: 600;">${agentPercentage}% Ù…Ù† Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</span>
                                </div>
                                <span style="font-weight: 900; color: var(--primary-color); font-size: 1.2rem; text-shadow: 0 2px 4px rgba(128, 28, 50, 0.2);">${formatNumber(totalAll)} Ø¯.Ø¹</span>
                            </div>
                        </div>
                    `;
                }
            });
            summaryHTML += `</div>`;
            document.getElementById('summaryContent').innerHTML = summaryHTML;
            
            const totalOffers = totalBasicAll + totalAdvancedAll + totalTwoMonthsAll;
            const basicPercentage = totalOffers > 0 ? ((totalBasicAll / totalOffers) * 100).toFixed(1) : 0;
            const advancedPercentage = totalOffers > 0 ? ((totalAdvancedAll / totalOffers) * 100).toFixed(1) : 0;
            const twoMonthsPercentage = totalOffers > 0 ? ((totalTwoMonthsAll / totalOffers) * 100).toFixed(1) : 0;
            
            let basicAgentsCount = 0, advancedAgentsCount = 0, twoMonthsAgentsCount = 0;
            sortedAgents.forEach(([agentName, report]) => {
                if (report.basic && report.basic.total && report.basic.total.amount > 0) basicAgentsCount++;
                if (report.advanced && report.advanced.total && report.advanced.total.profit > 0) advancedAgentsCount++;
                if (report.twoMonths && report.twoMonths.total && report.twoMonths.total.profit > 0) twoMonthsAgentsCount++;
            });
            
            let totalsHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <div style="background: linear-gradient(135deg, #22c55e, #16a34a); color: #fff; border-radius: 12px; padding: 18px; box-shadow: 0 4px 16px rgba(34, 197, 94, 0.3); text-align: center; border: 2px solid rgba(255, 255, 255, 0.2); position: relative; overflow: hidden;">
                        <div style="position: absolute; top: -15px; right: -15px; width: 70px; height: 70px; background: rgba(255, 255, 255, 0.1); border-radius: 50%;"></div>
                        <div style="position: relative; z-index: 2;">
                            <div style="font-size: 1.5rem; margin-bottom: 8px;"></div>
                            <div style="font-size: 0.95rem; font-weight: 700; margin-bottom: 10px; opacity: 0.95;">Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠ</div>
                            <div style="font-size: 1.6rem; font-weight: 900; margin-bottom: 6px; text-shadow: 0 2px 6px rgba(0,0,0,0.2);">${formatNumber(totalBasicAll)}</div>
                            <div style="padding: 6px 10px; background: rgba(255, 255, 255, 0.2); border-radius: 6px; margin-top: 8px; font-size: 0.8rem; font-weight: 600;">
                                ${basicPercentage}% | ${basicAgentsCount} ÙˆÙƒÙŠÙ„
                            </div>
                        </div>
                    </div>
                    <div style="background: linear-gradient(135deg, #3b82f6, #2563eb); color: #fff; border-radius: 12px; padding: 18px; box-shadow: 0 4px 16px rgba(59, 130, 246, 0.3); text-align: center; border: 2px solid rgba(255, 255, 255, 0.2); position: relative; overflow: hidden;">
                        <div style="position: absolute; top: -15px; right: -15px; width: 70px; height: 70px; background: rgba(255, 255, 255, 0.1); border-radius: 50%;"></div>
                        <div style="position: relative; z-index: 2;">
                            <div style="font-size: 1.5rem; margin-bottom: 8px;"></div>
                            <div style="font-size: 0.95rem; font-weight: 700; margin-bottom: 10px; opacity: 0.95;">Ù…Ø®ÙØ¶ 3 Ø£Ø´Ù‡Ø±</div>
                            <div style="font-size: 1.6rem; font-weight: 900; margin-bottom: 6px; text-shadow: 0 2px 6px rgba(0,0,0,0.2);">${formatNumber(totalAdvancedAll)}</div>
                            <div style="padding: 6px 10px; background: rgba(255, 255, 255, 0.2); border-radius: 6px; margin-top: 8px; font-size: 0.8rem; font-weight: 600;">
                                ${advancedPercentage}% | ${advancedAgentsCount} ÙˆÙƒÙŠÙ„
                            </div>
                        </div>
                    </div>
                    <div style="background: linear-gradient(135deg, #a855f7, #9333ea); color: #fff; border-radius: 12px; padding: 18px; box-shadow: 0 4px 16px rgba(168, 85, 247, 0.3); text-align: center; border: 2px solid rgba(255, 255, 255, 0.2); position: relative; overflow: hidden;">
                        <div style="position: absolute; top: -15px; right: -15px; width: 70px; height: 70px; background: rgba(255, 255, 255, 0.1); border-radius: 50%;"></div>
                        <div style="position: relative; z-index: 2;">
                            <div style="font-size: 1.5rem; margin-bottom: 8px;"></div>
                            <div style="font-size: 0.95rem; font-weight: 700; margin-bottom: 10px; opacity: 0.95;">Ù…Ø®ÙØ¶ Ø´Ù‡Ø±ÙŠÙ†</div>
                            <div style="font-size: 1.6rem; font-weight: 900; margin-bottom: 6px; text-shadow: 0 2px 6px rgba(0,0,0,0.2);">${formatNumber(totalTwoMonthsAll)}</div>
                            <div style="padding: 6px 10px; background: rgba(255, 255, 255, 0.2); border-radius: 6px; margin-top: 8px; font-size: 0.8rem; font-weight: 600;">
                                ${twoMonthsPercentage}% | ${twoMonthsAgentsCount} ÙˆÙƒÙŠÙ„
                            </div>
                        </div>
                    </div>
                    <div style="background: linear-gradient(135deg, #801c32, #a52d45); color: #fff; border-radius: 12px; padding: 18px; box-shadow: 0 6px 20px rgba(128, 28, 50, 0.4); text-align: center; border: 2px solid rgba(255, 255, 255, 0.3); position: relative; overflow: hidden;">
                        <div style="position: absolute; top: -20px; right: -20px; width: 80px; height: 80px; background: rgba(255, 255, 255, 0.15); border-radius: 50%;"></div>
                        <div style="position: relative; z-index: 2;">
                            <div style="font-size: 1.8rem; margin-bottom: 10px;"></div>
                            <div style="font-size: 1rem; font-weight: 800; margin-bottom: 12px; opacity: 0.95; text-shadow: 0 2px 4px rgba(0,0,0,0.3);">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ„ÙŠ</div>
                            <div style="font-size: 1.8rem; font-weight: 900; margin-bottom: 8px; text-shadow: 0 2px 8px rgba(0,0,0,0.3);">${formatNumber(totalAllAgents)}</div>
                            <div style="font-size: 0.85rem; opacity: 0.95; margin-bottom: 10px; font-weight: 600;">Ø¯ÙŠÙ†Ø§Ø± Ø¹Ø±Ø§Ù‚ÙŠ</div>
                            <div style="padding: 8px 12px; background: rgba(255, 255, 255, 0.25); border-radius: 8px; margin-top: 8px; font-size: 0.85rem; font-weight: 700; border: 1px solid rgba(255, 255, 255, 0.3);">
                                ${agentsCount} ÙˆÙƒÙŠÙ„ 
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('summaryTotalsGrid').innerHTML = totalsHTML;
            document.getElementById('summaryTotals').style.display = 'block';
            
            createCharts(totalBasicAll, totalAdvancedAll, totalTwoMonthsAll, sortedAgents);
        }
        
        function createCharts(totalBasic, totalAdvanced, totalTwoMonths, agentsData) {
            if (window.offersChart && typeof window.offersChart.destroy === 'function') {
                try {
                    window.offersChart.destroy();
                } catch (e) {
                    console.warn('Error destroying offersChart:', e);
                }
                window.offersChart = null;
            }
            if (window.topAgentsChart && typeof window.topAgentsChart.destroy === 'function') {
                try {
                    window.topAgentsChart.destroy();
                } catch (e) {
                    console.warn('Error destroying topAgentsChart:', e);
                }
                window.topAgentsChart = null;
            }
            if (window.subscriptionsChart && typeof window.subscriptionsChart.destroy === 'function') {
                try {
                    window.subscriptionsChart.destroy();
                } catch (e) {
                    console.warn('Error destroying subscriptionsChart:', e);
                }
                window.subscriptionsChart = null;
            }
            
            const offersCtx = document.getElementById('offersChart');
            if (offersCtx) {
                const totalOffers = totalBasic + totalAdvanced + totalTwoMonths;
                window.offersChart = new Chart(offersCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠ', 'Ù…Ø®ÙØ¶ 3 Ø£Ø´Ù‡Ø±', 'Ù…Ø®ÙØ¶ Ø´Ù‡Ø±ÙŠÙ†'],
                        datasets: [{
                            data: [totalBasic, totalAdvanced, totalTwoMonths],
                            backgroundColor: [
                                'rgba(34, 197, 94, 0.85)',
                                'rgba(59, 130, 246, 0.85)',
                                'rgba(168, 85, 247, 0.85)'
                            ],
                            borderColor: [
                                '#22c55e',
                                '#3b82f6',
                                '#a855f7'
                            ],
                            borderWidth: 3,
                            hoverOffset: 8
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 12,
                                    font: {
                                        size: 11,
                                        family: 'Cairo',
                                        weight: '600'
                                    },
                                    usePointStyle: true,
                                    pointStyle: 'circle'
                                }
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                padding: 10,
                                titleFont: {
                                    size: 12,
                                    family: 'Cairo',
                                    weight: '700'
                                },
                                bodyFont: {
                                    size: 11,
                                    family: 'Cairo'
                                },
                                callbacks: {
                                    label: function(context) {
                                        const value = context.parsed;
                                        const percentage = totalOffers > 0 ? ((value / totalOffers) * 100).toFixed(1) : 0;
                                        return context.label + ': ' + formatNumber(value) + ' Ø¯.Ø¹ (' + percentage + '%)';
                                    }
                                }
                            }
                        }
                    }
                });
            }
            
            const topAgentsCtx = document.getElementById('topAgentsChart');
            if (topAgentsCtx && agentsData.length > 0) {
                const topAgents = agentsData.slice(0, 10).map(([agentName, report]) => {
                    let total = 0;
                    if (report.basic?.total?.amount) total += report.basic.total.amount;
                    if (report.advanced?.total?.profit) total += report.advanced.total.profit;
                    if (report.twoMonths?.total?.profit) total += report.twoMonths.total.profit;
                    return { name: agentName, total: total };
                }).filter(a => a.total > 0);
                
                window.topAgentsChart = new Chart(topAgentsCtx, {
                    type: 'bar',
                    data: {
                        labels: topAgents.map(a => a.name),
                        datasets: [{
                            label: 'Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ (Ø¯.Ø¹)',
                            data: topAgents.map(a => a.total),
                            backgroundColor: topAgents.map((a, i) => {
                                const colors = [
                                    'rgba(128, 28, 50, 0.85)',
                                    'rgba(165, 45, 69, 0.85)',
                                    'rgba(192, 62, 86, 0.85)',
                                    'rgba(219, 79, 103, 0.85)',
                                    'rgba(246, 96, 120, 0.85)'
                                ];
                                return colors[i % colors.length];
                            }),
                            borderColor: '#801c32',
                            borderWidth: 2,
                            borderRadius: 6,
                            borderSkipped: false
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        indexAxis: 'y',
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                padding: 10,
                                titleFont: {
                                    size: 12,
                                    family: 'Cairo',
                                    weight: '700'
                                },
                                bodyFont: {
                                    size: 11,
                                    family: 'Cairo'
                                },
                                callbacks: {
                                    label: function(context) {
                                        return formatNumber(context.parsed.x) + ' Ø¯ÙŠÙ†Ø§Ø± Ø¹Ø±Ø§Ù‚ÙŠ';
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                ticks: {
                                    callback: function(value) {
                                        return formatNumber(value);
                                    },
                                    font: {
                                        size: 9,
                                        family: 'Cairo'
                                    }
                                },
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)'
                                }
                            },
                            y: {
                                ticks: {
                                    font: {
                                        size: 9,
                                        family: 'Cairo'
                                    }
                                },
                                grid: {
                                    display: false
                                }
                            }
                        }
                    }
                });
            }
            
            const subscriptionsCtx = document.getElementById('subscriptionsChart');
            if (subscriptionsCtx) {
                let totalBronze = 0, totalSilver = 0, totalGold = 0, totalPlatinum = 0;
                if (agentsData && agentsData.length > 0) {
                    agentsData.forEach(([agentName, report]) => {
                        if (report.basic && report.basic.bronze) {
                            totalBronze += Number(report.basic.bronze.count || 0);
                        }
                        if (report.basic && report.basic.silver) {
                            totalSilver += Number(report.basic.silver.count || 0);
                        }
                        if (report.basic && report.basic.gold) {
                            totalGold += Number(report.basic.gold.count || 0);
                        }
                        if (report.basic && report.basic.platinum) {
                            totalPlatinum += Number(report.basic.platinum.count || 0);
                        }
                        if (report.advanced && report.advanced.bronze) {
                            totalBronze += Number(report.advanced.bronze.count || 0);
                        }
                        if (report.advanced && report.advanced.silver) {
                            totalSilver += Number(report.advanced.silver.count || 0);
                        }
                        if (report.advanced && report.advanced.gold) {
                            totalGold += Number(report.advanced.gold.count || 0);
                        }
                        if (report.advanced && report.advanced.platinum) {
                            totalPlatinum += Number(report.advanced.platinum.count || 0);
                        }
                        if (report.twoMonths && report.twoMonths.bronze) {
                            totalBronze += Number(report.twoMonths.bronze.count || 0);
                        }
                        if (report.twoMonths && report.twoMonths.silver) {
                            totalSilver += Number(report.twoMonths.silver.count || 0);
                        }
                        if (report.twoMonths && report.twoMonths.gold) {
                            totalGold += Number(report.twoMonths.gold.count || 0);
                        }
                        if (report.twoMonths && report.twoMonths.platinum) {
                            totalPlatinum += Number(report.twoMonths.platinum.count || 0);
                        }
                    });
                }
                
                const totalSubscriptions = totalBronze + totalSilver + totalGold + totalPlatinum;
                const chartData = totalSubscriptions > 0 
                    ? [totalBronze, totalSilver, totalGold, totalPlatinum]
                    : [1, 1, 1, 1];
                
                const labels = ['Ø¨Ø±ÙˆÙ†Ø² (Bronze)', 'Ø³Ù„ÙØ± (Silver)', 'Ø°Ù‡Ø¨ÙŠ (Gold)', 'Ø¨Ù„Ø§ØªÙŠÙ†ÙŠÙˆÙ… (Platinum)'];
                const backgroundColors = [
                    'rgba(205, 127, 50, 0.8)',
                    'rgba(192, 192, 192, 0.8)',
                    'rgba(255, 215, 0, 0.8)',
                    'rgba(231, 231, 231, 0.8)'
                ];
                const borderColors = [
                    '#cd7f32',
                    '#c0c0c0',
                    '#ffd700',
                    '#e7e7e7'
                ];
                
                window.subscriptionsChart = new Chart(subscriptionsCtx, {
                    type: 'pie',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: chartData,
                            backgroundColor: backgroundColors,
                            borderColor: borderColors,
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 10,
                                    font: {
                                        size: 10,
                                        family: 'Cairo',
                                        weight: '600'
                                    },
                                    usePointStyle: true,
                                    pointStyle: 'circle',
                                    generateLabels: function(chart) {
                                        const values = [totalBronze, totalSilver, totalGold, totalPlatinum];
                                        const total = totalSubscriptions > 0 ? totalSubscriptions : values.reduce((a, b) => a + b, 0);
                                        return labels.map((label, i) => {
                                            const value = values[i];
                                            const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                            return {
                                                text: label + ': ' + formatNumberEnglish(value) + ' (' + percentage + '%)',
                                                fillStyle: backgroundColors[i],
                                                strokeStyle: borderColors[i],
                                                lineWidth: 2,
                                                hidden: false,
                                                index: i
                                            };
                                        });
                                    }
                                }
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                padding: 10,
                                titleFont: {
                                    size: 12,
                                    family: 'Cairo',
                                    weight: '700'
                                },
                                bodyFont: {
                                    size: 11,
                                    family: 'Cairo'
                                },
                                callbacks: {
                                    label: function(context) {
                                        if (totalSubscriptions === 0) {
                                            return context.label + ': Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª';
                                        }
                                        const value = context.parsed;
                                        const percentage = totalSubscriptions > 0 ? ((value / totalSubscriptions) * 100).toFixed(1) : 0;
                                        return context.label + ': ' + formatNumberEnglish(value) + ' Ø§Ø´ØªØ±Ø§Ùƒ (' + percentage + '%)';
                                    }
                                }
                            }
                        }
                    }
                });
            }
            
            document.getElementById('chartsSection').style.display = 'block';
        }
        function refreshSummary() {
            updateAgentSummary();
            showSuccessMessage('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù„Ø®Øµ Ø¨Ù†Ø¬Ø§Ø­!');
        }
        function exportSummaryToExcel() {
            if (!agentReports || Object.keys(agentReports).length === 0) {
                alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±. ÙŠØ±Ø¬Ù‰ ØªØ­Ù„ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆÙƒÙ„Ø§Ø¡ Ø£ÙˆÙ„Ø§Ù‹.');
                return;
            }
            
            let analyzedOfferType = null;
            let hasBasic = false, hasAdvanced = false, hasTwoMonths = false;
            
            Object.values(agentReports).forEach(report => {
                if (report.basic && report.basic.total && report.basic.total.count > 0) {
                    hasBasic = true;
                }
                if (report.advanced && report.advanced.total && report.advanced.total.count > 0) {
                    hasAdvanced = true;
                }
                if (report.twoMonths && report.twoMonths.total && report.twoMonths.total.count > 0) {
                    hasTwoMonths = true;
                }
            });
            
            if (hasBasic) {
                analyzedOfferType = 'basic';
            } else if (hasAdvanced) {
                analyzedOfferType = 'advanced';
            } else if (hasTwoMonths) {
                analyzedOfferType = 'twoMonths';
            }
            
            if (!analyzedOfferType) {
                alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„Ù„Ø© Ù„Ù„ØªØµØ¯ÙŠØ±. ÙŠØ±Ø¬Ù‰ ØªØ­Ù„ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆÙƒÙ„Ø§Ø¡ Ø£ÙˆÙ„Ø§Ù‹.');
                return;
            }
            
            try {
                const ExcelJS = window.ExcelJS;
                if (!ExcelJS) {
                    exportSummaryToExcelXLSX(analyzedOfferType);
                    return;
                }
                const workbook = new ExcelJS.Workbook();
                let worksheetTitle = '';
                let reportTitle = '';
                let headers = [];
                let totalColumns = 0;
                
                if (analyzedOfferType === 'basic') {
                    worksheetTitle = 'Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠ';
                    reportTitle = 'ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠ';
                    headers = [
                        'Ø§Ø³Ù… Ø§Ù„ÙˆÙƒÙŠÙ„',
                        'Ù†Ø³Ø¨Ø© Ø§Ù„ÙˆÙƒÙŠÙ„',
                        'Ø¨Ø±ÙˆÙ†Ø² (Ø¹Ø¯Ø¯)', 'Ø¨Ø±ÙˆÙ†Ø² (Ù…Ø¨Ù„Øº)',
                        'Ø³Ù„ÙØ± (Ø¹Ø¯Ø¯)', 'Ø³Ù„ÙØ± (Ù…Ø¨Ù„Øº)',
                        'Ø°Ù‡Ø¨ÙŠ (Ø¹Ø¯Ø¯)', 'Ø°Ù‡Ø¨ÙŠ (Ù…Ø¨Ù„Øº)',
                        'Ø¨Ù„Ø§ØªÙŠÙ†ÙŠÙˆÙ… (Ø¹Ø¯Ø¯)', 'Ø¨Ù„Ø§ØªÙŠÙ†ÙŠÙˆÙ… (Ù…Ø¨Ù„Øº)',
                        'Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ'
                    ];
                    totalColumns = 11;
                } else if (analyzedOfferType === 'advanced') {
                    worksheetTitle = 'Ù…Ø®ÙØ¶ 3 Ø£Ø´Ù‡Ø±';
                    reportTitle = 'ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø®ÙØ¶ Ù„Ø«Ù„Ø§Ø«Ø© Ø£Ø´Ù‡Ø±';
                    headers = [
                        'Ø§Ø³Ù… Ø§Ù„ÙˆÙƒÙŠÙ„',
                        'Ù†Ø³Ø¨Ø© Ø§Ù„ÙˆÙƒÙŠÙ„',
                        'Ø¨Ø±ÙˆÙ†Ø² (Ø¹Ø¯Ø¯)', 'Ø¨Ø±ÙˆÙ†Ø² (Ø¹Ø±Ø¶)', 'Ø¨Ø±ÙˆÙ†Ø² (Ø±Ø³Ù…ÙŠ)', 'Ø¨Ø±ÙˆÙ†Ø² (Ø±Ø§Ø¬Ø¹)',
                        'Ø³Ù„ÙØ± (Ø¹Ø¯Ø¯)', 'Ø³Ù„ÙØ± (Ø¹Ø±Ø¶)', 'Ø³Ù„ÙØ± (Ø±Ø³Ù…ÙŠ)', 'Ø³Ù„ÙØ± (Ø±Ø§Ø¬Ø¹)',
                        'Ø°Ù‡Ø¨ÙŠ (Ø¹Ø¯Ø¯)', 'Ø°Ù‡Ø¨ÙŠ (Ø¹Ø±Ø¶)', 'Ø°Ù‡Ø¨ÙŠ (Ø±Ø³Ù…ÙŠ)', 'Ø°Ù‡Ø¨ÙŠ (Ø±Ø§Ø¬Ø¹)',
                        'Ø¨Ù„Ø§ØªÙŠÙ†ÙŠÙˆÙ… (Ø¹Ø¯Ø¯)', 'Ø¨Ù„Ø§ØªÙŠÙ†ÙŠÙˆÙ… (Ø¹Ø±Ø¶)', 'Ø¨Ù„Ø§ØªÙŠÙ†ÙŠÙˆÙ… (Ø±Ø³Ù…ÙŠ)', 'Ø¨Ù„Ø§ØªÙŠÙ†ÙŠÙˆÙ… (Ø±Ø§Ø¬Ø¹)',
                        'Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ (Ø§Ù„Ø±Ø§Ø¬Ø¹)'
                    ];
                    totalColumns = 19;
                } else if (analyzedOfferType === 'twoMonths') {
                    worksheetTitle = 'Ù…Ø®ÙØ¶ Ø´Ù‡Ø±ÙŠÙ†';
                    reportTitle = 'ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø®ÙØ¶ Ù„Ø´Ù‡Ø±ÙŠÙ†';
                    headers = [
                        'Ø§Ø³Ù… Ø§Ù„ÙˆÙƒÙŠÙ„',
                        'Ù†Ø³Ø¨Ø© Ø§Ù„ÙˆÙƒÙŠÙ„',
                        'Ø¨Ø±ÙˆÙ†Ø² (Ø¹Ø¯Ø¯)', 'Ø¨Ø±ÙˆÙ†Ø² (Ø¹Ø±Ø¶)', 'Ø¨Ø±ÙˆÙ†Ø² (Ø±Ø³Ù…ÙŠ)', 'Ø¨Ø±ÙˆÙ†Ø² (Ø±Ø§Ø¬Ø¹)',
                        'Ø³Ù„ÙØ± (Ø¹Ø¯Ø¯)', 'Ø³Ù„ÙØ± (Ø¹Ø±Ø¶)', 'Ø³Ù„ÙØ± (Ø±Ø³Ù…ÙŠ)', 'Ø³Ù„ÙØ± (Ø±Ø§Ø¬Ø¹)',
                        'Ø°Ù‡Ø¨ÙŠ (Ø¹Ø¯Ø¯)', 'Ø°Ù‡Ø¨ÙŠ (Ø¹Ø±Ø¶)', 'Ø°Ù‡Ø¨ÙŠ (Ø±Ø³Ù…ÙŠ)', 'Ø°Ù‡Ø¨ÙŠ (Ø±Ø§Ø¬Ø¹)',
                        'Ø¨Ù„Ø§ØªÙŠÙ†ÙŠÙˆÙ… (Ø¹Ø¯Ø¯)', 'Ø¨Ù„Ø§ØªÙŠÙ†ÙŠÙˆÙ… (Ø¹Ø±Ø¶)', 'Ø¨Ù„Ø§ØªÙŠÙ†ÙŠÙˆÙ… (Ø±Ø³Ù…ÙŠ)', 'Ø¨Ù„Ø§ØªÙŠÙ†ÙŠÙˆÙ… (Ø±Ø§Ø¬Ø¹)',
                        'Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ (Ø§Ù„Ø±Ø§Ø¬Ø¹)'
                    ];
                    totalColumns = 19;
                }
                
                const worksheet = workbook.addWorksheet(worksheetTitle);
                
                const titleRow = worksheet.getRow(1);
                titleRow.getCell(1).value = reportTitle;
                titleRow.getCell(1).font = { bold: true, size: 18, color: { argb: 'FF801C32' } };
                titleRow.getCell(1).alignment = { horizontal: 'center', vertical: 'middle' };
                worksheet.mergeCells(1, 1, 1, totalColumns);
                titleRow.height = 35;
                
                let monthYear = null;
                if (analyzedOfferType === 'basic') {
                    monthYear = extractMonthYearFromDetails(basicDetails) || extractMonthYearFromData(basicData);
                } else if (analyzedOfferType === 'advanced') {
                    monthYear = extractMonthYearFromDetails(advancedDetails) || extractMonthYearFromData(advancedData);
                } else if (analyzedOfferType === 'twoMonths') {
                    monthYear = extractMonthYearFromDetails(twoMonthsDetails) || extractMonthYearFromData(twoMonthsData);
                }
                
                let monthInfo = '';
                if (monthYear) {
                    const [year, month] = monthYear.split('-');
                    const monthIndex = parseInt(month) - 1;
                    if (monthIndex >= 0 && monthIndex < arabicMonths.length) {
                        monthInfo = ` Ù„Ø´Ù‡Ø±: ${arabicMonths[monthIndex]} ${year}`;
                    }
                }
                
                const monthRow = worksheet.getRow(2);
                if (monthInfo) {
                    monthRow.getCell(1).value = monthInfo;
                    monthRow.getCell(1).font = { bold: true, size: 14, color: { argb: 'FF801C32' } };
                    monthRow.getCell(1).alignment = { horizontal: 'center', vertical: 'middle' };
                    worksheet.mergeCells(2, 1, 2, totalColumns);
                    monthRow.height = 30;
                }
                
                const dateRow = worksheet.getRow(monthInfo ? 3 : 2);
                const now = new Date();
                const dateStr = `${now.getDate()}/${now.getMonth() + 1}/${now.getFullYear()} ${now.getHours()}:${String(now.getMinutes()).padStart(2, '0')}`;
                dateRow.getCell(1).value = `ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ‚Ø±ÙŠØ±: ${dateStr}`;
                dateRow.getCell(1).font = { size: 12, color: { argb: 'FF666666' } };
                dateRow.getCell(1).alignment = { horizontal: 'center' };
                worksheet.mergeCells(monthInfo ? 3 : 2, 1, monthInfo ? 3 : 2, totalColumns);
                dateRow.height = 25;
                
                let currentRow = monthInfo ? 5 : 4;
                
                const headerRow = worksheet.getRow(currentRow);
                headers.forEach((header, idx) => {
                    const cell = headerRow.getCell(idx + 1);
                    cell.value = header;
                    cell.font = { bold: true, size: 12, color: { argb: 'FFFFFFFF' } };
                    cell.fill = {
                        type: 'pattern',
                        pattern: 'solid',
                        fgColor: { argb: 'FF801C32' }
                    };
                    cell.alignment = { horizontal: 'center', vertical: 'middle', wrapText: true };
                    cell.border = {
                        top: { style: 'thin', color: { argb: 'FFFFFFFF' } },
                        bottom: { style: 'thin', color: { argb: 'FFFFFFFF' } },
                        left: { style: 'thin', color: { argb: 'FFFFFFFF' } },
                        right: { style: 'thin', color: { argb: 'FFFFFFFF' } }
                    };
                });
                headerRow.height = 40;
                
                const sortedAgents = Object.entries(agentReports).sort((a, b) => {
                    let totalA = 0, totalB = 0;
                    if (analyzedOfferType === 'basic') {
                        totalA = (a[1].basic?.total?.amount || 0);
                        totalB = (b[1].basic?.total?.amount || 0);
                    } else if (analyzedOfferType === 'advanced') {
                        totalA = (a[1].advanced?.total?.profit || 0);
                        totalB = (b[1].advanced?.total?.profit || 0);
                    } else if (analyzedOfferType === 'twoMonths') {
                        totalA = (a[1].twoMonths?.total?.profit || 0);
                        totalB = (b[1].twoMonths?.total?.profit || 0);
                    }
                    return totalB - totalA;
                });
                
                let grandTotal = 0;
                let grandTotalBronzeCount = 0, grandTotalSilverCount = 0, grandTotalGoldCount = 0, grandTotalPlatinumCount = 0;
                let grandTotalBronzeAmount = 0, grandTotalSilverAmount = 0, grandTotalGoldAmount = 0, grandTotalPlatinumAmount = 0;
                
                sortedAgents.forEach(([agentName, report], index) => {
                    let hasData = false;
                    if (analyzedOfferType === 'basic' && report.basic && report.basic.total && report.basic.total.count > 0) {
                        hasData = true;
                    } else if (analyzedOfferType === 'advanced' && report.advanced && report.advanced.total && report.advanced.total.count > 0) {
                        hasData = true;
                    } else if (analyzedOfferType === 'twoMonths' && report.twoMonths && report.twoMonths.total && report.twoMonths.total.count > 0) {
                        hasData = true;
                    }
                    
                    if (!hasData) return;
                    
                    currentRow++;
                    const dataRow = worksheet.getRow(currentRow);
                    let col = 1;
                    
                    const agent = agentsList.find(a => a.name === agentName);
                    const agentSubName = agent?.subName || '';
                    const agentPercentage = agent?.percentage || 0;
                    
                    const agentNameCell = dataRow.getCell(col++);
                    if (agentSubName) {
                        agentNameCell.value = `${agentName}\n${agentSubName}`;
                    } else {
                        agentNameCell.value = agentName;
                    }
                    agentNameCell.alignment = { horizontal: 'center', vertical: 'middle', wrapText: true };
                    
                    const percentageCell = dataRow.getCell(col++);
                    percentageCell.value = agentPercentage;
                    if (agentPercentage > 0) {
                        percentageCell.numFmt = '0.00"%"';
                    }
                    
                    if (analyzedOfferType === 'basic') {
                    const basic = report.basic || {};
                    const basicBronze = basic.bronze || { count: 0, amount: 0 };
                    const basicSilver = basic.silver || { count: 0, amount: 0 };
                    const basicGold = basic.gold || { count: 0, amount: 0 };
                    const basicPlatinum = basic.platinum || { count: 0, amount: 0 };
                    const basicTotal = basic.total || { count: 0, amount: 0 };
                    
                    dataRow.getCell(col++).value = basicBronze.count || 0;
                    dataRow.getCell(col++).value = basicBronze.amount || 0;
                    dataRow.getCell(col++).value = basicSilver.count || 0;
                    dataRow.getCell(col++).value = basicSilver.amount || 0;
                    dataRow.getCell(col++).value = basicGold.count || 0;
                    dataRow.getCell(col++).value = basicGold.amount || 0;
                    dataRow.getCell(col++).value = basicPlatinum.count || 0;
                    dataRow.getCell(col++).value = basicPlatinum.amount || 0;
                    dataRow.getCell(col++).value = basicTotal.amount || 0;
                        
                        grandTotal += basicTotal.amount || 0;
                        grandTotalBronzeCount += basicBronze.count || 0;
                        grandTotalSilverCount += basicSilver.count || 0;
                        grandTotalGoldCount += basicGold.count || 0;
                        grandTotalPlatinumCount += basicPlatinum.count || 0;
                        grandTotalBronzeAmount += basicBronze.amount || 0;
                        grandTotalSilverAmount += basicSilver.amount || 0;
                        grandTotalGoldAmount += basicGold.amount || 0;
                        grandTotalPlatinumAmount += basicPlatinum.amount || 0;
                    } else if (analyzedOfferType === 'advanced') {
                    const advanced = report.advanced || {};
                    const advBronze = advanced.bronze || { count: 0, promoAmount: 0, officialAmount: 0 };
                    const advSilver = advanced.silver || { count: 0, promoAmount: 0, officialAmount: 0 };
                    const advGold = advanced.gold || { count: 0, promoAmount: 0, officialAmount: 0 };
                    const advPlatinum = advanced.platinum || { count: 0, promoAmount: 0, officialAmount: 0 };
                    const advTotal = advanced.total || { count: 0, profit: 0, promoAmount: 0, officialAmount: 0 };
                    
                    dataRow.getCell(col++).value = advBronze.count || 0;
                    dataRow.getCell(col++).value = advBronze.promoAmount || 0;
                    dataRow.getCell(col++).value = advBronze.officialAmount || 0;
                    dataRow.getCell(col++).value = (advBronze.officialAmount || 0) - (advBronze.promoAmount || 0);
                    dataRow.getCell(col++).value = advSilver.count || 0;
                    dataRow.getCell(col++).value = advSilver.promoAmount || 0;
                    dataRow.getCell(col++).value = advSilver.officialAmount || 0;
                    dataRow.getCell(col++).value = (advSilver.officialAmount || 0) - (advSilver.promoAmount || 0);
                    dataRow.getCell(col++).value = advGold.count || 0;
                    dataRow.getCell(col++).value = advGold.promoAmount || 0;
                    dataRow.getCell(col++).value = advGold.officialAmount || 0;
                    dataRow.getCell(col++).value = (advGold.officialAmount || 0) - (advGold.promoAmount || 0);
                    dataRow.getCell(col++).value = advPlatinum.count || 0;
                    dataRow.getCell(col++).value = advPlatinum.promoAmount || 0;
                    dataRow.getCell(col++).value = advPlatinum.officialAmount || 0;
                    dataRow.getCell(col++).value = (advPlatinum.officialAmount || 0) - (advPlatinum.promoAmount || 0);
                    dataRow.getCell(col++).value = advTotal.profit || 0;
                        
                        grandTotal += advTotal.profit || 0;
                        grandTotalBronzeCount += advBronze.count || 0;
                        grandTotalSilverCount += advSilver.count || 0;
                        grandTotalGoldCount += advGold.count || 0;
                        grandTotalPlatinumCount += advPlatinum.count || 0;
                    } else if (analyzedOfferType === 'twoMonths') {
                    const twoMonths = report.twoMonths || {};
                    const tmBronze = twoMonths.bronze || { count: 0, promoAmount: 0, officialAmount: 0 };
                    const tmSilver = twoMonths.silver || { count: 0, promoAmount: 0, officialAmount: 0 };
                    const tmGold = twoMonths.gold || { count: 0, promoAmount: 0, officialAmount: 0 };
                    const tmPlatinum = twoMonths.platinum || { count: 0, promoAmount: 0, officialAmount: 0 };
                    const tmTotal = twoMonths.total || { count: 0, profit: 0, promoAmount: 0, officialAmount: 0 };
                    
                    dataRow.getCell(col++).value = tmBronze.count || 0;
                    dataRow.getCell(col++).value = tmBronze.promoAmount || 0;
                    dataRow.getCell(col++).value = tmBronze.officialAmount || 0;
                    dataRow.getCell(col++).value = (tmBronze.officialAmount || 0) - (tmBronze.promoAmount || 0);
                    dataRow.getCell(col++).value = tmSilver.count || 0;
                    dataRow.getCell(col++).value = tmSilver.promoAmount || 0;
                    dataRow.getCell(col++).value = tmSilver.officialAmount || 0;
                    dataRow.getCell(col++).value = (tmSilver.officialAmount || 0) - (tmSilver.promoAmount || 0);
                    dataRow.getCell(col++).value = tmGold.count || 0;
                    dataRow.getCell(col++).value = tmGold.promoAmount || 0;
                    dataRow.getCell(col++).value = tmGold.officialAmount || 0;
                    dataRow.getCell(col++).value = (tmGold.officialAmount || 0) - (tmGold.promoAmount || 0);
                    dataRow.getCell(col++).value = tmPlatinum.count || 0;
                    dataRow.getCell(col++).value = tmPlatinum.promoAmount || 0;
                    dataRow.getCell(col++).value = tmPlatinum.officialAmount || 0;
                    dataRow.getCell(col++).value = (tmPlatinum.officialAmount || 0) - (tmPlatinum.promoAmount || 0);
                    dataRow.getCell(col++).value = tmTotal.profit || 0;
                        
                        grandTotal += tmTotal.profit || 0;
                        grandTotalBronzeCount += tmBronze.count || 0;
                        grandTotalSilverCount += tmSilver.count || 0;
                        grandTotalGoldCount += tmGold.count || 0;
                        grandTotalPlatinumCount += tmPlatinum.count || 0;
                    }
                    
                    const isEven = index % 2 === 0;
                    const bgColor = isEven ? 'FFFFFFFF' : 'FFF8F9FA';
                    for (let c = 1; c <= headers.length; c++) {
                        const cell = dataRow.getCell(c);
                        cell.fill = {
                            type: 'pattern',
                            pattern: 'solid',
                            fgColor: { argb: bgColor }
                        };
                        cell.font = { size: 12 };
                        cell.alignment = { horizontal: 'center', vertical: 'middle' };
                        cell.border = {
                            top: { style: 'thin', color: { argb: 'FFDDDDDD' } },
                            bottom: { style: 'thin', color: { argb: 'FFDDDDDD' } },
                            left: { style: 'thin', color: { argb: 'FFDDDDDD' } },
                            right: { style: 'thin', color: { argb: 'FFDDDDDD' } }
                        };
                        if (c > 1 && cell.value !== null && typeof cell.value === 'number') {
                            cell.numFmt = '#,##0';
                        }
                    }
                    dataRow.height = 25;
                });
                
                currentRow++;
                const totalRow = worksheet.getRow(currentRow);
                totalRow.getCell(1).value = 'Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ„ÙŠ';
                    totalRow.getCell(1).font = { bold: true, size: 14, color: { argb: 'FF801C32' } };
                
                if (analyzedOfferType === 'basic') {
                    totalRow.getCell(2).value = '';
                    totalRow.getCell(3).value = grandTotalBronzeCount;
                    totalRow.getCell(4).value = grandTotalBronzeAmount;
                    totalRow.getCell(5).value = grandTotalSilverCount;
                    totalRow.getCell(6).value = grandTotalSilverAmount;
                    totalRow.getCell(7).value = grandTotalGoldCount;
                    totalRow.getCell(8).value = grandTotalGoldAmount;
                    totalRow.getCell(9).value = grandTotalPlatinumCount;
                    totalRow.getCell(10).value = grandTotalPlatinumAmount;
                    totalRow.getCell(11).value = grandTotal;
                } else if (analyzedOfferType === 'advanced' || analyzedOfferType === 'twoMonths') {
                    totalRow.getCell(2).value = '';
                    totalRow.getCell(3).value = grandTotalBronzeCount;
                    totalRow.getCell(4).value = 0; 
                    totalRow.getCell(5).value = 0; 
                    totalRow.getCell(6).value = 0; 
                    totalRow.getCell(7).value = grandTotalSilverCount;
                    totalRow.getCell(8).value = 0;
                    totalRow.getCell(9).value = 0;
                    totalRow.getCell(10).value = 0;
                    totalRow.getCell(11).value = grandTotalGoldCount;
                    totalRow.getCell(12).value = 0;
                    totalRow.getCell(13).value = 0;
                    totalRow.getCell(14).value = 0;
                    totalRow.getCell(15).value = grandTotalPlatinumCount;
                    totalRow.getCell(16).value = 0;
                    totalRow.getCell(17).value = 0;
                    totalRow.getCell(18).value = 0;
                    totalRow.getCell(19).value = grandTotal;
                }
                
                for (let c = 1; c <= headers.length; c++) {
                    const cell = totalRow.getCell(c);
                    cell.fill = {
                        type: 'pattern',
                        pattern: 'solid',
                        fgColor: { argb: 'FFE8F0F5' }
                    };
                    cell.font = { bold: true, size: 12, color: { argb: 'FF801C32' } };
                    cell.alignment = { horizontal: 'center', vertical: 'middle' };
                    cell.border = {
                        top: { style: 'medium', color: { argb: 'FF801C32' } },
                        bottom: { style: 'medium', color: { argb: 'FF801C32' } },
                        left: { style: 'thin', color: { argb: 'FF801C32' } },
                        right: { style: 'thin', color: { argb: 'FF801C32' } }
                    };
                    if (c > 1 && cell.value !== null && typeof cell.value === 'number') {
                        cell.numFmt = '#,##0';
                    }
                }
                totalRow.height = 30;
                
                worksheet.columns.forEach((column, index) => {
                    if (index === 0) {
                        column.width = 25;
                    } else {
                        column.width = 12;
                    }
                });
                
                workbook.xlsx.writeBuffer().then(buffer => {
                    const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    const offerName = analyzedOfferType === 'basic' ? 'Ø§Ù„Ø¹Ø±Ø¶_Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠ' : 
                                     analyzedOfferType === 'advanced' ? 'Ù…Ø®ÙØ¶_3_Ø£Ø´Ù‡Ø±' : 'Ù…Ø®ÙØ¶_Ø´Ù‡Ø±ÙŠÙ†';
                    link.download = `ØªÙ‚Ø±ÙŠØ±_${offerName}_${formatDateForFilename(new Date())}.xlsx`;
                    link.click();
                    URL.revokeObjectURL(url);
                    const offerNameAr = analyzedOfferType === 'basic' ? 'Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠ' : 
                                       analyzedOfferType === 'advanced' ? 'Ù…Ø®ÙØ¶ 3 Ø£Ø´Ù‡Ø±' : 'Ù…Ø®ÙØ¶ Ø´Ù‡Ø±ÙŠÙ†';
                    showSuccessMessage(`ØªÙ… ØªØµØ¯ÙŠØ± ØªÙ‚Ø±ÙŠØ± ${offerNameAr} Ù„Ù€ ${sortedAgents.filter(([_, r]) => {
                        if (analyzedOfferType === 'basic') return r.basic?.total?.count > 0;
                        if (analyzedOfferType === 'advanced') return r.advanced?.total?.count > 0;
                        return r.twoMonths?.total?.count > 0;
                    }).length} ÙˆÙƒÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­!`);
                });
            } catch (error) {
                console.error('Error exporting with ExcelJS, trying XLSX:', error);
                exportSummaryToExcelXLSX(analyzedOfferType);
            }
        }
        
        function exportSummaryToExcelXLSX(analyzedOfferType = null) {
            if (!analyzedOfferType) {
                let hasBasic = false, hasAdvanced = false, hasTwoMonths = false;
                Object.values(agentReports).forEach(report => {
                    if (report.basic && report.basic.total && report.basic.total.count > 0) hasBasic = true;
                    if (report.advanced && report.advanced.total && report.advanced.total.count > 0) hasAdvanced = true;
                    if (report.twoMonths && report.twoMonths.total && report.twoMonths.total.count > 0) hasTwoMonths = true;
                });
                if (hasBasic) analyzedOfferType = 'basic';
                else if (hasAdvanced) analyzedOfferType = 'advanced';
                else if (hasTwoMonths) analyzedOfferType = 'twoMonths';
                else {
                    alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„Ù„Ø© Ù„Ù„ØªØµØ¯ÙŠØ±.');
                    return;
                }
            }
            
            try {
                const wb = XLSX.utils.book_new();
                const agentData = [];
                const sortedAgents = Object.entries(agentReports).sort((a, b) => {
                    let totalA = 0, totalB = 0;
                    if (analyzedOfferType === 'basic') {
                        totalA = (a[1].basic?.total?.amount || 0);
                        totalB = (b[1].basic?.total?.amount || 0);
                    } else if (analyzedOfferType === 'advanced') {
                        totalA = (a[1].advanced?.total?.profit || 0);
                        totalB = (b[1].advanced?.total?.profit || 0);
                    } else if (analyzedOfferType === 'twoMonths') {
                        totalA = (a[1].twoMonths?.total?.profit || 0);
                        totalB = (b[1].twoMonths?.total?.profit || 0);
                    }
                    return totalB - totalA;
                });
                
                sortedAgents.forEach(([agentName, report]) => {
                    const agent = agentsList.find(a => a.name === agentName);
                    const agentSubName = agent?.subName || '';
                    const agentPercentage = agent?.percentage || 0;
                    
                    let rowData = { 
                        'Ø§Ø³Ù… Ø§Ù„ÙˆÙƒÙŠÙ„': agentSubName ? `${agentName}\n${agentSubName}` : agentName,
                        'Ù†Ø³Ø¨Ø© Ø§Ù„ÙˆÙƒÙŠÙ„': agentPercentage
                    };
                    
                    if (analyzedOfferType === 'basic') {
                    const basic = report.basic || {};
                        rowData['Ø¨Ø±ÙˆÙ†Ø² (Ø¹Ø¯Ø¯)'] = basic.bronze?.count || 0;
                        rowData['Ø¨Ø±ÙˆÙ†Ø² (Ù…Ø¨Ù„Øº)'] = basic.bronze?.amount || 0;
                        rowData['Ø³Ù„ÙØ± (Ø¹Ø¯Ø¯)'] = basic.silver?.count || 0;
                        rowData['Ø³Ù„ÙØ± (Ù…Ø¨Ù„Øº)'] = basic.silver?.amount || 0;
                        rowData['Ø°Ù‡Ø¨ÙŠ (Ø¹Ø¯Ø¯)'] = basic.gold?.count || 0;
                        rowData['Ø°Ù‡Ø¨ÙŠ (Ù…Ø¨Ù„Øº)'] = basic.gold?.amount || 0;
                        rowData['Ø¨Ù„Ø§ØªÙŠÙ†ÙŠÙˆÙ… (Ø¹Ø¯Ø¯)'] = basic.platinum?.count || 0;
                        rowData['Ø¨Ù„Ø§ØªÙŠÙ†ÙŠÙˆÙ… (Ù…Ø¨Ù„Øº)'] = basic.platinum?.amount || 0;
                        rowData['Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ'] = basic.total?.amount || 0;
                        if ((basic.total?.count || 0) > 0) agentData.push(rowData);
                    } else if (analyzedOfferType === 'advanced') {
                    const advanced = report.advanced || {};
                        rowData['Ø¨Ø±ÙˆÙ†Ø² (Ø¹Ø¯Ø¯)'] = advanced.bronze?.count || 0;
                        rowData['Ø¨Ø±ÙˆÙ†Ø² (Ø¹Ø±Ø¶)'] = advanced.bronze?.promoAmount || 0;
                        rowData['Ø¨Ø±ÙˆÙ†Ø² (Ø±Ø³Ù…ÙŠ)'] = advanced.bronze?.officialAmount || 0;
                        rowData['Ø¨Ø±ÙˆÙ†Ø² (Ø±Ø§Ø¬Ø¹)'] = (advanced.bronze?.officialAmount || 0) - (advanced.bronze?.promoAmount || 0);
                        rowData['Ø³Ù„ÙØ± (Ø¹Ø¯Ø¯)'] = advanced.silver?.count || 0;
                        rowData['Ø³Ù„ÙØ± (Ø¹Ø±Ø¶)'] = advanced.silver?.promoAmount || 0;
                        rowData['Ø³Ù„ÙØ± (Ø±Ø³Ù…ÙŠ)'] = advanced.silver?.officialAmount || 0;
                        rowData['Ø³Ù„ÙØ± (Ø±Ø§Ø¬Ø¹)'] = (advanced.silver?.officialAmount || 0) - (advanced.silver?.promoAmount || 0);
                        rowData['Ø°Ù‡Ø¨ÙŠ (Ø¹Ø¯Ø¯)'] = advanced.gold?.count || 0;
                        rowData['Ø°Ù‡Ø¨ÙŠ (Ø¹Ø±Ø¶)'] = advanced.gold?.promoAmount || 0;
                        rowData['Ø°Ù‡Ø¨ÙŠ (Ø±Ø³Ù…ÙŠ)'] = advanced.gold?.officialAmount || 0;
                        rowData['Ø°Ù‡Ø¨ÙŠ (Ø±Ø§Ø¬Ø¹)'] = (advanced.gold?.officialAmount || 0) - (advanced.gold?.promoAmount || 0);
                        rowData['Ø¨Ù„Ø§ØªÙŠÙ†ÙŠÙˆÙ… (Ø¹Ø¯Ø¯)'] = advanced.platinum?.count || 0;
                        rowData['Ø¨Ù„Ø§ØªÙŠÙ†ÙŠÙˆÙ… (Ø¹Ø±Ø¶)'] = advanced.platinum?.promoAmount || 0;
                        rowData['Ø¨Ù„Ø§ØªÙŠÙ†ÙŠÙˆÙ… (Ø±Ø³Ù…ÙŠ)'] = advanced.platinum?.officialAmount || 0;
                        rowData['Ø¨Ù„Ø§ØªÙŠÙ†ÙŠÙˆÙ… (Ø±Ø§Ø¬Ø¹)'] = (advanced.platinum?.officialAmount || 0) - (advanced.platinum?.promoAmount || 0);
                        rowData['Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ (Ø§Ù„Ø±Ø§Ø¬Ø¹)'] = advanced.total?.profit || 0;
                        if ((advanced.total?.count || 0) > 0) agentData.push(rowData);
                    } else if (analyzedOfferType === 'twoMonths') {
                    const twoMonths = report.twoMonths || {};
                        rowData['Ø¨Ø±ÙˆÙ†Ø² (Ø¹Ø¯Ø¯)'] = twoMonths.bronze?.count || 0;
                        rowData['Ø¨Ø±ÙˆÙ†Ø² (Ø¹Ø±Ø¶)'] = twoMonths.bronze?.promoAmount || 0;
                        rowData['Ø¨Ø±ÙˆÙ†Ø² (Ø±Ø³Ù…ÙŠ)'] = twoMonths.bronze?.officialAmount || 0;
                        rowData['Ø¨Ø±ÙˆÙ†Ø² (Ø±Ø§Ø¬Ø¹)'] = (twoMonths.bronze?.officialAmount || 0) - (twoMonths.bronze?.promoAmount || 0);
                        rowData['Ø³Ù„ÙØ± (Ø¹Ø¯Ø¯)'] = twoMonths.silver?.count || 0;
                        rowData['Ø³Ù„ÙØ± (Ø¹Ø±Ø¶)'] = twoMonths.silver?.promoAmount || 0;
                        rowData['Ø³Ù„ÙØ± (Ø±Ø³Ù…ÙŠ)'] = twoMonths.silver?.officialAmount || 0;
                        rowData['Ø³Ù„ÙØ± (Ø±Ø§Ø¬Ø¹)'] = (twoMonths.silver?.officialAmount || 0) - (twoMonths.silver?.promoAmount || 0);
                        rowData['Ø°Ù‡Ø¨ÙŠ (Ø¹Ø¯Ø¯)'] = twoMonths.gold?.count || 0;
                        rowData['Ø°Ù‡Ø¨ÙŠ (Ø¹Ø±Ø¶)'] = twoMonths.gold?.promoAmount || 0;
                        rowData['Ø°Ù‡Ø¨ÙŠ (Ø±Ø³Ù…ÙŠ)'] = twoMonths.gold?.officialAmount || 0;
                        rowData['Ø°Ù‡Ø¨ÙŠ (Ø±Ø§Ø¬Ø¹)'] = (twoMonths.gold?.officialAmount || 0) - (twoMonths.gold?.promoAmount || 0);
                        rowData['Ø¨Ù„Ø§ØªÙŠÙ†ÙŠÙˆÙ… (Ø¹Ø¯Ø¯)'] = twoMonths.platinum?.count || 0;
                        rowData['Ø¨Ù„Ø§ØªÙŠÙ†ÙŠÙˆÙ… (Ø¹Ø±Ø¶)'] = twoMonths.platinum?.promoAmount || 0;
                        rowData['Ø¨Ù„Ø§ØªÙŠÙ†ÙŠÙˆÙ… (Ø±Ø³Ù…ÙŠ)'] = twoMonths.platinum?.officialAmount || 0;
                        rowData['Ø¨Ù„Ø§ØªÙŠÙ†ÙŠÙˆÙ… (Ø±Ø§Ø¬Ø¹)'] = (twoMonths.platinum?.officialAmount || 0) - (twoMonths.platinum?.promoAmount || 0);
                        rowData['Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ (Ø§Ù„Ø±Ø§Ø¬Ø¹)'] = twoMonths.total?.profit || 0;
                        if ((twoMonths.total?.count || 0) > 0) agentData.push(rowData);
                    }
                });
                
                if (agentData.length === 0) {
                    alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±.');
                    return;
                }
                
                let monthYear = null;
                if (analyzedOfferType === 'basic') {
                    monthYear = extractMonthYearFromDetails(basicDetails) || extractMonthYearFromData(basicData);
                } else if (analyzedOfferType === 'advanced') {
                    monthYear = extractMonthYearFromDetails(advancedDetails) || extractMonthYearFromData(advancedData);
                } else if (analyzedOfferType === 'twoMonths') {
                    monthYear = extractMonthYearFromDetails(twoMonthsDetails) || extractMonthYearFromData(twoMonthsData);
                }
                
                let monthInfo = '';
                if (monthYear) {
                    const [year, month] = monthYear.split('-');
                    const monthIndex = parseInt(month) - 1;
                    if (monthIndex >= 0 && monthIndex < arabicMonths.length) {
                        monthInfo = `Ù„Ø´Ù‡Ø±  : ${arabicMonths[monthIndex]} ${year}`;
                    }
                }
                
                const wsData = [];
                const reportTitle = analyzedOfferType === 'basic' ? 'ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠ' :
                                   analyzedOfferType === 'advanced' ? 'ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø®ÙØ¶ Ù„Ø«Ù„Ø§Ø«Ø© Ø£Ø´Ù‡Ø±' :
                                   'ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø®ÙØ¶ Ù„Ø´Ù‡Ø±ÙŠÙ†';
                wsData.push([reportTitle]);
                if (monthInfo) {
                    wsData.push([monthInfo]);
                }
                const now = new Date();
                const dateStr = `${now.getDate()}/${now.getMonth() + 1}/${now.getFullYear()} ${now.getHours()}:${String(now.getMinutes()).padStart(2, '0')}`;
                wsData.push([`ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ‚Ø±ÙŠØ±: ${dateStr}`]);
                wsData.push([]);
                
                const headers = [];
                if (analyzedOfferType === 'basic') {
                    headers.push('Ø§Ø³Ù… Ø§Ù„ÙˆÙƒÙŠÙ„', 'Ù†Ø³Ø¨Ø© Ø§Ù„ÙˆÙƒÙŠÙ„', 'Ø¨Ø±ÙˆÙ†Ø² (Ø¹Ø¯Ø¯)', 'Ø¨Ø±ÙˆÙ†Ø² (Ù…Ø¨Ù„Øº)', 'Ø³Ù„ÙØ± (Ø¹Ø¯Ø¯)', 'Ø³Ù„ÙØ± (Ù…Ø¨Ù„Øº)', 
                                'Ø°Ù‡Ø¨ÙŠ (Ø¹Ø¯Ø¯)', 'Ø°Ù‡Ø¨ÙŠ (Ù…Ø¨Ù„Øº)', 'Ø¨Ù„Ø§ØªÙŠÙ†ÙŠÙˆÙ… (Ø¹Ø¯Ø¯)', 'Ø¨Ù„Ø§ØªÙŠÙ†ÙŠÙˆÙ… (Ù…Ø¨Ù„Øº)', 'Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ');
                } else {
                    headers.push('Ø§Ø³Ù… Ø§Ù„ÙˆÙƒÙŠÙ„', 'Ù†Ø³Ø¨Ø© Ø§Ù„ÙˆÙƒÙŠÙ„', 'Ø¨Ø±ÙˆÙ†Ø² (Ø¹Ø¯Ø¯)', 'Ø¨Ø±ÙˆÙ†Ø² (Ø¹Ø±Ø¶)', 'Ø¨Ø±ÙˆÙ†Ø² (Ø±Ø³Ù…ÙŠ)', 'Ø¨Ø±ÙˆÙ†Ø² (Ø±Ø§Ø¬Ø¹)',
                                'Ø³Ù„ÙØ± (Ø¹Ø¯Ø¯)', 'Ø³Ù„ÙØ± (Ø¹Ø±Ø¶)', 'Ø³Ù„ÙØ± (Ø±Ø³Ù…ÙŠ)', 'Ø³Ù„ÙØ± (Ø±Ø§Ø¬Ø¹)',
                                'Ø°Ù‡Ø¨ÙŠ (Ø¹Ø¯Ø¯)', 'Ø°Ù‡Ø¨ÙŠ (Ø¹Ø±Ø¶)', 'Ø°Ù‡Ø¨ÙŠ (Ø±Ø³Ù…ÙŠ)', 'Ø°Ù‡Ø¨ÙŠ (Ø±Ø§Ø¬Ø¹)',
                                'Ø¨Ù„Ø§ØªÙŠÙ†ÙŠÙˆÙ… (Ø¹Ø¯Ø¯)', 'Ø¨Ù„Ø§ØªÙŠÙ†ÙŠÙˆÙ… (Ø¹Ø±Ø¶)', 'Ø¨Ù„Ø§ØªÙŠÙ†ÙŠÙˆÙ… (Ø±Ø³Ù…ÙŠ)', 'Ø¨Ù„Ø§ØªÙŠÙ†ÙŠÙˆÙ… (Ø±Ø§Ø¬Ø¹)', 'Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ (Ø§Ù„Ø±Ø§Ø¬Ø¹)');
                }
                wsData.push(headers);
                
                agentData.forEach(row => {
                    const rowData = [];
                    headers.forEach(header => {
                        rowData.push(row[header] || '');
                    });
                    wsData.push(rowData);
                });
                
                const ws = XLSX.utils.aoa_to_sheet(wsData);
                const colWidths = [{ wch: 30 }, { wch: 12 }];
                if (analyzedOfferType === 'basic') {
                    for (let i = 0; i < 9; i++) colWidths.push({ wch: 15 });
                } else {
                    for (let i = 0; i < 17; i++) colWidths.push({ wch: 15 });
                }
                ws['!cols'] = colWidths;
                const sheetName = analyzedOfferType === 'basic' ? 'Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠ' : 
                                 analyzedOfferType === 'advanced' ? 'Ù…Ø®ÙØ¶ 3 Ø£Ø´Ù‡Ø±' : 'Ù…Ø®ÙØ¶ Ø´Ù‡Ø±ÙŠÙ†';
                XLSX.utils.book_append_sheet(wb, ws, sheetName);
                const offerName = analyzedOfferType === 'basic' ? 'Ø§Ù„Ø¹Ø±Ø¶_Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠ' : 
                                 analyzedOfferType === 'advanced' ? 'Ù…Ø®ÙØ¶_3_Ø£Ø´Ù‡Ø±' : 'Ù…Ø®ÙØ¶_Ø´Ù‡Ø±ÙŠÙ†';
                const filename = `ØªÙ‚Ø±ÙŠØ±_${offerName}_${formatDateForFilename(new Date())}.xlsx`;
                XLSX.writeFile(wb, filename);
                const offerNameAr = analyzedOfferType === 'basic' ? 'Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠ' : 
                                   analyzedOfferType === 'advanced' ? 'Ù…Ø®ÙØ¶ 3 Ø£Ø´Ù‡Ø±' : 'Ù…Ø®ÙØ¶ Ø´Ù‡Ø±ÙŠÙ†';
                showSuccessMessage(`ØªÙ… ØªØµØ¯ÙŠØ± ØªÙ‚Ø±ÙŠØ± ${offerNameAr} Ù„Ù€ ${agentData.length} ÙˆÙƒÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­!`);
            } catch (error) {
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØµØ¯ÙŠØ±: ' + error.message);
                console.error('Export error:', error);
            }
        }
        function printSummaryReport() {
            if (!agentReports || Object.keys(agentReports).length === 0) {
                alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©. ÙŠØ±Ø¬Ù‰ ØªØ­Ù„ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆÙƒÙ„Ø§Ø¡ Ø£ÙˆÙ„Ø§Ù‹.');
                return;
            }
            updateAgentSummary();
            window.print();
        }
        async function clearAgentReports(agentName) {
            if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ÙˆÙƒÙŠÙ„ "${agentName}"ØŸ\n\nØ³ÙŠØªÙ… Ø­Ø°Ù:\n- ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠ\n- ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø®ÙØ¶ 3 Ø£Ø´Ù‡Ø±\n- ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø®ÙØ¶ Ø´Ù‡Ø±ÙŠÙ†\n- Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©\n\nÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¬Ø±Ø§Ø¡ ØªØ­Ù„ÙŠÙ„Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø­Ø°Ù.`)) {
                return;
            }
            if (agentReports[agentName]) {
                delete agentReports[agentName];
            }
            if (agentPercentages[agentName]) {
                delete agentPercentages[agentName];
                localStorage.setItem('agentPercentages', JSON.stringify(agentPercentages));
                if (supabaseClient) {
                    try {
                        const monthYear = localStorage.getItem('agentPercentages_monthYear') || getCurrentMonthYear();
                        await saveToDatabase('agent_percentages', agentPercentages, { monthYear: monthYear });
                    } catch (error) {
                        console.error('Error deleting agent percentage:', error);
                    }
                }
            }
            if (supabaseClient) {
                try {
                    const monthYear = getCurrentMonthYear();
                    const { data: basicArchive } = await supabaseClient
                        .from('analysis_archives')
                        .select('data')
                        .eq('month_year', monthYear)
                        .eq('analysis_type', 'basic')
                        .maybeSingle();
                    if (basicArchive && basicArchive.data && basicArchive.data.agentReports) {
                        delete basicArchive.data.agentReports[agentName];
                        await saveToDatabase('analysis_archives', basicArchive.data, { analysis_type: 'basic', monthYear: monthYear });
                    }
                    const { data: advancedArchive } = await supabaseClient
                        .from('analysis_archives')
                        .select('data')
                        .eq('month_year', monthYear)
                        .eq('analysis_type', 'advanced')
                        .maybeSingle();
                    if (advancedArchive && advancedArchive.data && advancedArchive.data.agentReports) {
                        delete advancedArchive.data.agentReports[agentName];
                        await saveToDatabase('analysis_archives', advancedArchive.data, { analysis_type: 'advanced', monthYear: monthYear });
                    }
                    const { data: twoMonthsArchive } = await supabaseClient
                        .from('analysis_archives')
                        .select('data')
                        .eq('month_year', monthYear)
                        .eq('analysis_type', 'two_months')
                        .maybeSingle();
                    if (twoMonthsArchive && twoMonthsArchive.data && twoMonthsArchive.data.agentReports) {
                        delete twoMonthsArchive.data.agentReports[agentName];
                        await saveToDatabase('analysis_archives', twoMonthsArchive.data, { analysis_type: 'two_months', monthYear: monthYear });
                    }
                } catch (error) {
                    console.error('Error clearing reports from database:', error);
                }
            }
            refreshAgentsList();
            updateAgentSummary();
            renderPercentageTable();
            showSuccessMessage(`ØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª ÙˆØ¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ø³Ø¨Ø© Ù„Ù„ÙˆÙƒÙŠÙ„ "${agentName}" Ø¨Ù†Ø¬Ø§Ø­`);
            logActivity('Ø­Ø°Ù ØªØ­Ù„ÙŠÙ„Ø§Øª ÙˆÙƒÙŠÙ„', `ØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª ÙˆØ¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ø³Ø¨Ø© Ù„Ù„ÙˆÙƒÙŠÙ„: ${agentName}`);
        }
        async function clearAllAgentReports() {
            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª Ù…Ù† ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø§Ù„Ø¹Ø±ÙˆØ¶ ÙˆØ§Ù„Ù…Ù„Ø®ØµØŸ\n\nØ³ÙŠØªÙ… Ø­Ø°Ù:\n- Ø¬Ù…ÙŠØ¹ ØªØ­Ù„ÙŠÙ„Ø§Øª Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠ\n- Ø¬Ù…ÙŠØ¹ ØªØ­Ù„ÙŠÙ„Ø§Øª Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø®ÙØ¶ 3 Ø£Ø´Ù‡Ø±\n- Ø¬Ù…ÙŠØ¹ ØªØ­Ù„ÙŠÙ„Ø§Øª Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø®ÙØ¶ Ø´Ù‡Ø±ÙŠÙ†\n- Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ø³Ø¨\n\nÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¬Ø±Ø§Ø¡ ØªØ­Ù„ÙŠÙ„Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø­Ø°Ù.')) {
                return;
            }
            
            agentReports = {};
            basicData = null;
            advancedData = null;
            twoMonthsData = null;
            basicDetails = [];
            advancedDetails = [];
            twoMonthsDetails = [];
            agentPercentages = {};
            
            document.getElementById('basicResults')?.classList.add('hidden');
            document.getElementById('advancedResults')?.classList.add('hidden');
            document.getElementById('twoMonthsResults')?.classList.add('hidden');
            document.getElementById('percentageResults')?.classList.add('hidden');
            
            localStorage.removeItem('basicData');
            localStorage.removeItem('advancedData');
            localStorage.removeItem('twoMonthsData');
            localStorage.removeItem('basicDetails');
            localStorage.removeItem('advancedDetails');
            localStorage.removeItem('twoMonthsDetails');
            localStorage.removeItem('basicResults');
            localStorage.removeItem('advancedResults');
            localStorage.removeItem('twoMonthsResults');
            localStorage.removeItem('agentReports');
            localStorage.removeItem('agentPercentages');
            localStorage.removeItem('agentPercentages_monthYear');
            
            document.getElementById('basicFileInput').value = '';
            document.getElementById('advancedFileInput').value = '';
            document.getElementById('twoMonthsFileInput').value = '';
            document.getElementById('percentageFileInput').value = '';
            
            if (supabaseClient) {
                try {
                    const monthYear = getCurrentMonthYear();
                    await Promise.all([
                        supabaseClient.from('agent_percentages').delete().eq('month_year', monthYear),
                        supabaseClient.from('analysis_archives').delete().eq('month_year', monthYear)
                    ]);
                    showSuccessMessage('ØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
                    logActivity('Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª', 'ØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª');
                } catch (error) {
                    console.error('Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
                    showSuccessMessage('ØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª. Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
                }
            } else {
                showSuccessMessage('ØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
                logActivity('Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª', 'ØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª');
            }
            
            refreshAgentsList();
            updateAgentSummary();
            renderPercentageTable();
        }
        
        async function deleteAgentFromArchive(agentName, monthYear) {
            if (currentUserRole !== 'admin') {
                alert('Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø£Ø±Ø´ÙŠÙ. Ù‡Ø°Ù‡ Ø§Ù„ÙˆØ¸ÙŠÙØ© Ù…ØªØ§Ø­Ø© Ù„Ù„Ù…Ø¯ÙŠØ± ÙÙ‚Ø·.');
                return;
            }
            
            if (!confirm(`âš ï¸ ØªØ­Ø°ÙŠØ±: Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙˆÙƒÙŠÙ„ "${agentName}" Ù…Ù† Ø§Ù„Ø£Ø±Ø´ÙŠÙ Ù„Ù„Ø´Ù‡Ø± ${monthYear}!\n\nØ³ÙŠØªÙ… Ø­Ø°Ù:\n- Ø¬Ù…ÙŠØ¹ ØªØ­Ù„ÙŠÙ„Ø§Øª Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠ\n- Ø¬Ù…ÙŠØ¹ ØªØ­Ù„ÙŠÙ„Ø§Øª Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø®ÙØ¶ 3 Ø£Ø´Ù‡Ø±\n- Ø¬Ù…ÙŠØ¹ ØªØ­Ù„ÙŠÙ„Ø§Øª Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø®ÙØ¶ Ø´Ù‡Ø±ÙŠÙ†\n- Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªÙØ§ØµÙŠÙ„ ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©\n\nÙ‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ`)) {
                return;
            }
            
            try {
                if (!supabaseClient) {
                    alert('Ø®Ø·Ø£: Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ù…ØªØµÙ„Ø©');
                    return;
                }
                
                const analysisTypes = ['basic', 'advanced', 'two_months'];
                for (const analysisType of analysisTypes) {
                    try {
                        const { data: archive } = await supabaseClient
                            .from('analysis_archives')
                            .select('data')
                            .eq('month_year', monthYear)
                            .eq('analysis_type', analysisType)
                            .maybeSingle();
                        
                        if (archive && archive.data) {
                            if (archive.data.agentReports && archive.data.agentReports[agentName]) {
                                delete archive.data.agentReports[agentName];
                            }
                            
                            if (Array.isArray(archive.data.details)) {
                                archive.data.details = archive.data.details.filter(detail => {
                                    const detailAgent = detail.agent || detail.Agent || detail.agentName || detail.AgentName || detail['Ø§Ø³Ù… Ø§Ù„ÙˆÙƒÙŠÙ„'] || detail['Ø§Ù„ÙˆÙƒÙŠÙ„'];
                                    return normalizeAgentName(detailAgent) !== normalizeAgentName(agentName);
                                });
                            }
                            
                            if (Array.isArray(archive.data.data)) {
                                archive.data.data = archive.data.data.filter(item => {
                                    const itemAgent = item.agent || item.Agent || item.agentName || item.AgentName || item['Ø§Ø³Ù… Ø§Ù„ÙˆÙƒÙŠÙ„'] || item['Ø§Ù„ÙˆÙƒÙŠÙ„'];
                                    return normalizeAgentName(itemAgent) !== normalizeAgentName(agentName);
                                });
                            }
                            
                            if (archive.data.results && archive.data.results.agentName === agentName) {
                                archive.data.results = null;
                            }
                            
                            await saveToDatabase('analysis_archives', archive.data, { analysis_type: analysisType, monthYear: monthYear });
                        }
                    } catch (error) {
                        console.error(`Error deleting ${analysisType} archive:`, error);
                    }
                }
                
                try {
                    const { data: percentagesArchive } = await supabaseClient
                        .from('agent_percentages')
                        .select('data')
                        .eq('month_year', monthYear)
                        .maybeSingle();
                    
                    if (percentagesArchive && percentagesArchive.data && percentagesArchive.data[agentName]) {
                        delete percentagesArchive.data[agentName];
                        await saveToDatabase('agent_percentages', percentagesArchive.data, { monthYear: monthYear });
                    }
                } catch (error) {
                    console.error('Error deleting agent percentage:', error);
                }
                
                showSuccessMessage(`âœ… ØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙˆÙƒÙŠÙ„ "${agentName}" Ù…Ù† Ø§Ù„Ø£Ø±Ø´ÙŠÙ Ø¨Ù†Ø¬Ø§Ø­`);
                logActivity('Ø­Ø°Ù ØªÙØ§ØµÙŠÙ„ ÙˆÙƒÙŠÙ„ Ù…Ù† Ø§Ù„Ø£Ø±Ø´ÙŠÙ', `ØªÙ… Ø­Ø°Ù ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙˆÙƒÙŠÙ„ "${agentName}" Ù…Ù† Ø§Ù„Ø£Ø±Ø´ÙŠÙ Ù„Ù„Ø´Ù‡Ø± ${monthYear}`);
                
                setTimeout(() => {
                    loadArchiveByAgent(monthYear);
                }, 1000);
                
            } catch (error) {
                console.error('Error deleting agent from archive:', error);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙˆÙƒÙŠÙ„: ' + error.message);
            }
        }
        
        
        let scrollTimeout;
        window.addEventListener('scroll', function() {
            clearTimeout(scrollTimeout);
            scrollTimeout = setTimeout(() => {
                const currentTab = localStorage.getItem('currentTab') || 'basic';
                const currentScroll = window.scrollY || document.documentElement.scrollTop;
                localStorage.setItem(`scrollPosition_${currentTab}`, currentScroll.toString());
            }, 150);
        });
        let activityLog = JSON.parse(localStorage.getItem('activityLog') || '[]');
        function logActivity(action, details) {
            const logEntry = {
                id: Date.now(),
                timestamp: new Date().toISOString(),
                action: action,
                details: details,
                user: loggedInUser || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'
            };
            activityLog.unshift(logEntry);
            if (activityLog.length > 1000) activityLog = activityLog.slice(0, 1000);
            localStorage.setItem('activityLog', JSON.stringify(activityLog));
        }
        function refreshActivityLog() {
            const container = document.getElementById('activityLogContent');
            if (!container) return;
            if (activityLog.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª Ù…Ø³Ø¬Ù„Ø©</p>';
                return;
            }
            let html = '';
            activityLog.forEach(log => {
                const date = new Date(log.timestamp);
                const timeStr = date.toLocaleString('ar-IQ', { 
                    year: 'numeric', month: 'long', day: 'numeric',
                    hour: '2-digit', minute: '2-digit' 
                });
                html += `
                    <div class="activity-item">
                        <span class="activity-icon">${getActivityIcon(log.action)}</span>
                        <div class="activity-details">
                            <strong>${log.action}</strong>
                            <div style="color: #666; font-size: 0.9rem; margin-top: 5px;">${log.details}</div>
                            <div class="activity-time">${timeStr} - ${log.user}</div>
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }
        function getActivityIcon(action) {
            if (action.includes('ØªØ­Ù…ÙŠÙ„') || action.includes('Ø±ÙØ¹')) return '[Ø±ÙØ¹]';
            if (action.includes('ØªØ­Ù„ÙŠÙ„')) return '[ØªØ­Ù„ÙŠÙ„]';
            if (action.includes('ØªØµØ¯ÙŠØ±')) return '[ØªØµØ¯ÙŠØ±]';
            if (action.includes('Ø­ÙØ¸')) return '[Ø­ÙØ¸]';
            if (action.includes('Ø·Ø¨Ø§Ø¹Ø©')) return '[Ø·Ø¨Ø§Ø¹Ø©]';
            if (action.includes('Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª')) return '[Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª]';
            if (action.includes('Ù†Ø³Ø®')) return '[Ù†Ø³Ø®]';
            if (action.includes('Ù…Ø³Ø­')) return '[Ù…Ø³Ø­]';
            return '[Ø¹Ù…Ù„ÙŠØ©]';
        }
        function filterActivityLog() {
            const searchTerm = document.getElementById('activitySearch').value.toLowerCase();
            const container = document.getElementById('activityLogContent');
            const items = container.querySelectorAll('.activity-item');
            items.forEach(item => {
                const text = item.textContent.toLowerCase();
                item.style.display = text.includes(searchTerm) ? 'flex' : 'none';
            });
        }
        function exportActivityLog() {
            if (currentUserRole !== 'admin') {
                showAlert(document.getElementById('usersAlert'), 'Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„ØªØµØ¯ÙŠØ± Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª.', 'error');
                return;
            }
            if (activityLog.length === 0) {
                alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª Ù„Ù„ØªØµØ¯ÙŠØ±');
                return;
            }
            const wb = XLSX.utils.book_new();
            const excelData = activityLog.map(log => ({
                'Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª': new Date(log.timestamp).toLocaleString('ar-IQ'),
                'Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡': log.action,
                'Ø§Ù„ØªÙØ§ØµÙŠÙ„': log.details,
                'Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…': log.user
            }));
            const ws = XLSX.utils.json_to_sheet(excelData);
            XLSX.utils.book_append_sheet(wb, ws, 'Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª');
            XLSX.writeFile(wb, `Ø³Ø¬Ù„_Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª_${formatDateForFilename(new Date())}.xlsx`);
            logActivity('ØªØµØ¯ÙŠØ± Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª', 'ØªÙ… ØªØµØ¯ÙŠØ± Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø¥Ù„Ù‰ Excel');
            showSuccessMessage('ØªÙ… ØªØµØ¯ÙŠØ± Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø¨Ù†Ø¬Ø§Ø­!');
        }
        function clearActivityLog() {
            if (currentUserRole !== 'admin') {
                showAlert(document.getElementById('usersAlert'), 'Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ù…Ø³Ø­ Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª.', 'error');
                return;
            }
            if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§ØªØŸ')) {
                activityLog = [];
                localStorage.removeItem('activityLog');
                refreshActivityLog();
                logActivity('Ù…Ø³Ø­ Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª', 'ØªÙ… Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª');
                showSuccessMessage('ØªÙ… Ù…Ø³Ø­ Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª');
            }
        }
        function loadSettings() {
            const saved = JSON.parse(localStorage.getItem('appSettings') || '{}');
            if (saved.bronze) {
                document.getElementById('priceBronze').value = saved.bronze;
                subscriptionPrices.basic['Iraqcell_Bronze_Profile_NEW'] = saved.bronze;
                subscriptionPrices.basic['Iraqcell_Bronze_Profile'] = saved.bronze;
            }
            if (saved.silver) {
                document.getElementById('priceSilver').value = saved.silver;
                subscriptionPrices.basic['Iraqcell_Silver_Profile_NEW'] = saved.silver;
                subscriptionPrices.basic['Iraqcell_Silver_Profile'] = saved.silver;
            }
            if (saved.gold) {
                document.getElementById('priceGold').value = saved.gold;
                subscriptionPrices.basic['Iraqcell_Gold_Profile_NEW'] = saved.gold;
                subscriptionPrices.basic['Iraqcell_Gold_Profile'] = saved.gold;
            }
            if (saved.platinum) {
                document.getElementById('pricePlatinum').value = saved.platinum;
                subscriptionPrices.basic['Iraqcell_Platinum_Profile_NEW'] = saved.platinum;
                subscriptionPrices.basic['Iraqcell_Platinum_Profile'] = saved.platinum;
            }
            if (saved.notifications !== undefined) document.getElementById('enableNotifications').checked = saved.notifications;
        }
        function savePriceSettings() {
            const bronze = parseFloat(document.getElementById('priceBronze').value);
            const silver = parseFloat(document.getElementById('priceSilver').value);
            const gold = parseFloat(document.getElementById('priceGold').value);
            const platinum = parseFloat(document.getElementById('pricePlatinum').value);
            subscriptionPrices.basic['Iraqcell_Bronze_Profile_NEW'] = bronze;
            subscriptionPrices.basic['Iraqcell_Bronze_Profile'] = bronze;
            subscriptionPrices.basic['Iraqcell_Silver_Profile_NEW'] = silver;
            subscriptionPrices.basic['Iraqcell_Silver_Profile'] = silver;
            subscriptionPrices.basic['Iraqcell_Gold_Profile_NEW'] = gold;
            subscriptionPrices.basic['Iraqcell_Gold_Profile'] = gold;
            subscriptionPrices.basic['Iraqcell_Platinum_Profile_NEW'] = platinum;
            subscriptionPrices.basic['Iraqcell_Platinum_Profile'] = platinum;
            const settings = {
                bronze, silver, gold, platinum,
                notifications: document.getElementById('enableNotifications').checked
            };
            localStorage.setItem('appSettings', JSON.stringify(settings));
            logActivity('Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª', `ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ø³Ø¹Ø§Ø±: Bronze=${bronze}, Silver=${silver}, Gold=${gold}, Platinum=${platinum}`);
            showSuccessMessage('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¨Ù†Ø¬Ø§Ø­! Ø³ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ø¹Ù†Ø¯ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©.');
        }
        function saveDefaultPercentage() {
            const defaultPercentage = parseFloat(document.getElementById('defaultAgentPercentage').value);
            if (defaultPercentage < 0 || defaultPercentage > 100) {
                alert('Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø¦ÙˆÙŠØ© ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ø¨ÙŠÙ† 0 Ùˆ 100');
                const saved = parseFloat(localStorage.getItem('defaultAgentPercentage')) || 16;
                document.getElementById('defaultAgentPercentage').value = saved;
                return;
            }
            localStorage.setItem('defaultAgentPercentage', defaultPercentage.toString());
            logActivity('Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª', `ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù„Ù„ÙˆÙƒÙ„Ø§Ø¡ Ø¥Ù„Ù‰ ${defaultPercentage}%`);
            showSuccessMessage(`ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©: ${defaultPercentage}%`);
        }
        function backupData() {
            const backup = {
                timestamp: new Date().toISOString(),
                agentReports: agentReports,
                settings: JSON.parse(localStorage.getItem('appSettings') || '{}'),
                activityLog: activityLog
            };
            const dataStr = JSON.stringify(backup, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `backup_${formatDateForFilename(new Date())}.json`;
            link.click();
            URL.revokeObjectURL(url);
            logActivity('Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠ', 'ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
            showSuccessMessage('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­!');
        }
        function restoreData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const backup = JSON.parse(event.target.result);
                        if (backup.agentReports) agentReports = backup.agentReports;
                        if (backup.settings) localStorage.setItem('appSettings', JSON.stringify(backup.settings));
                        if (backup.activityLog) {
                            activityLog = backup.activityLog;
                            localStorage.setItem('activityLog', JSON.stringify(activityLog));
                        }
                        loadSettings();
                        updateAgentSummary();
                        refreshActivityLog();
                        logActivity('Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©');
                        showSuccessMessage('ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!');
                    } catch (error) {
                        alert('Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù: ' + error.message);
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }
        async function clearAllData() {
            if (!confirm('âš ï¸ ØªØ­Ø°ÙŠØ±: Ø³ÙŠØªÙ… ØªØµÙÙŠØ± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„Ø¨Ø¯Ø¡ Ù…Ù† Ø¬Ø¯ÙŠØ¯!\n\nØ³ÙŠØªÙ… Ø­Ø°Ù:\n- Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø´Ù‡Ø± (Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠØŒ Ù…Ø®ÙØ¶ 3 Ø£Ø´Ù‡Ø±ØŒ Ù…Ø®ÙØ¶ Ø´Ù‡Ø±ÙŠÙ†)\n- Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ø³Ø¨ Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø´Ù‡Ø±\n- Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø±Ø´ÙŠÙØ§Øª Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø´Ù‡Ø±\n- Ø¬Ù…ÙŠØ¹ Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù†Ø´Ø§Ø· Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø´Ù‡Ø±\n\nØ³ÙŠØªÙ… Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ ÙÙ‚Ø· Ø¨Ù€:\n- Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„ÙˆÙƒÙ„Ø§Ø¡ ÙÙŠ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙˆÙƒÙ„Ø§Ø¡\n- Ø¹Ø±ÙˆØ¶ Ø§Ù„ÙˆÙƒÙ„Ø§Ø¡ (B, S, G, P)\n- Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†\n\nÙ‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ')) {
                return;
            }
            
            try {
                const agentsBackup = agentsList.map(agent => ({
                    name: agent.name,
                    subName: agent.subName || '',
                    phone: agent.phone || '',
                    email: agent.email || '',
                    percentage: agent.percentage || 16
                }));
                
                agentReports = {};
                agentPercentages = {};
                activityLog = [];
                basicData = null;
                advancedData = null;
                twoMonthsData = null;
                basicDetails = [];
                advancedDetails = [];
                twoMonthsDetails = [];
                
                localStorage.clear();
                localStorage.setItem('agentsList', JSON.stringify(agentsBackup));
                
                if (supabaseClient) {
                    try {
                        const { error: analysisError } = await supabaseClient
                            .from('analysis_archives')
                            .delete()
                            .gte('id', 0); 
                        if (analysisError) {
                            console.error('Error deleting analysis archives:', analysisError);
                        } else {
                        }
                    } catch (e) {
                        console.error('Error deleting analysis archives:', e);
                    }
                    
                    try {
                        const { error: percentagesError } = await supabaseClient
                            .from('agent_percentages')
                            .delete()
                            .gte('id', 0); 
                        if (percentagesError) {
                            console.error('Error deleting agent percentages:', percentagesError);
                        } else {
                        }
                    } catch (e) {
                        console.error('Error deleting agent percentages:', e);
                    }
                    
                    try {
                        const { error: activityError } = await supabaseClient
                            .from('activity_logs')
                            .delete()
                            .gte('id', 0); 
                        if (activityError) {
                            console.error('Error deleting activity logs:', activityError);
                        } else {
                        }
                    } catch (e) {
                        console.error('Error deleting activity logs:', e);
                    }
                    
                    try {
                        await saveAgentsToDatabase();
                    } catch (e) {
                        console.error('Error updating agents list:', e);
                    }
                }
                
                refreshAgentsList();
                updateAgentSummary();
                renderPercentageTable();
                
                showSuccessMessage('âœ… ØªÙ… ØªØµÙÙŠØ± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­! ØªÙ… Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„ÙˆÙƒÙ„Ø§Ø¡ ÙÙ‚Ø·.');
                
                setTimeout(() => {
                    location.reload();
                }, 2000);
                
            } catch (error) {
                console.error('Error clearing data:', error);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØµÙÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ' + error.message);
            }
        }
        function loadActivityLog() {
            refreshActivityLog();
}
        async function ensureAgentExists(agentName) {
            if (!agentName || agentName === 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯') {
                return;
            }
            
            const normalizedAgentName = agentName.trim();
            if (!normalizedAgentName) {
                return;
            }
            
            const agentExists = agentsList.some(a => {
                const normalizedExistingName = (a.name || '').trim();
                return normalizedExistingName === normalizedAgentName;
            });
            
            if (!agentExists) {
                const newAgent = { 
                    name: normalizedAgentName,
                    subName: '',
                    phone: '', 
                    email: '',
                    percentage: 16
                };
                agentsList.push(newAgent);
                localStorage.setItem('agentsList', JSON.stringify(agentsList));
                
                if (supabaseClient) {
                try {
                    const saved = await saveAgentsToDatabase();
                    if (saved) {
                    } else {
                        console.warn(`âš  Failed to save agent "${normalizedAgentName}" to database, will retry on next operation`);
                    }
                } catch (err) {
                    console.error('Error saving agent to database:', err);
                }
                }
                
                logActivity('Ø¥Ø¶Ø§ÙØ© ÙˆÙƒÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠ', `ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙˆÙƒÙŠÙ„ "${normalizedAgentName}" ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù…Ù† Ù…Ù„Ù Ø§Ù„ØªØ­Ù„ÙŠÙ„`);
                showSuccessMessage(`ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙˆÙƒÙŠÙ„ "${normalizedAgentName}" ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¥Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙˆÙƒÙ„Ø§Ø¡`);
            } else {
            }
        }
        async function saveAgentsToDatabase() {
            if (!supabaseClient) {
                return false;
            }
            try {
                const permanentMonthYear = '0000-00';
                const agentsData = agentsList.map(agent => ({
                    name: agent.name,
                    subName: agent.subName || '',
                    phone: agent.phone || '',
                    email: agent.email || '',
                    percentage: agent.percentage || 16
                }));
                const { data: existingArchive, error: checkError } = await supabaseClient
                    .from('agents_list')
                    .select('id, data')
                    .eq('month_year', permanentMonthYear)
                    .maybeSingle();
                if (!checkError && existingArchive) {
                    const { error: updateError } = await supabaseClient
                        .from('agents_list')
                        .update({
                            data: agentsData,
                            updated_at: new Date().toISOString()
                        })
                        .eq('id', existingArchive.id);
                    if (updateError) throw updateError;
                } else {
                    const { error: insertError } = await supabaseClient
                        .from('agents_list')
                        .insert({
                            month_year: permanentMonthYear,
                            data: agentsData,
                            created_at: new Date().toISOString(),
                            updated_at: new Date().toISOString()
                        });
                    if (insertError) throw insertError;
                }
                return true;
            } catch (error) {
                console.error('âœ— Error saving agents to database:', error);
                return false;
            }
        }
        let saveAgentsListToDatabaseTimeout = null;
        let isSavingAgentsList = false;
        async function saveAgentsListToDatabase(monthYear = null) {
            if (!supabaseClient) {
                return false;
            }
            if (isSavingAgentsList) {
                return false;
            }
            if (saveAgentsListToDatabaseTimeout) {
                clearTimeout(saveAgentsListToDatabaseTimeout);
            }
            return new Promise((resolve) => {
                saveAgentsListToDatabaseTimeout = setTimeout(async () => {
                    isSavingAgentsList = true;
                    try {
                        const result = await saveAgentsListToDatabaseInternal(monthYear);
                        resolve(result);
                    } finally {
                        isSavingAgentsList = false;
                        saveAgentsListToDatabaseTimeout = null;
                    }
                }, 2000);
            });
        }
        async function saveAgentsListToDatabaseInternal(monthYear = null) {
            if (!supabaseClient) {
                return false;
            }
            try {
                if (!monthYear) {
                    monthYear = getCurrentMonthYear();
                }
                const optimizeDetails = (details) => {
                    if (!Array.isArray(details) || details.length === 0) return [];
                    return details.slice(-200).map(detail => ({
                        username: detail.username,
                        subscription: detail.subscription,
                        agent: detail.agent,
                        date1: detail.date1,
                        date2: detail.date2,
                        date3: detail.date3,
                        daysDiff: detail.daysDiff,
                        type: detail.type
                    }));
                };
                const optimizeReport = (report) => {
                    if (!report) return null;
                    return {
                        bronze: report.bronze ? {
                            count: report.bronze.count,
                            amount: report.bronze.amount,
                            promoAmount: report.bronze.promoAmount,
                            officialAmount: report.bronze.officialAmount
                        } : null,
                        silver: report.silver ? {
                            count: report.silver.count,
                            amount: report.silver.amount,
                            promoAmount: report.silver.promoAmount,
                            officialAmount: report.silver.officialAmount
                        } : null,
                        gold: report.gold ? {
                            count: report.gold.count,
                            amount: report.gold.amount,
                            promoAmount: report.gold.promoAmount,
                            officialAmount: report.gold.officialAmount
                        } : null,
                        platinum: report.platinum ? {
                            count: report.platinum.count,
                            amount: report.platinum.amount,
                            promoAmount: report.platinum.promoAmount,
                            officialAmount: report.platinum.officialAmount
                        } : null,
                        total: report.total || null,
                        agentName: report.agentName || null
                    };
                };
                const agentsDataWithDetails = agentsList.map(agent => {
                    const agentName = agent.name;
                    const reports = agentReports[agentName] || {};
                    const basicDetailsForAgent = (basicDetails || []).filter(d => d && d.agent === agentName);
                    const advancedDetailsForAgent = (advancedDetails || []).filter(d => d && d.agent === agentName);
                    const twoMonthsDetailsForAgent = (twoMonthsDetails || []).filter(d => d && d.agent === agentName);
                    return {
                        name: agent.name,
                        subName: agent.subName || '',
                        phone: agent.phone || '',
                        email: agent.email || '',
                        percentage: agent.percentage || 16,
                        details: {
                            basic: optimizeDetails(basicDetailsForAgent),
                            advanced: optimizeDetails(advancedDetailsForAgent),
                            twoMonths: optimizeDetails(twoMonthsDetailsForAgent)
                        },
                        offers: {
                            basic: optimizeReport(reports.basic),
                            advanced: optimizeReport(reports.advanced),
                            twoMonths: optimizeReport(reports.twoMonths)
                        }
                    };
                });
                const checkPromise = supabaseClient
                    .from('agents_list')
                    .select('id, data')
                    .eq('month_year', monthYear)
                    .maybeSingle();
                const checkTimeout = new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('Check timeout')), 15000)
                );
                let existingArchive;
                let checkError = null;
                try {
                    const result = await Promise.race([checkPromise, checkTimeout]);
                    if (result && !result.error) {
                        existingArchive = result.data;
                    } else if (result && result.error) {
                        checkError = result.error;
                    }
                } catch (timeoutError) {
                    console.warn('Check timeout for agents_list, proceeding with insert');
                }
                if (!checkError && existingArchive) {
                    let existingAgents = existingArchive.data || [];
                    if (!Array.isArray(existingAgents)) {
                        existingAgents = [];
                    }
                    const existingAgentsMap = new Map();
                    existingAgents.forEach(agent => {
                        existingAgentsMap.set(agent.name, agent);
                    });
                    agentsDataWithDetails.forEach(newAgent => {
                        const existingAgent = existingAgentsMap.get(newAgent.name);
                        if (existingAgent) {
                            const hasNewBasic = newAgent.details.basic && newAgent.details.basic.length > 0;
                            const hasNewAdvanced = newAgent.details.advanced && newAgent.details.advanced.length > 0;
                            const hasNewTwoMonths = newAgent.details.twoMonths && newAgent.details.twoMonths.length > 0;
                            if (hasNewBasic || hasNewAdvanced || hasNewTwoMonths) {
                                existingAgent.details = {
                                    basic: newAgent.details.basic && newAgent.details.basic.length > 0 
                                        ? newAgent.details.basic 
                                        : (existingAgent.details?.basic || []),
                                    advanced: newAgent.details.advanced && newAgent.details.advanced.length > 0 
                                        ? newAgent.details.advanced 
                                        : (existingAgent.details?.advanced || []),
                                    twoMonths: newAgent.details.twoMonths && newAgent.details.twoMonths.length > 0 
                                        ? newAgent.details.twoMonths 
                                        : (existingAgent.details?.twoMonths || [])
                                };
                            }
                            existingAgent.offers = {
                                basic: newAgent.offers.basic || existingAgent.offers?.basic || null,
                                advanced: newAgent.offers.advanced || existingAgent.offers?.advanced || null,
                                twoMonths: newAgent.offers.twoMonths || existingAgent.offers?.twoMonths || null
                            };
                            if (!existingAgent.phone && newAgent.phone) existingAgent.phone = newAgent.phone;
                            if (!existingAgent.email && newAgent.email) existingAgent.email = newAgent.email;
                            if (!existingAgent.subName && newAgent.subName) existingAgent.subName = newAgent.subName;
                        } else {
                            existingAgents.push(newAgent);
                        }
                    });
                    const updatePromise = supabaseClient
                        .from('agents_list')
                        .update({
                            data: existingAgents,
                            updated_at: new Date().toISOString()
                        })
                        .eq('id', existingArchive.id);
                    const updateTimeout = new Promise((_, reject) => 
                        setTimeout(() => reject(new Error('Update timeout')), 90000)
                    );
                    try {
                        const { error: updateError } = await Promise.race([updatePromise, updateTimeout]);
                        if (updateError) throw updateError;
                    } catch (timeoutError) {
                        console.warn(`âš  Update timeout for agents_list (${monthYear}) - Data will be saved on next successful operation`);
                        return false;
                    }
                } else {
                    const insertPromise = supabaseClient
                        .from('agents_list')
                        .insert({
                            month_year: monthYear,
                            data: agentsDataWithDetails,
                            created_at: new Date().toISOString(),
                            updated_at: new Date().toISOString()
                        });
                    const insertTimeout = new Promise((_, reject) => 
                        setTimeout(() => reject(new Error('Insert timeout')), 90000)
                    );
                    try {
                        const { error: insertError } = await Promise.race([insertPromise, insertTimeout]);
                        if (insertError) throw insertError;
                    } catch (timeoutError) {
                        console.warn(`âš  Insert timeout for agents_list (${monthYear}) - Will retry on next operation`);
                        return false;
                    }
                }
                return true;
            } catch (error) {
                console.error('âœ— Error saving agents_list to database:', error);
                return false;
            }
        }
        let currentAgentSort = 'name';
        let currentAgentFilter = '';
        function refreshAgentsList() {
            renderAgentsList();
        }
        function filterAgents() {
            currentAgentFilter = document.getElementById('agentSearchInput').value.toLowerCase().trim();
            renderAgentsList();
        }
        function sortAgents() {
            currentAgentSort = document.getElementById('agentSortSelect').value;
            renderAgentsList();
        }
        function renderAgentsList() {
            const agentsListContainer = document.getElementById('agentsList');
            if (!agentsListContainer) return;
            if (agentsList.length === 0) {
                agentsListContainer.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #999;">
                        <p style="font-size: 1.2rem; margin-bottom: 20px;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆÙƒÙ„Ø§Ø¡ Ù…Ø³Ø¬Ù„ÙˆÙ†</p>
                        <p style="font-size: 0.9rem; color: #666;">Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙˆÙƒÙ„Ø§Ø¡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ù„ÙØ§Øª</p>
                    </div>
                `;
                document.getElementById('agentsCount').textContent = '0';
                return;
            }
            let filteredAgents = agentsList.filter(agent => {
                if (!currentAgentFilter) return true;
                return agent.name.toLowerCase().includes(currentAgentFilter) ||
                       (agent.phone && agent.phone.includes(currentAgentFilter)) ||
                       (agent.email && agent.email.toLowerCase().includes(currentAgentFilter));
            });
            filteredAgents = filteredAgents.map(agent => {
                const reports = agentReports[agent.name] || {};
                const totalBasic = reports.basic?.total.amount || 0;
                const totalAdvanced = reports.advanced?.total.profit || 0;
                const totalTwoMonths = reports.twoMonths?.total.profit || 0;
                const total = totalBasic + totalAdvanced + totalTwoMonths;
                const reportsCount = (totalBasic > 0 ? 1 : 0) + (totalAdvanced > 0 ? 1 : 0) + (totalTwoMonths > 0 ? 1 : 0);
                return {
                    ...agent,
                    index: agentsList.indexOf(agent),
                    total,
                    reportsCount
                };
            });
            filteredAgents.sort((a, b) => {
                switch(currentAgentSort) {
                    case 'name':
                        return a.name.localeCompare(b.name, 'ar');
                    case 'name-desc':
                        return b.name.localeCompare(a.name, 'ar');
                    case 'total-desc':
                        return b.total - a.total;
                    case 'total-asc':
                        return a.total - b.total;
                    case 'reports-desc':
                        return b.reportsCount - a.reportsCount;
                    case 'reports-asc':
                        return a.reportsCount - b.reportsCount;
                    default:
                        return 0;
                }
            });
            let html = '';
            filteredAgents.forEach((agent) => {
                const index = agent.index;
                const reports = agentReports[agent.name] || {};
                const totalBasic = reports.basic?.total.amount || 0;
                const totalAdvanced = reports.advanced?.total.profit || 0;
                const totalTwoMonths = reports.twoMonths?.total.profit || 0;
                const total = totalBasic + totalAdvanced + totalTwoMonths;
                const hasReports = total > 0;
                const reportsCount = (totalBasic > 0 ? 1 : 0) + (totalAdvanced > 0 ? 1 : 0) + (totalTwoMonths > 0 ? 1 : 0);
                const percentageData = agentPercentages[agent.name] || {};
                const hasPercentageData = percentageData.percentage !== undefined || percentageData.netPercentage !== undefined;
                const percentageAmount = percentageData.agentPercentageAmount || 0;
                const netPercentage = percentageData.netPercentage || 0;
                const deductions = percentageData.deductions || 0;
                const penalties = percentageData.penalties || 0;
                const percentageRate = percentageData.percentage || agent.percentage || 16;
                html += `
                    <div class="agent-card-improved">
                        <div class="agent-card-header-improved">
                            <div class="agent-name-section">
                                <h3 class="agent-name-title">${agent.name}</h3>
                                ${agent.subName ? `<p class="agent-name-subtitle">${agent.subName}</p>` : ''}
                                ${hasReports ? `<span class="agent-badge">${formatNumberEnglish(reportsCount)} ØªÙ‚Ø±ÙŠØ±</span>` : '<span class="agent-badge-empty">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ‚Ø§Ø±ÙŠØ±</span>'}
                            </div>
                            <div class="agent-actions-improved">
                                <button class="btn-action btn-action-edit" onclick="showEditAgentModal(${index})" title="ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª">
                                    ØªØ¹Ø¯ÙŠÙ„
                                </button>
                                <button class="btn-action btn-action-send" onclick="sendWhatsAppReport('${agent.name}')" title="Ø¥Ø±Ø³Ø§Ù„ ØªÙ‚Ø±ÙŠØ± ÙˆØ§ØªØ³Ø§Ø¨" ${!hasReports ? 'disabled style="opacity: 0.5; cursor: not-allowed;"' : ''}>
                                    Ø¥Ø±Ø³Ø§Ù„
                                </button>
                                <button class="btn-action btn-action-delete" onclick="deleteAgent(${index})" title="Ø­Ø°Ù Ø§Ù„ÙˆÙƒÙŠÙ„">
                                    Ø­Ø°Ù
                                </button>
                            </div>
                        </div>
                        <div class="agent-info-section">
                            <div class="info-item-improved">
                                <span class="info-label">Ø§Ù„Ù†Ø³Ø¨Ø©:</span>
                                <input type="number" id="agentPercentage_${index}" class="info-value-input" value="${agent.percentage || 16}" min="0" max="100" step="0.01" onchange="updateAgentPercentage(${index}, this.value)" style="width: 80px; padding: 4px; text-align: center; direction: ltr; font-size: 0.8rem; border: 1px solid rgba(128, 28, 50, 0.2); border-radius: 6px; position: relative; z-index: 10; pointer-events: auto; cursor: text;">
                                <span style="margin-right: 5px; color: #801c32; font-weight: 700;">%</span>
                            </div>
                            ${agent.phone ? `
                                <div class="info-item-improved">
                                    <span class="info-label">Ù‡Ø§ØªÙ:</span>
                                    <span class="info-value">${agent.phone}</span>
                                </div>
                            ` : ''}
                            ${agent.email ? `
                                <div class="info-item-improved">
                                    <span class="info-label">Ø¨Ø±ÙŠØ¯:</span>
                                    <span class="info-value">${agent.email}</span>
                                </div>
                            ` : ''}
                            ${!agent.phone && !agent.email ? `
                                <div class="info-item-improved">
                                    <span class="info-label-empty">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§ØªØµØ§Ù„</span>
                                </div>
                            ` : ''}
                        </div>
                        ${hasPercentageData ? `
                        <div class="agent-percentage-section" style="flex: 0 0 180px; min-width: 180px; max-width: 180px; padding-right: 12px; border-right: 1px solid rgba(128, 28, 50, 0.1); display: flex; flex-direction: column; gap: 4px;">
                            <div style="font-weight: 700; color: var(--primary-color); font-size: 0.75rem; margin-bottom: 4px;">ðŸ“Š Ù†Ø³Ø¨Ø© Ø§Ù„ÙˆÙƒÙŠÙ„</div>
                            <div style="background: rgba(128, 28, 50, 0.04); padding: 4px 6px; border-radius: 4px; border: 1px solid rgba(128, 28, 50, 0.15);">
                                <div style="font-size: 0.65rem; color: var(--text-secondary); margin-bottom: 2px;">Ø§Ù„Ù†Ø³Ø¨Ø©</div>
                                <div style="font-weight: 700; color: var(--primary-color); font-size: 0.8rem;">${formatNumber(percentageRate)}%</div>
                            </div>
                            <div style="background: rgba(128, 28, 50, 0.04); padding: 4px 6px; border-radius: 4px; border: 1px solid rgba(128, 28, 50, 0.15);">
                                <div style="font-size: 0.65rem; color: var(--text-secondary); margin-bottom: 2px;">Ø§Ù„Ù…Ø¨Ù„Øº</div>
                                <div style="font-weight: 700; color: #2d5016; font-size: 0.8rem;">${formatNumber(percentageAmount)} <span style="font-size: 0.65rem;">Ø¯.Ø¹</span></div>
                            </div>
                            <div style="background: rgba(128, 28, 50, 0.04); padding: 4px 6px; border-radius: 4px; border: 1px solid rgba(128, 28, 50, 0.15);">
                                <div style="font-size: 0.65rem; color: var(--text-secondary); margin-bottom: 2px;">Ø§Ù„ØµØ§ÙÙŠ</div>
                                <div style="font-weight: 700; color: #2d5016; font-size: 0.85rem;">${formatNumber(netPercentage)} <span style="font-size: 0.65rem;">Ø¯.Ø¹</span></div>
                            </div>
                            ${(deductions > 0 || penalties > 0) ? `
                            <div style="display: flex; gap: 4px;">
                                ${deductions > 0 ? `
                                <div style="background: rgba(255, 193, 7, 0.1); padding: 4px 6px; border-radius: 4px; border: 1px solid rgba(255, 193, 7, 0.3); flex: 1;">
                                    <div style="font-size: 0.6rem; color: var(--text-secondary); margin-bottom: 2px;">Ø§Ø³ØªÙ‚Ø·Ø§Ø¹</div>
                                    <div style="font-weight: 700; color: #f57c00; font-size: 0.75rem;">${formatNumber(deductions)} <span style="font-size: 0.6rem;">Ø¯.Ø¹</span></div>
                                </div>
                                ` : ''}
                                ${penalties > 0 ? `
                                <div style="background: rgba(244, 67, 54, 0.1); padding: 4px 6px; border-radius: 4px; border: 1px solid rgba(244, 67, 54, 0.3); flex: 1;">
                                    <div style="font-size: 0.6rem; color: var(--text-secondary); margin-bottom: 2px;">ØºØ±Ø§Ù…Ø©</div>
                                    <div style="font-weight: 700; color: #d32f2f; font-size: 0.75rem;">${formatNumber(penalties)} <span style="font-size: 0.6rem;">Ø¯.Ø¹</span></div>
                                </div>
                                ` : ''}
                            </div>
                            ` : ''}
                        </div>
                        ` : ''}
                        <div class="agent-reports-section">
                            <div class="reports-grid">
                                ${totalBasic > 0 ? `
                                    <div class="report-item report-basic">
                                        <div class="report-label">Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠ</div>
                                        <div class="report-value">${formatNumber(totalBasic)} <span class="currency">Ø¯.Ø¹</span></div>
                                    </div>
                                ` : ''}
                                ${totalAdvanced > 0 ? `
                                    <div class="report-item report-advanced">
                                        <div class="report-label">Ù…Ø®ÙØ¶ 3 Ø£Ø´Ù‡Ø±</div>
                                        <div class="report-value">${formatNumber(totalAdvanced)} <span class="currency">Ø¯.Ø¹</span></div>
                                    </div>
                                ` : ''}
                                ${totalTwoMonths > 0 ? `
                                    <div class="report-item report-twomonths">
                                        <div class="report-label">Ù…Ø®ÙØ¶ Ø´Ù‡Ø±ÙŠÙ†</div>
                                        <div class="report-value">${formatNumber(totalTwoMonths)} <span class="currency">Ø¯.Ø¹</span></div>
                                    </div>
                                ` : ''}
                            </div>
                            ${hasReports ? `
                                <div class="agent-total-section">
                                    <div class="total-label">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</div>
                                    <div class="total-value">${formatNumber(total)} <span class="currency">Ø¯.Ø¹</span></div>
                                </div>
                                <button class="btn btn-warning" onclick="clearAgentReports('${agent.name}')" style="padding: 5px 10px; font-size: 0.7rem; white-space: nowrap; flex-shrink: 0;">
                                    ðŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                                </button>
                            ` : `
                                <div class="no-reports-message" style="flex: 1; text-align: center; padding: 4px 8px; background: rgba(128, 28, 50, 0.04); border-radius: 5px; border: 1px dashed rgba(128, 28, 50, 0.25);">
                                    <p style="color: #999; font-size: 0.7rem; margin: 0; font-style: italic;">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ‚Ø§Ø±ÙŠØ±</p>
                                </div>
                            `}
                        </div>
                    </div>
                `;
            });
            agentsListContainer.innerHTML = html;
            const countElement = document.getElementById('agentsCount');
            if (countElement) {
                countElement.textContent = filteredAgents.length;
            }
        }
        function showAddAgentModal() {
            document.getElementById('agentModalTitle').textContent = 'Ø¥Ø¶Ø§ÙØ© ÙˆÙƒÙŠÙ„ Ø¬Ø¯ÙŠØ¯';
            document.getElementById('agentForm').reset();
            document.getElementById('agentForm').onsubmit = function(e) {
                e.preventDefault();
                addAgent();
            };
            document.getElementById('agentModal').classList.add('show');
        }
        function showEditAgentModal(index) {
            const agent = agentsList[index];
            document.getElementById('agentModalTitle').textContent = 'ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆÙƒÙŠÙ„';
            document.getElementById('agentName').value = agent.name;
            document.getElementById('agentSubName').value = agent.subName || '';
            document.getElementById('agentPhone').value = agent.phone || '';
            document.getElementById('agentEmail').value = agent.email || '';
            document.getElementById('agentForm').onsubmit = function(e) {
                e.preventDefault();
                updateAgent(index);
            };
            document.getElementById('agentModal').classList.add('show');
        }
        function closeAgentModal() {
            document.getElementById('agentModal').classList.remove('show');
        }
        async function addAgent() {
            const name = document.getElementById('agentName').value.trim();
            const subName = document.getElementById('agentSubName') ? document.getElementById('agentSubName').value.trim() : '';
            const phone = document.getElementById('agentPhone').value.trim();
            const email = document.getElementById('agentEmail').value.trim();
            if (!name) {
                alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„ÙˆÙƒÙŠÙ„');
                return;
            }
            const normalizedName = name.trim();
            const agentExists = agentsList.some(a => {
                const normalizedExistingName = (a.name || '').trim();
                return normalizedExistingName === normalizedName;
            });
            if (agentExists) {
                alert('Ø§Ø³Ù… Ø§Ù„ÙˆÙƒÙŠÙ„ Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹');
                return;
            }
            const agentData = { 
                name: normalizedName, 
                subName: subName || '', 
                phone, 
                email,
                percentage: 16
            };
            agentsList.push(agentData);
            localStorage.setItem('agentsList', JSON.stringify(agentsList));
            
            if (supabaseClient) {
            try {
                const saved = await saveAgentsToDatabase();
                if (saved) {
                        showSuccessMessage(`ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙˆÙƒÙŠÙ„ ÙˆØ­ÙØ¸Ù‡ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª`);
                } else {
                    console.warn(`âš  Failed to save agent "${name}" to database, will retry on next operation`);
                }
            } catch (err) {
                console.error('Error saving agent to database:', err);
                }
            }
            refreshAgentsList();
            updateAgentsListForPercentage();
            closeAgentModal();
            showSuccessMessage('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙˆÙƒÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­');
            logActivity('Ø¥Ø¶Ø§ÙØ© ÙˆÙƒÙŠÙ„', `ØªÙ… Ø¥Ø¶Ø§ÙØ© ÙˆÙƒÙŠÙ„ Ø¬Ø¯ÙŠØ¯: ${name}`);
        }
        function updateAgentPercentage(index, newPercentage) {
            const percentage = parseFloat(newPercentage) || 16;
            if (percentage < 0 || percentage > 100) {
                alert('Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø¦ÙˆÙŠØ© ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ø¨ÙŠÙ† 0 Ùˆ 100');
                const agent = agentsList[index];
                document.getElementById(`agentPercentage_${index}`).value = agent.percentage || 16;
                return;
            }
            const agent = agentsList[index];
            if (!agent) return;
            agent.percentage = percentage;
            localStorage.setItem('agentsList', JSON.stringify(agentsList));
            saveAgentsToDatabase().catch(err => console.error('Error saving agents to database:', err));
            refreshAgentsList();
            showSuccessMessage(`ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Ø³Ø¨Ø© Ù„Ù„ÙˆÙƒÙŠÙ„ "${agent.name}" Ø¥Ù„Ù‰ ${percentage}%`);
            logActivity('ØªØ¹Ø¯ÙŠÙ„ Ù†Ø³Ø¨Ø© ÙˆÙƒÙŠÙ„', `ØªÙ… ØªØ­Ø¯ÙŠØ« Ù†Ø³Ø¨Ø© Ø§Ù„ÙˆÙƒÙŠÙ„ "${agent.name}" Ø¥Ù„Ù‰ ${percentage}%`);
        }
        async function updateAgent(index) {
            const name = document.getElementById('agentName').value.trim();
            const subName = document.getElementById('agentSubName') ? document.getElementById('agentSubName').value.trim() : '';
            const phone = document.getElementById('agentPhone').value.trim();
            const email = document.getElementById('agentEmail').value.trim();
            if (!name) {
                alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„ÙˆÙƒÙŠÙ„');
                return;
            }
            const oldName = agentsList[index].name;
            if (name !== oldName && agentsList.some((a, i) => i !== index && a.name === name)) {
                alert('Ø§Ø³Ù… Ø§Ù„ÙˆÙƒÙŠÙ„ Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹');
                return;
            }
            if (name !== oldName && agentReports[oldName]) {
                agentReports[name] = agentReports[oldName];
                delete agentReports[oldName];
            }
            const existingAgent = agentsList[index];
            const agentData = { 
                name, 
                subName: subName !== '' ? subName : (existingAgent.subName || ''), 
                phone: phone !== '' ? phone : (existingAgent.phone || ''), 
                email: email !== '' ? email : (existingAgent.email || ''),
                percentage: existingAgent.percentage || 16
            };
            agentsList[index] = agentData;
            localStorage.setItem('agentsList', JSON.stringify(agentsList));
            
            if (supabaseClient) {
            try {
                const saved = await saveAgentsToDatabase();
                if (saved) {
                        showSuccessMessage(`ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª`);
                } else {
                    console.warn(`âš  Failed to update agent "${name}" in database, will retry on next operation`);
                }
            } catch (err) {
                console.error('Error updating agent in database:', err);
                }
            }
            refreshAgentsList();
            updateAgentSummary();
            updateAgentsListForPercentage();
            closeAgentModal();
            showSuccessMessage('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆÙƒÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­');
            logActivity('ØªØ¹Ø¯ÙŠÙ„ ÙˆÙƒÙŠÙ„', `ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆÙƒÙŠÙ„: ${name}`);
        }
        async function deleteAgent(index) {
            const agent = agentsList[index];
            if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„ÙˆÙƒÙŠÙ„ "${agent.name}"ØŸ\n\nØ³ÙŠØªÙ… Ø­Ø°Ù:\n- Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆÙƒÙŠÙ„ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©\n- Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡Ø°Ø§ Ø§Ù„ÙˆÙƒÙŠÙ„`)) return;
            const agentName = agent.name;
            agentsList.splice(index, 1);
            localStorage.setItem('agentsList', JSON.stringify(agentsList));
            if (agentReports[agentName]) {
                delete agentReports[agentName];
            }
            if (agentPercentages[agentName]) {
                delete agentPercentages[agentName];
                localStorage.setItem('agentPercentages', JSON.stringify(agentPercentages));
                if (supabaseClient) {
                    const savedMonthYear = localStorage.getItem('agentPercentages_monthYear') || getCurrentMonthYear();
                    saveToDatabase('agent_percentages', agentPercentages, { monthYear: savedMonthYear })
                        .catch(err => console.error('Error saving percentages after deletion:', err));
                }
            }
            if (supabaseClient) {
            try {
                const saved = await saveAgentsToDatabase();
                if (saved) {
                } else {
                    console.warn(`âš  Failed to delete agent "${agentName}" from database, will retry on next operation`);
                }
            } catch (err) {
                console.error('Error deleting agent from database:', err);
                }
            }
            refreshAgentsList();
            updateAgentsListForPercentage();
            updateAgentSummary();
            renderPercentageTable();
            showSuccessMessage('ØªÙ… Ø­Ø°Ù Ø§Ù„ÙˆÙƒÙŠÙ„ ÙˆØ¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§ØªÙ‡ Ø¨Ù†Ø¬Ø§Ø­');
            logActivity('Ø­Ø°Ù ÙˆÙƒÙŠÙ„', `ØªÙ… Ø­Ø°Ù Ø§Ù„ÙˆÙƒÙŠÙ„ ÙˆØ¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§ØªÙ‡: ${agentName}`);
        }
        function sendWhatsAppReport(agentName) {
            const agent = agentsList.find(a => a.name === agentName);
            if (!agent) {
                alert('Ø§Ù„ÙˆÙƒÙŠÙ„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©');
                return;
            }
            if (!agent.phone) {
                alert('Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø±Ù‚Ù… Ù‡Ø§ØªÙ Ù„Ù„ÙˆÙƒÙŠÙ„');
                return;
            }
            showMessageCustomizationModal(agentName);
        }
        function showMessageCustomizationModal(agentName) {
            const reports = agentReports[agentName] || {};
            const agent = agentsList.find(a => a.name === agentName);
            const agentSubName = agent?.subName || '';
            document.getElementById('customMessageAgentName').textContent = agentName;
            let defaultMessage = `*${agentName}*`;
            if (agentSubName) {
                defaultMessage += `\n${agentSubName}`;
            }
            defaultMessage += `\n\nØªØ­ÙŠØ© Ø·ÙŠØ¨Ø© \n\nÙ†ÙˆØ¯ Ø¥Ø¹Ù„Ø§Ù…ÙƒÙ… Ø¨Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø®Ø§Øµ Ø¨Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„Ù…Ø³ØªØ­Ù‚Ø©ØŒ ÙˆÙƒÙ…Ø§ ÙŠÙ„ÙŠ:\n\n`;
            const totalBasic = reports.basic?.total.amount || 0;
            const totalAdvanced = reports.advanced?.total.profit || 0;
            const totalTwoMonths = reports.twoMonths?.total.profit || 0;
            const selectedTotal = totalBasic + totalAdvanced + totalTwoMonths;
            const availableOffers = [];
            if (totalBasic > 0) availableOffers.push({ type: 'basic', amount: totalBasic });
            if (totalAdvanced > 0) availableOffers.push({ type: 'advanced', amount: totalAdvanced });
            if (totalTwoMonths > 0) availableOffers.push({ type: 'twoMonths', amount: totalTwoMonths });
            if (availableOffers.length > 1) {
                defaultMessage += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
            if (totalBasic > 0) {
                    defaultMessage += `*Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠ: ${formatNumberEnglish(totalBasic)} Ø¯ÙŠÙ†Ø§Ø± Ø¹Ø±Ø§Ù‚ÙŠ*\n`;
            }
            if (totalAdvanced > 0) {
                    defaultMessage += `*Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø®ÙØ¶ Ù„Ø«Ù„Ø§Ø«Ø© Ø£Ø´Ù‡Ø±: ${formatNumberEnglish(totalAdvanced)} Ø¯ÙŠÙ†Ø§Ø± Ø¹Ø±Ø§Ù‚ÙŠ*\n`;
            }
            if (totalTwoMonths > 0) {
                    defaultMessage += `*Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø®ÙØ¶ Ù„Ø´Ù‡Ø±ÙŠÙ†: ${formatNumberEnglish(totalTwoMonths)} Ø¯ÙŠÙ†Ø§Ø± Ø¹Ø±Ø§Ù‚ÙŠ*\n`;
            }
                defaultMessage += `\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
                defaultMessage += `*Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ„ÙŠ: ${formatNumberEnglish(selectedTotal)} Ø¯ÙŠÙ†Ø§Ø± Ø¹Ø±Ø§Ù‚ÙŠ*\n`;
            }
            else if (availableOffers.length === 1) {
                const offer = availableOffers[0];
                defaultMessage += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
                if (offer.type === 'basic') {
                    defaultMessage += `*Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠ: ${formatNumberEnglish(offer.amount)} Ø¯ÙŠÙ†Ø§Ø± Ø¹Ø±Ø§Ù‚ÙŠ*\n`;
                } else if (offer.type === 'advanced') {
                    defaultMessage += `*Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø®ÙØ¶ Ù„Ø«Ù„Ø§Ø«Ø© Ø£Ø´Ù‡Ø±: ${formatNumberEnglish(offer.amount)} Ø¯ÙŠÙ†Ø§Ø± Ø¹Ø±Ø§Ù‚ÙŠ*\n`;
                } else if (offer.type === 'twoMonths') {
                    defaultMessage += `*Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø®ÙØ¶ Ù„Ø´Ù‡Ø±ÙŠÙ†: ${formatNumberEnglish(offer.amount)} Ø¯ÙŠÙ†Ø§Ø± Ø¹Ø±Ø§Ù‚ÙŠ*\n`;
                }
            }
            else if (selectedTotal > 0) {
                defaultMessage += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
                defaultMessage += `*Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ„ÙŠ: ${formatNumberEnglish(selectedTotal)} Ø¯ÙŠÙ†Ø§Ø± Ø¹Ø±Ø§Ù‚ÙŠ*\n`;
            }
            defaultMessage += `\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
            defaultMessage += `ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªÙØ¶Ù„ Ø¨Ø§Ù„Ø§Ø·Ù„Ø§Ø¹ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø±ÙÙ‚ Ù„Ù„Ø§Ø·Ù„Ø§Ø¹ Ø¹Ù„Ù‰ Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙƒØ§Ù…Ù„Ø©.\n\n`;
            defaultMessage += `Ù…Ø¹ ÙØ§Ø¦Ù‚ Ø§Ù„Ø´ÙƒØ± ÙˆØ§Ù„ØªÙ‚Ø¯ÙŠØ±ØŒ\n`;
            defaultMessage += `*Ø´Ø±ÙƒØ© Ø¹Ø±Ø§Ù‚ Ø³ÙŠÙ„ Ù„Ù„Ø¥ØªØµØ§Ù„Ø§Øª*`;
            document.getElementById('customMessageText').value = defaultMessage;
            document.getElementById('customMessageAgentName').setAttribute('data-agent', agentName);
            document.getElementById('messageCustomizationModal').classList.add('show');
        }
        function generateSubscriptionTable(reportData, reportType) {
            let table = '';
            const categories = [
                { key: 'platinum', name: 'Platinum', emoji: 'ðŸ’Ž', arabicName: 'Ø¨Ù„Ø§ØªÙŠÙ†ÙŠÙˆÙ…' },
                { key: 'gold', name: 'Gold', emoji: 'ðŸ¥‡', arabicName: 'ÙƒÙˆÙ„Ø¯' },
                { key: 'silver', name: 'Silver', emoji: 'ðŸ¥ˆ', arabicName: 'Ø³Ù„ÙØ±' },
                { key: 'bronze', name: 'Bronze', emoji: 'ðŸ¥‰', arabicName: 'Ø¨Ø±ÙˆÙ†Ø²' }
            ];
            let hasData = false;
            categories.forEach(cat => {
                const category = reportData[cat.key];
                if (category && category.count > 0) {
                    hasData = true;
                    let amount = 0;
                    let price = 0;
                    if (reportType === 'basic') {
                        amount = category.amount || 0;
                        price = category.count > 0 ? Math.round(amount / category.count) : 0;
                    } else {
                        amount = (category.officialAmount || 0) - (category.promoAmount || 0);
                        price = category.count > 0 ? Math.round(amount / category.count) : 0;
                    }
                    table += `*${cat.arabicName} (${cat.name})*\n`;
                    table += `   Ø¹Ø¯Ø¯ Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª: ${formatNumberEnglish(category.count)}\n`;
                    table += `   Ø§Ù„Ø³Ø¹Ø± Ø§Ù„ÙˆØ§Ø­Ø¯: ${formatNumberEnglish(price)} Ø¯.Ø¹\n`;
                    table += `   Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: ${formatNumberEnglish(amount)} Ø¯.Ø¹\n\n`;
                }
            });
            if (hasData) {
                const totalCount = (reportData.platinum?.count || 0) + 
                                 (reportData.gold?.count || 0) + 
                                 (reportData.silver?.count || 0) + 
                                 (reportData.bronze?.count || 0);
                let totalAmount = 0;
                if (reportType === 'basic') {
                    totalAmount = reportData.total?.amount || 0;
                } else {
                    totalAmount = reportData.total?.profit || 0;
                }
                table += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
                table += `*Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹*\n`;
                table += `   Ø¹Ø¯Ø¯ Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª: ${formatNumberEnglish(totalCount)}\n`;
                table += `   Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${formatNumberEnglish(totalAmount)} Ø¯.Ø¹\n`;
            }
            return table;
        }
        function closeMessageCustomizationModal() {
            document.getElementById('messageCustomizationModal').classList.remove('show');
        }
        function insertOfferInfo(type) {
            const textarea = document.getElementById('customMessageText');
            const cursorPos = textarea.selectionStart;
            const textBefore = textarea.value.substring(0, cursorPos);
            const textAfter = textarea.value.substring(cursorPos);
            let insertText = '';
            const agentName = document.getElementById('customMessageAgentName').getAttribute('data-agent');
            const reports = agentReports[agentName] || {};
            if (type === 'basic' && reports.basic) {
                insertText = ` Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠ: ${formatNumberEnglish(reports.basic.total.amount || 0)} Ø¯ÙŠÙ†Ø§Ø± Ø¹Ø±Ø§Ù‚ÙŠ`;
            } else if (type === 'advanced' && reports.advanced) {
                insertText = ` Ù…Ø®ÙØ¶ 3 Ø£Ø´Ù‡Ø±: ${formatNumberEnglish(reports.advanced.total.profit || 0)} Ø¯ÙŠÙ†Ø§Ø± Ø¹Ø±Ø§Ù‚ÙŠ`;
            } else if (type === 'twomonths' && reports.twoMonths) {
                insertText = ` Ù…Ø®ÙØ¶ Ø´Ù‡Ø±ÙŠÙ†: ${formatNumberEnglish(reports.twoMonths.total.profit || 0)} Ø¯ÙŠÙ†Ø§Ø± Ø¹Ø±Ø§Ù‚ÙŠ`;
            } else if (type === 'total') {
                const totalBasic = reports.basic?.total.amount || 0;
                const totalAdvanced = reports.advanced?.total.profit || 0;
                const totalTwoMonths = reports.twoMonths?.total.profit || 0;
                const total = totalBasic + totalAdvanced + totalTwoMonths;
                insertText = ` Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ„ÙŠ: ${formatNumberEnglish(total)} Ø¯ÙŠÙ†Ø§Ø± Ø¹Ø±Ø§Ù‚ÙŠ`;
            }
            if (insertText) {
                textarea.value = textBefore + insertText + '\n' + textAfter;
                textarea.selectionStart = textarea.selectionEnd = cursorPos + insertText.length + 1;
            }
        }
        function formatNumberEnglish(num) {
            if (num === null || num === undefined || isNaN(num)) return '0';
            return new Intl.NumberFormat('en-US').format(Math.floor(num));
        }
        function addOffersToMessage(message, agentName) {
            const reports = agentReports[agentName] || {};
            const totalBasic = reports.basic?.total.amount || 0;
            const totalAdvanced = reports.advanced?.total.profit || 0;
            const totalTwoMonths = reports.twoMonths?.total.profit || 0;
            let finalMessage = message;
            const hasDetailedTable = finalMessage.includes('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”') || 
                                     finalMessage.includes('Ø¹Ø¯Ø¯ Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª:') ||
                                     finalMessage.includes('Ø§Ù„Ø³Ø¹Ø±:') ||
                                     finalMessage.includes('Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹:');
            const hasBasicInMessage = finalMessage.includes('Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠ') || 
                                     finalMessage.includes('Ø§Ø´ØªØ±Ø§Ùƒ Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠ') ||
                                     finalMessage.includes('Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠ:') ||
                                     finalMessage.match(/Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠ[:\s]+[\d,]+/);
            const hasAdvancedInMessage = finalMessage.includes('Ù…Ø®ÙØ¶ 3 Ø£Ø´Ù‡Ø±') || 
                                         finalMessage.includes('Ù…Ø®ÙØ¶ 3') ||
                                         finalMessage.includes('Ø«Ù„Ø§Ø«Ø© Ø£Ø´Ù‡Ø±') ||
                                         finalMessage.includes('Ø«Ù„Ø§Ø« Ø£Ø´Ù‡Ø±') ||
                                         finalMessage.includes('Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø®ÙÙ‘ÙŽØ¶ Ù„Ø«Ù„Ø§Ø«Ø© Ø£Ø´Ù‡Ø±') ||
                                         finalMessage.includes('Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø®ÙØ¶ Ù„Ø«Ù„Ø§Ø«Ø© Ø£Ø´Ù‡Ø±') ||
                                         finalMessage.match(/Ù…Ø®Ù[Ø¶Ù]\s*3/);
            const hasTwoMonthsInMessage = finalMessage.includes('Ù…Ø®ÙØ¶ Ø´Ù‡Ø±ÙŠÙ†') || 
                                          finalMessage.includes('Ù…Ø®ÙØ¶ Ø´Ù‡Ø±ÙŠÙ†') ||
                                          finalMessage.includes('Ø´Ù‡Ø±ÙŠÙ†') ||
                                          finalMessage.includes('Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø®ÙÙ‘ÙŽØ¶ Ù„Ø´Ù‡Ø±ÙŠÙ†') ||
                                          finalMessage.includes('Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø®ÙØ¶ Ù„Ø´Ù‡Ø±ÙŠÙ†') ||
                                          finalMessage.match(/Ù…Ø®Ù[Ø¶Ù]\s*Ø´Ù‡Ø±ÙŠÙ†/);
            const hasTotalInMessage = finalMessage.includes('Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ„ÙŠ') || 
                                     finalMessage.includes('Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:');
            if (hasDetailedTable) {
                return finalMessage;
            }
            if (totalBasic > 0 && !hasBasicInMessage) {
                finalMessage += `\n\n*Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠ*\n`;
                finalMessage += generateSubscriptionTable(reports.basic, 'basic');
            }
            if (totalAdvanced > 0 && !hasAdvancedInMessage) {
                finalMessage += `\n\n*Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø®ÙØ¶ Ù„Ø«Ù„Ø§Ø«Ø© Ø£Ø´Ù‡Ø±*\n`;
                finalMessage += generateSubscriptionTable(reports.advanced, 'advanced');
            }
            if (totalTwoMonths > 0 && !hasTwoMonthsInMessage) {
                finalMessage += `\n\n*Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø®ÙØ¶ Ù„Ø´Ù‡Ø±ÙŠÙ†*\n`;
                finalMessage += generateSubscriptionTable(reports.twoMonths, 'twoMonths');
            }
                const total = totalBasic + totalAdvanced + totalTwoMonths;
            if (total > 0 && !hasTotalInMessage) {
                finalMessage += `\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
                finalMessage += `*Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ„ÙŠ: ${formatNumberEnglish(total)} Ø¯ÙŠÙ†Ø§Ø± Ø¹Ø±Ø§Ù‚ÙŠ*\n`;
            }
            return finalMessage;
        }
        function sendCustomizedWhatsAppMessage() {
            const agentName = document.getElementById('customMessageAgentName').getAttribute('data-agent');
            const agent = agentsList.find(a => a.name === agentName);
            if (!agent || !agent.phone) {
                alert('Ø®Ø·Ø£ ÙÙŠ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆÙƒÙŠÙ„');
                return;
            }
            let message = document.getElementById('customMessageText').value.trim();
            if (!message) {
                alert('ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ø±Ø³Ø§Ù„Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„');
                return;
            }
            message = addOffersToMessage(message, agentName);
            const fileType = 'excel';
            const fileInfo = getFileTypeInfo(fileType, agentName);
            const fileBlobPromise = getFileBlobPromise(agentName, fileType);
            fileBlobPromise.then((fileBlob) => {
                const phone = formatPhoneForWhatsApp(agent.phone);
                downloadFile(fileBlob, fileInfo.filename);
                const whatsappUrl = `https://wa.me/${phone}?text=${encodeURIComponent(message)}`;
                window.open(whatsappUrl, '_blank');
                logActivity('Ø¥Ø±Ø³Ø§Ù„ ØªÙ‚Ø±ÙŠØ± ÙˆØ§ØªØ³Ø§Ø¨', `ØªÙ… ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù ${fileInfo.typeName} Ù„Ù„ÙˆÙƒÙŠÙ„: ${agentName}`);
                closeMessageCustomizationModal();
            }).catch((error) => {
                console.error('Error generating file:', error);
                alert(`Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù ${fileInfo.typeName}. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.`);
            });
        }
        function sendViaEmail() {
            const agentName = document.getElementById('customMessageAgentName').getAttribute('data-agent');
            const agent = agentsList.find(a => a.name === agentName);
            if (!agent || !agent.email) {
                alert('Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø¨Ø±ÙŠØ¯ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù„Ù„ÙˆÙƒÙŠÙ„');
                return;
            }
            let message = document.getElementById('customMessageText').value.trim();
            if (!message) {
                alert('ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ø±Ø³Ø§Ù„Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„');
                return;
            }
            message = addOffersToMessage(message, agentName);
            const fileType = 'excel';
            const fileInfo = getFileTypeInfo(fileType, agentName);
            const fileBlobPromise = getFileBlobPromise(agentName, fileType);
            fileBlobPromise.then(async (fileBlob) => {
                const subject = `ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„Ù…Ø³ØªØ­Ù‚Ø© - ${agentName}`;
                const emailBody = encodeURIComponent(message);
                downloadFile(fileBlob, fileInfo.filename);
                const mailtoLink = `mailto:${agent.email}?subject=${encodeURIComponent(subject)}&body=${emailBody}`;
                window.location.href = mailtoLink;
                logActivity('Ø¥Ø±Ø³Ø§Ù„ ØªÙ‚Ø±ÙŠØ± Ø¹Ø¨Ø± Ø§Ù„Ø¨Ø±ÙŠØ¯', `ØªÙ… ØªØ­Ø¶ÙŠØ± Ù…Ù„Ù ${fileInfo.typeName} ÙˆÙØªØ­ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù„Ù„ÙˆÙƒÙŠÙ„: ${agentName}`);
                showSuccessMessage(`ØªÙ… ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù ${fileInfo.typeName}. Ø³ÙŠØªÙ… ÙØªØ­ Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ. ÙŠØ±Ø¬Ù‰ Ø¥Ø±ÙØ§Ù‚ Ø§Ù„Ù…Ù„Ù ÙŠØ¯ÙˆÙŠØ§Ù‹.`);
                closeMessageCustomizationModal();
            }).catch((error) => {
                console.error('Error generating file:', error);
                alert(`Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù ${fileInfo.typeName}. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.`);
            });
        }
        function arabicTextToImage(text, fontSize, color, width = 170) {
            return new Promise((resolve) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                ctx.font = `${fontSize}px Tajawal`;
                ctx.fillStyle = color;
                ctx.textAlign = 'right';
                ctx.textBaseline = 'middle';
                const metrics = ctx.measureText(text);
                canvas.width = Math.max(width, metrics.width + 20);
                canvas.height = fontSize + 10;
                ctx.font = `${fontSize}px Tajawal`;
                ctx.fillStyle = color;
                ctx.textAlign = 'right';
                ctx.textBaseline = 'middle';
                ctx.fillText(text, canvas.width - 10, canvas.height / 2);
                canvas.toBlob((blob) => {
                    const reader = new FileReader();
                    reader.onload = () => {
                        resolve(reader.result);
                    };
                    reader.readAsDataURL(blob);
                }, 'image/png');
            });
        }
        function generatePDFReportBlob(agentName) {
            return new Promise(async (resolve, reject) => {
                try {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF('landscape');
                    const reportInfo = getReportInfo(agentName);
                    const { reportType, reportData, reportTitle, agent, dateFrom, dateTo } = reportInfo;
                    let yPos = 15;
                    const startX = 10;
                    const pageWidth = doc.internal.pageSize.getWidth();
                    const titleImage = await arabicTextToImage(reportTitle, 11, '#000000', pageWidth - 20);
                    doc.addImage(titleImage, 'PNG', startX, yPos, pageWidth - 20, 8);
                    yPos += 12;
                    const colWidths = {
                        serial: 12,
                        agentName: 40,
                        platinumPrice: 15,
                        platinumCount: 12,
                        goldPrice: 15,
                        goldCount: 12,
                        silverPrice: 15,
                        silverCount: 12,
                        bronzePrice: 15,
                        bronzeCount: 12,
                        totalSubs: 18,
                        totalAmount: 20,
                        dateFrom: 18,
                        dateTo: 18
                    };
                    const totalTableWidth = Object.values(colWidths).reduce((a, b) => a + b, 0);
                    const tableStartX = (pageWidth - totalTableWidth) / 2;
                    yPos += 2;
                    const header1Height = 8;
                    const header2Height = 7;
                    const header3Height = 6;
                    doc.setFillColor(173, 216, 230);
                    doc.rect(tableStartX, yPos, colWidths.serial, header1Height + header2Height + header3Height, 'F');
                    const serialHeaderImg = await arabicTextToImage('Øª', 10, '#000000', colWidths.serial);
                    doc.addImage(serialHeaderImg, 'PNG', tableStartX + 2, yPos + header1Height + header2Height + 2, colWidths.serial - 4, 4);
                    doc.rect(tableStartX + colWidths.serial, yPos, colWidths.agentName, header1Height + header2Height + header3Height, 'F');
                    const agentNameHeaderImg = await arabicTextToImage('Ø§Ø³Ù… Ø§Ù„ÙˆÙƒÙŠÙ„', 10, '#000000', colWidths.agentName);
                    doc.addImage(agentNameHeaderImg, 'PNG', tableStartX + colWidths.serial + 2, yPos + header1Height + header2Height + 2, colWidths.agentName - 4, 4);
                    const categoryWidth = colWidths.platinumPrice + colWidths.platinumCount + 
                                         colWidths.goldPrice + colWidths.goldCount + 
                                         colWidths.silverPrice + colWidths.silverCount + 
                                         colWidths.bronzePrice + colWidths.bronzeCount;
                    doc.rect(tableStartX + colWidths.serial + colWidths.agentName, yPos, categoryWidth, header1Height, 'F');
                    const categoryHeaderImg = await arabicTextToImage('Ø§Ù„ÙØ¦Ø©', 10, '#000000', categoryWidth);
                    doc.addImage(categoryHeaderImg, 'PNG', tableStartX + colWidths.serial + colWidths.agentName + categoryWidth/2 - 15, yPos + 2, 30, 4);
                    doc.rect(tableStartX + colWidths.serial + colWidths.agentName + categoryWidth, yPos, colWidths.totalSubs, header1Height + header2Height + header3Height, 'F');
                    const totalSubsHeaderImg = await arabicTextToImage('Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª', 9, '#000000', colWidths.totalSubs);
                    doc.addImage(totalSubsHeaderImg, 'PNG', tableStartX + colWidths.serial + colWidths.agentName + categoryWidth + 2, yPos + header1Height + header2Height + 2, colWidths.totalSubs - 4, 4);
                    doc.rect(tableStartX + colWidths.serial + colWidths.agentName + categoryWidth + colWidths.totalSubs, yPos, colWidths.totalAmount, header1Height + header2Height + header3Height, 'F');
                    const totalAmountHeaderImg = await arabicTextToImage('Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ', 9, '#000000', colWidths.totalAmount);
                    doc.addImage(totalAmountHeaderImg, 'PNG', tableStartX + colWidths.serial + colWidths.agentName + categoryWidth + colWidths.totalSubs + 2, yPos + header1Height + header2Height + 2, colWidths.totalAmount - 4, 4);
                    const dateWidth = colWidths.dateFrom + colWidths.dateTo;
                    doc.rect(tableStartX + colWidths.serial + colWidths.agentName + categoryWidth + colWidths.totalSubs + colWidths.totalAmount, yPos, dateWidth, header1Height, 'F');
                    const dateHeaderImg = await arabicTextToImage('Ø§Ù„ØªØ§Ø±ÙŠØ®', 10, '#000000', dateWidth);
                    doc.addImage(dateHeaderImg, 'PNG', tableStartX + colWidths.serial + colWidths.agentName + categoryWidth + colWidths.totalSubs + colWidths.totalAmount + dateWidth/2 - 12, yPos + 2, 24, 4);
                    let currentX = tableStartX + colWidths.serial + colWidths.agentName;
                    doc.setFillColor(173, 216, 230);
                    doc.rect(currentX, yPos + header1Height, colWidths.platinumPrice + colWidths.platinumCount, header2Height, 'F');
                    const platinumHeaderImg = await arabicTextToImage('Ø¨Ù„Ø§ØªÙŠÙ†ÙŠÙˆÙ…', 9, '#000000', colWidths.platinumPrice + colWidths.platinumCount);
                    doc.addImage(platinumHeaderImg, 'PNG', currentX + (colWidths.platinumPrice + colWidths.platinumCount)/2 - 15, yPos + header1Height + 1.5, 30, 4);
                    currentX += colWidths.platinumPrice + colWidths.platinumCount;
                    doc.rect(currentX, yPos + header1Height, colWidths.goldPrice + colWidths.goldCount, header2Height, 'F');
                    const goldHeaderImg = await arabicTextToImage('ÙƒÙˆÙ„Ø¯', 9, '#000000', colWidths.goldPrice + colWidths.goldCount);
                    doc.addImage(goldHeaderImg, 'PNG', currentX + (colWidths.goldPrice + colWidths.goldCount)/2 - 10, yPos + header1Height + 1.5, 20, 4);
                    currentX += colWidths.goldPrice + colWidths.goldCount;
                    doc.rect(currentX, yPos + header1Height, colWidths.silverPrice + colWidths.silverCount, header2Height, 'F');
                    const silverHeaderImg = await arabicTextToImage('Ø³Ù„ÙØ±', 9, '#000000', colWidths.silverPrice + colWidths.silverCount);
                    doc.addImage(silverHeaderImg, 'PNG', currentX + (colWidths.silverPrice + colWidths.silverCount)/2 - 10, yPos + header1Height + 1.5, 20, 4);
                    currentX += colWidths.silverPrice + colWidths.silverCount;
                    doc.rect(currentX, yPos + header1Height, colWidths.bronzePrice + colWidths.bronzeCount, header2Height, 'F');
                    const bronzeHeaderImg = await arabicTextToImage('Ø¨Ø±ÙˆÙ†Ø²', 9, '#000000', colWidths.bronzePrice + colWidths.bronzeCount);
                    doc.addImage(bronzeHeaderImg, 'PNG', currentX + (colWidths.bronzePrice + colWidths.bronzeCount)/2 - 10, yPos + header1Height + 1.5, 20, 4);
                    currentX = tableStartX + colWidths.serial + colWidths.agentName + categoryWidth + colWidths.totalSubs + colWidths.totalAmount;
                    doc.rect(currentX, yPos + header1Height, colWidths.dateFrom, header2Height + header3Height, 'F');
                    const dateFromHeaderImg = await arabicTextToImage('Ù…Ù†', 9, '#000000', colWidths.dateFrom);
                    doc.addImage(dateFromHeaderImg, 'PNG', currentX + colWidths.dateFrom/2 - 8, yPos + header1Height + header2Height + 1.5, 16, 4);
                    currentX += colWidths.dateFrom;
                    doc.rect(currentX, yPos + header1Height, colWidths.dateTo, header2Height + header3Height, 'F');
                    const dateToHeaderImg = await arabicTextToImage('Ø§Ù„Ù‰', 9, '#000000', colWidths.dateTo);
                    doc.addImage(dateToHeaderImg, 'PNG', currentX + colWidths.dateTo/2 - 8, yPos + header1Height + header2Height + 1.5, 16, 4);
                    currentX = tableStartX + colWidths.serial + colWidths.agentName;
                    doc.setFillColor(173, 216, 230);
                    const priceLabelImg = await arabicTextToImage('Ø§Ù„Ø³Ø¹Ø±', 8, '#000000', 15);
                    const countLabelImg = await arabicTextToImage('Ø¹Ø¯Ø¯ Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª', 8, '#000000', 12);
                    doc.rect(currentX, yPos + header1Height + header2Height, colWidths.platinumPrice, header3Height, 'F');
                    doc.addImage(priceLabelImg, 'PNG', currentX + 2, yPos + header1Height + header2Height + 1, colWidths.platinumPrice - 4, 3.5);
                    currentX += colWidths.platinumPrice;
                    doc.rect(currentX, yPos + header1Height + header2Height, colWidths.platinumCount, header3Height, 'F');
                    doc.addImage(countLabelImg, 'PNG', currentX + 1, yPos + header1Height + header2Height + 1, colWidths.platinumCount - 2, 3.5);
                    currentX += colWidths.platinumCount;
                    doc.rect(currentX, yPos + header1Height + header2Height, colWidths.goldPrice, header3Height, 'F');
                    doc.addImage(priceLabelImg, 'PNG', currentX + 2, yPos + header1Height + header2Height + 1, colWidths.goldPrice - 4, 3.5);
                    currentX += colWidths.goldPrice;
                    doc.rect(currentX, yPos + header1Height + header2Height, colWidths.goldCount, header3Height, 'F');
                    doc.addImage(countLabelImg, 'PNG', currentX + 1, yPos + header1Height + header2Height + 1, colWidths.goldCount - 2, 3.5);
                    currentX += colWidths.goldCount;
                    doc.rect(currentX, yPos + header1Height + header2Height, colWidths.silverPrice, header3Height, 'F');
                    doc.addImage(priceLabelImg, 'PNG', currentX + 2, yPos + header1Height + header2Height + 1, colWidths.silverPrice - 4, 3.5);
                    currentX += colWidths.silverPrice;
                    doc.rect(currentX, yPos + header1Height + header2Height, colWidths.silverCount, header3Height, 'F');
                    doc.addImage(countLabelImg, 'PNG', currentX + 1, yPos + header1Height + header2Height + 1, colWidths.silverCount - 2, 3.5);
                    currentX += colWidths.silverCount;
                    doc.rect(currentX, yPos + header1Height + header2Height, colWidths.bronzePrice, header3Height, 'F');
                    doc.addImage(priceLabelImg, 'PNG', currentX + 2, yPos + header1Height + header2Height + 1, colWidths.bronzePrice - 4, 3.5);
                    currentX += colWidths.bronzePrice;
                    doc.rect(currentX, yPos + header1Height + header2Height, colWidths.bronzeCount, header3Height, 'F');
                    doc.addImage(countLabelImg, 'PNG', currentX + 1, yPos + header1Height + header2Height + 1, colWidths.bronzeCount - 2, 3.5);
                    doc.setDrawColor(0, 0, 0);
                    doc.setLineWidth(0.1);
                    let headerX = tableStartX;
                    for (let key in colWidths) {
                        doc.rect(headerX, yPos, colWidths[key], header1Height + header2Height + header3Height, 'S');
                        headerX += colWidths[key];
                    }
                    doc.rect(tableStartX + colWidths.serial + colWidths.agentName, yPos + header1Height, categoryWidth, header2Height, 'S');
                    doc.rect(tableStartX + colWidths.serial + colWidths.agentName + categoryWidth + colWidths.totalSubs + colWidths.totalAmount, yPos + header1Height, dateWidth, header2Height, 'S');
                    doc.rect(tableStartX + colWidths.serial + colWidths.agentName + categoryWidth + colWidths.totalSubs + colWidths.totalAmount, yPos + header1Height + header2Height, dateWidth, header3Height, 'S');
                    yPos += header1Height + header2Height + header3Height;
                    const cellHeight = 10;
                    doc.setFillColor(255, 255, 255);
                    doc.rect(tableStartX, yPos, totalTableWidth, cellHeight, 'F');
                    doc.setDrawColor(0, 0, 0);
                    doc.rect(tableStartX, yPos, totalTableWidth, cellHeight, 'S');
                    doc.text('1', tableStartX + colWidths.serial/2, yPos + 7, { align: 'center' });
                    doc.rect(tableStartX, yPos, colWidths.serial, cellHeight, 'S');
                    const agentNameText = agentName + (agent?.email ? ' / ' + agent.email : '');
                    const agentNameImg = await arabicTextToImage(agentNameText, 9, '#000000', colWidths.agentName - 4);
                    doc.addImage(agentNameImg, 'PNG', tableStartX + colWidths.serial + 2, yPos + 2, colWidths.agentName - 4, 6);
                    doc.rect(tableStartX + colWidths.serial, yPos, colWidths.agentName, cellHeight, 'S');
                    currentX = tableStartX + colWidths.serial + colWidths.agentName;
                    const { platinumCount, platinumPrice, goldCount, goldPrice, 
                            silverCount, silverPrice, bronzeCount, bronzePrice, 
                            totalSubs, totalAmount } = calculateCategoryPricesAndCounts(reportData, reportType);
                    doc.text(formatNumber(Math.round(platinumPrice)), currentX + colWidths.platinumPrice/2, yPos + 7, { align: 'center' });
                    doc.rect(currentX, yPos, colWidths.platinumPrice, cellHeight, 'S');
                    currentX += colWidths.platinumPrice;
                    doc.text(String(platinumCount), currentX + colWidths.platinumCount/2, yPos + 7, { align: 'center' });
                    doc.rect(currentX, yPos, colWidths.platinumCount, cellHeight, 'S');
                    currentX += colWidths.platinumCount;
                    doc.text(formatNumber(Math.round(goldPrice)), currentX + colWidths.goldPrice/2, yPos + 7, { align: 'center' });
                    doc.rect(currentX, yPos, colWidths.goldPrice, cellHeight, 'S');
                    currentX += colWidths.goldPrice;
                    doc.text(String(goldCount), currentX + colWidths.goldCount/2, yPos + 7, { align: 'center' });
                    doc.rect(currentX, yPos, colWidths.goldCount, cellHeight, 'S');
                    currentX += colWidths.goldCount;
                    doc.text(formatNumber(Math.round(silverPrice)), currentX + colWidths.silverPrice/2, yPos + 7, { align: 'center' });
                    doc.rect(currentX, yPos, colWidths.silverPrice, cellHeight, 'S');
                    currentX += colWidths.silverPrice;
                    doc.text(String(silverCount), currentX + colWidths.silverCount/2, yPos + 7, { align: 'center' });
                    doc.rect(currentX, yPos, colWidths.silverCount, cellHeight, 'S');
                    currentX += colWidths.silverCount;
                    doc.text(formatNumber(Math.round(bronzePrice)), currentX + colWidths.bronzePrice/2, yPos + 7, { align: 'center' });
                    doc.rect(currentX, yPos, colWidths.bronzePrice, cellHeight, 'S');
                    currentX += colWidths.bronzePrice;
                    doc.text(String(bronzeCount), currentX + colWidths.bronzeCount/2, yPos + 7, { align: 'center' });
                    doc.rect(currentX, yPos, colWidths.bronzeCount, cellHeight, 'S');
                    currentX += colWidths.bronzeCount;
                    doc.text(String(totalSubs), currentX + colWidths.totalSubs/2, yPos + 7, { align: 'center' });
                    doc.rect(currentX, yPos, colWidths.totalSubs, cellHeight, 'S');
                    currentX += colWidths.totalSubs;
                    doc.text(formatNumber(totalAmount), currentX + colWidths.totalAmount/2, yPos + 7, { align: 'center' });
                    doc.rect(currentX, yPos, colWidths.totalAmount, cellHeight, 'S');
                    currentX += colWidths.totalAmount;
                    doc.text(dateFrom, currentX + colWidths.dateFrom/2, yPos + 7, { align: 'center' });
                    doc.rect(currentX, yPos, colWidths.dateFrom, cellHeight, 'S');
                    currentX += colWidths.dateFrom;
                    doc.text(dateTo, currentX + colWidths.dateTo/2, yPos + 7, { align: 'center' });
                    doc.rect(currentX, yPos, colWidths.dateTo, cellHeight, 'S');
                    yPos += cellHeight;
                    doc.setFillColor(200, 200, 200);
                    doc.rect(tableStartX, yPos, totalTableWidth, cellHeight, 'F');
                    doc.setDrawColor(0, 0, 0);
                    doc.rect(tableStartX, yPos, totalTableWidth, cellHeight, 'S');
                    const totalLabelImg = await arabicTextToImage('Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹', 9, '#000000', colWidths.serial + colWidths.agentName);
                    doc.addImage(totalLabelImg, 'PNG', tableStartX + 2, yPos + 2, colWidths.serial + colWidths.agentName - 4, 6);
                    doc.rect(tableStartX, yPos, colWidths.serial + colWidths.agentName, cellHeight, 'S');
                    currentX = tableStartX + colWidths.serial + colWidths.agentName;
                    doc.text('', currentX + colWidths.platinumPrice/2, yPos + 7, { align: 'center' });
                    doc.rect(currentX, yPos, colWidths.platinumPrice, cellHeight, 'S');
                    currentX += colWidths.platinumPrice;
                    doc.text(String(platinumCount), currentX + colWidths.platinumCount/2, yPos + 7, { align: 'center' });
                    doc.rect(currentX, yPos, colWidths.platinumCount, cellHeight, 'S');
                    currentX += colWidths.platinumCount;
                    doc.text('', currentX + colWidths.goldPrice/2, yPos + 7, { align: 'center' });
                    doc.rect(currentX, yPos, colWidths.goldPrice, cellHeight, 'S');
                    currentX += colWidths.goldPrice;
                    doc.text(String(goldCount), currentX + colWidths.goldCount/2, yPos + 7, { align: 'center' });
                    doc.rect(currentX, yPos, colWidths.goldCount, cellHeight, 'S');
                    currentX += colWidths.goldCount;
                    doc.text('', currentX + colWidths.silverPrice/2, yPos + 7, { align: 'center' });
                    doc.rect(currentX, yPos, colWidths.silverPrice, cellHeight, 'S');
                    currentX += colWidths.silverPrice;
                    doc.text(String(silverCount), currentX + colWidths.silverCount/2, yPos + 7, { align: 'center' });
                    doc.rect(currentX, yPos, colWidths.silverCount, cellHeight, 'S');
                    currentX += colWidths.silverCount;
                    doc.text('', currentX + colWidths.bronzePrice/2, yPos + 7, { align: 'center' });
                    doc.rect(currentX, yPos, colWidths.bronzePrice, cellHeight, 'S');
                    currentX += colWidths.bronzePrice;
                    doc.text(String(bronzeCount), currentX + colWidths.bronzeCount/2, yPos + 7, { align: 'center' });
                    doc.rect(currentX, yPos, colWidths.bronzeCount, cellHeight, 'S');
                    currentX += colWidths.bronzeCount;
                    doc.text(String(totalSubs), currentX + colWidths.totalSubs/2, yPos + 7, { align: 'center' });
                    doc.rect(currentX, yPos, colWidths.totalSubs, cellHeight, 'S');
                    currentX += colWidths.totalSubs;
                    doc.text(formatNumber(totalAmount), currentX + colWidths.totalAmount/2, yPos + 7, { align: 'center' });
                    doc.rect(currentX, yPos, colWidths.totalAmount, cellHeight, 'S');
                    currentX += colWidths.totalAmount;
                    doc.text('', currentX + colWidths.dateFrom/2, yPos + 7, { align: 'center' });
                    doc.rect(currentX, yPos, colWidths.dateFrom, cellHeight, 'S');
                    currentX += colWidths.dateFrom;
                    doc.text('', currentX + colWidths.dateTo/2, yPos + 7, { align: 'center' });
                    doc.rect(currentX, yPos, colWidths.dateTo, cellHeight, 'S');
                    const pdfBlob = doc.output('blob');
                    resolve(pdfBlob);
                } catch (error) {
                    reject(error);
                }
            });
        }
        function generateExcelReportBlob(agentName) {
            return new Promise(async (resolve, reject) => {
                try {
                    const reportInfo = getReportInfo(agentName);
                    const { reportType, reportData, reportTitle, agent, dateFrom, dateTo } = reportInfo;
                    const reports = agentReports[agentName] || {};
                    const hasBasic = reports.basic && reports.basic.total && reports.basic.total.count > 0;
                    const hasAdvanced = reports.advanced && reports.advanced.total && reports.advanced.total.count > 0;
                    const hasTwoMonths = reports.twoMonths && reports.twoMonths.total && reports.twoMonths.total.count > 0;
                    const ExcelJS = window.ExcelJS;
                    if (!ExcelJS) {
                        return generateExcelReportBlobXLSX(agentName).then(resolve).catch(reject);
                    }
                    const workbook = new ExcelJS.Workbook();
                    const worksheet = workbook.addWorksheet('ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙˆÙƒÙŠÙ„');
                    worksheet.columns = [
                        { width: 35, key: 'type' },
                        { width: 20, key: 'count' },
                        { width: 20, key: 'price' },
                        { width: 20, key: 'total' }
                    ];
                    let currentRow = 1;
                    const titleRow = worksheet.getRow(currentRow);
                    titleRow.getCell(1).value = reportTitle || 'ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„Ù…Ø³ØªØ­Ù‚Ø©';
                    titleRow.getCell(1).font = { bold: true, size: 18, color: { argb: 'FF801C32' } };
                    titleRow.getCell(1).alignment = { horizontal: 'center', vertical: 'middle' };
                    worksheet.mergeCells(currentRow, 1, currentRow, 4);
                    titleRow.height = 30;
                    currentRow++;
                    currentRow++;
                    worksheet.getRow(currentRow).getCell(1).value = `Ø§Ø³Ù… Ø§Ù„ÙˆÙƒÙŠÙ„: ${agentName}`;
                    worksheet.getRow(currentRow).getCell(1).font = { bold: true, size: 12 };
                    currentRow++;
                    if (agent?.email) {
                        worksheet.getRow(currentRow).getCell(1).value = `Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ: ${agent.email}`;
                        worksheet.getRow(currentRow).getCell(1).font = { size: 12 };
                        currentRow++;
                    }
                    if (agent?.phone) {
                        worksheet.getRow(currentRow).getCell(1).value = `Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ: ${agent.phone}`;
                        worksheet.getRow(currentRow).getCell(1).font = { size: 12 };
                        currentRow++;
                    }
                    currentRow++;
                    const createTable = (title, data, startRow) => {
                        let row = startRow;
                        const sectionRow = worksheet.getRow(row);
                        sectionRow.getCell(1).value = title;
                        sectionRow.getCell(1).font = { bold: true, size: 14, color: { argb: 'FF801C32' } };
                        sectionRow.getCell(1).fill = {
                            type: 'pattern',
                            pattern: 'solid',
                            fgColor: { argb: 'FFF8F9FA' }
                        };
                        sectionRow.getCell(1).alignment = { horizontal: 'right', vertical: 'middle' };
                        sectionRow.getCell(1).border = {
                            top: { style: 'thin', color: { argb: 'FF801C32' } },
                            bottom: { style: 'thin', color: { argb: 'FF801C32' } },
                            left: { style: 'thin', color: { argb: 'FF801C32' } },
                            right: { style: 'thin', color: { argb: 'FF801C32' } }
                        };
                        worksheet.mergeCells(row, 1, row, 4);
                        sectionRow.height = 25;
                        row++;
                        const headerRow = worksheet.getRow(row);
                        const headers = ['Ù†ÙˆØ¹ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ', 'Ø¹Ø¯Ø¯ Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª', 'Ø§Ù„Ø³Ø¹Ø± Ø§Ù„ÙˆØ§Ø­Ø¯ (Ø¯.Ø¹)', 'Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ (Ø¯.Ø¹)'];
                        headers.forEach((header, idx) => {
                            const cell = headerRow.getCell(idx + 1);
                            cell.value = header;
                            cell.font = { bold: true, size: 12, color: { argb: 'FFFFFFFF' } };
                            cell.fill = {
                                type: 'pattern',
                                pattern: 'solid',
                                fgColor: { argb: 'FF801C32' }
                            };
                            cell.alignment = { horizontal: 'center', vertical: 'middle', wrapText: true };
                            cell.border = {
                                top: { style: 'thin', color: { argb: 'FFFFFFFF' } },
                                bottom: { style: 'thin', color: { argb: 'FFFFFFFF' } },
                                left: { style: 'thin', color: { argb: 'FFFFFFFF' } },
                                right: { style: 'thin', color: { argb: 'FFFFFFFF' } }
                            };
                        });
                        headerRow.height = 25;
                        row++;
                        data.forEach((item, index) => {
                            const dataRow = worksheet.getRow(row);
                            const isTotalRow = item.type === 'Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹';
                            const isEven = index % 2 === 0;
                            const bgColor = isTotalRow ? 'FFE8F0F5' : (isEven ? 'FFFFFFFF' : 'FFF8F9FA');
                            dataRow.getCell(1).value = item.type;
                            dataRow.getCell(2).value = item.count;
                            dataRow.getCell(3).value = item.price || '';
                            dataRow.getCell(4).value = item.total;
                            for (let col = 1; col <= 4; col++) {
                                const cell = dataRow.getCell(col);
                                cell.font = isTotalRow ? { bold: true, size: 14 } : { size: 12 };
                                cell.fill = {
                                    type: 'pattern',
                                    pattern: 'solid',
                                    fgColor: { argb: bgColor }
                                };
                                cell.alignment = col === 1 ? 
                                    { horizontal: 'right', vertical: 'middle' } : 
                                    { horizontal: 'center', vertical: 'middle' };
                                cell.border = {
                                    top: { style: 'thin', color: { argb: 'FFDDDDDD' } },
                                    bottom: { style: 'thin', color: { argb: 'FFDDDDDD' } },
                                    left: { style: 'thin', color: { argb: 'FFDDDDDD' } },
                                    right: { style: 'thin', color: { argb: 'FFDDDDDD' } }
                                };
                            }
                            dataRow.height = 22;
                            row++;
                        });
                        row++;
                        return row;
                    };
                    if (hasBasic) {
                        const basicData = reports.basic;
                        const categories = [
                            { key: 'platinum', name: 'Platinum' },
                            { key: 'gold', name: 'Gold' },
                            { key: 'silver', name: 'Silver' },
                            { key: 'bronze', name: 'Bronze' }
                        ];
                        const tableData = [];
                        categories.forEach(cat => {
                            const category = basicData[cat.key] || { count: 0, amount: 0 };
                            const price = category.count > 0 ? Math.round((category.amount || 0) / category.count) : 0;
                            tableData.push({
                                type: cat.name,
                                count: formatNumberEnglish(category.count || 0),
                                price: formatNumberEnglish(price),
                                total: formatNumberEnglish(category.amount || 0)
                            });
                        });
                        tableData.push({
                            type: 'Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹',
                            count: formatNumberEnglish(basicData.total?.count || 0),
                            price: '',
                            total: formatNumberEnglish(basicData.total?.amount || 0)
                        });
                        currentRow = createTable('Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠ', tableData, currentRow);
                    }
                    if (hasAdvanced) {
                        const advancedData = reports.advanced;
                        const categories = [
                            { key: 'platinum', name: 'Platinum', category: 'P' },
                            { key: 'gold', name: 'Gold', category: 'G' },
                            { key: 'silver', name: 'Silver', category: 'S' },
                            { key: 'bronze', name: 'Bronze', category: 'B' }
                        ];
                        const tableData = [];
                        categories.forEach(cat => {
                            let category = advancedData[cat.key];
                            let count = 0;
                            let officialAmount = 0;
                            let promoAmount = 0;
                            if (category && (category.count > 0 || category.officialAmount > 0 || category.promoAmount > 0)) {
                                count = category.count || 0;
                                officialAmount = category.officialAmount || 0;
                                promoAmount = category.promoAmount || 0;
                            } else {
                                if (typeof advancedDetails !== 'undefined' && Array.isArray(advancedDetails) && advancedDetails.length > 0) {
                                    const currentAgentName = agentName || advancedData.agentName || '';
                                    const agentDetails = advancedDetails.filter(d => {
                                        const detailAgent = d.agent || d.Agent || d.agentName || d.AgentName || d['Ø§Ø³Ù… Ø§Ù„ÙˆÙƒÙŠÙ„'] || d['Ø§Ù„ÙˆÙƒÙŠÙ„'] || '';
                                        const subType = d.subscription || d.Subscription || d['Ù†ÙˆØ¹ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ'] || '';
                                        if (!detailAgent || detailAgent !== currentAgentName) return false;
                                        const detailCategory = getSubscriptionCategory(subType, detailAgent);
                                        return detailCategory === cat.category;
                                    });
                                    count = agentDetails.length;
                                    agentDetails.forEach(d => {
                                        const subType = d.subscription || d.Subscription || '';
                                        const detailAgent = d.agent || d.Agent || '';
                                        const detailCategory = getSubscriptionCategory(subType, detailAgent);
                                        if (detailCategory === cat.category) {
                                            const promo = d.promoPrice || getSubscriptionPrice(subType, detailCategory, 'advanced', 'promo');
                                            const official = d.officialPrice || getSubscriptionPrice(subType, detailCategory, 'advanced', 'official');
                                            promoAmount += promo || 0;
                                            officialAmount += official || 0;
                                        }
                                    });
                                }
                            }
                            const amount = officialAmount - promoAmount;
                            const price = count > 0 ? Math.round(amount / count) : 0;
                            tableData.push({
                                type: cat.name,
                                count: formatNumberEnglish(count),
                                price: formatNumberEnglish(price),
                                total: formatNumberEnglish(amount)
                            });
                        });
                        tableData.push({
                            type: 'Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹',
                            count: formatNumberEnglish(advancedData.total?.count || 0),
                            price: '',
                            total: formatNumberEnglish(advancedData.total?.profit || 0)
                        });
                        currentRow = createTable('Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø®ÙØ¶ Ù„Ø«Ù„Ø§Ø«Ø© Ø£Ø´Ù‡Ø±', tableData, currentRow);
                    }
                    if (hasTwoMonths) {
                        const twoMonthsData = reports.twoMonths;
                        const categories = [
                            { key: 'platinum', name: 'Platinum' },
                            { key: 'gold', name: 'Gold' },
                            { key: 'silver', name: 'Silver' },
                            { key: 'bronze', name: 'Bronze' }
                        ];
                        const tableData = [];
                        categories.forEach(cat => {
                            const category = twoMonthsData[cat.key] || { count: 0, officialAmount: 0, promoAmount: 0 };
                            const amount = (category.officialAmount || 0) - (category.promoAmount || 0);
                            const price = category.count > 0 ? Math.round(amount / category.count) : 0;
                            tableData.push({
                                type: cat.name,
                                count: formatNumberEnglish(category.count || 0),
                                price: formatNumberEnglish(price),
                                total: formatNumberEnglish(amount)
                            });
                        });
                        tableData.push({
                            type: 'Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹',
                            count: formatNumberEnglish(twoMonthsData.total?.count || 0),
                            price: '',
                            total: formatNumberEnglish(twoMonthsData.total?.profit || 0)
                        });
                        currentRow = createTable('Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø®ÙØ¶ Ù„Ø´Ù‡Ø±ÙŠÙ†', tableData, currentRow);
                    }
                    const totalBasic = reports.basic?.total.amount || 0;
                    const totalAdvanced = reports.advanced?.total.profit || 0;
                    const totalTwoMonths = reports.twoMonths?.total.profit || 0;
                    const selectedTotal = totalBasic + totalAdvanced + totalTwoMonths;
                    if (selectedTotal > 0) {
                        currentRow++;
                        const totalSectionRow = worksheet.getRow(currentRow);
                        totalSectionRow.getCell(1).value = 'Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ„ÙŠ';
                        totalSectionRow.getCell(1).font = { bold: true, size: 14, color: { argb: 'FF801C32' } };
                        totalSectionRow.getCell(1).fill = {
                            type: 'pattern',
                            pattern: 'solid',
                            fgColor: { argb: 'FFF8F9FA' }
                        };
                        totalSectionRow.getCell(1).border = {
                            top: { style: 'medium', color: { argb: 'FF801C32' } },
                            bottom: { style: 'medium', color: { argb: 'FF801C32' } },
                            left: { style: 'medium', color: { argb: 'FF801C32' } },
                            right: { style: 'medium', color: { argb: 'FF801C32' } }
                        };
                        worksheet.mergeCells(currentRow, 1, currentRow, 4);
                        totalSectionRow.height = 25;
                        currentRow++;
                        if (hasBasic) {
                            const row = worksheet.getRow(currentRow);
                            row.getCell(1).value = 'Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠ:';
                            row.getCell(4).value = formatNumberEnglish(totalBasic) + ' Ø¯.Ø¹';
                            row.getCell(1).font = { bold: true, size: 12 };
                            row.getCell(4).font = { bold: true, size: 12 };
                            row.getCell(4).alignment = { horizontal: 'center' };
                            currentRow++;
                        }
                        if (hasAdvanced) {
                            const row = worksheet.getRow(currentRow);
                            row.getCell(1).value = 'Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø®ÙØ¶ Ù„Ø«Ù„Ø§Ø«Ø© Ø£Ø´Ù‡Ø±:';
                            row.getCell(4).value = formatNumberEnglish(totalAdvanced) + ' Ø¯.Ø¹';
                            row.getCell(1).font = { bold: true, size: 12 };
                            row.getCell(4).font = { bold: true, size: 12 };
                            row.getCell(4).alignment = { horizontal: 'center' };
                            currentRow++;
                        }
                        if (hasTwoMonths) {
                            const row = worksheet.getRow(currentRow);
                            row.getCell(1).value = 'Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø®ÙØ¶ Ù„Ø´Ù‡Ø±ÙŠÙ†:';
                            row.getCell(4).value = formatNumberEnglish(totalTwoMonths) + ' Ø¯.Ø¹';
                            row.getCell(1).font = { bold: true, size: 12 };
                            row.getCell(4).font = { bold: true, size: 12 };
                            row.getCell(4).alignment = { horizontal: 'center' };
                            currentRow++;
                        }
                        const finalTotalRow = worksheet.getRow(currentRow);
                        finalTotalRow.getCell(1).value = 'Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ„ÙŠ:';
                        finalTotalRow.getCell(4).value = formatNumberEnglish(selectedTotal) + ' Ø¯ÙŠÙ†Ø§Ø± Ø¹Ø±Ø§Ù‚ÙŠ';
                        finalTotalRow.getCell(1).font = { bold: true, size: 14, color: { argb: 'FF801C32' } };
                        finalTotalRow.getCell(4).font = { bold: true, size: 14, color: { argb: 'FF801C32' } };
                        finalTotalRow.getCell(4).alignment = { horizontal: 'center' };
                        finalTotalRow.getCell(1).fill = {
                            type: 'pattern',
                            pattern: 'solid',
                            fgColor: { argb: 'FFE8F0F5' }
                        };
                        finalTotalRow.getCell(4).fill = {
                            type: 'pattern',
                            pattern: 'solid',
                            fgColor: { argb: 'FFE8F0F5' }
                        };
                        finalTotalRow.getCell(1).border = {
                            top: { style: 'medium', color: { argb: 'FF801C32' } },
                            bottom: { style: 'medium', color: { argb: 'FF801C32' } },
                            left: { style: 'medium', color: { argb: 'FF801C32' } },
                            right: { style: 'thin', color: { argb: 'FF801C32' } }
                        };
                        finalTotalRow.getCell(4).border = {
                            top: { style: 'medium', color: { argb: 'FF801C32' } },
                            bottom: { style: 'medium', color: { argb: 'FF801C32' } },
                            left: { style: 'thin', color: { argb: 'FF801C32' } },
                            right: { style: 'medium', color: { argb: 'FF801C32' } }
                        };
                        finalTotalRow.height = 30;
                    }
                    const buffer = await workbook.xlsx.writeBuffer();
                    const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                    resolve(blob);
                } catch (error) {
                    console.error('Error generating Excel with ExcelJS:', error);
                    generateExcelReportBlobXLSX(agentName).then(resolve).catch(reject);
                }
            });
        }
        function generateExcelReportBlobXLSX(agentName) {
            return new Promise((resolve, reject) => {
                try {
                    const reportInfo = getReportInfo(agentName);
                    const { reportType, reportData, reportTitle, agent, dateFrom, dateTo } = reportInfo;
                    const reports = agentReports[agentName] || {};
                    const hasBasic = reports.basic && reports.basic.total && reports.basic.total.count > 0;
                    const hasAdvanced = reports.advanced && reports.advanced.total && reports.advanced.total.count > 0;
                    const hasTwoMonths = reports.twoMonths && reports.twoMonths.total && reports.twoMonths.total.count > 0;
                    const wsData = [];
                    wsData.push([reportTitle || 'ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„Ù…Ø³ØªØ­Ù‚Ø©']);
                    wsData.push([`Ø§Ø³Ù… Ø§Ù„ÙˆÙƒÙŠÙ„: ${agentName}`]);
                    if (hasBasic) {
                        wsData.push(['Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠ']);
                        wsData.push(['Ù†ÙˆØ¹ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ', 'Ø¹Ø¯Ø¯ Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª', 'Ø§Ù„Ø³Ø¹Ø± Ø§Ù„ÙˆØ§Ø­Ø¯ (Ø¯.Ø¹)', 'Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ (Ø¯.Ø¹)']);
                        const basicData = reports.basic;
                        ['platinum', 'gold', 'silver', 'bronze'].forEach(key => {
                            const cat = basicData[key];
                            if (cat && cat.count > 0) {
                                const price = Math.round((cat.amount || 0) / cat.count);
                                wsData.push([
                                    key === 'platinum' ? 'Ø¨Ù„Ø§ØªÙŠÙ†ÙŠÙˆÙ… (Platinum)' : 
                                    key === 'gold' ? 'ÙƒÙˆÙ„Ø¯ (Gold)' : 
                                    key === 'silver' ? 'Ø³Ù„ÙØ± (Silver)' : 'Ø¨Ø±ÙˆÙ†Ø² (Bronze)',
                                    formatNumberEnglish(cat.count),
                                    formatNumberEnglish(price),
                                    formatNumberEnglish(cat.amount || 0)
                                ]);
                            }
                        });
                        wsData.push(['Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹', formatNumberEnglish(basicData.total?.count || 0), '', formatNumberEnglish(basicData.total?.amount || 0)]);
                    }
                    const wb = XLSX.utils.book_new();
                    const ws = XLSX.utils.aoa_to_sheet(wsData);
                    ws['!cols'] = [{ wch: 30 }, { wch: 18 }, { wch: 18 }, { wch: 18 }];
                    XLSX.utils.book_append_sheet(wb, ws, 'ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙˆÙƒÙŠÙ„');
                    const excelBlob = XLSX.write(wb, { type: 'array', bookType: 'xlsx' });
                    const blob = new Blob([excelBlob], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                    resolve(blob);
                } catch (error) {
                    reject(error);
                }
            });
        }
        function toggleUserContactPopup(event) {
            if (event) {
                event.stopPropagation();
            }
            const popup = document.getElementById('userContactPopup');
            const sidebarUser = document.getElementById('sidebarUser');
            if (!popup || !sidebarUser) {
                return false;
            }
            
            const isShowing = popup.classList.contains('show');
            
            if (isShowing) {
                popup.style.animation = 'popupFadeOut 0.15s ease-out forwards';
                setTimeout(() => {
                    popup.classList.remove('show');
                    popup.style.display = 'none';
                    popup.style.opacity = '0';
                    popup.style.visibility = 'hidden';
                    popup.style.pointerEvents = 'none';
                    popup.style.animation = '';
                    if (sidebarUser) {
                        sidebarUser.style.transform = 'scale(1)';
                        sidebarUser.style.boxShadow = '0 4px 12px rgba(128, 28, 50, 0.4)';
                    }
                }, 150);
            } else {
                const allPopups = document.querySelectorAll('.user-contact-popup.show');
                allPopups.forEach(p => {
                    p.classList.remove('show');
                    p.style.display = 'none';
                    p.style.opacity = '0';
                    p.style.visibility = 'hidden';
                    p.style.pointerEvents = 'none';
                    p.style.animation = '';
                });
                
                const rect = sidebarUser.getBoundingClientRect();
                const popupWidth = 250;
                const popupHeight = 200;
                
                const sidebar = document.getElementById('sidebar');
                const sidebarRect = sidebar ? sidebar.getBoundingClientRect() : null;
                let left = sidebarRect ? sidebarRect.left - popupWidth - 10 : rect.left - popupWidth - 10;
                let top = rect.top;
                
                const windowWidth = window.innerWidth;
                const windowHeight = window.innerHeight;
                let finalLeft = left;
                let finalTop = top;
                
                if (finalLeft < 10) {
                    finalLeft = sidebarRect ? sidebarRect.right + 10 : rect.right + 10;
                }
                if (finalLeft + popupWidth > windowWidth - 10) {
                    finalLeft = windowWidth - popupWidth - 10;
                }
                if (finalTop + popupHeight > windowHeight - 10) {
                    finalTop = windowHeight - popupHeight - 10;
                }
                if (finalTop < 10) {
                    finalTop = 10;
                }
                
                popup.style.left = finalLeft + 'px';
                popup.style.top = finalTop + 'px';
                popup.style.zIndex = '10001';
                
                popup.style.removeProperty('opacity');
                
                popup.style.display = 'block';
                popup.style.visibility = 'visible';
                popup.style.pointerEvents = 'auto';
                popup.style.transform = 'translateY(0)';
                
                setTimeout(() => {
                    popup.classList.add('show');
                }, 10);
            }
            return false;
        }
        
        window.toggleUserContactPopup = toggleUserContactPopup;
        
        function switchUser() {
            if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŸ Ø³ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø­Ø§Ù„ÙŠ.')) {
                loggedInUser = '';
                localStorage.removeItem('loggedInUser');
                localStorage.removeItem('currentUserRole');
                localStorage.removeItem('currentUserId');
                
                const dashboard = document.getElementById('dashboard');
                const loginScreen = document.getElementById('loginScreen');
                
                if (dashboard) {
                    dashboard.classList.add('hidden');
                    dashboard.style.display = 'none';
                }
                
                if (loginScreen) {
                    loginScreen.classList.remove('hidden');
                    loginScreen.style.display = 'flex';
                }
                
                const loginUsername = document.getElementById('loginUsername');
                const loginPassword = document.getElementById('loginPassword');
                const loginAlert = document.getElementById('loginAlert');
                
                if (loginUsername) loginUsername.value = '';
                if (loginPassword) loginPassword.value = '';
                if (loginAlert) loginAlert.innerHTML = '';
            }
        }
        
        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            const themeIcon = document.getElementById('themeToggleIcon');
            const themeText = document.getElementById('themeToggleText');
            if (themeIcon) {
                themeIcon.textContent = newTheme === 'dark' ? 'â˜€ï¸' : 'ðŸŒ™';
            }
        }
        function loadTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            const html = document.documentElement;
            html.setAttribute('data-theme', savedTheme);
            const themeIcon = document.getElementById('themeToggleIcon');
            const themeText = document.getElementById('themeToggleText');
            if (themeIcon) {
                themeIcon.textContent = savedTheme === 'dark' ? 'â˜€ï¸' : 'ðŸŒ™';
            }
        }
        
        function autoLoginFromMaster() {
            const autoUsername = sessionStorage.getItem('auto_login_username');
            const autoPassword = sessionStorage.getItem('auto_login_password');
            
            if (autoUsername && autoPassword) {
                const loginUsername = document.getElementById('loginUsername');
                const loginPassword = document.getElementById('loginPassword');
                
                if (loginUsername && loginPassword) {
                    loginUsername.value = autoUsername;
                    loginPassword.value = autoPassword;
                    
                    setTimeout(() => {
                        if (typeof handleLogin === 'function') {
                            handleLogin();
                        }
                    }, 500);
                    
                    sessionStorage.removeItem('auto_login_username');
                    sessionStorage.removeItem('auto_login_password');
                    sessionStorage.removeItem('auto_login_system');
                }
            }
        }
        
        window.addEventListener('message', function(event) {
            if (event.data && event.data.type === 'AUTO_LOGIN') {
                const loginUsername = document.getElementById('loginUsername');
                const loginPassword = document.getElementById('loginPassword');
                
                if (loginUsername && loginPassword) {
                    loginUsername.value = event.data.username || '';
                    loginPassword.value = event.data.password || '';
                    
                    setTimeout(() => {
                        if (typeof handleLogin === 'function') {
                            handleLogin();
                        }
                    }, 500);
                }
            }
        });
</script>
<div id="percentageSendOptionsModal" class="modal">
    <div class="modal-content" style="max-width: 400px;">
        <div class="modal-header">
            <h3>Ø§Ø®ØªØ± Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„</h3>
            <button class="modal-close" onclick="closePercentageSendOptions()">&times;</button>
        </div>
        <div style="padding: 20px 0;">
            <p style="margin-bottom: 20px; color: var(--text-primary); text-align: center; font-weight: 600;">
                <strong>Ø§Ù„ÙˆÙƒÙŠÙ„:</strong> <span id="percentageSendAgentName"></span>
            </p>
            <div style="display: flex; flex-direction: column; gap: 15px;">
                <button class="btn btn-success" onclick="sendPercentageReportViaWhatsApp()" style="width: 100%; padding: 15px; font-size: 1rem;">
                    Ø¥Ø±Ø³Ø§Ù„ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨
                </button>
                <button class="btn btn-primary" onclick="sendPercentageReportViaEmail()" style="width: 100%; padding: 15px; font-size: 1rem;">
                    Ø¥Ø±Ø³Ø§Ù„ Ø¹Ø¨Ø± Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ
                </button>
            </div>
        </div>
        <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button type="button" class="btn btn-danger" style="flex: 1;" onclick="closePercentageSendOptions()">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>
</div>
</body>
</html>
